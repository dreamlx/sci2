InheritedResources loaded: 
Run options: exclude {performance_benchmark: true}
.......FFFFFFFFFFFFF.F..................................F.................................FFFFFF.F............................FFFFFFFFFF.....................F..FF..F.................................FFFF.......................F.F.......F..F.F.......F..F.F.F.....F............FF...............FFFFFFFFFF..............................................................................................................................FFF.FFFFFFFF...FFFFFF.F....................FFFF.F.F...FFF....F...FFFF........................FFFFFFFFFFFFFFFFFFFFFF....FFFFF.FFF.FFF..FFF.FFF...FFFFFFFFF

Failures:

  1) AuditWorkOrderService#start_processing adds errors if processing fails
     Failure/Error: reimbursement.start_processing

     ActiveRecord::StatementInvalid:
       PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
     # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
     # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:18:in 'block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
     # ------------------
     # --- Caused by: ---
     # PG::InFailedSqlTransaction:
     #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
     #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  2) AuditWorkOrderService#approve approves the audit work order
     Failure/Error: reimbursement.start_processing

     ActiveRecord::StatementInvalid:
       PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
     # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
     # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:9:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:27:in 'block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
     # ------------------
     # --- Caused by: ---
     # PG::InFailedSqlTransaction:
     #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
     #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  3) AuditWorkOrderService#approve adds errors if approval fails
     Failure/Error: reimbursement.start_processing

     ActiveRecord::StatementInvalid:
       PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
     # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
     # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:35:in 'block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
     # ------------------
     # --- Caused by: ---
     # PG::InFailedSqlTransaction:
     #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
     #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  4) AuditWorkOrderService#reject rejects the audit work order
     Failure/Error: reimbursement.start_processing

     ActiveRecord::StatementInvalid:
       PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
     # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
     # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:9:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:46:in 'block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
     # ------------------
     # --- Caused by: ---
     # PG::InFailedSqlTransaction:
     #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
     #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  5) AuditWorkOrderService#reject adds errors if rejection fails
     Failure/Error: reimbursement.start_processing

     ActiveRecord::StatementInvalid:
       PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
     # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
     # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:54:in 'block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
     # ------------------
     # --- Caused by: ---
     # PG::InFailedSqlTransaction:
     #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
     #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  6) AuditWorkOrderService#reject requires an audit comment
     Failure/Error: reimbursement.start_processing

     ActiveRecord::StatementInvalid:
       PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
     # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
     # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:9:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:61:in 'block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
     # ------------------
     # --- Caused by: ---
     # PG::InFailedSqlTransaction:
     #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
     #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  7) AuditWorkOrderService#select_fee_detail selects a fee detail
     Failure/Error: reimbursement.start_processing

     ActiveRecord::StatementInvalid:
       PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
     # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
     # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:9:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:71:in 'block (4 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:72:in 'block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
     # ------------------
     # --- Caused by: ---
     # PG::InFailedSqlTransaction:
     #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
     #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  8) AuditWorkOrderService#select_fee_detail does not select a fee detail if it does not belong to the same reimbursement
     Failure/Error: reimbursement.start_processing

     ActiveRecord::StatementInvalid:
       PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
     # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
     # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:9:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:84:in 'block (4 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:85:in 'block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
     # ------------------
     # --- Caused by: ---
     # PG::InFailedSqlTransaction:
     #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
     #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  9) AuditWorkOrderService#select_fee_details selects multiple fee details
     Failure/Error: reimbursement.start_processing

     ActiveRecord::StatementInvalid:
       PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
     # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
     # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:9:in 'block (2 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:95:in 'block (4 levels) in <top (required)>'
     # ./spec/services/audit_work_order_service_spec.rb:96:in 'block (3 levels) in <top (required)>'
     # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
     # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
     # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
     # ------------------
     # --- Caused by: ---
     # PG::InFailedSqlTransaction:
     #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
     #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  10) AuditWorkOrderService#select_fee_details does not select fee details if they do not belong to the same reimbursement
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
      # ./spec/services/audit_work_order_service_spec.rb:9:in 'block (2 levels) in <top (required)>'
      # ./spec/services/audit_work_order_service_spec.rb:108:in 'block (4 levels) in <top (required)>'
      # ./spec/services/audit_work_order_service_spec.rb:109:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  11) AuditWorkOrderService#update_fee_detail_verification updates the verification status of a fee detail
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
      # ./spec/services/audit_work_order_service_spec.rb:9:in 'block (2 levels) in <top (required)>'
      # ./spec/services/audit_work_order_service_spec.rb:118:in 'block (4 levels) in <top (required)>'
      # ./spec/services/audit_work_order_service_spec.rb:119:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  12) AuditWorkOrderService#update_fee_detail_verification adds errors if the fee detail is not found
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
      # ./spec/services/audit_work_order_service_spec.rb:9:in 'block (2 levels) in <top (required)>'
      # ./spec/services/audit_work_order_service_spec.rb:126:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  13) AuditWorkOrderService#update_fee_detail_verification adds errors if the verification update fails
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/audit_work_order_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
      # ./spec/services/audit_work_order_service_spec.rb:9:in 'block (2 levels) in <top (required)>'
      # ./spec/services/audit_work_order_service_spec.rb:134:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  14) BaseImportService#initialize sets Current.admin_user
      Failure/Error: expect(Current.admin_user).to eq(admin_user)

        expected: #<AdminUser id: 17, email: "test_admin_user_17@example.com", created_at: "2025-10-28 23:52:29.4613480...52:29.461348000 +0000", name: nil, telephone: nil, role: "admin", status: "active", deleted_at: nil>
             got: #<AdminUser id: 16, email: "test_admin_user_16@example.com", created_at: "2025-10-28 23:52:29.4497300...52:29.449730000 +0000", name: nil, telephone: nil, role: "admin", status: "active", deleted_at: nil>

        (compared using ==)

        Diff:
        @@ -1 +1 @@
        -#<AdminUser id: 17, email: "test_admin_user_17@example.com", created_at: "2025-10-28 23:52:29.461348000 +0000", updated_at: "2025-10-28 23:52:29.461348000 +0000", name: nil, telephone: nil, role: "admin", status: "active", deleted_at: nil>
        +#<AdminUser id: 16, email: "test_admin_user_16@example.com", created_at: "2025-10-28 23:52:29.449730000 +0000", updated_at: "2025-10-28 23:52:29.449730000 +0000", name: nil, telephone: nil, role: "admin", status: "active", deleted_at: nil>
      # ./spec/services/base_import_service_spec.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  15) ExpressReceiptImportService#import with duplicate records skips duplicate records
      Failure/Error: latest_operation = operation_histories.maximum(:created_at)

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/reimbursement.rb:147:in 'Reimbursement#calculate_last_update_time'
      # ./app/models/reimbursement.rb:160:in 'Reimbursement#update_notification_status!'
      # ./app/models/work_order.rb:280:in 'WorkOrder#update_reimbursement_notification_status'
      # ./spec/services/express_receipt_import_service_spec.rb:128:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/reimbursement.rb:147:in 'Reimbursement#calculate_last_update_time'

  16) FeeDetailGroupService#group_by_fee_type groups fee details by fee type
      Failure/Error:
        FeeDetail.create!(
          document_number: reimbursement.invoice_number,
          fee_type: '月度交通费（销售/SMO/CO）',
          amount: 100.0,
          fee_date: Date.today,
          verification_status: 'pending'
        )

      ActiveRecord::RecordInvalid:
        验证失败: 费用id不能为空
      # ./spec/services/fee_detail_group_service_spec.rb:65:in 'block (2 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  17) FeeDetailGroupService#group_by_fee_type returns empty array if no fee details are provided
      Failure/Error:
        FeeDetail.create!(
          document_number: reimbursement.invoice_number,
          fee_type: '月度交通费（销售/SMO/CO）',
          amount: 100.0,
          fee_date: Date.today,
          verification_status: 'pending'
        )

      ActiveRecord::RecordInvalid:
        验证失败: 费用id不能为空
      # ./spec/services/fee_detail_group_service_spec.rb:65:in 'block (2 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  18) FeeDetailGroupService#fee_types returns unique fee types
      Failure/Error:
        FeeDetail.create!(
          document_number: reimbursement.invoice_number,
          fee_type: '月度交通费（销售/SMO/CO）',
          amount: 100.0,
          fee_date: Date.today,
          verification_status: 'pending'
        )

      ActiveRecord::RecordInvalid:
        验证失败: 费用id不能为空
      # ./spec/services/fee_detail_group_service_spec.rb:65:in 'block (2 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  19) FeeDetailGroupService#fee_type_ids returns fee type ids
      Failure/Error:
        FeeDetail.create!(
          document_number: reimbursement.invoice_number,
          fee_type: '月度交通费（销售/SMO/CO）',
          amount: 100.0,
          fee_date: Date.today,
          verification_status: 'pending'
        )

      ActiveRecord::RecordInvalid:
        验证失败: 费用id不能为空
      # ./spec/services/fee_detail_group_service_spec.rb:65:in 'block (2 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  20) FeeDetailGroupService#available_problem_types returns problem types for the fee types
      Failure/Error:
        FeeDetail.create!(
          document_number: reimbursement.invoice_number,
          fee_type: '月度交通费（销售/SMO/CO）',
          amount: 100.0,
          fee_date: Date.today,
          verification_status: 'pending'
        )

      ActiveRecord::RecordInvalid:
        验证失败: 费用id不能为空
      # ./spec/services/fee_detail_group_service_spec.rb:65:in 'block (2 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  21) FeeDetailGroupService#problem_types_by_fee_type groups problem types by fee type
      Failure/Error:
        FeeDetail.create!(
          document_number: reimbursement.invoice_number,
          fee_type: '月度交通费（销售/SMO/CO）',
          amount: 100.0,
          fee_date: Date.today,
          verification_status: 'pending'
        )

      ActiveRecord::RecordInvalid:
        验证失败: 费用id不能为空
      # ./spec/services/fee_detail_group_service_spec.rb:65:in 'block (2 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  22) FeeDetailImportService 弹性字段导入测试 弹性字段影响meeting_type_context方法
      Failure/Error: expect(fee_detail_1.meeting_type_context).to eq '学术论坛'

        expected: "学术论坛"
             got: "个人"

        (compared using ==)
      # ./spec/services/fee_detail_import_service_flex_fields_spec.rb:67:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  23) FeeDetailStatusService#update_status 当费用明细只关联审核工单时 应该根据审核工单状态更新
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/fee_detail_status_service_spec.rb:18:in 'block (4 levels) in <top (required)>'
      # ./spec/services/fee_detail_status_service_spec.rb:21:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  24) FeeDetailStatusService#update_status 当费用明细只关联沟通工单时 状态应该保持为 pending（沟通工单不影响状态）
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/fee_detail_status_service_spec.rb:34:in 'block (4 levels) in <top (required)>'
      # ./spec/services/fee_detail_status_service_spec.rb:38:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  25) FeeDetailStatusService#update_status 当费用明细同时关联审核工单和沟通工单时 应该只根据审核工单状态更新，忽略沟通工单
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/fee_detail_status_service_spec.rb:50:in 'block (4 levels) in <top (required)>'
      # ./spec/services/fee_detail_status_service_spec.rb:56:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  26) FeeDetailStatusService#update_status 当有多个审核工单和沟通工单时 应该根据最新的审核工单状态更新
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/fee_detail_status_service_spec.rb:70:in 'block (4 levels) in <top (required)>'
      # ./spec/services/fee_detail_status_service_spec.rb:80:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  27) FeeDetailStatusService#get_latest_work_order 当有审核工单和沟通工单时 应该返回最新的审核工单，排除沟通工单
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/fee_detail_status_service_spec.rb:98:in 'block (4 levels) in <top (required)>'
      # ./spec/services/fee_detail_status_service_spec.rb:104:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  28) FeeDetailStatusService#get_latest_work_order 当只有沟通工单时 应该返回 nil
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/fee_detail_status_service_spec.rb:116:in 'block (4 levels) in <top (required)>'
      # ./spec/services/fee_detail_status_service_spec.rb:119:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  29) FeeDetailStatusService#determine_status_from_work_order 当工单是沟通工单时 应该返回 pending
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/fee_detail_status_service_spec.rb:133:in 'block (4 levels) in <top (required)>'
      # ./spec/services/fee_detail_status_service_spec.rb:136:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  30) FeeDetailStatusService#determine_status_from_work_order 当工单是审核工单时 已批准的审核工单应该返回 verified
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/fee_detail_status_service_spec.rb:143:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  31) FeeDetailStatusService#determine_status_from_work_order 当工单是审核工单时 已拒绝的审核工单应该返回 problematic
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/fee_detail_status_service_spec.rb:149:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  32) FeeDetailStatusService#determine_status_from_work_order 当工单是审核工单时 待处理的审核工单应该返回 pending
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/fee_detail_status_service_spec.rb:155:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  33) OperationHistoryImportService Automatic Reopening Removal still imports operation history for closed reimbursements
      Failure/Error:
        expect do
          service.import
        end.to change(OperationHistory, :count).by(1)

        expected `OperationHistory.count` to have changed by 1, but was changed by 0
      # ./spec/services/operation_history_import_service_spec.rb:50:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  34) OperationHistoryImportService Automatic Reopening Removal automatic auditor assignment from operation history when reimbursement has no active assignment and operation type is "加签" automatically assigns the reimbursement to the matching operator
      Failure/Error: expect(result[:success]).to be_truthy

        expected: truthy value
             got: false
      # ./spec/services/operation_history_import_service_spec.rb:142:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  35) OperationHistoryImportService Automatic Reopening Removal automatic auditor assignment from operation history when reimbursement has no active assignment and operation type is "加签" handles operator name with extra content
      Failure/Error: expect(assignment).to be_present
        expected `nil.present?` to be truthy, got false
      # ./spec/services/operation_history_import_service_spec.rb:172:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  36) OperationHistoryImportService Operation History Creation still creates operation history records correctly
      Failure/Error: expect(result[:imported]).to eq(1)

        expected: 1
             got: 0

        (compared using ==)
      # ./spec/services/operation_history_import_service_spec.rb:281:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  37) ProblemFinderService.find_for when there is a precise match and a general match returns both precise and general problems
      Failure/Error:
        create(:problem_type, reimbursement_type_code: 'EN', meeting_type_code: '00', expense_type_code: '01',
                              title: 'EN precise problem')

      NoMethodError:
        undefined method 'reimbursement_type_code=' for an instance of ProblemType
      # ./spec/services/problem_finder_service_spec.rb:24:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  38) ProblemFinderService.find_for when there is only a general match (user entered fee_type does not match) returns only the general problems
      Failure/Error:
        create(:problem_type, reimbursement_type_code: 'EN', meeting_type_code: '00', expense_type_code: '01',
                              title: 'EN precise problem')

      NoMethodError:
        undefined method 'reimbursement_type_code=' for an instance of ProblemType
      # ./spec/services/problem_finder_service_spec.rb:24:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  39) ProblemFinderService.find_for when user entered fee_type matches but there are no precise problems, only general returns only the general problems
      Failure/Error:
        create(:problem_type, reimbursement_type_code: 'EN', meeting_type_code: '00', expense_type_code: '01',
                              title: 'EN precise problem')

      NoMethodError:
        undefined method 'reimbursement_type_code=' for an instance of ProblemType
      # ./spec/services/problem_finder_service_spec.rb:24:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  40) ProblemFinderService.find_for when context does not match anything returns an empty collection
      Failure/Error:
        create(:problem_type, reimbursement_type_code: 'EN', meeting_type_code: '00', expense_type_code: '01',
                              title: 'EN precise problem')

      NoMethodError:
        undefined method 'reimbursement_type_code=' for an instance of ProblemType
      # ./spec/services/problem_finder_service_spec.rb:24:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  41) ReimbursementAuthorizationService#default_scope with admin user returns assigned_to_me
      Failure/Error: expect(service.default_scope).to eq 'assigned_to_me'

        expected: "assigned_to_me"
             got: "all"

        (compared using ==)
      # ./spec/services/reimbursement_authorization_service_spec.rb:67:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  42) ReimbursementAuthorizationService#apply_role_based_default_filter with admin user filters to assigned reimbursements
      Failure/Error: expect(result).not_to include(reimbursement2)

        expected #<ActiveRecord::Relation [#<Reimbursement id: 250, invoice_number: "R2025000141", document_name: "测试报...ast_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>]> not to include #<Reimbursement id: 251, invoice_number: "R2025000142", document_name: "测试报销单", applicant: "测试用户", ap... last_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>
        Diff:
        @@ -1 +1,72 @@
        -[#<Reimbursement id: 251, invoice_number: "R2025000142", document_name: "测试报销单", applicant: "测试用户", applicant_id: "TEST001", company: "测试公司", department: "测试部门", receipt_status: "pending", receipt_date: nil, submission_date: nil, amount: 0.5e3, is_electronic: false, status: "pending", external_status: "审批中", approval_date: nil, approver_name: nil, related_application_number: nil, accounting_date: nil, document_tags: nil, created_at: "2025-10-28 23:52:34.933163000 +0000", updated_at: "2025-10-28 23:52:34.933163000 +0000", erp_current_approval_node: nil, erp_current_approver: nil, erp_flexible_field_2: nil, erp_node_entry_time: nil, erp_first_submitted_at: nil, erp_flexible_field_8: nil, manual_override: false, manual_override_at: nil, last_external_status: nil, last_viewed_operation_histories_at: nil, last_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>]
        +[#<Reimbursement:0x000000013f65cd00
        +  id: 250,
        +  invoice_number: "R2025000141",
        +  document_name: "测试报销单",
        +  applicant: "测试用户",
        +  applicant_id: "TEST001",
        +  company: "测试公司",
        +  department: "测试部门",
        +  receipt_status: "pending",
        +  receipt_date: nil,
        +  submission_date: nil,
        +  amount: 0.5e3,
        +  is_electronic: false,
        +  status: "pending",
        +  external_status: "审批中",
        +  approval_date: nil,
        +  approver_name: nil,
        +  related_application_number: nil,
        +  accounting_date: nil,
        +  document_tags: nil,
        +  created_at: Tue, 28 Oct 2025 23:52:34.929165000 UTC +00:00,
        +  updated_at: Tue, 28 Oct 2025 23:52:34.929165000 UTC +00:00,
        +  erp_current_approval_node: nil,
        +  erp_current_approver: nil,
        +  erp_flexible_field_2: nil,
        +  erp_node_entry_time: nil,
        +  erp_first_submitted_at: nil,
        +  erp_flexible_field_8: nil,
        +  manual_override: false,
        +  manual_override_at: nil,
        +  last_external_status: nil,
        +  last_viewed_operation_histories_at: nil,
        +  last_viewed_express_receipts_at: nil,
        +  last_viewed_at: nil,
        +  last_update_at: nil,
        +  has_updates: false>,
        + #<Reimbursement:0x000000013f65cbc0
        +  id: 251,
        +  invoice_number: "R2025000142",
        +  document_name: "测试报销单",
        +  applicant: "测试用户",
        +  applicant_id: "TEST001",
        +  company: "测试公司",
        +  department: "测试部门",
        +  receipt_status: "pending",
        +  receipt_date: nil,
        +  submission_date: nil,
        +  amount: 0.5e3,
        +  is_electronic: false,
        +  status: "pending",
        +  external_status: "审批中",
        +  approval_date: nil,
        +  approver_name: nil,
        +  related_application_number: nil,
        +  accounting_date: nil,
        +  document_tags: nil,
        +  created_at: Tue, 28 Oct 2025 23:52:34.933163000 UTC +00:00,
        +  updated_at: Tue, 28 Oct 2025 23:52:34.933163000 UTC +00:00,
        +  erp_current_approval_node: nil,
        +  erp_current_approver: nil,
        +  erp_flexible_field_2: nil,
        +  erp_node_entry_time: nil,
        +  erp_first_submitted_at: nil,
        +  erp_flexible_field_8: nil,
        +  manual_override: false,
        +  manual_override_at: nil,
        +  last_external_status: nil,
        +  last_viewed_operation_histories_at: nil,
        +  last_viewed_express_receipts_at: nil,
        +  last_viewed_at: nil,
        +  last_update_at: nil,
        +  has_updates: false>]
      # ./spec/services/reimbursement_authorization_service_spec.rb:87:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  43) ReimbursementAuthorizationService#apply_scope_filter with status scopes (default behavior) filters by processing status
      Failure/Error: expect(result).not_to include(reimbursement2)

        expected #<ActiveRecord::Relation [#<Reimbursement id: 267, invoice_number: "R2025000158", document_name: "测试报...ast_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>]> not to include #<Reimbursement id: 267, invoice_number: "R2025000158", document_name: "测试报销单", applicant: "测试用户", ap... last_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>
        Diff:
        @@ -1 +1,36 @@
        -[#<Reimbursement id: 267, invoice_number: "R2025000158", document_name: "测试报销单", applicant: "测试用户", applicant_id: "TEST001", company: "测试公司", department: "测试部门", receipt_status: "pending", receipt_date: nil, submission_date: nil, amount: 0.5e3, is_electronic: false, status: "processing", external_status: "审批中", approval_date: nil, approver_name: nil, related_application_number: nil, accounting_date: nil, document_tags: nil, created_at: "2025-10-28 23:52:35.212545000 +0000", updated_at: "2025-10-28 23:52:35.232475000 +0000", erp_current_approval_node: nil, erp_current_approver: nil, erp_flexible_field_2: nil, erp_node_entry_time: nil, erp_first_submitted_at: nil, erp_flexible_field_8: nil, manual_override: false, manual_override_at: nil, last_external_status: nil, last_viewed_operation_histories_at: nil, last_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>]
        +[#<Reimbursement:0x000000013f01d700
        +  id: 267,
        +  invoice_number: "R2025000158",
        +  document_name: "测试报销单",
        +  applicant: "测试用户",
        +  applicant_id: "TEST001",
        +  company: "测试公司",
        +  department: "测试部门",
        +  receipt_status: "pending",
        +  receipt_date: nil,
        +  submission_date: nil,
        +  amount: 0.5e3,
        +  is_electronic: false,
        +  status: "processing",
        +  external_status: "审批中",
        +  approval_date: nil,
        +  approver_name: nil,
        +  related_application_number: nil,
        +  accounting_date: nil,
        +  document_tags: nil,
        +  created_at: Tue, 28 Oct 2025 23:52:35.212545000 UTC +00:00,
        +  updated_at: Tue, 28 Oct 2025 23:52:35.232475000 UTC +00:00,
        +  erp_current_approval_node: nil,
        +  erp_current_approver: nil,
        +  erp_flexible_field_2: nil,
        +  erp_node_entry_time: nil,
        +  erp_first_submitted_at: nil,
        +  erp_flexible_field_8: nil,
        +  manual_override: false,
        +  manual_override_at: nil,
        +  last_external_status: nil,
        +  last_viewed_operation_histories_at: nil,
        +  last_viewed_express_receipts_at: nil,
        +  last_viewed_at: nil,
        +  last_update_at: nil,
        +  has_updates: false>]
      # ./spec/services/reimbursement_authorization_service_spec.rb:165:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  44) ReimbursementAuthorizationService#apply_scope_filter with unassigned scope filters to unassigned reimbursements by default
      Failure/Error: expect(result).to be_empty
        expected `#<ActiveRecord::Relation [#<Reimbursement id: 273, invoice_number: "R2025000164", document_name: "测试报...ast_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>]>.empty?` to be truthy, got false
      # ./spec/services/reimbursement_authorization_service_spec.rb:196:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  45) ReimbursementAuthorizationService#apply_scope_filter with all scope returns assigned reimbursements by default
      Failure/Error: expect(result).not_to include(reimbursement2)

        expected #<ActiveRecord::Relation [#<Reimbursement id: 276, invoice_number: "R2025000167", document_name: "测试报...ast_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>]> not to include #<Reimbursement id: 277, invoice_number: "R2025000168", document_name: "测试报销单", applicant: "测试用户", ap... last_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>
        Diff:
        @@ -1 +1,72 @@
        -[#<Reimbursement id: 277, invoice_number: "R2025000168", document_name: "测试报销单", applicant: "测试用户", applicant_id: "TEST001", company: "测试公司", department: "测试部门", receipt_status: "pending", receipt_date: nil, submission_date: nil, amount: 0.5e3, is_electronic: false, status: "pending", external_status: "审批中", approval_date: nil, approver_name: nil, related_application_number: nil, accounting_date: nil, document_tags: nil, created_at: "2025-10-28 23:52:35.350715000 +0000", updated_at: "2025-10-28 23:52:35.350715000 +0000", erp_current_approval_node: nil, erp_current_approver: nil, erp_flexible_field_2: nil, erp_node_entry_time: nil, erp_first_submitted_at: nil, erp_flexible_field_8: nil, manual_override: false, manual_override_at: nil, last_external_status: nil, last_viewed_operation_histories_at: nil, last_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>]
        +[#<Reimbursement:0x000000013955af20
        +  id: 276,
        +  invoice_number: "R2025000167",
        +  document_name: "测试报销单",
        +  applicant: "测试用户",
        +  applicant_id: "TEST001",
        +  company: "测试公司",
        +  department: "测试部门",
        +  receipt_status: "pending",
        +  receipt_date: nil,
        +  submission_date: nil,
        +  amount: 0.5e3,
        +  is_electronic: false,
        +  status: "pending",
        +  external_status: "审批中",
        +  approval_date: nil,
        +  approver_name: nil,
        +  related_application_number: nil,
        +  accounting_date: nil,
        +  document_tags: nil,
        +  created_at: Tue, 28 Oct 2025 23:52:35.347300000 UTC +00:00,
        +  updated_at: Tue, 28 Oct 2025 23:52:35.347300000 UTC +00:00,
        +  erp_current_approval_node: nil,
        +  erp_current_approver: nil,
        +  erp_flexible_field_2: nil,
        +  erp_node_entry_time: nil,
        +  erp_first_submitted_at: nil,
        +  erp_flexible_field_8: nil,
        +  manual_override: false,
        +  manual_override_at: nil,
        +  last_external_status: nil,
        +  last_viewed_operation_histories_at: nil,
        +  last_viewed_express_receipts_at: nil,
        +  last_viewed_at: nil,
        +  last_update_at: nil,
        +  has_updates: false>,
        + #<Reimbursement:0x0000000139559620
        +  id: 277,
        +  invoice_number: "R2025000168",
        +  document_name: "测试报销单",
        +  applicant: "测试用户",
        +  applicant_id: "TEST001",
        +  company: "测试公司",
        +  department: "测试部门",
        +  receipt_status: "pending",
        +  receipt_date: nil,
        +  submission_date: nil,
        +  amount: 0.5e3,
        +  is_electronic: false,
        +  status: "pending",
        +  external_status: "审批中",
        +  approval_date: nil,
        +  approver_name: nil,
        +  related_application_number: nil,
        +  accounting_date: nil,
        +  document_tags: nil,
        +  created_at: Tue, 28 Oct 2025 23:52:35.350715000 UTC +00:00,
        +  updated_at: Tue, 28 Oct 2025 23:52:35.350715000 UTC +00:00,
        +  erp_current_approval_node: nil,
        +  erp_current_approver: nil,
        +  erp_flexible_field_2: nil,
        +  erp_node_entry_time: nil,
        +  erp_first_submitted_at: nil,
        +  erp_flexible_field_8: nil,
        +  manual_override: false,
        +  manual_override_at: nil,
        +  last_external_status: nil,
        +  last_viewed_operation_histories_at: nil,
        +  last_viewed_express_receipts_at: nil,
        +  last_viewed_at: nil,
        +  last_update_at: nil,
        +  has_updates: false>]
      # ./spec/services/reimbursement_authorization_service_spec.rb:213:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  46) ReimbursementAuthorizationService#apply_scope_filter with no scope applies role-based default filter
      Failure/Error: expect(result).not_to include(reimbursement2)

        expected #<ActiveRecord::Relation [#<Reimbursement id: 292, invoice_number: "R2025000183", document_name: "测试报...ast_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>]> not to include #<Reimbursement id: 293, invoice_number: "R2025000184", document_name: "测试报销单", applicant: "测试用户", ap... last_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>
        Diff:
        @@ -1 +1,72 @@
        -[#<Reimbursement id: 293, invoice_number: "R2025000184", document_name: "测试报销单", applicant: "测试用户", applicant_id: "TEST001", company: "测试公司", department: "测试部门", receipt_status: "pending", receipt_date: nil, submission_date: nil, amount: 0.5e3, is_electronic: false, status: "pending", external_status: "审批中", approval_date: nil, approver_name: nil, related_application_number: nil, accounting_date: nil, document_tags: nil, created_at: "2025-10-28 23:52:35.603195000 +0000", updated_at: "2025-10-28 23:52:35.603195000 +0000", erp_current_approval_node: nil, erp_current_approver: nil, erp_flexible_field_2: nil, erp_node_entry_time: nil, erp_first_submitted_at: nil, erp_flexible_field_8: nil, manual_override: false, manual_override_at: nil, last_external_status: nil, last_viewed_operation_histories_at: nil, last_viewed_express_receipts_at: nil, last_viewed_at: nil, last_update_at: nil, has_updates: false>]
        +[#<Reimbursement:0x000000013ffd3988
        +  id: 292,
        +  invoice_number: "R2025000183",
        +  document_name: "测试报销单",
        +  applicant: "测试用户",
        +  applicant_id: "TEST001",
        +  company: "测试公司",
        +  department: "测试部门",
        +  receipt_status: "pending",
        +  receipt_date: nil,
        +  submission_date: nil,
        +  amount: 0.5e3,
        +  is_electronic: false,
        +  status: "pending",
        +  external_status: "审批中",
        +  approval_date: nil,
        +  approver_name: nil,
        +  related_application_number: nil,
        +  accounting_date: nil,
        +  document_tags: nil,
        +  created_at: Tue, 28 Oct 2025 23:52:35.601162000 UTC +00:00,
        +  updated_at: Tue, 28 Oct 2025 23:52:35.601162000 UTC +00:00,
        +  erp_current_approval_node: nil,
        +  erp_current_approver: nil,
        +  erp_flexible_field_2: nil,
        +  erp_node_entry_time: nil,
        +  erp_first_submitted_at: nil,
        +  erp_flexible_field_8: nil,
        +  manual_override: false,
        +  manual_override_at: nil,
        +  last_external_status: nil,
        +  last_viewed_operation_histories_at: nil,
        +  last_viewed_express_receipts_at: nil,
        +  last_viewed_at: nil,
        +  last_update_at: nil,
        +  has_updates: false>,
        + #<Reimbursement:0x000000013ffd3848
        +  id: 293,
        +  invoice_number: "R2025000184",
        +  document_name: "测试报销单",
        +  applicant: "测试用户",
        +  applicant_id: "TEST001",
        +  company: "测试公司",
        +  department: "测试部门",
        +  receipt_status: "pending",
        +  receipt_date: nil,
        +  submission_date: nil,
        +  amount: 0.5e3,
        +  is_electronic: false,
        +  status: "pending",
        +  external_status: "审批中",
        +  approval_date: nil,
        +  approver_name: nil,
        +  related_application_number: nil,
        +  accounting_date: nil,
        +  document_tags: nil,
        +  created_at: Tue, 28 Oct 2025 23:52:35.603195000 UTC +00:00,
        +  updated_at: Tue, 28 Oct 2025 23:52:35.603195000 UTC +00:00,
        +  erp_current_approval_node: nil,
        +  erp_current_approver: nil,
        +  erp_flexible_field_2: nil,
        +  erp_node_entry_time: nil,
        +  erp_first_submitted_at: nil,
        +  erp_flexible_field_8: nil,
        +  manual_override: false,
        +  manual_override_at: nil,
        +  last_external_status: nil,
        +  last_viewed_operation_histories_at: nil,
        +  last_viewed_express_receipts_at: nil,
        +  last_viewed_at: nil,
        +  last_update_at: nil,
        +  has_updates: false>]
      # ./spec/services/reimbursement_authorization_service_spec.rb:273:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  47) ReimbursementAuthorizationService#should_show_default_scope_notice? with admin user returns true
      Failure/Error: expect(service.should_show_default_scope_notice?).to be true

        expected true
             got false
      # ./spec/services/reimbursement_authorization_service_spec.rb:301:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  48) ReimbursementAuthorizationService#default_scope_notice with admin user returns notice message
      Failure/Error: expect(service.default_scope_notice).to eq '默认显示分配给您的报销单。您可以使用搜索和过滤功能查看其他报销单。'

        expected: "默认显示分配给您的报销单。您可以使用搜索和过滤功能查看其他报销单。"
             got: nil

        (compared using ==)
      # ./spec/services/reimbursement_authorization_service_spec.rb:319:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  49) ReimbursementAuthorizationService#should_use_global_view? with admin user returns false by default
      Failure/Error: expect(service.should_use_global_view?({})).to be false

        expected false
             got true
      # ./spec/services/reimbursement_authorization_service_spec.rb:338:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  50) ReimbursementAuthorizationService#global_view_notice with admin user returns appropriate notice for admin users
      Failure/Error: expect(service.global_view_notice).to eq('当前为全局视图模式，您可以查看所有报销单数据')

        expected: "当前为全局视图模式，您可以查看所有报销单数据"
             got: nil

        (compared using ==)
      # ./spec/services/reimbursement_authorization_service_spec.rb:382:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  51) ReimbursementImportService#import with file error automatic auditor assignment when current approval node is "审核" and approver matches admin user automatically assigns the reimbursement to the matching auditor
      Failure/Error:
        expect do
          service.import(spreadsheet)
        end.to change(ReimbursementAssignment, :count).by(1)

        expected `ReimbursementAssignment.count` to have changed by 1, but was changed by 0
      # ./spec/services/reimbursement_import_service_spec.rb:289:in 'block (6 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  52) ReimbursementImportService#import with file error automatic auditor assignment when current approval node is "审核" and approver matches admin user handles approver name with extra content
      Failure/Error:
        expect do
          service.import(spreadsheet)
        end.to change(ReimbursementAssignment, :count).by(1)

        expected `ReimbursementAssignment.count` to have changed by 1, but was changed by 0
      # ./spec/services/reimbursement_import_service_spec.rb:312:in 'block (6 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  53) ReimbursementImportService New Status Logic Integration #determine_status_from_external returns "closed" for "已付款" external status
      Failure/Error: result = service.send(:determine_status_from_external, reimbursement, '已付款')

      NoMethodError:
        undefined method 'determine_status_from_external' for an instance of ReimbursementImportService
      # ./spec/services/reimbursement_import_service_status_logic_spec.rb:12:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  54) ReimbursementImportService New Status Logic Integration #determine_status_from_external returns "closed" for "待付款" external status
      Failure/Error: result = service.send(:determine_status_from_external, reimbursement, '待付款')

      NoMethodError:
        undefined method 'determine_status_from_external' for an instance of ReimbursementImportService
      # ./spec/services/reimbursement_import_service_status_logic_spec.rb:17:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  55) ReimbursementImportService New Status Logic Integration #determine_status_from_external returns "processing" for "审批中" when work orders exist
      Failure/Error: initialize_with { raise 'Cannot create WorkOrder directly, use a subclass factory' }

      RuntimeError:
        Cannot create WorkOrder directly, use a subclass factory
      # ./spec/factories/work_orders.rb:13:in 'block (3 levels) in <top (required)>'
      # ./spec/services/reimbursement_import_service_status_logic_spec.rb:22:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  56) ReimbursementImportService New Status Logic Integration #determine_status_from_external returns "pending" for "审批中" when no work orders exist
      Failure/Error: result = service.send(:determine_status_from_external, reimbursement, '审批中')

      NoMethodError:
        undefined method 'determine_status_from_external' for an instance of ReimbursementImportService
      # ./spec/services/reimbursement_import_service_status_logic_spec.rb:28:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  57) ReimbursementImportService New Status Logic Integration #determine_status_from_external respects manual override protection
      Failure/Error: result = service.send(:determine_status_from_external, reimbursement, '审批中')

      NoMethodError:
        undefined method 'determine_status_from_external' for an instance of ReimbursementImportService
      # ./spec/services/reimbursement_import_service_status_logic_spec.rb:36:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  58) ReimbursementImportService New Status Logic Integration External Status Priority prioritizes external status over work order logic
      Failure/Error: initialize_with { raise 'Cannot create WorkOrder directly, use a subclass factory' }

      RuntimeError:
        Cannot create WorkOrder directly, use a subclass factory
      # ./spec/factories/work_orders.rb:13:in 'block (3 levels) in <top (required)>'
      # ./spec/services/reimbursement_import_service_status_logic_spec.rb:46:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  59) ReimbursementImportService New Status Logic Integration External Status Priority uses work order logic when external status allows
      Failure/Error: initialize_with { raise 'Cannot create WorkOrder directly, use a subclass factory' }

      RuntimeError:
        Cannot create WorkOrder directly, use a subclass factory
      # ./spec/factories/work_orders.rb:13:in 'block (3 levels) in <top (required)>'
      # ./spec/services/reimbursement_import_service_status_logic_spec.rb:54:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  60) ReimbursementImportService New Status Logic Integration Last External Status Tracking updates last_external_status when status changes
      Failure/Error: service.send(:determine_status_from_external, reimbursement, '已付款')

      NoMethodError:
        undefined method 'determine_status_from_external' for an instance of ReimbursementImportService
      # ./spec/services/reimbursement_import_service_status_logic_spec.rb:67:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  61) ReimbursementImportService New Status Logic Integration Last External Status Tracking tracks external status changes over time
      Failure/Error: service.send(:determine_status_from_external, reimbursement, '审批中')

      NoMethodError:
        undefined method 'determine_status_from_external' for an instance of ReimbursementImportService
      # ./spec/services/reimbursement_import_service_status_logic_spec.rb:74:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  62) ReimbursementImportService Integration with Import Process applies new status logic during import
      Failure/Error: service.send(:determine_status_from_external, r1, '已付款')

      NoMethodError:
        undefined method 'determine_status_from_external' for #<ReimbursementImportService:0x0000000169b5f198>
      # ./spec/services/reimbursement_import_service_status_logic_spec.rb:122:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  63) UnifiedExpressReceiptImportService 增强功能测试 重复记录检查功能 存在重复记录时 跳过重复记录
      Failure/Error: expect(result[:success]).to be true

        expected true
             got false
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:43:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  64) UnifiedExpressReceiptImportService 增强功能测试 重复记录检查功能 存在重复记录时 记录跳过原因到日志
      Failure/Error: expect(Rails.logger).to receive(:info).with(/跳过重复记录.*SF123456789/)

        (#<ActiveSupport::BroadcastLogger:0x00000001391e7988 @broadcasts=[#<ActiveSupport::Logger:0x000000013918e6a8 @level=0, @progname=nil, @default_formatter=#<Logger::Formatter:0x00000001391ea0e8 @datetime_format=nil>, @formatter=#<ActiveSupport::Logger::SimpleFormatter:0x00000001391e7d48 @datetime_format=nil, @thread_key="activesupport_tagged_logging_tags:11512">, @logdev=#<Logger::LogDevice:0x000000013941a020 @shift_period_suffix="%Y%m%d", @shift_size=104857600, @shift_age=1, @filename="/Users/dreamlinx/Dropbox/Projects/NetBeansProjects/think-bridge/sci2/log/test.log", @dev=#<File:/Users/dreamlinx/Dropbox/Projects/NetBeansProjects/think-bridge/sci2/log/test.log>, @binmode=false, @reraise_write_errors=[], @skip_header=false, @mon_data=#<Monitor:0x00000001391e9ff8>, @mon_data_owner_object_id=3360>, @level_override={}, @local_level_key=:logger_thread_safe_level_11472>], @progname="Broadcast", @formatter=#<ActiveSupport::Logger::SimpleFormatter:0x00000001391e7d48 @datetime_format=nil, @thread_key="activesupport_tagged_logging_tags:11512">>).info(/跳过重复记录.*SF123456789/)
            expected: 1 time with arguments: (/跳过重复记录.*SF123456789/)
            received: 0 times
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:50:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  65) UnifiedExpressReceiptImportService 增强功能测试 重复记录检查功能 没有重复记录时 正常创建所有记录
      Failure/Error: expect(result[:success]).to be true

        expected true
             got false
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:59:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  66) UnifiedExpressReceiptImportService 增强功能测试 状态管理功能 更新报销单状态为已收单
      Failure/Error: expect(reimbursement.receipt_status).to eq('received')

        expected: "received"
             got: "pending"

        (compared using ==)
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:100:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  67) UnifiedExpressReceiptImportService 增强功能测试 状态管理功能 重置通知状态
      Failure/Error: expect(reimbursement.last_viewed_express_receipts_at).to be_nil

        expected: nil
             got: 2025-10-28 23:52:38.883081000 +0000
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:111:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  68) UnifiedExpressReceiptImportService 增强功能测试 状态管理功能 记录通知重置到日志
      Failure/Error: expect(Rails.logger).to receive(:debug).with(/重置报销单.*通知状态/)

        (#<ActiveSupport::BroadcastLogger:0x00000001391e7988 @broadcasts=[#<ActiveSupport::Logger:0x000000013918e6a8 @level=0, @progname=nil, @default_formatter=#<Logger::Formatter:0x00000001391ea0e8 @datetime_format=nil>, @formatter=#<ActiveSupport::Logger::SimpleFormatter:0x00000001391e7d48 @datetime_format=nil, @thread_key="activesupport_tagged_logging_tags:11512">, @logdev=#<Logger::LogDevice:0x000000013941a020 @shift_period_suffix="%Y%m%d", @shift_size=104857600, @shift_age=1, @filename="/Users/dreamlinx/Dropbox/Projects/NetBeansProjects/think-bridge/sci2/log/test.log", @dev=#<File:/Users/dreamlinx/Dropbox/Projects/NetBeansProjects/think-bridge/sci2/log/test.log>, @binmode=false, @reraise_write_errors=[], @skip_header=false, @mon_data=#<Monitor:0x00000001391e9ff8>, @mon_data_owner_object_id=3360>, @level_override={}, @local_level_key=:logger_thread_safe_level_11472>], @progname="Broadcast", @formatter=#<ActiveSupport::Logger::SimpleFormatter:0x00000001391e7d48 @datetime_format=nil, @thread_key="activesupport_tagged_logging_tags:11512">>).debug(/重置报销单.*通知状态/)
            expected: 1 time with arguments: (/重置报销单.*通知状态/)
            received: 0 times
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:115:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  69) UnifiedExpressReceiptImportService 增强功能测试 增强时间解析功能 各种时间格式支持 正确解析多种时间格式
      Failure/Error: expect(result[:success]).to be true

        expected true
             got false
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:147:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  70) UnifiedExpressReceiptImportService 增强功能测试 增强时间解析功能 Excel序列号格式拒绝 拒绝Excel序列号格式
      Failure/Error: expect(result[:success]).to be true # 应该处理成功但时间为nil

        expected true
             got false
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:182:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  71) UnifiedExpressReceiptImportService 增强功能测试 错误处理增强 状态机转换错误 处理状态转换错误并记录
      Failure/Error: expect(result[:success]).to be true # 第一条记录失败但第二条可能成功

        expected true
             got false
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:199:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  72) UnifiedExpressReceiptImportService 增强功能测试 错误处理增强 事务处理错误 处理事务错误并记录
      Failure/Error: expect(result[:errors]).to include(/事务处理失败/)

        expected ["缺少必需字段: 快递单号。请确保文件包含以下列: 快递单号"] to include /事务处理失败/
        Diff:
        @@ -1 +1 @@
        -[/事务处理失败/]
        +["缺少必需字段: 快递单号。请确保文件包含以下列: 快递单号"]
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:216:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  73) UnifiedExpressReceiptImportService 增强功能测试 字段映射增强 支持多种字段名变体
      Failure/Error: expect(result[:success]).to be true

        expected true
             got false
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:245:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  74) UnifiedExpressReceiptImportService 性能和兼容性测试 BaseImportService继承 继承BaseImportService的所有方法
      Failure/Error: expect(service).to respond_to(:validate_file, true)

      TypeError:
        true is not a symbol nor a string
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:287:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  75) UnifiedExpressReceiptImportService 性能和兼容性测试 文件扩展名支持 支持.csv文件格式
      Failure/Error: expect(service.send(:supported_extension?, extension.delete('.'))).to be_truthy

      NameError:
        undefined local variable or method 'service' for #<RSpec::ExampleGroups::UnifiedExpressReceiptImportService::Nested_2::Nested:0x00000001699d7410>
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:297:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  76) UnifiedExpressReceiptImportService 性能和兼容性测试 文件扩展名支持 支持.xls文件格式
      Failure/Error: expect(service.send(:supported_extension?, extension.delete('.'))).to be_truthy

      NameError:
        undefined local variable or method 'service' for #<RSpec::ExampleGroups::UnifiedExpressReceiptImportService::Nested_2::Nested:0x0000000169bf1688>
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:297:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  77) UnifiedExpressReceiptImportService 性能和兼容性测试 文件扩展名支持 支持.xlsx文件格式
      Failure/Error: expect(service.send(:supported_extension?, extension.delete('.'))).to be_truthy

      NameError:
        undefined local variable or method 'service' for #<RSpec::ExampleGroups::UnifiedExpressReceiptImportService::Nested_2::Nested:0x0000000169bd85c0>
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:297:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  78) UnifiedExpressReceiptImportService 性能和兼容性测试 文件扩展名支持 支持.XLS文件格式
      Failure/Error: expect(service.send(:supported_extension?, extension.delete('.'))).to be_truthy

      NameError:
        undefined local variable or method 'service' for #<RSpec::ExampleGroups::UnifiedExpressReceiptImportService::Nested_2::Nested:0x0000000169b9f518>
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:297:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  79) UnifiedExpressReceiptImportService 性能和兼容性测试 文件扩展名支持 支持.XLSX文件格式
      Failure/Error: expect(service.send(:supported_extension?, extension.delete('.'))).to be_truthy

      NameError:
        undefined local variable or method 'service' for #<RSpec::ExampleGroups::UnifiedExpressReceiptImportService::Nested_2::Nested:0x0000000169b95d38>
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:297:in 'block (5 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  80) UnifiedExpressReceiptImportService 性能和兼容性测试 边界条件处理 处理只有表头的文件
      Failure/Error: expect(result[:success]).to be true # 没有数据行也算成功

        expected true
             got false
      # ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:326:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  81) UnifiedExpressReceiptImportService#import with valid file containing express receipt data processes express receipts successfully
      Failure/Error: @file.path
        #<Double "csv_file"> received unexpected message :path with (no args)
      # ./app/services/base_import_service.rb:97:in 'BaseImportService#extract_file_path'
      # ./app/services/base_import_service.rb:40:in 'BaseImportService#parse_file'
      # ./app/services/unified_express_receipt_import_service.rb:16:in 'UnifiedExpressReceiptImportService#import'
      # ./spec/services/unified_express_receipt_import_service_spec.rb:33:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  82) UnifiedExpressReceiptImportService#import with valid file containing express receipt data creates ExpressReceipt records
      Failure/Error:
        expect { service.import(test_spreadsheet) }
          .to change { ExpressReceipt.count }.by(1)

      NameError:
        uninitialized constant ExpressReceipt
      # ./spec/services/unified_express_receipt_import_service_spec.rb:42:in 'block (5 levels) in <top (required)>'
      # ./spec/services/unified_express_receipt_import_service_spec.rb:42:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  83) UnifiedExpressReceiptImportService#import with valid file containing express receipt data handles unmatched receipts
      Failure/Error: @file.path
        #<Double "csv_file"> received unexpected message :path with (no args)
      # ./app/services/base_import_service.rb:97:in 'BaseImportService#extract_file_path'
      # ./app/services/base_import_service.rb:40:in 'BaseImportService#parse_file'
      # ./app/services/unified_express_receipt_import_service.rb:16:in 'UnifiedExpressReceiptImportService#import'
      # ./spec/services/unified_express_receipt_import_service_spec.rb:46:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  84) UnifiedExpressReceiptImportService#import with missing required fields returns validation error
      Failure/Error: @file.path
        #<Double "csv_file"> received unexpected message :path with (no args)
      # ./app/services/base_import_service.rb:97:in 'BaseImportService#extract_file_path'
      # ./app/services/base_import_service.rb:40:in 'BaseImportService#parse_file'
      # ./app/services/unified_express_receipt_import_service.rb:16:in 'UnifiedExpressReceiptImportService#import'
      # ./spec/services/unified_express_receipt_import_service_spec.rb:74:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  85) UnifiedExpressReceiptImportService#import with tracking number in text field extracts tracking number from text using regex
      Failure/Error: @file.path
        #<Double "csv_file"> received unexpected message :path with (no args)
      # ./app/services/base_import_service.rb:97:in 'BaseImportService#extract_file_path'
      # ./app/services/base_import_service.rb:40:in 'BaseImportService#parse_file'
      # ./app/services/unified_express_receipt_import_service.rb:16:in 'UnifiedExpressReceiptImportService#import'
      # ./spec/services/unified_express_receipt_import_service_spec.rb:112:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  86) UnifiedExpressReceiptImportService#validate_required_fields returns error when required fields are missing
      Failure/Error: expect(result[:errors]).to include('缺少必需字段: 快递单号')
        expected ["缺少必需字段: 快递单号。请确保文件包含以下列: 快递单号"] to include "缺少必需字段: 快递单号"
      # ./spec/services/unified_express_receipt_import_service_spec.rb:134:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  87) UnifiedExpressReceiptImportService#find_matching_fee_detail with matching document number and receipt number finds fee detail by both criteria
      Failure/Error: fee_detail = service.send(:find_matching_fee_detail, 'SF123456789', row_data)

      NoMethodError:
        undefined method 'find_matching_fee_detail' for an instance of UnifiedExpressReceiptImportService
      # ./spec/services/unified_express_receipt_import_service_spec.rb:173:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  88) UnifiedExpressReceiptImportService#find_matching_fee_detail with only receipt number match finds fee detail by receipt number only
      Failure/Error: fee_detail = service.send(:find_matching_fee_detail, 'SF123456789', row_data)

      NoMethodError:
        undefined method 'find_matching_fee_detail' for an instance of UnifiedExpressReceiptImportService
      # ./spec/services/unified_express_receipt_import_service_spec.rb:182:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  89) UnifiedExpressReceiptImportService#find_matching_fee_detail with no matching fee detail returns nil
      Failure/Error: fee_detail = service.send(:find_matching_fee_detail, 'NONEXISTENT', row_data)

      NoMethodError:
        undefined method 'find_matching_fee_detail' for an instance of UnifiedExpressReceiptImportService
      # ./spec/services/unified_express_receipt_import_service_spec.rb:191:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  90) UnifiedExpressReceiptImportService#parse_date_field parses valid datetime string
      Failure/Error: expect(parsed_date).to be_a(Time)
        expected Mon, 15 Jan 2024 to be a kind of Time
      # ./spec/services/unified_express_receipt_import_service_spec.rb:233:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  91) UnifiedExpressReceiptImportService#create_or_update_express_receipt with new express receipt creates new express receipt
      Failure/Error:
        expect {
          service.send(:create_or_update_express_receipt, fee_detail, row_data, 1)
        }.to change { ExpressReceipt.count }.by(1)

      NameError:
        uninitialized constant ExpressReceipt
      # ./spec/services/unified_express_receipt_import_service_spec.rb:267:in 'block (5 levels) in <top (required)>'
      # ./spec/services/unified_express_receipt_import_service_spec.rb:267:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  92) UnifiedExpressReceiptImportService#create_or_update_express_receipt with existing express receipt updates existing express receipt
      Failure/Error: let(:reimbursement) { create(:reimbursement, document_number: 'DOC001') }

      NoMethodError:
        undefined method 'document_number=' for an instance of Reimbursement
      # ./spec/services/unified_express_receipt_import_service_spec.rb:6:in 'block (2 levels) in <top (required)>'
      # ./spec/services/unified_express_receipt_import_service_spec.rb:7:in 'block (2 levels) in <top (required)>'
      # ./spec/services/unified_express_receipt_import_service_spec.rb:277:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  93) UnifiedExpressReceiptImportService#create_or_update_express_receipt with invalid data handles save errors gracefully
      Failure/Error:
        expect {
          service.send(:create_or_update_express_receipt, fee_detail, invalid_row_data, 1)
        }.not_to change { ExpressReceipt.count }

      NameError:
        uninitialized constant ExpressReceipt
      # ./spec/services/unified_express_receipt_import_service_spec.rb:295:in 'block (5 levels) in <top (required)>'
      # ./spec/services/unified_express_receipt_import_service_spec.rb:295:in 'block (4 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  94) UnifiedExpressReceiptImportService#handle_unmatched_receipt adds receipt to unmatched list
      Failure/Error: expect(service.unmatched_receipts.length).to eq(1)

      NoMethodError:
        undefined method 'unmatched_receipts' for an instance of UnifiedExpressReceiptImportService
      # ./spec/services/unified_express_receipt_import_service_spec.rb:314:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  95) WorkOrderOperationService#record_create creates a new operation record with create type
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/work_order_operation_service_spec.rb:5:in 'block (2 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:7:in 'block (2 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:12:in 'block (4 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:13:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  96) WorkOrderOperationService#record_update creates a new operation record with update type
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/work_order_operation_service_spec.rb:5:in 'block (2 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:7:in 'block (2 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:30:in 'block (4 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:31:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  97) WorkOrderOperationService#record_update does not create a record if no attributes changed
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/work_order_operation_service_spec.rb:5:in 'block (2 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:7:in 'block (2 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:43:in 'block (4 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:44:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  98) WorkOrderOperationService#record_status_change creates a new operation record with status_change type
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/work_order_operation_service_spec.rb:5:in 'block (2 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:7:in 'block (2 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:51:in 'block (4 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:52:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  99) WorkOrderOperationService#record_add_problem creates a new operation record with add_problem type
      Failure/Error: reimbursement.start_processing

      ActiveRecord::StatementInvalid:
        PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
      # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
      # ./spec/services/work_order_operation_service_spec.rb:5:in 'block (2 levels) in <top (required)>'
      # ./spec/services/work_order_operation_service_spec.rb:69:in 'block (3 levels) in <top (required)>'
      # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
      # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
      # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
      # ------------------
      # --- Caused by: ---
      # PG::InFailedSqlTransaction:
      #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
      #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  100) WorkOrderOperationService#record_remove_problem creates a new operation record with remove_problem type
       Failure/Error: reimbursement.start_processing

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
       # ./spec/services/work_order_operation_service_spec.rb:5:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_operation_service_spec.rb:7:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_operation_service_spec.rb:95:in 'block (4 levels) in <top (required)>'
       # ./spec/services/work_order_operation_service_spec.rb:96:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  101) WorkOrderOperationService#record_modify_problem creates a new operation record with modify_problem type
       Failure/Error: reimbursement.start_processing

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'
       # ./spec/services/work_order_operation_service_spec.rb:5:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_operation_service_spec.rb:7:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_operation_service_spec.rb:115:in 'block (4 levels) in <top (required)>'
       # ./spec/services/work_order_operation_service_spec.rb:116:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./app/models/work_order.rb:268:in 'WorkOrder#update_reimbursement_status_on_create'

  102) WorkOrderProblemService#add_problem adds a single problem type
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:54:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  103) WorkOrderProblemService#add_problem does not add duplicate problem type
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:62:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  104) WorkOrderProblemService#add_problems adds multiple problem types
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:74:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  105) WorkOrderProblemService#add_problems replaces existing problem types
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:83:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  106) WorkOrderProblemService#add_problems returns false if problem_type_ids is blank
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:95:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  107) WorkOrderProblemService#remove_problem removes a problem type
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:104:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  108) WorkOrderProblemService#remove_problem returns true even if problem type was not associated
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:114:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  109) WorkOrderProblemService#clear_problems removes all problem types
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:123:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  110) WorkOrderProblemService#clear_problems clears audit_comment if present
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:133:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  111) WorkOrderProblemService#clear_problems clears problem_type_id if present
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:142:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  112) WorkOrderProblemService#get_problems returns all associated problem types
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:153:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  113) WorkOrderProblemService#get_problems returns empty array when there are no problems
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:163:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  114) WorkOrderProblemService#get_formatted_problems returns formatted problem descriptions
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:172:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  115) WorkOrderProblemService#generate_audit_comment generates audit comment from problem types
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:190:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  116) WorkOrderProblemService#generate_audit_comment returns nil when there are no problems
       Failure/Error:
         AuditWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: nil
         )

       ActiveRecord::StatementInvalid:
         PG::InFailedSqlTransaction: ERROR:  current transaction is aborted, commands ignored until end of transaction block
       # ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_problem_service_spec.rb:208:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'
       # ------------------
       # --- Caused by: ---
       # PG::InFailedSqlTransaction:
       #   ERROR:  current transaction is aborted, commands ignored until end of transaction block
       #   ./spec/services/work_order_problem_service_spec.rb:14:in 'block (2 levels) in <top (required)>'

  117) WorkOrderService 沟通工单状态处理 处理意见设置为'可以通过' 工单状态变更为approved
       Failure/Error:
         work_order = CommunicationWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: admin_user.id
         )

       ActiveRecord::RecordInvalid:
         验证失败: Audit comment不能为空, Audit comment沟通内容至少需要10个字符, 沟通方式不能为空
       # ./spec/services/work_order_service_spec.rb:128:in 'block (3 levels) in <top (required)>'
       # ./spec/services/work_order_service_spec.rb:148:in 'block (4 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  118) WorkOrderService 沟通工单状态处理 处理意见设置为'可以通过' 关联的费用明细状态变更为verified
       Failure/Error:
         work_order = CommunicationWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: admin_user.id
         )

       ActiveRecord::RecordInvalid:
         验证失败: Audit comment不能为空, Audit comment沟通内容至少需要10个字符, 沟通方式不能为空
       # ./spec/services/work_order_service_spec.rb:128:in 'block (3 levels) in <top (required)>'
       # ./spec/services/work_order_service_spec.rb:159:in 'block (4 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  119) WorkOrderService 沟通工单状态处理 处理意见设置为'无法通过' 工单状态变更为rejected
       Failure/Error:
         work_order = CommunicationWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: admin_user.id
         )

       ActiveRecord::RecordInvalid:
         验证失败: Audit comment不能为空, Audit comment沟通内容至少需要10个字符, 沟通方式不能为空
       # ./spec/services/work_order_service_spec.rb:128:in 'block (3 levels) in <top (required)>'
       # ./spec/services/work_order_service_spec.rb:172:in 'block (4 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  120) WorkOrderService 沟通工单状态处理 处理意见设置为'无法通过' 关联的费用明细状态变更为problematic
       Failure/Error:
         work_order = CommunicationWorkOrder.create!(
           reimbursement: reimbursement,
           status: 'pending',
           created_by: admin_user.id
         )

       ActiveRecord::RecordInvalid:
         验证失败: Audit comment不能为空, Audit comment沟通内容至少需要10个字符, 沟通方式不能为空
       # ./spec/services/work_order_service_spec.rb:128:in 'block (3 levels) in <top (required)>'
       # ./spec/services/work_order_service_spec.rb:183:in 'block (4 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  121) WorkOrderService 多问题类型处理 支持添加多个问题类型
       Failure/Error:
         FeeType.create!(
           code: '00',
           title: '月度交通费',
           meeting_type: '个人',
           active: true
         )

       ActiveModel::UnknownAttributeError:
         unknown attribute 'meeting_type' for FeeType.
       # ./spec/services/work_order_service_spec.rb:27:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_service_spec.rb:41:in 'block (2 levels) in <top (required)>'
       # ./spec/services/work_order_service_spec.rb:225:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  122) WorkOrderService#approve 成功批准工单并更新状态
       Failure/Error: expect(result).to be true

         expected true
              got nil
       # ./spec/services/work_order_service_spec.rb:316:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  123) WorkOrderService#approve 批准时设置审核日期
       Failure/Error: expect(result).to be true

         expected true
              got nil
       # ./spec/services/work_order_service_spec.rb:325:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  124) WorkOrderService#approve 批准时记录操作历史
       Failure/Error:
         expect do
           service.approve(audit_comment: '测试批准')
         end.to change(WorkOrderOperation, :count).by(1)

         expected `WorkOrderOperation.count` to have changed by 1, but was changed by 4
       # ./spec/services/work_order_service_spec.rb:333:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  125) WorkOrderService#reject 成功拒绝工单并更新状态
       Failure/Error: expect(result).to be true

         expected true
              got nil
       # ./spec/services/work_order_service_spec.rb:366:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  126) WorkOrderService#reject 拒绝时设置审核日期
       Failure/Error: expect(result).to be true

         expected true
              got nil
       # ./spec/services/work_order_service_spec.rb:375:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  127) WorkOrderService#reject 拒绝时记录操作历史
       Failure/Error:
         expect do
           service.reject(audit_comment: '测试拒绝')
         end.to change(WorkOrderOperation, :count).by(1)

         expected `WorkOrderOperation.count` to have changed by 1, but was changed by 4
       # ./spec/services/work_order_service_spec.rb:382:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  128) WorkOrderService#update 处理意见变更为"可以通过"时调用approve方法
       Failure/Error: expect(result).to be true

         expected true
              got nil
       # ./spec/services/work_order_service_spec.rb:423:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  129) WorkOrderService#update 处理意见变更为"无法通过"时调用reject方法
       Failure/Error: expect(result).to be true

         expected true
              got nil
       # ./spec/services/work_order_service_spec.rb:431:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  130) WorkOrderService#update 更新时记录操作历史
       Failure/Error:
         expect do
           service.update(audit_comment: '更新测试')
         end.to change(WorkOrderOperation, :count).by(1)

         expected `WorkOrderOperation.count` to have changed by 1, but was changed by 3
       # ./spec/services/work_order_service_spec.rb:439:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  131) WorkOrderService#mark_as_truly_completed 成功标记工单为真正完成
       Failure/Error: if @work_order.mark_as_truly_completed(@current_admin_user) # Call model method

       NoMethodError:
         undefined method 'mark_as_truly_completed' for an instance of AuditWorkOrder
       # ./app/services/work_order_service.rb:86:in 'WorkOrderService#mark_as_truly_completed'
       # ./spec/services/work_order_service_spec.rb:476:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  132) WorkOrderService#mark_as_truly_completed 标记完成时记录操作历史
       Failure/Error: if @work_order.mark_as_truly_completed(@current_admin_user) # Call model method

       NoMethodError:
         undefined method 'mark_as_truly_completed' for an instance of AuditWorkOrder
       # ./app/services/work_order_service.rb:86:in 'WorkOrderService#mark_as_truly_completed'
       # ./spec/services/work_order_service_spec.rb:486:in 'block (4 levels) in <top (required)>'
       # ./spec/services/work_order_service_spec.rb:487:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  133) WorkOrderService#mark_as_truly_completed 当工单已经标记为完成 返回错误
       Failure/Error:
         audit_work_order.update_columns(
           is_truly_completed: true,
           completed_at: 1.day.ago,
           completed_by_id: admin_user.id
         )

       ActiveModel::MissingAttributeError:
         can't write unknown attribute `is_truly_completed`
       # ./spec/services/work_order_service_spec.rb:495:in 'block (4 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  134) WorkOrderService#process_action 统一逻辑 approve和reject使用相同的process_action逻辑
       Failure/Error: expect(result1).to be true

         expected true
              got nil
       # ./spec/services/work_order_service_spec.rb:582:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  135) WorkOrderService#process_action 统一逻辑 状态机异常处理 捕获 StateMachines::InvalidTransition 异常
       Failure/Error: expect(result).to be false

         expected false
              got true
       # ./spec/services/work_order_service_spec.rb:601:in 'block (4 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  136) WorkOrderService 费用明细选择处理 处理费用明细选择
       Failure/Error:
         WorkOrderFeeDetail.create!(
           work_order: @work_order,
           fee_detail: fee_detail,
           work_order_type: @work_order.type
         )

       ActiveModel::UnknownAttributeError:
         unknown attribute 'work_order_type' for WorkOrderFeeDetail.
       # ./app/services/work_order_service.rb:220:in 'block in WorkOrderService#process_fee_detail_selections'
       # ./app/services/work_order_service.rb:212:in 'Array#each'
       # ./app/services/work_order_service.rb:212:in 'WorkOrderService#process_fee_detail_selections'
       # ./spec/services/work_order_service_spec.rb:631:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  137) WorkOrderService 费用明细选择处理 清除现有关联并创建新关联
       Failure/Error:
         WorkOrderFeeDetail.create!(
           work_order: @work_order,
           fee_detail: fee_detail,
           work_order_type: @work_order.type
         )

       ActiveModel::UnknownAttributeError:
         unknown attribute 'work_order_type' for WorkOrderFeeDetail.
       # ./app/services/work_order_service.rb:220:in 'block in WorkOrderService#process_fee_detail_selections'
       # ./app/services/work_order_service.rb:212:in 'Array#each'
       # ./app/services/work_order_service.rb:212:in 'WorkOrderService#process_fee_detail_selections'
       # ./spec/services/work_order_service_spec.rb:647:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  138) WorkOrderService 费用明细选择处理 忽略不属于同一报销单的费用明细
       Failure/Error:
         WorkOrderFeeDetail.create!(
           work_order: @work_order,
           fee_detail: fee_detail,
           work_order_type: @work_order.type
         )

       ActiveModel::UnknownAttributeError:
         unknown attribute 'work_order_type' for WorkOrderFeeDetail.
       # ./app/services/work_order_service.rb:220:in 'block in WorkOrderService#process_fee_detail_selections'
       # ./app/services/work_order_service.rb:212:in 'Array#each'
       # ./app/services/work_order_service.rb:212:in 'WorkOrderService#process_fee_detail_selections'
       # ./spec/services/work_order_service_spec.rb:670:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  139) WorkOrderService 审核日期自动设置 approve时自动设置audit_date
       Failure/Error:
               freeze_time do
                 service.approve
         
                 expect(audit_work_order.reload.audit_date).to be_within(1.second).of(Time.current)
               end

       NoMethodError:
         undefined method 'freeze_time' for #<RSpec::ExampleGroups::WorkOrderService::Nested_6:0x000000013e18c3a8>
       # ./spec/services/work_order_service_spec.rb:694:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  140) WorkOrderService 审核日期自动设置 reject时自动设置audit_date
       Failure/Error:
               freeze_time do
                 service.reject
         
                 expect(audit_work_order.reload.audit_date).to be_within(1.second).of(Time.current)
               end

       NoMethodError:
         undefined method 'freeze_time' for #<RSpec::ExampleGroups::WorkOrderService::Nested_6:0x0000000138b10b50>
       # ./spec/services/work_order_service_spec.rb:702:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  141) WorkOrderService 费用明细同步 approve后调用sync_fee_details_verification_status
       Failure/Error: expect(audit_work_order).to receive(:sync_fee_details_verification_status).and_call_original

         (#<AuditWorkOrder id: 122, reimbursement_id: 795, type: "AuditWorkOrder", status: "approved", created_by: 720, processing_opinion: "可以通过", tracking_number: nil, received_at: nil, courier_name: nil, audit_result: nil, audit_comment: nil, audit_date: nil, vat_verified: nil, created_at: "2025-10-28 23:52:40.545057000 +0000", updated_at: "2025-10-28 23:52:40.554301000 +0000", problem_type_id: nil, initiator_role: "internal", communication_method: nil, fee_type_id: nil, filling_id: nil>).sync_fee_details_verification_status(*(any args))
             expected: 1 time with any arguments
             received: 2 times with any arguments
       # ./spec/services/work_order_service_spec.rb:727:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

  142) WorkOrderService 费用明细同步 reject后调用sync_fee_details_verification_status
       Failure/Error: expect(audit_work_order).to receive(:sync_fee_details_verification_status).and_call_original

         (#<AuditWorkOrder id: 123, reimbursement_id: 796, type: "AuditWorkOrder", status: "rejected", created_by: 721, processing_opinion: "无法通过", tracking_number: nil, received_at: nil, courier_name: nil, audit_result: nil, audit_comment: nil, audit_date: nil, vat_verified: nil, created_at: "2025-10-28 23:52:40.574572000 +0000", updated_at: "2025-10-28 23:52:40.582569000 +0000", problem_type_id: nil, initiator_role: "internal", communication_method: nil, fee_type_id: nil, filling_id: nil>).sync_fee_details_verification_status(*(any args))
             expected: 1 time with any arguments
             received: 2 times with any arguments
       # ./spec/services/work_order_service_spec.rb:733:in 'block (3 levels) in <top (required)>'
       # ./spec/rails_helper.rb:153:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:52:in 'block (2 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:20:in 'block (3 levels) in <top (required)>'
       # ./spec/support/performance_helper.rb:19:in 'block (2 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:22:in 'block (3 levels) in <top (required)>'
       # ./spec/support/database_cleaner.rb:21:in 'block (2 levels) in <top (required)>'

Finished in 11.89 seconds (files took 1.39 seconds to load)
580 examples, 142 failures

Failed examples:

rspec ./spec/services/audit_work_order_service_spec.rb:17 # AuditWorkOrderService#start_processing adds errors if processing fails
rspec ./spec/services/audit_work_order_service_spec.rb:25 # AuditWorkOrderService#approve approves the audit work order
rspec ./spec/services/audit_work_order_service_spec.rb:33 # AuditWorkOrderService#approve adds errors if approval fails
rspec ./spec/services/audit_work_order_service_spec.rb:44 # AuditWorkOrderService#reject rejects the audit work order
rspec ./spec/services/audit_work_order_service_spec.rb:52 # AuditWorkOrderService#reject adds errors if rejection fails
rspec ./spec/services/audit_work_order_service_spec.rb:59 # AuditWorkOrderService#reject requires an audit comment
rspec ./spec/services/audit_work_order_service_spec.rb:69 # AuditWorkOrderService#select_fee_detail selects a fee detail
rspec ./spec/services/audit_work_order_service_spec.rb:79 # AuditWorkOrderService#select_fee_detail does not select a fee detail if it does not belong to the same reimbursement
rspec ./spec/services/audit_work_order_service_spec.rb:93 # AuditWorkOrderService#select_fee_details selects multiple fee details
rspec ./spec/services/audit_work_order_service_spec.rb:103 # AuditWorkOrderService#select_fee_details does not select fee details if they do not belong to the same reimbursement
rspec ./spec/services/audit_work_order_service_spec.rb:116 # AuditWorkOrderService#update_fee_detail_verification updates the verification status of a fee detail
rspec ./spec/services/audit_work_order_service_spec.rb:125 # AuditWorkOrderService#update_fee_detail_verification adds errors if the fee detail is not found
rspec ./spec/services/audit_work_order_service_spec.rb:130 # AuditWorkOrderService#update_fee_detail_verification adds errors if the verification update fails
rspec ./spec/services/base_import_service_spec.rb:19 # BaseImportService#initialize sets Current.admin_user
rspec ./spec/services/express_receipt_import_service_spec.rb:131 # ExpressReceiptImportService#import with duplicate records skips duplicate records
rspec ./spec/services/fee_detail_group_service_spec.rb:95 # FeeDetailGroupService#group_by_fee_type groups fee details by fee type
rspec ./spec/services/fee_detail_group_service_spec.rb:114 # FeeDetailGroupService#group_by_fee_type returns empty array if no fee details are provided
rspec ./spec/services/fee_detail_group_service_spec.rb:123 # FeeDetailGroupService#fee_types returns unique fee types
rspec ./spec/services/fee_detail_group_service_spec.rb:133 # FeeDetailGroupService#fee_type_ids returns fee type ids
rspec ./spec/services/fee_detail_group_service_spec.rb:143 # FeeDetailGroupService#available_problem_types returns problem types for the fee types
rspec ./spec/services/fee_detail_group_service_spec.rb:153 # FeeDetailGroupService#problem_types_by_fee_type groups problem types by fee type
rspec ./spec/services/fee_detail_import_service_flex_fields_spec.rb:61 # FeeDetailImportService 弹性字段导入测试 弹性字段影响meeting_type_context方法
rspec ./spec/services/fee_detail_status_service_spec.rb:24 # FeeDetailStatusService#update_status 当费用明细只关联审核工单时 应该根据审核工单状态更新
rspec ./spec/services/fee_detail_status_service_spec.rb:41 # FeeDetailStatusService#update_status 当费用明细只关联沟通工单时 状态应该保持为 pending（沟通工单不影响状态）
rspec ./spec/services/fee_detail_status_service_spec.rb:60 # FeeDetailStatusService#update_status 当费用明细同时关联审核工单和沟通工单时 应该只根据审核工单状态更新，忽略沟通工单
rspec ./spec/services/fee_detail_status_service_spec.rb:85 # FeeDetailStatusService#update_status 当有多个审核工单和沟通工单时 应该根据最新的审核工单状态更新
rspec ./spec/services/fee_detail_status_service_spec.rb:108 # FeeDetailStatusService#get_latest_work_order 当有审核工单和沟通工单时 应该返回最新的审核工单，排除沟通工单
rspec ./spec/services/fee_detail_status_service_spec.rb:122 # FeeDetailStatusService#get_latest_work_order 当只有沟通工单时 应该返回 nil
rspec ./spec/services/fee_detail_status_service_spec.rb:135 # FeeDetailStatusService#determine_status_from_work_order 当工单是沟通工单时 应该返回 pending
rspec ./spec/services/fee_detail_status_service_spec.rb:142 # FeeDetailStatusService#determine_status_from_work_order 当工单是审核工单时 已批准的审核工单应该返回 verified
rspec ./spec/services/fee_detail_status_service_spec.rb:148 # FeeDetailStatusService#determine_status_from_work_order 当工单是审核工单时 已拒绝的审核工单应该返回 problematic
rspec ./spec/services/fee_detail_status_service_spec.rb:154 # FeeDetailStatusService#determine_status_from_work_order 当工单是审核工单时 待处理的审核工单应该返回 pending
rspec ./spec/services/operation_history_import_service_spec.rb:45 # OperationHistoryImportService Automatic Reopening Removal still imports operation history for closed reimbursements
rspec ./spec/services/operation_history_import_service_spec.rb:136 # OperationHistoryImportService Automatic Reopening Removal automatic auditor assignment from operation history when reimbursement has no active assignment and operation type is "加签" automatically assigns the reimbursement to the matching operator
rspec ./spec/services/operation_history_import_service_spec.rb:155 # OperationHistoryImportService Automatic Reopening Removal automatic auditor assignment from operation history when reimbursement has no active assignment and operation type is "加签" handles operator name with extra content
rspec ./spec/services/operation_history_import_service_spec.rb:276 # OperationHistoryImportService Operation History Creation still creates operation history records correctly
rspec ./spec/services/problem_finder_service_spec.rb:45 # ProblemFinderService.find_for when there is a precise match and a general match returns both precise and general problems
rspec ./spec/services/problem_finder_service_spec.rb:56 # ProblemFinderService.find_for when there is only a general match (user entered fee_type does not match) returns only the general problems
rspec ./spec/services/problem_finder_service_spec.rb:70 # ProblemFinderService.find_for when user entered fee_type matches but there are no precise problems, only general returns only the general problems
rspec ./spec/services/problem_finder_service_spec.rb:80 # ProblemFinderService.find_for when context does not match anything returns an empty collection
rspec ./spec/services/reimbursement_authorization_service_spec.rb:66 # ReimbursementAuthorizationService#default_scope with admin user returns assigned_to_me
rspec ./spec/services/reimbursement_authorization_service_spec.rb:84 # ReimbursementAuthorizationService#apply_role_based_default_filter with admin user filters to assigned reimbursements
rspec ./spec/services/reimbursement_authorization_service_spec.rb:161 # ReimbursementAuthorizationService#apply_scope_filter with status scopes (default behavior) filters by processing status
rspec ./spec/services/reimbursement_authorization_service_spec.rb:192 # ReimbursementAuthorizationService#apply_scope_filter with unassigned scope filters to unassigned reimbursements by default
rspec ./spec/services/reimbursement_authorization_service_spec.rb:209 # ReimbursementAuthorizationService#apply_scope_filter with all scope returns assigned reimbursements by default
rspec ./spec/services/reimbursement_authorization_service_spec.rb:270 # ReimbursementAuthorizationService#apply_scope_filter with no scope applies role-based default filter
rspec ./spec/services/reimbursement_authorization_service_spec.rb:300 # ReimbursementAuthorizationService#should_show_default_scope_notice? with admin user returns true
rspec ./spec/services/reimbursement_authorization_service_spec.rb:318 # ReimbursementAuthorizationService#default_scope_notice with admin user returns notice message
rspec ./spec/services/reimbursement_authorization_service_spec.rb:337 # ReimbursementAuthorizationService#should_use_global_view? with admin user returns false by default
rspec ./spec/services/reimbursement_authorization_service_spec.rb:381 # ReimbursementAuthorizationService#global_view_notice with admin user returns appropriate notice for admin users
rspec ./spec/services/reimbursement_import_service_spec.rb:278 # ReimbursementImportService#import with file error automatic auditor assignment when current approval node is "审核" and approver matches admin user automatically assigns the reimbursement to the matching auditor
rspec ./spec/services/reimbursement_import_service_spec.rb:301 # ReimbursementImportService#import with file error automatic auditor assignment when current approval node is "审核" and approver matches admin user handles approver name with extra content
rspec ./spec/services/reimbursement_import_service_status_logic_spec.rb:11 # ReimbursementImportService New Status Logic Integration #determine_status_from_external returns "closed" for "已付款" external status
rspec ./spec/services/reimbursement_import_service_status_logic_spec.rb:16 # ReimbursementImportService New Status Logic Integration #determine_status_from_external returns "closed" for "待付款" external status
rspec ./spec/services/reimbursement_import_service_status_logic_spec.rb:21 # ReimbursementImportService New Status Logic Integration #determine_status_from_external returns "processing" for "审批中" when work orders exist
rspec ./spec/services/reimbursement_import_service_status_logic_spec.rb:27 # ReimbursementImportService New Status Logic Integration #determine_status_from_external returns "pending" for "审批中" when no work orders exist
rspec ./spec/services/reimbursement_import_service_status_logic_spec.rb:32 # ReimbursementImportService New Status Logic Integration #determine_status_from_external respects manual override protection
rspec ./spec/services/reimbursement_import_service_status_logic_spec.rb:44 # ReimbursementImportService New Status Logic Integration External Status Priority prioritizes external status over work order logic
rspec ./spec/services/reimbursement_import_service_status_logic_spec.rb:53 # ReimbursementImportService New Status Logic Integration External Status Priority uses work order logic when external status allows
rspec ./spec/services/reimbursement_import_service_status_logic_spec.rb:64 # ReimbursementImportService New Status Logic Integration Last External Status Tracking updates last_external_status when status changes
rspec ./spec/services/reimbursement_import_service_status_logic_spec.rb:73 # ReimbursementImportService New Status Logic Integration Last External Status Tracking tracks external status changes over time
rspec ./spec/services/reimbursement_import_service_status_logic_spec.rb:107 # ReimbursementImportService Integration with Import Process applies new status logic during import
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:40 # UnifiedExpressReceiptImportService 增强功能测试 重复记录检查功能 存在重复记录时 跳过重复记录
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:49 # UnifiedExpressReceiptImportService 增强功能测试 重复记录检查功能 存在重复记录时 记录跳过原因到日志
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:56 # UnifiedExpressReceiptImportService 增强功能测试 重复记录检查功能 没有重复记录时 正常创建所有记录
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:96 # UnifiedExpressReceiptImportService 增强功能测试 状态管理功能 更新报销单状态为已收单
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:104 # UnifiedExpressReceiptImportService 增强功能测试 状态管理功能 重置通知状态
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:114 # UnifiedExpressReceiptImportService 增强功能测试 状态管理功能 记录通知重置到日志
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:143 # UnifiedExpressReceiptImportService 增强功能测试 增强时间解析功能 各种时间格式支持 正确解析多种时间格式
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:177 # UnifiedExpressReceiptImportService 增强功能测试 增强时间解析功能 Excel序列号格式拒绝 拒绝Excel序列号格式
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:190 # UnifiedExpressReceiptImportService 增强功能测试 错误处理增强 状态机转换错误 处理状态转换错误并记录
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:206 # UnifiedExpressReceiptImportService 增强功能测试 错误处理增强 事务处理错误 处理事务错误并记录
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:241 # UnifiedExpressReceiptImportService 增强功能测试 字段映射增强 支持多种字段名变体
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:283 # UnifiedExpressReceiptImportService 性能和兼容性测试 BaseImportService继承 继承BaseImportService的所有方法
rspec './spec/services/unified_express_receipt_import_service_enhanced_spec.rb[1:2:2:1]' # UnifiedExpressReceiptImportService 性能和兼容性测试 文件扩展名支持 支持.csv文件格式
rspec './spec/services/unified_express_receipt_import_service_enhanced_spec.rb[1:2:2:2]' # UnifiedExpressReceiptImportService 性能和兼容性测试 文件扩展名支持 支持.xls文件格式
rspec './spec/services/unified_express_receipt_import_service_enhanced_spec.rb[1:2:2:3]' # UnifiedExpressReceiptImportService 性能和兼容性测试 文件扩展名支持 支持.xlsx文件格式
rspec './spec/services/unified_express_receipt_import_service_enhanced_spec.rb[1:2:2:4]' # UnifiedExpressReceiptImportService 性能和兼容性测试 文件扩展名支持 支持.XLS文件格式
rspec './spec/services/unified_express_receipt_import_service_enhanced_spec.rb[1:2:2:5]' # UnifiedExpressReceiptImportService 性能和兼容性测试 文件扩展名支持 支持.XLSX文件格式
rspec ./spec/services/unified_express_receipt_import_service_enhanced_spec.rb:318 # UnifiedExpressReceiptImportService 性能和兼容性测试 边界条件处理 处理只有表头的文件
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:32 # UnifiedExpressReceiptImportService#import with valid file containing express receipt data processes express receipts successfully
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:40 # UnifiedExpressReceiptImportService#import with valid file containing express receipt data creates ExpressReceipt records
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:45 # UnifiedExpressReceiptImportService#import with valid file containing express receipt data handles unmatched receipts
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:73 # UnifiedExpressReceiptImportService#import with missing required fields returns validation error
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:111 # UnifiedExpressReceiptImportService#import with tracking number in text field extracts tracking number from text using regex
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:131 # UnifiedExpressReceiptImportService#validate_required_fields returns error when required fields are missing
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:172 # UnifiedExpressReceiptImportService#find_matching_fee_detail with matching document number and receipt number finds fee detail by both criteria
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:181 # UnifiedExpressReceiptImportService#find_matching_fee_detail with only receipt number match finds fee detail by receipt number only
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:190 # UnifiedExpressReceiptImportService#find_matching_fee_detail with no matching fee detail returns nil
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:230 # UnifiedExpressReceiptImportService#parse_date_field parses valid datetime string
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:264 # UnifiedExpressReceiptImportService#create_or_update_express_receipt with new express receipt creates new express receipt
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:279 # UnifiedExpressReceiptImportService#create_or_update_express_receipt with existing express receipt updates existing express receipt
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:292 # UnifiedExpressReceiptImportService#create_or_update_express_receipt with invalid data handles save errors gracefully
rspec ./spec/services/unified_express_receipt_import_service_spec.rb:311 # UnifiedExpressReceiptImportService#handle_unmatched_receipt adds receipt to unmatched list
rspec ./spec/services/work_order_operation_service_spec.rb:10 # WorkOrderOperationService#record_create creates a new operation record with create type
rspec ./spec/services/work_order_operation_service_spec.rb:26 # WorkOrderOperationService#record_update creates a new operation record with update type
rspec ./spec/services/work_order_operation_service_spec.rb:41 # WorkOrderOperationService#record_update does not create a record if no attributes changed
rspec ./spec/services/work_order_operation_service_spec.rb:49 # WorkOrderOperationService#record_status_change creates a new operation record with status_change type
rspec ./spec/services/work_order_operation_service_spec.rb:73 # WorkOrderOperationService#record_add_problem creates a new operation record with add_problem type
rspec ./spec/services/work_order_operation_service_spec.rb:91 # WorkOrderOperationService#record_remove_problem creates a new operation record with remove_problem type
rspec ./spec/services/work_order_operation_service_spec.rb:110 # WorkOrderOperationService#record_modify_problem creates a new operation record with modify_problem type
rspec ./spec/services/work_order_problem_service_spec.rb:53 # WorkOrderProblemService#add_problem adds a single problem type
rspec ./spec/services/work_order_problem_service_spec.rb:61 # WorkOrderProblemService#add_problem does not add duplicate problem type
rspec ./spec/services/work_order_problem_service_spec.rb:73 # WorkOrderProblemService#add_problems adds multiple problem types
rspec ./spec/services/work_order_problem_service_spec.rb:81 # WorkOrderProblemService#add_problems replaces existing problem types
rspec ./spec/services/work_order_problem_service_spec.rb:94 # WorkOrderProblemService#add_problems returns false if problem_type_ids is blank
rspec ./spec/services/work_order_problem_service_spec.rb:103 # WorkOrderProblemService#remove_problem removes a problem type
rspec ./spec/services/work_order_problem_service_spec.rb:113 # WorkOrderProblemService#remove_problem returns true even if problem type was not associated
rspec ./spec/services/work_order_problem_service_spec.rb:122 # WorkOrderProblemService#clear_problems removes all problem types
rspec ./spec/services/work_order_problem_service_spec.rb:132 # WorkOrderProblemService#clear_problems clears audit_comment if present
rspec ./spec/services/work_order_problem_service_spec.rb:141 # WorkOrderProblemService#clear_problems clears problem_type_id if present
rspec ./spec/services/work_order_problem_service_spec.rb:152 # WorkOrderProblemService#get_problems returns all associated problem types
rspec ./spec/services/work_order_problem_service_spec.rb:162 # WorkOrderProblemService#get_problems returns empty array when there are no problems
rspec ./spec/services/work_order_problem_service_spec.rb:171 # WorkOrderProblemService#get_formatted_problems returns formatted problem descriptions
rspec ./spec/services/work_order_problem_service_spec.rb:189 # WorkOrderProblemService#generate_audit_comment generates audit comment from problem types
rspec ./spec/services/work_order_problem_service_spec.rb:207 # WorkOrderProblemService#generate_audit_comment returns nil when there are no problems
rspec ./spec/services/work_order_service_spec.rb:146 # WorkOrderService 沟通工单状态处理 处理意见设置为'可以通过' 工单状态变更为approved
rspec ./spec/services/work_order_service_spec.rb:157 # WorkOrderService 沟通工单状态处理 处理意见设置为'可以通过' 关联的费用明细状态变更为verified
rspec ./spec/services/work_order_service_spec.rb:170 # WorkOrderService 沟通工单状态处理 处理意见设置为'无法通过' 工单状态变更为rejected
rspec ./spec/services/work_order_service_spec.rb:181 # WorkOrderService 沟通工单状态处理 处理意见设置为'无法通过' 关联的费用明细状态变更为problematic
rspec ./spec/services/work_order_service_spec.rb:223 # WorkOrderService 多问题类型处理 支持添加多个问题类型
rspec ./spec/services/work_order_service_spec.rb:313 # WorkOrderService#approve 成功批准工单并更新状态
rspec ./spec/services/work_order_service_spec.rb:322 # WorkOrderService#approve 批准时设置审核日期
rspec ./spec/services/work_order_service_spec.rb:330 # WorkOrderService#approve 批准时记录操作历史
rspec ./spec/services/work_order_service_spec.rb:363 # WorkOrderService#reject 成功拒绝工单并更新状态
rspec ./spec/services/work_order_service_spec.rb:372 # WorkOrderService#reject 拒绝时设置审核日期
rspec ./spec/services/work_order_service_spec.rb:379 # WorkOrderService#reject 拒绝时记录操作历史
rspec ./spec/services/work_order_service_spec.rb:420 # WorkOrderService#update 处理意见变更为"可以通过"时调用approve方法
rspec ./spec/services/work_order_service_spec.rb:428 # WorkOrderService#update 处理意见变更为"无法通过"时调用reject方法
rspec ./spec/services/work_order_service_spec.rb:436 # WorkOrderService#update 更新时记录操作历史
rspec ./spec/services/work_order_service_spec.rb:475 # WorkOrderService#mark_as_truly_completed 成功标记工单为真正完成
rspec ./spec/services/work_order_service_spec.rb:484 # WorkOrderService#mark_as_truly_completed 标记完成时记录操作历史
rspec ./spec/services/work_order_service_spec.rb:502 # WorkOrderService#mark_as_truly_completed 当工单已经标记为完成 返回错误
rspec ./spec/services/work_order_service_spec.rb:579 # WorkOrderService#process_action 统一逻辑 approve和reject使用相同的process_action逻辑
rspec ./spec/services/work_order_service_spec.rb:595 # WorkOrderService#process_action 统一逻辑 状态机异常处理 捕获 StateMachines::InvalidTransition 异常
rspec ./spec/services/work_order_service_spec.rb:630 # WorkOrderService 费用明细选择处理 处理费用明细选择
rspec ./spec/services/work_order_service_spec.rb:637 # WorkOrderService 费用明细选择处理 清除现有关联并创建新关联
rspec ./spec/services/work_order_service_spec.rb:653 # WorkOrderService 费用明细选择处理 忽略不属于同一报销单的费用明细
rspec ./spec/services/work_order_service_spec.rb:693 # WorkOrderService 审核日期自动设置 approve时自动设置audit_date
rspec ./spec/services/work_order_service_spec.rb:701 # WorkOrderService 审核日期自动设置 reject时自动设置audit_date
rspec ./spec/services/work_order_service_spec.rb:726 # WorkOrderService 费用明细同步 approve后调用sync_fee_details_verification_status
rspec ./spec/services/work_order_service_spec.rb:732 # WorkOrderService 费用明细同步 reject后调用sync_fee_details_verification_status


=== Coverage Performance Summary ===
Total Files: 106
Total Lines: 8100
Covered Lines: 2699
Coverage Percentage: 33.32%

=== Files Needing Attention ===
/Users/dreamlinx/Dropbox/Projects/NetBeansProjects/think-bridge/sci2/app/services/problem_code_migration_service.rb: 0.0% ([]/71 lines)
/Users/dreamlinx/Dropbox/Projects/NetBeansProjects/think-bridge/sci2/app/controllers/concerns/permission_handling.rb: 0.0% ([]/116 lines)
/Users/dreamlinx/Dropbox/Projects/NetBeansProjects/think-bridge/sci2/app/jobs/application_job.rb: 0.0% ([]/2 lines)
/Users/dreamlinx/Dropbox/Projects/NetBeansProjects/think-bridge/sci2/app/models/ability.rb: 0.0% ([]/41 lines)
/Users/dreamlinx/Dropbox/Projects/NetBeansProjects/think-bridge/sci2/app/repositories/problem_type_repository.rb: 0.0% ([]/157 lines)

⚠️  WARNING: Coverage below 85% threshold
Consider adding tests for uncovered business logic
Coverage report generated for RSpec to /Users/dreamlinx/Dropbox/Projects/NetBeansProjects/think-bridge/sci2/coverage.
Line Coverage: 33.32% (2699 / 8100)
Stopped processing SimpleCov as a previous error not related to SimpleCov has been detected
