<%= form_tag import_path, multipart: true, id: 'import_form', remote: false do %>
  <div class="panel">
    <h3><%= title %></h3>
    
    <div class="panel_contents">
      <% if instructions.present? %>
        <div class="instructions">
          <h4>å¯¼å…¥è¯´æ˜</h4>
          <ul>
            <% instructions.each do |instruction| %>
              <li><%= instruction %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      
      <!-- è¿›åº¦æç¤ºåŒºåŸŸ -->
      <div id="import_progress" style="display: none; margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <div class="spinner" style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #2196f3; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          <div>
            <strong>æ­£åœ¨å¯¼å…¥æ•°æ®ï¼Œè¯·ç¨å€™...</strong>
            <div id="progress_message" style="font-size: 14px; color: #666; margin-top: 5px;">
              æ­£åœ¨å¤„ç†æ‚¨çš„æ–‡ä»¶ï¼Œè¯·ä¸è¦å…³é—­é¡µé¢æˆ–é‡å¤ç‚¹å‡»
            </div>
          </div>
        </div>
        <div id="progress_details" style="margin-top: 10px; font-size: 12px; color: #888;">
          <!-- è¿™é‡Œä¼šæ˜¾ç¤ºè¯¦ç»†çš„è¿›åº¦ä¿¡æ¯ -->
        </div>
      </div>
      
      <!-- é”™è¯¯æç¤ºåŒºåŸŸ -->
      <div id="import_error" style="display: none; margin: 20px 0; padding: 15px; background: #ffebee; border-radius: 5px; border-left: 4px solid #f44336;">
        <strong style="color: #d32f2f;">å¯¼å…¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯</strong>
        <div id="error_message" style="margin-top: 5px; color: #666;"></div>
      </div>
      
      <div class="form-inputs">
        <div class="input file">
          <label for="file">é€‰æ‹©æ–‡ä»¶</label>
          <%= file_field_tag :file, required: true, accept: '.csv,.xlsx,.xls', id: 'file_input' %>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            æ”¯æŒæ ¼å¼ï¼šCSV, Excel (.xlsx, .xls)
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <%= submit_tag "å¯¼å…¥", class: "button", id: "import_submit_btn" %>
        <%= link_to "å–æ¶ˆ", cancel_path, class: "button" %>
      </div>
    </div>
  </div>
<% end %>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

#import_form.importing .button {
  pointer-events: none;
  opacity: 0.6;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('import_form');
  const submitBtn = document.getElementById('import_submit_btn');
  const fileInput = document.getElementById('file_input');
  const progressDiv = document.getElementById('import_progress');
  const progressMessage = document.getElementById('progress_message');
  const progressDetails = document.getElementById('progress_details');
  const errorDiv = document.getElementById('import_error');
  const errorMessage = document.getElementById('error_message');
  
  if (form && submitBtn && progressDiv) {
    form.addEventListener('submit', function(e) {
      const file = fileInput.files[0];
      
      if (!file) {
        alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
        e.preventDefault();
        return;
      }
      
      // æ˜¾ç¤ºè¿›åº¦æç¤º
      showImportProgress(file);
      
      // ç¦ç”¨æäº¤æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
      submitBtn.disabled = true;
      submitBtn.textContent = 'å¯¼å…¥ä¸­...';
      form.classList.add('importing');
      
      // éšè—é”™è¯¯æç¤º
      errorDiv.style.display = 'none';
    });
    
    function showImportProgress(file) {
      progressDiv.style.display = 'block';
      
      // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
      const fileSize = (file.size / 1024 / 1024).toFixed(2);
      const fileName = file.name;
      
      progressMessage.textContent = `æ­£åœ¨å¤„ç†æ–‡ä»¶: ${fileName} (${fileSize}MB)`;
      
      // ä¼°ç®—å¤„ç†æ—¶é—´
      let estimatedTime = 'å‡ ç§’é’Ÿ';
      if (file.size > 5 * 1024 * 1024) { // å¤§äº5MB
        estimatedTime = '1-2åˆ†é’Ÿ';
      } else if (file.size > 1 * 1024 * 1024) { // å¤§äº1MB
        estimatedTime = '30ç§’-1åˆ†é’Ÿ';
      }
      
      progressDetails.innerHTML = `
        <div>ğŸ“ æ–‡ä»¶å: ${fileName}</div>
        <div>ğŸ“Š æ–‡ä»¶å¤§å°: ${fileSize}MB</div>
        <div>â±ï¸ é¢„è®¡å¤„ç†æ—¶é—´: ${estimatedTime}</div>
        <div style="margin-top: 10px; color: #2196f3;">
          ğŸ’¡ æç¤º: å¯¼å…¥è¿‡ç¨‹ä¸­è¯·ä¸è¦å…³é—­é¡µé¢æˆ–é‡å¤ç‚¹å‡»å¯¼å…¥æŒ‰é’®
        </div>
      `;
      
      // æ·»åŠ åŠ¨æ€æç¤º
      let messageIndex = 0;
      const messages = [
        'æ­£åœ¨è§£ææ–‡ä»¶å†…å®¹...',
        'æ­£åœ¨éªŒè¯æ•°æ®æ ¼å¼...',
        'æ­£åœ¨å¤„ç†æ•°æ®å¯¼å…¥...',
        'æ­£åœ¨æ›´æ–°å…³è”å…³ç³»...',
        'å³å°†å®Œæˆï¼Œè¯·ç¨å€™...'
      ];
      
      const messageInterval = setInterval(function() {
        if (messageIndex < messages.length) {
          progressMessage.textContent = messages[messageIndex];
          messageIndex++;
        } else {
          clearInterval(messageInterval);
          progressMessage.textContent = 'æ­£åœ¨å®Œæˆå¯¼å…¥ï¼Œè¯·ç¨å€™...';
        }
      }, 3000); // æ¯3ç§’æ›´æ¢ä¸€æ¬¡æç¤ºä¿¡æ¯
      
      // ä¿å­˜interval IDä»¥ä¾¿åç»­æ¸…ç†
      form.dataset.messageInterval = messageInterval;
    }
    
    // å¤„ç†è¡¨å•æäº¤é”™è¯¯
    window.addEventListener('beforeunload', function(e) {
      if (form.classList.contains('importing')) {
        e.preventDefault();
        e.returnValue = 'å¯¼å…¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦ç¦»å¼€é¡µé¢å—ï¼Ÿ';
        return e.returnValue;
      }
    });
  }
  
  // æ–‡ä»¶é€‰æ‹©æ—¶çš„é¢„æ£€æŸ¥
  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const fileSize = file.size / 1024 / 1024; // MB
        const fileName = file.name;
        const fileExt = fileName.split('.').pop().toLowerCase();
        
        // æ–‡ä»¶æ ¼å¼æ£€æŸ¥
        if (!['csv', 'xlsx', 'xls'].includes(fileExt)) {
          alert('è¯·é€‰æ‹©CSVæˆ–Excelæ ¼å¼çš„æ–‡ä»¶');
          e.target.value = '';
          return;
        }
        
        // æ–‡ä»¶å¤§å°æ£€æŸ¥
        if (fileSize > 50) { // å¤§äº50MB
          if (!confirm(`æ–‡ä»¶è¾ƒå¤§ (${fileSize.toFixed(2)}MB)ï¼Œå¯¼å…¥å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
            e.target.value = '';
            return;
          }
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        const fileInfo = document.createElement('div');
        fileInfo.style.cssText = 'margin-top: 5px; padding: 8px; background: #f5f5f5; border-radius: 3px; font-size: 12px;';
        fileInfo.innerHTML = `
          <strong>å·²é€‰æ‹©æ–‡ä»¶:</strong> ${fileName}<br>
          <strong>æ–‡ä»¶å¤§å°:</strong> ${fileSize.toFixed(2)}MB<br>
          <strong>é¢„è®¡è®°å½•æ•°:</strong> ${estimateRecordCount(fileSize)}æ¡
        `;
        
        // ç§»é™¤ä¹‹å‰çš„æ–‡ä»¶ä¿¡æ¯
        const existingInfo = fileInput.parentNode.querySelector('.file-info');
        if (existingInfo) {
          existingInfo.remove();
        }
        
        fileInfo.className = 'file-info';
        fileInput.parentNode.appendChild(fileInfo);
      }
    });
  }
  
  function estimateRecordCount(fileSizeMB) {
    // ç²—ç•¥ä¼°ç®—ï¼š1MBå¤§çº¦åŒ…å«5000-10000æ¡è®°å½•
    const estimatedRecords = Math.round(fileSizeMB * 7500);
    return estimatedRecords.toLocaleString();
  }
});
</script>
</content>
</file>
<file><path>app/assets/javascripts/active_admin_custom.js</path>
<content lines="1-6">
1 | // Custom JavaScript for ActiveAdmin
2 | document.addEventListener('DOMContentLoaded', function() {
3 |   // Initialize custom tooltips if needed
4 |   // This is a placeholder for any additional JavaScript functionality
5 |   // that might be needed for the tooltips in the future
6 | });