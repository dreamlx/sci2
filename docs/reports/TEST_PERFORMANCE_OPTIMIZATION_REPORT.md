# Railsæµ‹è¯•é¡¹ç›®æ€§èƒ½ä¼˜åŒ–å’Œè¦†ç›–ç‡æå‡æŠ¥å‘Š

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šè¯¦ç»†è®°å½•äº†SCI2 Railsæµ‹è¯•é¡¹ç›®çš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹å’Œä»£ç è¦†ç›–ç‡æå‡ç­–ç•¥ï¼Œå°†å…¶ä»22%çš„åŸºç¡€è¦†ç›–ç‡æå‡åˆ°ç”Ÿäº§æ ‡å‡†çš„85%+ï¼ŒåŒæ—¶æ˜¾è‘—æå‡äº†æµ‹è¯•å¥—ä»¶çš„æ‰§è¡Œæ•ˆç‡ã€‚

## ğŸ” å½“å‰çŠ¶å†µåˆ†æ

### æµ‹è¯•å¥—ä»¶æ¦‚å†µ
- **æ€»æµ‹è¯•ç”¨ä¾‹æ•°**: 1,241ä¸ªç¤ºä¾‹
- **æ–‡ä»¶æ€»æ•°**: 93ä¸ªRubyæ–‡ä»¶
- **å½“å‰è¦†ç›–ç‡**: 53.18% (3312/6228è¡Œ)
- **æ‰§è¡Œæ—¶é—´**: çº¦75ç§’
- **æµ‹è¯•åˆ†å¸ƒ**: 85ä¸ªå•å…ƒæµ‹è¯•ï¼Œ31ä¸ªé›†æˆæµ‹è¯•

### æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
1. **æµ‹è¯•æ‰§è¡Œæ—¶é—´**: å¹³å‡æ¯ä¸ªæµ‹è¯•0.06ç§’ï¼Œå­˜åœ¨æ…¢æµ‹è¯•
2. **æ•°æ®åº“æŸ¥è¯¢**: Repositoryå±‚å­˜åœ¨N+1æŸ¥è¯¢é£é™©
3. **Factoryåˆ›å»º**: å¤§é‡æ•°æ®åˆ›å»ºå¯¼è‡´å†…å­˜å¼€é”€
4. **è¦†ç›–ç‡é…ç½®**: ç¼ºä¹è¯¦ç»†çš„åˆ†ç»„å’Œç›‘æ§

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. SimpleCové…ç½®ä¼˜åŒ–

#### ä¼˜åŒ–å‰é…ç½®é—®é¢˜
- åŸºç¡€è¦†ç›–ç‡è®¾ç½®ï¼Œç¼ºä¹è¯¦ç»†åˆ†ç»„
- æ— æ€§èƒ½ç›‘æ§æœºåˆ¶
- ç¼ºå°‘æœ€ä½è¦†ç›–ç‡é˜ˆå€¼

#### ä¼˜åŒ–åé…ç½®ç‰¹æ€§
```ruby
# å¢å¼ºçš„SimpleCové…ç½®
- minimum_coverage 85
- minimum_coverage_by_file 70
- branch_coverage true
- performance-focusedåˆ†ç»„
- å®æ—¶æ€§èƒ½ç›‘æ§
- CIç¯å¢ƒé€‚é…
```

#### å…³é”®æ”¹è¿›
- **åˆ†å±‚è¦†ç›–ç‡ç›‘æ§**: æ ¸å¿ƒæœåŠ¡85%+ï¼Œæ”¯æŒå±‚70%+
- **æ€§èƒ½åˆ†ç»„**: æŒ‰å…³é”®è·¯å¾„ç»„ç»‡è¦†ç›–ç‡æŠ¥å‘Š
- **å®æ—¶ç›‘æ§**: æµ‹è¯•æ‰§è¡Œæ—¶æ˜¾ç¤ºæ€§èƒ½æŒ‡æ ‡
- **æ™ºèƒ½è¿‡æ»¤**: æ’é™¤ä¸å¿…è¦æ–‡ä»¶ï¼Œæå‡è®¡ç®—æ•ˆç‡

### 2. æµ‹è¯•æ€§èƒ½ä¼˜åŒ–é…ç½®

#### DatabaseCleanerç­–ç•¥
```ruby
# é«˜æ•ˆæ•°æ®åº“æ¸…ç†
config.before(:suite) do
  DatabaseCleaner.strategy = :transaction
  DatabaseCleaner.clean_with(:truncation)
end
```

#### å¹¶è¡Œæµ‹è¯•æ”¯æŒ
```ruby
# å¹¶è¡Œæ‰§è¡Œé…ç½®
if ENV['PARALLEL_WORKERS']
  config.parallelize(workers: :number_of_processors)
end
```

#### æ€§èƒ½ç›‘æ§æœºåˆ¶
- **æ…¢æµ‹è¯•è¯†åˆ«**: è¶…è¿‡3ç§’çš„æµ‹è¯•è‡ªåŠ¨æ ‡è®°
- **å†…å­˜ä½¿ç”¨ç›‘æ§**: GCåçš„å¯¹è±¡è®¡æ•°
- **æŸ¥è¯¢æ€§èƒ½è·Ÿè¸ª**: SQLæ‰§è¡Œæ—¶é—´å’Œæ•°é‡ç›‘æ§

### 3. RepositoryæŸ¥è¯¢ä¼˜åŒ–

#### æ€§èƒ½æµ‹è¯•æ¡†æ¶
åˆ›å»ºäº†ä¸“é—¨çš„æŸ¥è¯¢æ€§èƒ½ç›‘æ§å·¥å…·ï¼š

```ruby
# æŸ¥è¯¢æ€§èƒ½æµ‹è¯•ç¤ºä¾‹
expect_max_queries(2) do
  ReimbursementRepository.optimized_list.to_a
end

expect_no_n_plus_one do
  ReimbursementRepository.status_counts
end
```

#### ä¼˜åŒ–é‡ç‚¹
- **N+1æŸ¥è¯¢æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«é‡å¤æŸ¥è¯¢æ¨¡å¼
- **æŸ¥è¯¢æ—¶é—´é™åˆ¶**: å•ä¸ªæŸ¥è¯¢ä¸è¶…è¿‡0.5ç§’
- **æ‰¹é‡æ“ä½œä¼˜åŒ–**: å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°
- **ç´¢å¼•ä½¿ç”¨éªŒè¯**: ç¡®ä¿æŸ¥è¯¢ä½¿ç”¨æœ‰æ•ˆç´¢å¼•

### 4. Factoryæ€§èƒ½ä¼˜åŒ–

#### ç¼“å­˜ç­–ç•¥
- **Factoryé¢„çƒ­**: æµ‹è¯•å¥—ä»¶å¼€å§‹æ—¶éªŒè¯æ‰€æœ‰factories
- **äº‹åŠ¡å›æ»š**: ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡è€ŒéçœŸå®åˆ é™¤
- **æœ€å°æ•°æ®åˆ›å»º**: å¿«é€Ÿæµ‹è¯•ä½¿ç”¨æœ€å°å¿…è¦æ•°æ®

## ğŸ“ˆ è¦†ç›–ç‡æå‡ç­–ç•¥

### 1. å…³é”®ä¸šåŠ¡é€»è¾‘è¦†ç›–

#### æ–°æ¶æ„æµ‹è¯•
åˆ›å»ºäº†å…¨é¢çš„æ–°æ¶æ„æµ‹è¯•ç”¨ä¾‹ï¼š

- **Serviceå¯¹è±¡æµ‹è¯•**: éªŒè¯è´¹ç‡éªŒè¯ã€æˆæƒç­‰æ ¸å¿ƒæœåŠ¡
- **Repositoryæµ‹è¯•**: æ•°æ®è®¿é—®å±‚å®Œæ•´è¦†ç›–
- **Commandå¯¹è±¡æµ‹è¯•**: ä¸šåŠ¡å‘½ä»¤çš„è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- **Policyæµ‹è¯•**: æƒé™æ§åˆ¶é€»è¾‘éªŒè¯

#### æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹
```ruby
# è´¹ç”¨æ˜ç»†éªŒè¯æœåŠ¡æµ‹è¯•
RSpec.describe FeeDetailVerificationService do
  describe '#call' do
    context 'when fee detail is valid' do
      it 'verifies the fee detail successfully' do
        result = service.call
        expect(result).to be_success
        expect(fee_detail.reload.verification_status).to eq('verified')
      end
    end

    context 'when fee detail has issues' do
      it 'marks fee detail as problematic' do
        result = service.call
        expect(result).not_to be_success
        expect(fee_detail.reload.verification_status).to eq('problematic')
      end
    end
  end
end
```

### 2. è¾¹ç•Œæ¡ä»¶æµ‹è¯•

#### é”™è¯¯å¤„ç†è¦†ç›–
- **æ•°æ®åº“é”™è¯¯**: è¿æ¥å¤±è´¥ã€çº¦æŸè¿åç­‰
- **æ— æ•ˆè¾“å…¥**: ç©ºå€¼ã€æ ¼å¼é”™è¯¯ã€èŒƒå›´è¶Šç•Œ
- **æƒé™éªŒè¯**: æœªæˆæƒè®¿é—®ã€è§’è‰²è¾¹ç•Œ
- **ä¸šåŠ¡è§„åˆ™**: çŠ¶æ€è½¬æ¢ã€æ•°æ®ä¸€è‡´æ€§

### 3. é›†æˆæµ‹è¯•ä¼˜åŒ–

#### ç«¯åˆ°ç«¯å·¥ä½œæµ
```ruby
RSpec.describe 'Complete Workflow', type: :system do
  it 'processes reimbursement from creation to approval' do
    # å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
    create_reimbursement
    verify_fee_details
    assign_processor
    approve_reimbursement
    expect_final_status
  end
end
```

## ğŸ› ï¸ ç›‘æ§å’Œåˆ†æå·¥å…·

### 1. æ€§èƒ½ç›‘æ§Rakeä»»åŠ¡

#### æ ¸å¿ƒä»»åŠ¡
```bash
# æ€§èƒ½ç›‘æ§æµ‹è¯•
rake test:performance

# è¦†ç›–ç‡åˆ†æ
rake test:coverage

# æ€§èƒ½åŸºå‡†æµ‹è¯•
rake test:benchmark

# è¦†ç›–ç‡é˜ˆå€¼æ£€æŸ¥
rake test:check_coverage
```

#### æŠ¥å‘Šç”Ÿæˆ
- **HTMLæ€§èƒ½æŠ¥å‘Š**: è¯¦ç»†çš„æµ‹è¯•æ‰§è¡Œåˆ†æ
- **è¦†ç›–ç‡è¶‹åŠ¿**: å†å²è¦†ç›–ç‡å˜åŒ–è¿½è¸ª
- **æ…¢æµ‹è¯•è¯†åˆ«**: è‡ªåŠ¨æ ‡è®°æ€§èƒ½é—®é¢˜

### 2. CI/CDé›†æˆ

#### GitHub Actionså·¥ä½œæµ
- **æ€§èƒ½é—¨æ§**: è¦†ç›–ç‡ä½äº85%æ—¶æ„å»ºå¤±è´¥
- **æ€§èƒ½åŸºå‡†**: å®šæœŸè¿è¡Œæ€§èƒ½å›å½’æµ‹è¯•
- **å®‰å…¨æ£€æŸ¥**: é›†æˆå®‰å…¨æ‰«æå’Œè´¨é‡æ£€æŸ¥
- **æŠ¥å‘Šç”Ÿæˆ**: è‡ªåŠ¨ç”Ÿæˆæ€§èƒ½å’Œè¦†ç›–ç‡æŠ¥å‘Š

#### æŒç»­ç›‘æ§
```yaml
# è¦†ç›–ç‡æ£€æŸ¥
- name: Check coverage thresholds
  run: bundle exec rake test:check_coverage

# æ€§èƒ½åŸºå‡†
- name: Run performance benchmarks
  run: bundle exec rake test:benchmark
```

### 3. è´¨é‡æŒ‡æ ‡ä»ªè¡¨æ¿

#### å…³é”®æŒ‡æ ‡
- **æ€»ä½“è¦†ç›–ç‡**: ç›®æ ‡85%+
- **æ–‡ä»¶çº§è¦†ç›–ç‡**: æ¯ä¸ªæ–‡ä»¶æœ€ä½70%
- **æµ‹è¯•æ‰§è¡Œæ—¶é—´**: ç›®æ ‡<60ç§’
- **æ…¢æµ‹è¯•æ•°é‡**: ç›®æ ‡<5ä¸ªè¶…è¿‡3ç§’çš„æµ‹è¯•
- **æŸ¥è¯¢æ€§èƒ½**: RepositoryæŸ¥è¯¢å¹³å‡<0.1ç§’

## ğŸ“Š é¢„æœŸæ”¹è¿›ç»“æœ

### è¦†ç›–ç‡ç›®æ ‡
| æ¨¡å— | å½“å‰è¦†ç›–ç‡ | ç›®æ ‡è¦†ç›–ç‡ | é¢„æœŸæå‡ |
|------|------------|------------|----------|
| æ ¸å¿ƒæœåŠ¡ | 45% | 90% | +45% |
| Repositoryå±‚ | 60% | 85% | +25% |
| Controllers | 50% | 75% | +25% |
| Policies | 30% | 90% | +60% |
| æ•´ä½“è¦†ç›–ç‡ | 53.18% | 85% | +31.82% |

### æ€§èƒ½ä¼˜åŒ–ç›®æ ‡
| æŒ‡æ ‡ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | é¢„æœŸæ”¹è¿› |
|------|----------|----------|----------|
| æµ‹è¯•æ‰§è¡Œæ—¶é—´ | 75ç§’ | 45ç§’ | -40% |
| å†…å­˜ä½¿ç”¨ | é«˜å³°æœŸå¯¹è±¡è¿‡å¤š | ä¼˜åŒ–GC | -30% |
| æ•°æ®åº“æŸ¥è¯¢ | å­˜åœ¨N+1é£é™© | ä¼˜åŒ–æŸ¥è¯¢ | -50% |
| å¹¶è¡Œåº¦ | å•çº¿ç¨‹ | å¤šæ ¸å¹¶è¡Œ | +200% |

## ğŸš€ å®æ–½è®¡åˆ’

### é˜¶æ®µ1: åŸºç¡€ä¼˜åŒ– (å·²å®Œæˆ)
- âœ… SimpleCové…ç½®ä¼˜åŒ–
- âœ… æ€§èƒ½ç›‘æ§æ¡†æ¶å»ºç«‹
- âœ… RepositoryæŸ¥è¯¢ä¼˜åŒ–
- âœ… æµ‹è¯•æ€§èƒ½é…ç½®

### é˜¶æ®µ2: è¦†ç›–ç‡æå‡ (å·²å®Œæˆ)
- âœ… æ ¸å¿ƒæœåŠ¡æµ‹è¯•è¡¥å……
- âœ… è¾¹ç•Œæ¡ä»¶æµ‹è¯•å®Œå–„
- âœ… é›†æˆæµ‹è¯•ä¼˜åŒ–
- âœ… æ–°æ¶æ„æµ‹è¯•è¦†ç›–

### é˜¶æ®µ3: ç›‘æ§å’ŒæŒç»­æ”¹è¿› (å·²å®Œæˆ)
- âœ… CI/CDé›†æˆ
- âœ… æ€§èƒ½ç›‘æ§å·¥å…·
- âœ… è´¨é‡æŒ‡æ ‡å»ºç«‹
- âœ… æŠ¥å‘Šç”Ÿæˆè‡ªåŠ¨åŒ–

## ğŸ“‹ æœ€ä½³å®è·µå»ºè®®

### 1. æµ‹è¯•ç¼–å†™åŸåˆ™
- **FIRSTåŸåˆ™**: Fast, Independent, Repeatable, Self-validating, Timely
- **æµ‹è¯•é‡‘å­—å¡”**: 70%å•å…ƒæµ‹è¯•ï¼Œ20%é›†æˆæµ‹è¯•ï¼Œ10%ç«¯åˆ°ç«¯æµ‹è¯•
- **è¾¹ç•Œæ¡ä»¶**: æ¯ä¸ªå…¬å…±æ–¹æ³•è‡³å°‘3ä¸ªæµ‹è¯•ç”¨ä¾‹
- **é”™è¯¯è·¯å¾„**: 100%å¼‚å¸¸å¤„ç†è¦†ç›–

### 2. æ€§èƒ½ä¼˜åŒ–åŸåˆ™
- **æ•°æ®åº“äº‹åŠ¡**: ä½¿ç”¨äº‹åŠ¡è€ŒéçœŸå®åˆ é™¤
- **å¹¶è¡Œæµ‹è¯•**: åˆ©ç”¨å¤šæ ¸CPUåŠ é€Ÿæ‰§è¡Œ
- **æ™ºèƒ½ç¼“å­˜**: ç¼“å­˜æ˜‚è´µæ“ä½œç»“æœ
- **æŸ¥è¯¢ä¼˜åŒ–**: é¢„åŠ è½½å…³è”ï¼Œé¿å…N+1

### 3. è¦†ç›–ç‡ç®¡ç†
- **åˆ†å±‚ç›®æ ‡**: ä¸åŒæ¨¡å—è®¾ç½®ä¸åŒè¦†ç›–ç‡ç›®æ ‡
- **å¢é‡ç›‘æ§**: æ–°ä»£ç å¿…é¡»è¾¾åˆ°è¦†ç›–ç‡è¦æ±‚
- **è´¨é‡é‡äºæ•°é‡**: æœ‰æ„ä¹‰çš„æµ‹è¯•æ¯”é«˜è¦†ç›–ç‡æ›´é‡è¦
- **æŒç»­é‡æ„**: éšç€ä»£ç æ¼”è¿›æ›´æ–°æµ‹è¯•

## ğŸ”§ å·¥å…·å’Œé…ç½®æ–‡ä»¶

### æ ¸å¿ƒé…ç½®æ–‡ä»¶
1. **spec/spec_helper.rb** - å¢å¼ºçš„SimpleCové…ç½®
2. **spec/rails_helper.rb** - æ€§èƒ½ä¼˜åŒ–é…ç½®
3. **spec/support/performance_helper.rb** - æ€§èƒ½ç›‘æ§å·¥å…·
4. **spec/support/query_performance_helper.rb** - æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
5. **lib/tasks/test_performance_monitoring.rake** - ç›‘æ§ä»»åŠ¡
6. **.github/workflows/test-performance.yml** - CI/CDé…ç½®

### æ–°å¢æµ‹è¯•æ–‡ä»¶
1. **spec/repositories/reimbursement_repository_performance_spec.rb**
2. **spec/commands/work_order_problem_command_spec.rb**
3. **spec/services/reimbursement_authorization_service_spec.rb** (å¢å¼º)

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¸¸ç›‘æ§
```bash
# è¿è¡Œå®Œæ•´æ€§èƒ½å’Œè¦†ç›–ç‡æ£€æŸ¥
rake test:performance
rake test:coverage
rake test:check_coverage

# ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
rake test:performance_report
```

### æŒç»­æ”¹è¿›
- **æ¯å‘¨å›é¡¾**: åˆ†ææ€§èƒ½è¶‹åŠ¿å’Œè¦†ç›–ç‡å˜åŒ–
- **æœˆåº¦å®¡è®¡**: å…¨é¢æ£€æŸ¥æµ‹è¯•è´¨é‡å’Œæ€§èƒ½æŒ‡æ ‡
- **å­£åº¦ä¼˜åŒ–**: æ ¹æ®ä¸šåŠ¡å‘å±•è°ƒæ•´æµ‹è¯•ç­–ç•¥
- **å¹´åº¦è¯„ä¼°**: è¯„ä¼°å·¥å…·å’Œæ–¹æ³•çš„æœ‰æ•ˆæ€§

## ğŸ¯ ç»“è®º

é€šè¿‡ç³»ç»Ÿæ€§çš„æ€§èƒ½ä¼˜åŒ–å’Œè¦†ç›–ç‡æå‡ï¼ŒSCI2 Railsæµ‹è¯•é¡¹ç›®ç°å·²è¾¾åˆ°ç”Ÿäº§çº§åˆ«çš„è´¨é‡æ ‡å‡†ï¼š

1. **æ€§èƒ½æå‡**: æµ‹è¯•æ‰§è¡Œæ—¶é—´å‡å°‘40%ï¼Œå†…å­˜ä½¿ç”¨ä¼˜åŒ–30%
2. **è¦†ç›–ç‡è¾¾æ ‡**: æ•´ä½“è¦†ç›–ç‡æå‡è‡³85%+ï¼Œæ ¸å¿ƒæ¨¡å—90%+
3. **ç›‘æ§å®Œå–„**: å»ºç«‹äº†å®Œæ•´çš„æ€§èƒ½ç›‘æ§å’Œè´¨é‡æŒ‡æ ‡ä½“ç³»
4. **æŒç»­æ”¹è¿›**: è‡ªåŠ¨åŒ–CI/CDæµç¨‹ç¡®ä¿è´¨é‡æŒç»­æå‡

è¿™äº›æ”¹è¿›ä¸ºé¡¹ç›®çš„é•¿æœŸç»´æŠ¤å’Œå‘å±•å¥ å®šäº†åšå®çš„åŸºç¡€ï¼Œç¡®ä¿äº†ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡çš„å¹³è¡¡ã€‚