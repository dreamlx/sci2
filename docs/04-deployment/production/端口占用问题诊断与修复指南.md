# 端口占用问题诊断与修复指南

## 问题概述

在执行 `USE_VPN=true bundle exec cap production deploy` 时遇到以下错误：

```
Address already in use - bind(2) for "0.0.0.0" port 3000 (Errno::EADDRINUSE)
```

这是一个典型的端口占用问题，表明端口 3000 已被其他进程占用。

## 问题分析

### 根本原因

1. **端口占用**：端口 3000 被现有的 Puma 进程或其他服务占用
2. **进程管理不当**：之前的 Puma 进程没有正确停止
3. **部署脚本缺陷**：原始的 puma.rake 缺少充分的进程检查和清理机制

### 可能的原因

1. **最可能**：旧的 Puma 进程未完全停止
2. **次可能**：其他服务占用端口 3000
3. **较少可能**：系统级进程冲突
4. **罕见**：防火墙或网络配置问题

## 解决方案

### 方案一：使用紧急修复脚本（推荐）

我们已经创建了一个立即可用的紧急修复脚本：

```bash
./emergency_port_fix.sh
```

该脚本使用现有的 Capistrano 任务，会自动执行以下步骤：
1. 检查服务器状态
2. 停止现有 Puma 进程（使用增强的停止机制）
3. 强制清理端口 3000
4. 验证端口释放
5. 启动新的 Puma 进程（带端口验证）
6. 验证部署状态

**注意**：此脚本使用已验证可用的 Capistrano 任务，确保立即可执行。

### 方案二：手动诊断和修复

#### 步骤1：诊断问题

```bash
# 检查服务器状态
USE_VPN=true bundle exec cap production server:full_diagnostic

# 检查端口占用
USE_VPN=true bundle exec cap production server:check_port

# 检查 Puma 状态
USE_VPN=true bundle exec cap production puma:status
```

#### 步骤2：清理端口占用

```bash
# 紧急清理端口 3000
USE_VPN=true bundle exec cap production server:emergency_cleanup

# 停止 Puma 进程
USE_VPN=true bundle exec cap production puma:stop
```

#### 步骤3：验证和重启

```bash
# 验证端口释放
USE_VPN=true bundle exec cap production server:check_port

# 启动 Puma
USE_VPN=true bundle exec cap production puma:start

# 验证启动状态
USE_VPN=true bundle exec cap production puma:status
```

### 方案三：完整重新部署

如果上述方案都失败，可以执行完整的重新部署：

```bash
# 先清理环境
USE_VPN=true bundle exec cap production server:emergency_cleanup

# 然后重新部署
USE_VPN=true bundle exec cap production deploy
```

## 增强的 Capistrano 任务

我们已经增强了 Capistrano 任务来更好地处理端口占用问题：

### Puma 管理任务

- `puma:check_port` - 检查端口可用性
- `puma:force_kill_port` - 强制清理端口 3000
- `puma:stop` - 增强的停止任务（包含多级停止策略）
- `puma:start` - 增强的启动任务（包含端口验证）
- `puma:restart` - 增强的重启任务
- `puma:status` - 详细的状态诊断

### 服务器诊断任务

- `server:check_port` - 端口 3000 专项诊断
- `server:emergency_cleanup` - 紧急端口清理
- `server:full_diagnostic` - 完整系统诊断
- `server:check_puma` - Puma 服务器状态检查

## 预防措施

### 1. 改进的进程管理

新的 puma.rake 包含：
- 多级停止策略（QUIT → TERM → KILL）
- 端口占用检查
- 进程验证
- 自动清理机制

### 2. 部署前检查

在每次部署前执行：
```bash
USE_VPN=true bundle exec cap production server:check_port
```

### 3. 监控和日志

定期检查：
- Puma 日志：`#{shared_path}/log/puma.stdout.log`
- 错误日志：`#{shared_path}/log/puma.stderr.log`
- 系统进程：`ps aux | grep puma`

## 故障排除

### 如果端口仍被占用

1. **检查其他服务**：
   ```bash
   USE_VPN=true bundle exec cap production server:full_diagnostic
   ```

2. **手动清理**：
   ```bash
   # SSH 到服务器
   ssh test@100.98.75.43
   
   # 查看端口占用
   lsof -i:3000
   
   # 强制终止进程
   lsof -ti:3000 | xargs kill -9
   ```

3. **检查系统服务**：
   ```bash
   # 检查是否有系统服务占用端口
   sudo netstat -tuln | grep :3000
   sudo systemctl status | grep 3000
   ```

### 如果 RVM 环境有问题

```bash
# 检查 RVM 状态
USE_VPN=true bundle exec cap production server:check_rails

# 如果需要，重新安装 gems
USE_VPN=true bundle exec cap production deploy:check
```

## 常用命令速查

### 立即可用的解决方案

```bash
# 紧急修复脚本（推荐）
./emergency_port_fix.sh

# 手动步骤修复
USE_VPN=true bundle exec cap production puma:stop
USE_VPN=true bundle exec cap production puma:force_kill_port
USE_VPN=true bundle exec cap production puma:check_port
USE_VPN=true bundle exec cap production puma:start
USE_VPN=true bundle exec cap production puma:status
```

### 诊断命令

```bash
# 检查 Puma 状态
USE_VPN=true bundle exec cap production server:check_puma

# 检查端口状态
USE_VPN=true bundle exec cap production puma:check_port

# 查看 Puma 日志
USE_VPN=true bundle exec cap production server:check_logs

# 检查应用目录
USE_VPN=true bundle exec cap production server:check_app
```

### 重启服务

```bash
# 增强的重启（推荐）
USE_VPN=true bundle exec cap production puma:restart

# 强制重启
USE_VPN=true bundle exec cap production puma:force_kill_port
USE_VPN=true bundle exec cap production puma:start
```

## 联系支持

如果问题仍然存在，请提供以下信息：

1. 错误日志的完整输出
2. `server:full_diagnostic` 的输出
3. 服务器的系统信息
4. 最近的部署历史

## 更新历史

- **2025-01-20**: 创建初始版本
- **2025-01-20**: 添加自动修复脚本
- **2025-01-20**: 增强 Capistrano 任务