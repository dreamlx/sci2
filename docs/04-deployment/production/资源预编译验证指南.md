# 资源预编译验证指南

## 概述

为了防止 Active Admin 500 错误等资源相关问题，我们在部署流程中添加了自动资源预编译验证系统。

## 验证流程

### 自动验证时机

1. **资源预编译后**: `after 'deploy:assets:precompile', 'assets:verify'`
2. **应用重启前**: `before 'deploy:restart', 'assets:verify'`

### 验证内容

#### 1. 关键资源文件检查
- `active_admin.css` - Active Admin 样式文件
- `active_admin.js` - Active Admin JavaScript 文件  
- `application.css` - 应用主样式文件
- `application.js` - 应用主 JavaScript 文件

#### 2. 资源清单验证
- 检查 `.sprockets-manifest-*.json` 文件是否存在
- 验证清单中是否包含所有关键资源
- 确认物理文件与清单记录一致

#### 3. npm 依赖项检查
- `@hotwired/stimulus` - Stimulus 框架
- `@hotwired/turbo-rails` - Turbo Rails
- `esbuild` - JavaScript 构建工具

## 自动修复机制

当验证失败时，系统会自动执行以下修复步骤：

### 1. 依赖项修复
```bash
# 安装所有 npm 依赖项
npm install

# 检查并安装缺失的关键包
npm install @hotwired/stimulus @hotwired/turbo-rails esbuild
```

### 2. 资源重建
```bash
# 清理旧资源文件
rm -rf /opt/sci2/shared/public/assets/*

# 重新预编译
RAILS_ENV=production bundle exec rake assets:precompile
```

### 3. 验证结果
- 确认生成的资源文件数量
- 验证 Active Admin 相关文件是否存在
- 检查物理文件完整性

## 手动使用

### 运行验证
```bash
# 验证当前资源状态
cap production assets:verify

# 强制修复资源问题
cap production assets:fix_precompilation

# 验证修复结果
cap production assets:verify_after_fix
```

### 本地测试
```bash
# 本地预编译测试
RAILS_ENV=production bundle exec rake assets:precompile

# 检查生成的文件
ls -la public/assets/ | grep active_admin
```

## 故障排除

### 常见问题

#### 1. npm 依赖项缺失
**症状**: `Could not resolve "@hotwired/stimulus"`
**解决**: 自动安装缺失的 npm 包

#### 2. 资源文件未生成
**症状**: `The asset "active_admin.css" is not present in the asset pipeline`
**解决**: 清理并重新预编译资源

#### 3. 物理文件缺失
**症状**: 清单中有记录但文件不存在
**解决**: 重新预编译并验证文件完整性

### 手动干预

如果自动修复失败，可以手动执行：

```bash
# SSH 到服务器
ssh test@100.98.75.43

# 进入应用目录
cd /opt/sci2/current

# 加载 RVM 环境
source /usr/share/rvm/scripts/rvm

# 安装依赖项
npm install

# 手动预编译
RAILS_ENV=production bundle exec rake assets:precompile

# 重启应用
RAILS_ENV=production bundle exec pumactl restart
```

## 监控和日志

### 验证日志
验证过程会输出详细的状态信息：
- ✅ 成功状态
- ❌ 错误状态  
- ⚠️ 警告信息
- 🔧 修复操作

### 关键指标
- 资源文件数量
- Active Admin 文件存在性
- npm 包完整性
- 预编译执行时间

## 最佳实践

1. **定期检查**: 在每次部署后验证资源状态
2. **依赖管理**: 保持 `package.json` 中的依赖项完整
3. **监控日志**: 关注验证过程中的警告信息
4. **备份策略**: 保留工作正常的资源文件备份

## 相关文件

- [`lib/capistrano/tasks/assets_verification.rake`](../../../lib/capistrano/tasks/assets_verification.rake) - 验证任务定义
- [`config/deploy.rb`](../../../config/deploy.rb) - 部署流程配置
- [`app/assets/config/manifest.js`](../../../app/assets/config/manifest.js) - 资源清单配置
- [`package.json`](../../../package.json) - npm 依赖项配置