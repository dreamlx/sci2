# èµ„æºé¢„ç¼–è¯‘éªŒè¯æŒ‡å—

## æ¦‚è¿°

ä¸ºäº†é˜²æ­¢ Active Admin 500 é”™è¯¯ç­‰èµ„æºç›¸å…³é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨éƒ¨ç½²æµç¨‹ä¸­æ·»åŠ äº†è‡ªåŠ¨èµ„æºé¢„ç¼–è¯‘éªŒè¯ç³»ç»Ÿã€‚

## éªŒè¯æµç¨‹

### è‡ªåŠ¨éªŒè¯æ—¶æœº

1. **èµ„æºé¢„ç¼–è¯‘å**: `after 'deploy:assets:precompile', 'assets:verify'`
2. **åº”ç”¨é‡å¯å‰**: `before 'deploy:restart', 'assets:verify'`

### éªŒè¯å†…å®¹

#### 1. å…³é”®èµ„æºæ–‡ä»¶æ£€æŸ¥
- `active_admin.css` - Active Admin æ ·å¼æ–‡ä»¶
- `active_admin.js` - Active Admin JavaScript æ–‡ä»¶  
- `application.css` - åº”ç”¨ä¸»æ ·å¼æ–‡ä»¶
- `application.js` - åº”ç”¨ä¸» JavaScript æ–‡ä»¶

#### 2. èµ„æºæ¸…å•éªŒè¯
- æ£€æŸ¥ `.sprockets-manifest-*.json` æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- éªŒè¯æ¸…å•ä¸­æ˜¯å¦åŒ…å«æ‰€æœ‰å…³é”®èµ„æº
- ç¡®è®¤ç‰©ç†æ–‡ä»¶ä¸æ¸…å•è®°å½•ä¸€è‡´

#### 3. npm ä¾èµ–é¡¹æ£€æŸ¥
- `@hotwired/stimulus` - Stimulus æ¡†æ¶
- `@hotwired/turbo-rails` - Turbo Rails
- `esbuild` - JavaScript æ„å»ºå·¥å…·

## è‡ªåŠ¨ä¿®å¤æœºåˆ¶

å½“éªŒè¯å¤±è´¥æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹ä¿®å¤æ­¥éª¤ï¼š

### 1. ä¾èµ–é¡¹ä¿®å¤
```bash
# å®‰è£…æ‰€æœ‰ npm ä¾èµ–é¡¹
npm install

# æ£€æŸ¥å¹¶å®‰è£…ç¼ºå¤±çš„å…³é”®åŒ…
npm install @hotwired/stimulus @hotwired/turbo-rails esbuild
```

### 2. èµ„æºé‡å»º
```bash
# æ¸…ç†æ—§èµ„æºæ–‡ä»¶
rm -rf /opt/sci2/shared/public/assets/*

# é‡æ–°é¢„ç¼–è¯‘
RAILS_ENV=production bundle exec rake assets:precompile
```

### 3. éªŒè¯ç»“æœ
- ç¡®è®¤ç”Ÿæˆçš„èµ„æºæ–‡ä»¶æ•°é‡
- éªŒè¯ Active Admin ç›¸å…³æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥ç‰©ç†æ–‡ä»¶å®Œæ•´æ€§

## æ‰‹åŠ¨ä½¿ç”¨

### è¿è¡ŒéªŒè¯
```bash
# éªŒè¯å½“å‰èµ„æºçŠ¶æ€
cap production assets:verify

# å¼ºåˆ¶ä¿®å¤èµ„æºé—®é¢˜
cap production assets:fix_precompilation

# éªŒè¯ä¿®å¤ç»“æœ
cap production assets:verify_after_fix
```

### æœ¬åœ°æµ‹è¯•
```bash
# æœ¬åœ°é¢„ç¼–è¯‘æµ‹è¯•
RAILS_ENV=production bundle exec rake assets:precompile

# æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
ls -la public/assets/ | grep active_admin
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. npm ä¾èµ–é¡¹ç¼ºå¤±
**ç—‡çŠ¶**: `Could not resolve "@hotwired/stimulus"`
**è§£å†³**: è‡ªåŠ¨å®‰è£…ç¼ºå¤±çš„ npm åŒ…

#### 2. èµ„æºæ–‡ä»¶æœªç”Ÿæˆ
**ç—‡çŠ¶**: `The asset "active_admin.css" is not present in the asset pipeline`
**è§£å†³**: æ¸…ç†å¹¶é‡æ–°é¢„ç¼–è¯‘èµ„æº

#### 3. ç‰©ç†æ–‡ä»¶ç¼ºå¤±
**ç—‡çŠ¶**: æ¸…å•ä¸­æœ‰è®°å½•ä½†æ–‡ä»¶ä¸å­˜åœ¨
**è§£å†³**: é‡æ–°é¢„ç¼–è¯‘å¹¶éªŒè¯æ–‡ä»¶å®Œæ•´æ€§

### æ‰‹åŠ¨å¹²é¢„

å¦‚æœè‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
# SSH åˆ°æœåŠ¡å™¨
ssh test@100.98.75.43

# è¿›å…¥åº”ç”¨ç›®å½•
cd /opt/sci2/current

# åŠ è½½ RVM ç¯å¢ƒ
source /usr/share/rvm/scripts/rvm

# å®‰è£…ä¾èµ–é¡¹
npm install

# æ‰‹åŠ¨é¢„ç¼–è¯‘
RAILS_ENV=production bundle exec rake assets:precompile

# é‡å¯åº”ç”¨
RAILS_ENV=production bundle exec pumactl restart
```

## ç›‘æ§å’Œæ—¥å¿—

### éªŒè¯æ—¥å¿—
éªŒè¯è¿‡ç¨‹ä¼šè¾“å‡ºè¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯ï¼š
- âœ… æˆåŠŸçŠ¶æ€
- âŒ é”™è¯¯çŠ¶æ€  
- âš ï¸ è­¦å‘Šä¿¡æ¯
- ğŸ”§ ä¿®å¤æ“ä½œ

### å…³é”®æŒ‡æ ‡
- èµ„æºæ–‡ä»¶æ•°é‡
- Active Admin æ–‡ä»¶å­˜åœ¨æ€§
- npm åŒ…å®Œæ•´æ€§
- é¢„ç¼–è¯‘æ‰§è¡Œæ—¶é—´

## æœ€ä½³å®è·µ

1. **å®šæœŸæ£€æŸ¥**: åœ¨æ¯æ¬¡éƒ¨ç½²åéªŒè¯èµ„æºçŠ¶æ€
2. **ä¾èµ–ç®¡ç†**: ä¿æŒ `package.json` ä¸­çš„ä¾èµ–é¡¹å®Œæ•´
3. **ç›‘æ§æ—¥å¿—**: å…³æ³¨éªŒè¯è¿‡ç¨‹ä¸­çš„è­¦å‘Šä¿¡æ¯
4. **å¤‡ä»½ç­–ç•¥**: ä¿ç•™å·¥ä½œæ­£å¸¸çš„èµ„æºæ–‡ä»¶å¤‡ä»½

## ç›¸å…³æ–‡ä»¶

- [`lib/capistrano/tasks/assets_verification.rake`](../../../lib/capistrano/tasks/assets_verification.rake) - éªŒè¯ä»»åŠ¡å®šä¹‰
- [`config/deploy.rb`](../../../config/deploy.rb) - éƒ¨ç½²æµç¨‹é…ç½®
- [`app/assets/config/manifest.js`](../../../app/assets/config/manifest.js) - èµ„æºæ¸…å•é…ç½®
- [`package.json`](../../../package.json) - npm ä¾èµ–é¡¹é…ç½®