# 沟通工单重构部署指南

## 概述
本指南详细说明了沟通工单重构的部署步骤，确保从审核流程中分离沟通工单功能，使其专注于电话沟通记录。

## 重构目标
- ✅ 沟通工单不影响费用明细验证状态
- ✅ 沟通工单不影响报销单审核流程
- ✅ 简化沟通工单操作流程（创建→填写→自动完成）
- ✅ 保持数据完整性和向后兼容

## 部署前检查清单

### 1. 环境准备
- [ ] 确认当前系统版本和依赖
- [ ] 备份生产数据库
- [ ] 确认测试环境可用
- [ ] 准备回滚方案

### 2. 代码审查
- [ ] 审查所有修改的文件
- [ ] 确认测试用例覆盖率
- [ ] 验证业务逻辑正确性
- [ ] 检查性能影响

### 3. 测试验证
- [ ] 运行单元测试
- [ ] 运行集成测试
- [ ] 手动测试关键流程
- [ ] 性能测试

## 部署步骤

### 第一步：代码部署
```bash
# 1. 拉取最新代码
git pull origin main

# 2. 安装依赖
bundle install

# 3. 预编译资源
rails assets:precompile
```

### 第二步：数据库迁移
```bash
# 1. 运行迁移脚本
rails db:migrate

# 2. 检查迁移结果
rails db:migrate:status
```

### 第三步：状态重新计算
```bash
# 1. 检查影响范围
rails communication_work_order:check_impact

# 2. 重新计算费用明细状态
rails communication_work_order:full_recalculate

# 3. 清理沟通工单状态
rails communication_work_order:cleanup_communication_work_orders
```

### 第四步：功能验证
1. **创建沟通工单测试**
   - 从报销单页面创建沟通工单
   - 验证表单只包含沟通相关字段
   - 确认提交后自动完成

2. **状态隔离测试**
   - 创建沟通工单关联费用明细
   - 验证费用明细状态不变
   - 确认报销单状态不受影响

3. **审核工单测试**
   - 验证审核工单功能正常
   - 确认审核工单仍能影响状态
   - 测试混合场景（审核+沟通工单）

### 第五步：性能监控
```bash
# 1. 监控状态计算性能
rails runner "
  start_time = Time.current
  FeeDetailStatusService.new(FeeDetail.limit(100).pluck(:id)).update_status
  puts \"状态计算耗时: #{Time.current - start_time}秒\"
"

# 2. 检查数据库查询性能
# 监控慢查询日志
```

## 验证检查点

### 核心功能验证
- [ ] 沟通工单创建后自动完成
- [ ] 沟通工单不影响费用明细状态
- [ ] 审核工单功能保持正常
- [ ] 报销单状态计算正确
- [ ] UI界面显示正确

### 数据一致性检查
```sql
-- 检查沟通工单状态
SELECT status, COUNT(*) FROM work_orders 
WHERE type = 'CommunicationWorkOrder' 
GROUP BY status;

-- 检查费用明细状态分布
SELECT verification_status, COUNT(*) FROM fee_details 
GROUP BY verification_status;

-- 检查只有沟通工单关联的费用明细
SELECT COUNT(*) FROM fee_details fd
WHERE EXISTS (
  SELECT 1 FROM work_order_fee_details wofd 
  JOIN work_orders wo ON wofd.work_order_id = wo.id 
  WHERE wofd.fee_detail_id = fd.id AND wo.type = 'CommunicationWorkOrder'
) AND NOT EXISTS (
  SELECT 1 FROM work_order_fee_details wofd 
  JOIN work_orders wo ON wofd.work_order_id = wo.id 
  WHERE wofd.fee_detail_id = fd.id AND wo.type != 'CommunicationWorkOrder'
);
```

### 性能基准测试
```bash
# 测试状态计算性能
rails runner "
  require 'benchmark'
  
  fee_detail_ids = FeeDetail.limit(1000).pluck(:id)
  
  time = Benchmark.measure do
    FeeDetailStatusService.new(fee_detail_ids).update_status
  end
  
  puts \"处理1000个费用明细耗时: #{time.real}秒\"
"
```

## 回滚方案

### 紧急回滚步骤
如果发现严重问题，可以按以下步骤回滚：

1. **代码回滚**
```bash
# 回滚到上一个稳定版本
git revert <commit-hash>
git push origin main
```

2. **数据库回滚**
```bash
# 回滚迁移（如果需要）
rails db:rollback STEP=1
```

3. **状态恢复**
```bash
# 使用备份数据恢复状态
# 或重新运行原有的状态计算逻辑
```

### 部分回滚选项
如果只需要回滚特定功能：

1. **恢复原有UI界面**
   - 恢复 `app/views/admin/communication_work_orders/_form.html.erb`
   - 恢复 `app/admin/communication_work_orders.rb`

2. **恢复原有状态逻辑**
   - 恢复 `app/services/fee_detail_status_service.rb`
   - 重新运行状态计算

## 监控和维护

### 关键指标监控
1. **业务指标**
   - 沟通工单创建数量
   - 费用明细状态分布
   - 报销单处理时间

2. **技术指标**
   - 状态计算性能
   - 数据库查询性能
   - 错误率和异常

3. **用户体验指标**
   - 页面加载时间
   - 操作成功率
   - 用户反馈

### 日常维护任务
```bash
# 每日状态一致性检查
rails communication_work_order:check_impact

# 每周性能检查
rails runner "
  # 检查慢查询和性能指标
"

# 每月数据清理
# 清理过期的临时数据
```

## 故障排除

### 常见问题及解决方案

1. **费用明细状态不正确**
```bash
# 重新计算特定费用明细状态
rails runner "
  fee_detail_id = ARGV[0]
  FeeDetailStatusService.new([fee_detail_id]).update_status
  puts \"费用明细 ##{fee_detail_id} 状态已更新\"
" -- <fee_detail_id>
```

2. **沟通工单状态异常**
```bash
# 修复沟通工单状态
rails communication_work_order:cleanup_communication_work_orders
```

3. **性能问题**
```bash
# 检查数据库索引
rails runner "
  # 检查相关表的索引使用情况
  ActiveRecord::Base.connection.execute('EXPLAIN ANALYZE SELECT ...')
"
```

## 联系信息
- **技术负责人**: [姓名] <email@example.com>
- **业务负责人**: [姓名] <email@example.com>
- **紧急联系**: [电话号码]

## 附录

### 修改文件清单
- `app/services/fee_detail_status_service.rb` - 核心状态服务
- `app/models/communication_work_order.rb` - 沟通工单模型
- `app/views/admin/communication_work_orders/_form.html.erb` - 表单界面
- `app/admin/communication_work_orders.rb` - ActiveAdmin配置
- `db/migrate/20250814062600_recalculate_fee_detail_status_excluding_communication_work_orders.rb` - 数据迁移
- `lib/tasks/communication_work_order_refactor.rake` - 维护任务
- `spec/services/fee_detail_status_service_spec.rb` - 服务测试
- `spec/models/communication_work_order_spec.rb` - 模型测试
- `spec/integration/communication_work_order_refactor_spec.rb` - 集成测试

### 相关文档
- [沟通工单重构设计方案](./沟通工单重构设计方案.md)
- [系统架构文档](../SCI-系统设计/)
- [API文档](../api/)