# 文档一致性检查指南

## 📋 概述

本指南提供了检查和维护文档与代码一致性的方法和工具，确保文档始终反映实际的系统实现。

## 🔍 检查维度

### 1. API文档一致性

#### 检查内容
- 路由定义与API文档的一致性
- 参数类型和必填项
- 响应格式和状态码
- 认证和权限要求

#### 检查方法
```bash
# 提取路由信息
rails routes > tmp/current_routes.txt

# 对比API文档中的路由
grep -r "GET\|POST\|PUT\|DELETE" docs/03-development/api/ > tmp/documented_routes.txt

# 人工对比差异
diff tmp/current_routes.txt tmp/documented_routes.txt
```

#### 自动化脚本建议
```ruby
# scripts/check_api_docs.rb
#!/usr/bin/env ruby

require_relative '../config/environment'

class ApiDocChecker
  def check_routes
    # 获取实际路由
    actual_routes = Rails.application.routes.routes.map do |route|
      {
        verb: route.verb,
        path: route.path.spec.to_s,
        controller: route.defaults[:controller],
        action: route.defaults[:action]
      }
    end
    
    # 检查文档中的路由
    # 实现逻辑...
  end
  
  def check_parameters
    # 检查参数定义
    # 实现逻辑...
  end
end
```

### 2. 数据模型一致性

#### 检查内容
- 数据库表结构与模型文档
- 字段类型、约束和默认值
- 关联关系定义
- 验证规则

#### 检查方法
```bash
# 生成当前数据库结构
rails db:schema:dump

# 对比schema.rb与模型文档
# 检查字段定义
grep -r "t\." db/schema.rb > tmp/current_schema.txt
```

#### 模型文档模板
```markdown
# 模型名称

## 字段定义
| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | integer | primary key | - | 主键 |
| name | string | not null | - | 名称 |

## 关联关系
- belongs_to :user
- has_many :items

## 验证规则
- validates :name, presence: true
- validates :email, uniqueness: true

## 业务逻辑
- 状态机定义
- 回调方法
- 作用域定义
```

### 3. 服务类一致性

#### 检查内容
- 服务类的公共方法签名
- 参数类型和返回值
- 异常处理
- 业务逻辑流程

#### 检查方法
```bash
# 提取服务类方法
find app/services -name "*.rb" -exec grep -H "def " {} \; > tmp/service_methods.txt

# 检查文档中的方法定义
find docs/03-development/services -name "*.md" -exec grep -H "def\|方法" {} \;
```

### 4. 配置参数一致性

#### 检查内容
- 环境变量定义
- 配置文件参数
- 默认值设置
- 参数说明

#### 检查方法
```bash
# 提取环境变量
grep -r "ENV\[" app/ config/ > tmp/env_vars.txt

# 检查配置文档
grep -r "ENV\|环境变量" docs/04-deployment/ docs/07-reference/
```

## 🛠️ 检查工具

### 1. 自动化检查脚本

#### 主检查脚本
```bash
#!/bin/bash
# scripts/doc_consistency_check.sh

echo "=== SCI2 文档一致性检查 ==="
echo "开始时间: $(date)"

# 1. 检查API文档
echo "1. 检查API文档一致性..."
ruby scripts/check_api_docs.rb

# 2. 检查数据模型
echo "2. 检查数据模型一致性..."
ruby scripts/check_model_docs.rb

# 3. 检查服务类
echo "3. 检查服务类一致性..."
ruby scripts/check_service_docs.rb

# 4. 检查配置文档
echo "4. 检查配置文档一致性..."
ruby scripts/check_config_docs.rb

# 5. 生成报告
echo "5. 生成一致性报告..."
ruby scripts/generate_consistency_report.rb

echo "检查完成时间: $(date)"
```

### 2. 持续集成检查

#### GitHub Actions配置
```yaml
# .github/workflows/doc_consistency.yml
name: Documentation Consistency Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  doc-consistency:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.0
        
    - name: Install dependencies
      run: bundle install
      
    - name: Check documentation consistency
      run: |
        chmod +x scripts/doc_consistency_check.sh
        ./scripts/doc_consistency_check.sh
        
    - name: Upload consistency report
      uses: actions/upload-artifact@v2
      with:
        name: consistency-report
        path: tmp/consistency_report.html
```

### 3. 开发环境集成

#### Git Hooks
```bash
#!/bin/bash
# .git/hooks/pre-commit

# 检查是否有模型文件变更
if git diff --cached --name-only | grep -q "app/models/\|db/migrate/"; then
    echo "检测到模型变更，检查文档一致性..."
    ruby scripts/check_model_docs.rb --quick
    if [ $? -ne 0 ]; then
        echo "文档一致性检查失败，请更新相关文档"
        exit 1
    fi
fi
```

## 📊 一致性报告

### 报告格式

#### HTML报告模板
```html
<!DOCTYPE html>
<html>
<head>
    <title>SCI2 文档一致性报告</title>
    <style>
        .pass { color: green; }
        .fail { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>文档一致性检查报告</h1>
    <p>生成时间: {{timestamp}}</p>
    
    <h2>总体统计</h2>
    <ul>
        <li>检查项目: {{total_checks}}</li>
        <li class="pass">通过: {{passed_checks}}</li>
        <li class="fail">失败: {{failed_checks}}</li>
        <li class="warning">警告: {{warning_checks}}</li>
    </ul>
    
    <h2>详细结果</h2>
    {{detailed_results}}
</body>
</html>
```

#### Markdown报告模板
```markdown
# 文档一致性检查报告

**生成时间**: {{timestamp}}  
**检查版本**: {{git_commit}}

## 📊 总体统计

| 检查类型 | 总数 | 通过 | 失败 | 警告 |
|---------|------|------|------|------|
| API文档 | {{api_total}} | {{api_pass}} | {{api_fail}} | {{api_warn}} |
| 数据模型 | {{model_total}} | {{model_pass}} | {{model_fail}} | {{model_warn}} |
| 服务类 | {{service_total}} | {{service_pass}} | {{service_fail}} | {{service_warn}} |
| 配置参数 | {{config_total}} | {{config_pass}} | {{config_fail}} | {{config_warn}} |

## 🔍 详细结果

### API文档检查
{{api_details}}

### 数据模型检查
{{model_details}}

### 服务类检查
{{service_details}}

### 配置参数检查
{{config_details}}

## 📋 待修复问题

### 高优先级
{{high_priority_issues}}

### 中优先级
{{medium_priority_issues}}

### 低优先级
{{low_priority_issues}}
```

## 🔄 维护流程

### 日常维护

#### 1. 代码变更时
```bash
# 开发者在提交代码前运行
./scripts/doc_consistency_check.sh --quick

# 如果发现不一致，更新相关文档
# 然后重新检查
./scripts/doc_consistency_check.sh --verify-fix
```

#### 2. 功能发布前
```bash
# 完整的一致性检查
./scripts/doc_consistency_check.sh --full

# 生成详细报告
./scripts/generate_consistency_report.rb --detailed --output=tmp/release_doc_report.html
```

### 定期维护

#### 每周检查
- 运行完整的一致性检查
- 审查新增的不一致问题
- 更新文档债务清单

#### 每月审查
- 分析一致性趋势
- 评估文档质量指标
- 优化检查工具和流程

#### 每季度评估
- 全面审查文档结构
- 评估用户反馈
- 调整文档策略

## 🎯 质量指标

### 一致性指标
- **API一致性**: 目标 ≥95%
- **模型一致性**: 目标 ≥98%
- **配置一致性**: 目标 ≥90%
- **整体一致性**: 目标 ≥95%

### 响应时间指标
- **问题发现**: ≤1天
- **问题修复**: ≤3天
- **文档更新**: ≤1天

### 覆盖率指标
- **API覆盖率**: ≥90%
- **模型覆盖率**: ≥95%
- **服务覆盖率**: ≥85%

## 🚨 告警机制

### 告警级别

#### 严重 (Critical)
- 核心API文档与实现不符
- 数据库结构重大变更未更新文档
- 部署配置错误

#### 警告 (Warning)
- 新增API未添加文档
- 模型字段变更未更新说明
- 配置参数缺少说明

#### 信息 (Info)
- 文档格式不规范
- 链接失效
- 示例代码过时

### 通知方式
- **Slack通知**: 实时告警
- **邮件报告**: 每日/每周汇总
- **GitHub Issue**: 自动创建修复任务

## 📚 最佳实践

### 文档编写
1. **同步更新**: 代码变更时同步更新文档
2. **模板使用**: 使用标准化的文档模板
3. **交叉引用**: 建立文档间的关联关系
4. **版本标记**: 标明文档的适用版本

### 检查流程
1. **自动化优先**: 尽可能使用自动化检查
2. **人工审查**: 定期进行人工审查
3. **持续改进**: 根据检查结果优化流程
4. **团队协作**: 建立团队文档维护责任制

### 工具使用
1. **脚本维护**: 定期更新检查脚本
2. **报告分析**: 深入分析一致性报告
3. **指标监控**: 持续监控质量指标
4. **反馈循环**: 建立用户反馈机制

---

> 💡 **提示**: 文档一致性检查是一个持续的过程，需要团队的共同努力。建议将检查工具集成到日常开发流程中，确保文档始终与代码保持同步。