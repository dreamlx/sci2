# 数据导入顺序测试说明

## 导入顺序重要性

根据系统设计，四种CSV数据必须按照特定顺序导入，以确保数据正确关联：

1. 首先导入**报销单报表**，建立基础数据
2. 然后导入**快递收单导出数据**，关联到报销单
3. 接着导入**单据费用明细报表**，关联到报销单
4. 最后导入**每单操作历史数据**，更新报销单状态

不按照正确顺序导入可能导致数据关联失败或工单生成错误。

## 数据关系说明

### 数据模型关系

1. **Reimbursement（报销单）**：核心模型，通过 `invoice_number` 字段与其他模型关联
2. **ExpressReceipt（快递收单）**：通过 `document_number` 字段关联到报销单的 `invoice_number`
3. **FeeDetail（费用明细）**：通过 `document_number` 字段关联到报销单的 `invoice_number`
4. **OperationHistory（操作历史）**：通过 `document_number` 字段关联到报销单的 `invoice_number`
5. **WorkOrder（工单）**：通过 `document_number` 字段关联到报销单的 `invoice_number`，包含多种子类型：
   - **AuditWorkOrder（审核工单）**
   - **ExpressReceiptWorkOrder（快递收单工单）**
   - **CommunicationWorkOrder（沟通工单）**

### 导入流程影响

1. **报销单导入**：创建基础报销单记录
2. **快递收单导入**：
   - 关联到已存在的报销单
   - 更新报销单的收单状态
   - 创建快递收单工单
3. **费用明细导入**：
   - 关联到已存在的报销单
   - 创建费用明细记录
4. **操作历史导入**：
   - 关联到已存在的报销单
   - 根据操作类型更新报销单状态
   - 可能创建沟通工单（如果操作类型为"需补件"）

## 测试方法

### 自动化测试

我们创建了自动化测试来验证导入顺序和数据关联：

1. **集成测试**：`sci2/test/integration/import_order_test.rb`
   - 测试正确导入顺序的情况
   - 测试错误导入顺序的情况（系统应能优雅处理）

运行测试：
```
rails test test/integration/import_order_test.rb
```

### 手动测试

我们提供了测试数据和脚本，可以手动验证导入过程：

1. **测试数据**：`sci2/test/fixtures/` 目录下的CSV文件
   - `test_reimbursements.csv` - 测试用报销单数据
   - `test_express_receipts.csv` - 测试用快递收单数据
   - `test_fee_details.csv` - 测试用费用明细数据
   - `test_operation_histories.csv` - 测试用操作历史数据

2. **测试脚本**：`sci2/test/scripts/run_import_test.rb`
   - 自动转换CSV为XLSX
   - 按正确顺序导入数据
   - 验证导入结果

运行脚本：
```
rails runner test/scripts/run_import_test.rb
```

## 验证要点

导入完成后，应验证以下几点：

1. **报销单状态**：
   - ER-TEST-001：状态应为"已审批"，收单状态应为"已收单"
   - ER-TEST-002：状态应为"pending"，收单状态应为"未收单"（电子发票）
   - ER-TEST-003：状态应为"已审批"，收单状态应为"已收单"

2. **工单创建**：
   - 快递收单工单：应关联到 ER-TEST-001 和 ER-TEST-003
   - 审核工单：应关联到 ER-TEST-001 和 ER-TEST-003
   - 沟通工单：应关联到 ER-TEST-002（因为操作历史中有"需补件"记录）

3. **数据关联**：
   - 费用明细应正确关联到对应报销单，且金额总和应匹配
   - 快递收单应正确关联到对应报销单
   - 操作历史应正确关联到对应报销单

## 特殊情况处理

系统应能处理以下特殊情况：

1. **电子发票报销单**：ER-TEST-002 标记为电子发票，不需要快递收单
2. **未匹配的快递单**：如果导入快递收单时找不到对应的报销单，系统应创建占位报销单
3. **需补件情况**：ER-TEST-002 的操作历史为"需补件"，系统应创建沟通工单

## 结论

正确的导入顺序对于确保数据完整性和关联关系至关重要。通过遵循文档中描述的导入顺序，可以确保系统正确处理数据关联和工单生成。

测试用例和脚本提供了验证导入顺序正确性的方法，可以帮助开发和测试团队确保系统按预期工作。