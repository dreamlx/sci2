# 工单系统集成测试用户故事

## 测试场景：多报销单完整处理流程

### 测试目标

验证工单系统在真实业务场景下的完整功能，包括数据导入、工单创建、状态流转、费用明细验证和报销单状态联动等核心功能。

### 测试角色

张经理：系统管理员，同时具有审计组和沟通组权限，负责处理所有报销单相关工作。

### 测试数据准备

#### 1. 报销单数据 (10条)

创建一个CSV文件 `test_reimbursements.csv`，包含以下数据：

```csv
报销单单号,单据名称,报销单申请人,报销单申请人工号,申请人公司,申请人部门,收单状态,收单日期,提交报销日期,报销金额（单据币种）,报销单状态
R2025001,差旅费报销,李明,E001,科技有限公司,研发部,pending,,2025-04-01,1200.50,待审批
R2025002,办公用品报销,王芳,E002,科技有限公司,行政部,pending,,2025-04-02,458.75,待审批
R2025003,会议费用报销,张伟,E003,科技有限公司,市场部,pending,,2025-04-03,3500.00,待审批
R2025004,培训费用报销,刘洋,E004,科技有限公司,人力资源部,pending,,2025-04-04,2800.00,待审批
R2025005,交通费报销,赵静,E005,科技有限公司,财务部,pending,,2025-04-05,320.50,待审批
R2025006,餐费报销,陈明,E006,科技有限公司,销售部,pending,,2025-04-06,680.00,待审批
R2025007,设备采购报销,林华,E007,科技有限公司,IT部,pending,,2025-04-07,12500.00,待审批
R2025008,广告费用报销,黄强,E008,科技有限公司,市场部,pending,,2025-04-08,8600.00,待审批
R2025009,维修费用报销,周丽,E009,科技有限公司,行政部,pending,,2025-04-09,1450.00,待审批
R2025010,通讯费报销,吴刚,E010,科技有限公司,研发部,pending,,2025-04-10,350.00,待审批
```

#### 2. 快递收单数据

创建一个CSV文件 `test_express_receipts.csv`，包含以下数据：

```csv
单据编号,操作类型,操作日期,操作人,操作意见
R2025001,收单,2025-04-11,张经理,SF1234567890
R2025002,收单,2025-04-11,张经理,YT9876543210
R2025003,收单,2025-04-12,张经理,ZT1122334455
R2025004,收单,2025-04-12,张经理,JD5566778899
R2025005,收单,2025-04-13,张经理,SF2468135790
R2025006,收单,2025-04-13,张经理,YT1357924680
R2025007,收单,2025-04-14,张经理,ZT2468013579
R2025008,收单,2025-04-14,张经理,JD1324354657
R2025009,收单,2025-04-15,张经理,SF9876543210
R2025010,收单,2025-04-15,张经理,YT1234567890
```

#### 3. 费用明细数据

创建一个CSV文件 `test_fee_details.csv`，包含以下数据：

```csv
报销单单号,费用类型,原始金额,原始币种,费用发生日期,弹性字段11
R2025001,机票,800.00,CNY,2025-03-25,信用卡
R2025001,住宿,300.50,CNY,2025-03-26,信用卡
R2025001,餐费,100.00,CNY,2025-03-26,现金
R2025002,打印纸,158.75,CNY,2025-03-30,公司账户
R2025002,文具,300.00,CNY,2025-03-30,公司账户
R2025003,场地租赁,2500.00,CNY,2025-03-15,公司账户
R2025003,茶点,1000.00,CNY,2025-03-15,现金
R2025004,培训费,2800.00,CNY,2025-03-20,公司账户
R2025005,出租车,120.50,CNY,2025-04-01,现金
R2025005,地铁,200.00,CNY,2025-04-02,交通卡
R2025006,团队午餐,680.00,CNY,2025-04-03,信用卡
R2025007,电脑,8500.00,CNY,2025-03-28,公司账户
R2025007,显示器,4000.00,CNY,2025-03-28,公司账户
R2025008,线上广告,5600.00,CNY,2025-03-25,公司账户
R2025008,平面广告,3000.00,CNY,2025-03-26,公司账户
R2025009,空调维修,950.00,CNY,2025-04-05,现金
R2025009,门锁更换,500.00,CNY,2025-04-06,现金
R2025010,手机费,200.00,CNY,2025-04-01,信用卡
R2025010,宽带费,150.00,CNY,2025-04-01,信用卡
```

#### 4. 操作历史数据

创建一个CSV文件 `test_operation_histories.csv`，包含以下数据：

```csv
单据编号,操作类型,操作日期,操作人,操作意见
R2025001,提交,2025-04-01,李明,请审批
R2025002,提交,2025-04-02,王芳,请审批
R2025003,提交,2025-04-03,张伟,请审批
R2025004,提交,2025-04-04,刘洋,请审批
R2025005,提交,2025-04-05,赵静,请审批
R2025006,提交,2025-04-06,陈明,请审批
R2025007,提交,2025-04-07,林华,请审批
R2025008,提交,2025-04-08,黄强,请审批
R2025009,提交,2025-04-09,周丽,请审批
R2025010,提交,2025-04-10,吴刚,请审批
```

### 测试流程

#### 第一阶段：数据导入

1. 张经理登录系统
2. 导入报销单数据
   - 上传 `test_reimbursements.csv`
   - 验证成功导入10条报销单记录
   - 验证所有报销单状态为 pending

3. 导入快递收单数据
   - 上传 `test_express_receipts.csv`
   - 验证成功导入10条快递收单记录
   - 验证自动创建10个快递收单工单，状态为 completed
   - 验证报销单状态仍为 pending

4. 导入费用明细数据
   - 上传 `test_fee_details.csv`
   - 验证成功导入19条费用明细记录
   - 验证所有费用明细状态为 pending

5. 导入操作历史数据
   - 上传 `test_operation_histories.csv`
   - 验证成功导入10条操作历史记录

#### 第二阶段：审核工单处理

1. 处理报销单 R2025001（直接通过路径）
   - 进入报销单 R2025001 详情页
   - 创建审核工单
   - 选择所有费用明细
   - 处理意见选择"审核通过"并保存
   - 验证工单状态直接变为 approved
   - 验证费用明细状态直接变为 verified
   - 验证报销单状态变为 waiting_completion

2. 处理报销单 R2025002（标准通过路径）
   - 进入报销单 R2025002 详情页
   - 创建审核工单
   - 选择所有费用明细
   - 填写问题类型为"文档不完整"，问题说明为"缺少发票照片"，备注为"请补充发票照片"
   - 保存工单（状态变为 processing）
   - 验证费用明细状态变为 problematic
   - 再次编辑工单，处理意见选择"审核通过"并保存
   - 验证工单状态变为 approved
   - 验证费用明细状态变为 verified
   - 验证报销单状态变为 waiting_completion

3. 处理报销单 R2025003（拒绝路径）
   - 进入报销单 R2025003 详情页
   - 创建审核工单
   - 选择所有费用明细
   - 填写问题类型为"金额错误"，问题说明为"金额超出预算"，备注为"请调整金额后重新提交"
   - 处理意见选择"否决"并保存
   - 验证工单状态变为 rejected
   - 验证费用明细状态变为 problematic
   - 验证报销单状态变为 processing

#### 第三阶段：沟通工单处理

1. 处理报销单 R2025003（沟通后通过）
   - 进入报销单 R2025003 详情页
   - 创建沟通工单
   - 选择所有费用明细
   - 填写问题类型为"金额错误"，问题说明为"金额超出预算"，备注为"已与申请人沟通，金额已调整"
   - 勾选 needs_communication 标志
   - 保存工单（状态变为 processing）
   - 添加沟通记录："已与张伟电话沟通，确认金额调整为3000元"
   - 再次编辑工单，处理意见选择"审核通过"并保存
   - 验证工单状态变为 approved
   - 验证费用明细状态变为 verified
   - 验证报销单状态变为 waiting_completion

2. 处理报销单 R2025004（直接通过路径）
   - 进入报销单 R2025004 详情页
   - 创建沟通工单
   - 选择所有费用明细
   - 处理意见选择"审核通过"并保存
   - 验证工单状态直接变为 approved
   - 验证费用明细状态直接变为 verified
   - 验证报销单状态变为 waiting_completion

#### 第四阶段：混合处理场景

1. 处理报销单 R2025005（费用明细分开处理）
   - 进入报销单 R2025005 详情页
   - 创建审核工单
   - 只选择"出租车"费用明细
   - 处理意见选择"审核通过"并保存
   - 验证选中费用明细状态变为 verified
   - 验证报销单状态仍为 processing（因为还有未验证的费用明细）
   - 创建另一个审核工单
   - 选择"地铁"费用明细
   - 处理意见选择"审核通过"并保存
   - 验证所有费用明细状态变为 verified
   - 验证报销单状态变为 waiting_completion

2. 处理报销单 R2025006（审核拒绝后沟通通过）
   - 进入报销单 R2025006 详情页
   - 创建审核工单
   - 选择所有费用明细
   - 填写问题类型为"缺少证明"，问题说明为"缺少参会人员名单"，备注为"请提供参会人员名单"
   - 处理意见选择"否决"并保存
   - 验证工单状态变为 rejected
   - 验证费用明细状态变为 problematic
   - 创建沟通工单
   - 选择所有费用明细
   - 填写问题类型为"缺少证明"，问题说明为"缺少参会人员名单"，备注为"已收到参会人员名单"
   - 勾选 needs_communication 标志
   - 添加沟通记录："已与陈明电话沟通，已收到参会人员名单"
   - 处理意见选择"审核通过"并保存
   - 验证工单状态变为 approved
   - 验证费用明细状态变为 verified
   - 验证报销单状态变为 waiting_completion

#### 第五阶段：操作历史导入与状态更新

1. 创建操作历史数据
   - 创建一个新的CSV文件 `test_operation_histories_approval.csv`，包含以下数据：
   ```csv
   单据编号,操作类型,操作日期,操作人,操作意见
   R2025001,审批,2025-04-20,李总,审批通过
   R2025002,审批,2025-04-20,李总,审批通过
   R2025003,审批,2025-04-21,李总,审批通过
   R2025004,审批,2025-04-21,李总,审批通过
   R2025005,审批,2025-04-22,李总,审批通过
   R2025006,审批,2025-04-22,李总,审批通过
   ```

2. 导入操作历史数据
   - 上传 `test_operation_histories_approval.csv`
   - 验证成功导入6条操作历史记录
   - 验证报销单 R2025001 至 R2025006 的状态变为 closed
   - 验证工单状态不受影响

#### 第六阶段：电子发票标志测试

1. 设置电子发票标志
   - 进入报销单 R2025007 详情页
   - 编辑报销单，勾选电子发票标志并保存
   - 验证报销单列表页和详情页显示电子发票标志

#### 第七阶段：多工单关联同一费用明细

1. 处理报销单 R2025007（多工单关联同一费用明细）
   - 进入报销单 R2025007 详情页
   - 创建审核工单A
   - 选择"电脑"费用明细
   - 填写问题类型为"金额错误"，问题说明为"金额超出预算"，备注为"请确认金额"
   - 保存工单（状态变为 processing）
   - 验证费用明细状态变为 problematic
   - 创建沟通工单B
   - 选择同样的"电脑"费用明细
   - 填写问题类型为"金额错误"，问题说明为"金额超出预算"，备注为"已与申请人沟通确认金额正确"
   - 处理意见选择"审核通过"并保存
   - 验证工单B状态变为 approved
   - 验证费用明细状态变为 verified（跟随最新处理的工单B）
   - 创建审核工单C
   - 选择"显示器"费用明细
   - 处理意见选择"审核通过"并保存
   - 验证所有费用明细状态变为 verified
   - 验证报销单状态变为 waiting_completion

### 测试验证点

1. **数据导入功能**
   - 报销单、快递收单、费用明细和操作历史数据导入成功
   - 重复数据处理正确
   - 关联关系正确建立

2. **工单状态流转**
   - 审核工单和沟通工单状态流转符合预期
   - 直接通过路径正常工作
   - 处理意见与状态关系正确

3. **费用明细验证**
   - 费用明细状态随工单状态正确变化
   - 多工单关联同一费用明细时，状态跟随最新处理的工单
   - 所有费用明细verified时，报销单状态自动变为waiting_completion

4. **报销单状态联动**
   - 报销单状态随费用明细状态正确变化
   - 操作历史导入后，报销单状态正确更新为closed

5. **沟通工单特性**
   - needs_communication布尔标志正确工作
   - 沟通记录正确添加和显示

6. **电子发票标志**
   - 电子发票标志可以正确设置和显示

### 预期结果

1. 所有10条报销单数据成功导入和处理
2. 工单状态流转符合预期，包括直接通过路径和标准流转路径
3. 费用明细状态正确更新，并影响报销单状态
4. 操作历史导入后，报销单状态正确更新为closed
5. 沟通工单的needs_communication布尔标志和沟通记录功能正常工作
6. 电子发票标志可以正确设置和显示
7. 多工单关联同一费用明细时，状态跟随最新处理的工单

这个集成测试用户故事涵盖了工单系统的主要功能点，模拟了真实业务场景下的完整操作流程，可以有效验证系统的功能完整性和正确性。