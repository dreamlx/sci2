# ActiveAdmin实现计划

## 概述

本文档提供了SCI2工单系统ActiveAdmin实现的详细计划，包括资源注册、自定义控制器、视图模板和样式设计。实现将基于单表继承(STI)模型，确保用户界面符合业务需求和用户体验设计。

## 实现目标

1. 实现报销单、工单、费用明细和操作历史的ActiveAdmin资源
2. 实现数据导入功能
3. 实现工单状态流转功能
4. 实现费用明细验证功能
5. 实现沟通记录管理功能
6. 实现仪表盘和数据可视化

## 实现步骤

### 1. 基础配置

#### 1.1 ActiveAdmin初始化配置

修改 `config/initializers/active_admin.rb` 文件：

```ruby
ActiveAdmin.setup do |config|
  config.site_title = "SCI2工单系统"
  config.default_namespace = :admin
  config.root_to = 'dashboard#index'
  config.batch_actions = true
  config.default_per_page = 30
  config.csv_options = { col_sep: ',', force_quotes: true }
  config.filters_position = :right
  config.comments = false # 禁用评论功能
  
  # 设置默认时区
  config.before_action do
    Time.zone = 'Beijing'
  end
  
  # 自定义页脚
  config.view_factory.footer = proc do
    render partial: 'admin/shared/custom_footer'
  end
  
  # 添加下载链接
  config.download_links = [:csv, :xlsx]
  
  # 自定义CSS和JavaScript
  config.register_stylesheet 'active_admin/custom.css'
  config.register_javascript 'active_admin/custom.js'
end
```

#### 1.2 创建自定义样式和脚本

创建 `app/assets/stylesheets/active_admin/custom.scss` 文件：

```scss
// 自定义ActiveAdmin样式

// 状态标签样式
.status_tag {
  &.pending {
    background-color: #6c757d;
  }
  
  &.processing {
    background-color: #007bff;
  }
  
  &.waiting_completion {
    background-color: #fd7e14;
  }
  
  &.closed {
    background-color: #28a745;
  }
  
  &.approved {
    background-color: #28a745;
  }
  
  &.rejected {
    background-color: #dc3545;
  }
  
  &.needs_communication {
    background-color: #6f42c1;
  }
  
  &.completed {
    background-color: #28a745;
  }
  
  &.problematic {
    background-color: #dc3545;
  }
  
  &.verified {
    background-color: #28a745;
  }
}

// 表单样式
.formtastic {
  .input {
    margin-bottom: 15px;
  }
  
  .label {
    font-weight: bold;
  }
  
  .inline-errors {
    color: #dc3545;
    margin-top: 5px;
  }
  
  .check_boxes {
    .choices-group {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      
      .choice {
        margin-bottom: 5px;
      }
    }
  }
}

// 标签页样式
.ui-tabs {
  .ui-tabs-nav {
    li {
      a {
        padding: 8px 15px;
      }
      
      &.ui-tabs-active {
        a {
          background-color: #2678e3;
          color: white;
        }
      }
    }
  }
}

// 导入表单样式
.import-form {
  .import-instructions {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 4px;
    
    ul {
      margin-left: 20px;
    }
  }
}

// 时间线样式
.timeline {
  // 样式定义见仪表盘设计与实现文档
}

// 响应式调整
@media (max-width: 767px) {
  .columns {
    .column {
      width: 100% !important;
      margin-right: 0 !important;
    }
  }
}
```

创建 `app/assets/javascripts/active_admin/custom.js` 文件：

```javascript
// 自定义ActiveAdmin脚本

// 文档加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
  // 全选/取消全选复选框
  var selectAllCheckbox = document.getElementById('select-all-fee-details');
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      var checkboxes = document.querySelectorAll('.fee-detail-checkbox');
      checkboxes.forEach(function(checkbox) {
        checkbox.checked = selectAllCheckbox.checked;
      });
    });
  }
  
  // 表单验证
  var workOrderForm = document.querySelector('.work_order_form');
  if (workOrderForm) {
    workOrderForm.addEventListener('submit', function(event) {
      var feeDetailCheckboxes = document.querySelectorAll('.fee-detail-checkbox:checked');
      if (feeDetailCheckboxes.length === 0) {
        event.preventDefault();
        alert('请至少选择一条费用明细');
      }
    });
  }
  
  // 动态显示/隐藏表单字段
  var problemTypeSelect = document.querySelector('select[name*="problem_type"]');
  if (problemTypeSelect) {
    var problemDescriptionField = document.querySelector('.problem_description_input');
    
    problemTypeSelect.addEventListener('change', function() {
      if (this.value === 'other_issue') {
        problemDescriptionField.style.display = 'block';
      } else {
        problemDescriptionField.style.display = 'none';
      }
    });
    
    // 初始化时触发一次
    problemTypeSelect.dispatchEvent(new Event('change'));
  }
});
### 2. 资源注册

#### 2.1 报销单资源

创建 `app/admin/reimbursements.rb` 文件：

```ruby
ActiveAdmin.register Reimbursement do
  # 权限控制
  permit_params :invoice_number, :document_name, :applicant, :applicant_id, :company, :department,
                :amount, :receipt_status, :status, :receipt_date, :submission_date,
                :is_electronic, :external_status, :approval_date, :approver_name
  
  # 菜单设置
  menu priority: 1, label: "报销单管理"
  
  # 过滤器
  filter :invoice_number
  filter :applicant
  filter :status, label: "内部状态", as: :select, collection: Reimbursement.state_machines[:status].states.map(&:value)
  filter :external_status, label: "外部状态"
  filter :receipt_status, as: :select, collection: ["pending", "received"]
  filter :is_electronic, as: :boolean
  filter :created_at
  filter :approval_date
  
  # 批量操作
  batch_action :mark_as_received do |ids|
    batch_action_collection.find(ids).each do |reimbursement|
      reimbursement.update(receipt_status: 'received', receipt_date: Time.current)
    end
    redirect_to collection_path, notice: "已将选中的报销单标记为已收单"
  end
  
  batch_action :start_processing, if: proc { params[:scope] == 'pending' || params[:q].blank? } do |ids|
    batch_action_collection.find(ids).each do |reimbursement|
      begin
        reimbursement.start_processing!
      rescue StateMachines::InvalidTransition => e
        Rails.logger.warn "Batch action start_processing failed for Reimbursement #{reimbursement.id}: #{e.message}"
      end
    end
    redirect_to collection_path, notice: "已尝试将选中的报销单标记为处理中"
  end
  
  # 操作按钮
  action_item :import, only: :index do
    link_to "导入报销单", new_import_admin_reimbursements_path
  end
  
  action_item :new_audit_work_order, only: :show, if: proc{!resource.closed?} do
    link_to "新建审核工单", new_admin_audit_work_order_path(reimbursement_id: resource.id)
  end
  
  action_item :new_communication_work_order, only: :show, if: proc{!resource.closed?} do
    link_to "新建沟通工单", new_admin_communication_work_order_path(reimbursement_id: resource.id)
  end
  
  # 导入操作
  collection_action :new_import, method: :get do
    render "admin/reimbursements/new_import"
  end
  
  collection_action :import, method: :post do
    unless params[:file].present?
      redirect_to new_import_admin_reimbursements_path, alert: "请选择要导入的文件。"
      return
    end
    
    service = ReimbursementImportService.new(params[:file], current_admin_user)
    result = service.import
    
    if result[:success]
      notice_message = "导入成功: #{result[:created]} 创建, #{result[:updated]} 更新."
      notice_message += " #{result[:errors]} 错误." if result[:errors].to_i > 0
      redirect_to admin_reimbursements_path, notice: notice_message
    else
      alert_message = "导入失败: #{result[:errors].join(', ')}"
      alert_message += " 错误详情: #{result[:error_details].join('; ')}" if result[:error_details].present?
      redirect_to new_import_admin_reimbursements_path, alert: alert_message
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :invoice_number
    column :applicant
    column :amount do |reimbursement| number_to_currency(reimbursement.amount, unit: "¥") end
    column "内部状态", :status do |reimbursement| status_tag reimbursement.status end
    column "外部状态", :external_status
    column :receipt_status do |reimbursement| status_tag reimbursement.receipt_status end
    column :is_electronic
    column :approval_date
    column :created_at
    actions
  end
  
  # 详情页
  show title: proc{|r| "报销单 ##{r.invoice_number}" } do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :id
          row :invoice_number
          row :document_name
          row :applicant
          row :applicant_id
          row :company
          row :department
          row :amount do |reimbursement| number_to_currency(reimbursement.amount, unit: "¥") end
          row "内部状态", :status do |reimbursement| status_tag reimbursement.status end
          row "外部状态", :external_status
          row :receipt_status do |reimbursement| status_tag reimbursement.receipt_status end
          row :receipt_date
          row :submission_date
          row :is_electronic
          row :approval_date
          row :approver_name
          row :created_at
          row :updated_at
        end
      end
      
      tab "快递收单工单" do
        panel "快递收单工单信息" do
          table_for resource.express_receipt_work_orders.order(created_at: :desc) do
            column(:id) { |wo| link_to wo.id, admin_express_receipt_work_order_path(wo) }
            column :tracking_number
            column :received_at
            column :courier_name
            column(:status) { |wo| status_tag wo.status }
            column :creator
            column :created_at
          end
        end
      end
      
      tab "审核工单" do
        panel "审核工单信息" do
          table_for resource.audit_work_orders.order(created_at: :desc) do
            column(:id) { |wo| link_to wo.id, admin_audit_work_order_path(wo) }
            column(:status) { |wo| status_tag wo.status }
            column(:audit_result) { |wo| status_tag wo.audit_result if wo.audit_result.present? }
            column :audit_date
            column :creator
            column :created_at
          end
        end
        
        div class: "action_items" do
          span class: "action_item" do
            link_to "新建审核工单", new_admin_audit_work_order_path(reimbursement_id: resource.id), class: "button"
          end
        end
      end
      
      tab "沟通工单" do
        panel "沟通工单信息" do
          table_for resource.communication_work_orders.order(created_at: :desc) do
            column(:id) { |wo| link_to wo.id, admin_communication_work_order_path(wo) }
            column(:status) { |wo| status_tag wo.status }
            column :initiator_role
            column :creator
            column :created_at
          end
        end
        
        div class: "action_items" do
          span class: "action_item" do
            link_to "新建沟通工单", new_admin_communication_work_order_path(reimbursement_id: resource.id), class: "button"
          end
        end
      end
      
      tab "费用明细" do
        panel "费用明细信息" do
          table_for resource.fee_details.order(created_at: :desc) do
            column(:id) { |fd| link_to fd.id, admin_fee_detail_path(fd) }
            column :fee_type
            column :amount do |fd| number_to_currency(fd.amount, unit: "¥") end
            column :fee_date
            column :verification_status do |fd| status_tag fd.verification_status end
            column :payment_method
            column :created_at
          end
        end
      end
      
      tab "操作历史" do
        panel "操作历史记录" do
          table_for resource.operation_histories.order(operation_time: :desc) do
            column :id
            column :operation_type
            column :operator
            column :operation_time
            column :notes
          end
        end
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "报销单信息" do
      f.input :invoice_number, input_html: { readonly: !f.object.new_record? }
      f.input :document_name
      f.input :applicant
      f.input :applicant_id
      f.input :company
      f.input :department
      f.input :amount
      f.input :status, label: "内部状态", as: :select, collection: Reimbursement.state_machines[:status].states.map(&:value), include_blank: false
      f.input :external_status, label: "外部状态", input_html: { readonly: true }
      f.input :receipt_status, as: :select, collection: ["pending", "received"]
      f.input :receipt_date, as: :datepicker
      f.input :submission_date, as: :datepicker
      f.input :is_electronic
      f.input :approval_date, as: :datepicker
      f.input :approver_name
    end
    f.actions
  end
end
```
#### 2.2 审核工单资源

创建 `app/admin/audit_work_orders.rb` 文件：

```ruby
ActiveAdmin.register AuditWorkOrder do
  # 权限控制
  permit_params :reimbursement_id, :status, :audit_result, :audit_comment, :audit_date,
                :vat_verified, :created_by,
                :problem_type, :problem_description, :remark, :processing_opinion,
                fee_detail_ids: []
  
  # 菜单设置
  menu priority: 3, label: "审核工单", parent: "工单管理"
  config.sort_order = 'created_at_desc'
  
  # 控制器
  controller do
    def scoped_collection
      AuditWorkOrder.includes(:reimbursement, :creator)
    end
    
    def build_new_resource
      resource = super
      if params[:reimbursement_id] && resource.reimbursement_id.nil?
        resource.reimbursement_id = params[:reimbursement_id]
      end
      resource
    end
  end
  
  # 过滤器
  filter :reimbursement_invoice_number, as: :string, label: '报销单号'
  filter :status, as: :select, collection: AuditWorkOrder.state_machines[:status].states.map(&:value)
  filter :audit_result, as: :select, collection: ["approved", "rejected"]
  filter :creator
  filter :created_at
  
  # 批量操作
  batch_action :start_processing, if: proc { params[:scope] == 'pending' || params[:q].blank? } do |ids|
    batch_action_collection.find(ids).each do |work_order|
      begin
        AuditWorkOrderService.new(work_order, current_admin_user).start_processing
      rescue => e
        Rails.logger.warn "Batch action start_processing failed for AuditWorkOrder #{work_order.id}: #{e.message}"
      end
    end
    redirect_to collection_path, notice: "已尝试将选中的工单标记为处理中"
  end
  
  # 操作按钮
  action_item :start_processing, only: :show, if: proc { resource.pending? } do
    link_to "开始处理", start_processing_admin_audit_work_order_path(resource), method: :put, data: { confirm: "确定要开始处理此工单吗?" }
  end
  
  action_item :approve, only: :show, if: proc { resource.processing? } do
    link_to "审核通过", approve_admin_audit_work_order_path(resource)
  end
  
  action_item :reject, only: :show, if: proc { resource.processing? } do
    link_to "审核拒绝", reject_admin_audit_work_order_path(resource)
  end
  
  # 成员操作
  member_action :start_processing, method: :put do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    if service.start_processing
      redirect_to admin_audit_work_order_path(resource), notice: "工单已开始处理"
    else
      redirect_to admin_audit_work_order_path(resource), alert: "操作失败: #{resource.errors.full_messages.join(', ')}"
    end
  end
  
  member_action :approve, method: :get do
    @audit_work_order = resource
    render :approve
  end
  
  member_action :do_approve, method: :post do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    permitted_params = params.require(:audit_work_order).permit(:audit_comment, :problem_type, :problem_description, :remark, :processing_opinion)
    if service.approve(permitted_params)
      redirect_to admin_audit_work_order_path(resource), notice: "审核已通过"
    else
      @audit_work_order = resource
      flash.now[:alert] = "操作失败: #{resource.errors.full_messages.join(', ')}"
      render :approve
    end
  end
  
  member_action :reject, method: :get do
    @audit_work_order = resource
    render :reject
  end
  
  member_action :do_reject, method: :post do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    permitted_params = params.require(:audit_work_order).permit(:audit_comment, :problem_type, :problem_description, :remark, :processing_opinion)
    if service.reject(permitted_params)
      redirect_to admin_audit_work_order_path(resource), notice: "审核已拒绝"
    else
      @audit_work_order = resource
      flash.now[:alert] = "操作失败: #{resource.errors.full_messages.join(', ')}"
      render :reject
    end
  end
  
  # 费用明细验证操作
  member_action :verify_fee_detail, method: :get do
    @work_order = resource
    @fee_detail = resource.fee_details.find(params[:fee_detail_id])
    render 'admin/shared/verify_fee_detail'
  end
  
  member_action :do_verify_fee_detail, method: :post do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    if service.update_fee_detail_verification(params[:fee_detail_id], params[:verification_status], params[:comment])
      redirect_to admin_audit_work_order_path(resource), notice: "费用明细 ##{params[:fee_detail_id]} 状态已更新"
    else
      @work_order = resource
      @fee_detail = resource.fee_details.find(params[:fee_detail_id])
      flash.now[:alert] = "费用明细 ##{params[:fee_detail_id]} 更新失败: #{@fee_detail.errors.full_messages.join(', ')}"
      render 'admin/shared/verify_fee_detail'
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
    column :status do |wo| status_tag wo.status end
    column :audit_result do |wo| status_tag wo.audit_result if wo.audit_result.present? end
    column :creator
    column :created_at
    actions
  end
  
  # 详情页
  show title: proc{|wo| "审核工单 ##{wo.id}" } do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :id
          row :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
          row :type
          row :status do |wo| status_tag wo.status end
          row :audit_result do |wo| status_tag wo.audit_result if wo.audit_result.present? end
          row :audit_comment
          row :audit_date
          row :vat_verified
          row :problem_type
          row :problem_description
          row :remark
          row :processing_opinion
          row :creator
          row :created_at
          row :updated_at
        end
      end
      
      tab "费用明细 (#{resource.fee_details.count})" do
        panel "费用明细信息" do
          table_for resource.fee_detail_selections.includes(:fee_detail) do |selection|
            column "费用明细ID", :fee_detail_id do |sel| link_to sel.fee_detail_id, admin_fee_detail_path(sel.fee_detail) end
            column "费用类型", :fee_type do |sel| sel.fee_detail.fee_type end
            column "金额", :amount do |sel| number_to_currency(sel.fee_detail.amount, unit: "¥") end
            column "全局状态", :global_status do |sel| status_tag sel.fee_detail.verification_status end
            column "工单内状态", :verification_status do |sel| status_tag sel.verification_status end
            column "验证意见", :verification_comment
            column "操作" do |sel|
              link_to("更新验证状态", verify_fee_detail_admin_audit_work_order_path(resource, fee_detail_id: sel.fee_detail_id))
            end
          end
        end
      end
      
      tab "沟通工单 (#{resource.communication_work_orders.count})" do
        panel "关联沟通工单" do
          table_for resource.communication_work_orders do
            column(:id) { |comm_wo| link_to comm_wo.id, admin_communication_work_order_path(comm_wo) }
            column(:status) { |comm_wo| status_tag comm_wo.status }
            column :creator
            column :created_at
          end
        end
      end
      
      tab "状态变更历史" do
        panel "状态变更历史" do
          table_for resource.work_order_status_changes.order(changed_at: :desc) do
            column :from_status
            column :to_status
            column :changed_at
            column :changer do |change| change.changer&.email end
          end
        end
      end
    end
  end
  
  # 表单
  form partial: 'form'
end
```

创建 `app/views/admin/audit_work_orders/_form.html.erb` 文件：

```erb
<%= semantic_form_for [:admin, @audit_work_order], html: { class: 'work_order_form' } do |f| %>
  <%= f.inputs "基本信息" do %>
    <% if f.object.new_record? && params[:reimbursement_id] %>
      <%= f.input :reimbursement_id, as: :hidden, input_html: { value: params[:reimbursement_id] } %>
      <li class="string input optional">
          <label class="label">报销单</label>
          <%= link_to f.object.reimbursement&.invoice_number, admin_reimbursement_path(f.object.reimbursement) %>
      </li>
    <% else %>
      <%= f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }, input_html: { disabled: !f.object.new_record? } %>
    <% end %>
    <%= f.input :status, as: :select, collection: AuditWorkOrder.state_machines[:status].states.map(&:value), include_blank: false %>
    <%= f.input :problem_type, as: :select, collection: ProblemType.audit_problem_types, include_blank: '无' %>
    <%= f.input :problem_description, as: :select, collection: ProblemDescription.audit_problem_descriptions, include_blank: '无' %>
    <%= f.input :remark, as: :text, input_html: { rows: 3 } %>
    <%= f.input :processing_opinion, as: :select, collection: ProcessingOpinion.audit_processing_opinions, include_blank: '无' %>
    <%= f.input :audit_comment, as: :text, input_html: { rows: 3 } %>
    <%= f.input :vat_verified %>
  <% end %>
  
  <%= f.inputs "选择费用明细" do %>
    <div class="select-all-container">
      <label>
        <input type="checkbox" id="select-all-fee-details"> 全选/取消全选
      </label>
    </div>
    
    <%= f.input :fee_detail_ids, as: :check_boxes, 
                collection: f.object.reimbursement&.fee_details&.map { |fd| 
                  ["##{fd.id} #{fd.fee_type} (#{number_to_currency(fd.amount)}) - #{fd.verification_status}", fd.id] 
                } || [], 
                label: false,
                input_html: { class: 'fee-detail-checkbox' } %>
  <% end %>
  
  <%= f.actions %>
<% end %>
```

创建 `app/views/admin/audit_work_orders/approve.html.erb` 文件：

```erb
<% @page_title = "审核通过 - 审核工单 ##{@audit_work_order.id}" %>

<%= semantic_form_for [:admin, @audit_work_order], url: do_approve_admin_audit_work_order_path(@audit_work_order), method: :post do |f| %>
  <%= f.inputs "审核通过意见" do %>
    <li class="string input optional">
      <label class="label">报销单</label>
      <%= link_to @audit_work_order.reimbursement.invoice_number, admin_reimbursement_path(@audit_work_order.reimbursement) %>
    </li>
    
    <li class="string input optional">
      <label class="label">当前状态</label>
      <%= status_tag @audit_work_order.status %>
    </li>
    
    <%= f.input :problem_type, as: :select, collection: ProblemType.audit_problem_types, include_blank: '无' %>
    <%= f.input :problem_description, as: :select, collection: ProblemDescription.audit_problem_descriptions, include_blank: '无' %>
    <%= f.input :remark, as: :text, input_html: { rows: 3 } %>
    <%= f.input :processing_opinion, as: :select, collection: ProcessingOpinion.audit_processing_opinions, include_blank: '无' %>
    <%= f.input :audit_comment, as: :text, label: "审核意见", input_html: { rows: 5 } %>
  <% end %>
  
  <%= f.actions do %>
    <%= f.action :submit, label: "确认通过" %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_audit_work_order_path(@audit_work_order) } %>
  <% end %>
<% end %>
```

创建 `app/views/admin/audit_work_orders/reject.html.erb` 文件：

```erb
<% @page_title = "审核拒绝 - 审核工单 ##{@audit_work_order.id}" %>

<%= semantic_form_for [:admin, @audit_work_order], url: do_reject_admin_audit_work_order_path(@audit_work_order), method: :post do |f| %>
  <%= f.inputs "审核拒绝意见" do %>
    <li class="string input optional">
      <label class="label">报销单</label>
      <%= link_to @audit_work_order.reimbursement.invoice_number, admin_reimbursement_path(@audit_work_order.reimbursement) %>
    </li>
    
    <li class="string input optional">
      <label class="label">当前状态</label>
      <%= status_tag @audit_work_order.status %>
    </li>
    
    <%= f.input :problem_type, as: :select, collection: ProblemType.audit_problem_types, include_blank: '无' %>
    <%= f.input :problem_description, as: :select, collection: ProblemDescription.audit_problem_descriptions, include_blank: '无' %>
    <%= f.input :remark, as: :text, input_html: { rows: 3 } %>
    <%= f.input :processing_opinion, as: :select, collection: ProcessingOpinion.audit_processing_opinions, include_blank: '无' %>
    <%= f.input :audit_comment, as: :text, label: "拒绝原因", input_html: { rows: 5, required: true } %>
  <% end %>
  
  <%= f.actions do %>
    <%= f.action :submit, label: "确认拒绝" %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_audit_work_order_path(@audit_work_order) } %>
  <% end %>
<% end %>
```
#### 2.3 沟通工单资源

创建 `app/admin/communication_work_orders.rb` 文件：

```ruby
ActiveAdmin.register CommunicationWorkOrder do
  # 权限控制
  permit_params :reimbursement_id, :audit_work_order_id, :status, :communication_method,
                :initiator_role, :resolution_summary, :created_by,
                :problem_type, :problem_description, :remark, :processing_opinion,
                fee_detail_ids: []
  
  # 菜单设置
  menu priority: 4, label: "沟通工单", parent: "工单管理"
  config.sort_order = 'created_at_desc'
  
  # 控制器
  controller do
    def scoped_collection
      CommunicationWorkOrder.includes(:reimbursement, :creator, :audit_work_order)
    end
    
    def build_new_resource
      resource = super
      if params[:reimbursement_id] && resource.reimbursement_id.nil?
        resource.reimbursement_id = params[:reimbursement_id]
      end
      if params[:audit_work_order_id] && resource.audit_work_order_id.nil?
        resource.audit_work_order_id = params[:audit_work_order_id]
      end
      resource
    end
  end
  
  # 过滤器
  filter :reimbursement_invoice_number, as: :string, label: '报销单号'
  filter :audit_work_order_id
  filter :status, as: :select, collection: CommunicationWorkOrder.state_machines[:status].states.map(&:value)
  filter :communication_method
  filter :initiator_role
  filter :creator
  filter :created_at
  
  # 操作按钮
  action_item :start_processing, only: :show, if: proc { resource.pending? } do
    link_to "开始处理", start_processing_admin_communication_work_order_path(resource), method: :put, data: { confirm: "确定要开始处理此工单吗?" }
  end
  
  action_item :mark_needs_communication, only: :show, if: proc { resource.pending? } do
    link_to "标记需沟通", mark_needs_communication_admin_communication_work_order_path(resource), method: :put, data: { confirm: "确定要标记为需要沟通吗?" }
  end
  
  action_item :approve, only: :show, if: proc { resource.processing? || resource.needs_communication? } do
    link_to "沟通后通过", approve_admin_communication_work_order_path(resource)
  end
  
  action_item :reject, only: :show, if: proc { resource.processing? || resource.needs_communication? } do
    link_to "沟通后拒绝", reject_admin_communication_work_order_path(resource)
  end
  
  action_item :add_communication_record, only: :show do
    link_to "添加沟通记录", new_communication_record_admin_communication_work_order_path(resource)
  end
  
  # 成员操作
  member_action :start_processing, method: :put do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    if service.start_processing
      redirect_to admin_communication_work_order_path(resource), notice: "工单已开始处理"
    else
      redirect_to admin_communication_work_order_path(resource), alert: "操作失败: #{resource.errors.full_messages.join(', ')}"
    end
  end
  
  member_action :mark_needs_communication, method: :put do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    if service.mark_needs_communication
      redirect_to admin_communication_work_order_path(resource), notice: "工单已标记为需要沟通"
    else
      redirect_to admin_communication_work_order_path(resource), alert: "操作失败: #{resource.errors.full_messages.join(', ')}"
    end
  end
  
  member_action :approve, method: :get do
    @communication_work_order = resource
    render :approve
  end
  
  member_action :do_approve, method: :post do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    permitted_params = params.require(:communication_work_order).permit(:resolution_summary, :problem_type, :problem_description, :remark, :processing_opinion)
    if service.approve(permitted_params)
      redirect_to admin_communication_work_order_path(resource), notice: "工单已沟通通过"
    else
      @communication_work_order = resource
      flash.now[:alert] = "操作失败: #{resource.errors.full_messages.join(', ')}"
      render :approve
    end
  end
  
  member_action :reject, method: :get do
    @communication_work_order = resource
    render :reject
  end
  
  member_action :do_reject, method: :post do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    permitted_params = params.require(:communication_work_order).permit(:resolution_summary, :problem_type, :problem_description, :remark, :processing_opinion)
    if service.reject(permitted_params)
      redirect_to admin_communication_work_order_path(resource), notice: "工单已沟通拒绝"
    else
      @communication_work_order = resource
      flash.now[:alert] = "操作失败: #{resource.errors.full_messages.join(', ')}"
      render :reject
    end
  end
  
  # 沟通记录操作
  member_action :new_communication_record, method: :get do
    @communication_work_order = resource
    @communication_record = resource.communication_records.build
    render :new_communication_record
  end
  
  member_action :create_communication_record, method: :post do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    record = service.add_communication_record(params.require(:communication_record).permit(:content, :communicator_role, :communicator_name, :communication_method))
    if record.persisted?
      redirect_to admin_communication_work_order_path(resource), notice: "沟通记录已添加"
    else
      @communication_work_order = resource
      @communication_record = record
      flash.now[:alert] = "添加沟通记录失败: #{record.errors.full_messages.join(', ')}"
      render :new_communication_record
    end
  end
  
  # 费用明细验证操作
  member_action :verify_fee_detail, method: :get do
    @work_order = resource
    @fee_detail = resource.fee_details.find(params[:fee_detail_id])
    render 'admin/shared/verify_fee_detail'
  end
  
  member_action :do_verify_fee_detail, method: :post do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    if service.update_fee_detail_verification(params[:fee_detail_id], params[:verification_status], params[:comment])
      redirect_to admin_communication_work_order_path(resource), notice: "费用明细 ##{params[:fee_detail_id]} 状态已更新"
    else
      @work_order = resource
      @fee_detail = resource.fee_details.find(params[:fee_detail_id])
      flash.now[:alert] = "费用明细 ##{params[:fee_detail_id]} 更新失败: #{@fee_detail.errors.full_messages.join(', ')}"
      render 'admin/shared/verify_fee_detail'
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
    column :audit_work_order do |wo| link_to wo.audit_work_order_id, admin_audit_work_order_path(wo.audit_work_order) if wo.audit_work_order_id end
    column :status do |wo| status_tag wo.status end
    column :initiator_role
    column :creator
    column :created_at
    actions
  end
  
  # 详情页
  show title: proc{|wo| "沟通工单 ##{wo.id}" } do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :id
          row :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
          row :audit_work_order do |wo| link_to wo.audit_work_order_id, admin_audit_work_order_path(wo.audit_work_order) if wo.audit_work_order_id end
          row :type
          row :status do |wo| status_tag wo.status end
          row :communication_method
          row :initiator_role
          row :resolution_summary
          row :problem_type
          row :problem_description
          row :remark
          row :processing_opinion
          row :creator
          row :created_at
          row :updated_at
        end
      end
      
      tab "沟通记录 (#{resource.communication_records.count})" do
        panel "沟通记录" do
          table_for resource.communication_records.order(recorded_at: :desc) do
            column :id
            column :communicator_role
            column :communicator_name
            column :communication_method
            column :content
            column :recorded_at
          end
        end
        
        div class: "action_items" do
          span class: "action_item" do
            link_to "添加沟通记录", new_communication_record_admin_communication_work_order_path(resource), class: "button"
          end
        end
      end
      
      tab "费用明细 (#{resource.fee_details.count})" do
        panel "费用明细信息" do
          table_for resource.fee_detail_selections.includes(:fee_detail) do |selection|
            column "费用明细ID", :fee_detail_id do |sel| link_to sel.fee_detail_id, admin_fee_detail_path(sel.fee_detail) end
            column "费用类型", :fee_type do |sel| sel.fee_detail.fee_type end
            column "金额", :amount do |sel| number_to_currency(sel.fee_detail.amount, unit: "¥") end
            column "全局状态", :global_status do |sel| status_tag sel.fee_detail.verification_status end
            column "工单内状态", :verification_status do |sel| status_tag sel.verification_status end
            column "验证意见", :verification_comment
            column "操作" do |sel|
              link_to("更新验证状态", verify_fee_detail_admin_communication_work_order_path(resource, fee_detail_id: sel.fee_detail_id))
            end
          end
        end
      end
      
      tab "状态变更历史" do
        panel "状态变更历史" do
          table_for resource.work_order_status_changes.order(changed_at: :desc) do
            column :from_status
            column :to_status
            column :changed_at
            column :changer do |change| change.changer&.email end
          end
        end
      end
    end
  end
  
  # 表单
  form partial: 'form'
end
```

创建 `app/views/admin/communication_work_orders/_form.html.erb` 文件：

```erb
<%= semantic_form_for [:admin, @communication_work_order], html: { class: 'work_order_form' } do |f| %>
  <%= f.inputs "基本信息" do %>
    <% if f.object.new_record? && params[:reimbursement_id] %>
      <%= f.input :reimbursement_id, as: :hidden, input_html: { value: params[:reimbursement_id] } %>
      <li class="string input optional">
        <label class="label">报销单</label>
        <%= link_to f.object.reimbursement&.invoice_number, admin_reimbursement_path(f.object.reimbursement) %>
      </li>
    <% else %>
      <%= f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }, input_html: { disabled: !f.object.new_record? } %>
    <% end %>
    
    <% if f.object.new_record? && params[:audit_work_order_id] %>
      <%= f.input :audit_work_order_id, as: :hidden, input_html: { value: params[:audit_work_order_id] } %>
      <li class="string input optional">
        <label class="label">审核工单</label>
        <%= link_to "审核工单 ##{f.object.audit_work_order_id}", admin_audit_work_order_path(f.object.audit_work_order_id) %>
      </li>
    <% else %>
      <%= f.input :audit_work_order_id, as: :select, 
                  collection: AuditWorkOrder.where(reimbursement_id: f.object.reimbursement_id).map { |aw| ["审核工单 ##{aw.id} (#{aw.status})", aw.id] }, 
                  include_blank: false, 
                  required: true %>
    <% end %>
    
    <%= f.input :status, as: :select, collection: CommunicationWorkOrder.state_machines[:status].states.map(&:value), include_blank: false %>
    <%= f.input :communication_method, as: :select, collection: ["email", "phone", "system", "other"] %>
    <%= f.input :initiator_role, as: :select, collection: ["auditor", "applicant", "manager", "other"] %>
    <%= f.input :problem_type, as: :select, collection: ProblemType.communication_problem_types, include_blank: '无' %>
    <%= f.input :problem_description, as: :select, collection: ProblemDescription.communication_problem_descriptions, include_blank: '无' %>
    <%= f.input :remark, as: :text, input_html: { rows: 3 } %>
    <%= f.input :processing_opinion, as: :select, collection: ProcessingOpinion.communication_processing_opinions, include_blank: '无' %>
    <%= f.input :resolution_summary, as: :text, input_html: { rows: 3 } %>
  <% end %>
  
  <%= f.inputs "选择费用明细" do %>
    <div class="select-all-container">
      <label>
        <input type="checkbox" id="select-all-fee-details"> 全选/取消全选
      </label>
    </div>
    
    <%= f.input :fee_detail_ids, as: :check_boxes, 
                collection: f.object.reimbursement&.fee_details&.map { |fd| 
                  ["##{fd.id} #{fd.fee_type} (#{number_to_currency(fd.amount)}) - #{fd.verification_status}", fd.id] 
                } || [], 
                label: false,
                input_html: { class: 'fee-detail-checkbox' } %>
  <% end %>
  
  <%= f.actions %>
<% end %>
```

创建 `app/views/admin/communication_work_orders/approve.html.erb` 文件：

```erb
<% @page_title = "沟通后通过 - 沟通工单 ##{@communication_work_order.id}" %>

<%= semantic_form_for [:admin, @communication_work_order], url: do_approve_admin_communication_work_order_path(@communication_work_order), method: :post do |f| %>
  <%= f.inputs "沟通后通过" do %>
    <li class="string input optional">
      <label class="label">报销单</label>
      <%= link_to @communication_work_order.reimbursement.invoice_number, admin_reimbursement_path(@communication_work_order.reimbursement) %>
    </li>
    
    <li class="string input optional">
      <label class="label">审核工单</label>
      <%= link_to "审核工单 ##{@communication_work_order.audit_work_order_id}", admin_audit_work_order_path(@communication_work_order.audit_work_order) %>
    </li>
    
    <li class="string input optional">
      <label class="label">当前状态</label>
      <%= status_tag @communication_work_order.status %>
    </li>
    
    <%= f.input :problem_type, as: :select, collection: ProblemType.communication_problem_types, include_blank: '无' %>
    <%= f.input :problem_description, as: :select, collection: ProblemDescription.communication_problem_descriptions, include_blank: '无' %>
    <%= f.input :remark, as: :text, input_html: { rows: 3 } %>
    <%= f.input :processing_opinion, as: :select, collection: ProcessingOpinion.communication_processing_opinions, include_blank: '无' %>
    <%= f.input :resolution_summary, as: :text, label: "解决方案摘要", input_html: { rows: 5 } %>
  <% end %>
  
  <%= f.actions do %>
    <%= f.action :submit, label: "确认通过" %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_communication_work_order_path(@communication_work_order) } %>
  <% end %>
<% end %>
```

创建 `app/views/admin/communication_work_orders/reject.html.erb` 文件：

```erb
<% @page_title = "沟通后拒绝 - 沟通工单 ##{@communication_work_order.id}" %>

<%= semantic_form_for [:admin, @communication_work_order], url: do_reject_admin_communication_work_order_path(@communication_work_order), method: :post do |f| %>
  <%= f.inputs "沟通后拒绝" do %>
    <li class="string input optional">
      <label class="label">报销单</label>
      <%= link_to @communication_work_order.reimbursement.invoice_number, admin_reimbursement_path(@communication_work_order.reimbursement) %>
    </li>
    
    <li class="string input optional">
      <label class="label">审核工单</label>
      <%= link_to "审核工单 ##{@communication_work_order.audit_work_order_id}", admin_audit_work_order_path(@communication_work_order.audit_work_order) %>
    </li>
    
    <li class="string input optional">
      <label class="label">当前状态</label>
      <%= status_tag @communication_work_order.status %>
    </li>
    
    <%= f.input :problem_type, as: :select, collection: ProblemType.communication_problem_types, include_blank: '无' %>
    <%= f.input :problem_description, as: :select, collection: ProblemDescription.communication_problem_descriptions, include_blank: '无' %>
    <%= f.input :remark, as: :text, input_html: { rows: 3 } %>
    <%= f.input :processing_opinion, as: :select, collection: ProcessingOpinion.communication_processing_opinions, include_blank: '无' %>
    <%= f.input :resolution_summary, as: :text, label: "拒绝原因", input_html: { rows: 5, required: true } %>
  <% end %>
  
  <%= f.actions do %>
    <%= f.action :submit, label: "确认拒绝" %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_communication_work_order_path(@communication_work_order) } %>
  <% end %>
<% end %>
```

创建 `app/views/admin/communication_work_orders/new_communication_record.html.erb` 文件：

```erb
<% @page_title = "添加沟通记录 - 沟通工单 ##{@communication_work_order.id}" %>

<%= semantic_form_for [:admin, @communication_work_order, @communication_record || CommunicationRecord.new], url: create_communication_record_admin_communication_work_order_path(@communication_work_order), method: :post do |f| %>
  <%= f.inputs "沟通记录" do %>
    <%= f.input :content, as: :text, label: "沟通内容", input_html: { rows: 5, required: true } %>
    <%= f.input :communicator_role, as: :select, collection: [["审核人", "auditor"], ["申请人", "applicant"], ["管理员", "admin"], ["其他", "other"]], label: "沟通角色", required: true %>
    <%= f.input :communicator_name, as: :string, label: "沟通人姓名", input_html: { value: current_admin_user.email } %>
    <%= f.input :communication_method, as: :select, collection: [["系统", "system"], ["邮件", "email"], ["电话", "phone"], ["其他", "other"]], label: "沟通方式", required: true %>
  <% end %>
  
  <%= f.actions do %>
    <%= f.action :submit, label: "添加记录" %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_communication_work_order_path(@communication_work_order) } %>
  <% end %>
<% end %>
```

#### 2.4 共享视图

创建 `app/views/admin/shared/verify_fee_detail.html.erb` 文件：

```erb
<% work_order_type = @work_order.class.name.underscore %>
<% provide :title, "验证费用明细 ##{@fee_detail.id} - #{work_order_type.titleize} ##{@work_order.id}" %>

<h2>验证费用明细 #<%= @fee_detail.id %> - <%= work_order_type.titleize %> #<%= @work_order.id %></h2>

<%= semantic_form_for [:admin, @work_order], url: polymorphic_path([:do_verify_fee_detail, :admin, @work_order]), method: :post do |f| %>
  <%= hidden_field_tag :fee_detail_id, @fee_detail.id %>
  
  <%= f.inputs do %>
    <li class="string input optional">
      <label class="label">费用类型</label>
      <%= @fee_detail.fee_type %>
    </li>
    
    <li class="string input optional">
      <label class="label">金额</label>
      <%= number_to_currency(@fee_detail.amount, unit: "¥") %>
    </li>
    
    <li class="string input optional">
      <label class="label">费用日期</label>
      <%= @fee_detail.fee_date %>
    </li>
    
    <li class="string input optional">
      <label class="label">当前全局状态</label>
      <%= status_tag @fee_detail.verification_status %>
    </li>
    
    <% selection = @work_order.fee_detail_selections.find_by(fee_detail_id: @fee_detail.id) %>
    <li class="string input optional">
      <label class="label">当前工单内状态</label>
      <%= status_tag selection&.verification_status %>
    </li>
    
    <%= label_tag :verification_status, "设置验证状态 *" %>
    <%= select_tag :verification_status, options_for_select(FeeDetail::VERIFICATION_STATUSES.map { |s| [s.titleize, s] }, selection&.verification_status), required: true %>
    
    <%= label_tag :comment, "验证意见" %>
    <%= text_area_tag :comment, selection&.verification_comment, rows: 3 %>
  <% end %>
  
  <%= f.actions do %>
    <%= f.action :submit, label: "提交", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: polymorphic_path([:admin, @work_order]) } %>
  <% end %>
<% end %>
```
#### 2.5 快递收单工单资源

创建 `app/admin/express_receipt_work_orders.rb` 文件：

```ruby
ActiveAdmin.register ExpressReceiptWorkOrder do
  # 权限控制
  permit_params :reimbursement_id, :tracking_number, :received_at, :courier_name, :created_by
  
  # 菜单设置
  menu priority: 2, label: "快递收单工单", parent: "工单管理"
  
  # 控制器
  controller do
    def scoped_collection
      ExpressReceiptWorkOrder.includes(:reimbursement, :creator)
    end
  end
  
  # 过滤器
  filter :reimbursement_invoice_number, as: :string, label: '报销单号'
  filter :tracking_number
  filter :received_at
  filter :courier_name
  filter :creator
  filter :created_at
  
  # 导入操作
  action_item :import, only: :index do
    link_to "导入快递收单", new_import_admin_express_receipt_work_orders_path
  end
  
  collection_action :new_import, method: :get do
    render "admin/express_receipt_work_orders/new_import"
  end
  
  collection_action :import, method: :post do
    unless params[:file].present?
      redirect_to new_import_admin_express_receipt_work_orders_path, alert: "请选择要导入的文件。"
      return
    end
    
    service = ExpressReceiptImportService.new(params[:file], current_admin_user)
    result = service.import
    
    if result[:success]
      notice_message = "导入成功: #{result[:created]} 创建, #{result[:skipped]} 跳过."
      if result[:unmatched] > 0
        notice_message += " #{result[:unmatched]} 未匹配."
      end
      notice_message += " #{result[:errors]} 错误." if result[:errors].to_i > 0
      redirect_to admin_express_receipt_work_orders_path, notice: notice_message
    else
      alert_message = "导入失败: #{result[:errors].join(', ')}"
      redirect_to new_import_admin_express_receipt_work_orders_path, alert: alert_message
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
    column :tracking_number
    column :status do |wo| status_tag wo.status end
    column :received_at
    column :courier_name
    column :creator
    column :created_at
    actions
  end
  
  # 详情页
  show title: proc{|wo| "快递收单工单 ##{wo.id}" } do
    attributes_table do
      row :id
      row :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
      row :type
      row :status do |wo| status_tag wo.status end
      row :tracking_number
      row :received_at
      row :courier_name
      row :creator
      row :created_at
      row :updated_at
    end
    
    panel "状态变更历史" do
      table_for resource.work_order_status_changes.order(changed_at: :desc) do
        column :from_status
        column :to_status
        column :changed_at
        column :changer do |change| change.changer&.email end
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "快递收单工单信息" do
      f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }, input_html: { disabled: !f.object.new_record? }
      f.input :tracking_number
      f.input :received_at, as: :datepicker
      f.input :courier_name
    end
    f.actions
  end
end
```

创建 `app/views/admin/express_receipt_work_orders/new_import.html.erb` 文件：

```erb
<% @page_title = "导入快递收单" %>

<div class="import-form">
  <div class="import-instructions">
    <h3>导入说明</h3>
    <p>请选择要导入的快递收单CSV或Excel文件。文件应包含以下列：</p>
    <ul>
      <li><strong>单号</strong>：对应报销单号</li>
      <li><strong>操作意见</strong>：包含快递单号信息，格式如"快递单号：SF123456789"</li>
      <li><strong>操作时间</strong>：快递收单时间</li>
    </ul>
    <p>导入过程中将自动创建快递收单工单，状态为已完成（completed）。</p>
    <p>如果报销单不存在，对应的快递收单将被跳过。</p>
    <p>如果快递单号已存在，对应的记录将被跳过。</p>
  </div>
  
  <%= semantic_form_for :import, url: import_admin_express_receipt_work_orders_path, html: { multipart: true } do |f| %>
    <%= f.inputs "导入文件" do %>
      <%= f.input :file, as: :file, label: "选择文件", hint: "支持CSV和Excel格式", required: true %>
    <% end %>
    
    <%= f.actions do %>
      <%= f.action :submit, label: "导入" %>
      <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_express_receipt_work_orders_path } %>
    <% end %>
  <% end %>
</div>
```

#### 2.6 费用明细资源

创建 `app/admin/fee_details.rb` 文件：

```ruby
ActiveAdmin.register FeeDetail do
  # 权限控制
  permit_params :document_number, :fee_type, :amount, :currency, :fee_date, :payment_method, :verification_status
  
  # 菜单设置
  menu priority: 5, label: "费用明细", parent: "基础数据"
  config.sort_order = 'created_at_desc'
  
  # 控制器
  controller do
    def scoped_collection
      FeeDetail.includes(:reimbursement)
    end
  end
  
  # 过滤器
  filter :document_number_cont, label: "报销单号"
  filter :fee_type
  filter :verification_status, as: :select, collection: FeeDetail::VERIFICATION_STATUSES
  filter :fee_date
  filter :payment_method
  filter :created_at
  
  # 导入操作
  action_item :import, only: :index do
    link_to "导入费用明细", new_import_admin_fee_details_path
  end
  
  collection_action :new_import, method: :get do
    render "admin/fee_details/new_import"
  end
  
  collection_action :import, method: :post do
    unless params[:file].present?
      redirect_to new_import_admin_fee_details_path, alert: "请选择要导入的文件。"
      return
    end
    
    service = FeeDetailImportService.new(params[:file], current_admin_user)
    result = service.import
    
    if result[:success]
      notice_message = "导入成功: #{result[:imported]} 导入, #{result[:skipped]} 跳过."
      if result[:unmatched] > 0
        notice_message += " #{result[:unmatched]} 未匹配."
      end
      notice_message += " #{result[:errors]} 错误." if result[:errors].to_i > 0
      redirect_to admin_fee_details_path, notice: notice_message
    else
      alert_message = "导入失败: #{result[:errors].join(', ')}"
      redirect_to new_import_admin_fee_details_path, alert: alert_message
    end
  end
  
  # 批量操作
  batch_action :mark_as_verified, if: proc { params[:scope] == 'pending' || params[:q].blank? } do |ids|
    batch_action_collection.find(ids).each do |fee_detail|
      begin
        verification_service = FeeDetailVerificationService.new(current_admin_user)
        verification_service.update_verification_status(fee_detail, FeeDetail::VERIFICATION_STATUS_VERIFIED, "批量验证")
      rescue => e
        Rails.logger.warn "Batch action mark_as_verified failed for FeeDetail #{fee_detail.id}: #{e.message}"
      end
    end
    redirect_to collection_path, notice: "已尝试将选中的费用明细标记为已验证"
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :document_number do |fd|
      link_to fd.document_number, admin_reimbursement_path(fd.reimbursement) if fd.reimbursement
    end
    column :fee_type
    column :amount do |fd| number_to_currency(fd.amount, unit: fd.currency || "¥") end
    column :fee_date
    column :verification_status do |fd| status_tag fd.verification_status end
    column :payment_method
    column :created_at
    actions
  end
  
  # 详情页
  show title: proc{|fd| "费用明细 ##{fd.id}" } do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :id
          row :reimbursement do |fd| link_to fd.document_number, admin_reimbursement_path(fd.reimbursement) if fd.reimbursement end
          row :fee_type
          row :amount do |fd| number_to_currency(fd.amount, unit: fd.currency || "¥") end
          row :currency
          row :fee_date
          row :verification_status do |fd| status_tag fd.verification_status end
          row :payment_method
          row :created_at
          row :updated_at
        end
      end
      
      tab "关联工单" do
        panel "关联工单" do
          table_for resource.fee_detail_selections.includes(:work_order) do
            column "工单ID" do |sel|
              link_to sel.work_order_id, polymorphic_path([:admin, sel.work_order]) if sel.work_order
            end
            column "工单类型", :work_order_type
            column "工单状态" do |sel| status_tag sel.work_order.status if sel.work_order end
            column "验证状态 (工单内)", :verification_status do |sel| status_tag sel.verification_status end
            column "验证意见", :verification_comment
          end
        end
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "费用明细信息" do
      f.input :document_number, label: "报销单号"
      f.input :fee_type
      f.input :amount
      f.input :currency
      f.input :fee_date, as: :datepicker
      f.input :payment_method
      f.input :verification_status, as: :select, collection: FeeDetail::VERIFICATION_STATUSES, include_blank: false
    end
    f.actions
  end
end
```

创建 `app/views/admin/fee_details/new_import.html.erb` 文件：

```erb
<% @page_title = "导入费用明细" %>

<div class="import-form">
  <div class="import-instructions">
    <h3>导入说明</h3>
    <p>请选择要导入的费用明细CSV或Excel文件。文件应包含以下列：</p>
    <ul>
      <li><strong>报销单单号</strong>：对应报销单号</li>
      <li><strong>费用类型</strong>：费用类型</li>
      <li><strong>原始金额</strong>：费用金额</li>
      <li><strong>原始币种</strong>：币种（可选，默认为CNY）</li>
      <li><strong>费用发生日期</strong>：费用日期</li>
      <li><strong>弹性字段11</strong>：支付方式（可选）</li>
    </ul>
    <p>导入过程中将自动关联到报销单，初始验证状态为待验证（pending）。</p>
    <p>如果报销单不存在，对应的费用明细将被跳过。</p>
    <p>如果费用明细已存在（报销单号+费用类型+金额+费用日期相同），对应的记录将被跳过。</p>
  </div>
  
  <%= semantic_form_for :import, url: import_admin_fee_details_path, html: { multipart: true } do |f| %>
    <%= f.inputs "导入文件" do %>
      <%= f.input :file, as: :file, label: "选择文件", hint: "支持CSV和Excel格式", required: true %>
    <% end %>
    
    <%= f.actions do %>
      <%= f.action :submit, label: "导入" %>
      <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_fee_details_path } %>
    <% end %>
  <% end %>
</div>
```

#### 2.7 操作历史资源

创建 `app/admin/operation_histories.rb` 文件：

```ruby
ActiveAdmin.register OperationHistory do
  # 权限控制
  permit_params :document_number, :operation_type, :operation_time, :operator, :notes
  
  # 菜单设置
  menu priority: 6, label: "操作历史", parent: "基础数据"
  config.sort_order = 'operation_time_desc'
  
  # 控制器
  controller do
    def scoped_collection
      OperationHistory.includes(:reimbursement)
    end
  end
  
  # 过滤器
  filter :document_number_cont, label: "报销单号"
  filter :operation_type
  filter :operator
  filter :operation_time
  filter :notes
  filter :created_at
  
  # 导入操作
  action_item :import, only: :index do
    link_to "导入操作历史", new_import_admin_operation_histories_path
  end
  
  collection_action :new_import, method: :get do
    render "admin/operation_histories/new_import"
  end
  
  collection_action :import, method: :post do
    unless params[:file].present?
      redirect_to new_import_admin_operation_histories_path, alert: "请选择要导入的文件。"
      return
    end
    
    service = OperationHistoryImportService.new(params[:file], current_admin_user)
    result = service.import
    
    if result[:success]
      notice_message = "导入成功: #{result[:imported]} 导入, #{result[:skipped]} 跳过."
      if result[:updated_reimbursements] > 0
        notice_message += " #{result[:updated_reimbursements]} 报销单状态已更新."
      end
      if result[:unmatched] > 0
        notice_message += " #{result[:unmatched]} 未匹配."
      end
      notice_message += " #{result[:errors]} 错误." if result[:errors].to_i > 0
      redirect_to admin_operation_histories_path, notice: notice_message
    else
      alert_message = "导入失败: #{result[:errors].join(', ')}"
      redirect_to new_import_admin_operation_histories_path, alert: alert_message
    end
  end
  
  # 列表页
  index do
    id_column
    column :document_number do |h|
      link_to h.document_number, admin_reimbursement_path(h.reimbursement) if h.reimbursement
    end
    column :operation_type
    column :operator
    column :operation_time
    column :notes
    actions
  end
  
  # 详情页
  show title: proc{|h| "操作历史 ##{h.id}" } do
    attributes_table do
      row :id
      row :reimbursement do |h| link_to h.document_number, admin_reimbursement_path(h.reimbursement) if h.reimbursement end
      row :operation_type
      row :operator
      row :operation_time
      row :notes
      row :created_at
      row :updated_at
    end
  end
  
  # 表单
  form do |f|
    f.inputs "操作历史信息" do
      f.input :document_number, label: "报销单号"
      f.input :operation_type
      f.input :operator
      f.input :operation_time, as: :datepicker
      f.input :notes, as: :text
    end
    f.actions
  end
end
```

创建 `app/views/admin/operation_histories/new_import.html.erb` 文件：

```erb
<% @page_title = "导入操作历史" %>

<div class="import-form">
  <div class="import-instructions">
    <h3>导入说明</h3>
    <p>请选择要导入的操作历史CSV或Excel文件。文件应包含以下列：</p>
    <ul>
      <li><strong>单据编号</strong>：对应报销单号</li>
      <li><strong>操作类型</strong>：操作类型</li>
      <li><strong>操作日期</strong>：操作时间</li>
      <li><strong>操作人</strong>：操作人</li>
      <li><strong>操作意见</strong>：操作意见（可选）</li>
    </ul>
    <p>导入过程中将自动关联到报销单。</p>
    <p>如果报销单不存在，对应的操作历史将被跳过。</p>
    <p>如果操作历史已存在（报销单号+操作类型+操作时间+操作人相同），对应的记录将被跳过。</p>
    <p>如果操作类型为"审批"且操作意见为"审批通过"，对应的报销单状态将自动更新为已关闭（closed）。</p>
  </div>
  
  <%= semantic_form_for :import, url: import_admin_operation_histories_path, html: { multipart: true } do |f| %>
    <%= f.inputs "导入文件" do %>
      <%= f.input :file, as: :file, label: "选择文件", hint: "支持CSV和Excel格式", required: true %>
    <% end %>
    
    <%= f.actions do %>
      <%= f.action :submit, label: "导入" %>
      <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_operation_histories_path } %>
    <% end %>
  <% end %>
</div>
```

### 3. 下拉列表选项配置

创建 `app/models/problem_type.rb` 文件：

```ruby
# 问题类型配置
class ProblemType
  def self.audit_problem_types
    [
      ["发票信息不完整", "incomplete_invoice"],
      ["发票金额错误", "wrong_amount"],
      ["发票日期错误", "wrong_date"],
      ["发票抬头错误", "wrong_title"],
      ["发票类型错误", "wrong_type"],
      ["缺少发票", "missing_invoice"],
      ["其他问题", "other_issue"]
    ]
  end
  
  def self.communication_problem_types
    [
      ["发票信息不完整", "incomplete_invoice"],
      ["发票金额错误", "wrong_amount"],
      ["发票日期错误", "wrong_date"],
      ["发票抬头错误", "wrong_title"],
      ["发票类型错误", "wrong_type"],
      ["缺少发票", "missing_invoice"],
      ["需要补充材料", "need_additional_materials"],
      ["其他问题", "other_issue"]
    ]
  end
end
```

创建 `app/models/problem_description.rb` 文件：

```ruby
# 问题说明配置
class ProblemDescription
  def self.audit_problem_descriptions
    [
      ["发票缺少税号", "missing_tax_number"],
      ["发票缺少日期", "missing_date"],
      ["发票缺少金额", "missing_amount"],
      ["发票缺少抬头", "missing_title"],
      ["发票金额与申请不符", "amount_mismatch"],
      ["发票日期与申请不符", "date_mismatch"],
      ["发票抬头与公司不符", "title_mismatch"],
      ["发票类型不符合要求", "type_mismatch"],
      ["未提供原始发票", "no_original_invoice"],
      ["其他问题说明", "other_description"]
    ]
  end
  
  def self.communication_problem_descriptions
    [
      ["发票缺少税号", "missing_tax_number"],
      ["发票缺少日期", "missing_date"],
      ["发票缺少金额", "missing_amount"],
      ["发票缺少抬头", "missing_title"],
      ["发票金额与申请不符", "amount_mismatch"],
      ["发票日期与申请不符", "date_mismatch"],
      ["发票抬头与公司不符", "title_mismatch"],
      ["发票类型不符合要求", "type_mismatch"],
      ["未提供原始发票", "no_original_invoice"],
      ["需要提供补充说明", "need_explanation"],
      ["需要提供额外证明", "need_proof"],
      ["其他问题说明", "other_description"]
    ]
  end
end
```

创建 `app/models/processing_opinion.rb` 文件：

```ruby
# 处理意见配置
class ProcessingOpinion
  def self.audit_processing_opinions
    [
      ["需要补充发票", "need_invoice"],
      ["需要更正发票", "need_correction"],
      ["需要提供原始发票", "need_original"],
      ["需要提供补充材料", "need_materials"],
      ["不符合报销规定", "not_compliant"],
      ["金额超出限额", "exceed_limit"],
      ["其他处理意见", "other_opinion"]
    ]
  end
  
  def self.communication_processing_opinions
    [
      ["需要补充发票", "need_invoice"],
      ["需要更正发票", "need_correction"],
      ["需要提供原始发票", "need_original"],
      ["需要提供补充材料", "need_materials"],
      ["不符合报销规定", "not_compliant"],
      ["金额超出限额", "exceed_limit"],
      ["需要与申请人沟通", "need_communication"],
      ["需要与部门主管沟通", "need_manager_communication"],
      ["其他处理意见", "other_opinion"]
    ]
  end
end
```

### 4. 导入模板

创建 `app/views/admin/reimbursements/new_import.html.erb` 文件：

```erb
<% @page_title = "导入报销单" %>

<div class="import-form">
  <div class="import-instructions">
    <h3>导入说明</h3>
    <p>请选择要导入的报销单CSV或Excel文件。文件应包含以下列：</p>
    <ul>
      <li><strong>报销单单号</strong>：唯一标识符</li>
      <li><strong>单据名称</strong>：报销单名称</li>
      <li><strong>报销单申请人</strong>：申请人姓名</li>
      <li><strong>报销单申请人工号</strong>：申请人工号</li>
      <li><strong>申请人公司</strong>：公司名称</li>
      <li><strong>申请人部门</strong>：部门名称</li>
      <li><strong>报销金额（单据币种）</strong>：报销金额</li>
      <li><strong>收单状态</strong>：收单状态</li>
      <li><strong>收单日期</strong>：收单日期</li>
      <li><strong>提交报销日期</strong>：提交日期</li>
      <li><strong>报销单状态</strong>：外部状态</li>
      <li><strong>单据标签</strong>：用于判断是否为电子发票</li>
      <li><strong>报销单审核通过日期</strong>：审批日期</li>
      <li><strong>审核通过人</strong>：审批人</li>
    </ul>
    <p>导入过程中将自动设置内部状态为待处理（pending）。</p>
    <p>如果报销单已存在（报销单号相同），将更新现有记录。</p>
    <p>如果单据标签包含"全电子发票"，将自动标记为电子发票。</p>
  </div>
  
  <%= semantic_form_for :import, url: import_admin_reimbursements_path, html: { multipart: true } do |f| %>
    <%= f.inputs "导入文件" do %>
      <%= f.input :file, as: :file, label: "选择文件", hint: "支持CSV和Excel格式", required: true %>
    <% end %>
    
    <%= f.actions do %>
      <%= f.action :submit, label: "导入" %>
      <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_reimbursements_path } %>
    <% end %>
  <% end %>
</div>
```

## 实现注意事项

1. **状态机集成**：确保ActiveAdmin表单和控制器正确处理状态机事件，避免直接修改状态字段。

2. **多态关联**：处理`fee_detail_selections`和`work_order_status_changes`的多态关联时，确保正确设置`work_order_type`。

3. **表单验证**：确保表单验证逻辑（如至少选择一条费用明细）在客户端和服务器端都有实现。

4. **权限控制**：根据用户角色限制操作权限，例如只有特定用户组可以创建审核工单或沟通工单。

5. **性能优化**：使用`includes`预加载关联数据，避免N+1查询问题。

6. **错误处理**：提供清晰的错误消息，特别是在导入和状态转换操作中。

7. **用户体验**：使用状态标签、颜色编码和直观的操作按钮提升用户体验。

8. **响应式设计**：确保界面在不同设备上都能正常显示和操作。

## 测试验证

1. **功能测试**：测试各个资源的CRUD操作、导入功能和状态转换功能。

2. **集成测试**：测试完整的工作流程，如报销单导入、工单创建、状态流转和费用明细验证。

3. **用户界面测试**：测试表单验证、动态显示/隐藏字段、全选/取消全选功能等。

4. **性能测试**：测试大量数据导入和查询的性能。

## 总结

本实现计划提供了SCI2工单系统ActiveAdmin集成的详细指南，包括资源注册、自定义控制器、视图模板和样式设计。通过遵循这些指南，可以实现一个功能完整、用户友好的工单管理系统，满足业务需求和用户体验设计。