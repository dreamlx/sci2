# ActiveAdmin实现计划

## 概述

本文档提供了SCI2工单系统ActiveAdmin界面的详细实现计划，包括资源配置、自定义控制器、视图模板和JavaScript增强功能。实现计划基于单表继承(STI)模型，旨在提供直观、高效的用户界面。

## 实现目标

1. 配置ActiveAdmin基础设置和自定义样式
2. 实现各模型的ActiveAdmin资源
3. 创建自定义控制器和操作
4. 实现自定义视图模板
5. 添加JavaScript增强交互功能
6. 实现响应式布局
7. 集成数据可视化功能

## 实现步骤

### 1. ActiveAdmin基础配置

#### 1.1 安装和配置ActiveAdmin

ActiveAdmin已经在项目初始化阶段安装，但需要进行一些自定义配置。

```ruby
# config/initializers/active_admin.rb
ActiveAdmin.setup do |config|
  config.site_title = "SCI2工单系统"
  config.site_title_link = "/"
  config.footer = "SCI2工单系统 © #{Date.today.year}"
  config.default_namespace = :admin
  config.authentication_method = :authenticate_admin_user!
  config.current_user_method = :current_admin_user
  config.logout_link_path = :destroy_admin_user_session_path
  config.batch_actions = true
  config.localize = true
  config.default_per_page = 20
  config.comments = false
  config.download_links = [:csv, :json]
  config.namespace :admin do |admin|
    admin.build_menu do |menu|
      menu.add label: "仪表盘", url: "/admin/dashboard", priority: 1
      menu.add label: "报销单管理", priority: 2
      menu.add label: "工单管理", priority: 3
      menu.add label: "基础数据", priority: 4
      menu.add label: "系统管理", priority: 5
    end
  end
end
```

#### 1.2 自定义样式

创建自定义样式文件：

```scss
// app/assets/stylesheets/active_admin/custom.scss

// 覆盖默认变量
$primary-color: #2678e3;
$secondary-color: #6c757d;
$success-color: #28a745;
$warning-color: #fd7e14;
$error-color: #dc3545;
$info-color: #17a2b8;

// 导入Active Admin样式
@import "active_admin/mixins";
@import "active_admin/base";

// 自定义样式
.status_tag {
  &.pending { background-color: $secondary-color; }
  &.processing { background-color: $primary-color; }
  &.waiting_completion { background-color: $warning-color; }
  &.closed { background-color: $success-color; }
  &.approved { background-color: $success-color; }
  &.rejected { background-color: $error-color; }
  &.needs_communication { background-color: #6f42c1; }
  &.completed { background-color: $success-color; }
  &.problematic { background-color: $error-color; }
  &.verified { background-color: $success-color; }
}

// 仪表盘样式
.dashboard-stats {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 20px;
  
  .stat-card {
    flex: 1;
    min-width: 200px;
    background-color: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    text-align: center;
    
    h3 {
      margin: 0;
      font-size: 16px;
      color: #666;
      font-weight: normal;
    }
    
    h2 {
      margin: 10px 0;
      font-size: 32px;
      color: $primary-color;
    }
    
    p {
      margin: 0;
      font-size: 14px;
      color: #888;
    }
  }
}

// 面板页脚
.panel-footer {
  padding: 10px;
  text-align: center;
  background-color: #f9f9f9;
  border-top: 1px solid #eee;
  margin-top: 10px;
}

// 响应式调整
@media (max-width: 767px) {
  .dashboard-stats {
    flex-direction: column;
    
    .stat-card {
      width: 100%;
    }
  }
}
```

#### 1.3 添加Font Awesome图标

```ruby
# app/assets/javascripts/active_admin.js
//= require active_admin/base
//= require https://kit.fontawesome.com/a076d05399.js
```

#### 1.4 工单共享模型逻辑 (WorkOrder Base/Concern)

为了处理审核工单 (`AuditWorkOrder`) 和沟通工单 (`CommunicationWorkOrder`) 之间共享的业务逻辑和字段，建议在模型层面进行统一管理。这可以通过 `WorkOrder` 基类或一个可共享的 `Ruby Concern` (例如 `ProcessableWorkOrder`) 来实现。

**共享的属性和关联应包括:**

*   `reimbursement_id`: (Integer) 关联到报销单。
*   `status`: (String) 工单状态 (例如: pending, processing, closed)，及其状态机逻辑。
*   `problem_type`: (String) 问题类型。
*   `problem_description`: (String) 问题描述。
*   `remark`: (Text) 备注。
*   `processing_opinion`: (String) 处理意见。
*   `created_by`(或`creator_id`): (Integer) 创建人ID，关联到`AdminUser`。
*   `fee_detail_ids`: (Array) 关联的费用明细ID列表，用于表单提交。
*   与 `FeeDetail` 的多对多关联 (通常通过一个中间表如 `fee_detail_selections`)。

**共享的逻辑可能包括:**

*   通用的状态转换方法 (例如 `start_processing!`, `close!`)。
*   处理选定费用明细的逻辑。
*   通用的验证规则 (例如，`reimbursement_id` 必须存在)。
*   与 `WorkOrderStatusChange` 模型的关联，用于记录状态变更历史。

在 `app/models/work_order.rb` (如果作为基类) 或 `app/models/concerns/processable_work_order.rb` (如果作为Concern) 中定义这些共享元素，可以显著减少 `AuditWorkOrder` 和 `CommunicationWorkOrder` 模型中的代码重复，并使逻辑更集中。

### 2. 资源实现

#### 2.1 报销单资源

```ruby
# app/admin/reimbursements.rb
ActiveAdmin.register Reimbursement do
  menu priority: 2, label: "报销单管理", parent: "报销单管理"
  
  # 权限控制
  permit_params :invoice_number, :document_name, :applicant, :applicant_id, :company, :department,
                :amount, :receipt_status, :status, :receipt_date, :submission_date,
                :is_electronic, :external_status, :approval_date, :approver_name
  
  # 过滤器
  filter :invoice_number
  filter :applicant
  filter :status, label: "内部状态", as: :select, collection: Reimbursement.state_machines[:status].states.map(&:value)
  filter :external_status, label: "外部状态"
  filter :receipt_status, as: :select, collection: ["pending", "received"]
  filter :is_electronic, as: :boolean
  filter :created_at
  filter :approval_date
  
  # 批量操作
  batch_action :mark_as_received do |ids|
    batch_action_collection.find(ids).each do |reimbursement|
      reimbursement.update(receipt_status: 'received', receipt_date: Time.current)
    end
    redirect_to collection_path, notice: "已将选中的报销单标记为已收单"
  end
  
  batch_action :start_processing, if: proc { params[:scope] == 'pending' || params[:q].blank? } do |ids|
    batch_action_collection.find(ids).each do |reimbursement|
      begin
        reimbursement.start_processing!
      rescue StateMachines::InvalidTransition => e
        Rails.logger.warn "Batch action start_processing failed for Reimbursement #{reimbursement.id}: #{e.message}"
      end
    end
    redirect_to collection_path, notice: "已尝试将选中的报销单标记为处理中"
  end
  
  # 操作按钮
  action_item :import, only: :index do
    link_to "导入报销单", new_import_admin_reimbursements_path
  end
  
  action_item :new_audit_work_order, only: :show, if: proc{!resource.closed?} do
# 导入功能
  collection_action :new_import, method: :get do
    render "admin/reimbursements/new_import"
  end
  
  collection_action :import, method: :post do
    unless params[:file].present?
      redirect_to new_import_admin_reimbursements_path, alert: "请选择要导入的文件。"
      return
    end
    
    service = ReimbursementImportService.new(params[:file], current_admin_user)
    result = service.import
    
    if result[:success]
      notice_message = "导入成功: #{result[:created]} 创建, #{result[:updated]} 更新."
      notice_message += " #{result[:errors]} 错误." if result[:errors].to_i > 0
      redirect_to admin_reimbursements_path, notice: notice_message
    else
      alert_message = "导入失败: #{result[:errors].join(', ')}"
      alert_message += " 错误详情: #{result[:error_details].join('; ')}" if result[:error_details].present?
      redirect_to new_import_admin_reimbursements_path, alert: alert_message
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :invoice_number
    column :applicant
    column :amount do |reimbursement| number_to_currency(reimbursement.amount, unit: "¥") end
    column "内部状态", :status do |reimbursement| status_tag reimbursement.status end
    column "外部状态", :external_status
    column :receipt_status do |reimbursement| status_tag reimbursement.receipt_status end
    column :is_electronic
    column :approval_date
    column :created_at
    actions
  end
  
  # 详情页
  show title: proc{|r| "报销单 ##{r.invoice_number}" } do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :id
          row :invoice_number
          row :document_name
          row :applicant
          row :applicant_id
          row :company
          row :department
          row :amount do |reimbursement| number_to_currency(reimbursement.amount, unit: "¥") end
          row "内部状态", :status do |reimbursement| status_tag reimbursement.status end
          row "外部状态", :external_status
          row :receipt_status do |reimbursement| status_tag reimbursement.receipt_status end
          row :receipt_date
          row :submission_date
          row :is_electronic
          row :approval_date
          row :approver_name
          row :created_at
          row :updated_at
        end
      end
      
      tab "快递收单工单" do
        panel "快递收单工单信息" do
          table_for resource.express_receipt_work_orders.order(created_at: :desc) do
            column(:id) { |wo| link_to wo.id, admin_express_receipt_work_order_path(wo) }
            column :tracking_number
            column :received_at
            column :courier_name
            column(:status) { |wo| status_tag wo.status }
            column :creator
            column :created_at
          end
        end
      end
      
      tab "审核工单" do
        panel "审核工单信息" do
          table_for resource.audit_work_orders.order(created_at: :desc) do
            column(:id) { |wo| link_to wo.id, admin_audit_work_order_path(wo) }
            column(:status) { |wo| status_tag wo.status }
            column(:audit_result) { |wo| status_tag wo.audit_result if wo.audit_result.present? }
            column :audit_date
            column :creator
            column :created_at
          end
        end
        div class: "action_items" do
          span class: "action_item" do
            link_to "新建审核工单", new_admin_audit_work_order_path(reimbursement_id: resource.id), class: "button"
          end
        end
      end
      
      tab "沟通工单" do
        panel "沟通工单信息" do
          table_for resource.communication_work_orders.order(created_at: :desc) do
            column(:id) { |wo| link_to wo.id, admin_communication_work_order_path(wo) }
            column(:status) { |wo| status_tag wo.status }
            column :initiator_role
            column :creator
            column :created_at
          end
        end
        div class: "action_items" do
          span class: "action_item" do
            link_to "新建沟通工单", new_admin_communication_work_order_path(reimbursement_id: resource.id), class: "button"
          end
        end
      end
      
      tab "费用明细" do
        panel "费用明细信息" do
          table_for resource.fee_details.order(created_at: :desc) do
            column(:id) { |fd| link_to fd.id, admin_fee_detail_path(fd) }
            column :fee_type
            column :amount do |fd| number_to_currency(fd.amount, unit: "¥") end
            column :fee_date
            column :verification_status do |fd| status_tag fd.verification_status end
            column :payment_method
            column :created_at
          end
        end
      end
      
      tab "操作历史" do
        panel "操作历史记录" do
          table_for resource.operation_histories.order(operation_time: :desc) do
            column :id
            column :operation_type
            column :operator
            column :operation_time
            column :notes
          end
        end
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "报销单信息" do
      f.input :invoice_number, input_html: { readonly: !f.object.new_record? }
      f.input :document_name
      f.input :applicant
      f.input :applicant_id
      f.input :company
      f.input :department
      f.input :amount
      f.input :status, label: "内部状态", as: :select, collection: Reimbursement.state_machines[:status].states.map(&:value), include_blank: false
      f.input :external_status, label: "外部状态", input_html: { readonly: true }
      f.input :receipt_status, as: :select, collection: ["pending", "received"]
      f.input :receipt_date, as: :datepicker
      f.input :submission_date, as: :datepicker
      f.input :is_electronic
      f.input :approval_date, as: :datepicker
      f.input :approver_name
    end
    f.actions
  end
end
```

#### 2.2 审核工单资源

```ruby
# app/admin/audit_work_orders.rb
ActiveAdmin.register AuditWorkOrder do
  menu priority: 3, label: "审核工单", parent: "工单管理"
  config.sort_order = 'created_at_desc'
  
  # 权限控制
  permit_params :reimbursement_id, :status, :created_by, # 来自 WorkOrder 基类/Concern
                # Shared fields from Req 6/7 (也应在 WorkOrder 基类/Concern 中定义)
                :problem_type, :problem_description, :remark, :processing_opinion,
                fee_detail_ids: [], # 来自 WorkOrder 基类/Concern
                # AuditWorkOrder 特有字段
                :audit_result, :audit_comment, :audit_date, :vat_verified
  
  # 控制器
  controller do
    def scoped_collection
      AuditWorkOrder.includes(:reimbursement, :creator)
    end
    
    # Set reimbursement based on param when creating
    def build_new_resource
      resource = super
      if params[:reimbursement_id] && resource.reimbursement_id.nil?
        resource.reimbursement_id = params[:reimbursement_id]
      end
      resource
    end
  end
  
  # 过滤器
  filter :reimbursement_invoice_number, as: :string, label: '报销单号'
  filter :status, as: :select, collection: AuditWorkOrder.state_machines[:status].states.map(&:value)
  filter :audit_result, as: :select, collection: ["approved", "rejected"]
  filter :creator
  filter :created_at
  
  # 批量操作
  batch_action :start_processing, if: proc { params[:scope] == 'pending' || params[:q].blank? } do |ids|
    batch_action_collection.find(ids).each do |work_order|
      begin
        AuditWorkOrderService.new(work_order, current_admin_user).start_processing
      rescue => e
        Rails.logger.warn "Batch action start_processing failed for AuditWorkOrder #{work_order.id}: #{e.message}"
      end
    end
    redirect_to collection_path, notice: "已尝试将选中的工单标记为处理中"
  end
  
  # 操作按钮
  action_item :start_processing, only: :show, if: proc { resource.pending? } do
    link_to "开始处理", start_processing_admin_audit_work_order_path(resource), method: :put, data: { confirm: "确定要开始处理此工单吗?" }
  end
  
  action_item :approve, only: :show, if: proc { resource.processing? } do
    link_to "审核通过", approve_admin_audit_work_order_path(resource)
  end
  
  action_item :reject, only: :show, if: proc { resource.processing? } do
    link_to "审核拒绝", reject_admin_audit_work_order_path(resource)
  end
    link_to "新建审核工单", new_admin_audit_work_order_path(reimbursement_id: resource.id)
  end
  
  action_item :new_communication_work_order, only: :show, if: proc{!resource.closed?} do
    link_to "新建沟通工单", new_admin_communication_work_order_path(reimbursement_id: resource.id)
  end
# 自定义操作
  member_action :start_processing, method: :put do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    if service.start_processing
      redirect_to admin_audit_work_order_path(resource), notice: "工单已开始处理"
    else
      redirect_to admin_audit_work_order_path(resource), alert: "操作失败: #{resource.errors.full_messages.join(', ')}"
    end
  end
  
  member_action :approve, method: :get do
    @audit_work_order = resource
    render :approve
  end
  
  member_action :do_approve, method: :post do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    permitted_params = params.require(:audit_work_order).permit(:audit_comment, :problem_type, :problem_description, :remark, :processing_opinion)
    if service.approve(permitted_params)
      redirect_to admin_audit_work_order_path(resource), notice: "审核已通过"
    else
      @audit_work_order = resource
      flash.now[:alert] = "操作失败: #{resource.errors.full_messages.join(', ')}"
      render :approve
    end
  end
  
  member_action :reject, method: :get do
    @audit_work_order = resource
    render :reject
  end
  
  member_action :do_reject, method: :post do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    permitted_params = params.require(:audit_work_order).permit(:audit_comment, :problem_type, :problem_description, :remark, :processing_opinion)
    if service.reject(permitted_params)
      redirect_to admin_audit_work_order_path(resource), notice: "审核已拒绝"
    else
      @audit_work_order = resource
      flash.now[:alert] = "操作失败: #{resource.errors.full_messages.join(', ')}"
      render :reject
    end
  end
  
  # 费用明细验证操作
  member_action :verify_fee_detail, method: :get do
    @work_order = resource
    @fee_detail = resource.fee_details.find(params[:fee_detail_id])
    render 'admin/shared/verify_fee_detail'
  end
  
  member_action :do_verify_fee_detail, method: :post do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    if service.update_fee_detail_verification(params[:fee_detail_id], params[:verification_status], params[:comment])
      redirect_to admin_audit_work_order_path(resource), notice: "费用明细 ##{params[:fee_detail_id]} 状态已更新"
    else
      @work_order = resource
      @fee_detail = resource.fee_details.find(params[:fee_detail_id])
      flash.now[:alert] = "费用明细 ##{params[:fee_detail_id]} 更新失败: #{@fee_detail.errors.full_messages.join(', ')}"
      render 'admin/shared/verify_fee_detail'
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
    column :status do |wo| status_tag wo.status end
    column :audit_result do |wo| status_tag wo.audit_result if wo.audit_result.present? end
    column :creator
    column :created_at
    actions
  end
  
  # 详情页
  show title: proc{|wo| "审核工单 ##{wo.id}" } do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :id
          row :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
          row :type
          row :status do |wo| status_tag wo.status end
          row :audit_result do |wo| status_tag wo.audit_result if wo.audit_result.present? end
          row :audit_comment
          row :audit_date
          row :vat_verified
          # Show Shared Req 6/7 fields
          row :problem_type
          row :problem_description
          row :remark
          row :processing_opinion
          row :creator
          row :created_at
          row :updated_at
        end
      end
      
      tab "费用明细 (#{resource.fee_details.count})" do
        panel "费用明细信息" do
          table_for resource.fee_detail_selections.includes(:fee_detail) do |selection|
            column "费用明细ID", :fee_detail_id do |sel| link_to sel.fee_detail_id, admin_fee_detail_path(sel.fee_detail) end
            column "费用类型", :fee_type do |sel| sel.fee_detail.fee_type end
            column "金额", :amount do |sel| number_to_currency(sel.fee_detail.amount, unit: "¥") end
            column "全局状态", :global_status do |sel| status_tag sel.fee_detail.verification_status end
            column "工单内状态", :verification_status do |sel| status_tag sel.verification_status end
            column "验证意见", :verification_comment
            column "操作" do |sel|
              link_to("更新验证状态", verify_fee_detail_admin_audit_work_order_path(resource, fee_detail_id: sel.fee_detail_id))
            end
          end
        end
      end
      
      tab "沟通工单 (#{resource.communication_work_orders.count})" do
        panel "关联沟通工单" do
          table_for resource.communication_work_orders do
            column(:id) { |comm_wo| link_to comm_wo.id, admin_communication_work_order_path(comm_wo) }
            column(:status) { |comm_wo| status_tag comm_wo.status }
            column :creator
            column :created_at
          end
        end
      end
      
      tab "状态变更历史" do
        panel "状态变更历史" do
          table_for resource.work_order_status_changes.order(changed_at: :desc) do
            column :from_status
            column :to_status
            column :changed_at
            column :changer do |change| change.changer&.email end
          end
        end
      end
    end
  end
  
  # 表单
  form partial: 'form'
end
```

#### 2.3 沟通工单资源

```ruby
# app/admin/communication_work_orders.rb
ActiveAdmin.register CommunicationWorkOrder do
  menu priority: 4, label: "沟通工单", parent: "工单管理"
  config.sort_order = 'created_at_desc'
  
  # 权限控制
  permit_params :reimbursement_id, :status, :created_by, # 来自 WorkOrder 基类/Concern
                # Shared fields from Req 6/7 (也应在 WorkOrder 基类/Concern 中定义)
                :problem_type, :problem_description, :remark, :processing_opinion,
                fee_detail_ids: [], # 来自 WorkOrder 基类/Concern
                # CommunicationWorkOrder 特有字段
                :audit_work_order_id, :communication_method,
                :initiator_role, :resolution_summary
  
  # 控制器
  controller do
    def scoped_collection
      CommunicationWorkOrder.includes(:reimbursement, :creator, :audit_work_order)
    end
    
    # Set reimbursement/audit_work_order based on param when creating
    def build_new_resource
      resource = super
      if params[:reimbursement_id] && resource.reimbursement_id.nil?
        resource.reimbursement_id = params[:reimbursement_id]
      end
      if params[:audit_work_order_id] && resource.audit_work_order_id.nil?
        resource.audit_work_order_id = params[:audit_work_order_id]
      end
      resource
    end
  end
# 过滤器
  filter :reimbursement_invoice_number, as: :string, label: '报销单号'
  filter :audit_work_order_id
  filter :status, as: :select, collection: CommunicationWorkOrder.state_machines[:status].states.map(&:value)
  filter :communication_method
  filter :initiator_role
  filter :creator
  filter :created_at
  
  # 操作按钮
  action_item :start_processing, only: :show, if: proc { resource.pending? } do
    link_to "开始处理", start_processing_admin_communication_work_order_path(resource), method: :put, data: { confirm: "确定要开始处理此工单吗?" }
  end
  
  action_item :mark_needs_communication, only: :show, if: proc { resource.pending? } do
    link_to "标记需沟通", mark_needs_communication_admin_communication_work_order_path(resource), method: :put, data: { confirm: "确定要标记为需要沟通吗?" }
  end
  
  action_item :approve, only: :show, if: proc { resource.processing? || resource.needs_communication? } do
    link_to "沟通后通过", approve_admin_communication_work_order_path(resource)
  end
  
  action_item :reject, only: :show, if: proc { resource.processing? || resource.needs_communication? } do
    link_to "沟通后拒绝", reject_admin_communication_work_order_path(resource)
  end
  
  action_item :add_communication_record, only: :show do
    link_to "添加沟通记录", new_communication_record_admin_communication_work_order_path(resource)
  end
  
  # 自定义操作
  member_action :start_processing, method: :put do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    if service.start_processing
      redirect_to admin_communication_work_order_path(resource), notice: "工单已开始处理"
    else
      redirect_to admin_communication_work_order_path(resource), alert: "操作失败: #{resource.errors.full_messages.join(', ')}"
    end
  end
  
  member_action :mark_needs_communication, method: :put do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    if service.mark_needs_communication
      redirect_to admin_communication_work_order_path(resource), notice: "工单已标记为需要沟通"
    else
      redirect_to admin_communication_work_order_path(resource), alert: "操作失败: #{resource.errors.full_messages.join(', ')}"
    end
  end
  
  member_action :approve, method: :get do
    @communication_work_order = resource
    render :approve
  end
  
  member_action :do_approve, method: :post do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    permitted_params = params.require(:communication_work_order).permit(:resolution_summary, :problem_type, :problem_description, :remark, :processing_opinion)
    if service.approve(permitted_params)
      redirect_to admin_communication_work_order_path(resource), notice: "工单已沟通通过"
    else
      @communication_work_order = resource
      flash.now[:alert] = "操作失败: #{resource.errors.full_messages.join(', ')}"
      render :approve
    end
  end
  
  member_action :reject, method: :get do
    @communication_work_order = resource
    render :reject
  end
  
  member_action :do_reject, method: :post do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    permitted_params = params.require(:communication_work_order).permit(:resolution_summary, :problem_type, :problem_description, :remark, :processing_opinion)
    if service.reject(permitted_params)
      redirect_to admin_communication_work_order_path(resource), notice: "工单已沟通拒绝"
    else
      @communication_work_order = resource
      flash.now[:alert] = "操作失败: #{resource.errors.full_messages.join(', ')}"
      render :reject
    end
  end
  
  # 沟通记录操作
  member_action :new_communication_record, method: :get do
    @communication_work_order = resource
    @communication_record = resource.communication_records.build
    render :new_communication_record
  end
  
  member_action :create_communication_record, method: :post do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    record = service.add_communication_record(params.require(:communication_record).permit(:content, :communicator_role, :communicator_name, :communication_method))
    if record.persisted?
      redirect_to admin_communication_work_order_path(resource), notice: "沟通记录已添加"
    else
      @communication_work_order = resource
      @communication_record = record
      flash.now[:alert] = "添加沟通记录失败: #{record.errors.full_messages.join(', ')}"
      render :new_communication_record
    end
  end
  
  # 费用明细验证操作
  member_action :verify_fee_detail, method: :get do
    @work_order = resource
    @fee_detail = resource.fee_details.find(params[:fee_detail_id])
    render 'admin/shared/verify_fee_detail'
  end
  
  member_action :do_verify_fee_detail, method: :post do
    service = CommunicationWorkOrderService.new(resource, current_admin_user)
    if service.update_fee_detail_verification(params[:fee_detail_id], params[:verification_status], params[:comment])
      redirect_to admin_communication_work_order_path(resource), notice: "费用明细 ##{params[:fee_detail_id]} 状态已更新"
    else
      @work_order = resource
      @fee_detail = resource.fee_details.find(params[:fee_detail_id])
      flash.now[:alert] = "费用明细 ##{params[:fee_detail_id]} 更新失败: #{@fee_detail.errors.full_messages.join(', ')}"
      render 'admin/shared/verify_fee_detail'
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
    column :audit_work_order do |wo| link_to wo.audit_work_order_id, admin_audit_work_order_path(wo.audit_work_order) if wo.audit_work_order_id end
    column :status do |wo| status_tag wo.status end
    column :initiator_role
    column :creator
    column :created_at
    actions
  end
# 详情页
  show title: proc{|wo| "沟通工单 ##{wo.id}" } do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :id
          row :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
          row :audit_work_order do |wo| link_to wo.audit_work_order_id, admin_audit_work_order_path(wo.audit_work_order) if wo.audit_work_order_id end
          row :type
          row :status do |wo| status_tag wo.status end
          row :communication_method
          row :initiator_role
          row :resolution_summary
          # Show Shared Req 6/7 fields
          row :problem_type
          row :problem_description
          row :remark
          row :processing_opinion
          row :creator
          row :created_at
          row :updated_at
        end
      end
      
      tab "沟通记录 (#{resource.communication_records.count})" do
        panel "沟通记录" do
          table_for resource.communication_records.order(recorded_at: :desc) do
            column :id
            column :communicator_role
            column :communicator_name
            column :communication_method
            column :content
            column :recorded_at
          end
        end
        div class: "action_items" do
          span class: "action_item" do
            link_to "添加沟通记录", new_communication_record_admin_communication_work_order_path(resource), class: "button"
          end
        end
      end
      
      tab "费用明细 (#{resource.fee_details.count})" do
        panel "费用明细信息" do
          table_for resource.fee_detail_selections.includes(:fee_detail) do |selection|
            column "费用明细ID", :fee_detail_id do |sel| link_to sel.fee_detail_id, admin_fee_detail_path(sel.fee_detail) end
            column "费用类型", :fee_type do |sel| sel.fee_detail.fee_type end
            column "金额", :amount do |sel| number_to_currency(sel.fee_detail.amount, unit: "¥") end
            column "全局状态", :global_status do |sel| status_tag sel.fee_detail.verification_status end
            column "工单内状态", :verification_status do |sel| status_tag sel.verification_status end
            column "验证意见", :verification_comment
            column "操作" do |sel|
              link_to("更新验证状态", verify_fee_detail_admin_communication_work_order_path(resource, fee_detail_id: sel.fee_detail_id))
            end
          end
        end
      end
      
      tab "状态变更历史" do
        panel "状态变更历史" do
          table_for resource.work_order_status_changes.order(changed_at: :desc) do
            column :from_status
            column :to_status
            column :changed_at
            column :changer do |change| change.changer&.email end
          end
        end
      end
    end
  end
  
  # 表单
  form partial: 'form'
end
```

#### 2.4 快递收单工单资源

```ruby
# app/admin/express_receipt_work_orders.rb
ActiveAdmin.register ExpressReceiptWorkOrder do
  menu priority: 2, label: "快递收单工单", parent: "工单管理"
  
  # 权限控制
  permit_params :reimbursement_id, :tracking_number, :received_at, :courier_name, :created_by
  
  # 控制器
  controller do
    def scoped_collection
      # Ensure we only query for this specific type
      ExpressReceiptWorkOrder.includes(:reimbursement, :creator)
    end
  end
  
  # 过滤器
  filter :reimbursement_invoice_number, as: :string, label: '报销单号'
  filter :tracking_number
  filter :received_at
  filter :courier_name
  filter :creator
  filter :created_at
  
  # 导入功能
  action_item :import, only: :index do
    link_to "导入快递收单", new_import_admin_express_receipt_work_orders_path
  end
  
  collection_action :new_import, method: :get do
    render "admin/express_receipt_work_orders/new_import"
  end
  
  collection_action :import, method: :post do
    unless params[:file].present?
      redirect_to new_import_admin_express_receipt_work_orders_path, alert: "请选择要导入的文件。"
      return
    end
    
    service = ExpressReceiptImportService.new(params[:file], current_admin_user)
    result = service.import
    
    if result[:success]
      notice_message = "导入成功: #{result[:created]} 创建, #{result[:skipped]} 跳过."
      notice_message += " #{result[:unmatched]} 未匹配." if result[:unmatched].to_i > 0
      notice_message += " #{result[:errors]} 错误." if result[:errors].to_i > 0
      redirect_to admin_express_receipt_work_orders_path, notice: notice_message
    else
      alert_message = "导入失败: #{result[:errors].join(', ')}"
      redirect_to new_import_admin_express_receipt_work_orders_path, alert: alert_message
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
    column :tracking_number
    column :status do |wo| status_tag wo.status end # Always 'completed'
    column :received_at
    column :courier_name
    column :creator
    column :created_at
    actions
  end
  
  # 详情页
  show title: proc{|wo| "快递收单工单 ##{wo.id}" } do
    attributes_table do
      row :id
      row :reimbursement do |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) end
      row :type
      row :status do |wo| status_tag wo.status end
      row :tracking_number
      row :received_at
      row :courier_name
      row :creator
      row :created_at
      row :updated_at
    end
    
    panel "状态变更历史" do
      table_for resource.work_order_status_changes.order(changed_at: :desc) do
        column :from_status
        column :to_status
        column :changed_at
        column :changer do |change| change.changer&.email end
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "快递收单工单信息" do
      f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }, input_html: { disabled: !f.object.new_record? }
      # Status is fixed, no input needed
      f.input :tracking_number
      f.input :received_at, as: :datepicker
      f.input :courier_name
      # created_by should be set automatically by service
    end
    f.actions
  end
end
```

#### 2.5 费用明细资源

```ruby
# app/admin/fee_details.rb
ActiveAdmin.register FeeDetail do
  menu priority: 1, label: "费用明细", parent: "基础数据"
  config.sort_order = 'created_at_desc'
  
  # 权限控制
  permit_params :document_number, :fee_type, :amount, :currency, :fee_date, :payment_method, :verification_status
# 导入功能
  action_item :import, only: :index do
    link_to "导入费用明细", new_import_admin_fee_details_path
  end
  
  collection_action :new_import, method: :get do
    render "admin/fee_details/new_import"
  end
  
  collection_action :import, method: :post do
    unless params[:file].present?
      redirect_to new_import_admin_fee_details_path, alert: "请选择要导入的文件。"
      return
    end
    
    service = FeeDetailImportService.new(params[:file], current_admin_user)
    result = service.import
    
    if result[:success]
      notice_message = "导入成功: #{result[:imported]} 导入, #{result[:skipped]} 跳过."
      notice_message += " #{result[:unmatched]} 未匹配." if result[:unmatched].to_i > 0
      notice_message += " #{result[:errors]} 错误." if result[:errors].to_i > 0
      redirect_to admin_fee_details_path, notice: notice_message
    else
      alert_message = "导入失败: #{result[:errors].join(', ')}"
      redirect_to new_import_admin_fee_details_path, alert: alert_message
    end
  end
  
  # 过滤器
  filter :document_number_cont, label: "报销单号"
  filter :fee_type
  filter :verification_status, as: :select, collection: FeeDetail::VERIFICATION_STATUSES
  filter :fee_date
  filter :payment_method
  
  # 批量操作
  batch_action :mark_as_verified do |ids|
    batch_action_collection.find(ids).each do |fee_detail|
      fee_detail.update(verification_status: FeeDetail::VERIFICATION_STATUS_VERIFIED)
    end
    redirect_to collection_path, notice: "已将选中的费用明细标记为已验证"
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :document_number do |fd|
      link_to fd.document_number, admin_reimbursement_path(fd.reimbursement) if fd.reimbursement
    end
    column :fee_type
    column :amount do |fd| number_to_currency(fd.amount, unit: fd.currency || "¥") end
    column :fee_date
    column :verification_status do |fd| status_tag fd.verification_status end
    column :payment_method
    column :created_at
    actions
  end
  
  # 详情页
  show title: proc{|fd| "费用明细 ##{fd.id}" } do
    attributes_table do
      row :id
      row :reimbursement do |fd| link_to fd.document_number, admin_reimbursement_path(fd.reimbursement) if fd.reimbursement end
      row :fee_type
      row :amount do |fd| number_to_currency(fd.amount, unit: fd.currency || "¥") end
      row :currency
      row :fee_date
      row :verification_status do |fd| status_tag fd.verification_status end
      row :payment_method
      row :created_at
      row :updated_at
    end
    
    panel "关联工单" do
      table_for resource.fee_detail_selections.includes(:work_order) do
        column "工单ID" do |sel|
          link_to sel.work_order_id, polymorphic_path([:admin, sel.work_order]) if sel.work_order
        end
        column "工单类型", :work_order_type
        column "工单状态" do |sel| status_tag sel.work_order.status if sel.work_order end
        column "验证状态 (工单内)", :verification_status do |sel| status_tag sel.verification_status end
        column "验证意见", :verification_comment
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "费用明细信息" do
      f.input :document_number, label: "报销单号"
      f.input :fee_type
      f.input :amount
      f.input :currency
      f.input :fee_date, as: :datepicker
      f.input :payment_method
      f.input :verification_status, as: :select, collection: FeeDetail::VERIFICATION_STATUSES, include_blank: false
    end
    f.actions
  end
end
```

#### 2.6 操作历史资源

```ruby
# app/admin/operation_histories.rb
ActiveAdmin.register OperationHistory do
  menu priority: 2, label: "操作历史", parent: "基础数据"
  config.sort_order = 'operation_time_desc'
  
  # 权限控制
  permit_params :document_number, :operation_type, :operation_time, :operator, :notes
  
  # 导入功能
  action_item :import, only: :index do
    link_to "导入操作历史", new_import_admin_operation_histories_path
  end
  
  collection_action :new_import, method: :get do
    render "admin/operation_histories/new_import"
  end
  
  collection_action :import, method: :post do
    unless params[:file].present?
      redirect_to new_import_admin_operation_histories_path, alert: "请选择要导入的文件。"
      return
    end
    
    service = OperationHistoryImportService.new(params[:file], current_admin_user)
    result = service.import
    
    if result[:success]
      notice_message = "导入成功: #{result[:imported]} 导入, #{result[:skipped]} 跳过."
      notice_message += " #{result[:updated_reimbursements]} 报销单状态更新." if result[:updated_reimbursements].to_i > 0
      notice_message += " #{result[:unmatched]} 未匹配." if result[:unmatched].to_i > 0
      notice_message += " #{result[:errors]} 错误." if result[:errors].to_i > 0
      redirect_to admin_operation_histories_path, notice: notice_message
    else
      alert_message = "导入失败: #{result[:errors].join(', ')}"
      redirect_to new_import_admin_operation_histories_path, alert: alert_message
    end
  end
  
  # 过滤器
  filter :document_number_cont, label: "报销单号"
  filter :operation_type
  filter :operator
  filter :operation_time
  
  # 列表页
  index do
    id_column
    column :document_number do |h|
      link_to h.document_number, admin_reimbursement_path(h.reimbursement) if h.reimbursement
    end
    column :operation_type
    column :operator
    column :operation_time
    column :notes
    actions
  end
  
  # 详情页
  show title: proc{|h| "操作历史 ##{h.id}" } do
    attributes_table do
      row :id
      row :reimbursement do |h| link_to h.document_number, admin_reimbursement_path(h.reimbursement) if h.reimbursement end
      row :operation_type
      row :operator
      row :operation_time
      row :notes
      row :created_at
      row :updated_at
    end
  end
  
  # 表单
  form do |f|
    f.inputs "操作历史信息" do
      f.input :document_number, label: "报销单号"
      f.input :operation_type
      f.input :operator
      f.input :operation_time, as: :datepicker
      f.input :notes, as: :text
    end
    f.actions
  end
end
```

### 3. 自定义视图模板

#### 3.1 导入视图模板

```erb
<!-- app/views/admin/reimbursements/new_import.html.erb -->
<% content_for :title do %>
  导入报销单
<% end %>

<div class="panel">
  <h3>导入报销单</h3>
  
  <div class="panel_contents">
    <div class="import-instructions">
      <h4>导入说明</h4>
      <ul>
        <li>请使用CSV或Excel文件导入报销单数据</li>
        <li>文件必须包含以下列：报销单单号, 单据名称, 报销单申请人, 报销单申请人工号, 申请人公司, 申请人部门, 报销金额（单据币种）, 收单状态, 收单日期, 提交报销日期, 报销单状态</li>
        <li>如果报销单已存在，将根据报销单单号更新现有记录</li>
        <li>如果报销单不存在，将创建新记录</li>
      </ul>
    </div>
    
    <%= form_tag import_admin_reimbursements_path, multipart: true do %>
      <div class="form-inputs">
        <div class="input file">
          <label for="file">选择文件</label>
          <%= file_field_tag :file, accept: ".csv, .xls, .xlsx" %>
        </div>
      </div>
      
      <div class="form-actions">
        <%= submit_tag "导入", class: "button" %>
        <%= link_to "取消", admin_reimbursements_path, class: "button" %>
      </div>
    <% end %>
  </div>
</div>
```

类似地，为其他导入视图创建模板：
- `app/views/admin/express_receipt_work_orders/new_import.html.erb`
- `app/views/admin/fee_details/new_import.html.erb`
- `app/views/admin/operation_histories/new_import.html.erb`

#### 3.2 工单表单模板

```erb
<!-- app/views/admin/audit_work_orders/_form.html.erb -->
<%= semantic_form_for [:admin, @audit_work_order] do |f| %>
  <%= f.inputs "基本信息" do %>
    <% if f.object.new_record? && params[:reimbursement_id] %>
      <%= f.input :reimbursement_id, as: :hidden, input_html: { value: params[:reimbursement_id] } %>
      <li class="string input optional">
        <label class="label">报销单</label>
        <%= link_to f.object.reimbursement&.invoice_number, admin_reimbursement_path(f.object.reimbursement) %>
      </li>
    <% else %>
      <%= f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }, input_html: { disabled: !f.object.new_record? } %>
    <% end %>
    <%= f.input :status, as: :select, collection: AuditWorkOrder.state_machines[:status].states.map(&:value), include_blank: false %>
    <%= f.input :problem_type, as: :select, collection: ["问题类型A", "问题类型B", "其他"], include_blank: '无' %>
    <%= f.input :problem_description, as: :select, collection: ["问题描述1", "问题描述2", "其他"], include_blank: '无' %>
    <%= f.input :remark, as: :text, input_html: { rows: 3 } %>
    <%= f.input :processing_opinion, as: :select, collection: ["处理意见X", "处理意见Y", "其他"], include_blank: '无' %>
    <%= f.input :audit_comment, as: :text, input_html: { rows: 3 } %>
    <%= f.input :vat_verified %>
  <% end %>
  <%= f.inputs "选择费用明细" do %>
    <div class="fee-detail-selection">
      <label>
        <input type="checkbox" id="select-all-fee-details" class="select-all"> 全选/取消全选
      </label>
      <%= f.input :fee_detail_ids, as: :check_boxes, collection: f.object.reimbursement&.fee_details&.map { |fd| ["##{fd.id} #{fd.fee_type} (#{number_to_currency(fd.amount)}) - #{fd.verification_status}", fd.id] } || [], label: false, input_html: { class: 'fee-detail-checkbox' } %>
    </div>
  <% end %>
  <%= f.actions %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var selectAllCheckbox = document.getElementById('select-all-fee-details');
    var feeDetailCheckboxes = document.querySelectorAll('.fee-detail-checkbox');
    
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        var checked = this.checked;
        feeDetailCheckboxes.forEach(function(checkbox) {
          checkbox.checked = checked;
        });
      });
    }
  });
</script>
```

```erb
<!-- app/views/admin/communication_work_orders/_form.html.erb -->
<%= semantic_form_for [:admin, @communication_work_order] do |f| %>
  <%= f.inputs "基本信息" do %>
    <% if f.object.new_record? && params[:reimbursement_id] %>
      <%= f.input :reimbursement_id, as: :hidden, input_html: { value: params[:reimbursement_id] } %>
      <li class="string input optional">
        <label class="label">报销单</label>
        <%= link_to f.object.reimbursement&.invoice_number, admin_reimbursement_path(f.object.reimbursement) %>
      </li>
    <% else %>
      <%= f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }, input_html: { disabled: !f.object.new_record? } %>
    <% end %>
    <%= f.input :audit_work_order_id, as: :select, collection: AuditWorkOrder.where(reimbursement_id: f.object.reimbursement_id).map { |aw| ["审核工单 ##{aw.id} (#{aw.status})", aw.id] }, include_blank: false, required: true %>
    <%= f.input :status, as: :select, collection: CommunicationWorkOrder.state_machines[:status].states.map(&:value), include_blank: false %>
    <%= f.input :communication_method, as: :select, collection: ["email", "phone", "system", "other"] %>
    <%= f.input :initiator_role, as: :select, collection: ["auditor", "applicant", "manager", "other"] %>
    <%= f.input :problem_type, as: :select, collection: ["问题类型A", "问题类型B", "其他"], include_blank: '无' %>
    <%= f.input :problem_description, as: :select, collection: ["问题描述1", "问题描述2", "其他"], include_blank: '无' %>
    <%= f.input :remark, as: :text, input_html: { rows: 3 } %>
    <%= f.input :processing_opinion, as: :select, collection: ["处理意见X", "处理意见Y", "其他"], include_blank: '无' %>
    <%= f.input :resolution_summary, as: :text, input_html: { rows: 3 } %>
  <% end %>
  <%= f.inputs "选择费用明细" do %>
    <div class="fee-detail-selection">
      <label>
        <input type="checkbox" id="select-all-fee-details" class="select-all"> 全选/取消全选
      </label>
      <%= f.input :fee_detail_ids, as: :check_boxes, collection: f.object.reimbursement&.fee_details&.map { |fd| ["##{fd.id} #{fd.fee_type} (#{number_to_currency(fd.amount)}) - #{fd.verification_status}", fd.id] } || [], label: false, input_html: { class: 'fee-detail-checkbox' } %>
    </div>
  <% end %>
  <%= f.actions %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var selectAllCheckbox = document.getElementById('select-all-fee-details');
    var feeDetailCheckboxes = document.querySelectorAll('.fee-detail-checkbox');
    
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        var checked = this.checked;
        feeDetailCheckboxes.forEach(function(checkbox) {
          checkbox.checked = checked;
        });
      });
    }
  });
</script>
```

#### 3.3 状态变更视图模板

```erb
<!-- app/views/admin/audit_work_orders/approve.html.erb -->
<% @page_title = "审核通过 - 审核工单 ##{@audit_work_order.id}" %>
<%= semantic_form_for [:admin, @audit_work_order], url: do_approve_admin_audit_work_order_path(@audit_work_order), method: :post do |f| %>
  <%= f.inputs "审核通过意见" do %>
    <li class="string input optional">
      <label class="label">报销单</label>
      <%= link_to @audit_work_order.reimbursement.invoice_number, admin_reimbursement_path(@audit_work_order.reimbursement) %>
    </li>
    <%= f.input :problem_type, as: :select, collection: ["问题类型A", "问题类型B", "其他"], include_blank: '无' %>
    <%= f.input :problem_description, as: :select, collection: ["问题描述1", "问题描述2", "其他"], include_blank: '无' %>
    <%= f.input :remark, as: :text, input_html: { rows: 3 } %>
    <%= f.input :processing_opinion, as: :select, collection: ["处理意见X", "处理意见Y", "其他"], include_blank: '无' %>
    <%= f.input :audit_comment, as: :text, label: "审核意见", input_html: { rows: 5 } %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "确认通过" %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_audit_work_order_path(@audit_work_order) } %>
  <% end %>
<% end %>
```

```erb
<!-- app/views/admin/audit_work_orders/reject.html.erb -->
<% @page_title = "审核拒绝 - 审核工单 ##{@audit_work_order.id}" %>
<%= semantic_form_for [:admin, @audit_work_order], url: do_reject_admin_audit_work_order_path(@audit_work_order), method: :post do |f| %>
  <%= f.inputs "审核拒绝意见" do %>
    <li class="string input optional">
      <label class="label">报销单</label>
      <%= link_to @audit_work_order.reimbursement.invoice_number, admin_reimbursement_path(@audit_work_order.reimbursement) %>
    </li>
    <%= f.input :problem_type, as: :select, collection: ["问题类型A", "问题类型B", "其他"], include_blank: '无' %>
    <%= f.input :problem_description, as: :select, collection: ["问题描述1", "问题描述2", "其他"], include_blank: '无' %>
    <%= f.input :remark, as: :text, input_html: { rows: 3 } %>
    <%= f.input :processing_opinion, as: :select, collection: ["处理意见X", "处理意见Y", "其他"], include_blank: '无' %>
    <%= f.input :audit_comment, as: :text, label: "拒绝原因", input_html: { rows: 5, required: true } %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "确认拒绝" %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_audit_work_order_path(@audit_work_order) } %>
  <% end %>
<% end %>
```

类似地，为沟通工单创建状态变更视图模板：
- `app/views/admin/communication_work_orders/approve.html.erb`
- `app/views/admin/communication_work_orders/reject.html.erb`

#### 3.4 沟通记录视图模板

```erb
<!-- app/views/admin/communication_work_orders/new_communication_record.html.erb -->
<% @page_title = "添加沟通记录 - 沟通工单 ##{@communication_work_order.id}" %>
<%= semantic_form_for [:admin, @communication_work_order, @communication_record], url: create_communication_record_admin_communication_work_order_path(@communication_work_order), method: :post do |f| %>
  <%= f.inputs "沟通记录" do %>
    <%= f.input :content, as: :text, label: "沟通内容", input_html: { rows: 5, required: true } %>
    <%= f.input :communicator_role, as: :select, collection: [["审核人", "auditor"], ["申请人", "applicant"], ["管理员", "admin"], ["其他", "other"]], label: "沟通角色", required: true %>
    <%= f.input :communicator_name, as: :string, label: "沟通人姓名", input_html: { value: current_admin_user.email } %>
    <%= f.input :communication_method, as: :select, collection: [["系统", "system"], ["邮件", "email"], ["电话", "phone"], ["其他", "other"]], label: "沟通方式", required: true %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "添加记录" %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_communication_work_order_path(@communication_work_order) } %>
  <% end %>
<% end %>
```

#### 3.5 费用明细验证视图模板

```erb
<!-- app/views/admin/shared/verify_fee_detail.html.erb -->
<% work_order_type = @work_order.class.name.underscore %>
<% provide :title, "验证费用明细 ##{@fee_detail.id} - #{work_order_type.titleize} ##{@work_order.id}" %>
<h2>验证费用明细 #<%= @fee_detail.id %> - <%= work_order_type.titleize %> #<%= @work_order.id %></h2>

<%= semantic_form_for [:admin, @work_order], url: polymorphic_path([:do_verify_fee_detail, :admin, @work_order]), method: :post do |f| %>
  <%= hidden_field_tag :fee_detail_id, @fee_detail.id %>
  <%= f.inputs do %>
    <li class="string input optional">
      <label class="label">费用类型</label>
      <%= @fee_detail.fee_type %>
    </li>
    <li class="string input optional">
      <label class="label">金额</label>
      <%= number_to_currency(@fee_detail.amount, unit: "¥") %>
    </li>
    <li class="string input optional">
      <label class="label">当前全局状态</label>
      <%= status_tag @fee_detail.verification_status %>
    </li>
    <% selection = @work_order.fee_detail_selections.find_by(fee_detail_id: @fee_detail.id) %>
    <li class="string input optional">
      <label class="label">当前工单内状态</label>
      <%= status_tag selection&.verification_status %>
    </li>
    <li class="select input required">
      <label for="verification_status">设置验证状态 <abbr title="required">*</abbr></label>
      <%= select_tag :verification_status, options_for_select(FeeDetail::VERIFICATION_STATUSES.map { |s| [s.titleize, s] }, selection&.verification_status), required: true %>
    </li>
    <li class="text input optional">
      <label for="comment">验证意见</label>
      <%= text_area_tag :comment, selection&.verification_comment, rows: 3 %>
    </li>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "提交", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: polymorphic_path([:admin, @work_order]) } %>
  <% end %>
<% end %>
```

### 4. 仪表盘实现

```ruby
# app/admin/dashboard.rb
ActiveAdmin.register_page "Dashboard" do
  menu priority: 1, label: proc { I18n.t("active_admin.dashboard") }

  content title: proc { I18n.t("active_admin.dashboard") } do
    columns do
      column do
        panel "系统概览" do
          div class: "dashboard-stats" do
            div class: "stat-card" do
              h3 "报销单总数"
              h2 Reimbursement.count
              para "#{Reimbursement.where(created_at: Time.current.beginning_of_day..Time.current).count} 今日新增"
            end
            
            div class: "stat-card" do
              h3 "待处理报销单"
              h2 Reimbursement.where(status: ['pending', 'processing']).count
              para "#{Reimbursement.where(status: 'waiting_completion').count} 等待完成"
            end
            
            div class: "stat-card" do
              h3 "待处理工单"
              pending_count = AuditWorkOrder.pending.count + CommunicationWorkOrder.pending.count
              h2 pending_count
              para "#{AuditWorkOrder.processing.count + CommunicationWorkOrder.where(status: ['processing', 'needs_communication']).count} 处理中"
            end
            
            div class: "stat-card" do
              h3 "待验证费用明细"
              h2 FeeDetail.where(verification_status: ['pending', 'problematic']).count
              para "#{FeeDetail.verified.count} 已验证"
            end
          end
        end
      end
    end
    
    columns do
      column do
        panel "待处理审核工单" do
          table_for AuditWorkOrder.pending.order(created_at: :desc).limit(5) do
            column("ID") { |wo| link_to "##{wo.id}", admin_audit_work_order_path(wo) }
            column("报销单") { |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) }
            column("状态") { |wo| status_tag wo.status }
            column("创建时间") { |wo| wo.created_at.strftime("%Y-%m-%d %H:%M") }
            column("操作") { |wo| link_to "处理", start_processing_admin_audit_work_order_path(wo), method: :put, class: "button" }
          end
          div class: "panel-footer" do
            link_to "查看全部", admin_audit_work_orders_path(q: { status_eq: 'pending' }), class: "button"
          end
        end
      end
      
      column do
        panel "待处理沟通工单" do
          table_for CommunicationWorkOrder.pending.order(created_at: :desc).limit(5) do
            column("ID") { |wo| link_to "##{wo.id}", admin_communication_work_order_path(wo) }
            column("报销单") { |wo| link_to wo.reimbursement.invoice_number, admin_reimbursement_path(wo.reimbursement) }
            column("状态") { |wo| status_tag wo.status }
            column("创建时间") { |wo| wo.created_at.strftime("%Y-%m-%d %H:%M") }
            column("操作") do |wo| 
              span do
                link_to "处理", start_processing_admin_communication_work_order_path(wo), method: :put, class: "button"
              end
              span do
                link_to "需沟通", mark_needs_communication_admin_communication_work_order_path(wo), method: :put, class: "button"
              end
            end
          end
          div class: "panel-footer" do
            link_to "查看全部", admin_communication_work_orders_path(q: { status_eq: 'pending' }), class: "button"
          end
        end
      end
    end
    
    columns do
      column do
        panel "最近导入的报销单" do
          table_for Reimbursement.order(created_at: :desc).limit(5) do
            column("单号") { |r| link_to r.invoice_number, admin_reimbursement_path(r) }
            column("申请人") { |r| r.applicant }
            column("金额") { |r| number_to_currency(r.amount, unit: "¥") }
            column("内部状态") { |r| status_tag r.status }
            column("外部状态") { |r| r.external_status }
            column("创建时间") { |r| r.created_at.strftime("%Y-%m-%d %H:%M") }
          end
          div class: "panel-footer" do
            link_to "查看全部", admin_reimbursements_path, class: "button"
          end
        end
      end
      
      column do
        panel "快速操作" do
          div
div class: "quick-actions" do
            ul do
              li do
                link_to admin_reimbursements_path + "/new" do
                  i(class: "fas fa-plus")
                  span "新建报销单"
                end
              end
              li do
                link_to new_import_admin_reimbursements_path do
                  i(class: "fas fa-file-import")
                  span "导入报销单"
                end
              end
              li do
                link_to new_import_admin_express_receipt_work_orders_path do
                  i(class: "fas fa-file-import")
                  span "导入快递收单"
                end
              end
              li do
                link_to new_import_admin_fee_details_path do
                  i(class: "fas fa-file-import")
                  span "导入费用明细"
                end
              end
              li do
                link_to new_import_admin_operation_histories_path do
                  i(class: "fas fa-file-import")
                  span "导入操作历史"
                end
              end
            end
          end
        end
      end
    end
  end
end
```

## 5. 实现计划

### 5.1 实现顺序

1. **基础配置**
   - 配置ActiveAdmin初始化文件
   - 添加自定义样式
   - 添加Font Awesome图标

2. **资源实现**
   - 实现报销单资源
   - 实现工单资源（快递收单、审核、沟通）
   - 实现费用明细资源
   - 实现操作历史资源

3. **视图模板实现**
   - 实现导入视图模板
   - 实现工单表单模板
   - 实现状态变更视图模板
   - 实现沟通记录视图模板
   - 实现费用明细验证视图模板

4. **仪表盘实现**
   - 实现系统概览
   - 实现待处理工单列表
   - 实现快速操作区域

### 5.2 实现时间表

| 任务 | 预计时间 | 优先级 |
|------|----------|--------|
| 基础配置 | 1天 | 高 |
| 报销单资源实现 | 2天 | 高 |
| 工单资源实现 | 3天 | 高 |
| 费用明细资源实现 | 1天 | 高 |
| 操作历史资源实现 | 1天 | 中 |
| 导入视图模板实现 | 2天 | 高 |
| 工单表单模板实现 | 2天 | 高 |
| 状态变更视图模板实现 | 2天 | 高 |
| 沟通记录视图模板实现 | 1天 | 中 |
| 费用明细验证视图模板实现 | 1天 | 高 |
| 仪表盘实现 | 2天 | 中 |
| 测试与调整 | 3天 | 高 |
| **总计** | **21天** | |

## 6. 注意事项

1. **权限控制**：确保不同用户组只能访问其权限范围内的功能。

2. **表单验证**：确保所有表单都有适当的客户端和服务器端验证。

3. **状态流转**：确保工单状态流转符合业务规则，特别是状态变更对费用明细状态的影响。

4. **导入功能**：确保导入功能能够正确处理重复记录和错误情况。

5. **性能优化**：使用includes预加载关联数据，避免N+1查询问题。

6. **响应式设计**：确保界面在不同设备上都能正常显示。

7. **用户体验**：添加适当的提示信息和确认对话框，提高用户体验。

8. **错误处理**：添加适当的错误处理和日志记录，方便调试和问题排查。

## 7. 总结

本文档提供了SCI2工单系统ActiveAdmin界面的详细实现计划，包括资源配置、自定义控制器、视图模板和JavaScript增强功能。实现计划基于单表继承(STI)模型，旨在提供直观、高效的用户界面。

通过实现本计划，可以为用户提供一个功能完善、易于使用的工单管理系统，满足报销单管理、工单处理、费用明细验证等业务需求。