# SCI2 工单系统重构 - AI 编码任务指令

本目录包含针对 SCI2 工单系统重构的详细 AI 编码任务指令，专为 Qwen 32B 模型设计。每个任务都提供了明确的输入、期望输出和详细步骤，以确保代码质量和一致性。

## 目录结构

```
docs/AI_CODE/
├── README.md                           # 本文件
├── 1_准备阶段/                         # 准备阶段任务指令
│   ├── 1.1_项目结构设置.md
│   └── 1.2_数据库迁移脚本准备.md
├── 2_基础模型实现/                     # 基础模型实现阶段任务指令
│   ├── 2.1_报销单模型.md
│   ├── 2.2_快递收单工单模型.md
│   ├── 2.3_审核工单模型.md
│   ├── 2.4_沟通工单模型.md
│   ├── 2.5_费用明细模型.md
│   └── 2.6_关联模型.md
├── 3_服务层实现/                       # 服务层实现阶段任务指令
│   ├── 3.1_导入服务/
│   │   ├── 3.1.1_报销单导入服务.md
│   │   ├── 3.1.2_快递收单导入服务.md
│   │   ├── 3.1.3_费用明细导入服务.md
│   │   └── 3.1.4_操作历史导入服务.md
│   ├── 3.2_工单处理服务/
│   │   ├── 3.2.1_审核工单处理服务.md
│   │   ├── 3.2.2_沟通工单处理服务.md
│   │   └── 3.2.3_快递收单工单处理服务.md
│   └── 3.3_费用明细验证服务.md
├── 4_控制器与界面实现/                 # 控制器与界面实现阶段任务指令
│   ├── 4.1_ActiveAdmin资源/
│   │   ├── 4.1.1_报销单资源.md
│   │   ├── 4.1.2_快递收单工单资源.md
│   │   ├── 4.1.3_审核工单资源.md
│   │   ├── 4.1.4_沟通工单资源.md
│   │   └── 4.1.5_费用明细资源.md
│   └── 4.2_自定义视图模板.md
└── 5_测试实现/                         # 测试实现阶段任务指令
    ├── 5.1_单元测试/
    │   ├── 5.1.1_模型测试.md
    │   └── 5.1.2_服务测试.md
    └── 5.2_集成测试/
        ├── 5.2.1_工单流程测试.md
        ├── 5.2.2_数据导入测试.md
        └── 5.2.3_端到端测试.md
```

## 使用说明

1. 按照目录结构顺序逐步实现各个任务。
2. 每个任务文件包含以下内容：
   - 任务描述
   - 输入和依赖
   - 期望输出
   - 详细实现步骤
   - 代码示例和模板
   - 测试验证方法
3. 完成每个任务后，应进行测试验证，确保符合要求。
4. 所有实现应遵循 `docs/00LLM_AI开发任务分解指南.md` 中的代码质量保证原则。

## 架构概览

本项目采用单表继承 (Single Table Inheritance, STI) 架构实现工单系统，主要特点：

1. **单表继承模型**：使用 `WorkOrder` 作为基类，通过 `type` 字段区分不同工单类型（快递收单、审核、沟通）
2. **共享字段**：所有工单类型共享字段如 `problem_type`, `problem_description`, `remark`, `processing_opinion`
3. **状态流转**：
   - 快递收单工单：固定状态为 `completed`
   - 审核工单：`pending` → `processing` → `approved`/`rejected`
   - 沟通工单：`pending` → `processing`/`needs_communication` → `approved`/`rejected`
4. **费用明细验证**：状态为 `pending` → `problematic`/`verified`
5. **报销单状态**：`pending` → `processing` → `waiting_completion` → `closed`

## 开发流程

1. 先完成基础模型实现。
2. 再实现服务层。
3. 然后实现控制器和界面。
4. 最后编写测试。

## 注意事项

1. 严格遵循 Rails 和 Ruby 的命名约定和最佳实践。
2. 确保状态机实现正确，特别是状态流转逻辑（使用 state_machines gem）。
3. 特别关注费用明细验证逻辑，确保沟通工单解决后状态不自动更新。
4. 确保两种审核工单创建路径正确实现。
5. 确保数据导入顺序的强制要求（必须先导入报销单）。
6. 确保重复数据处理逻辑正确：
   - 报销单：根据 invoice_number 查找，存在则更新
   - 快递收单：根据 reimbursement_id + tracking_number 检查，存在则跳过
   - 费用明细：根据 document_number + fee_type + amount + fee_date 检查，存在则跳过
   - 操作历史：根据 document_number + operation_type + operation_time + operator 检查，存在则跳过
7. 使用 RSpec 进行测试，确保测试覆盖所有关键功能和边缘情况。

最终实现将使用 `docs/1-2SCI2工单系统测试计划_v3.md` 作为验收标准，确保所有测试用例都能通过。