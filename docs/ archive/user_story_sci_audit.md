# 上下文
文件名：[user_story_sci_audit.md]
创建于：[2024-08-21T10:00:00Z]
创建者：[AI]
关联协议：RIPER-5 + Multidimensional + Agent Protocol

# 任务描述
根据用户输入和相关数据文件，重建并明确工单审计系统的用户故事。该系统旨在帮助审计公司处理客户（销售团队）的报销单。

# 项目概述
项目目标是开发一个工单系统，用于审计客户ERP系统导出的报销单数据。系统需要处理多种数据导入（报销单、费用明细、快递收据、操作历史），并支持创建和管理不同类型的工单（快递收单工单、审核工单、沟通工单）来跟踪审计过程。

---
*以下部分由 AI 在协议执行过程中维护*
---

# 分析 (由 RESEARCH 模式填充)

## 用户故事 (User Story)

**背景：**
我们是一家审计公司，负责审计客户销售团队提交的报销单。所有报销单及相关单据数据均从客户的ERP系统导出。我们需要一个公司内部系统来高效处理这些数据，并为此创建一个工单系统进行跟踪和管理。

**核心角色：**
*   **审计员/操作员：** 使用系统导入数据、创建和处理工单、记录审计发现。

**每日标准作业流程 (SOP)：**
1.  **导入报销单数据：**
    *   来源：`2.HLY报销单报表.csv`
    *   操作：导入系统，以创建新的报销单记录或更新现有报销单信息。明确当日需要处理的报销单。
2.  **导入费用明细数据：**
    *   来源：`4.HLY单据费用明细报表.csv`
    *   操作：导入系统，与相应的报销单进行关联，并更新/创建相关的费用明细条目。
3.  **导入快递收单数据：**
    *   来源：`1.HLY快递收单导出数据.csv`
    *   操作：确认报销凭据（纸质发票等）的快递已收到。
    *   影响：
        *   更新对应报销单的收单状态为 "received" (或类似状态)。
        *   如果一个报销单有关联的快递收单记录，则该报销单**不是**"全电子发票"。（系统默认所有报销单为电子发票，此操作会覆盖该默认设置）。
4.  **导入操作历史数据：**
    *   来源：`3.HLY每单操作历史数据.csv`
    *   操作：导入系统，用于查看和跟踪报销单在客户ERP系统中的审批状态和历史操作。

**工单系统设计：**

**1. 快递收单工单 (Express Receipt Work Order):**
    *   **触发：** 当 `1.HLY快递收单导出数据.csv` 中的数据显示某个报销单的快递已签收时自动创建。
    *   **关联：** 自动关联到对应的报销单。
    *   **状态：** 一旦创建，即视为 "已完成" (completed) 状态。
    *   **逻辑：** 此工单的存在表明报销单包含需要邮寄的纸质凭证。

**2. 审核工单 (Audit Work Order) 与 沟通工单 (Communication Work Order):**
    *   **共性：**
        *   结构和处理逻辑完全相同。
        *   均用于记录对报销单费用明细的审核发现和沟通点。
    *   **区别：**
        *   **创建者/用户组：** 由两组不同的人员创建/处理（一组负责审核，一组负责沟通）。实际上，这两组人可能是同一批人员轮班工作。
        *   **工单类型标识：** 在系统中通过不同的类型字段区分。
        *   **入口：** 在用户界面上可能有不同的创建入口/按钮。
    *   **核心功能 - 问题添加与处理：**
        *   一个审核/沟通工单可以关联**多个**选定的费用明细。
        *   在一个工单内，可以添加**多个**"问题"。
        *   **添加问题流程：**
            1.  在工单中选择一个或多个费用明细。
            2.  针对这些选定的费用明细，记录一个"问题"。每个问题包含：
                *   `费用类型` (Expense Type)
                *   `问题类型` (Issue Type)
            3.  可以重复此过程，为工单内的不同（或相同）费用明细组合添加更多问题。
    *   **处理意见与流程：**
        *   **无问题：**
            *   处理意见选择："可以通过"。
            *   不需要填写额外的审核说明。
        *   **有问题：**
            *   处理意见选择："无法通过"。
            *   必须从预定义列表中选择 `问题类型`。
            *   如果实际问题不在预定义列表中，则需要在"审核说明" (或备注) 字段中手动填写详细描述。
    *   **费用明细与问题的关系：**
        *   一个费用明细可以被多个问题关联（可能在同一个工单的不同"问题条目"中，或在不同工单中）。

**问题类型数据源与逻辑 (最终统一版)：**

*   **核心思想：** 审计员在工单中为选定的一组（一个或多个）费用明细添加问题时，使用统一的三级级联下拉菜单。下拉菜单的选项将以 "Code + Title" 的组合字符串形式显示。
*   **前提：**
    *   工单已关联到一个报销单。该报销单的类型（个人或学术，根据 `单据名称` 判断）已确定。
    *   审计员在工单内选择了一个或多个费用明细（这些费用明细自然属于该报销单，因此其上下文也与报销单类型一致，不会出现个人与学术费用明细混合选择的情况）。
*   **统一的三级级联下拉问题添加流程：**
    1.  **第一级下拉 - 选择 `会议类型` (Meeting Type / Category):**
        *   **列表内容与行为：**
            *   **若父报销单为"个人单"：** 此下拉列表将仅包含或默认选择一个选项：`"00 - 个人"`。
            *   **若父报销单为"学术单"：** 此下拉列表将包含所有学术相关的 `会议类型`（例如：`"03 - 学术论坛"`, `"04 - 患者教育"`等）。这些选项来源于整合后的问题代码库（基于原 `学术问题code.csv` 的 `Meeting Code` 和 `会议类型`）。审计员根据实际情况选择一个。
                *   （此处的逻辑关联到费用明细上的 `弹性字段7(报销单)`，该字段的值会对应这些学术会议类型的Code）。
    2.  **第二级下拉 - 选择 `问题大类` (Issue Category / Major Type):**
        *   **列表内容与行为：** 根据第一级选定的 `会议类型` (`Code + Title`) 动态填充。
            *   **若一级上下文为 `"00 - 个人"`：** 此下拉列表内容为原 `个人问题code.csv` 中的 `费用类型` (`Exp. Code + 费用类型`，例如 `"00 - 月度交通费（销售/SMO/CO）"`, `"03 - 电话费"`)。这些现在扮演"个人单的问题大类"角色。
            *   **若一级上下文为某个学术 `会议类型`（例如 `"03 - 学术论坛"`）：** 此下拉列表内容为原 `学术问题code.csv` (或新统一问题库) 中与该会议类型关联的 `问题大类` (`Issue Code + 问题大类`，例如 `"01 - 会议整体问题"`, `"02 - 会议议程问题"`)。
    3.  **第三级下拉 - 选择 `问题类型` (Specific Issue):**
        *   **列表内容与行为：** 根据第二级选定的 `问题大类` (`Code + Title`) 以及隐含的第一级 `会议类型` 上下文动态填充。
            *   **若一级为 `"00 - 个人"`，二级为某个（原）`费用类型`（例如 `"00 - 月度交通费（销售/SMO/CO）"`）：** 此列表内容为该（原）`费用类型` 下的具体 `问题类型` (`Issue Code + 问题类型`，例如 `"01 - 燃油费行程问题"`)，来源于原 `个人问题code.csv`。
            *   **若一级为学术会议，二级为某个 `问题大类`（例如 `"02 - 会议议程问题"`）：** 此列表内容为该 `问题大类` 下的具体 `问题类型` (`Issue Code + 问题类型`，例如 `"02 - 会议议程不完整"`)，来源于原 `学术问题code.csv` (或新统一问题库)。

*   **重要说明：**
    *   系统**不会**根据所选费用明细上的 `费用类型` 字段自动筛选或限制任何下拉选项。选择权完全交给审计员，审计员可以根据需要多次添加不同组合的问题。
    *   如果审计员认为下拉列表中没有完全匹配的问题描述，他们应选择最接近的条目，并在"审核说明"/"备注字段中提供详细的自定义说明。

*   **数据结构影响：**
    *   为实现此统一流程，`docs/user_data/个人问题code.csv` 和 `docs/user_data/学术问题code.csv` 的内容需要被整合或映射到一个支持 `[会议类型_Code, 会议类型_Title] -> [问题大类_Code, 问题大类_Title] -> [问题类型_Code, 问题类型_Title, SOP描述, 标准处理方法]` 层级关系的新统一数据结构/代码表中。
    *   对于"个人"类别 (`"00 - 个人"`)，原 `个人问题code.csv` 中的 `Exp. Code` 和 `费用类型` 将分别作为新结构中的 `问题大类_Code` 和 `问题大类_Title`。

**后续步骤：**
1.  **确认用户故事：** 请用户确认以上整理的用户故事是否准确完整，特别是统一后的三级下拉问题选择逻辑。
2.  **更新测试计划：** 基于当前确认的用户故事，更新 `docs/999-SCI2工单系统测试计划_v4.3.md`。
3.  **测试驱动开发 (TDD)：** 按照更新后的测试计划，采用TDD方法迭代开发项目。

# 提议的解决方案 (由 INNOVATE 模式填充)

**1. 核心数据模型与关联逻辑：**

*   **报销单 (`Invoices`):** 存储报销单主体信息。
    *   关键字段：`invoice_number` (唯一主键), `document_name` (用于判断个人/学术类型), `status` (`pending_receipt`, `processing`, `closed`), `is_electronic_invoice` (boolean, 默认为true)。
*   **费用明细 (`ExpenseDetails`):** 存储费用明细项。
    *   关联：`invoice_number` (外键关联到 `Invoices`)。
    *   关键字段：`expense_type` (费用类型本身), `flexible_field_7` (弹性字段7，用于学术单据的会议类型判断)。
*   **快递收单 (`ExpressReceipts`):** 存储快递签收信息。
    *   关联：`invoice_number` (外键关联到 `Invoices`)。
*   **操作历史 (`OperationHistories`):** 存储来自客户ERP的操作记录。
    *   关联：`invoice_number` (外键关联到 `Invoices`)。
*   **工单 (`WorkOrders`):** 基类/表，存储所有工单的通用信息。
    *   关键字段：`invoice_id` (外键关联到 `Invoices`), `work_order_type` ('express_receipt', 'audit', 'communication'), `status` ('completed' for express, 'approved'/'rejected'/'pending_review' for audit/comm), `created_by_user_id`, `remarks` (审核说明/备注)。
*   **工单范围内的费用明细 (`WorkOrderScopedDetails`):** 连接表，记录一个审核/沟通工单在创建时选定关联了哪些费用明细。此关联在工单生命周期内固定不变。
    *   字段：`work_order_id` (外键), `expense_detail_id` (外键)。
*   **工单问题条目 (`WorkOrderProblems`):** 记录添加到审核/沟通工单中的每个"问题"实例。每个问题条目默认应用于其父工单所绑定的所有`WorkOrderScopedDetails`。
    *   字段：`work_order_id` (外键), `problem_meeting_type_code`, `problem_major_category_code`, `problem_specific_type_code`, `custom_description` (用户填写的自定义问题描述)。

**2. 统一的问题代码库 (数据库实现)：**

*   将采用数据库表来存储和管理三级联动的问题代码。
*   **表结构设想：**
    *   `ProblemMeetingTypes`:
        *   `id` (PK)
        *   `code` (VARCHAR, e.g., "00", "03") - 唯一
        *   `title` (VARCHAR, e.g., "个人", "学术论坛")
    *   `ProblemMajorCategories`:
        *   `id` (PK)
        *   `code` (VARCHAR) - 在其 `meeting_type_id` 范围内唯一
        *   `title` (VARCHAR, e.g., "月度交通费（销售/SMO/CO）", "会议整体问题")
        *   `meeting_type_id` (FK, references `ProblemMeetingTypes.id`)
    *   `ProblemSpecificTypes`:
        *   `id` (PK)
        *   `code` (VARCHAR) - 在其 `major_category_id` 范围内唯一
        *   `title` (VARCHAR, e.g., "燃油费行程问题", "会议议程不完整")
        *   `sop_description` (TEXT)
        *   `standard_handling` (TEXT)
        *   `major_category_id` (FK, references `ProblemMajorCategories.id`)
*   **数据来源：** 初始数据将通过解析和整合 `docs/user_data/个人问题code.csv` 和 `docs/user_data/学术问题code.csv` 来填充这些表。
*   **管理：** 后期应提供管理界面，允许授权用户增、删、改问题代码库中的条目。

**3. 工单处理与状态联动：**

*   **快递收单工单 (`ExpressReceiptWorkOrder`):**
    *   导入快递收单数据时，若匹配到报销单，则自动创建此类型工单，状态设为 `completed`。
    *   对应报销单的 `is_electronic_invoice` 标志设为 `false`。
    *   对应报销单状态若为 `pending_receipt`，则更新为 `processing` (如果尚无其他审核/沟通工单使其变为 `processing`)。
*   **审核/沟通工单 (`AuditWorkOrder`, `CommunicationWorkOrder`):**
    *   在报销单详情页创建，创建时需选择一组费用明细进行关联（存入 `WorkOrderScopedDetails`）。
    *   可以添加多个 `WorkOrderProblems`，每个 problem 包含三级问题代码选择及自定义描述。
    *   工单处理意见（`approved`, `rejected`, `pending_review`）将影响其关联的所有 `WorkOrderScopedDetails` 中费用明细的校验状态（例如，`verified`, `problematic`）。具体规则待定（例如，只要有一个 `rejected` 的工单问题，或工单整体 `rejected`，则明细为 `problematic`）。
    *   创建任何审核/沟通工单，会使对应报销单状态变为 `processing` (如果之前是 `pending_receipt` 或 `pending`)。
*   **报销单状态 (`Invoice.status`):**
    *   `pending_receipt`: 初始导入状态，或未收到快递。
    *   `processing`: 收到快递（如果需要），或已创建审核/沟通工单。
    *   `closed`: 用户在报销单详情页手动点击"处理完成"按钮（可能需要所有关联费用明细都为 `verified` 状态），或者通过导入操作历史（如"审批通过"）触发。
    *   报销单进入 `closed` 状态后，禁止对其关联的审核/沟通工单进行任何创建或修改操作。

**4. 用户界面 (UI) 考量：**

*   **三级级联下拉：** 在审核/沟通工单中添加问题时，提供动态的三级级联下拉菜单，选项以 `Code + Title` 形式展示。
*   **问题代码库管理界面：** 允许管理员维护问题代码。

# 实施计划 (由 PLAN 模式生成)
[待填充]

# 当前执行步骤 (由 EXECUTE 模式在开始执行某步骤时更新)
[待填充]

# 任务进度 (由 EXECUTE 模式在每步完成后追加)
[待填充]

# 最终审查 (由 REVIEW 模式填充)
[待填充] 