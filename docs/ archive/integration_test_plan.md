# SCI2 工单系统集成测试计划

## 测试目标

创建一个完整的集成测试，涵盖从报销单选择费用明细，创建沟通工单和审核工单，选择多个费用，创建多个费用问题，然后进行审核通过和审核不通过的完整流程。

## 测试数据准备

1. **管理员用户**：用于登录系统
2. **报销单**：创建一个测试报销单
3. **费用明细**：创建多个费用明细，关联到报销单
4. **费用类型**：创建多个费用类型
5. **问题类型**：为每个费用类型创建多个问题类型

## 测试流程

### 1. 沟通工单处理流程

1. **创建沟通工单**：
   - 访问报销单详情页
   - 点击"新建沟通工单"按钮
   - 选择多个费用明细
   - 提交表单创建工单

2. **添加问题到沟通工单**：
   - 点击"拒绝"按钮进入拒绝表单
   - 选择第一个费用类型
   - 选择对应的问题类型
   - 验证审核意见字段自动填充
   - 修改审核意见，添加第一个问题描述
   - 选择第二个费用类型和问题类型
   - 添加第二个问题描述
   - 提交拒绝表单

3. **验证沟通工单状态**：
   - 验证工单状态变为"rejected"
   - 验证关联的费用明细状态变为"problematic"

### 2. 审核工单处理流程

1. **创建审核工单**：
   - 访问报销单详情页
   - 点击"新建审核工单"按钮
   - 选择多个费用明细（可以与沟通工单相同或不同）
   - 提交表单创建工单

2. **添加问题到审核工单并拒绝**：
   - 点击"拒绝"按钮进入拒绝表单
   - 选择费用类型和问题类型
   - 验证审核意见字段自动填充
   - 添加多个问题描述
   - 提交拒绝表单
   - 验证工单状态变为"rejected"
   - 验证关联的费用明细状态变为"problematic"

3. **创建并通过审核工单**：
   - 再次访问报销单详情页
   - 创建新的审核工单
   - 选择之前被拒绝的费用明细
   - 点击"通过"按钮进入通过表单
   - 填写审核意见
   - 提交通过表单
   - 验证工单状态变为"approved"
   - 验证关联的费用明细状态变为"verified"（根据"最新工单决定"原则）

### 3. 报销单状态验证

- 验证报销单状态变为"processing"
- 验证所有费用明细的状态是否正确（根据最新关联的工单状态）

## 测试验证点

1. **级联下拉列表功能**：
   - 选择费用类型后正确加载对应的问题类型
   - 当只有一个问题类型时自动选择

2. **问题描述自动生成**：
   - 选择问题类型后自动填充审核意见
   - 多个问题描述格式正确

3. **费用明细状态更新**：
   - 工单状态变化正确触发费用明细状态更新
   - "最新工单决定"原则正确应用

4. **报销单状态更新**：
   - 创建工单后报销单状态正确更新

## 实现建议

这个集成测试应该创建为 `spec/system/integration/complete_workflow_spec.rb`，使用 RSpec 系统测试框架实现。由于测试涉及到 JavaScript 交互，需要设置 `js: true` 选项。

测试应该使用 Factory Bot 创建测试数据，并使用 Capybara 模拟用户交互。

**注意**：由于 Architect 模式限制，无法直接创建测试文件。请切换到 Code 模式来实现这个测试。