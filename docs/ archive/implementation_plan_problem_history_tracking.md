# 工单问题历史记录功能实现计划

本文档提供了工单问题历史记录功能的详细实现计划，包括任务分解、优先级排序和时间估计。

## 1. 功能概述

工单问题历史记录功能旨在跟踪工单中问题的添加、修改和删除历史，提供完整的审计跟踪，便于了解问题处理的时间线和变更原因。

## 2. 实现阶段

### 阶段一：数据库结构调整（2天）

1. **创建迁移脚本**（0.5天）
   - 创建 `work_order_problem_histories` 表
   - 添加必要的字段和索引
   - 设置外键约束

2. **执行迁移**（0.5天）
   - 运行迁移脚本
   - 验证表结构正确性

3. **创建模型**（1天）
   - 实现 `WorkOrderProblemHistory` 模型
   - 添加关联、验证和作用域
   - 更新相关模型（`WorkOrder`, `ProblemType`, `FeeType`, `AdminUser`）的关联

### 阶段二：服务层实现（3天）

1. **更新 `WorkOrderProblemService`**（2天）
   - 实现 `add_problem` 方法，添加历史记录功能
   - 实现 `modify_problem` 方法，添加历史记录功能
   - 实现 `remove_problem` 方法，添加历史记录功能
   - 实现 `clear_problems` 方法，添加历史记录功能
   - 实现 `record_problem_history` 私有方法

2. **实现差异比较功能**（1天）
   - 添加 `diffy` 或类似的差异比较库
   - 实现 `content_diff` 方法

### 阶段三：UI实现（3天）

1. **ActiveAdmin 配置**（1天）
   - 创建 `work_order_problem_histories.rb` 文件
   - 配置索引页和详情页
   - 添加过滤器和作用域

2. **工单详情页集成**（1天）
   - 在工单详情页添加问题历史记录面板
   - 实现历史记录列表和详情链接

3. **差异比较视图**（1天）
   - 实现变更前后内容的标签页视图
   - 实现差异比较视图
   - 添加必要的CSS样式

### 阶段四：测试与优化（2天）

1. **单元测试**（1天）
   - 为 `WorkOrderProblemHistory` 模型编写测试
   - 为更新后的 `WorkOrderProblemService` 编写测试

2. **集成测试**（0.5天）
   - 编写端到端测试，验证完整功能
   - 测试边缘情况和错误处理

3. **性能优化**（0.5天）
   - 检查和优化查询性能
   - 添加必要的索引
   - 优化大量历史记录的显示

## 3. 任务分解与优先级

### 高优先级任务

1. 创建 `work_order_problem_histories` 表的迁移脚本
2. 实现 `WorkOrderProblemHistory` 模型
3. 更新 `WorkOrderProblemService` 的 `add_problem` 方法
4. 在工单详情页添加问题历史记录面板

### 中优先级任务

1. 实现 `modify_problem` 和 `remove_problem` 方法
2. 创建 ActiveAdmin 配置
3. 编写单元测试
4. 实现变更前后内容的标签页视图

### 低优先级任务

1. 实现差异比较功能
2. 添加 CSS 样式优化
3. 性能优化
4. 添加变更原因记录功能

## 4. 时间估计

| 阶段 | 任务 | 估计时间 |
|------|------|----------|
| 阶段一 | 数据库结构调整 | 2天 |
| 阶段二 | 服务层实现 | 3天 |
| 阶段三 | UI实现 | 3天 |
| 阶段四 | 测试与优化 | 2天 |
| **总计** | | **10天** |

## 5. 依赖关系

1. 数据库结构调整必须在服务层实现之前完成
2. 服务层实现必须在UI实现之前完成
3. 测试与优化可以与UI实现并行进行，但最终验证需要在所有功能实现后进行

## 6. 风险与缓解措施

### 风险

1. **数据量增长**：随着时间推移，历史记录可能会大量增长，影响性能
2. **文本差异比较复杂性**：复杂的文本差异比较可能导致性能问题
3. **用户界面复杂性**：显示历史记录和差异比较的界面可能变得复杂

### 缓解措施

1. **分页和懒加载**：实现分页和懒加载，减少一次性加载的数据量
2. **定期归档**：考虑实现定期归档机制，将旧的历史记录移动到归档表
3. **简化差异比较**：对于大型文本，可以只显示变更的部分，而不是整个文本
4. **用户界面简化**：提供简洁的历史记录摘要，只在用户请求时显示详细信息

## 7. 验收标准

1. 能够记录工单问题的添加、修改和删除历史
2. 历史记录包含操作类型、操作人、时间戳、变更前后内容
3. 能够在工单详情页查看问题历史记录
4. 能够查看变更前后内容的差异
5. 所有单元测试和集成测试通过
6. 性能满足要求，即使在有大量历史记录的情况下

## 8. 后续扩展

1. **变更通知**：添加变更通知功能，当问题被修改或删除时通知相关人员
2. **历史记录搜索**：添加历史记录搜索功能，支持按操作类型、操作人、时间范围等搜索
3. **历史记录导出**：添加历史记录导出功能，支持导出为CSV或Excel格式
4. **历史记录统计**：添加历史记录统计功能，显示问题变更的趋势和模式
5. **批量操作**：支持批量添加、修改或删除问题，并记录为单个历史记录

## 9. 总结

工单问题历史记录功能将提供完整的问题变更跟踪，增强系统的审计能力，便于了解问题处理的时间线和变更原因。该功能将分四个阶段实现，预计需要10个工作日完成。实现过程中需要注意数据量增长和性能问题，并采取相应的缓解措施。