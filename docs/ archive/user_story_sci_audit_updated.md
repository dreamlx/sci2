# 上下文
文件名：[user_story_sci_audit_updated.md]
创建于：[2024-08-21T10:00:00Z]
更新于：[2025-05-29T17:00:00Z]
创建者：[AI]
关联协议：RIPER-5 + Multidimensional + Agent Protocol

# 任务描述
根据用户输入和相关数据文件，重建并明确工单审计系统的用户故事。该系统旨在帮助审计公司处理客户（销售团队）的报销单。

# 项目概述
项目目标是开发一个工单系统，用于审计客户ERP系统导出的报销单数据。系统需要处理多种数据导入（报销单、费用明细、快递收据、操作历史），并支持创建和管理不同类型的工单（快递收单工单、审核工单、沟通工单）来跟踪审计过程。

---
*以下部分由 AI 在协议执行过程中维护*
---

# 分析 (由 RESEARCH 模式填充)

## 用户故事 (User Story)

**背景：**
我们是一家审计公司，负责审计客户销售团队提交的报销单。所有报销单及相关单据数据均从客户的ERP系统导出。我们需要一个公司内部系统来高效处理这些数据，并为此创建一个工单系统进行跟踪和管理。

**核心角色：**
*   **审计员/操作员：** 使用系统导入数据、创建和处理工单、记录审计发现。

**每日标准作业流程 (SOP)：**
1.  **导入报销单数据：**
    *   来源：`2.HLY报销单报表.csv`
    *   操作：导入系统，以创建新的报销单记录或更新现有报销单信息。明确当日需要处理的报销单。
2.  **导入费用明细数据：**
    *   来源：`4.HLY单据费用明细报表.csv`
    *   操作：导入系统，与相应的报销单进行关联，并更新/创建相关的费用明细条目。
3.  **导入快递收单数据：**
    *   来源：`1.HLY快递收单导出数据.csv`
    *   操作：确认报销凭据（纸质发票等）的快递已收到。
    *   影响：
        *   更新对应报销单的收单状态为 "received" (或类似状态)。
        *   如果一个报销单有关联的快递收单记录，则该报销单**不是**"全电子发票"。（系统默认所有报销单为电子发票，此操作会覆盖该默认设置）。
4.  **导入操作历史数据：**
    *   来源：`3.HLY每单操作历史数据.csv`
    *   操作：导入系统，用于查看和跟踪报销单在客户ERP系统中的审批状态和历史操作。

**工单系统设计：**

**1. 快递收单工单 (Express Receipt Work Order):**
    *   **触发：** 当 `1.HLY快递收单导出数据.csv` 中的数据显示某个报销单的快递已签收时自动创建。
    *   **关联：** 自动关联到对应的报销单。
    *   **状态：** 一旦创建，即视为 "已完成" (completed) 状态。
    *   **逻辑：** 此工单的存在表明报销单包含需要邮寄的纸质凭证。

**2. 审核工单 (Audit Work Order) 与 沟通工单 (Communication Work Order):**
    *   **共性：**
        *   结构和处理逻辑完全相同。
        *   均用于记录对报销单费用明细的审核发现和沟通点。
    *   **区别：**
        *   **创建者/用户组：** 由两组不同的人员创建/处理（一组负责审核，一组负责沟通）。实际上，这两组人可能是同一批人员轮班工作。
        *   **工单类型标识：** 在系统中通过不同的类型字段区分。
        *   **入口：** 在用户界面上可能有不同的创建入口/按钮。
    *   **核心功能 - 问题添加与处理：**
        *   一个审核/沟通工单可以关联**多个**选定的费用明细。
        *   在一个工单内，可以添加**多个**问题（通过两级级联选择）。
        *   **问题选择流程：**
            1.  在工单中选择一个或多个费用明细作为此工单的固定范围。
            2.  针对这些选定的费用明细，进行两级问题选择：
                *   `费用类型` (Fee Type) - 第一级
                *   `问题类型` (Problem Type) - 第二级
            3.  系统自动将选择的问题信息添加到审核描述文本中。
            4.  可以重复添加多个问题，每个问题之间用空行分隔。
            5.  可以手动编辑审核描述文本。
    *   **处理意见与流程：**
        *   **无问题：**
            *   处理意见选择："可以通过"。
            *   不需要填写额外的审核说明。
        *   **有问题：**
            *   处理意见选择："无法通过"。
            *   必须完成两级问题选择。
            *   如果实际问题不在预定义列表中，则可以在审核描述中手动编辑详细描述。
    *   **费用明细与问题的关系：**
        *   一个费用明细可以被多个工单关联（可能在不同工单中）。

**问题类型数据源与逻辑 (两级级联设计)：**

* **核心思想:** 审计员在工单中为选定的一组（一个或多个）费用明细添加问题时，使用统一的两级级联下拉菜单。下拉菜单的选项将以 "Code + Title" 的组合字符串形式显示，选择后会自动添加完整问题描述到审核描述文本中。

* **前提:**
    * 工单已关联到一个报销单。该报销单的类型（个人或学术，根据 `单据名称` 判断）确定了会议类型上下文。
    * 审计员在工单内选择了一个或多个费用明细（这些费用明细自然属于该报销单，因此其上下文也与报销单类型一致）。

* **统一的两级级联下拉问题选择流程:**
    1. **第一级下拉 - 选择 `费用类型` (Fee Type):**
        * **列表内容与行为:**
            * 根据报销单类型（个人/学术）显示相应的费用类型列表
            * **若父报销单为"个人单":** 显示个人相关的费用类型，如 `"00 - 月度交通费（销售/SMO/CO）"`, `"03 - 电话费"`等
            * **若父报销单为"学术单":** 显示学术相关的费用类型，如 `"01 - 会议整体费用"`, `"02 - 会议餐饮费"`等
            * 选项以 "Code + Title" 形式显示

    2. **第二级下拉 - 选择 `问题类型` (Problem Type):**
        * **列表内容与行为:** 根据第一级选定的 `费用类型` (`Code + Title`) 动态填充
            * 显示该费用类型下的所有可能问题，如 `"01 - 燃油费行程问题"`, `"02 - 会议议程不完整"`等
            * 选项以 "Code + Title" 形式显示
            * 每个问题类型包含完整的 SOP 描述和标准处理方法

* **问题添加到审核描述:**
    * 用户可以多次添加问题，每次选择问题类型后，系统自动将问题信息添加到审核描述文本区域
    * 每个问题的格式为:
      ```
      费用类型(code+title): 问题类型(code+title)
          SOP描述内容
          标准处理方法内容
      ```
    * 多个问题之间用空行分隔
    * 每次添加新问题时，系统会自动将新问题信息追加到现有审核描述的末尾，并用空行分隔
    * 审计员可以手动编辑审核描述文本，增加、修改或删除问题描述

* **重要说明:**
    * 系统根据报销单类型（个人/学术）自动设置会议类型上下文
    * 个人报销单会自动将会议类型上下文设置为"个人"
    * 学术报销单会根据报销单信息确定相应的学术会议类型上下文
    * 选择权完全交给审计员，可以根据需要选择合适的问题类型

* **数据结构实现:**
    * **两级数据库表结构:**
        * `fee_types`: 存储费用类型 (id, code, title, meeting_type, active)
        * `problem_types`: 存储问题类型 (id, code, title, sop_description, standard_handling, fee_type_id, active)
    * **工单问题选择字段:**
        * `audit_description`: 存储包含所有问题信息的文本描述

**后续步骤：**
1.  **确认用户故事：** 请用户确认以上整理的用户故事是否准确完整，特别是简化后的两级下拉问题选择逻辑。
2.  **更新测试计划：** 基于当前确认的用户故事，更新 `docs/999-SCI2工单系统测试计划_v4.3.md`。
3.  **测试驱动开发 (TDD)：** 按照更新后的测试计划，采用TDD方法迭代开发项目。

# 提议的解决方案 (由 INNOVATE 模式填充)

**1. 核心数据模型与关联逻辑：**

*   **报销单 (`reimbursements`):** 存储报销单主体信息。
    *   关键字段：`invoice_number` (唯一主键), `document_name` (用于判断个人/学术类型), `status` (`pending`, `processing`, `closed`), `is_electronic` (boolean, 默认为true)。
*   **费用明细 (`fee_details`):** 存储费用明细项。
    *   关联：`document_number` (外键关联到 `reimbursements.invoice_number`)。
    *   关键字段：`fee_type` (费用类型本身), `flex_field_7` (弹性字段7，用于学术单据的会议类型判断)。
*   **快递收单 (`ExpressReceiptWorkOrder`):** 通过快递收单工单实现。
    *   关联：`reimbursement_id` (外键关联到 `reimbursements`)。
*   **操作历史 (`operation_histories`):** 存储来自客户ERP的操作记录。
    *   关联：`document_number` (外键关联到 `reimbursements.invoice_number`)。
*   **工单 (`work_orders`):** 基类/表，存储所有工单的通用信息。
    *   关键字段：`reimbursement_id` (外键关联到 `reimbursements`), `type` ('ExpressReceiptWorkOrder', 'AuditWorkOrder', 'CommunicationWorkOrder'), `status` ('completed' for express, 'approved'/'rejected'/'pending' for audit/comm), `created_by`, `audit_description` (审核描述文本，包含所有问题信息)。
*   **工单范围内的费用明细 (`work_order_fee_details`):** 连接表，记录一个审核/沟通工单在创建时选定关联了哪些费用明细。此关联在工单生命周期内固定不变。
    *   字段：`work_order_id` (外键), `fee_detail_id` (外键), `work_order_type`。

**2. 两级问题代码库 (数据库实现)：**

*   将采用数据库表来存储和管理两级联动的问题代码。
*   **表结构：**
    *   `fee_types`:
        *   `id` (PK)
        *   `code` (VARCHAR, e.g., "00", "01") - 唯一
        *   `title` (VARCHAR, e.g., "月度交通费（销售/SMO/CO）", "会议整体费用")
        *   `meeting_type` (VARCHAR, e.g., "个人", "学术论坛")
        *   `active` (BOOLEAN, 默认true)
    *   `problem_types`:
        *   `id` (PK)
        *   `code` (VARCHAR) - 在其 `fee_type_id` 范围内唯一
        *   `title` (VARCHAR, e.g., "燃油费行程问题", "会议议程不完整")
        *   `sop_description` (TEXT)
        *   `standard_handling` (TEXT)
        *   `fee_type_id` (FK, references `fee_types.id`)
        *   `active` (BOOLEAN, 默认true)
*   **数据来源：** 初始数据将通过解析和整合 `docs/user_data/个人问题code.csv` 和 `docs/user_data/学术问题code.csv` 来填充这些表。
*   **管理：** 后期应提供管理界面，允许授权用户增、删、改问题代码库中的条目。

**3. 工单处理与状态联动：**

*   **快递收单工单 (`ExpressReceiptWorkOrder`):**
    *   导入快递收单数据时，若匹配到报销单，则自动创建此类型工单，状态设为 `completed`。
    *   对应报销单的 `is_electronic` 标志设为 `false`。
    *   对应报销单状态若为 `pending`，则更新为 `processing`。
*   **审核/沟通工单 (`AuditWorkOrder`, `CommunicationWorkOrder`):**
    *   在报销单详情页创建，创建时需选择一组费用明细进行关联（存入 `work_order_fee_details`）。
    *   可以通过两级问题选择添加多个问题，问题信息直接添加到 `audit_description` 文本字段中。
    *   工单处理意见（`approved`, `rejected`, `pending`）将影响其关联的所有费用明细的验证状态（例如，`verified`, `problematic`）。具体规则：**最新工单决定原则** - 费用明细的状态由最新关联的工单状态决定。如果最新工单是 `approved`，则费用明细为 `verified`；如果最新工单是 `rejected`，则费用明细为 `problematic`。
    *   创建任何审核/沟通工单，会使对应报销单状态变为 `processing` (如果之前是 `pending`)。
*   **报销单状态 (`reimbursement.status`):**
    *   `pending`: 初始导入状态，或未收到快递。
    *   `processing`: 收到快递（如果需要），或已创建审核/沟通工单。
    *   `closed`: 用户在报销单详情页手动点击"处理完成"按钮（可能需要所有关联费用明细都为 `verified` 状态），或者通过导入操作历史（如"审批通过"）触发。
    *   报销单进入 `closed` 状态后，禁止对其关联的审核/沟通工单进行任何创建或修改操作。

**4. 用户界面 (UI) 考量：**

*   **两级级联下拉：** 在审核/沟通工单中添加问题时，提供动态的两级级联下拉菜单，选项以 `Code + Title` 形式展示。
*   **问题代码库管理界面：** 允许管理员维护问题代码。
*   **审核描述文本区域：** 提供可编辑的文本区域，显示所有已添加的问题信息，并允许手动编辑。

# 实施计划 (由 PLAN 模式生成)
[待填充]

# 当前执行步骤 (由 EXECUTE 模式在开始执行某步骤时更新)
[待填充]

# 任务进度 (由 EXECUTE 模式在每步完成后追加)
[待填充]

# 最终审查 (由 REVIEW 模式填充)
[待填充]