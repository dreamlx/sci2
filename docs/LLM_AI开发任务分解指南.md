# SCI2 工单系统重构 - AI 开发任务分解指南

## 1. 概述

本文档为使用 LLM (Large Language Model) 进行 SCI2 工单系统重构开发提供详细的任务分解指南。考虑到 AI 编程的特性、优势和局限性，我们将开发任务分解为多个层次和阶段，确保代码质量和项目理解的一致性。

## 2. LLM 编程特性与策略

### 2.1 LLM 编程优势

- **代码生成能力**：能够根据详细描述生成完整的代码实现
- **模式识别**：能够理解并应用常见的设计模式和最佳实践
- **文档生成**：能够为代码生成清晰的注释和文档
- **跨文件理解**：能够理解多个文件之间的关系和依赖

### 2.2 LLM 编程局限性

- **上下文窗口限制**：无法同时处理过多的代码文件
- **一致性挑战**：在长时间或多次交互中保持一致性可能有困难
- **细节遗漏**：可能忽略某些边缘情况或特定实现细节
- **测试覆盖不完整**：可能无法自动考虑所有测试场景

### 2.3 应对策略

1. **分层开发**：从基础模型到服务层再到控制器层逐步实现
2. **模块化任务**：将任务分解为独立且可管理的模块
3. **明确接口定义**：在开始编码前明确定义各组件间的接口
4. **增量测试**：每完成一个模块就进行测试
5. **代码审查**：定期审查已生成的代码，确保一致性和质量
6. **文档驱动开发**：使用详细的文档指导开发过程

## 3. 开发阶段划分

### 3.1 准备阶段

1. **项目结构设置**
2. **数据库迁移脚本准备**
3. **依赖库安装配置**

### 3.2 基础模型实现阶段

1. **核心模型实现**
2. **关联关系建立**
3. **状态机实现**

### 3.3 服务层实现阶段

1. **导入服务实现**
2. **工单处理服务实现**
3. **费用明细验证服务实现**

### 3.4 控制器与界面实现阶段

1. **ActiveAdmin 资源配置**
2. **自定义控制器实现**
3. **视图模板实现**

### 3.5 测试阶段

1. **单元测试实现**
2. **集成测试实现**
3. **系统测试实现**

## 4. 详细任务分解

### 4.1 准备阶段任务

#### 4.1.1 项目结构设置

```
任务：设置项目基础结构
输入：Rails 项目框架
输出：配置好的项目结构
步骤：
1. 确认 Rails 版本和依赖
2. 设置数据库配置
3. 配置 ActiveAdmin
4. 设置 AASM 状态机
```

#### 4.1.2 数据库迁移脚本准备

```
任务：创建数据库迁移脚本
输入：数据库结构设计文档
输出：完整的数据库迁移脚本
步骤：
1. 为每个工单类型创建表迁移
2. 创建关联表迁移
3. 设置适当的索引和约束
4. 验证迁移脚本的正确性
```

### 4.2 基础模型实现阶段任务

#### 4.2.1 报销单模型实现

```
任务：实现报销单模型
输入：数据库结构和业务需求
输出：完整的报销单模型
步骤：
1. 定义模型属性和验证
2. 实现与其他模型的关联关系
3. 实现业务方法（如 mark_as_received, mark_as_complete）
4. 添加适当的作用域和查询方法
```

#### 4.2.2 快递收单工单模型实现

```
任务：实现快递收单工单模型
输入：数据库结构和业务需求
输出：完整的快递收单工单模型
步骤：
1. 定义模型属性和验证
2. 实现与报销单的关联关系
3. 使用 AASM 实现状态机
4. 实现状态变更记录功能
5. 实现完成后创建审核工单的功能
```

#### 4.2.3 审核工单模型实现

```
任务：实现审核工单模型
输入：数据库结构和业务需求
输出：完整的审核工单模型
步骤：
1. 定义模型属性和验证
2. 实现与报销单和快递收单工单的关联关系
3. 使用 AASM 实现状态机
4. 实现状态变更记录功能
5. 实现创建沟通工单的功能
6. 实现费用明细验证功能
```

#### 4.2.4 沟通工单模型实现

```
任务：实现沟通工单模型
输入：数据库结构和业务需求
输出：完整的沟通工单模型
步骤：
1. 定义模型属性和验证
2. 实现与报销单和审核工单的关联关系
3. 使用 AASM 实现状态机
4. 实现状态变更记录功能
5. 实现沟通记录功能
6. 实现通知父工单的功能
```

#### 4.2.5 费用明细模型实现

```
任务：实现费用明细模型
输入：数据库结构和业务需求
输出：完整的费用明细模型
步骤：
1. 定义模型属性和验证
2. 实现与报销单的关联关系
3. 实现验证状态更新方法
4. 添加适当的作用域和查询方法
```

#### 4.2.6 关联模型实现

```
任务：实现费用明细选择和沟通记录等关联模型
输入：数据库结构和业务需求
输出：完整的关联模型
步骤：
1. 实现费用明细选择模型
2. 实现沟通记录模型
3. 实现工单状态变更模型
4. 确保关联关系正确建立
```

### 4.3 服务层实现阶段任务

#### 4.3.1 报销单导入服务实现

```
任务：实现报销单导入服务
输入：导入需求和模型定义
输出：完整的报销单导入服务
步骤：
1. 实现 CSV 解析功能
2. 实现报销单创建和更新逻辑
3. 实现电子发票标记识别
4. 实现非电子发票报销单自动创建审核工单功能
5. 实现错误处理和报告
```

#### 4.3.2 快递收单导入服务实现

```
任务：实现快递收单导入服务
输入：导入需求和模型定义
输出：完整的快递收单导入服务
步骤：
1. 实现 CSV 解析功能
2. 实现报销单存在性验证
3. 实现快递收单创建逻辑
4. 实现快递收单工单自动创建功能
5. 实现未匹配记录处理
6. 实现错误处理和报告
```

#### 4.3.3 费用明细导入服务实现

```
任务：实现费用明细导入服务
输入：导入需求和模型定义
输出：完整的费用明细导入服务
步骤：
1. 实现 CSV 解析功能
2. 实现报销单存在性验证
3. 实现费用明细创建逻辑
4. 实现与审核工单的自动关联
5. 实现未匹配记录处理
6. 实现错误处理和报告
```

#### 4.3.4 操作历史导入服务实现

```
任务：实现操作历史导入服务
输入：导入需求和模型定义
输出：完整的操作历史导入服务
步骤：
1. 实现 CSV 解析功能
2. 实现报销单存在性验证
3. 实现操作历史创建逻辑
4. 实现报销单状态更新逻辑
5. 实现工单状态更新逻辑
6. 实现错误处理和报告
```

#### 4.3.5 审核工单处理服务实现

```
任务：实现审核工单处理服务
输入：业务需求和模型定义
输出：完整的审核工单处理服务
步骤：
1. 实现状态转换方法
2. 实现审核通过和拒绝逻辑
3. 实现费用明细验证逻辑
4. 实现沟通工单创建逻辑
5. 实现完成处理逻辑
```

#### 4.3.6 沟通工单处理服务实现

```
任务：实现沟通工单处理服务
输入：业务需求和模型定义
输出：完整的沟通工单处理服务
步骤：
1. 实现状态转换方法
2. 实现沟通记录添加逻辑
3. 实现解决和未解决逻辑
4. 实现通知父工单逻辑
5. 实现关闭处理逻辑
```

#### 4.3.7 快递收单工单处理服务实现

```
任务：实现快递收单工单处理服务
输入：业务需求和模型定义
输出：完整的快递收单工单处理服务
步骤：
1. 实现状态转换方法
2. 实现处理逻辑
3. 实现完成逻辑
4. 实现创建审核工单逻辑
```

#### 4.3.8 费用明细验证服务实现

```
任务：实现费用明细验证服务
输入：业务需求和模型定义
输出：完整的费用明细验证服务
步骤：
1. 实现验证状态更新方法
2. 实现批量验证功能
3. 实现在工单中验证的功能
4. 实现沟通解决后手动更新功能
```

### 4.4 控制器与界面实现阶段任务

#### 4.4.1 报销单 ActiveAdmin 资源实现

```
任务：实现报销单 ActiveAdmin 资源
输入：模型和服务定义
输出：完整的报销单管理界面
步骤：
1. 配置资源属性和权限
2. 实现列表页面
3. 实现详情页面
4. 实现表单页面
5. 实现导入功能
6. 实现批量操作
```

#### 4.4.2 快递收单工单 ActiveAdmin 资源实现

```
任务：实现快递收单工单 ActiveAdmin 资源
输入：模型和服务定义
输出：完整的快递收单工单管理界面
步骤：
1. 配置资源属性和权限
2. 实现列表页面
3. 实现详情页面
4. 实现表单页面
5. 实现状态转换操作
6. 实现批量操作
```

#### 4.4.3 审核工单 ActiveAdmin 资源实现

```
任务：实现审核工单 ActiveAdmin 资源
输入：模型和服务定义
输出：完整的审核工单管理界面
步骤：
1. 配置资源属性和权限
2. 实现列表页面
3. 实现详情页面
4. 实现表单页面
5. 实现状态转换操作
6. 实现费用明细验证界面
7. 实现沟通工单创建界面
```

#### 4.4.4 沟通工单 ActiveAdmin 资源实现

```
任务：实现沟通工单 ActiveAdmin 资源
输入：模型和服务定义
输出：完整的沟通工单管理界面
步骤：
1. 配置资源属性和权限
2. 实现列表页面
3. 实现详情页面
4. 实现表单页面
5. 实现状态转换操作
6. 实现沟通记录添加界面
7. 实现费用明细问题解决界面
```

#### 4.4.5 费用明细 ActiveAdmin 资源实现

```
任务：实现费用明细 ActiveAdmin 资源
输入：模型和服务定义
输出：完整的费用明细管理界面
步骤：
1. 配置资源属性和权限
2. 实现列表页面
3. 实现详情页面
4. 实现表单页面
5. 实现验证状态更新界面
6. 实现批量操作
```

#### 4.4.6 自定义视图模板实现

```
任务：实现自定义视图模板
输入：界面需求
输出：完整的自定义视图模板
步骤：
1. 实现报销单导入视图
2. 实现审核工单审核视图
3. 实现费用明细验证视图
4. 实现沟通工单沟通记录视图
5. 实现沟通工单解决视图
```

### 4.5 测试阶段任务

#### 4.5.1 模型单元测试实现

```
任务：实现模型单元测试
输入：模型定义和测试计划
输出：完整的模型单元测试
步骤：
1. 测试模型验证
2. 测试模型关联关系
3. 测试模型方法
4. 测试状态机功能
```

#### 4.5.2 服务单元测试实现

```
任务：实现服务单元测试
输入：服务定义和测试计划
输出：完整的服务单元测试
步骤：
1. 测试导入服务
2. 测试工单处理服务
3. 测试费用明细验证服务
4. 测试状态变更服务
```

#### 4.5.3 工单流程集成测试实现

```
任务：实现工单流程集成测试
输入：测试计划
输出：完整的工单流程集成测试
步骤：
1. 测试快递收单工单流程
2. 测试审核工单流程
3. 测试沟通工单流程
4. 测试费用明细验证流程
```

#### 4.5.4 数据导入集成测试实现

```
任务：实现数据导入集成测试
输入：测试计划
输出：完整的数据导入集成测试
步骤：
1. 测试报销单导入
2. 测试快递收单导入
3. 测试费用明细导入
4. 测试操作历史导入
5. 测试导入顺序要求
```

#### 4.5.5 端到端系统测试实现

```
任务：实现端到端系统测试
输入：测试计划
输出：完整的端到端系统测试
步骤：
1. 测试完整报销流程
2. 测试包含沟通的报销流程
3. 测试非电子发票报销流程
4. 测试操作历史影响报销单状态
```

## 5. LLM 开发指导原则

### 5.1 代码质量保证

1. **命名规范**：使用清晰、一致的命名约定
2. **代码注释**：为复杂逻辑添加详细注释
3. **错误处理**：实现全面的错误处理和日志记录
4. **代码重用**：提取共享逻辑到公共方法或关注点
5. **测试覆盖**：确保关键功能有测试覆盖

### 5.2 开发流程建议

1. **先实现核心模型**：从基础模型开始，确保关联关系正确
2. **再实现服务层**：基于模型实现各种服务
3. **然后实现界面**：基于服务实现用户界面
4. **最后编写测试**：为所有功能编写测试

### 5.3 代码审查重点

1. **状态流转逻辑**：确保状态机实现正确
2. **费用明细验证逻辑**：特别关注沟通工单解决后状态不自动更新
3. **工单创建逻辑**：确保两种审核工单创建路径正确实现
4. **数据导入顺序**：确保强制要求先导入报销单

## 6. 测试验收标准

最终实现将使用 'docs/refactoring/SCI2工单系统重构测试计划.md' 作为验收标准，确保所有测试用例都能通过。重点关注：

1. **数据导入测试**：确保四种数据类型的导入功能和导入顺序要求
2. **工单状态流转测试**：确保三种工单类型的状态流转逻辑
3. **费用明细验证测试**：特别关注沟通工单解决后状态不自动更新的情况
4. **集成测试场景**：确保完整业务流程的正确性

## 7. 开发任务优先级

### 7.1 高优先级任务

1. 基础模型实现
2. 状态机实现
3. 数据导入服务实现
4. 费用明细验证逻辑实现

### 7.2 中优先级任务

1. 工单处理服务实现
2. ActiveAdmin 资源实现
3. 自定义视图模板实现

### 7.3 低优先级任务

1. 批量操作功能
2. 高级查询功能
3. UI 美化

## 8. 总结

本文档提供了使用 LLM 进行 SCI2 工单系统重构开发的详细任务分解指南。通过分层开发、模块化任务和明确的接口定义，我们可以充分利用 LLM 的编程优势，同时规避其局限性。最终实现将通过 'docs/refactoring/SCI2工单系统重构测试计划.md' 中定义的测试用例进行验证，确保满足所有业务需求。