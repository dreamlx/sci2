# 工单系统测试计划 (V4.3)

## 目录

- [1. 测试目标与范围](#1-测试目标与范围)
- [2. 测试环境](#2-测试环境)
- [3. 测试数据准备](#3-测试数据准备)
- [4. 测试用例分类](#4-测试用例分类)
- [5. 数据导入测试](#5-数据导入测试)
- [6. 工单处理与报销单状态联动测试](#6-工单处理与报销单状态联动测试)
- [7. 工单关联关系测试](#7-工单关联关系测试)
- [8. 费用明细验证测试](#8-费用明细验证测试)
- [9. 集成测试场景](#9-集成测试场景)
- [10. 测试执行计划](#10-测试执行计划)
- [11. 测试报告模板](#11-测试报告模板)

## 1. 测试目标与范围

### 测试目标

1. 验证工单系统的核心功能是否按照设计规范正常工作
2. 确保数据导入功能能够正确处理各类CSV文件
3. 测试工单与报销单的关联关系是否正确建立和维护
4. 确保选定的"费用明细组"与工单的关联固定不变，以及工单内"问题条目"的正确应用逻辑
5. 测试系统在各种边界条件和异常情况下的行为
6. 验证报销单状态 (pending_receipt, processing, closed) 的正确流转逻辑
7. 验证报销单进入 closed 状态后，工单不可创建和修改
8. 验证统一问题代码库（数据库表）的正确使用及两级级联下拉功能
9. 验证费用明细状态由最新工单决定的原则

### 测试范围

- **数据导入模块**：报销单、快递收单、操作历史、费用明细的CSV导入功能
- **工单处理模块**：三种工单类型（快递收单工单、审核工单、沟通工单）的创建与处理。审核工单与沟通工单逻辑一致。
- **工单核心逻辑模块**：审核/沟通工单创建时选择固定的"费用明细组"，工单内可添加多个"问题条目"，每个问题条目应用于整个费用明细组。
- **问题选择模块**：统一的两级级联下拉问题选择（费用类型、问题类型），选项显示为"Code + Title"。
- **费用明细状态管理模块**：费用明细的最终审计状态（problematic, verified）如何根据所有关联工单的结论综合判定。
- **工单关联模块**：工单与报销单的关联，工单与其选择的"费用明细组"的关联，工单与其"问题条目"列表的关联。
- **报销单状态管理模块**：报销单状态 (pending_receipt, processing, closed) 的变更及相关操作限制。
- **问题代码库模块**：数据库中存储的统一问题代码（三级结构）的正确性和可维护性（管理功能暂不测试）。

## 2. 测试环境

### 开发环境

- **操作系统**：macOS/Linux/Windows
- **数据库**：sqlite
- **Ruby版本**：3.0+
- **Rails版本**：7.0+
- **浏览器**：Chrome 最新版、Firefox 最新版、Safari 最新版

### 测试环境

- **测试数据库**：与开发环境隔离的独立测试数据库
- **测试框架**：Rails内置测试框架（Minitest）
- **测试类型**：单元测试、集成测试、系统测试
- **CI/CD**：GitHub Actions 或 Jenkins

## 3. 测试数据准备

### 基础测试数据

1. **报销单数据**：
   - 普通报销单（`is_electronic_invoice` 会被快递收单置为 `false`）
   - 纯电子发票报销单（无快递收单, `is_electronic_invoice` 保持 `true`）
   - 不同状态的报销单（pending_receipt、processing、closed）
   - 包含"个人"类型的单据名称的报销单
   - 包含"学术"类型的单据名称的报销单

2. **快递收单数据**：
   - 匹配已有报销单的快递收单
   - 未匹配报销单的快递收单
   - （V4.2移除：多次收单的情况（一个报销单对应多个快递单）- 简化为一次有效收单即标志为非电子）

3. **费用明细数据**：
   - 不同 `expense_type` 的费用明细
   - 具有不同 `flexible_field_7` 值的费用明细 (用于学术单判断会议类型上下文)
   - 期望最终状态为 `verified` 的费用明细集合
   - 期望最终状态为 `problematic` 的费用明细集合
   - 同时被多个工单（结论可能冲突）关联的费用明细

4. **操作历史数据**：
   - 不同操作类型的历史记录（审批、审批通过、退回等）
   - 不同操作人的历史记录

5. **问题代码库数据 (数据库)**:
   - **核心**：测试数据库中应包含预填充的、符合两层结构（`FeeTypes`, `ProblemTypes`）的问题代码表。
   - 样例数据应覆盖:
     - 个人类型上下文 ("个人"):
       - `FeeTypes`: {code: "00", title: "月度交通费（销售/SMO/CO）", meeting_type: "个人"}
         - `ProblemTypes` (关联到对应的FeeType, {code:"01", title:"燃油费行程问题", sop_description:"...", standard_handling:"..."})
     - 学术类型上下文 (e.g., "学术论坛"):
       - `FeeTypes`: {code: "01", title: "会议整体费用", meeting_type: "学术论坛"}
         - `ProblemTypes` (关联到对应的FeeType, {code:"02", title:"会议议程不完整", sop_description:"...", standard_handling:"..."})
   - 所有`ProblemTypes`记录应包含有效的SOP描述和标准处理方法字段。
   - (可选，低优先级) 准备用于测试问题代码库 *初始化/迁移脚本* 的源文件（如CSV/Excel），包含正确和错误格式的数据行，验证迁移工具的健壮性。

### 测试文件准备

1. **CSV测试文件**：
   - 标准格式的CSV文件
   - 包含中文字符的CSV文件
   - 格式错误的CSV文件（用于测试错误处理）
   - 包含重复数据的CSV文件（用于测试重复处理）
   - 包含部分重复部分新增的混合CSV文件

2. **Excel测试文件**：这里由客户人工测试，我们先不用考虑
   - .xlsx格式文件
   - .xls格式文件
   - 包含多个工作表的Excel文件

3. **测试数据生成脚本**：
   - 开发自动化脚本生成大量测试数据
   - 支持生成不同场景的测试数据集
   - 生成直接approved状态工单的测试数据

## 4. 测试用例分类

### 按功能模块分类

1. **数据导入测试**
2. **工单创建与处理测试**
3. **费用明细验证测试**
4. **工单关联关系测试**
5. **报销单状态管理测试**
6. **表单结构与字段测试**
7. **用户权限分组测试**

### 按测试类型分类

1. **单元测试**：测试各个模型和方法的独立功能
## 5. 数据导入测试

NOTICE 第一阶段： 只测试csv数据导入，不做excel处理， 是否是电子发票这个状态需要另外操作，目前只需要确认有这个字段存在。

### 5.1 报销单导入测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-R-001 | 导入标准CSV格式报销单 | 1. 准备标准格式的报销单CSV文件<br>2. 使用导入功能上传文件 | 1. 成功导入所有记录<br>2. 显示导入成功消息<br>3. 数据库中创建对应的报销单记录<br>4. 报销单状态设置为pending | 高 |
| IMP-R-002 | 导入Excel格式报销单 | 1. 准备.xlsx格式的报销单文件<br>2. 使用导入功能上传文件 | 1. 成功导入所有记录<br>2. 显示导入成功消息<br>3. 数据库中创建对应的报销单记录<br>4. 报销单状态设置为pending | 高 |
| IMP-R-003 | 验证报销单`is_electronic_invoice`状态的自动与手动调整 | 1. 导入报销单文件 (不包含匹配的快递收单记录)<br>2. 验证新导入报销单的 `is_electronic_invoice` 字段默认为 `true`。<br>3. 导入匹配该报销单的快递收单CSV文件。<br>4. 验证该报销单的 `is_electronic_invoice` 字段自动更新为 `false`。<br>5. (如果业务支持) 检查是否存在UI功能允许有相应权限的用户手动覆盖 `is_electronic_invoice` 状态，并测试其是否按预期工作及记录操作历史。 | 1. 新报销单 `is_electronic_invoice` 默认为 `true`。<br>2. 关联快递收单导入后，`is_electronic_invoice` 自动变为 `false`。<br>3. 如果存在手动调整功能，其操作符合业务规则。 | 中 |
| IMP-R-005 | 导入格式错误的报销单文件 | 1. 准备格式错误的报销单文件<br>2. 使用导入功能上传文件 | 1. 显示导入错误消息<br>2. 提供错误详情<br>3. 不导入任何记录 | 中 |
| IMP-R-006 | 导入重复的报销单 | 1. 导入一批报销单<br>2. 再次导入相同invoice number的报销单<br>3. 测试不同字段更新时的覆盖规则 | 1. 系统识别重复记录（以invoice number作为唯一识别key）<br>2. 更新已存在的报销单记录<br>3. 显示更新成功消息<br>4. 验证更新后的完整数据对比 | 高 |
| IMP-R-007 | 导入报销单验证默认电子发票状态 | 1. 准备不包含任何关联快递收单信息的报销单CSV文件。<br>2. 使用导入功能上传该文件。 | 1. 所有报销单成功导入。<br>2. 数据库中对应报销单记录的 `is_electronic_invoice` 字段值均为 `true`。 | 高 |
### 5.2 快递收单导入测试

NOTICE 第一阶段： 只测试csv数据导入，不做excel处理，

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-E-001 | 导入匹配已有报销单的快递收单 | 1. 先导入报销单 (其 `is_electronic_invoice` 默认为 `true`)<br>2. 导入对应的快递收单 | 1. 成功导入所有记录<br>2. 自动关联到对应的报销单<br>3. 自动创建快递收单工单<br>4. 工单状态设为completed<br>5. 工单操作人设为导入用户<br>6. 对应报销单的 `is_electronic_invoice` 字段更新为 `false`<br>7. 对应报销单状态更新 (如从 `pending_receipt` 到 `processing`) | 高 |
| IMP-E-002 | 导入未匹配报销单的快递收单 | 1. 导入不存在对应报销单的快递收单 | 1. 显示未匹配警告<br/>2. 记录未匹配的快递收单<br/>3. 提供未匹配记录下载<br/>4. 不创建快递收单工单 | 高 |
| IMP-E-004 | (V4.3移除/重新评估)导入多次收单的情况 | (原测试逻辑与简化后的"一次有效收单即标志为非电子"不符，暂移除或重定义测试点) |  | 中 |
| IMP-E-005 | 导入格式错误的快递收单文件 | 1. 准备格式错误的快递收单文件<br>2. 使用导入功能上传文件 | 1. 显示导入错误消息<br>2. 提供错误详情<br>3. 不导入任何记录 | 中 |
### 5.3 费用明细导入测试

NOTICE 第一阶段： 只测试csv数据导入，不做excel处理，

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-F-001 | 导入匹配已有报销单的费用明细 | 1. 先导入报销单<br>2. 导入对应的费用明细 | 1. 成功导入所有记录<br>2. 自动关联到对应的报销单<br>3. 设置费用明细验证状态为pending | 高 |
| IMP-F-002 | 导入未匹配报销单的费用明细 | 1. 导入不存在对应报销单的费用明细 | 1. 显示未匹配警告<br>2. 提供未匹配成功的items csv下载 | 中 |
| IMP-F-004 | 导入多种费用类型的明细 | 1. 准备包含多种费用类型的明细文件<br>2. 使用导入功能上传文件 | 1. 成功导入所有记录<br>2. 正确识别不同的费用类型<br>3. 设置费用明细验证状态为pending | 中 |
| IMP-F-005 | 导入格式错误的费用明细文件 | 1. 准备格式错误的费用明细文件<br>2. 使用导入功能上传文件 | 1. 显示导入错误消息<br>2. 提供错误详情<br>3. 不导入任何记录 | 中 |
| IMP-F-006 | 导入重复的费用明细 | 1. 导入一批费用明细<br>2. 再次导入完全相同的费用明细<br>3. 导入部分重复部分新增的混合数据 | 1. 系统识别重复记录<br>2. 跳过重复记录<br>3. 显示跳过记录数量<br>4. 验证重复记录的精确识别<br>5. 验证部分重复部分新增的混合场景处理正确 | 高 |
### 5.4 操作历史导入测试

NOTICE 第一阶段： 只测试csv数据导入，不做excel处理，

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-O-001 | 导入匹配已有报销单的操作历史 | 1. 先导入报销单<br>2. 导入对应的操作历史 | 1. 成功导入所有记录<br>2. 自动关联到对应的报销单 | 高 |
| IMP-O-002 | 导入审批通过类型的操作历史 | 1. 先导入报销单<br>2. 导入包含"审批通过"类型的操作历史：<br />{操作类型：审批,操作意见：审批通过} | 1. 成功导入记录<br>2. 自动更新报销单状态为 `close` | 高 |
| IMP-O-004 | 导入未匹配报销单的操作历史 | 1. 导入不存在对应报销单的操作历史 | 1. 显示未匹配警告<br/>2. 提供未匹配成功的items csv下载 | 中 |
| IMP-O-005 | 导入格式错误的操作历史文件 | 1. 准备格式错误的操作历史文件<br>2. 使用导入功能上传文件 | 1. 显示导入错误消息<br>2. 提供错误详情<br>3. 不导入任何记录 | 中 |
| IMP-O-006 | 导入重复的操作历史 | 1. 导入一批操作历史<br>2. 再次导入完全相同的操作历史<br>3. 导入部分重复部分新增的混合数据 | 1. 系统识别重复记录<br>2. 跳过重复记录<br>3. 显示跳过记录数量<br>4. 验证重复记录的精确识别<br>5. 验证导入完成后的重复记录统计信息显示<br>6. 验证部分重复部分新增的混合场景处理正确 | 高 |
### 5.5 导入顺序测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-S-001 | 按正确顺序导入所有数据 | 1. 先导入报销单<br>2. 导入快递收单<br>3. 导入费用明细<br>4. 导入操作历史 | 1. 所有数据成功导入<br>2. 所有关联关系正确建立<br>3. 工单自动创建<br>4. 状态正确更新 | 高 |
| IMP-S-002 | 颠倒顺序导入数据 | 1. 先导入操作历史<br>2. 导入费用明细<br>3. 导入快递收单<br>4. 导入报销单 | 1. 系统能够处理顺序错误<br>2. 跳过未匹配item<br>3. 最终所有关联关系正确 | 中 |
| IMP-S-003 | 混合顺序多次导入 | 1. 先导入部分报销单<br>2. 导入部分快递收单<br>3. 再导入剩余报销单<br>4. 导入费用明细和操作历史 | 1. 系统能够正确处理混合顺序<br>2. 最终所有关联关系正确<br>3. 工单状态正确 | 中 |
### 5.6 问题代码库导入测试

NOTICE: (V4.3调整) 此部分主要测试问题代码库通过特定工具/脚本初始化的功能，而非日常操作。核心业务逻辑测试依赖于数据库中已存在的问题代码。

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-PC-001 | (低) 初始化导入标准格式的问题代码库源文件 | 1. 准备包含正确层级关系（会议类型 -> 问题大类 -> 具体问题，包含Code和Title，SOP，标准处理）的源文件 (如CSV/Excel)<br>2. 使用初始化脚本/工具导入文件到空的数据库表 | 1. 成功导入所有问题代码记录到数据库三层表结构中<br>2. 显示导入成功消息<br>3. 数据库中问题代码记录的层级关系正确 | 中 |
| IMP-PC-002 | (低) 初始化导入格式错误的问题代码库源文件 | 1. 准备包含列缺失、层级关系断裂等错误的源文件<br>2. 使用初始化脚本/工具导入文件 | 1. 初始化工具显示导入错误消息<br>2. 提供错误详情（如行号、错误原因）<br>3. 不导入任何或仅部分正确记录（根据错误处理策略决定） | 低 |
| IMP-PC-003 | (低) 初始化导入包含重复/更新数据的问题代码库源文件 | 1. 先通过脚本导入一批问题代码到数据库<br>2. 准备包含部分重复Code（但Title或其他信息不同）和部分全新Code的源文件<br>3. 再次使用初始化脚本/工具导入文件 | 1. 初始化工具能识别重复Code<br>2. 根据预设规则更新现有记录或跳过/报错（需明确更新策略）<br>3. 新增不重复的记录<br>4. 显示导入/更新/跳过/错误摘要信息 | 低 |
## 6. 工单处理与报销单状态联动测试

### 6.1 快递收单工单测试

快递收单工单在导入快递收单CSV时自动创建并设置为已完成状态。

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| WF-E-001 | 快递收单工单自动创建与报销单状态更新 | 1. 导入报销单 (初始状态 `pending_receipt`, `is_electronic_invoice` 为 `true`)<br>2. 导入对应的快递收单数据 | 1. 自动创建快递收单工单<br>2. 收单工单状态设置为completed<br>3. 工单操作人设置为导入用户<br>4. 关联报销单的 `is_electronic_invoice` 更新为 `false`<br>5. 关联报销单状态从 `pending_receipt` 变为 `processing` | 高 |
| WF-E-002 | 快递收单工单关联报销单 | 1. 导入报销单<br>2. 导入对应的快递收单 | 1. 快递收单工单自动关联到报销单 | 高 |

### 6.2 审核与沟通工单处理测试

审核工单与沟通工单逻辑一致，在报销单 show 页面创建。创建任一此类工单会使报销单状态变为 `processing` (如果之前是 `pending`)。工单没有状态变更历史记录。

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| WF-AC-001 | 审核/沟通工单创建与基础处理 - 通过路径 | 1. 在某报销单详情页面选择创建审核/沟通工单<br>2. **系统要求选择一个或多个该报销单下的费用明细作为此工单的固定范围（存入`WorkOrderFeeDetails`）**<br>3. （可选）添加一个或多个问题：<br>   a. 根据报销单类型（个人/学术），系统自动设置会议类型上下文。<br>   b. 第一级"费用类型"下拉根据会议类型上下文显示选项。选择一项。选项显示为"Code+Title"。<br>   c. 第二级"问题类型"下拉根据一级选择动态加载。选择一项。选项显示为"Code+Title"。<br>   d. 系统自动将问题信息添加到审核描述文本，格式为："费用类型: 问题类型"，下面缩进显示SOP描述和标准处理方法。<br>   e. 重复上述步骤可添加多个问题，每个问题之间用空行分隔。<br>   f. (可选) 手动编辑审核描述。<br>4. 处理意见：审核通过（工单标记为 `approved`）<br>5. (可选) 填写整体工单备注。 | 1. 工单成功创建并标记为 `approved`<br>2. 关联报销单状态更新为 `processing` (如果之前是 `pending_receipt`)<br>3. 工单关联的"费用明细组"中的所有费用明细，因受此`approved`工单影响，其审核状态贡献为"通过"。（最终状态需综合所有关联工单判断，见REL-004, FEE-003, FEE-004）<br>4. 若添加了问题，其信息被正确记录到审核描述中，多个问题之间用空行分隔。即使是"通过"，也可能记录问题（表示问题已解决）。 | 高 |
| WF-AC-002 | 审核/沟通工单创建与基础处理 - 不通过路径 | 1. 在某报销单详情页面选择创建审核/沟通工单<br>2. **系统要求选择一个或多个该报销单下的费用明细作为此工单的固定范围（存入`WorkOrderFeeDetails`）**<br>3. **必须**添加至少一个问题：<br>   a. 根据报销单类型（个人/学术），系统自动设置会议类型上下文。<br>   b. 第一级"费用类型"下拉根据会议类型上下文显示选项。选择一项。<br>   c. 第二级"问题类型"下拉根据一级选择动态加载。选择一项。<br>   d. 系统自动将问题信息添加到审核描述文本。<br>   e. (可选) 手动编辑审核描述。<br>4. 处理意见：审核不通过（工单标记为 `rejected`）<br>5. (可选) 填写整体工单备注。 | 1. 工单成功创建并标记为 `rejected`<br>2. 关联报销单状态更新为 `processing` (如果之前是 `pending_receipt`)<br>3. 工单关联的"费用明细组"中的所有费用明细，因受此`rejected`工单影响，其审核状态贡献为"不通过"。（最终状态需综合所有关联工单判断）<br>4. 添加的问题信息被正确记录到审核描述中。 | 高 |
| WF-AC-003 | 审核/沟通工单处理中保存（待处理） | 1. 在某报销单详情页面选择创建审核/沟通工单<br>2. **系统要求选择一个或多个该报销单下的费用明细作为此工单的固定范围（存入`WorkOrderFeeDetails`）**<br>3. (可选) 添加一个或多个问题（按照WF-AC-001步骤3a-3f的流程）。<br>4. 处理意见设置为"待处理/pending_review"或类似状态。<br>5. 保存工单 | 1. 工单成功创建/更新，状态为"待处理/pending_review"<br>2. 关联报销单状态更新为 `processing` (如果之前是 `pending_receipt`)<br>3. 工单关联的"费用明细组"中的所有费用明细，因受此`pending_review`工单影响，其审核状态贡献可能视为"不通过"或"待定"（需明确业务规则，一般存在未解决问题即视为有问题）。 |  高 |
| WF-AC-004 | 审核/沟通工单内添加多个问题 | 1. 创建一个审核/沟通工单，并固定关联一组费用明细。<br>2. 在该工单内，重复添加问题操作N次，每次选择不同的费用类型和问题类型组合。<br>3. 观察每次添加问题后，系统自动将问题信息添加到审核描述文本，并用空行分隔。<br>4. 保存工单。 | 1. 工单成功保存。<br>2. 工单的审核描述文本中包含N个问题信息，每个问题之间用空行分隔。<br>3. 所有这些问题逻辑上都应用于该工单固定的那一组费用明细。 | 高 |
| WF-AC-005 | 审核/沟通工单问题类型必填验证（不通过时） | 1. 在报销单show页面创建审核/沟通工单<br>2. 选择费用明细组<br>3. 处理意见：无法通过 (rejected)<br>4. **不添加任何问题** 或添加的问题未完成两级选择<br>5. 尝试提交/保存 | 1. 系统显示错误消息<br>2. 要求至少添加一个完整的问题（包含完整的两级问题选择） | 高 |

### 6.3 工单表单字段测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| WF-FORM-001 | 工单表单字段完整性验证 | 1. 分别创建审核工单和沟通工单<br>2. 验证表单包含：费用明细选择（用于初始关联，不可更改）、"添加问题"机制、两级级联下拉（费用类型、问题类型，均显示Code+Title）、审核描述文本区域、处理意见下拉列表<br>3. 验证操作人默认为当前用户 | 1. 两种工单表单结构符合最新设计<br />2. 所有必填字段（如处理意见，或在"不通过"时的问题选择）按预期工作<br>3. 两级下拉列表按上下文正确动态加载和显示<br>4. 操作人自动填充为当前用户 | 高 |

### 6.4 报销单关闭 (close) 状态测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| WF-CL-001 | 报销单状态变为 processing | 1. 创建报销单 (初始状态 pending)<br>2. 创建任意类型工单 (快递收单/审核/沟通) | 1. 报销单状态从 pending 变为 processing | 高 |
| WF-CL-002 | 报销单状态从 processing 变为 close | 1. 报销单状态为 processing<br>2. 用户点击"处理完成"按钮 | 1. 报销单状态变为 close | 高 |
| WF-CL-003 | close状态下禁止创建新工单 | 1. 报销单状态为 close<br>2. 尝试创建新的审核工单<br>3. 尝试创建新的沟通工单 | 1. 系统阻止创建新工单<br>2. 显示提示信息 | 高 |
| WF-CL-004 | close状态下禁止修改现有工单 | 1. 报销单状态为 close，已有关联工单<br>2. 尝试修改现有审核工单的内容<br>3. 尝试修改现有沟通工单的内容 | 1. 系统阻止修改工单<br>2. 显示提示信息 | 高 |
## 7. 工单关联关系测试

NOTICE： 第一阶段不考虑多用户权限，先默认一个人可以操作所有环节简化权限逻辑

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| REL-001 | 工单与报销单关联 | 1. 创建报销单<br>2. 在报销单show页面创建审核工单<br>3. 在报销单show页面创建沟通工单 | 1. 所有工单都正确关联到报销单<br>2. 报销单可以访问到所有关联工单 | 高 |
| REL-002 | 一个报销单多个工单 | 1. 为同一报销单创建多个审核工单<br>2. 为同一报销单创建多个沟通工单 | 1. 所有工单都关联到同一报销单<br>2. 报销单详情页显示所有关联工单 | 高 |
| REL-003 | 工单、其固定的费用明细组、及其审核描述的关联 | 1. 创建报销单和费用明细A, B, C<br>2. 创建审核工单X，在创建时选择并固定关联费用明细A, B (记录于 `WorkOrderFeeDetails`)<br>3. 在工单X中添加问题P1 (选择费用类型和问题类型)，观察问题信息添加到审核描述<br>4. 在工单X中添加第二个问题P2 (选择不同的费用类型和问题类型)，观察问题信息追加到审核描述<br>5. 创建沟通工单Y，在创建时选择并固定关联费用明细B, C (记录于 `WorkOrderFeeDetails`)<br>6. 在工单Y中添加问题P3 (选择费用类型和问题类型)，观察问题信息添加到审核描述 | 1. 工单X与费用明细A, B通过`WorkOrderFeeDetails`正确关联 (此关联在工单X生命周期内固定)<br>2. 工单Y与费用明细B, C通过`WorkOrderFeeDetails`正确关联 (此关联在工单Y生命周期内固定)<br>3. 工单X的审核描述包含P1和P2的完整信息，两个问题之间用空行分隔。<br>4. 工单Y的审核描述包含P3的完整信息。<br>5. 逻辑上，P1和P2都应用于费用明细A和B。P3应用于费用明细B和C。<br>6. 费用明细B的详情页能反向追溯到影响它的工单X (及其审核描述中的问题P1,P2) 和工单Y (及其审核描述中的问题P3)。 | 高 |
| REL-004 | 报销单状态与费用明细最终状态联动（一票否决原则） | 1. 创建报销单R1和多个费用明细 (X, Y, Z)。<br>2. 创建审核工单W1，关联费用明细组 (X, Y)，添加问题P1a (针对X,Y)，工单W1处理意见为"无法通过" (`rejected`)。<br>3. 创建沟通工单W2，关联费用明细组 (Y, Z)，无问题或问题已解决，工单W2处理意见为"可以通过" (`approved`)。<br>4. 费用明细X的最终状态应为 `problematic` (受W1影响)。<br>5. 费用明细Y的最终状态应为 `problematic` (受W1影响，即使W2通过，一票否决)。<br>6. 费用明细Z的最终状态应为 `verified` (仅受W2影响)。<br>7. 若后续工单W1被修改为 `approved` (问题解决)，则费用明细X应变为 `verified`，费用明细Y应变为 `verified` (此时Y同时受W1-approved 和 W2-approved影响)。<br>8. 确认若所有与报销单R1关联的费用明细 (X,Y,Z) 最终状态均为 `verified`，用户在报销单详情页点击"处理完成"按钮。 | 1. 单个费用明细的最终状态 (`problematic`/`verified`)遵循"一票否决"原则：只要任一关联它的工单贡献了"不通过"的审计结论，则该费用明细最终为`problematic`；只有当所有影响它的工单都贡献"通过"的结论时，费用明细才为`verified`。<br>2. 报销单R1的状态在有`problematic`明细时不能通过"处理完成"变为`closed`（按钮可能禁用或操作失败）。<br>3. 当所有关联费用明细最终状态均为`verified`后，点击"处理完成"按钮，报销单状态成功变为 `closed`。 | 高 |
| REL-005 | 删除报销单对工单的影响 | 1. 创建报销单和关联工单（包含问题条目）<br>2. 删除报销单 | 1. 关联工单及问题条目也被删除或标记为无效<br>2. 系统处理级联删除 | 低 |
| REL-006 | 工单创建入口限制 | 1. 尝试在报销单show页面外创建审核工单<br>2. 尝试在报销单show页面外创建沟通工单 | 1. 系统阻止在报销单show页面外创建工单<br>2. 显示错误消息或重定向到报销单列表 | 中 |
| REL-007 | 工单之间无关联关系验证 | 1. 为同一报销单创建审核工单A和沟通工单B<br>2. 修改审核工单A的状态<br>3. 删除审核工单A | 1. 修改审核工单A状态不影响沟通工单B<br>2. 删除审核工单A后沟通工单B仍然存在且状态不变<br>3. 系统中不存在工单之间的直接关联 | 中 |
| REL-008 | 报销单 `close` 状态触发 | 1. 创建报销单和多个费用明细<br>2. 通过工单处理将所有费用明细设为verified<br>3. 用户点击"处理完成"按钮 | 1. 在点击"处理完成"按钮前，即使所有费用明细已verified，报销单状态仍为 processing (或 pending 如果没有工单创建)<br>2. 点击"处理完成"按钮后，报销单状态变为 `close` | 高 |
| REL-009 | 报销单 `close`状态下工单操作限制 | 1. 报销单进入 `close` 状态<br>2. 尝试创建新的审核/沟通工单<br>3. 尝试修改已有的审核/沟通工单 | 1. 新工单无法创建<br>2. 已有工单无法修改 | 高 |
## 8. 费用明细验证测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| FEE-001 | 在工单创建时选择并固定关联费用明细组 | 1. 在报销单show页面创建审核工单<br>2. 选择多个费用明细作为该工单的固定范围（记录于`WorkOrderScopedDetails`） | 1. 成功记录工单与其选择的"费用明细组"的关联。<br>2. 此关联在工单后续的生命周期中不可更改。 | 高 |
| FEE-002 | 批量全选关联费用明细 | 1. 导入报销单<br>2. 导入费用明细<br>3. 在报销单show页面创建审核工单，使用"全选"功能关联所有属于该报销单的费用明细 | 1. 所有相关费用明细被成功关联到工单<br>2. 初始验证状态同FEE-001 | 中 |
| FEE-003 | 工单结论对关联费用明细组的影响及最终状态判断（最新工单决定原则） | 1. 创建审核工单X并固定关联费用明细组G1 (包含明细A, B)。<br>2. 在工单X中添加一个或多个问题条目，使工单X的整体"处理意见"为"无法通过" (`rejected`)并保存。<br>3. 费用明细A和B因为工单X的`rejected`状态，其最终审计状态应判断为 `problematic`。<br>4. 假设另有一个工单Y也关联了费用明细A，且工单Y的处理意见为 `approved`，且工单Y的更新时间晚于工单X。费用明细A的最终状态应为 `verified` (因为最新的工单Y是approved)。<br>5. 后续将工单X的"处理意见"修改为"可以通过" (`approved`)并保存 (所有问题已解决)。<br>6. 此时，工单X成为最新的工单，费用明细A和B的最终状态均变为 `verified`。 | 1. 工单的处理意见会影响其关联的整个"费用明细组"中的每一条明细。<br>2. 单个费用明细的最终审计状态 (`problematic`/`verified`) 由最新关联的工单状态决定。 | 高 |
| FEE-004 | 单个费用明细被多个工单覆盖及其最终状态（最新工单决定原则） | 1. 创建审核工单A，关联费用明细X，添加问题，处理意见为"无法通过" (`rejected`)。<br>2. 创建沟通工单B，也关联费用明细X（无问题或问题已解决），处理意见为"可以通过" (`approved`)。<br>3. 验证费用明细X的最终状态。 | 1. 费用明细X成功关联到两个工单。<br>2. 费用明细X的最终状态为 `verified` (由于最新的工单B是`approved`状态)。<br>3. 如果后续工单A被修改，成为最新的工单，则费用明细X的最终状态将跟随工单A的状态变化。 | 高 |
| FEE-005 | 费用明细查看关联工单 | 1. 创建多个工单（包含不同的问题和处理意见）并关联同一费用明细<br>2. 查看该费用明细的详情或历史记录 | 1. 能清晰展示所有影响该费用明细的工单列表<br>2. 每个关联工单的审核描述（包含问题信息）和处理意见可见 | 高 |
| FEE-006 | 费用明细状态对报销单 `close` 状态的影响 | 1. 创建报销单和多个费用明细<br>2. 通过一个或多个工单的处理，确保所有与该报销单关联的费用明细状态均为 `verified`<br>3. 用户点击报销单的"处理完成"按钮 | 1. "处理完成"按钮的可用性可能依赖于所有费用明细达到 `verified` 状态<br>2. 点击"处理完成"后，报销单状态成功变为 `close` | 高 |
| FEE-007 | 工单内问题添加到审核描述 | 1. 创建审核工单并固定关联一组费用明细。<br>2. 在工单中添加一个问题：完成两级选择（费用类型, 问题类型）。<br>3. 观察系统自动将问题信息添加到审核描述文本，包含SOP描述和标准处理方法。<br>4. 保存工单。 | 1. 工单的审核描述文本中成功记录了该问题的完整信息，包括费用类型、问题类型、SOP描述和标准处理方法。 | 中 |
| FEE-008 | 通过工单标记费用明细问题 | 1. 创建审核工单并关联一组费用明细<br>2. 在工单中添加一个问题（通过两级下拉选择），观察问题信息添加到审核描述<br>3. 将该工单的"处理意见"设置为"无法通过" | 1. 与该工单关联的所有费用明细状态均更新为 `problematic`（假设这是最新的工单）<br>2. 工单内的问题信息（包括SOP描述和标准处理方法）被正确记录在审核描述中 | 高 |
| FEE-009 | 多工单对同一费用明细状态影响的冲突处理 | 1. 费用明细X关联工单A（处理意见"无法通过"，X状态problematic）<br>2. 后续，费用明细X又关联了工单B（处理意见"可以通过"）<br>3. 验证费用明细X的最终状态 | 1. 费用明细X的最终状态为 `verified` (因为最新工单B是approved)<br>2. 系统应明确使用工单的更新时间（updated_at）来确定哪个是最新工单 | 高 |
| FEE-010 | 费用明细受工单影响记录查看 | 1. 对同一费用明细执行多次不同工单操作（例如，工单A使其problematic，工单B使其verified）<br>2. 查看该费用明细的关联工单历史 | 1. 能够清晰追溯到是哪些工单（包含其审核描述中的问题信息和处理意见）在何时影响了该费用明细的状态变更 | 中 |

### 8.1 问题代码库管理测试

NOTICE: 测试问题代码库在系统中的管理功能（非导入功能）。

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| FEE-PCM-001 | 手动添加/修改问题代码 | 1. 进入问题代码管理界面<br>2. 尝试添加新的费用类型、问题类型（包括Code, Title, SOP, 标准处理）确保层级关联正确<br>3. 尝试修改已存在的问题代码的Title、SOP、标准处理等非Code文本字段<br>4. 验证Code字段的唯一性约束（如尝试添加重复Code） | 1. 新问题代码成功添加，两层级结构正确建立<br>2. 修改成功保存<br>3. 新增/修改的条目能正确反映在工单创建时的两级下拉选项中<br>4. 重复Code添加应被阻止或提示错误 | 高 |
| FEE-PCM-002 | 手动删除问题代码并验证影响 | 1. 进入问题代码管理界面<br>2. 尝试删除一个问题类型<br>3. 尝试删除一个有关联问题类型的费用类型（应有警告或阻止删除，或提供级联删除选项并警告）<br>4. 验证被成功删除的条目不再出现在工单问题选择下拉中 | 1. 删除操作按预期执行（简单删除或带警告的级联删除/阻止删除）<br>2. 已被删除的条目在新建工单时不再可选<br>3. 需明确已使用被删除代码的历史工单如何显示该问题（例如，显示旧的Code+Title，或标记为"已失效代码"） | 中 |

## 9. 集成测试场景

NOTICE：第一阶段暂时假设只有一个admin user，简化权限用户测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| INT-001 | 完整报销流程-快递收单到审核完成 | 1. 导入报销单（例如：个人单）<br>2. 导入快递收单（如果非电子发票）<br>3. 在报销单show页面创建审核工单，选择关联的费用明细<br>4. 在工单中添加问题：通过两级下拉选择（例如，费用类型选"00-月度交通费"，问题类型选"01-燃油费行程问题"或一个"无问题"的代码）<br>5. 观察系统自动将问题信息添加到审核描述文本<br>6. 将工单处理意见设为 approved<br>7. 用户点击"处理完成"按钮使报销单close | 1. 快递收单工单自动创建并完成（如适用）<br>2. 审核工单成功创建并标记为approved<br>3. 问题信息被正确记录在审核描述中<br>4. 关联的所有费用明细状态从pending变为verified (V1逻辑)<br>5. 报销单状态：pending -> processing (因创建工单) -> close (因点击按钮) | 高 |
| INT-002 | 完整报销流程-包含沟通处理 | 1. 导入报销单（例如：学术单）<br>2. 导入快递收单（如适用）<br>3. 在报销单show页面创建审核工单，选择关联费用明细<br>4. 添加问题P1（通过两级下拉选择一个实际问题），观察问题信息添加到审核描述<br>5. 处理意见设为 rejected<br>6. 观察费用明细状态（应为problematic）<br>7. 创建沟通工单，选择相同费用明细<br>8. 添加问题P2（可能针对P1的澄清或补充），观察问题信息添加到审核描述<br>9. 处理意见设为 approved (表示沟通后问题解决)<br>10. 观察费用明细状态（应为verified）<br>11. 用户点击"处理完成"按钮使报销单close | 1. 所有工单状态正确处理<br>2. 问题P1, P2被正确记录在各自工单的审核描述中<br>3. 费用明细状态先变为problematic (因工单A)，后变为verified (因工单B) (V1逻辑，整体工单意见驱动)<br>4. 报销单状态：pending -> processing (因创建工单) -> close (因点击按钮) | 高 |
|         |                                 |                                                              |                                                              |        |
| INT-004 | 费用明细多工单关联测试 | 1. 导入报销单和一组费用明细 (FD1, FD2)<br>2. 创建审核工单A，关联FD1, FD2。添加问题条目Q_A1。处理意见设为 rejected。<br>3. 创建沟通工单B，仅关联FD1。添加问题条目Q_B1。处理意见设为 approved。<br>4. 观察FD1和FD2的状态 | 1. FD1, FD2 初始因工单A变为problematic。<br>2. FD1 后因工单B变为verified (假设B的处理更新或优先)。<br>3. FD2 保持problematic (未被工单B覆盖)。<br>4. 费用明细状态跟随最新有效处理的、且覆盖该明细的工单状态变化 (V1逻辑，一个工单问题应用到其所有选定明细)。 | 高 |
| INT-005 | 操作历史影响报销单状态 | 1. 导入报销单<br>2. 创建并处理工单 (报销单状态变为 processing)，工单处理意见为 rejected (费用明细problematic)<br>3. 导入包含审批通过的操作历史数据 | 1. 报销单状态更新为 `close` (基于操作历史导入)<br>2. 工单状态和费用明细状态不受此操作历史导入影响，保持原样（rejected, problematic） | 中 |
|         |                                 |                                                              |                                                              |        |
| INT-007 | 多个报销单并行处理 | 1. 导入多个报销单<br>2. 对不同报销单并行创建工单、添加不同问题条目、设置不同处理意见<br>3. 观察系统行为 | 1. 各报销单及其关联工单、费用明细的处理互不影响<br>2. 所有工单状态正确处理，报销单状态正确流转 | 低 |
| INT-008 | 直接通过工单测试 | 1. 导入报销单和费用明细<br>2. 创建工单，关联费用明细，不添加任何问题或在审核描述中手动添加"无问题"说明，直接将处理意见设置为approved<br>3. 观察费用明细状态变化 | 1. 工单状态直接设置为approved<br>2. 关联的费用明细状态直接变为verified<br>3. 报销单状态变为 processing | 高 |
| INT-009 | 报销单关闭后工单操作限制测试 | 1. 导入报销单、快递单、费用明细<br>2. 创建审核/沟通工单 (报销单变为 processing)，添加问题到审核描述，处理工单<br>3. 用户点击"处理完成"按钮使报销单变为 close<br>4. 尝试创建新的审核/沟通工单<br>5. 尝试修改已存在的审核/沟通工单（包括修改审核描述或处理意见） | 1. 新工单无法创建<br>2. 已有工单无法修改<br>3. 报销单保持 close 状态 | 高 |
| INT-010 | 多问题添加到审核描述测试 | 1. 导入报销单，关联一组费用明细 (FD1, FD2)<br>2. 创建一个审核工单，关联FD1, FD2。<br>3. 选择第一组费用类型和问题类型组合（例如"00 - 月度交通费"和"01 - 燃油费行程问题"）。<br>4. 观察系统自动将该问题信息添加到审核描述文本区域。<br>5. 再次选择第二组不同的费用类型和问题类型组合（例如"03 - 电话费"和"02 - 电话费不合规"）。<br>6. 观察系统自动将第二个问题信息追加到审核描述末尾，并用空行与第一个问题分隔。<br>7. 手动编辑审核描述，添加一些自定义文本。<br>8. 将此工单的处理意见设置为"无法通过"。<br>9. 观察FD1, FD2状态。 | 1. 工单成功记录两个问题的完整信息（包括SOP描述和标准处理方法）在审核描述中，并用空行分隔。<br>2. 手动编辑的自定义文本被正确保存。<br>3. 由于工单整体处理意见为"无法通过"，FD1和FD2的状态均变为 problematic。<br>4. 报销单状态变为 processing。 | 高 |
## 10. 测试执行计划

测试执行计划将按照系统实施路线图分为四个主要阶段进行：

### 10.1 数据结构调整阶段测试（5月1日 - 5月4日）

| 测试活动 | 测试内容 | 时间安排 | 负责人 |
|---------|---------|---------|--------|
| 数据库迁移设计评审 | 评审数据库迁移脚本，确保符合设计要求 | 5月2日 | 测试负责人 |
| 数据库迁移测试 | 验证数据库迁移执行成功，表结构符合预期 | 5月4日 | 测试负责人 |
| 数据完整性测试 | 验证迁移后数据的完整性和一致性 | 5月4日 | 测试负责人 |

### 10.2 模型实现阶段测试（5月5日 - 5月12日）

| 测试活动 | 测试内容 | 时间安排 | 负责人 |
|---------|---------|---------|--------|
| 工单基类单元测试 | 测试WorkOrder基类的功能和方法 | 5月7日 | 测试负责人 |
| 审核工单单元测试 | 测试AuditWorkOrder的功能和与费用明细的联动 | 5月9日 | 测试负责人 |
| 沟通工单单元测试 | 测试CommunicationWorkOrder的功能（包括needs_communication标志）和与费用明细的联动 | 5月11日 | 测试负责人 |
| 快递收单工单单元测试 | 测试ExpressReceiptWorkOrder的功能和自动完成逻辑 | 5月12日 | 测试负责人 |

### 10.3 控制器与视图阶段测试（5月13日 - 5月23日）

| 测试活动 | 测试内容 | 时间安排 | 负责人 |
|---------|---------|---------|--------|
| 工单基础控制器测试 | 测试工单基础控制器的CRUD功能（考虑报销单close状态下的限制） | 5月15日 | 测试负责人 |
| 审核工单控制器与视图测试 | 测试审核工单的特定功能和界面展示 | 5月18日 | 测试负责人 |
| 沟通工单控制器与视图测试 | 测试沟通工单的特定功能和界面展示 | 5月21日 | 测试负责人 |
| 快递收单工单控制器与视图测试 | 测试快递收单工单的特定功能和界面展示 | 5月23日 | 测试负责人 |
| 报销单状态管理测试 | 测试报销单 pending, processing, close 状态流转及相关逻辑 (如REL-008, WF-CL系列用例) | 5月22日 | 测试负责人 |

### 10.4 测试与部署阶段（5月24日 - 6月1日）

| 测试活动 | 测试内容 | 时间安排 | 负责人 |
|---------|---------|---------|--------|
| 单元测试执行 | 执行所有单元测试，确保各模块功能正常 | 5月24日-26日 | 测试负责人 |
| 集成测试执行 | 执行集成测试，验证模块间交互正常 | 5月27日-29日 | 测试负责人 |
| 用户验收测试 | 执行用户验收测试，验证系统满足业务需求 | 5月30日-31日 | 测试负责人 |
| 部署前测试 | 在生产环境部署前进行最终测试 | 6月1日 | 测试负责人 |
| 表单结构一致性测试 | 执行INT-003测试用例 | 5月29日 | 测试负责人 |
## 11. 测试报告模板

### 11.1 测试报告概述

测试报告将包含以下内容：

1. **测试概述**：测试目标、范围和执行时间
2. **测试环境**：测试环境配置和版本信息
3. **测试结果摘要**：通过/失败测试用例数量和比例
4. **测试详情**：每个测试用例的执行结果和问题描述
5. **问题跟踪**：发现的缺陷及其严重程度和状态
6. **结论与建议**：测试结论和改进建议

### 11.2 缺陷报告模板

| 字段 | 描述 |
|------|------|
| 缺陷ID | 唯一标识符 |
| 缺陷标题 | 简短描述缺陷 |
| 严重程度 | 严重/高/中/低 |
| 优先级 | 高/中/低 |
| 状态 | 新建/已分配/已修复/已验证/已关闭 |
| 报告人 | 发现缺陷的测试人员 |
| 分配给 | 负责修复的开发人员 |
| 报告日期 | 缺陷报告日期 |
| 修复日期 | 缺陷修复日期 |
| 验证日期 | 缺陷验证日期 |
| 重现步骤 | 详细的重现步骤 |
| 预期结果 | 正确的预期行为 |
| 实际结果 | 实际观察到的行为 |
| 附件 | 截图或日志文件 |
| 备注 | 其他相关信息 |