# 快递收单导入服务实现

## 任务描述

实现快递收单导入服务（ExpressReceiptImportService），用于从CSV文件导入快递收单数据。该服务需要处理CSV文件解析、数据验证、快递收单创建，以及自动创建快递收单工单。服务还需要处理快递单号提取、报销单匹配等功能。

## 输入和依赖

- 已完成的报销单模型
- 已完成的快递收单工单模型
- CSV文件格式参考文档 (`docs/3.数据导入格式参考.md`)
- 服务实现设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的快递收单导入服务实现，包括：
- CSV文件解析功能
- 数据验证功能
- 快递单号提取功能
- 报销单匹配功能
- 快递收单创建功能
- 自动创建快递收单工单的功能
- 导入结果统计和错误处理
- 未匹配快递收单的手动匹配功能

## 详细实现步骤

### 1. 创建快递收单模型

首先，我们需要创建一个快递收单模型来存储快递收单的基本信息：

创建 `app/models/express_receipt.rb` 文件：

```ruby
# app/models/express_receipt.rb
class ExpressReceipt < ApplicationRecord
  # 关联
  belongs_to :reimbursement, foreign_key: 'document_number', primary_key: 'invoice_number', optional: true
  
  # 验证
  validates :document_number, presence: true
  validates :tracking_number, presence: true
  
  # 方法
  def reimbursement_found?
    reimbursement.present?
  end
  
  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id document_number tracking_number receive_date receiver courier_company created_at updated_at]
  end
  
  def self.ransackable_associations(auth_object = nil)
    %w[reimbursement]
  end
end
```

### 2. 创建快递收单导入服务

创建 `app/services/express_receipt_import_service.rb` 文件：

```ruby
# app/services/express_receipt_import_service.rb
require 'csv'

class ExpressReceiptImportService
  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @matched_count = 0
    @unmatched_count = 0
    @error_count = 0
    @errors = []
    @unmatched_receipts = []
  end
  
  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?
    
    begin
      CSV.foreach(@file.path, headers: true) do |row|
        import_express_receipt(row)
      end
      
      {
        success: true,
        matched: @matched_count,
        unmatched: @unmatched_count,
        errors: @error_count,
        error_details: @errors,
        unmatched_receipts: @unmatched_receipts
      }
    rescue => e
      { success: false, errors: [e.message] }
    end
  end
  
  def manual_match(express_receipt_id, reimbursement_id)
    express_receipt = ExpressReceipt.find(express_receipt_id)
    reimbursement = Reimbursement.find(reimbursement_id)
    
    # 更新快递收单的单据号
    if express_receipt.update(document_number: reimbursement.invoice_number)
      # 更新报销单收单状态
      reimbursement.mark_as_received(express_receipt.receive_date)
      
      # 创建工单
      create_express_receipt_work_order(express_receipt, reimbursement)
      
      return { success: true }
    else
      return { success: false, errors: express_receipt.errors.full_messages }
    end
  end
  
  private
  
  def import_express_receipt(row)
    document_number = extract_document_number(row)
    tracking_number = extract_tracking_number(row)
    
    # 检查必要字段
    unless document_number.present? && tracking_number.present?
      @error_count += 1
      @errors << "行 #{$.}: 单据号或快递单号不能为空"
      return
    end
    
    # 查找对应的报销单
    reimbursement = Reimbursement.find_by(invoice_number: document_number)
    
    if reimbursement
      # 创建快递收单记录并关联到报销单
      express_receipt = ExpressReceipt.create!(
        document_number: document_number,
        tracking_number: tracking_number,
        receive_date: parse_date(row['操作时间']),
        receiver: row['操作人'] || @current_admin_user.email,
        courier_company: extract_courier_company(row)
      )
      
      # 更新报销单收单状态
      reimbursement.mark_as_received(express_receipt.receive_date)
      
      # 创建工单
      create_express_receipt_work_order(express_receipt, reimbursement)
      
      @matched_count += 1
    else
      # 记录未匹配的快递单
      @unmatched_count += 1
      @unmatched_receipts << {
        original_data: row.to_h,
        document_number: document_number,
        tracking_number: tracking_number
      }
    end
  end
  
  def create_express_receipt_work_order(express_receipt, reimbursement)
    ExpressReceiptWorkOrder.create!(
      reimbursement: reimbursement,
      status: 'received',
      tracking_number: express_receipt.tracking_number,
      received_at: express_receipt.receive_date,
      courier_name: express_receipt.courier_company,
      created_by: @current_admin_user.id
    )
  end
  
  def extract_document_number(row)
    row['单号'] || row['单据编号'] || ''
  end
  
  def extract_tracking_number(row)
    if row['操作意见'].present? && row['操作意见'] =~ /快递单号[：:]\s*(\w+)/
      $1.strip
    else
      "未知-#{Time.now.to_i}"
    end
  end
  
  def extract_courier_company(row)
    if row['操作意见'].present?
      if row['操作意见'].include?('顺丰')
        '顺丰'
      elsif row['操作意见'].include?('圆通')
        '圆通'
      elsif row['操作意见'].include?('中通')
        '中通'
      elsif row['操作意见'].include?('申通')
        '申通'
      elsif row['操作意见'].include?('韵达')
        '韵达'
      else
        '其他'
      end
    else
      '未知'
    end
  end
  
  def parse_date(date_string)
    return nil unless date_string.present?
    begin
      DateTime.parse(date_string)
    rescue
      DateTime.now
    end
  end
end
```

### 3. 创建快递收单导入控制器

创建 `app/controllers/admin/express_receipt_imports_controller.rb` 文件：

```ruby
# app/controllers/admin/express_receipt_imports_controller.rb
module Admin
  class ExpressReceiptImportsController < ApplicationController
    def new
      render 'admin/express_receipt_imports/new'
    end
    
    def create
      service = ExpressReceiptImportService.new(params[:file], current_admin_user)
      result = service.import
      
      if result[:success]
        if result[:unmatched] > 0
          session[:unmatched_receipts] = result[:unmatched_receipts]
          redirect_to unmatched_admin_express_receipt_imports_path, notice: "成功导入 #{result[:matched]} 条记录，有 #{result[:unmatched]} 条记录未匹配到报销单"
        else
          redirect_to admin_express_receipts_path, notice: "成功导入 #{result[:matched]} 条记录"
        end
      else
        flash[:alert] = "导入失败: #{result[:errors].join(', ')}"
        render 'admin/express_receipt_imports/new'
      end
    end
    
    def unmatched
      @unmatched_receipts = session[:unmatched_receipts] || []
      @reimbursements = Reimbursement.all
    end
    
    def manual_match
      service = ExpressReceiptImportService.new(nil, current_admin_user)
      result = service.manual_match(params[:express_receipt_id], params[:reimbursement_id])
      
      if result[:success]
        redirect_to admin_express_receipts_path, notice: "成功匹配快递收单"
      else
        redirect_to unmatched_admin_express_receipt_imports_path, alert: "匹配失败: #{result[:errors].join(', ')}"
      end
    end
  end
end
```

### 4. 创建快递收单导入视图

创建 `app/views/admin/express_receipt_imports/new.html.erb` 文件：

```erb
<!-- app/views/admin/express_receipt_imports/new.html.erb -->
<h2>导入快递收单</h2>

<%= form_tag admin_express_receipt_imports_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择CSV文件</th>
            <td><%= file_field_tag :file, accept: '.csv' %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_express_receipts_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV文件应包含以下列：</p>
    <ul>
      <li>单号/单据编号（必填）</li>
      <li>操作人</li>
      <li>操作时间</li>
      <li>操作意见（包含快递单号信息）</li>
    </ul>
  </div>
</div>
```

创建 `app/views/admin/express_receipt_imports/unmatched.html.erb` 文件：

```erb
<!-- app/views/admin/express_receipt_imports/unmatched.html.erb -->
<h2>未匹配的快递收单</h2>

<div class="panel">
  <div class="panel_contents">
    <table class="index_table">
      <thead>
        <tr>
          <th>单据号</th>
          <th>快递单号</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <% @unmatched_receipts.each_with_index do |receipt, index| %>
          <tr>
            <td><%= receipt['document_number'] %></td>
            <td><%= receipt['tracking_number'] %></td>
            <td>
              <%= form_tag manual_match_admin_express_receipt_imports_path, method: :post do %>
                <%= hidden_field_tag :express_receipt_id, index %>
                <%= select_tag :reimbursement_id, options_from_collection_for_select(@reimbursements, :id, :invoice_number) %>
                <%= submit_tag "匹配", class: "button" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<div class="actions">
  <%= link_to "返回", admin_express_receipts_path, class: "button" %>
</div>
```

### 5. 更新路由配置

修改 `config/routes.rb` 文件，添加快递收单导入路由：

```ruby
# config/routes.rb
Rails.application.routes.draw do
  # ...
  
  namespace :admin do
    resources :express_receipts do
      collection do
        resources :express_receipt_imports, only: [:new, :create] do
          collection do
            get :unmatched
            post :manual_match
          end
        end
      end
    end
    # ...
  end
  
  # ...
end
```

### 6. 更新 ActiveAdmin 配置

创建 `app/admin/express_receipts.rb` 文件：

```ruby
# app/admin/express_receipts.rb
ActiveAdmin.register ExpressReceipt do
  # 权限控制
  permit_params :document_number, :tracking_number, :receive_date, :receiver, :courier_company
  
  # 菜单设置
  menu priority: 2, label: "快递收单"
  
  # 过滤器
  filter :document_number
  filter :tracking_number
  filter :receive_date
  filter :receiver
  filter :courier_company
  filter :created_at
  
  # 自定义操作
  action_item :import, only: :index do
    link_to "导入快递收单", new_admin_express_receipt_import_path
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :document_number
    column :tracking_number
    column :receive_date
    column :receiver
    column :courier_company
    column :created_at
    actions
  end
  
  # 详情页
  show do
    attributes_table do
      row :id
      row :document_number
      row :reimbursement do |express_receipt|
        if express_receipt.reimbursement.present?
          link_to express_receipt.reimbursement.invoice_number, admin_reimbursement_path(express_receipt.reimbursement)
        end
      end
      row :tracking_number
      row :receive_date
      row :receiver
      row :courier_company
      row :created_at
      row :updated_at
    end
    
    panel "关联的工单" do
      if express_receipt.reimbursement.present?
        table_for express_receipt.reimbursement.express_receipt_work_orders do
          column :id
          column :status
          column :received_at
          column :created_at
          column "操作" do |work_order|
            link_to "查看", admin_express_receipt_work_order_path(work_order)
          end
        end
      else
        para "没有关联的工单"
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "快递收单信息" do
      f.input :document_number
      f.input :tracking_number
      f.input :receive_date, as: :datepicker
      f.input :receiver
      f.input :courier_company
    end
    f.actions
  end
end
```

### 7. 创建快递收单导入服务测试

创建 `spec/services/express_receipt_import_service_spec.rb` 文件：

```ruby
# spec/services/express_receipt_import_service_spec.rb
require 'rails_helper'

RSpec.describe ExpressReceiptImportService do
  let(:admin_user) { create(:admin_user) }
  let(:csv_file) { fixture_file_upload('files/test_express_receipts.csv', 'text/csv') }
  
  describe '#import' do
    context 'with valid file' do
      before do
        # 创建测试报销单
        @reimbursement = create(:reimbursement, invoice_number: 'R20250101001')
        
        # 创建测试CSV文件
        CSV.open(Rails.root.join('spec/fixtures/files/test_express_receipts.csv'), 'w') do |csv|
          csv << ['单号', '操作人', '操作时间', '操作意见']
          csv << ['R20250101001', '张三', '2025-01-01 10:00:00', '收到快递，快递单号: SF1234567890，顺丰快递']
          csv << ['R20250101002', '李四', '2025-01-02 10:00:00', '收到快递，快递单号: YT9876543210，圆通快递']
        end
      end
      
      after do
        # 删除测试CSV文件
        File.delete(Rails.root.join('spec/fixtures/files/test_express_receipts.csv')) if File.exist?(Rails.root.join('spec/fixtures/files/test_express_receipts.csv'))
      end
      
      it 'creates express receipts and work orders for matched reimbursements' do
        service = ExpressReceiptImportService.new(csv_file, admin_user)
        
        expect {
          result = service.import
          expect(result[:success]).to be true
          expect(result[:matched]).to eq(1)
          expect(result[:unmatched]).to eq(1)
          expect(result[:errors]).to eq(0)
        }.to change(ExpressReceipt, :count).by(2)
          .and change(ExpressReceiptWorkOrder, :count).by(1)
        
        # 验证快递收单记录
        express_receipt = ExpressReceipt.find_by(document_number: 'R20250101001')
        expect(express_receipt.tracking_number).to eq('SF1234567890')
        expect(express_receipt.courier_company).to eq('顺丰')
        
        # 验证报销单状态
        @reimbursement.reload
        expect(@reimbursement.receipt_status).to eq('received')
        
        # 验证工单创建
        work_order = ExpressReceiptWorkOrder.last
        expect(work_order.reimbursement).to eq(@reimbursement)
        expect(work_order.status).to eq('received')
        expect(work_order.tracking_number).to eq('SF1234567890')
      end
      
      it 'records unmatched receipts' do
        service = ExpressReceiptImportService.new(csv_file, admin_user)
        result = service.import
        
        expect(result[:unmatched]).to eq(1)
        expect(result[:unmatched_receipts].size).to eq(1)
        expect(result[:unmatched_receipts][0]['document_number']).to eq('R20250101002')
        expect(result[:unmatched_receipts][0]['tracking_number']).to eq('YT9876543210')
      end
    end
    
    context 'with invalid file' do
      it 'returns error when file is nil' do
        service = ExpressReceiptImportService.new(nil, admin_user)
        result = service.import
        
        expect(result[:success]).to be false
        expect(result[:errors]).to include("文件不存在")
      end
      
      it 'handles CSV parsing errors' do
        invalid_file = fixture_file_upload('files/invalid.csv', 'text/csv')
        
        # 创建无效的CSV文件
        File.open(Rails.root.join('spec/fixtures/files/invalid.csv'), 'w') do |file|
          file.write("This is not a valid CSV file")
        end
        
        service = ExpressReceiptImportService.new(invalid_file, admin_user)
        result = service.import
        
        expect(result[:success]).to be false
        expect(result[:errors]).to be_present
        
        # 删除测试文件
        File.delete(Rails.root.join('spec/fixtures/files/invalid.csv')) if File.exist?(Rails.root.join('spec/fixtures/files/invalid.csv'))
      end
    end
  end
  
  describe '#manual_match' do
    before do
      @reimbursement = create(:reimbursement, invoice_number: 'R20250101001')
      @express_receipt = create(:express_receipt, document_number: 'R20250101002', tracking_number: 'SF1234567890')
    end
    
    it 'matches express receipt to reimbursement' do
      service = ExpressReceiptImportService.new(nil, admin_user)
      
      expect {
        result = service.manual_match(@express_receipt.id, @reimbursement.id)
        expect(result[:success]).to be true
      }.to change(ExpressReceiptWorkOrder, :count).by(1)
      
      # 验证快递收单更新
      @express_receipt.reload
      expect(@express_receipt.document_number).to eq('R20250101001')
      
      # 验证报销单状态
      @reimbursement.reload
      expect(@reimbursement.receipt_status).to eq('received')
      
      # 验证工单创建
      work_order = ExpressReceiptWorkOrder.last
      expect(work_order.reimbursement).to eq(@reimbursement)
      expect(work_order.status).to eq('received')
      expect(work_order.tracking_number).to eq('SF1234567890')
    end
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/services/express_receipt_import_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：
   ```ruby
   # 创建测试报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false
   )
   
   # 创建测试CSV文件
   require 'csv'
   CSV.open('tmp/test_express_receipts.csv', 'w') do |csv|
     csv << ['单号', '操作人', '操作时间', '操作意见']
     csv << ['R20250101001', '张三', '2025-01-01 10:00:00', '收到快递，快递单号: SF1234567890，顺丰快递']
     csv << ['R20250101002', '李四', '2025-01-02 10:00:00', '收到快递，快递单号: YT9876543210，圆通快递']
   end
   
   # 创建测试文件对象
   file = File.open('tmp/test_express_receipts.csv')
   def file.original_filename; 'test_express_receipts.csv'; end
   def file.content_type; 'text/csv'; end
   
   # 创建管理员用户
   admin_user = AdminUser.first || AdminUser.create!(email: 'admin@example.com', password: 'password')
   
   # 测试导入服务
   service = ExpressReceiptImportService.new(file, admin_user)
   result = service.import
   
   # 检查结果
   puts "导入结果: #{result.inspect}"
   puts "创建的快递收单数量: #{ExpressReceipt.count}"
   puts "创建的快递收单工单数量: #{ExpressReceiptWorkOrder.count}"
   puts "未匹配的快递收单数量: #{result[:unmatched]}"
   
   # 检查报销单状态
   reimbursement.reload
   puts "报销单收单状态: #{reimbursement.receipt_status}"
   puts "报销单收单日期: #{reimbursement.receipt_date}"
   
   # 测试手动匹配
   if result[:unmatched] > 0
     # 创建另一个报销单
     reimbursement2 = Reimbursement.create!(
       invoice_number: "R20250101002",
       document_name: "测试报销单2",
       applicant: "李四",
       applicant_id: "EMP002",
       company: "测试公司",
       department: "财务部",
       amount: 2000.00,
       is_electronic: false
     )
     
     # 获取未匹配的快递收单
     unmatched_receipt = ExpressReceipt.find_by(document_number: 'R20250101002')
     
     # 手动匹配
     result = service.manual_match(unmatched_receipt.id, reimbursement2.id)
     puts "手动匹配结果: #{result.inspect}"
     
     # 检查报销单状态
     reimbursement2.reload
     puts "报销单2收单状态: #{reimbursement2.receipt_status}"
     puts "报销单2收单日期: #{reimbursement2.receipt_date}"
     
     # 检查工单创建
     puts "报销单2关联的工单数量: #{reimbursement2.express_receipt_work_orders.count}"
   end
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试快递收单导入功能

## 注意事项

1. 确保CSV文件解析功能正确实现，特别是处理中文字符和日期格式
2. 确保快递单号提取功能正确实现，特别是从操作意见中提取快递单号
3. 确保报销单匹配功能正确实现，特别是处理未匹配的情况
4. 确保快递收单创建功能正确实现，特别是设置正确的快递公司信息
5. 确保自动创建快递收单工单的功能正确实现，特别是设置正确的初始状态
6. 确保导入结果统计和错误处理功能正确实现，特别是提供详细的错误信息
7. 确保未匹配快递收单的手动匹配功能正确实现，特别是更新报销单状态和创建工单