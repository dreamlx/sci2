# 工单状态变更服务实现

## 任务描述

实现工单状态变更服务（WorkOrderStatusChangeService），用于记录工单状态变更历史和查询工单状态变更记录。该服务是工单系统的辅助业务逻辑，负责跟踪工单状态的变化，便于审计和问题排查。

## 输入和依赖

- 已完成的工单状态变更模型
- 已完成的快递收单工单模型
- 已完成的审核工单模型
- 已完成的沟通工单模型
- 服务实现设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的工单状态变更服务实现，包括：
- 记录状态变更功能
- 查询状态变更记录功能
- 错误处理和验证功能

## 详细实现步骤

### 1. 创建工单状态变更服务

创建 `app/services/work_order_status_change_service.rb` 文件：

```ruby
# app/services/work_order_status_change_service.rb
class WorkOrderStatusChangeService
  def initialize(current_admin_user)
    @current_admin_user = current_admin_user
  end
  
  def record_status_change(work_order, from_status, to_status, reason = nil)
    work_order_type = case work_order
                      when ExpressReceiptWorkOrder
                        'express_receipt'
                      when AuditWorkOrder
                        'audit'
                      when CommunicationWorkOrder
                        'communication'
                      else
                        raise ArgumentError, "未知的工单类型: #{work_order.class.name}"
                      end
    
    WorkOrderStatusChange.create!(
      work_order_type: work_order_type,
      work_order_id: work_order.id,
      from_status: from_status,
      to_status: to_status,
      changed_at: Time.current,
      changed_by: @current_admin_user.id,
      reason: reason
    )
  end
  
  def get_status_changes(work_order)
    work_order_type = case work_order
                      when ExpressReceiptWorkOrder
                        'express_receipt'
                      when AuditWorkOrder
                        'audit'
                      when CommunicationWorkOrder
                        'communication'
                      else
                        raise ArgumentError, "未知的工单类型: #{work_order.class.name}"
                      end
    
    WorkOrderStatusChange.where(
      work_order_type: work_order_type,
      work_order_id: work_order.id
    ).order(changed_at: :desc)
  end
  
  def get_status_changes_by_type(work_order_type, work_order_id)
    WorkOrderStatusChange.where(
      work_order_type: work_order_type,
      work_order_id: work_order_id
    ).order(changed_at: :desc)
  end
  
  def get_recent_status_changes(limit = 10)
    WorkOrderStatusChange.order(changed_at: :desc).limit(limit)
  end
  
  def get_status_changes_by_admin_user(admin_user_id, limit = 50)
    WorkOrderStatusChange.where(changed_by: admin_user_id)
                         .order(changed_at: :desc)
                         .limit(limit)
  end
end
```

### 2. 更新工单模型中的状态变更记录逻辑

修改 `app/models/express_receipt_work_order.rb` 文件，更新状态变更记录逻辑：

```ruby
# app/models/express_receipt_work_order.rb
class ExpressReceiptWorkOrder < ApplicationRecord
  # 其他代码...
  
  # 回调
  after_save :record_status_change, if: :saved_change_to_status?
  
  # 其他代码...
  
  private
  
  def record_status_change
    if saved_change_to_status?
      old_status, new_status = saved_change_to_status
      
      # 使用服务记录状态变更
      WorkOrderStatusChangeService.new(Current.admin_user).record_status_change(
        self,
        old_status,
        new_status,
        nil
      )
    end
  end
end
```

修改 `app/models/audit_work_order.rb` 文件，更新状态变更记录逻辑：

```ruby
# app/models/audit_work_order.rb
class AuditWorkOrder < ApplicationRecord
  # 其他代码...
  
  # 回调
  after_save :record_status_change, if: :saved_change_to_status?
  
  # 其他代码...
  
  private
  
  def record_status_change
    if saved_change_to_status?
      old_status, new_status = saved_change_to_status
      
      # 使用服务记录状态变更
      WorkOrderStatusChangeService.new(Current.admin_user).record_status_change(
        self,
        old_status,
        new_status,
        nil
      )
    end
  end
end
```

修改 `app/models/communication_work_order.rb` 文件，更新状态变更记录逻辑：

```ruby
# app/models/communication_work_order.rb
class CommunicationWorkOrder < ApplicationRecord
  # 其他代码...
  
  # 回调
  after_save :record_status_change, if: :saved_change_to_status?
  
  # 其他代码...
  
  private
  
  def record_status_change
    if saved_change_to_status?
      old_status, new_status = saved_change_to_status
      
      # 使用服务记录状态变更
      WorkOrderStatusChangeService.new(Current.admin_user).record_status_change(
        self,
        old_status,
        new_status,
        nil
      )
    end
  end
end
```

### 3. 创建工单状态变更控制器

创建 `app/controllers/admin/work_order_status_changes_controller.rb` 文件：

```ruby
# app/controllers/admin/work_order_status_changes_controller.rb
module Admin
  class WorkOrderStatusChangesController < ApplicationController
    def index
      @work_order_status_changes = WorkOrderStatusChange.order(changed_at: :desc).page(params[:page]).per(30)
    end
    
    def show
      @work_order_status_change = WorkOrderStatusChange.find(params[:id])
    end
    
    def by_work_order
      work_order_type = params[:work_order_type]
      work_order_id = params[:work_order_id]
      
      @work_order_status_changes = WorkOrderStatusChangeService.new(current_admin_user)
                                                              .get_status_changes_by_type(work_order_type, work_order_id)
      
      render :index
    end
    
    def by_admin_user
      admin_user_id = params[:admin_user_id]
      
      @work_order_status_changes = WorkOrderStatusChangeService.new(current_admin_user)
                                                              .get_status_changes_by_admin_user(admin_user_id)
      
      render :index
    end
    
    def recent
      @work_order_status_changes = WorkOrderStatusChangeService.new(current_admin_user)
                                                              .get_recent_status_changes(30)
      
      render :index
    end
  end
end
```

### 4. 更新路由配置

修改 `config/routes.rb` 文件，添加工单状态变更路由：

```ruby
# config/routes.rb
Rails.application.routes.draw do
  # ...
  
  namespace :admin do
    resources :work_order_status_changes, only: [:index, :show] do
      collection do
        get :by_work_order
        get :by_admin_user
        get :recent
      end
    end
    # ...
  end
  
  # ...
end
```

### 5. 创建工单状态变更服务测试

创建 `spec/services/work_order_status_change_service_spec.rb` 文件：

```ruby
# spec/services/work_order_status_change_service_spec.rb
require 'rails_helper'

RSpec.describe WorkOrderStatusChangeService do
  let(:admin_user) { create(:admin_user) }
  let(:service) { WorkOrderStatusChangeService.new(admin_user) }
  
  describe '#record_status_change' do
    let(:reimbursement) { create(:reimbursement) }
    
    context 'with express receipt work order' do
      let(:work_order) { create(:express_receipt_work_order, reimbursement: reimbursement, status: 'received') }
      
      it 'creates a status change record' do
        expect {
          service.record_status_change(work_order, 'received', 'processed')
        }.to change(WorkOrderStatusChange, :count).by(1)
        
        status_change = WorkOrderStatusChange.last
        expect(status_change.work_order_type).to eq('express_receipt')
        expect(status_change.work_order_id).to eq(work_order.id)
        expect(status_change.from_status).to eq('received')
        expect(status_change.to_status).to eq('processed')
        expect(status_change.changed_by).to eq(admin_user.id)
      end
    end
    
    context 'with audit work order' do
      let(:work_order) { create(:audit_work_order, reimbursement: reimbursement, status: 'pending') }
      
      it 'creates a status change record' do
        expect {
          service.record_status_change(work_order, 'pending', 'processing')
        }.to change(WorkOrderStatusChange, :count).by(1)
        
        status_change = WorkOrderStatusChange.last
        expect(status_change.work_order_type).to eq('audit')
        expect(status_change.work_order_id).to eq(work_order.id)
        expect(status_change.from_status).to eq('pending')
        expect(status_change.to_status).to eq('processing')
        expect(status_change.changed_by).to eq(admin_user.id)
      end
    end
    
    context 'with communication work order' do
      let(:audit_work_order) { create(:audit_work_order, reimbursement: reimbursement) }
      let(:work_order) { create(:communication_work_order, reimbursement: reimbursement, audit_work_order: audit_work_order, status: 'open') }
      
      it 'creates a status change record' do
        expect {
          service.record_status_change(work_order, 'open', 'in_progress')
        }.to change(WorkOrderStatusChange, :count).by(1)
        
        status_change = WorkOrderStatusChange.last
        expect(status_change.work_order_type).to eq('communication')
        expect(status_change.work_order_id).to eq(work_order.id)
        expect(status_change.from_status).to eq('open')
        expect(status_change.to_status).to eq('in_progress')
        expect(status_change.changed_by).to eq(admin_user.id)
      end
    end
    
    context 'with invalid work order type' do
      it 'raises an error' do
        expect {
          service.record_status_change(Object.new, 'old', 'new')
        }.to raise_error(ArgumentError, /未知的工单类型/)
      end
    end
  end
  
  describe '#get_status_changes' do
    let(:reimbursement) { create(:reimbursement) }
    let(:work_order) { create(:express_receipt_work_order, reimbursement: reimbursement) }
    
    before do
      # 创建多条状态变更记录
      create(:work_order_status_change, work_order_type: 'express_receipt', work_order_id: work_order.id, from_status: nil, to_status: 'received', changed_at: 3.days.ago)
      create(:work_order_status_change, work_order_type: 'express_receipt', work_order_id: work_order.id, from_status: 'received', to_status: 'processed', changed_at: 2.days.ago)
      create(:work_order_status_change, work_order_type: 'express_receipt', work_order_id: work_order.id, from_status: 'processed', to_status: 'completed', changed_at: 1.day.ago)
      
      # 创建其他工单的状态变更记录
      other_work_order = create(:express_receipt_work_order, reimbursement: reimbursement)
      create(:work_order_status_change, work_order_type: 'express_receipt', work_order_id: other_work_order.id, from_status: nil, to_status: 'received')
    end
    
    it 'returns status changes for the specified work order' do
      status_changes = service.get_status_changes(work_order)
      
      expect(status_changes.count).to eq(3)
      expect(status_changes.first.to_status).to eq('completed')
      expect(status_changes.last.to_status).to eq('received')
    end
  end
  
  describe '#get_recent_status_changes' do
    before do
      # 创建多条状态变更记录
      5.times do |i|
        create(:work_order_status_change, changed_at: i.days.ago)
      end
    end
    
    it 'returns the most recent status changes' do
      status_changes = service.get_recent_status_changes(3)
      
      expect(status_changes.count).to eq(3)
      expect(status_changes.first.changed_at).to be > status_changes.last.changed_at
    end
  end
  
  describe '#get_status_changes_by_admin_user' do
    let(:admin_user1) { create(:admin_user) }
    let(:admin_user2) { create(:admin_user) }
    
    before do
      # 创建多条状态变更记录
      3.times do
        create(:work_order_status_change, changed_by: admin_user1.id)
      end
      
      2.times do
        create(:work_order_status_change, changed_by: admin_user2.id)
      end
    end
    
    it 'returns status changes for the specified admin user' do
      status_changes = service.get_status_changes_by_admin_user(admin_user1.id)
      
      expect(status_changes.count).to eq(3)
      status_changes.each do |change|
        expect(change.changed_by).to eq(admin_user1.id)
      end
    end
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/services/work_order_status_change_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：
   ```ruby
   # 创建测试报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false,
     is_complete: false,
     reimbursement_status: 'processing'
   )
   
   # 创建测试快递收单工单
   express_receipt_work_order = ExpressReceiptWorkOrder.create!(
     reimbursement: reimbursement,
     status: 'received',
     tracking_number: 'SF1234567890',
     received_at: Time.current,
     courier_name: '顺丰',
     created_by: 1
   )
   
   # 创建管理员用户
   admin_user = AdminUser.first || AdminUser.create!(email: 'admin@example.com', password: 'password')
   
   # 创建服务实例
   service = WorkOrderStatusChangeService.new(admin_user)
   
   # 测试记录状态变更
   service.record_status_change(express_receipt_work_order, 'received', 'processed', '手动处理')
   puts "状态变更记录数: #{WorkOrderStatusChange.count}"
   
   # 测试查询状态变更记录
   status_changes = service.get_status_changes(express_receipt_work_order)
   puts "工单状态变更记录数: #{status_changes.count}"
   status_changes.each do |change|
     puts "从 #{change.from_status} 变更为 #{change.to_status}，时间: #{change.changed_at}，操作人: #{change.changed_by}"
   end
   
   # 测试查询最近状态变更记录
   recent_changes = service.get_recent_status_changes(5)
   puts "最近状态变更记录数: #{recent_changes.count}"
   
   # 测试查询管理员状态变更记录
   admin_changes = service.get_status_changes_by_admin_user(admin_user.id)
   puts "管理员状态变更记录数: #{admin_changes.count}"
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试工单状态变更记录功能

## 注意事项

1. 确保状态变更记录功能正确实现，特别是工单类型的判断和记录的创建
2. 确保查询状态变更记录功能正确实现，特别是按工单、按管理员和最近记录的查询
3. 确保错误处理和验证功能正确实现，特别是非法工单类型的处理
4. 确保服务与模型的交互正确实现，特别是在模型回调中使用服务记录状态变更
5. 确保服务与控制器的交互正确实现，特别是参数的传递和结果的处理
6. 注意工单状态变更记录是系统的重要审计信息，需要确保记录的完整性和准确性