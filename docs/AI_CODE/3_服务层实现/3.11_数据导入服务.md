# 数据导入服务实现

## 任务描述

实现四种数据导入服务：报销单导入服务（ReimbursementImportService）、快递收单导入服务（ExpressReceiptImportService）、费用明细导入服务（FeeDetailImportService）和操作历史导入服务（OperationHistoryImportService）。这些服务是工单系统的核心业务逻辑，负责从CSV文件中导入数据，并根据业务规则创建相应的记录和工单。

## 输入和依赖

- 已完成的报销单模型
- 已完成的快递收单模型
- 已完成的费用明细模型
- 已完成的操作历史模型
- 已完成的快递收单工单模型
- 已完成的审核工单模型
- 已完成的沟通工单模型
- 服务实现设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的数据导入服务实现，包括：
- 报销单导入服务
- 快递收单导入服务
- 费用明细导入服务
- 操作历史导入服务
- 导入顺序验证功能
- 错误处理和验证功能

## 详细实现步骤

### 1. 创建报销单导入服务

创建 `app/services/reimbursement_import_service.rb` 文件：

```ruby
# app/services/reimbursement_import_service.rb
class ReimbursementImportService
  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @created_count = 0
    @updated_count = 0
    @error_count = 0
    @errors = []
  end
  
  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?
    
    begin
      CSV.foreach(@file.path, headers: true) do |row|
        import_reimbursement(row)
      end
      
      {
        success: true,
        created: @created_count,
        updated: @updated_count,
        errors: @error_count,
        error_details: @errors
      }
    rescue => e
      { success: false, errors: [e.message] }
    end
  end
  
  private
  
  def import_reimbursement(row)
    invoice_number = row['报销单单号']
    
    # 检查必要字段
    unless invoice_number.present?
      @error_count += 1
      @errors << "行 #{$.}: 报销单单号不能为空"
      return
    end
    
    # 查找或创建报销单
    reimbursement = Reimbursement.find_by(invoice_number: invoice_number)
    
    if reimbursement
      # 更新现有报销单
      update_reimbursement(reimbursement, row)
    else
      # 创建新报销单
      create_reimbursement(row)
    end
  end
  
  def create_reimbursement(row)
    reimbursement = Reimbursement.new(
      invoice_number: row['报销单单号'],
      document_name: row['单据名称'],
      applicant: row['报销单申请人'],
      applicant_id: row['报销单申请人工号'],
      company: row['申请人公司'],
      department: row['申请人部门'],
      amount: row['报销金额（单据币种）'],
      receipt_status: parse_receipt_status(row['收单状态']),
      reimbursement_status: parse_reimbursement_status(row['报销单状态']),
      receipt_date: parse_date(row['收单日期']),
      submission_date: parse_date(row['提交报销日期']),
      is_electronic: row['单据标签']&.include?('全电子发票'),
      is_complete: parse_reimbursement_status(row['报销单状态']) == 'closed'
    )
    
    if reimbursement.save
      @created_count += 1
      
      # 如果是非电子发票且未收单，创建审核工单
      if !reimbursement.is_electronic && reimbursement.receipt_status != 'received'
        create_audit_work_order(reimbursement)
      end
    else
      @error_count += 1
      @errors << "行 #{$.}: #{reimbursement.errors.full_messages.join(', ')}"
    end
  end
  
  def update_reimbursement(reimbursement, row)
    # 更新报销单属性
    reimbursement.assign_attributes(
      document_name: row['单据名称'] || reimbursement.document_name,
      applicant: row['报销单申请人'] || reimbursement.applicant,
      applicant_id: row['报销单申请人工号'] || reimbursement.applicant_id,
      company: row['申请人公司'] || reimbursement.company,
      department: row['申请人部门'] || reimbursement.department,
      amount: row['报销金额（单据币种）'] || reimbursement.amount,
      receipt_status: parse_receipt_status(row['收单状态']) || reimbursement.receipt_status,
      reimbursement_status: parse_reimbursement_status(row['报销单状态']) || reimbursement.reimbursement_status,
      receipt_date: parse_date(row['收单日期']) || reimbursement.receipt_date,
      submission_date: parse_date(row['提交报销日期']) || reimbursement.submission_date,
      is_electronic: row['单据标签']&.include?('全电子发票') || reimbursement.is_electronic,
      is_complete: parse_reimbursement_status(row['报销单状态']) == 'closed' || reimbursement.is_complete
    )
    
    if reimbursement.changed? && reimbursement.save
      @updated_count += 1
    end
  end
  
  def create_audit_work_order(reimbursement)
    AuditWorkOrder.create(
      reimbursement: reimbursement,
      status: 'pending',
      created_by: @current_admin_user.id
    )
  end
  
  def parse_receipt_status(status)
    return nil unless status.present?
    status.include?('已收单') ? 'received' : 'pending'
  end
  
  def parse_reimbursement_status(status)
    return nil unless status.present?
    status.include?('已付款') || status.include?('已完成') ? 'closed' : 'processing'
  end
  
  def parse_date(date_string)
    return nil unless date_string.present?
    begin
      DateTime.parse(date_string)
    rescue
      nil
    end
  end
end
```

### 2. 创建快递收单导入服务

创建 `app/services/express_receipt_import_service.rb` 文件：

```ruby
# app/services/express_receipt_import_service.rb
class ExpressReceiptImportService
  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @matched_count = 0
    @unmatched_count = 0
    @error_count = 0
    @errors = []
    @unmatched_receipts = []
  end
  
  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?
    
    begin
      CSV.foreach(@file.path, headers: true) do |row|
        import_express_receipt(row)
      end
      
      {
        success: true,
        matched: @matched_count,
        unmatched: @unmatched_count,
        errors: @error_count,
        error_details: @errors,
        unmatched_receipts: @unmatched_receipts
      }
    rescue => e
      { success: false, errors: [e.message] }
    end
  end
  
  def manual_match(express_receipt_id, reimbursement_id)
    express_receipt = ExpressReceipt.find(express_receipt_id)
    reimbursement = Reimbursement.find(reimbursement_id)
    
    # 更新快递收单的单据号
    if express_receipt.update(document_number: reimbursement.invoice_number)
      # 更新报销单收单状态
      reimbursement.mark_as_received(express_receipt.receive_date)
      
      # 创建工单
      create_express_receipt_work_order(express_receipt, reimbursement)
      
      return { success: true }
    else
      return { success: false, errors: express_receipt.errors.full_messages }
    end
  end
  
  private
  
  def import_express_receipt(row)
    document_number = extract_document_number(row)
    tracking_number = extract_tracking_number(row)
    
    # 检查必要字段
    unless document_number.present? && tracking_number.present?
      @error_count += 1
      @errors << "行 #{$.}: 单据号或快递单号不能为空"
      return
    end
    
    # 查找对应的报销单
    reimbursement = Reimbursement.find_by(invoice_number: document_number)
    
    if reimbursement
      # 创建快递收单记录并关联到报销单
      express_receipt = ExpressReceipt.create!(
        document_number: document_number,
        tracking_number: tracking_number,
        receive_date: parse_date(row['操作时间']),
        receiver: row['操作人'] || @current_admin_user.email,
        courier_company: extract_courier_company(row)
      )
      
      # 更新报销单收单状态
      reimbursement.mark_as_received(express_receipt.receive_date)
      
      # 创建工单
      create_express_receipt_work_order(express_receipt, reimbursement)
      
      @matched_count += 1
    else
      # 记录未匹配的快递单
      @unmatched_count += 1
      @unmatched_receipts << {
        original_data: row.to_h,
        document_number: document_number,
        tracking_number: tracking_number
      }
    end
  end
  
  def create_express_receipt_work_order(express_receipt, reimbursement)
    ExpressReceiptWorkOrder.create!(
      reimbursement: reimbursement,
      status: 'received',
      tracking_number: express_receipt.tracking_number,
      received_at: express_receipt.receive_date,
      courier_name: express_receipt.courier_company,
      created_by: @current_admin_user.id
    )
  end
  
  def extract_document_number(row)
    row['单号'] || row['单据编号'] || ''
  end
  
  def extract_tracking_number(row)
    if row['操作意见'].present? && row['操作意见'] =~ /快递单号[：:]\s*(\w+)/
      $1.strip
    else
      "未知-#{Time.now.to_i}"
    end
  end
  
  def extract_courier_company(row)
    if row['操作意见'].present?
      if row['操作意见'].include?('顺丰')
        '顺丰'
      elsif row['操作意见'].include?('圆通')
        '圆通'
      elsif row['操作意见'].include?('中通')
        '中通'
      elsif row['操作意见'].include?('申通')
        '申通'
      elsif row['操作意见'].include?('韵达')
        '韵达'
      else
        '其他'
      end
    else
      '未知'
    end
  end
  
  def parse_date(date_string)
    return nil unless date_string.present?
    begin
      DateTime.parse(date_string)
    rescue
      DateTime.now
    end
  end
end
```

### 3. 创建费用明细导入服务

创建 `app/services/fee_detail_import_service.rb` 文件：

```ruby
# app/services/fee_detail_import_service.rb
class FeeDetailImportService
  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @imported_count = 0
    @unmatched_count = 0
    @error_count = 0
    @errors = []
    @unmatched_details = []
  end
  
  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?
    
    begin
      CSV.foreach(@file.path, headers: true) do |row|
        import_fee_detail(row)
      end
      
      {
        success: true,
        imported: @imported_count,
        unmatched: @unmatched_count,
        errors: @error_count,
        error_details: @errors,
        unmatched_details: @unmatched_details
      }
    rescue => e
      { success: false, errors: [e.message] }
    end
  end
  
  private
  
  def import_fee_detail(row)
    document_number = row['报销单单号']
    
    # 检查必要字段
    unless document_number.present?
      @error_count += 1
      @errors << "行 #{$.}: 报销单单号不能为空"
      return
    end
    
    # 查找对应的报销单
    reimbursement = Reimbursement.find_by(invoice_number: document_number)
    
    if reimbursement
      # 创建费用明细记录
      fee_detail = FeeDetail.new(
        document_number: document_number,
        fee_type: row['费用类型'],
        amount: row['原始金额'],
        currency: 'CNY',
        fee_date: parse_date(row['费用发生日期']),
        payment_method: row['弹性字段11'],
        verification_status: 'pending'
      )
      
      if fee_detail.save
        @imported_count += 1
        
        # 如果存在审核工单，自动关联费用明细
        associate_with_audit_work_orders(fee_detail, reimbursement)
      else
        @error_count += 1
        @errors << "行 #{$.}: #{fee_detail.errors.full_messages.join(', ')}"
      end
    else
      # 记录未匹配的费用明细
      @unmatched_count += 1
      @unmatched_details << {
        original_data: row.to_h,
        document_number: document_number
      }
    end
  end
  
  def associate_with_audit_work_orders(fee_detail, reimbursement)
    # 查找该报销单的所有审核工单
    audit_work_orders = AuditWorkOrder.where(reimbursement_id: reimbursement.id)
    
    # 关联到所有处于pending或processing状态的审核工单
    audit_work_orders.where(status: ['pending', 'processing']).each do |audit_work_order|
      audit_work_order.select_fee_detail(fee_detail)
    end
  end
  
  def parse_date(date_string)
    return nil unless date_string.present?
    begin
      DateTime.parse(date_string)
    rescue
      nil
    end
  end
end
```

### 4. 创建操作历史导入服务

创建 `app/services/operation_history_import_service.rb` 文件：

```ruby
# app/services/operation_history_import_service.rb
class OperationHistoryImportService
  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @imported_count = 0
    @updated_count = 0
    @error_count = 0
    @errors = []
  end
  
  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?
    
    begin
      CSV.foreach(@file.path, headers: true) do |row|
        import_operation_history(row)
      end
      
      {
        success: true,
        imported: @imported_count,
        updated: @updated_count,
        errors: @error_count,
        error_details: @errors
      }
    rescue => e
      { success: false, errors: [e.message] }
    end
  end
  
  private
  
  def import_operation_history(row)
    document_number = row['单据编号']
    operation_type = row['操作类型']
    
    # 检查必要字段
    unless document_number.present? && operation_type.present?
      @error_count += 1
      @errors << "行 #{$.}: 单据编号或操作类型不能为空"
      return
    end
    
    # 创建操作历史记录
    operation_history = OperationHistory.new(
      document_number: document_number,
      operation_type: operation_type,
      operation_time: parse_date(row['操作日期']),
      operator: row['操作人'],
      notes: row['操作意见']
    )
    
    if operation_history.save
      @imported_count += 1
      
      # 查找对应的报销单
      reimbursement = Reimbursement.find_by(invoice_number: document_number)
      if reimbursement
        # 检查是否为审批相关操作
        if operation_type.include?('审批') || operation_type.include?('审批通过')
          # 更新报销单状态为已关闭
          reimbursement.mark_as_complete
          @updated_count += 1
          
          # 更新相关工单状态
          update_work_orders(reimbursement)
        end
      end
    else
      @error_count += 1
      @errors << "行 #{$.}: #{operation_history.errors.full_messages.join(', ')}"
    end
  end
  
  def update_work_orders(reimbursement)
    # 更新该报销单的所有审核工单状态
    reimbursement.audit_work_orders.where(status: ['pending', 'processing', 'auditing']).each do |audit_work_order|
      # 如果审核工单尚未完成，则标记为已完成
      audit_work_order.approve if audit_work_order.status == 'auditing'
      audit_work_order.complete if ['approved', 'rejected'].include?(audit_work_order.status)
    end
    
    # 更新该报销单的所有沟通工单状态
    reimbursement.communication_work_orders.where(status: ['open', 'in_progress']).each do |communication_work_order|
      # 如果沟通工单尚未完成，则标记为已解决并关闭
      communication_work_order.resolve(resolution_summary: '基于操作历史自动解决') if communication_work_order.status == 'in_progress'
      communication_work_order.close if ['resolved', 'unresolved'].include?(communication_work_order.status)
    end
  end
  
  def parse_date(date_string)
    return nil unless date_string.present?
    begin
      DateTime.parse(date_string)
    rescue
      DateTime.now
    end
  end
end
```

### 5. 创建导入控制器

创建 `app/controllers/admin/imports_controller.rb` 文件：

```ruby
# app/controllers/admin/imports_controller.rb
module Admin
  class ImportsController < ApplicationController
    include ServiceRegistry
    
    def index
      # 导入首页
    end
    
    def import_reimbursements
      render "admin/imports/import_reimbursements"
    end
    
    def do_import_reimbursements
      result = reimbursement_import_service.import
      
      if result[:success]
        redirect_to admin_reimbursements_path, notice: "成功导入 #{result[:created]} 条新记录，更新 #{result[:updated]} 条记录"
      else
        redirect_to import_reimbursements_admin_imports_path, alert: "导入失败: #{result[:errors].join(', ')}"
      end
    end
    
    def import_express_receipts
      render "admin/imports/import_express_receipts"
    end
    
    def do_import_express_receipts
      result = express_receipt_import_service.import
      
      if result[:success]
        redirect_to admin_express_receipts_path, notice: "成功导入 #{result[:matched]} 条记录，未匹配 #{result[:unmatched]} 条记录"
      else
        redirect_to import_express_receipts_admin_imports_path, alert: "导入失败: #{result[:errors].join(', ')}"
      end
    end
    
    def import_fee_details
      render "admin/imports/import_fee_details"
    end
    
    def do_import_fee_details
      result = fee_detail_import_service.import
      
      if result[:success]
        redirect_to admin_fee_details_path, notice: "成功导入 #{result[:imported]} 条记录，未匹配 #{result[:unmatched]} 条记录"
      else
        redirect_to import_fee_details_admin_imports_path, alert: "导入失败: #{result[:errors].join(', ')}"
      end
    end
    
    def import_operation_histories
      render "admin/imports/import_operation_histories"
    end
    
    def do_import_operation_histories
      result = operation_history_import_service.import
      
      if result[:success]
        redirect_to admin_operation_histories_path, notice: "成功导入 #{result[:imported]} 条记录，更新 #{result[:updated]} 条记录"
      else
        redirect_to import_operation_histories_admin_imports_path, alert: "导入失败: #{result[:errors].join(', ')}"
      end
    end
  end
end
```

### 6. 更新路由配置

修改 `config/routes.rb` 文件，添加导入路由：

```ruby
# config/routes.rb
Rails.application.routes.draw do
  # ...
  
  namespace :admin do
    resources :imports, only: [:index] do
      collection do
        get :import_reimbursements
        post :do_import_reimbursements
        get :import_express_receipts
        post :do_import_express_receipts
        get :import_fee_details
        post :do_import_fee_details
        get :import_operation_histories
        post :do_import_operation_histories
      end
    end
    # ...
  end
  
  # ...
end
```

## 测试验证方法

1. 运行 `rspec spec/services/reimbursement_import_service_spec.rb` 确保所有测试通过
2. 运行 `rspec spec/services/express_receipt_import_service_spec.rb` 确保所有测试通过
3. 运行 `rspec spec/services/fee_detail_import_service_spec.rb` 确保所有测试通过
4. 运行 `rspec spec/services/operation_history_import_service_spec.rb` 确保所有测试通过
5. 在 Rails 控制台中测试导入功能：
   ```ruby
   # 创建测试CSV文件
   require 'csv'
   
   # 创建报销单CSV
   CSV.open("tmp/test_reimbursements.csv", "wb") do |csv|
     csv << ["报销单单号", "单据名称", "报销单申请人", "报销单申请人工号", "申请人公司", "申请人部门", "报销金额（单据币种）", "收单状态", "报销单状态", "收单日期", "提交报销日期", "单据标签"]
     csv << ["R20250101001", "测试报销单1", "张三", "EMP001", "测试公司", "测试部门", "1000.00", "未收单", "处理中", "", "2025-01-01", ""]
     csv << ["R20250101002", "测试报销单2", "李四", "EMP002", "测试公司", "财务部", "2000.00", "未收单", "处理中", "", "2025-01-02", "全电子发票"]
   end
   
   # 创建快递收单CSV
   CSV.open("tmp/test_express_receipts.csv", "wb") do |csv|
     csv << ["单号", "操作人", "操作时间", "操作意见"]
     csv << ["R20250101001", "王五", "2025-01-03", "已收到快递，快递单号：SF1234567890，顺丰快递"]
     csv << ["R20250101003", "赵六", "2025-01-04", "已收到快递，快递单号：YT9876543210，圆通快递"]
   end
   
   # 创建费用明细CSV
   CSV.open("tmp/test_fee_details.csv", "wb") do |csv|
     csv << ["报销单单号", "费用类型", "原始金额", "费用发生日期", "弹性字段11"]
     csv << ["R20250101001", "交通费", "100.00", "2025-01-01", "现金"]
     csv << ["R20250101001", "餐饮费", "200.00", "2025-01-01", "信用卡"]
     csv << ["R20250101002", "办公用品", "300.00", "2025-01-02", "公司账户"]
   end
   
   # 创建操作历史CSV
   CSV.open("tmp/test_operation_histories.csv", "wb") do |csv|
     csv << ["单据编号", "操作类型", "操作日期", "操作人", "操作意见"]
     csv << ["R20250101001", "提交", "2025-01-01", "张三", "提交报销单"]
     csv << ["R20250101001", "审批通过", "2025-01-05", "总监", "审批通过"]
     csv << ["R20250101002", "提交", "2025-01-02", "李四", "提交报销单"]
   end
   
   # 创建管理员用户
   admin_user = AdminUser.first || AdminUser.create!(email: 'admin@example.com', password: 'password')
   
   # 测试报销单导入
   reimbursement_file = File.open("tmp/test_reimbursements.csv")
   reimbursement_import_service = ReimbursementImportService.new(reimbursement_file, admin_user)
   result = reimbursement_import_service.import
   puts "报销单导入结果: #{result.inspect}"
   
   # 测试快递收单导入
   express_receipt_file = File.open("tmp/test_express_receipts.csv")
   express_receipt_import_service = ExpressReceiptImportService.new(express_receipt_file, admin_user)
   result = express_receipt_import_service.import
   puts "快递收单导入结果: #{result.inspect}"
   
   # 测试费用明细导入
   fee_detail_file = File.open("tmp/test_fee_details.csv")
   fee_detail_import_service = FeeDetailImportService.new(fee_detail_file, admin_user)
   result = fee_detail_import_service.import
   puts "费用明细导入结果: #{result.inspect}"
   
   # 测试操作历史导入
   operation_history_file = File.open("tmp/test_operation_histories.csv")
   operation_history_import_service = OperationHistoryImportService.new(operation_history_file, admin_user)
   result = operation_history_import_service.import
   puts "操作历史导入结果: #{result.inspect}"
   ```
6. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试导入功能

## 注意事项

1. 确保导入服务正确实现，特别是CSV文件的解析和数据的验证
2. 确保导入顺序验证功能正确实现，特别是快递收单、费用明细和操作历史导入前必须先导入报销单
3. 确保错误处理和验证功能正确实现，特别是必要字段的检查和数据格式的验证
4. 确保导入后的自动处理功能正确实现，特别是自动创建工单和更新状态
5. 确保未匹配记录的处理功能正确实现，特别是记录未匹配的原因和提供手动匹配的方法
6. 注意导入服务是系统的核心业务逻辑，需要确保数据的一致性和完整性
7. 在测试中，需要模拟各种异常情况，如文件不存在、格式错误、数据不完整等