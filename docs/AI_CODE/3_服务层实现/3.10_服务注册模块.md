# 服务注册模块实现

## 任务描述

实现服务注册模块（ServiceRegistry），用于在控制器中方便地访问各种服务。该模块是工单系统的辅助组件，负责集中管理和提供服务实例，简化控制器代码，提高代码的可维护性和可测试性。

## 输入和依赖

- 已完成的报销单导入服务
- 已完成的快递收单导入服务
- 已完成的费用明细导入服务
- 已完成的操作历史导入服务
- 已完成的审核工单处理服务
- 已完成的沟通工单处理服务
- 已完成的快递收单工单处理服务
- 已完成的费用明细验证服务
- 已完成的工单状态变更服务
- 服务实现设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的服务注册模块实现，包括：
- 服务注册模块定义
- 各种服务的访问方法
- 在控制器中使用服务注册模块的示例

## 详细实现步骤

### 1. 创建服务注册模块

创建 `app/services/service_registry.rb` 文件：

```ruby
# app/services/service_registry.rb
module ServiceRegistry
  def reimbursement_import_service
    @reimbursement_import_service ||= ReimbursementImportService.new(params[:file], current_admin_user)
  end
  
  def express_receipt_import_service
    @express_receipt_import_service ||= ExpressReceiptImportService.new(params[:file], current_admin_user)
  end
  
  def fee_detail_import_service
    @fee_detail_import_service ||= FeeDetailImportService.new(params[:file], current_admin_user)
  end
  
  def operation_history_import_service
    @operation_history_import_service ||= OperationHistoryImportService.new(params[:file], current_admin_user)
  end
  
  def audit_work_order_service(work_order)
    @audit_work_order_service ||= AuditWorkOrderService.new(work_order, current_admin_user)
  end
  
  def communication_work_order_service(work_order)
    @communication_work_order_service ||= CommunicationWorkOrderService.new(work_order, current_admin_user)
  end
  
  def express_receipt_work_order_service(work_order)
    @express_receipt_work_order_service ||= ExpressReceiptWorkOrderService.new(work_order, current_admin_user)
  end
  
  def fee_detail_verification_service
    @fee_detail_verification_service ||= FeeDetailVerificationService.new(current_admin_user)
  end
  
  def work_order_status_change_service
    @work_order_status_change_service ||= WorkOrderStatusChangeService.new(current_admin_user)
  end
end
```

### 2. 在控制器中使用服务注册模块

修改 `app/controllers/application_controller.rb` 文件，引入服务注册模块：

```ruby
# app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
  include ServiceRegistry
  
  # 其他代码...
end
```

### 3. 在导入控制器中使用服务注册模块

修改 `app/controllers/admin/reimbursements_controller.rb` 文件，使用服务注册模块：

```ruby
# app/controllers/admin/reimbursements_controller.rb
module Admin
  class ReimbursementsController < ApplicationController
    def import
      result = reimbursement_import_service.import
      
      if result[:success]
        redirect_to admin_reimbursements_path, notice: "成功导入 #{result[:created]} 条新记录，更新 #{result[:updated]} 条记录"
      else
        redirect_to new_import_admin_reimbursements_path, alert: "导入失败: #{result[:errors].join(', ')}"
      end
    end
    
    # 其他代码...
  end
end
```

修改 `app/controllers/admin/express_receipts_controller.rb` 文件，使用服务注册模块：

```ruby
# app/controllers/admin/express_receipts_controller.rb
module Admin
  class ExpressReceiptsController < ApplicationController
    def import
      result = express_receipt_import_service.import
      
      if result[:success]
        redirect_to admin_express_receipts_path, notice: "成功导入 #{result[:matched]} 条记录，未匹配 #{result[:unmatched]} 条记录"
      else
        redirect_to new_import_admin_express_receipts_path, alert: "导入失败: #{result[:errors].join(', ')}"
      end
    end
    
    # 其他代码...
  end
end
```

修改 `app/controllers/admin/fee_details_controller.rb` 文件，使用服务注册模块：

```ruby
# app/controllers/admin/fee_details_controller.rb
module Admin
  class FeeDetailsController < ApplicationController
    def import
      result = fee_detail_import_service.import
      
      if result[:success]
        redirect_to admin_fee_details_path, notice: "成功导入 #{result[:imported]} 条记录，未匹配 #{result[:unmatched]} 条记录"
      else
        redirect_to new_import_admin_fee_details_path, alert: "导入失败: #{result[:errors].join(', ')}"
      end
    end
    
    # 其他代码...
  end
end
```

修改 `app/controllers/admin/operation_histories_controller.rb` 文件，使用服务注册模块：

```ruby
# app/controllers/admin/operation_histories_controller.rb
module Admin
  class OperationHistoriesController < ApplicationController
    def import
      result = operation_history_import_service.import
      
      if result[:success]
        redirect_to admin_operation_histories_path, notice: "成功导入 #{result[:imported]} 条记录，更新 #{result[:updated]} 条记录"
      else
        redirect_to new_import_admin_operation_histories_path, alert: "导入失败: #{result[:errors].join(', ')}"
      end
    end
    
    # 其他代码...
  end
end
```

### 4. 在工单处理控制器中使用服务注册模块

修改 `app/controllers/admin/audit_work_orders_controller.rb` 文件，使用服务注册模块：

```ruby
# app/controllers/admin/audit_work_orders_controller.rb
module Admin
  class AuditWorkOrdersController < ApplicationController
    before_action :set_work_order
    
    def start_processing
      service = audit_work_order_service(@work_order)
      
      if service.start_processing
        redirect_to admin_audit_work_order_path(@work_order), notice: "工单已开始处理"
      else
        redirect_to admin_audit_work_order_path(@work_order), alert: "操作失败"
      end
    end
    
    # 其他代码...
    
    private
    
    def set_work_order
      @work_order = AuditWorkOrder.find(params[:id])
    end
  end
end
```

修改 `app/controllers/admin/communication_work_orders_controller.rb` 文件，使用服务注册模块：

```ruby
# app/controllers/admin/communication_work_orders_controller.rb
module Admin
  class CommunicationWorkOrdersController < ApplicationController
    before_action :set_work_order
    
    def start_communication
      service = communication_work_order_service(@work_order)
      
      if service.start_communication
        redirect_to admin_communication_work_order_path(@work_order), notice: "工单已开始沟通"
      else
        redirect_to admin_communication_work_order_path(@work_order), alert: "操作失败"
      end
    end
    
    # 其他代码...
    
    private
    
    def set_work_order
      @work_order = CommunicationWorkOrder.find(params[:id])
    end
  end
end
```

修改 `app/controllers/admin/express_receipt_work_orders_controller.rb` 文件，使用服务注册模块：

```ruby
# app/controllers/admin/express_receipt_work_orders_controller.rb
module Admin
  class ExpressReceiptWorkOrdersController < ApplicationController
    before_action :set_work_order
    
    def process
      service = express_receipt_work_order_service(@work_order)
      
      if service.process
        redirect_to admin_express_receipt_work_order_path(@work_order), notice: "工单已处理"
      else
        redirect_to admin_express_receipt_work_order_path(@work_order), alert: "操作失败"
      end
    end
    
    # 其他代码...
    
    private
    
    def set_work_order
      @work_order = ExpressReceiptWorkOrder.find(params[:id])
    end
  end
end
```

### 5. 在费用明细验证控制器中使用服务注册模块

修改 `app/controllers/admin/fee_details_controller.rb` 文件，使用服务注册模块：

```ruby
# app/controllers/admin/fee_details_controller.rb
module Admin
  class FeeDetailsController < ApplicationController
    # 其他代码...
    
    def do_verify
      @work_order = find_work_order
      
      if fee_detail_verification_service.verify_fee_detail_in_work_order(@work_order, @fee_detail.id, params[:verification_status], params[:comment])
        redirect_to polymorphic_path([:admin, @work_order]), notice: "费用明细已验证"
      else
        redirect_to polymorphic_path([:admin, @work_order]), alert: "验证费用明细失败"
      end
    end
    
    # 其他代码...
  end
end
```

### 6. 在工单状态变更控制器中使用服务注册模块

修改 `app/controllers/admin/work_order_status_changes_controller.rb` 文件，使用服务注册模块：

```ruby
# app/controllers/admin/work_order_status_changes_controller.rb
module Admin
  class WorkOrderStatusChangesController < ApplicationController
    def by_work_order
      work_order_type = params[:work_order_type]
      work_order_id = params[:work_order_id]
      
      @work_order_status_changes = work_order_status_change_service.get_status_changes_by_type(work_order_type, work_order_id)
      
      render :index
    end
    
    # 其他代码...
  end
end
```

## 测试验证方法

1. 在 Rails 控制台中测试服务注册模块：
   ```ruby
   # 创建测试控制器
   class TestController < ApplicationController
     include ServiceRegistry
     
     def initialize
       @params = {}
     end
     
     def params
       @params
     end
     
     def current_admin_user
       AdminUser.first || AdminUser.create!(email: 'admin@example.com', password: 'password')
     end
   end
   
   # 创建控制器实例
   controller = TestController.new
   
   # 测试获取服务实例
   fee_detail_verification_service = controller.fee_detail_verification_service
   puts "费用明细验证服务类: #{fee_detail_verification_service.class.name}"
   
   # 测试获取需要工单参数的服务实例
   reimbursement = Reimbursement.first
   audit_work_order = AuditWorkOrder.create!(reimbursement: reimbursement, status: 'pending', created_by: 1)
   audit_work_order_service = controller.audit_work_order_service(audit_work_order)
   puts "审核工单处理服务类: #{audit_work_order_service.class.name}"
   ```
2. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试各种控制器功能

## 注意事项

1. 确保服务注册模块正确实现，特别是服务实例的创建和缓存
2. 确保在控制器中正确引入和使用服务注册模块
3. 确保服务注册模块中的方法名与服务类名保持一致，便于理解和使用
4. 确保服务注册模块中的方法参数与服务类构造函数参数保持一致
5. 注意服务注册模块是一个辅助组件，主要目的是简化控制器代码，提高代码的可维护性和可测试性
6. 在测试中，可以通过模拟服务注册模块来隔离控制器和服务，提高测试的可靠性和效率