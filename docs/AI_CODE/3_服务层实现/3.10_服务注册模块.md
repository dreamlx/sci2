# 服务注册模块实现

## 任务描述

实现服务注册模块（ServiceRegistry），为控制器提供一个统一的接口来访问各种服务。该模块将被包含在控制器中，提供初始化各种服务的辅助方法，使控制器代码更加简洁和一致。

## 输入和依赖

- 所有已实现的服务类
- 服务层设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的服务注册模块实现，包括：
- 所有服务的注册方法
- 模块的包含机制
- 单元测试

## 详细实现步骤

### 1. 创建服务注册模块

创建 `app/services/service_registry.rb` 文件：

```ruby
# app/services/service_registry.rb
module ServiceRegistry
  # 报销单导入服务
  def reimbursement_import_service(file)
    ReimbursementImportService.new(file, current_admin_user)
  end

  # 快递收单导入服务
  def express_receipt_import_service(file)
    ExpressReceiptImportService.new(file, current_admin_user)
  end

  # 费用明细导入服务
  def fee_detail_import_service(file)
    FeeDetailImportService.new(file, current_admin_user)
  end

  # 操作历史导入服务
  def operation_history_import_service(file)
    OperationHistoryImportService.new(file, current_admin_user)
  end

  # 审核工单处理服务
  def audit_work_order_service(work_order)
    AuditWorkOrderService.new(work_order, current_admin_user)
  end

  # 沟通工单处理服务
  def communication_work_order_service(work_order)
    CommunicationWorkOrderService.new(work_order, current_admin_user)
  end

  # 快递收单工单处理服务
  def express_receipt_work_order_service(work_order)
    ExpressReceiptWorkOrderService.new(work_order, current_admin_user)
  end

  # 费用明细验证服务
  def fee_detail_verification_service
    FeeDetailVerificationService.new(current_admin_user)
  end

  # 工单状态变更服务
  def work_order_status_change_service
    WorkOrderStatusChangeService.new(current_admin_user)
  end
end
```

### 2. 在 ApplicationController 中包含服务注册模块

修改 `app/controllers/application_controller.rb` 文件：

```ruby
class ApplicationController < ActionController::Base
  include ServiceRegistry
  
  # ... 其他代码 ...
end
```

### 3. 创建服务注册模块测试

创建 `spec/services/service_registry_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe ServiceRegistry, type: :module do
  # 创建一个测试控制器类
  class TestController < ApplicationController
    def current_admin_user
      @current_admin_user ||= AdminUser.first
    end
  end
  
  let(:controller) { TestController.new }
  let(:admin_user) { create(:admin_user) }
  let(:file) { double('file') }
  let(:work_order) { double('work_order') }
  
  before do
    allow(controller).to receive(:current_admin_user).and_return(admin_user)
  end
  
  describe '#reimbursement_import_service' do
    it '返回 ReimbursementImportService 实例' do
      expect(ReimbursementImportService).to receive(:new).with(file, admin_user)
      controller.reimbursement_import_service(file)
    end
  end
  
  describe '#express_receipt_import_service' do
    it '返回 ExpressReceiptImportService 实例' do
      expect(ExpressReceiptImportService).to receive(:new).with(file, admin_user)
      controller.express_receipt_import_service(file)
    end
  end
  
  describe '#fee_detail_import_service' do
    it '返回 FeeDetailImportService 实例' do
      expect(FeeDetailImportService).to receive(:new).with(file, admin_user)
      controller.fee_detail_import_service(file)
    end
  end
  
  describe '#operation_history_import_service' do
    it '返回 OperationHistoryImportService 实例' do
      expect(OperationHistoryImportService).to receive(:new).with(file, admin_user)
      controller.operation_history_import_service(file)
    end
  end
  
  describe '#audit_work_order_service' do
    it '返回 AuditWorkOrderService 实例' do
      expect(AuditWorkOrderService).to receive(:new).with(work_order, admin_user)
      controller.audit_work_order_service(work_order)
    end
  end
  
  describe '#communication_work_order_service' do
    it '返回 CommunicationWorkOrderService 实例' do
      expect(CommunicationWorkOrderService).to receive(:new).with(work_order, admin_user)
      controller.communication_work_order_service(work_order)
    end
  end
  
  describe '#express_receipt_work_order_service' do
    it '返回 ExpressReceiptWorkOrderService 实例' do
      expect(ExpressReceiptWorkOrderService).to receive(:new).with(work_order, admin_user)
      controller.express_receipt_work_order_service(work_order)
    end
  end
  
  describe '#fee_detail_verification_service' do
    it '返回 FeeDetailVerificationService 实例' do
      expect(FeeDetailVerificationService).to receive(:new).with(admin_user)
      controller.fee_detail_verification_service
    end
  end
  
  describe '#work_order_status_change_service' do
    it '返回 WorkOrderStatusChangeService 实例' do
      expect(WorkOrderStatusChangeService).to receive(:new).with(admin_user)
      controller.work_order_status_change_service
    end
  end
end
```

## 在 ActiveAdmin 中使用服务注册模块

在 ActiveAdmin 资源文件中使用服务注册模块：

```ruby
# app/admin/reimbursements.rb
ActiveAdmin.register Reimbursement do
  # ... 其他代码 ...

  collection_action :import, method: :post do
    # 使用服务注册模块获取服务实例
    service = reimbursement_import_service(params[:file])
    result = service.import
    
    if result[:success]
      redirect_to admin_reimbursements_path, notice: "导入成功: #{result[:created]} 创建, #{result[:updated]} 更新, #{result[:errors]} 错误."
    else
      redirect_to new_import_admin_reimbursements_path, alert: "导入失败: #{result[:errors].join(', ')}"
    end
  end
  
  # ... 其他代码 ...
end

# app/admin/audit_work_orders.rb
ActiveAdmin.register AuditWorkOrder do
  # ... 其他代码 ...

  member_action :approve, method: :post do
    # 使用服务注册模块获取服务实例
    service = audit_work_order_service(resource)
    
    if service.approve(params[:comment])
      redirect_to admin_audit_work_order_path(resource), notice: "审核已通过"
    else
      redirect_to admin_audit_work_order_path(resource), alert: "操作失败: #{resource.errors.full_messages.join(', ')}"
    end
  end
  
  # ... 其他代码 ...
end
```

## 测试验证方法

1. 运行 `rspec spec/services/service_registry_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务注册模块：

```ruby
# 创建一个测试控制器
class TestController < ApplicationController
  def current_admin_user
    AdminUser.first
  end
  
  def test_services
    puts "报销单导入服务: #{reimbursement_import_service(nil).class.name}"
    puts "快递收单导入服务: #{express_receipt_import_service(nil).class.name}"
    puts "费用明细导入服务: #{fee_detail_import_service(nil).class.name}"
    puts "操作历史导入服务: #{operation_history_import_service(nil).class.name}"
    
    # 创建测试工单
    reimbursement = Reimbursement.first
    audit_work_order = AuditWorkOrder.create!(reimbursement: reimbursement, status: 'pending', created_by: current_admin_user.id)
    communication_work_order = CommunicationWorkOrder.create!(reimbursement: reimbursement, audit_work_order: audit_work_order, status: 'open', created_by: current_admin_user.id)
    express_receipt_work_order = ExpressReceiptWorkOrder.create!(reimbursement: reimbursement, status: 'received', tracking_number: 'TEST123', created_by: current_admin_user.id)
    
    puts "审核工单处理服务: #{audit_work_order_service(audit_work_order).class.name}"
    puts "沟通工单处理服务: #{communication_work_order_service(communication_work_order).class.name}"
    puts "快递收单工单处理服务: #{express_receipt_work_order_service(express_receipt_work_order).class.name}"
    puts "费用明细验证服务: #{fee_detail_verification_service.class.name}"
    puts "工单状态变更服务: #{work_order_status_change_service.class.name}"
  end
end

# 创建控制器实例并测试
controller = TestController.new
controller.test_services
```

3. 在 ActiveAdmin 资源文件中使用服务注册模块，确保功能正常

## 注意事项

1. 确保所有服务都已正确实现，并且接口一致
2. 确保 `current_admin_user` 方法在控制器中可用，这通常由 Devise 提供
3. 考虑在服务注册模块中添加错误处理和日志记录功能
4. 考虑添加服务缓存机制，避免重复创建服务实例
5. 考虑添加服务依赖注入机制，使测试更容易
6. 确保测试覆盖所有服务注册方法
7. 考虑在服务注册模块中添加文档注释，说明每个服务的用途和参数