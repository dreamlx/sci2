# 服务层实现概述

## 1. 服务层架构

SCI2工单系统的服务层采用服务对象模式（Service Object Pattern），将业务逻辑从控制器和模型中分离出来，提高代码的可维护性和可测试性。服务层的主要职责包括：

1. **数据导入**：处理从外部系统导入的数据，包括报销单、快递收单、费用明细和操作历史
2. **工单处理**：处理各类工单的业务逻辑，包括状态转换、关联操作等
3. **费用明细验证**：处理费用明细的验证业务逻辑
4. **服务注册**：提供统一的接口访问各种服务

服务层的架构如下图所示：

```
服务层架构
├── 导入服务
│   ├── 报销单导入服务 (ReimbursementImportService)
│   ├── 快递收单导入服务 (ExpressReceiptImportService)
│   ├── 费用明细导入服务 (FeeDetailImportService)
│   └── 操作历史导入服务 (OperationHistoryImportService)
├── 工单处理服务
│   ├── 审核工单处理服务 (AuditWorkOrderService)
│   ├── 沟通工单处理服务 (CommunicationWorkOrderService)
│   └── 快递收单工单处理服务 (ExpressReceiptWorkOrderService)
├── 费用明细验证服务 (FeeDetailVerificationService)
├── 工单状态变更服务 (WorkOrderStatusChangeService)
└── 服务注册模块 (ServiceRegistry)
```

## 2. 服务层依赖关系

服务层的依赖关系如下：

1. **导入服务**依赖于基础模型，负责创建和更新模型实例
2. **工单处理服务**依赖于基础模型和费用明细验证服务，负责处理工单的业务逻辑
3. **费用明细验证服务**依赖于基础模型，负责处理费用明细的验证业务逻辑
4. **工单状态变更服务**依赖于基础模型，负责记录工单状态变更历史
5. **服务注册模块**依赖于所有服务，提供统一的接口访问各种服务

依赖关系图：

```
                  ┌─────────────┐
                  │  基础模型   │
                  └─────────────┘
                         ▲
                         │
         ┌───────────────┼───────────────┐
         │               │               │
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  导入服务   │  │ 费用明细验证 │  │ 工单状态变更 │
└─────────────┘  │   服务     │  │   服务     │
                 └─────────────┘  └─────────────┘
                        ▲                ▲
                        │                │
                 ┌─────────────┐         │
                 │ 工单处理服务 │─────────┘
                 └─────────────┘
                        ▲
                        │
                 ┌─────────────┐
                 │ 服务注册模块 │
                 └─────────────┘
                        ▲
                        │
                 ┌─────────────┐
                 │   控制器    │
                 └─────────────┘
```

## 3. 服务层实现文件

### 3.1 导入服务

#### 3.1.1 报销单导入服务

- 文件：`app/services/reimbursement_import_service.rb`
- 职责：处理报销单数据的导入，包括创建和更新报销单记录
- 主要方法：
  - `import`：导入报销单数据
  - `import_reimbursement`：导入单个报销单
  - `create_reimbursement`：创建报销单
  - `update_reimbursement`：更新报销单
  - `create_audit_work_order`：为非电子发票报销单创建审核工单

#### 3.1.2 快递收单导入服务

- 文件：`app/services/express_receipt_import_service.rb`
- 职责：处理快递收单数据的导入，包括创建快递收单记录和快递收单工单
- 主要方法：
  - `import`：导入快递收单数据
  - `import_express_receipt`：导入单个快递收单
  - `create_express_receipt_work_order`：创建快递收单工单
  - `manual_match`：手动匹配未匹配的快递收单

#### 3.1.3 费用明细导入服务

- 文件：`app/services/fee_detail_import_service.rb`
- 职责：处理费用明细数据的导入，包括创建费用明细记录和关联到审核工单
- 主要方法：
  - `import`：导入费用明细数据
  - `import_fee_detail`：导入单个费用明细
  - `create_fee_detail`：创建费用明细
  - `associate_with_audit_work_orders`：关联费用明细到审核工单

#### 3.1.4 操作历史导入服务

- 文件：`app/services/operation_history_import_service.rb`
- 职责：处理操作历史数据的导入，包括创建操作历史记录和更新报销单状态
- 主要方法：
  - `import`：导入操作历史数据
  - `import_operation_history`：导入单个操作历史
  - `create_operation_history`：创建操作历史
  - `update_reimbursement_status`：根据操作历史更新报销单状态

### 3.2 工单处理服务

#### 3.2.1 审核工单处理服务

- 文件：`app/services/audit_work_order_service.rb`
- 职责：处理审核工单的业务逻辑，包括状态转换、费用明细验证、沟通工单创建等
- 主要方法：
  - `start_processing`：开始处理
  - `start_audit`：开始审核
  - `approve`：审核通过
  - `reject`：审核拒绝
  - `need_communication`：需要沟通
  - `resume_audit`：恢复审核
  - `complete`：完成
  - `create_communication_work_order`：创建沟通工单
  - `select_fee_details`：选择费用明细
  - `verify_fee_detail`：验证费用明细

#### 3.2.2 沟通工单处理服务

- 文件：`app/services/communication_work_order_service.rb`
- 职责：处理沟通工单的业务逻辑，包括状态转换、沟通记录添加、通知父工单等
- 主要方法：
  - `start_communication`：开始沟通
  - `resolve`：解决
  - `mark_unresolved`：标记为未解决
  - `close`：关闭
  - `add_communication_record`：添加沟通记录
  - `resolve_fee_detail_issue`：解决费用明细问题

#### 3.2.3 快递收单工单处理服务

- 文件：`app/services/express_receipt_work_order_service.rb`
- 职责：处理快递收单工单的业务逻辑，包括状态转换、完成后创建审核工单等
- 主要方法：
  - `process`：处理
  - `complete`：完成
  - `associate_fee_details_to_audit_work_order`：关联费用明细到审核工单

### 3.3 费用明细验证服务

- 文件：`app/services/fee_detail_verification_service.rb`
- 职责：处理费用明细的验证业务逻辑，包括更新验证状态、批量验证等
- 主要方法：
  - `verify_fee_details`：批量验证费用明细
  - `update_verification_status`：更新验证状态
  - `verify_fee_detail_in_work_order`：在工单中验证费用明细
  - `get_verification_history`：获取验证历史
  - `get_fee_details_by_status`：获取特定状态的费用明细

### 3.4 工单状态变更服务

- 文件：`app/services/work_order_status_change_service.rb`
- 职责：处理工单状态变更的业务逻辑，包括记录状态变更历史
- 主要方法：
  - `record_status_change`：记录状态变更
  - `get_status_changes`：获取状态变更历史

### 3.5 服务注册模块

- 文件：`app/services/service_registry.rb`
- 职责：提供统一的接口访问各种服务
- 主要方法：
  - `reimbursement_import_service`：获取报销单导入服务
  - `express_receipt_import_service`：获取快递收单导入服务
  - `fee_detail_import_service`：获取费用明细导入服务
  - `operation_history_import_service`：获取操作历史导入服务
  - `audit_work_order_service`：获取审核工单处理服务
  - `communication_work_order_service`：获取沟通工单处理服务
  - `express_receipt_work_order_service`：获取快递收单工单处理服务
  - `fee_detail_verification_service`：获取费用明细验证服务
  - `work_order_status_change_service`：获取工单状态变更服务

## 4. 服务层测试

每个服务都有对应的测试文件，用于验证服务的功能正确性。测试文件位于 `spec/services` 目录下，命名规则为 `服务名_spec.rb`。

测试覆盖以下方面：
1. 服务的基本功能
2. 边缘情况处理
3. 错误处理
4. 与其他服务的集成

## 5. 服务层使用示例

### 5.1 在控制器中使用服务

```ruby
# app/controllers/admin/reimbursements_controller.rb
class Admin::ReimbursementsController < ApplicationController
  include ServiceRegistry
  
  def import
    service = reimbursement_import_service(params[:file])
    result = service.import
    
    if result[:success]
      redirect_to admin_reimbursements_path, notice: "导入成功: #{result[:created]} 创建, #{result[:updated]} 更新, #{result[:errors]} 错误."
    else
      redirect_to new_import_admin_reimbursements_path, alert: "导入失败: #{result[:errors].join(', ')}"
    end
  end
end
```

### 5.2 在 ActiveAdmin 中使用服务

```ruby
# app/admin/audit_work_orders.rb
ActiveAdmin.register AuditWorkOrder do
  member_action :approve, method: :post do
    service = audit_work_order_service(resource)
    
    if service.approve(params[:comment])
      redirect_to admin_audit_work_order_path(resource), notice: "审核已通过"
    else
      redirect_to admin_audit_work_order_path(resource), alert: "操作失败: #{resource.errors.full_messages.join(', ')}"
    end
  end
end
```

## 6. 服务层最佳实践

1. **单一职责原则**：每个服务只负责一种类型的业务逻辑
2. **依赖注入**：通过构造函数注入依赖，提高可测试性
3. **错误处理**：使用异常或返回值明确表示错误情况
4. **事务处理**：使用事务确保数据一致性
5. **日志记录**：记录关键操作和错误信息
6. **参数验证**：验证输入参数，确保数据有效性
7. **返回值一致性**：保持返回值格式的一致性，便于调用者处理
8. **测试覆盖**：确保测试覆盖所有关键功能和边缘情况

## 7. 服务层扩展点

1. **新工单类型**：添加新的工单类型时，只需创建对应的工单处理服务
2. **新导入类型**：添加新的导入类型时，只需创建对应的导入服务
3. **新验证规则**：在费用明细验证服务中添加新的验证规则
4. **新状态转换**：在工单处理服务中添加新的状态转换逻辑
5. **新服务注册**：在服务注册模块中添加新的服务注册方法

## 8. 总结

服务层是 SCI2 工单系统的核心部分，负责处理所有业务逻辑。通过服务对象模式，将业务逻辑从控制器和模型中分离出来，提高了代码的可维护性和可测试性。服务层的设计遵循单一职责原则，每个服务只负责一种类型的业务逻辑，使得系统更加模块化和可扩展。

服务注册模块提供了统一的接口访问各种服务，简化了控制器的代码。通过依赖注入，提高了服务的可测试性。通过事务处理，确保了数据的一致性。通过错误处理和日志记录，提高了系统的可靠性和可维护性。

总之，服务层的实现为 SCI2 工单系统提供了一个稳定、可靠、可扩展的业务逻辑处理框架。