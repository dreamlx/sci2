# 审核工单处理服务实现

## 任务描述

实现审核工单处理服务（AuditWorkOrderService），用于处理审核工单的状态流转、费用明细验证、沟通工单创建等功能。该服务是工单系统的核心业务逻辑之一，负责处理报销单的审核流程。

## 输入和依赖

- 已完成的报销单模型
- 已完成的审核工单模型
- 已完成的沟通工单模型
- 已完成的费用明细模型
- 已完成的费用明细选择模型
- 服务实现设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的审核工单处理服务实现，包括：
- 工单状态流转功能
- 费用明细验证功能
- 沟通工单创建功能
- 工单完成后的报销单状态更新功能
- 错误处理和验证功能

## 详细实现步骤

### 1. 创建审核工单处理服务

创建 `app/services/audit_work_order_service.rb` 文件：

```ruby
# app/services/audit_work_order_service.rb
class AuditWorkOrderService
  def initialize(audit_work_order, current_admin_user)
    @audit_work_order = audit_work_order
    @current_admin_user = current_admin_user
  end
  
  def start_processing
    @audit_work_order.start_processing
  end
  
  def start_audit
    @audit_work_order.start_audit
  end
  
  def approve(comment = nil)
    result = @audit_work_order.approve
    
    if result
      # 更新审核信息
      @audit_work_order.update(
        audit_result: 'approved',
        audit_comment: comment,
        audit_date: Time.current
      )
      
      # 更新所有关联的费用明细为已验证
      @audit_work_order.fee_details.each do |fee_detail|
        @audit_work_order.verify_fee_detail(fee_detail, 'verified')
def reject(comment = nil)
    result = @audit_work_order.reject
    
    if result
      # 更新审核信息
      @audit_work_order.update(
        audit_result: 'rejected',
        audit_comment: comment,
        audit_date: Time.current
      )
      
      # 更新所有关联的费用明细为已拒绝
      @audit_work_order.fee_details.each do |fee_detail|
        @audit_work_order.verify_fee_detail(fee_detail, 'rejected')
      end
    end
    
    result
  end
  
  def need_communication
    @audit_work_order.need_communication
  end
  
  def resume_audit
    @audit_work_order.resume_audit
  end
  
  def complete
    result = @audit_work_order.complete
    
    if result
      # 如果所有审核工单都已完成，更新报销单状态
      reimbursement = @audit_work_order.reimbursement
      pending_audit_work_orders = reimbursement.audit_work_orders.where.not(status: 'completed')
      
      if pending_audit_work_orders.empty?
        reimbursement.mark_as_complete
      end
    end
    
    result
  end
  
  def create_communication_work_order(params)
    # 创建沟通工单
    communication_work_order = @audit_work_order.create_communication_work_order(
      communication_method: params[:communication_method],
      initiator_role: params[:initiator_role] || 'auditor',
      created_by: @current_admin_user.id,
      fee_detail_ids: params[:fee_detail_ids]
    )
    
    # 添加初始沟通记录
    if communication_work_order.persisted? && params[:content].present?
      communication_work_order.add_communication_record(
        content: params[:content],
        communicator_role: params[:initiator_role] || 'auditor',
        communicator_name: @current_admin_user.email,
        communication_method: params[:communication_method] || 'system',
        recorded_at: Time.current
      )
    end
    
    communication_work_order
  end
  
  def select_fee_details(fee_detail_ids)
    @audit_work_order.select_fee_details(fee_detail_ids)
  end
  
  def verify_fee_detail(fee_detail_id, result, comment = nil)
    fee_detail = FeeDetail.find(fee_detail_id)
    @audit_work_order.verify_fee_detail(fee_detail, result, comment)
  end
  
  def mark_fee_detail_problematic(fee_detail_id, issue_description)
    fee_detail = FeeDetail.find(fee_detail_id)
    
    # 标记费用明细为有问题
    @audit_work_order.verify_fee_detail(fee_detail, 'problematic', issue_description)
    
    # 创建沟通工单
    create_communication_work_order(
      communication_method: 'system',
      initiator_role: 'auditor',
      content: issue_description,
      fee_detail_ids: [fee_detail_id]
    )
  end
end
```

### 2. 创建审核工单控制器

创建 `app/controllers/admin/audit_work_orders_controller.rb` 文件：

```ruby
# app/controllers/admin/audit_work_orders_controller.rb
module Admin
  class AuditWorkOrdersController < ApplicationController
    before_action :set_audit_work_order, except: [:index, :new, :create]
    
    def index
      @audit_work_orders = AuditWorkOrder.all
    end
    
    def show
      @audit_work_order = AuditWorkOrder.find(params[:id])
    end
    
    def new
      @audit_work_order = AuditWorkOrder.new
    end
    
    def create
      @audit_work_order = AuditWorkOrder.new(audit_work_order_params)
      @audit_work_order.created_by = current_admin_user.id
      
      if @audit_work_order.save
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "审核工单已创建"
      else
        render :new
      end
    end
    
    def edit
    end
    
    def update
      if @audit_work_order.update(audit_work_order_params)
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "审核工单已更新"
      else
        render :edit
      end
    end
    
    def destroy
      @audit_work_order.destroy
def start_processing
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      if service.start_processing
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "工单已开始处理"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "操作失败"
      end
    end
    
    def start_audit
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      if service.start_audit
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "工单已开始审核"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "操作失败"
      end
    end
    
    def approve
      render "admin/audit_work_orders/approve"
    end
    
    def do_approve
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      if service.approve(params[:comment])
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "审核已通过"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "操作失败"
      end
    end
    
    def reject
      render "admin/audit_work_orders/reject"
    end
    
    def do_reject
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      if service.reject(params[:comment])
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "审核已拒绝"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "操作失败"
      end
    end
    
    def need_communication
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      if service.need_communication
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "工单已标记为需要沟通"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "操作失败"
      end
    end
    
    def resume_audit
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      if service.resume_audit
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "工单已恢复审核"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "操作失败"
      end
    end
    
    def complete
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      if service.complete
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "工单已完成"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "操作失败"
      end
    end
    
    def new_communication
      @fee_details = @audit_work_order.reimbursement.fee_details
      render "admin/audit_work_orders/new_communication"
    end
    
    def create_communication
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      communication_work_order = service.create_communication_work_order(
        communication_method: params[:communication_method],
        initiator_role: params[:initiator_role],
        content: params[:content],
        fee_detail_ids: params[:fee_detail_ids]
      )
      
      if communication_work_order.persisted?
        redirect_to admin_communication_work_order_path(communication_work_order), notice: "沟通工单已创建"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "创建沟通工单失败: #{communication_work_order.errors.full_messages.join(', ')}"
      end
    end
      redirect_to admin_audit_work_orders_path, notice: "审核工单已删除"
    end
      end
    end
    
    result
  end
def select_fee_details
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      if service.select_fee_details(params[:fee_detail_ids])
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "费用明细已选择"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "选择费用明细失败"
      end
    end
    
    def verify_fee_detail
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      if service.verify_fee_detail(params[:fee_detail_id], params[:result], params[:comment])
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "费用明细已验证"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "验证费用明细失败"
      end
    end
    
    def mark_fee_detail_problematic
      service = AuditWorkOrderService.new(@audit_work_order, current_admin_user)
      
      if service.mark_fee_detail_problematic(params[:fee_detail_id], params[:issue_description])
        redirect_to admin_audit_work_order_path(@audit_work_order), notice: "费用明细已标记为有问题，并创建了沟通工单"
      else
        redirect_to admin_audit_work_order_path(@audit_work_order), alert: "标记费用明细有问题失败"
      end
    end
    
    private
    
    def set_audit_work_order
      @audit_work_order = AuditWorkOrder.find(params[:id])
    end
    
    def audit_work_order_params
      params.require(:audit_work_order).permit(
        :reimbursement_id, 
        :express_receipt_work_order_id, 
        :status, 
        :audit_result, 
        :audit_comment, 
        :audit_date, 
        :vat_verified
      )
    end
  end
end
```

### 3. 创建审核工单视图

创建 `app/views/admin/audit_work_orders/approve.html.erb` 文件：

```erb
<!-- app/views/admin/audit_work_orders/approve.html.erb -->
<h2>审核通过</h2>

<%= form_tag do_approve_admin_audit_work_order_path(@audit_work_order), method: :post do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @audit_work_order.reimbursement.invoice_number %></td>
          </tr>
          <tr>
            <th>申请人</th>
            <td><%= @audit_work_order.reimbursement.applicant %></td>
          </tr>
          <tr>
            <th>审核意见</th>
            <td><%= text_area_tag :comment, nil, rows: 5, cols: 50 %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "确认通过", class: "button" %>
    <%= link_to "取消", admin_audit_work_order_path(@audit_work_order), class: "button" %>
  </div>
<% end %>
```

创建 `app/views/admin/audit_work_orders/reject.html.erb` 文件：

```erb
<!-- app/views/admin/audit_work_orders/reject.html.erb -->
<h2>审核拒绝</h2>

<%= form_tag do_reject_admin_audit_work_order_path(@audit_work_order), method: :post do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @audit_work_order.reimbursement.invoice_number %></td>
          </tr>
          <tr>
            <th>申请人</th>
            <td><%= @audit_work_order.reimbursement.applicant %></td>
          </tr>
          <tr>
            <th>拒绝原因</th>
            <td><%= text_area_tag :comment, nil, rows: 5, cols: 50, required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "确认拒绝", class: "button" %>
    <%= link_to "取消", admin_audit_work_order_path(@audit_work_order), class: "button" %>
  </div>
<% end %>
```
创建 `app/views/admin/audit_work_orders/new_communication.html.erb` 文件：

```erb
<!-- app/views/admin/audit_work_orders/new_communication.html.erb -->
<h2>创建沟通工单</h2>

<%= form_tag create_communication_admin_audit_work_order_path(@audit_work_order), method: :post do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @audit_work_order.reimbursement.invoice_number %></td>
          </tr>
          <tr>
            <th>申请人</th>
            <td><%= @audit_work_order.reimbursement.applicant %></td>
          </tr>
          <tr>
            <th>沟通方式</th>
            <td>
              <%= select_tag :communication_method, options_for_select([
                ["系统", "system"],
                ["邮件", "email"],
                ["电话", "phone"],
                ["其他", "other"]
              ]), required: true %>
            </td>
          </tr>
          <tr>
            <th>发起人角色</th>
            <td>
              <%= select_tag :initiator_role, options_for_select([
                ["审核人", "auditor"],
                ["申请人", "applicant"],
                ["管理员", "admin"],
                ["其他", "other"]
              ]), required: true %>
            </td>
          </tr>
          <tr>
            <th>沟通内容</th>
            <td><%= text_area_tag :content, nil, rows: 5, cols: 50, required: true %></td>
          </tr>
          <tr>
            <th>关联费用明细</th>
            <td>
              <div class="fee_detail_selection">
                <% @fee_details.each do |fee_detail| %>
                  <div>
                    <%= check_box_tag "fee_detail_ids[]", fee_detail.id, false, id: "fee_detail_#{fee_detail.id}" %>
                    <%= label_tag "fee_detail_#{fee_detail.id}", "#{fee_detail.fee_type} - #{number_to_currency(fee_detail.amount, unit: '¥')}" %>
                  </div>
                <% end %>
              </div>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "创建沟通工单", class: "button" %>
    <%= link_to "取消", admin_audit_work_order_path(@audit_work_order), class: "button" %>
  </div>
<% end %>
```

### 4. 更新路由配置

修改 `config/routes.rb` 文件，添加审核工单处理路由：

```ruby
# config/routes.rb
Rails.application.routes.draw do
  # ...
  
  namespace :admin do
    resources :audit_work_orders do
      member do
        put :start_processing
        put :start_audit
        get :approve
        post :do_approve
        get :reject
        post :do_reject
        put :need_communication
        put :resume_audit
        put :complete
        get :new_communication
        post :create_communication
        post :select_fee_details
        post :verify_fee_detail
        post :mark_fee_detail_problematic
      end
    end
    # ...
  end
  
  # ...
end
```

### 5. 创建审核工单处理服务测试

创建 `spec/services/audit_work_order_service_spec.rb` 文件：

```ruby
# spec/services/audit_work_order_service_spec.rb
require 'rails_helper'

RSpec.describe AuditWorkOrderService do
  let(:admin_user) { create(:admin_user) }
  let(:reimbursement) { create(:reimbursement) }
  let(:audit_work_order) { create(:audit_work_order, reimbursement: reimbursement, status: 'pending') }
  let(:service) { AuditWorkOrderService.new(audit_work_order, admin_user) }
  
  describe '#start_processing' do
    it 'changes status to processing' do
      expect {
        service.start_processing
      }.to change { audit_work_order.reload.status }.from('pending').to('processing')
    end
    
    it 'returns false if status transition is invalid' do
      audit_work_order.update(status: 'completed')
      expect(service.start_processing).to be false
    end
  end
  
  describe '#start_audit' do
    before do
      audit_work_order.update(status: 'processing')
    end
    
    it 'changes status to auditing' do
      expect {
        service.start_audit
      }.to change { audit_work_order.reload.status }.from('processing').to('auditing')
    end
    
    it 'returns false if status transition is invalid' do
      audit_work_order.update(status: 'pending')
      expect(service.start_audit).to be false
    end
  end
describe '#approve' do
    before do
      audit_work_order.update(status: 'auditing')
      @fee_detail1 = create(:fee_detail, document_number: reimbursement.invoice_number)
      @fee_detail2 = create(:fee_detail, document_number: reimbursement.invoice_number)
      audit_work_order.select_fee_detail(@fee_detail1)
      audit_work_order.select_fee_detail(@fee_detail2)
    end
    
    it 'changes status to approved' do
      expect {
        service.approve("审核通过")
      }.to change { audit_work_order.reload.status }.from('auditing').to('approved')
    end
    
    it 'updates audit information' do
      service.approve("审核通过")
      audit_work_order.reload
      
      expect(audit_work_order.audit_result).to eq('approved')
      expect(audit_work_order.audit_comment).to eq('审核通过')
      expect(audit_work_order.audit_date).to be_present
    end
    
    it 'updates all fee details to verified' do
      service.approve
      
      expect(@fee_detail1.reload.verification_status).to eq('verified')
      expect(@fee_detail2.reload.verification_status).to eq('verified')
    end
    
    it 'returns false if status transition is invalid' do
      audit_work_order.update(status: 'pending')
      expect(service.approve).to be false
    end
  end
  
  describe '#reject' do
    before do
      audit_work_order.update(status: 'auditing')
      @fee_detail1 = create(:fee_detail, document_number: reimbursement.invoice_number)
      @fee_detail2 = create(:fee_detail, document_number: reimbursement.invoice_number)
      audit_work_order.select_fee_detail(@fee_detail1)
      audit_work_order.select_fee_detail(@fee_detail2)
    end
    
    it 'changes status to rejected' do
      expect {
        service.reject("审核拒绝")
      }.to change { audit_work_order.reload.status }.from('auditing').to('rejected')
    end
    
    it 'updates audit information' do
      service.reject("审核拒绝")
      audit_work_order.reload
      
      expect(audit_work_order.audit_result).to eq('rejected')
      expect(audit_work_order.audit_comment).to eq('审核拒绝')
      expect(audit_work_order.audit_date).to be_present
    end
    
    it 'updates all fee details to rejected' do
      service.reject
      
      expect(@fee_detail1.reload.verification_status).to eq('rejected')
      expect(@fee_detail2.reload.verification_status).to eq('rejected')
    end
    
    it 'returns false if status transition is invalid' do
      audit_work_order.update(status: 'pending')
      expect(service.reject).to be false
    end
  end
  
  describe '#need_communication' do
    before do
      audit_work_order.update(status: 'auditing')
    end
    
    it 'changes status to needs_communication' do
      expect {
        service.need_communication
      }.to change { audit_work_order.reload.status }.from('auditing').to('needs_communication')
    end
    
    it 'returns false if status transition is invalid' do
      audit_work_order.update(status: 'pending')
      expect(service.need_communication).to be false
    end
  end
  
  describe '#resume_audit' do
    before do
      audit_work_order.update(status: 'needs_communication')
    end
    
    it 'changes status to auditing' do
      expect {
        service.resume_audit
      }.to change { audit_work_order.reload.status }.from('needs_communication').to('auditing')
    end
    
    it 'returns false if status transition is invalid' do
      audit_work_order.update(status: 'pending')
      expect(service.resume_audit).to be false
    end
  end
describe '#complete' do
    before do
      audit_work_order.update(status: 'approved')
    end
    
    it 'changes status to completed' do
      expect {
        service.complete
      }.to change { audit_work_order.reload.status }.from('approved').to('completed')
    end
    
    it 'updates reimbursement status if all audit work orders are completed' do
      expect {
        service.complete
      }.to change { reimbursement.reload.is_complete }.from(false).to(true)
    end
    
    it 'does not update reimbursement status if there are pending audit work orders' do
      create(:audit_work_order, reimbursement: reimbursement, status: 'pending')
      
      expect {
        service.complete
      }.not_to change { reimbursement.reload.is_complete }
    end
    
    it 'returns false if status transition is invalid' do
      audit_work_order.update(status: 'pending')
      expect(service.complete).to be false
    end
  end
  
  describe '#create_communication_work_order' do
    before do
      audit_work_order.update(status: 'auditing')
      @fee_detail = create(:fee_detail, document_number: reimbursement.invoice_number)
    end
    
    it 'creates a communication work order' do
      expect {
        service.create_communication_work_order(
          communication_method: 'email',
          initiator_role: 'auditor',
          content: '需要沟通',
          fee_detail_ids: [@fee_detail.id]
        )
      }.to change(CommunicationWorkOrder, :count).by(1)
        .and change(CommunicationRecord, :count).by(1)
        .and change { audit_work_order.reload.status }.to('needs_communication')
    end
    
    it 'associates fee details with the communication work order' do
      communication_work_order = service.create_communication_work_order(
        communication_method: 'email',
        initiator_role: 'auditor',
        content: '需要沟通',
        fee_detail_ids: [@fee_detail.id]
      )
      
      expect(communication_work_order.fee_details).to include(@fee_detail)
      expect(@fee_detail.reload.verification_status).to eq('problematic')
    end
    
    it 'creates a communication record' do
      communication_work_order = service.create_communication_work_order(
        communication_method: 'email',
        initiator_role: 'auditor',
        content: '需要沟通',
        fee_detail_ids: [@fee_detail.id]
      )
      
      communication_record = communication_work_order.communication_records.first
      expect(communication_record.content).to eq('需要沟通')
      expect(communication_record.communicator_role).to eq('auditor')
      expect(communication_record.communication_method).to eq('email')
    end
  end
  
  describe '#verify_fee_detail' do
    before do
      @fee_detail = create(:fee_detail, document_number: reimbursement.invoice_number)
      audit_work_order.select_fee_detail(@fee_detail)
    end
    
    it 'updates fee detail verification status' do
      expect {
        service.verify_fee_detail(@fee_detail.id, 'verified', '验证通过')
      }.to change { @fee_detail.reload.verification_status }.from('pending').to('verified')
    end
    
    it 'updates fee detail selection verification status' do
      service.verify_fee_detail(@fee_detail.id, 'verified', '验证通过')
      
      selection = audit_work_order.fee_detail_selections.find_by(fee_detail: @fee_detail)
      expect(selection.verification_status).to eq('verified')
      expect(selection.verification_comment).to eq('验证通过')
      expect(selection.verified_by).to eq(admin_user.id)
      expect(selection.verified_at).to be_present
    end
  end
  
  describe '#mark_fee_detail_problematic' do
    before do
      @fee_detail = create(:fee_detail, document_number: reimbursement.invoice_number)
      audit_work_order.select_fee_detail(@fee_detail)
    end
    
    it 'marks fee detail as problematic and creates a communication work order' do
      expect {
        service.mark_fee_detail_problematic(@fee_detail.id, '金额有问题')
      }.to change { @fee_detail.reload.verification_status }.from('pending').to('problematic')
        .and change(CommunicationWorkOrder, :count).by(1)
    end
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/services/audit_work_order_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：
   ```ruby
   # 创建测试报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false,
     is_complete: false,
     reimbursement_status: 'processing'
   )
   
   # 创建测试审核工单
   audit_work_order = AuditWorkOrder.create!(
     reimbursement: reimbursement,
     status: 'pending',
     created_by: 1
   )
   
   # 创建测试费用明细
   fee_detail = FeeDetail.create!(
     document_number: reimbursement.invoice_number,
     fee_type: "交通费",
     amount: 100.00,
     currency: "CNY",
     verification_status: "pending"
   )
   
   # 创建管理员用户
   admin_user = AdminUser.first || AdminUser.create!(email: 'admin@example.com', password: 'password')
   
   # 创建服务实例
   service = AuditWorkOrderService.new(audit_work_order, admin_user)
   
   # 测试状态流转
   service.start_processing
   puts "工单状态: #{audit_work_order.reload.status}"
   
   service.start_audit
   puts "工单状态: #{audit_work_order.reload.status}"
   
   # 测试费用明细关联
   audit_work_order.select_fee_detail(fee_detail)
   puts "关联的费用明细数量: #{audit_work_order.fee_details.count}"
   
   # 测试费用明细验证
   service.verify_fee_detail(fee_detail.id, 'verified', '验证通过')
   puts "费用明细验证状态: #{fee_detail.reload.verification_status}"
   
   # 测试审核通过
   service.approve('审核通过')
   puts "工单状态: #{audit_work_order.reload.status}"
   puts "审核结果: #{audit_work_order.audit_result}"
   
   # 测试工单完成
   service.complete
   puts "工单状态: #{audit_work_order.reload.status}"
   puts "报销单完成状态: #{reimbursement.reload.is_complete}"
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试审核工单处理功能

## 注意事项

1. 确保状态流转功能正确实现，特别是状态转换的条件和回调
2. 确保费用明细验证功能正确实现，特别是验证状态的更新和记录
3. 确保沟通工单创建功能正确实现，特别是费用明细的关联和初始沟通记录的创建
4. 确保工单完成后的报销单状态更新功能正确实现，特别是检查是否所有审核工单都已完成
5. 确保错误处理和验证功能正确实现，特别是非法状态转换的处理
6. 确保服务与控制器的交互正确实现，特别是参数的传递和结果的处理
7. 确保视图正确实现，特别是表单的提交和数据的显示