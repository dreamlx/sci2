# 报销单导入服务实现

## 任务描述

实现报销单导入服务（ReimbursementImportService），用于从CSV文件导入报销单数据。该服务需要处理CSV文件解析、数据验证、报销单创建或更新，以及根据报销单类型（电子发票或非电子发票）自动创建审核工单。

## 输入和依赖

- 已完成的报销单模型
- 已完成的审核工单模型
- CSV文件格式参考文档 (`docs/3.数据导入格式参考.md`)
- 服务实现设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的报销单导入服务实现，包括：
- CSV文件解析功能
- 数据验证功能
- 报销单创建或更新功能
- 根据报销单类型自动创建审核工单的功能
- 导入结果统计和错误处理

## 详细实现步骤

### 1. 创建报销单导入服务

创建 `app/services/reimbursement_import_service.rb` 文件：

```ruby
# app/services/reimbursement_import_service.rb
require 'csv'

class ReimbursementImportService
  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @created_count = 0
    @updated_count = 0
    @error_count = 0
    @errors = []
  end
  
  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?
    
    begin
      CSV.foreach(@file.path, headers: true) do |row|
        import_reimbursement(row)
      end
      
      {
        success: true,
        created: @created_count,
        updated: @updated_count,
        errors: @error_count,
        error_details: @errors
      }
    rescue => e
      { success: false, errors: [e.message] }
    end
  end
  
  private
  
  def import_reimbursement(row)
    invoice_number = row['报销单单号']
    
    # 检查必要字段
    unless invoice_number.present?
      @error_count += 1
      @errors << "行 #{$.}: 报销单单号不能为空"
      return
    end
    
    # 查找或创建报销单
    reimbursement = Reimbursement.find_by(invoice_number: invoice_number)
    
    if reimbursement
      # 更新现有报销单
      update_reimbursement(reimbursement, row)
    else
      # 创建新报销单
      create_reimbursement(row)
    end
  end
  
  def create_reimbursement(row)
    reimbursement = Reimbursement.new(
      invoice_number: row['报销单单号'],
      document_name: row['单据名称'],
      applicant: row['报销单申请人'],
      applicant_id: row['报销单申请人工号'],
      company: row['申请人公司'],
      department: row['申请人部门'],
      amount: row['报销金额（单据币种）'],
      receipt_status: parse_receipt_status(row['收单状态']),
      reimbursement_status: parse_reimbursement_status(row['报销单状态']),
      receipt_date: parse_date(row['收单日期']),
      submission_date: parse_date(row['提交报销日期']),
      is_electronic: row['单据标签']&.include?('全电子发票'),
      is_complete: parse_reimbursement_status(row['报销单状态']) == 'closed'
    )
    
    if reimbursement.save
      @created_count += 1
      
      # 如果是非电子发票，创建审核工单
      if !reimbursement.is_electronic
        create_audit_work_order(reimbursement)
      end
    else
      @error_count += 1
      @errors << "行 #{$.}: #{reimbursement.errors.full_messages.join(', ')}"
    end
  end
  
  def update_reimbursement(reimbursement, row)
    # 更新报销单属性
    reimbursement.assign_attributes(
      document_name: row['单据名称'] || reimbursement.document_name,
      applicant: row['报销单申请人'] || reimbursement.applicant,
      applicant_id: row['报销单申请人工号'] || reimbursement.applicant_id,
      company: row['申请人公司'] || reimbursement.company,
      department: row['申请人部门'] || reimbursement.department,
      amount: row['报销金额（单据币种）'] || reimbursement.amount,
      receipt_status: parse_receipt_status(row['收单状态']) || reimbursement.receipt_status,
      reimbursement_status: parse_reimbursement_status(row['报销单状态']) || reimbursement.reimbursement_status,
      receipt_date: parse_date(row['收单日期']) || reimbursement.receipt_date,
      submission_date: parse_date(row['提交报销日期']) || reimbursement.submission_date,
      is_electronic: row['单据标签']&.include?('全电子发票') || reimbursement.is_electronic,
      is_complete: parse_reimbursement_status(row['报销单状态']) == 'closed' || reimbursement.is_complete
    )
    
    if reimbursement.changed? && reimbursement.save
      @updated_count += 1
      
      # 如果是非电子发票且没有关联的审核工单，创建审核工单
      if !reimbursement.is_electronic && reimbursement.audit_work_orders.empty?
        create_audit_work_order(reimbursement)
      end
    end
  end
  
  def create_audit_work_order(reimbursement)
    AuditWorkOrder.create(
      reimbursement: reimbursement,
      status: 'pending',
      created_by: @current_admin_user.id
    )
  end
  
  def parse_receipt_status(status)
    return nil unless status.present?
    status.include?('已收单') ? 'received' : 'pending'
  end
  
  def parse_reimbursement_status(status)
    return nil unless status.present?
    status.include?('已付款') || status.include?('已完成') ? 'closed' : 'processing'
  end
  
  def parse_date(date_string)
    return nil unless date_string.present?
    begin
      DateTime.parse(date_string)
    rescue
      nil
    end
  end
end
```

### 2. 创建报销单导入控制器

创建 `app/controllers/admin/reimbursement_imports_controller.rb` 文件：

```ruby
# app/controllers/admin/reimbursement_imports_controller.rb
module Admin
  class ReimbursementImportsController < ApplicationController
    def new
      render 'admin/reimbursement_imports/new'
    end
    
    def create
      service = ReimbursementImportService.new(params[:file], current_admin_user)
      result = service.import
      
      if result[:success]
        redirect_to admin_reimbursements_path, notice: "成功导入 #{result[:created]} 条新记录，更新 #{result[:updated]} 条记录"
      else
        flash[:alert] = "导入失败: #{result[:errors].join(', ')}"
        render 'admin/reimbursement_imports/new'
      end
    end
  end
end
```

### 3. 创建报销单导入视图

创建 `app/views/admin/reimbursement_imports/new.html.erb` 文件：

```erb
<!-- app/views/admin/reimbursement_imports/new.html.erb -->
<h2>导入报销单</h2>

<%= form_tag admin_reimbursement_imports_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择CSV文件</th>
            <td><%= file_field_tag :file, accept: '.csv' %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_reimbursements_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV文件应包含以下列：</p>
    <ul>
      <li>报销单单号（必填）</li>
      <li>单据名称</li>
      <li>报销单申请人</li>
      <li>报销单申请人工号</li>
      <li>申请人公司</li>
      <li>申请人部门</li>
      <li>报销金额（单据币种）</li>
      <li>收单状态</li>
      <li>报销单状态</li>
      <li>收单日期</li>
      <li>提交报销日期</li>
      <li>单据标签</li>
    </ul>
  </div>
</div>
```

### 4. 更新路由配置

修改 `config/routes.rb` 文件，添加报销单导入路由：

```ruby
# config/routes.rb
Rails.application.routes.draw do
  # ...
  
  namespace :admin do
    resources :reimbursements do
      collection do
        resources :reimbursement_imports, only: [:new, :create]
      end
    end
    # ...
  end
  
  # ...
end
```

### 5. 更新 ActiveAdmin 配置

修改 `app/admin/reimbursements.rb` 文件，添加导入按钮：

```ruby
# app/admin/reimbursements.rb
ActiveAdmin.register Reimbursement do
  # ...
  
  action_item :import, only: :index do
    link_to "导入报销单", new_admin_reimbursement_import_path
  end
  
  # ...
end
```

### 6. 创建报销单导入服务测试

创建 `spec/services/reimbursement_import_service_spec.rb` 文件：

```ruby
# spec/services/reimbursement_import_service_spec.rb
require 'rails_helper'

RSpec.describe ReimbursementImportService do
  let(:admin_user) { create(:admin_user) }
  let(:csv_file) { fixture_file_upload('files/test_reimbursements.csv', 'text/csv') }
  
  describe '#import' do
    context 'with valid file' do
      before do
        # 创建测试CSV文件
        CSV.open(Rails.root.join('spec/fixtures/files/test_reimbursements.csv'), 'w') do |csv|
          csv << ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签']
          csv << ['R20250101001', '测试报销单1', '张三', 'EMP001', '测试公司', '测试部门', '1000.00', '已收单', '处理中', '2025-01-01', '2025-01-01', '']
          csv << ['R20250101002', '测试报销单2', '李四', 'EMP002', '测试公司', '财务部', '2000.00', '未收单', '处理中', '', '2025-01-02', '全电子发票']
        end
      end
      
      after do
        # 删除测试CSV文件
        File.delete(Rails.root.join('spec/fixtures/files/test_reimbursements.csv')) if File.exist?(Rails.root.join('spec/fixtures/files/test_reimbursements.csv'))
      end
      
      it 'creates new reimbursements' do
        service = ReimbursementImportService.new(csv_file, admin_user)
        
        expect {
          result = service.import
          expect(result[:success]).to be true
          expect(result[:created]).to eq(2)
          expect(result[:updated]).to eq(0)
          expect(result[:errors]).to eq(0)
        }.to change(Reimbursement, :count).by(2)
      end
      
      it 'updates existing reimbursements' do
        # 先创建一个报销单
        create(:reimbursement, invoice_number: 'R20250101001')
        
        service = ReimbursementImportService.new(csv_file, admin_user)
        
        expect {
          result = service.import
          expect(result[:success]).to be true
          expect(result[:created]).to eq(1)
          expect(result[:updated]).to eq(1)
          expect(result[:errors]).to eq(0)
        }.to change(Reimbursement, :count).by(1)
      end
      
      it 'creates audit work order for non-electronic reimbursements' do
        service = ReimbursementImportService.new(csv_file, admin_user)
        
        expect {
          service.import
        }.to change(AuditWorkOrder, :count).by(1)
        
        reimbursement = Reimbursement.find_by(invoice_number: 'R20250101001')
        expect(reimbursement.audit_work_orders.count).to eq(1)
        expect(reimbursement.audit_work_orders.first.status).to eq('pending')
      end
      
      it 'does not create audit work order for electronic reimbursements' do
        service = ReimbursementImportService.new(csv_file, admin_user)
        service.import
        
        reimbursement = Reimbursement.find_by(invoice_number: 'R20250101002')
        expect(reimbursement.audit_work_orders.count).to eq(0)
      end
    end
    
    context 'with invalid file' do
      it 'returns error when file is nil' do
        service = ReimbursementImportService.new(nil, admin_user)
        result = service.import
        
        expect(result[:success]).to be false
        expect(result[:errors]).to include("文件不存在")
      end
      
      it 'handles CSV parsing errors' do
        invalid_file = fixture_file_upload('files/invalid.csv', 'text/csv')
        
        # 创建无效的CSV文件
        File.open(Rails.root.join('spec/fixtures/files/invalid.csv'), 'w') do |file|
          file.write("This is not a valid CSV file")
        end
        
        service = ReimbursementImportService.new(invalid_file, admin_user)
        result = service.import
        
        expect(result[:success]).to be false
        expect(result[:errors]).to be_present
        
        # 删除测试文件
        File.delete(Rails.root.join('spec/fixtures/files/invalid.csv')) if File.exist?(Rails.root.join('spec/fixtures/files/invalid.csv'))
      end
    end
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/services/reimbursement_import_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：
   ```ruby
   # 创建测试CSV文件
   require 'csv'
   CSV.open('tmp/test_reimbursements.csv', 'w') do |csv|
     csv << ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签']
     csv << ['R20250101001', '测试报销单1', '张三', 'EMP001', '测试公司', '测试部门', '1000.00', '已收单', '处理中', '2025-01-01', '2025-01-01', '']
     csv << ['R20250101002', '测试报销单2', '李四', 'EMP002', '测试公司', '财务部', '2000.00', '未收单', '处理中', '', '2025-01-02', '全电子发票']
   end
   
   # 创建测试文件对象
   file = File.open('tmp/test_reimbursements.csv')
   def file.original_filename; 'test_reimbursements.csv'; end
   def file.content_type; 'text/csv'; end
   
   # 创建管理员用户
   admin_user = AdminUser.first || AdminUser.create!(email: 'admin@example.com', password: 'password')
   
   # 测试导入服务
   service = ReimbursementImportService.new(file, admin_user)
   result = service.import
   
   # 检查结果
   puts "导入结果: #{result.inspect}"
   puts "创建的报销单数量: #{Reimbursement.count}"
   puts "创建的审核工单数量: #{AuditWorkOrder.count}"
   
   # 检查非电子发票报销单是否创建了审核工单
   reimbursement = Reimbursement.find_by(invoice_number: 'R20250101001')
   puts "非电子发票报销单审核工单数量: #{reimbursement.audit_work_orders.count}"
   
   # 检查电子发票报销单是否没有创建审核工单
   reimbursement = Reimbursement.find_by(invoice_number: 'R20250101002')
   puts "电子发票报销单审核工单数量: #{reimbursement.audit_work_orders.count}"
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试报销单导入功能

## 注意事项

1. 确保CSV文件解析功能正确实现，特别是处理中文字符和日期格式
2. 确保数据验证功能正确实现，特别是必填字段的验证
3. 确保报销单创建或更新功能正确实现，特别是处理已存在报销单的更新
4. 确保根据报销单类型自动创建审核工单的功能正确实现
5. 确保导入结果统计和错误处理功能正确实现，特别是提供详细的错误信息
6. 确保导入服务的安全性，特别是防止SQL注入和文件上传漏洞