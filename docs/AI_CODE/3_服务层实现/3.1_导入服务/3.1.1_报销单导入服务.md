# 报销单导入服务实现

## 任务描述

实现报销单导入服务（ReimbursementImportService），负责从Excel或CSV文件中导入报销单数据到系统中，并根据报销单类型（电子发票或非电子发票）自动创建审核工单。

## 输入和依赖

- 基础模型（Reimbursement, AuditWorkOrder）
- Roo gem（用于处理Excel文件）
- 服务层设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的报销单导入服务实现，包括：
- 文件解析功能
- 报销单创建和更新逻辑
- 电子发票标记识别
- 非电子发票报销单自动创建审核工单功能
- 错误处理和报告
- 单元测试

## 详细实现步骤

### 1. 安装 Roo gem

确保在 Gemfile 中添加 Roo gem：

```ruby
gem 'roo', '~> 2.10.0'
```

然后运行：

```bash
bundle install
```

### 2. 创建报销单导入服务

创建 `app/services/reimbursement_import_service.rb` 文件：

```ruby
class ReimbursementImportService
  attr_reader :created_count, :updated_count, :error_count, :errors

  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @created_count = 0
    @updated_count = 0
    @error_count = 0
    @errors = []
  end

  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?

    begin
      spreadsheet = open_spreadsheet
      header = spreadsheet.row(1)
      
      # 将头部转换为符号形式，方便后续使用
      header_symbols = header.map { |h| h.to_s.strip.gsub(/\s+/, '_').downcase.to_sym }
      
      (2..spreadsheet.last_row).each do |i|
        row = Hash[[header_symbols, spreadsheet.row(i)].transpose]
        import_reimbursement(row, i)
      end

      {
        success: true,
        created: @created_count,
        updated: @updated_count,
        errors: @error_count,
        error_details: @errors
      }
    rescue => e
      Rails.logger.error "报销单导入错误: #{e.message}\n#{e.backtrace.join("\n")}"
      { success: false, errors: [e.message] }
    end
  end

  private

  def open_spreadsheet
    case File.extname(@file.original_filename)
    when '.csv'
      Roo::CSV.new(@file.path, csv_options: {encoding: 'utf-8'})
    when '.xls'
      Roo::Excel.new(@file.path)
    when '.xlsx'
      Roo::Excelx.new(@file.path)
    else
      raise "未知的文件类型: #{@file.original_filename}"
    end
  end

  def import_reimbursement(row, row_number)
    # 获取报销单号
    invoice_number = row[:报销单单号] || row[:invoice_number]

    # 检查必要字段
    unless invoice_number.present?
      @error_count += 1
      @errors << "行 #{row_number}: 报销单单号不能为空"
      return
    end

    # 查找或创建报销单
    reimbursement = Reimbursement.find_by(invoice_number: invoice_number)

    if reimbursement
      # 更新现有报销单
      update_reimbursement(reimbursement, row, row_number)
    else
      # 创建新报销单
      create_reimbursement(row, row_number)
    end
  end

  def create_reimbursement(row, row_number)
    # 准备报销单属性
    attributes = {
      invoice_number: row[:报销单单号] || row[:invoice_number],
      document_name: row[:单据名称] || row[:document_name],
      applicant: row[:报销单申请人] || row[:applicant],
      applicant_id: row[:报销单申请人工号] || row[:applicant_id],
      company: row[:申请人公司] || row[:company],
      department: row[:申请人部门] || row[:department],
      amount: row[:报销金额] || row[:amount],
      receipt_status: parse_receipt_status(row[:收单状态] || row[:receipt_status]),
      reimbursement_status: parse_reimbursement_status(row[:报销单状态] || row[:reimbursement_status]),
      receipt_date: parse_date(row[:收单日期] || row[:receipt_date]),
      submission_date: parse_date(row[:提交报销日期] || row[:submission_date]),
      is_electronic: parse_is_electronic(row[:单据标签] || row[:document_tag]),
      is_complete: parse_is_complete(row[:报销单状态] || row[:reimbursement_status])
    }

    # 创建报销单
    reimbursement = Reimbursement.new(attributes)

    if reimbursement.save
      @created_count += 1
      
      # 根据是否为电子发票决定是否创建审核工单
      create_audit_work_order_if_needed(reimbursement)
    else
      @error_count += 1
      @errors << "行 #{row_number}: #{reimbursement.errors.full_messages.join(', ')}"
    end
  end

  def update_reimbursement(reimbursement, row, row_number)
    # 准备更新属性
    attributes = {}
    attributes[:document_name] = row[:单据名称] || row[:document_name] if row[:单据名称].present? || row[:document_name].present?
    attributes[:applicant] = row[:报销单申请人] || row[:applicant] if row[:报销单申请人].present? || row[:applicant].present?
    attributes[:applicant_id] = row[:报销单申请人工号] || row[:applicant_id] if row[:报销单申请人工号].present? || row[:applicant_id].present?
    attributes[:company] = row[:申请人公司] || row[:company] if row[:申请人公司].present? || row[:company].present?
    attributes[:department] = row[:申请人部门] || row[:department] if row[:申请人部门].present? || row[:department].present?
    attributes[:amount] = row[:报销金额] || row[:amount] if row[:报销金额].present? || row[:amount].present?
    
    receipt_status = parse_receipt_status(row[:收单状态] || row[:receipt_status])
    attributes[:receipt_status] = receipt_status if receipt_status.present?
    
    reimbursement_status = parse_reimbursement_status(row[:报销单状态] || row[:reimbursement_status])
    attributes[:reimbursement_status] = reimbursement_status if reimbursement_status.present?
    
    receipt_date = parse_date(row[:收单日期] || row[:receipt_date])
    attributes[:receipt_date] = receipt_date if receipt_date.present?
    
    submission_date = parse_date(row[:提交报销日期] || row[:submission_date])
    attributes[:submission_date] = submission_date if submission_date.present?
    
    is_electronic = parse_is_electronic(row[:单据标签] || row[:document_tag])
    attributes[:is_electronic] = is_electronic unless is_electronic.nil?
    
    is_complete = parse_is_complete(row[:报销单状态] || row[:reimbursement_status])
    attributes[:is_complete] = is_complete unless is_complete.nil?

    # 更新报销单
    if attributes.present? && reimbursement.update(attributes)
      @updated_count += 1
      
      # 检查是否需要创建审核工单
      create_audit_work_order_if_needed(reimbursement)
    elsif attributes.present?
      @error_count += 1
      @errors << "行 #{row_number}: 更新失败 - #{reimbursement.errors.full_messages.join(', ')}"
    end
  end

  def create_audit_work_order_if_needed(reimbursement)
    # 根据07_refactoring_adjustments调整，无论是否为电子发票都创建审核工单
    # 但要确保不重复创建
    unless AuditWorkOrder.exists?(reimbursement_id: reimbursement.id, express_receipt_work_order_id: nil)
      AuditWorkOrder.create(
        reimbursement: reimbursement,
        status: 'pending',
        created_by: @current_admin_user.id
      )
    end
  end

  def parse_receipt_status(status)
    return nil unless status.present?
    
    status = status.to_s.downcase
    if status.include?('已收单') || status == 'received'
      'received'
    else
      'pending'
    end
  end

  def parse_reimbursement_status(status)
    return nil unless status.present?
    
    status = status.to_s.downcase
    if status.include?('已付款') || status.include?('已完成') || status == 'closed'
      'closed'
    else
      'processing'
    end
  end

  def parse_date(date_string)
    return nil unless date_string.present?
    
    begin
      if date_string.is_a?(String)
        Date.parse(date_string)
      else
        date_string # 可能已经是日期对象
      end
    rescue ArgumentError
      nil
    end
  end

  def parse_is_electronic(tag)
    return nil unless tag.present?
    
    tag = tag.to_s.downcase
    tag.include?('全电子') || tag.include?('electronic')
  end

  def parse_is_complete(status)
    return nil unless status.present?
    
    status = status.to_s.downcase
    status.include?('已付款') || status.include?('已完成') || status == 'closed'
  end
end
```

### 3. 创建报销单导入服务测试

创建 `spec/services/reimbursement_import_service_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe ReimbursementImportService, type: :service do
  let(:admin_user) { create(:admin_user) }
  let(:file_path) { Rails.root.join('spec', 'fixtures', 'files', 'test_reimbursements.xlsx') }
  let(:file) { fixture_file_upload(file_path, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') }
  
  # 准备测试文件
  before do
    # 确保测试目录存在
    FileUtils.mkdir_p(Rails.root.join('spec', 'fixtures', 'files'))
    
    # 创建测试Excel文件（如果不存在）
    unless File.exist?(file_path)
      workbook = WriteXLSX.new(file_path)
      worksheet = workbook.add_worksheet
      
      # 添加表头
      headers = ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', 
                '报销金额', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签']
      headers.each_with_index do |header, index|
        worksheet.write(0, index, header)
      end
      
      # 添加数据行
      data = [
        ['R20250101001', '测试报销单1', '张三', 'EMP001', '测试公司', '测试部门', 1000, '已收单', '处理中', '2025-01-01', '2025-01-01', '全电子发票'],
        ['R20250101002', '测试报销单2', '李四', 'EMP002', '测试公司', '财务部', 2000, '待收单', '处理中', nil, '2025-01-02', ''],
        ['R20250101003', '测试报销单3', '王五', 'EMP003', '测试公司', '市场部', 3000, '已收单', '已付款', '2025-01-03', '2025-01-03', '']
      ]
      
      data.each_with_index do |row, row_index|
        row.each_with_index do |value, col_index|
          worksheet.write(row_index + 1, col_index, value)
        end
      end
      
      workbook.close
    end
  end
  
  describe '#import' do
    context '当文件不存在时' do
      it '返回错误信息' do
        service = ReimbursementImportService.new(nil, admin_user)
        result = service.import
        
        expect(result[:success]).to be_falsey
        expect(result[:errors]).to include('文件不存在')
      end
    end
    
    context '当文件格式不支持时' do
      let(:invalid_file) { fixture_file_upload(Rails.root.join('spec', 'fixtures', 'files', 'test.txt'), 'text/plain') }
      
      it '返回错误信息' do
        allow(File).to receive(:extname).and_return('.txt')
        
        service = ReimbursementImportService.new(invalid_file, admin_user)
        expect { service.import }.to raise_error(/未知的文件类型/)
      end
    end
    
    context '当文件有效时' do
      it '导入报销单数据' do
        service = ReimbursementImportService.new(file, admin_user)
        
        expect {
          result = service.import
          expect(result[:success]).to be_truthy
          expect(result[:created]).to eq(3)
          expect(result[:updated]).to eq(0)
          expect(result[:errors]).to eq(0)
        }.to change(Reimbursement, :count).by(3)
      end
      
      it '为非电子发票报销单创建审核工单' do
        service = ReimbursementImportService.new(file, admin_user)
        
        expect {
          service.import
        }.to change(AuditWorkOrder, :count).by(3) # 根据07_refactoring_adjustments调整，无论是否为电子发票都创建审核工单
      end
      
      it '更新已存在的报销单' do
        # 先创建一个报销单
        create(:reimbursement, invoice_number: 'R20250101001', document_name: '旧名称')
        
        service = ReimbursementImportService.new(file, admin_user)
        
        expect {
          result = service.import
          expect(result[:success]).to be_truthy
          expect(result[:created]).to eq(2)
          expect(result[:updated]).to eq(1)
        }.to change(Reimbursement, :count).by(2)
        
        # 验证更新
        reimbursement = Reimbursement.find_by(invoice_number: 'R20250101001')
        expect(reimbursement.document_name).to eq('测试报销单1')
      end
      
      it '处理缺少必要字段的行' do
        # 创建一个缺少报销单号的测试文件
        invalid_file_path = Rails.root.join('spec', 'fixtures', 'files', 'invalid_reimbursements.xlsx')
        workbook = WriteXLSX.new(invalid_file_path)
        worksheet = workbook.add_worksheet
        
        # 添加表头
        headers = ['报销单单号', '单据名称', '报销单申请人']
        headers.each_with_index do |header, index|
          worksheet.write(0, index, header)
        end
        
        # 添加数据行（缺少报销单号）
        worksheet.write(1, 0, nil)
        worksheet.write(1, 1, '测试报销单')
        worksheet.write(1, 2, '张三')
        
        workbook.close
        
        invalid_file = fixture_file_upload(invalid_file_path, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
        service = ReimbursementImportService.new(invalid_file, admin_user)
        
        result = service.import
        expect(result[:success]).to be_truthy
        expect(result[:created]).to eq(0)
        expect(result[:errors]).to eq(1)
        expect(result[:error_details]).to include(/行 2: 报销单单号不能为空/)
      end
    end
  end
  
  describe '私有方法' do
    let(:service) { ReimbursementImportService.new(file, admin_user) }
    
    describe '#parse_receipt_status' do
      it '解析收单状态' do
        expect(service.send(:parse_receipt_status, '已收单')).to eq('received')
        expect(service.send(:parse_receipt_status, 'received')).to eq('received')
        expect(service.send(:parse_receipt_status, '待收单')).to eq('pending')
        expect(service.send(:parse_receipt_status, 'pending')).to eq('pending')
        expect(service.send(:parse_receipt_status, nil)).to be_nil
      end
    end
    
    describe '#parse_reimbursement_status' do
      it '解析报销单状态' do
        expect(service.send(:parse_reimbursement_status, '已付款')).to eq('closed')
        expect(service.send(:parse_reimbursement_status, '已完成')).to eq('closed')
        expect(service.send(:parse_reimbursement_status, 'closed')).to eq('closed')
        expect(service.send(:parse_reimbursement_status, '处理中')).to eq('processing')
        expect(service.send(:parse_reimbursement_status, 'processing')).to eq('processing')
        expect(service.send(:parse_reimbursement_status, nil)).to be_nil
      end
    end
    
    describe '#parse_date' do
      it '解析日期' do
        expect(service.send(:parse_date, '2025-01-01')).to eq(Date.parse('2025-01-01'))
        expect(service.send(:parse_date, Date.parse('2025-01-01'))).to eq(Date.parse('2025-01-01'))
        expect(service.send(:parse_date, 'invalid date')).to be_nil
        expect(service.send(:parse_date, nil)).to be_nil
      end
    end
    
    describe '#parse_is_electronic' do
      it '解析是否为电子发票' do
        expect(service.send(:parse_is_electronic, '全电子发票')).to be_truthy
        expect(service.send(:parse_is_electronic, 'electronic')).to be_truthy
        expect(service.send(:parse_is_electronic, '纸质发票')).to be_falsey
        expect(service.send(:parse_is_electronic, nil)).to be_nil
      end
    end
    
    describe '#parse_is_complete' do
      it '解析是否完成' do
        expect(service.send(:parse_is_complete, '已付款')).to be_truthy
        expect(service.send(:parse_is_complete, '已完成')).to be_truthy
        expect(service.send(:parse_is_complete, 'closed')).to be_truthy
        expect(service.send(:parse_is_complete, '处理中')).to be_falsey
        expect(service.send(:parse_is_complete, nil)).to be_nil
      end
    end
  end
end
```

### 4. 创建 ActiveAdmin 导入界面

在 `app/admin/reimbursements.rb` 文件中添加导入功能：

```ruby
ActiveAdmin.register Reimbursement do
  # ... 其他配置 ...

  # 自定义操作
  action_item :import, only: :index do
    link_to "导入报销单", new_import_admin_reimbursements_path
  end

  # 自定义页面
  collection_action :new_import, method: :get do
    render "admin/reimbursements/new_import"
  end

  collection_action :import, method: :post do
    # 调用导入服务
    service = ReimbursementImportService.new(params[:file], current_admin_user)
    result = service.import
    if result[:success]
      redirect_to admin_reimbursements_path, notice: "导入成功: #{result[:created]} 创建, #{result[:updated]} 更新, #{result[:errors]} 错误."
    else
      # 错误处理，可能需要渲染 new_import 并显示错误
      redirect_to new_import_admin_reimbursements_path, alert: "导入失败: #{result[:errors].join(', ')}"
    end
  end

  # ... 其他配置 ...
end
```

创建 `app/views/admin/reimbursements/new_import.html.erb` 文件：

```erb
<h2>导入报销单</h2>

<%= form_tag import_admin_reimbursements_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择文件</th>
            <td><%= file_field_tag :file, accept: '.csv,.xlsx,.xls', required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_reimbursements_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV或Excel文件应包含以下列：</p>
    <ul>
      <li>报销单单号（必填）</li>
      <li>单据名称</li>
      <li>报销单申请人</li>
      <li>报销单申请人工号</li>
      <li>申请人公司</li>
      <li>申请人部门</li>
      <li>报销金额（单据币种）</li>
      <li>收单状态</li>
      <li>报销单状态</li>
      <li>收单日期</li>
      <li>提交报销日期</li>
      <li>单据标签</li>
    </ul>
  </div>
</div>
```

## 测试验证方法

1. 运行 `rspec spec/services/reimbursement_import_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：

```ruby
# 假设已经有一个测试文件
file_path = Rails.root.join('spec', 'fixtures', 'files', 'test_reimbursements.xlsx')
file = File.open(file_path)
admin_user = AdminUser.first

# 创建服务实例
service = ReimbursementImportService.new(file, admin_user)

# 执行导入
result = service.import
puts "导入结果: #{result.inspect}"

# 检查导入的报销单
reimbursements = Reimbursement.last(3)
reimbursements.each do |r|
  puts "报销单 #{r.invoice_number}: #{r.document_name}, 电子发票: #{r.is_electronic}, 状态: #{r.reimbursement_status}"
end

# 检查创建的审核工单
audit_work_orders = AuditWorkOrder.last(3)
audit_work_orders.each do |awo|
  puts "审核工单 #{awo.id}: 报销单 #{awo.reimbursement.invoice_number}, 状态: #{awo.status}"
end
```

3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试报销单导入功能

## 注意事项

1. 确保 Roo gem 正确安装和配置
2. 确保导入逻辑正确处理各种边缘情况，如缺少必要字段、格式错误等
3. 确保根据07_refactoring_adjustments调整，无论是否为电子发票都创建审核工单
4. 确保错误处理和日志记录功能正确实现
5. 确保测试覆盖所有关键功能，特别是文件解析、数据导入和审核工单创建
6. 考虑大文件导入的性能问题，可能需要使用批量导入或后台任务