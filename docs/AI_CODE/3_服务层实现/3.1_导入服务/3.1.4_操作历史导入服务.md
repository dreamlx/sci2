# 操作历史导入服务实现

## 任务描述

实现操作历史导入服务（OperationHistoryImportService），负责从Excel或CSV文件中导入操作历史数据到系统中，并根据操作历史更新报销单状态。该服务需要处理未匹配到报销单的操作历史记录，并提供错误处理和报告功能。

## 输入和依赖

- 基础模型（Reimbursement, OperationHistory）
- Roo gem（用于处理Excel文件）
- 服务层设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的操作历史导入服务实现，包括：
- 文件解析功能
- 报销单匹配逻辑
- 操作历史创建逻辑
- 报销单状态更新逻辑
- 未匹配记录处理
- 错误处理和报告
- 单元测试

## 详细实现步骤

### 1. 创建操作历史导入服务

创建 `app/services/operation_history_import_service.rb` 文件：

```ruby
class OperationHistoryImportService
  attr_reader :imported_count, :updated_count, :error_count, :errors, :unmatched_histories

  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @imported_count = 0
    @updated_count = 0
    @error_count = 0
    @errors = []
    @unmatched_histories = []
  end

  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?

    begin
      spreadsheet = open_spreadsheet
      header = spreadsheet.row(1)
      
      # 将头部转换为符号形式，方便后续使用
      header_symbols = header.map { |h| h.to_s.strip.gsub(/\s+/, '_').downcase.to_sym }
      
      (2..spreadsheet.last_row).each do |i|
        row = Hash[[header_symbols, spreadsheet.row(i)].transpose]
        import_operation_history(row, i)
      end

      {
        success: true,
        imported: @imported_count,
        updated: @updated_count,
        errors: @error_count,
        error_details: @errors,
        unmatched_histories: @unmatched_histories
      }
    rescue => e
      Rails.logger.error "操作历史导入错误: #{e.message}\n#{e.backtrace.join("\n")}"
      { success: false, errors: [e.message] }
    end
  end

  private

  def open_spreadsheet
    case File.extname(@file.original_filename)
    when '.csv'
      Roo::CSV.new(@file.path, csv_options: {encoding: 'utf-8'})
    when '.xls'
      Roo::Excel.new(@file.path)
    when '.xlsx'
      Roo::Excelx.new(@file.path)
    else
      raise "未知的文件类型: #{@file.original_filename}"
    end
  end

  def import_operation_history(row, row_number)
    # 获取单据编号和操作类型
    document_number = extract_document_number(row)
    operation_type = extract_operation_type(row)

    # 检查必要字段
    unless document_number.present? && operation_type.present?
      @error_count += 1
      @errors << "行 #{row_number}: 单据编号或操作类型不能为空"
      return
    end

    # 查找对应的报销单
    reimbursement = Reimbursement.find_by(invoice_number: document_number)

    unless reimbursement
      # 记录未匹配的操作历史
      @unmatched_count += 1
      @unmatched_histories << {
        original_data: row,
        document_number: document_number,
        error: "报销单不存在"
      }
      return
    end

    # 创建操作历史记录
    operation_history = create_operation_history(row, document_number)
    
    if operation_history.persisted?
      @imported_count += 1
      
      # 检查是否为审批相关操作，并更新报销单状态
      if is_approval_operation?(operation_type)
        update_reimbursement_status(reimbursement, operation_type)
        @updated_count += 1
      end
    else
      @error_count += 1
      @errors << "行 #{row_number}: 创建操作历史失败 - #{operation_history.errors.full_messages.join(', ')}"
    end
  end

  def create_operation_history(row, document_number)
    OperationHistory.create(
      document_number: document_number,
      operation_type: extract_operation_type(row),
      operation_time: parse_date(extract_operation_time(row)),
      operator: extract_operator(row),
      notes: extract_notes(row)
    )
  end

  def update_reimbursement_status(reimbursement, operation_type)
    if is_payment_operation?(operation_type) || is_completion_operation?(operation_type)
      reimbursement.mark_as_complete
    end
  end

  def is_approval_operation?(operation_type)
    operation_type.to_s.downcase.include?('审批') || 
    operation_type.to_s.downcase.include?('审核') || 
    operation_type.to_s.downcase.include?('批准') || 
    operation_type.to_s.downcase.include?('通过') || 
    operation_type.to_s.downcase.include?('approval')
  end

  def is_payment_operation?(operation_type)
    operation_type.to_s.downcase.include?('付款') || 
    operation_type.to_s.downcase.include?('支付') || 
    operation_type.to_s.downcase.include?('payment')
  end

  def is_completion_operation?(operation_type)
    operation_type.to_s.downcase.include?('完成') || 
    operation_type.to_s.downcase.include?('结束') || 
    operation_type.to_s.downcase.include?('关闭') || 
    operation_type.to_s.downcase.include?('completed') || 
    operation_type.to_s.downcase.include?('closed')
  end

  def extract_document_number(row)
    row[:单据编号] || row[:报销单单号] || row[:document_number] || ''
  end

  def extract_operation_type(row)
    row[:操作类型] || row[:operation_type] || ''
  end

  def extract_operation_time(row)
    row[:操作日期] || row[:操作时间] || row[:operation_time] || row[:operation_date]
  end

  def extract_operator(row)
    row[:操作人] || row[:operator] || ''
  end

  def extract_notes(row)
    row[:操作意见] || row[:备注] || row[:notes] || ''
  end

  def parse_date(date_string)
    return nil unless date_string.present?
    
    begin
      if date_string.is_a?(String)
        DateTime.parse(date_string)
      else
        date_string # 可能已经是日期对象
      end
    rescue ArgumentError
      nil
    end
  end
end
```

### 2. 创建操作历史导入服务测试

创建 `spec/services/operation_history_import_service_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe OperationHistoryImportService, type: :service do
  let(:admin_user) { create(:admin_user) }
  let(:file_path) { Rails.root.join('spec', 'fixtures', 'files', 'test_operation_histories.xlsx') }
  let(:file) { fixture_file_upload(file_path, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') }
  
  # 准备测试文件和数据
  before do
    # 确保测试目录存在
    FileUtils.mkdir_p(Rails.root.join('spec', 'fixtures', 'files'))
    
    # 创建测试报销单
    @reimbursement1 = create(:reimbursement, invoice_number: 'R20250101001', is_complete: false, reimbursement_status: 'processing')
    @reimbursement2 = create(:reimbursement, invoice_number: 'R20250101002', is_complete: false, reimbursement_status: 'processing')
    
    # 创建测试Excel文件（如果不存在）
    unless File.exist?(file_path)
      workbook = WriteXLSX.new(file_path)
      worksheet = workbook.add_worksheet
      
      # 添加表头
      headers = ['单据编号', '操作类型', '操作日期', '操作人', '操作意见']
      headers.each_with_index do |header, index|
        worksheet.write(0, index, header)
      end
      
      # 添加数据行
      data = [
        ['R20250101001', '审批通过', '2025-01-01', '张三', '审批通过，准予报销'],
        ['R20250101001', '已付款', '2025-01-02', '李四', '已完成付款'],
        ['R20250101002', '审核中', '2025-01-01', '王五', '正在审核中'],
        ['R20250101003', '审批通过', '2025-01-03', '赵六', '审批通过，准予报销']
      ]
      
      data.each_with_index do |row, row_index|
        row.each_with_index do |value, col_index|
          worksheet.write(row_index + 1, col_index, value)
        end
      end
      
      workbook.close
    end
  end
  
  describe '#import' do
    context '当文件不存在时' do
      it '返回错误信息' do
        service = OperationHistoryImportService.new(nil, admin_user)
        result = service.import
        
        expect(result[:success]).to be_falsey
        expect(result[:errors]).to include('文件不存在')
      end
    end
    
    context '当文件格式不支持时' do
      let(:invalid_file) { fixture_file_upload(Rails.root.join('spec', 'fixtures', 'files', 'test.txt'), 'text/plain') }
      
      it '返回错误信息' do
        allow(File).to receive(:extname).and_return('.txt')
        
        service = OperationHistoryImportService.new(invalid_file, admin_user)
        expect { service.import }.to raise_error(/未知的文件类型/)
      end
    end
    
    context '当文件有效时' do
      it '导入操作历史数据' do
        service = OperationHistoryImportService.new(file, admin_user)
        
        expect {
          result = service.import
          expect(result[:success]).to be_truthy
          expect(result[:imported]).to eq(3) # 只有三个操作历史能匹配到报销单
          expect(result[:updated]).to eq(1) # 只有一个报销单状态被更新（已付款）
          expect(result[:errors]).to eq(0)
        }.to change(OperationHistory, :count).by(3)
      end
      
      it '更新报销单状态' do
        service = OperationHistoryImportService.new(file, admin_user)
        service.import
        
        # 检查第一个报销单状态是否更新为已完成
        @reimbursement1.reload
        expect(@reimbursement1.is_complete).to be_truthy
        expect(@reimbursement1.reimbursement_status).to eq('closed')
        
        # 检查第二个报销单状态是否保持不变
        @reimbursement2.reload
        expect(@reimbursement2.is_complete).to be_falsey
        expect(@reimbursement2.reimbursement_status).to eq('processing')
      end
      
      it '记录未匹配的操作历史' do
        service = OperationHistoryImportService.new(file, admin_user)
        result = service.import
        
        expect(result[:unmatched]).to eq(1)
        expect(result[:unmatched_histories].size).to eq(1)
        expect(result[:unmatched_histories][0][:document_number]).to eq('R20250101003')
        expect(result[:unmatched_histories][0][:error]).to eq('报销单不存在')
      end
      
      it '处理缺少必要字段的行' do
        # 创建一个缺少操作类型的测试文件
        invalid_file_path = Rails.root.join('spec', 'fixtures', 'files', 'invalid_operation_histories.xlsx')
        workbook = WriteXLSX.new(invalid_file_path)
        worksheet = workbook.add_worksheet
        
        # 添加表头
        headers = ['单据编号', '操作类型', '操作日期', '操作人', '操作意见']
        headers.each_with_index do |header, index|
          worksheet.write(0, index, header)
        end
        
        # 添加数据行（缺少操作类型）
        worksheet.write(1, 0, 'R20250101001')
        worksheet.write(1, 1, nil)
        worksheet.write(1, 2, '2025-01-01')
        worksheet.write(1, 3, '张三')
        worksheet.write(1, 4, '审批通过，准予报销')
        
        workbook.close
        
        invalid_file = fixture_file_upload(invalid_file_path, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
        service = OperationHistoryImportService.new(invalid_file, admin_user)
        
        result = service.import
        expect(result[:success]).to be_truthy
        expect(result[:imported]).to eq(0)
        expect(result[:errors]).to eq(1)
        expect(result[:error_details]).to include(/行 2: 单据编号或操作类型不能为空/)
      end
    end
  end
  
  describe '私有方法' do
    let(:service) { OperationHistoryImportService.new(file, admin_user) }
    let(:sample_row) { {
      单据编号: 'R20250101001',
      操作类型: '审批通过',
      操作日期: '2025-01-01',
      操作人: '张三',
      操作意见: '审批通过，准予报销'
    } }
    
    describe '#extract_document_number' do
      it '提取单据编号' do
        expect(service.send(:extract_document_number, sample_row)).to eq('R20250101001')
        expect(service.send(:extract_document_number, { 报销单单号: 'R20250101002' })).to eq('R20250101002')
        expect(service.send(:extract_document_number, { document_number: 'R20250101003' })).to eq('R20250101003')
        expect(service.send(:extract_document_number, {})).to eq('')
      end
    end
    
    describe '#extract_operation_type' do
      it '提取操作类型' do
        expect(service.send(:extract_operation_type, sample_row)).to eq('审批通过')
        expect(service.send(:extract_operation_type, { operation_type: '已付款' })).to eq('已付款')
        expect(service.send(:extract_operation_type, {})).to eq('')
      end
    end
    
    describe '#is_approval_operation?' do
      it '判断是否为审批操作' do
        expect(service.send(:is_approval_operation?, '审批通过')).to be_truthy
        expect(service.send(:is_approval_operation?, '审核完成')).to be_truthy
        expect(service.send(:is_approval_operation?, '批准')).to be_truthy
        expect(service.send(:is_approval_operation?, 'approval')).to be_truthy
        expect(service.send(:is_approval_operation?, '提交')).to be_falsey
      end
    end
    
    describe '#is_payment_operation?' do
      it '判断是否为付款操作' do
        expect(service.send(:is_payment_operation?, '已付款')).to be_truthy
        expect(service.send(:is_payment_operation?, '支付完成')).to be_truthy
        expect(service.send(:is_payment_operation?, 'payment')).to be_truthy
        expect(service.send(:is_payment_operation?, '审批')).to be_falsey
      end
    end
    
    describe '#is_completion_operation?' do
      it '判断是否为完成操作' do
        expect(service.send(:is_completion_operation?, '已完成')).to be_truthy
        expect(service.send(:is_completion_operation?, '已结束')).to be_truthy
        expect(service.send(:is_completion_operation?, '已关闭')).to be_truthy
        expect(service.send(:is_completion_operation?, 'completed')).to be_truthy
        expect(service.send(:is_completion_operation?, 'closed')).to be_truthy
        expect(service.send(:is_completion_operation?, '审批')).to be_falsey
      end
    end
    
    describe '#parse_date' do
      it '解析日期' do
        expect(service.send(:parse_date, '2025-01-01')).to eq(DateTime.parse('2025-01-01'))
        expect(service.send(:parse_date, DateTime.parse('2025-01-01'))).to eq(DateTime.parse('2025-01-01'))
        expect(service.send(:parse_date, 'invalid date')).to be_nil
        expect(service.send(:parse_date, nil)).to be_nil
      end
    end
  end
end
```

### 3. 创建 ActiveAdmin 导入界面

在 `app/admin/operation_histories.rb` 文件中添加导入功能：

```ruby
ActiveAdmin.register OperationHistory do
  # ... 其他配置 ...

  # 自定义操作
  action_item :import, only: :index do
    link_to "导入操作历史", new_import_admin_operation_histories_path
  end

  # 自定义页面
  collection_action :new_import, method: :get do
    render "admin/operation_histories/new_import"
  end

  collection_action :import, method: :post do
    # 调用导入服务
    service = OperationHistoryImportService.new(params[:file], current_admin_user)
    result = service.import
    
    if result[:success]
      if result[:unmatched] > 0
        redirect_to admin_operation_histories_path, notice: "导入成功: #{result[:imported]} 导入, #{result[:updated]} 报销单状态更新, #{result[:unmatched]} 未匹配, #{result[:errors]} 错误. 未匹配的操作历史对应的报销单不存在."
      else
        redirect_to admin_operation_histories_path, notice: "导入成功: #{result[:imported]} 导入, #{result[:updated]} 报销单状态更新, #{result[:unmatched]} 未匹配, #{result[:errors]} 错误."
      end
    else
      redirect_to new_import_admin_operation_histories_path, alert: "导入失败: #{result[:errors].join(', ')}"
    end
  end

  # ... 其他配置 ...
end
```

创建 `app/views/admin/operation_histories/new_import.html.erb` 文件：

```erb
<h2>导入操作历史</h2>

<%= form_tag import_admin_operation_histories_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择文件</th>
            <td><%= file_field_tag :file, accept: '.csv,.xlsx,.xls', required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_operation_histories_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV或Excel文件应包含以下列：</p>
    <ul>
      <li>单据编号/报销单单号（必填）</li>
      <li>操作类型（必填）</li>
      <li>操作日期/操作时间（可选）</li>
      <li>操作人（可选）</li>
      <li>操作意见/备注（可选）</li>
    </ul>
    <p>注意：导入的操作历史将根据操作类型自动更新报销单状态。例如，"已付款"、"已完成"等操作类型会将报销单标记为已完成。</p>
  </div>
</div>
```

## 测试验证方法

1. 运行 `rspec spec/services/operation_history_import_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：

```ruby
# 假设已经有一个测试文件
file_path = Rails.root.join('spec', 'fixtures', 'files', 'test_operation_histories.xlsx')
file = File.open(file_path)
admin_user = AdminUser.first

# 创建测试报销单
reimbursement1 = Reimbursement.create!(
  invoice_number: 'R20250101001',
  document_name: '测试报销单1',
  applicant: '张三',
  applicant_id: 'EMP001',
  company: '测试公司',
  department: '测试部门',
  amount: 1000.00,
  is_complete: false,
  reimbursement_status: 'processing'
)

reimbursement2 = Reimbursement.create!(
  invoice_number: 'R20250101002',
  document_name: '测试报销单2',
  applicant: '李四',
  applicant_id: 'EMP002',
  company: '测试公司',
  department: '财务部',
  amount: 2000.00,
  is_complete: false,
  reimbursement_status: 'processing'
)

# 创建服务实例
service = OperationHistoryImportService.new(file, admin_user)

# 执行导入
result = service.import
puts "导入结果: #{result.inspect}"

# 检查导入的操作历史
operation_histories = OperationHistory.last(3)
operation_histories.each do |oh|
  puts "操作历史 #{oh.id}: 单据编号 #{oh.document_number}, 操作类型: #{oh.operation_type}, 操作时间: #{oh.operation_time}, 操作人: #{oh.operator}"
end

# 检查报销单状态
reimbursement1.reload
reimbursement2.reload
puts "报销单1 状态: #{reimbursement1.reimbursement_status}, 是否完成: #{reimbursement1.is_complete}"
puts "报销单2 状态: #{reimbursement2.reimbursement_status}, 是否完成: #{reimbursement2.is_complete}"
```

3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试操作历史导入功能

## 注意事项

1. 确保 Roo gem 正确安装和配置
2. 确保导入逻辑正确处理各种边缘情况，如缺少必要字段、格式错误等
3. 确保报销单状态更新逻辑正确实现，特别是对于不同类型的操作
4. 确保未匹配记录的处理逻辑正确实现
5. 确保错误处理和日志记录功能正确实现
6. 确保测试覆盖所有关键功能，特别是文件解析、数据导入和报销单状态更新
7. 考虑大文件导入的性能问题，可能需要使用批量导入或后台任务