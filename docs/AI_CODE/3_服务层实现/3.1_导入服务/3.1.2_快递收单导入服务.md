# 快递收单导入服务实现

## 任务描述

实现快递收单导入服务（ExpressReceiptImportService），负责从Excel或CSV文件中导入快递收单数据到系统中，创建快递收单记录和快递收单工单，并更新报销单收单状态。该服务还需要处理未匹配到报销单的快递收单记录，并提供手动匹配功能。

## 输入和依赖

- 基础模型（Reimbursement, ExpressReceipt, ExpressReceiptWorkOrder）
- Roo gem（用于处理Excel文件）
- 服务层设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的快递收单导入服务实现，包括：
- 文件解析功能
- 报销单匹配逻辑
- 快递收单记录创建逻辑
- 快递收单工单创建逻辑
- 报销单状态更新逻辑
- 未匹配记录处理
- 手动匹配功能
- 错误处理和报告
- 单元测试

## 详细实现步骤

### 1. 创建快递收单导入服务

创建 `app/services/express_receipt_import_service.rb` 文件：

```ruby
class ExpressReceiptImportService
  attr_reader :matched_count, :unmatched_count, :error_count, :errors, :unmatched_receipts

  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @matched_count = 0
    @unmatched_count = 0
    @error_count = 0
    @errors = []
    @unmatched_receipts = []
  end

  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?

    begin
      spreadsheet = open_spreadsheet
      header = spreadsheet.row(1)
      
      # 将头部转换为符号形式，方便后续使用
      header_symbols = header.map { |h| h.to_s.strip.gsub(/\s+/, '_').downcase.to_sym }
      
      (2..spreadsheet.last_row).each do |i|
        row = Hash[[header_symbols, spreadsheet.row(i)].transpose]
        import_express_receipt(row, i)
      end

      {
        success: true,
        matched: @matched_count,
        unmatched: @unmatched_count,
        errors: @error_count,
        error_details: @errors,
        unmatched_receipts: @unmatched_receipts
      }
    rescue => e
      Rails.logger.error "快递收单导入错误: #{e.message}\n#{e.backtrace.join("\n")}"
      { success: false, errors: [e.message] }
    end
  end
def manual_match(tracking_number, reimbursement_id)
    # 查找未匹配的快递收单记录
    unmatched_data = @unmatched_receipts.find { |r| r[:tracking_number] == tracking_number }
    
    # 查找报销单
    reimbursement = Reimbursement.find_by(id: reimbursement_id)
    
    unless unmatched_data && reimbursement
      return { success: false, errors: ["无法找到未匹配的快递收单记录或报销单"] }
    end
    
    # 创建快递收单记录
    express_receipt = create_express_receipt(unmatched_data[:original_data], reimbursement.invoice_number)
    
    if express_receipt.persisted?
      # 更新报销单收单状态
      reimbursement.mark_as_received(express_receipt.receive_date)
      
      # 创建快递收单工单
      work_order = create_express_receipt_work_order(express_receipt, reimbursement)
      
      if work_order.persisted?
        return { 
          success: true, 
          express_receipt_id: express_receipt.id,
          work_order_id: work_order.id
        }
      else
        return { 
          success: false, 
          errors: ["创建快递收单工单失败: #{work_order.errors.full_messages.join(', ')}"] 
        }
      end
    else
      return { 
        success: false, 
        errors: ["创建快递收单记录失败: #{express_receipt.errors.full_messages.join(', ')}"] 
      }
    end
  end

  private

  def open_spreadsheet
    case File.extname(@file.original_filename)
    when '.csv'
      Roo::CSV.new(@file.path, csv_options: {encoding: 'utf-8'})
    when '.xls'
      Roo::Excel.new(@file.path)
    when '.xlsx'
      Roo::Excelx.new(@file.path)
    else
      raise "未知的文件类型: #{@file.original_filename}"
    end
  end

  def import_express_receipt(row, row_number)
    # 获取单据编号和快递单号
    document_number = extract_document_number(row)
    tracking_number = extract_tracking_number(row)

    # 检查必要字段
    unless document_number.present? && tracking_number.present?
      @error_count += 1
      @errors << "行 #{row_number}: 单据编号或快递单号不能为空"
      return
    end

    # 查找对应的报销单
    reimbursement = Reimbursement.find_by(invoice_number: document_number)

    unless reimbursement
      # 记录未匹配的快递单
      @unmatched_count += 1
      @unmatched_receipts << {
        original_data: row,
        document_number: document_number,
        tracking_number: tracking_number,
        error: "报销单不存在"
      }
      return
    end

    # 创建快递收单记录
    express_receipt = create_express_receipt(row, document_number)
    
    if express_receipt.persisted?
      # 更新报销单收单状态
      reimbursement.mark_as_received(express_receipt.receive_date)
      
      # 创建快递收单工单
      work_order = create_express_receipt_work_order(express_receipt, reimbursement)
      
      if work_order.persisted?
        @matched_count += 1
      else
        @error_count += 1
        @errors << "行 #{row_number}: 创建快递收单工单失败 - #{work_order.errors.full_messages.join(', ')}"
      end
    else
      @error_count += 1
      @errors << "行 #{row_number}: 创建快递收单记录失败 - #{express_receipt.errors.full_messages.join(', ')}"
    end
  end

  def create_express_receipt(row, document_number)
    ExpressReceipt.create(
      document_number: document_number,
      tracking_number: extract_tracking_number(row),
      receive_date: parse_date(row[:操作时间] || row[:operation_time]),
      receiver: row[:操作人] || row[:operator] || @current_admin_user.email,
      courier_company: extract_courier_company(row)
    )
  end

  def create_express_receipt_work_order(express_receipt, reimbursement)
    # 检查是否已存在相同的快递收单工单
    existing_work_order = ExpressReceiptWorkOrder.find_by(
      reimbursement_id: reimbursement.id,
      tracking_number: express_receipt.tracking_number
    )
    
    return existing_work_order if existing_work_order
    
    # 创建新的快递收单工单
    ExpressReceiptWorkOrder.create(
      reimbursement: reimbursement,
      status: 'received',
      tracking_number: express_receipt.tracking_number,
      received_at: express_receipt.receive_date,
      courier_name: express_receipt.courier_company,
      created_by: @current_admin_user.id
    )
  end

  def extract_document_number(row)
    row[:单号] || row[:单据编号] || row[:document_number] || ''
  end

  def extract_tracking_number(row)
    # 尝试从操作意见中提取快递单号
    if row[:操作意见].present? && row[:操作意见] =~ /快递单号[：:]\s*(\w+)/
      $1.strip
    else
      # 尝试从其他列获取
      row[:快递单号] || row[:tracking_number] || "未知-#{Time.now.to_i}"
    end
  end

  def extract_courier_company(row)
    # 尝试从操作意见中提取快递公司
    if row[:操作意见].present?
      if row[:操作意见].include?('顺丰')
        '顺丰'
      elsif row[:操作意见].include?('圆通')
        '圆通'
      elsif row[:操作意见].include?('中通')
        '中通'
      elsif row[:操作意见].include?('申通')
        '申通'
      elsif row[:操作意见].include?('韵达')
        '韵达'
      elsif row[:操作意见].include?('邮政')
        '邮政'
      elsif row[:操作意见].include?('EMS')
        'EMS'
      else
        '其他'
      end
    else
      row[:快递公司] || row[:courier_company] || '未知'
    end
  end

  def parse_date(date_string)
    return Time.current unless date_string.present?
    
    begin
      if date_string.is_a?(String)
        DateTime.parse(date_string)
      else
        date_string # 可能已经是日期对象
      end
    rescue ArgumentError
      Time.current
    end
  end
end
```
### 2. 创建快递收单导入服务测试

创建 `spec/services/express_receipt_import_service_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe ExpressReceiptImportService, type: :service do
  let(:admin_user) { create(:admin_user) }
  let(:file_path) { Rails.root.join('spec', 'fixtures', 'files', 'test_express_receipts.xlsx') }
  let(:file) { fixture_file_upload(file_path, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') }
  
  # 准备测试文件和数据
  before do
    # 确保测试目录存在
    FileUtils.mkdir_p(Rails.root.join('spec', 'fixtures', 'files'))
    
    # 创建测试报销单
    @reimbursement1 = create(:reimbursement, invoice_number: 'R20250101001')
    @reimbursement2 = create(:reimbursement, invoice_number: 'R20250101002')
    
    # 创建测试Excel文件（如果不存在）
    unless File.exist?(file_path)
      workbook = WriteXLSX.new(file_path)
      worksheet = workbook.add_worksheet
      
      # 添加表头
      headers = ['单号', '操作人', '操作时间', '操作意见', '快递单号', '快递公司']
      headers.each_with_index do |header, index|
        worksheet.write(0, index, header)
      end
      
      # 添加数据行
      data = [
        ['R20250101001', '张三', '2025-01-01 10:00:00', '已收到快递，快递单号: SF123456', nil, nil],
        ['R20250101002', '李四', '2025-01-02 11:00:00', '顺丰快递已收到，快递单号: SF789012', nil, nil],
        ['R20250101003', '王五', '2025-01-03 12:00:00', '圆通快递已收到，快递单号: YT345678', nil, nil]
      ]
      
      data.each_with_index do |row, row_index|
        row.each_with_index do |value, col_index|
          worksheet.write(row_index + 1, col_index, value)
        end
      end
      
      workbook.close
    end
  end
  
  describe '#import' do
    context '当文件不存在时' do
      it '返回错误信息' do
        service = ExpressReceiptImportService.new(nil, admin_user)
        result = service.import
        
        expect(result[:success]).to be_falsey
        expect(result[:errors]).to include('文件不存在')
      end
    end
    
    context '当文件格式不支持时' do
      let(:invalid_file) { fixture_file_upload(Rails.root.join('spec', 'fixtures', 'files', 'test.txt'), 'text/plain') }
      
      it '返回错误信息' do
        allow(File).to receive(:extname).and_return('.txt')
        
        service = ExpressReceiptImportService.new(invalid_file, admin_user)
        expect { service.import }.to raise_error(/未知的文件类型/)
      end
    end
    
    context '当文件有效时' do
      it '导入快递收单数据' do
        service = ExpressReceiptImportService.new(file, admin_user)
        
        expect {
          result = service.import
          expect(result[:success]).to be_truthy
          expect(result[:matched]).to eq(2) # 只有两个报销单能匹配
          expect(result[:unmatched]).to eq(1) # 一个报销单不存在
          expect(result[:errors]).to eq(0)
        }.to change(ExpressReceipt, :count).by(2)
         .and change(ExpressReceiptWorkOrder, :count).by(2)
      end
      
      it '更新报销单收单状态' do
        service = ExpressReceiptImportService.new(file, admin_user)
        service.import
        
        @reimbursement1.reload
        @reimbursement2.reload
        
        expect(@reimbursement1.receipt_status).to eq('received')
        expect(@reimbursement1.receipt_date).not_to be_nil
        
        expect(@reimbursement2.receipt_status).to eq('received')
        expect(@reimbursement2.receipt_date).not_to be_nil
      end
      
      it '记录未匹配的快递单' do
        service = ExpressReceiptImportService.new(file, admin_user)
        result = service.import
        
        expect(result[:unmatched]).to eq(1)
        expect(result[:unmatched_receipts].size).to eq(1)
        expect(result[:unmatched_receipts][0][:document_number]).to eq('R20250101003')
        expect(result[:unmatched_receipts][0][:tracking_number]).to eq('YT345678')
        expect(result[:unmatched_receipts][0][:error]).to eq('报销单不存在')
      end
      
      it '处理缺少必要字段的行' do
        # 创建一个缺少单号的测试文件
        invalid_file_path = Rails.root.join('spec', 'fixtures', 'files', 'invalid_express_receipts.xlsx')
        workbook = WriteXLSX.new(invalid_file_path)
        worksheet = workbook.add_worksheet
        
        # 添加表头
        headers = ['单号', '操作人', '操作时间', '操作意见']
        headers.each_with_index do |header, index|
          worksheet.write(0, index, header)
        end
        
        # 添加数据行（缺少单号）
        worksheet.write(1, 0, nil)
        worksheet.write(1, 1, '张三')
        worksheet.write(1, 2, '2025-01-01 10:00:00')
        worksheet.write(1, 3, '已收到快递')
        
        workbook.close
        
        invalid_file = fixture_file_upload(invalid_file_path, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
        service = ExpressReceiptImportService.new(invalid_file, admin_user)
        
        result = service.import
        expect(result[:success]).to be_truthy
        expect(result[:matched]).to eq(0)
        expect(result[:errors]).to eq(1)
        expect(result[:error_details]).to include(/行 2: 单据编号或快递单号不能为空/)
      end
    end
  end
  
  describe '#manual_match' do
    it '手动匹配未匹配的快递单' do
      # 先导入数据，产生未匹配记录
      service = ExpressReceiptImportService.new(file, admin_user)
      import_result = service.import
      
      # 创建一个新的报销单用于手动匹配
      new_reimbursement = create(:reimbursement, invoice_number: 'R20250101003')
      
      # 获取未匹配记录的快递单号
      tracking_number = import_result[:unmatched_receipts][0][:tracking_number]
      
      # 手动匹配
      match_result = service.manual_match(tracking_number, new_reimbursement.id)
      
      expect(match_result[:success]).to be_truthy
      expect(match_result[:express_receipt_id]).not_to be_nil
      expect(match_result[:work_order_id]).not_to be_nil
      
      # 验证报销单状态已更新
      new_reimbursement.reload
      expect(new_reimbursement.receipt_status).to eq('received')
      expect(new_reimbursement.receipt_date).not_to be_nil
      
      # 验证快递收单工单已创建
      work_order = ExpressReceiptWorkOrder.find(match_result[:work_order_id])
      expect(work_order.reimbursement_id).to eq(new_reimbursement.id)
      expect(work_order.tracking_number).to eq(tracking_number)
      expect(work_order.status).to eq('received')
    end
    
    it '处理无效的手动匹配请求' do
      service = ExpressReceiptImportService.new(file, admin_user)
      
      # 尝试匹配不存在的记录
      result = service.manual_match('invalid_tracking_number', 999)
      
      expect(result[:success]).to be_falsey
      expect(result[:errors]).to include('无法找到未匹配的快递收单记录或报销单')
    end
  end
  
  describe '私有方法' do
    let(:service) { ExpressReceiptImportService.new(file, admin_user) }
    let(:sample_row) { {
      单号: 'R20250101001',
      操作人: '张三',
      操作时间: '2025-01-01 10:00:00',
      操作意见: '已收到快递，快递单号: SF123456'
    } }
    
    describe '#extract_document_number' do
      it '提取单据编号' do
        expect(service.send(:extract_document_number, sample_row)).to eq('R20250101001')
        expect(service.send(:extract_document_number, { 单据编号: 'R20250101002' })).to eq('R20250101002')
        expect(service.send(:extract_document_number, { document_number: 'R20250101003' })).to eq('R20250101003')
        expect(service.send(:extract_document_number, {})).to eq('')
      end
    end
    
    describe '#extract_tracking_number' do
      it '从操作意见中提取快递单号' do
        expect(service.send(:extract_tracking_number, sample_row)).to eq('SF123456')
      end
      
      it '从快递单号列提取' do
        expect(service.send(:extract_tracking_number, { 快递单号: 'YT123456' })).to eq('YT123456')
      end
      
      it '生成默认值当无法提取时' do
        result = service.send(:extract_tracking_number, { 操作意见: '已收到快递' })
        expect(result).to match(/未知-\d+/)
      end
    end
    
    describe '#extract_courier_company' do
      it '从操作意见中提取快递公司' do
        expect(service.send(:extract_courier_company, { 操作意见: '顺丰快递已收到' })).to eq('顺丰')
        expect(service.send(:extract_courier_company, { 操作意见: '圆通快递已收到' })).to eq('圆通')
        expect(service.send(:extract_courier_company, { 操作意见: '中通快递已收到' })).to eq('中通')
        expect(service.send(:extract_courier_company, { 操作意见: '申通快递已收到' })).to eq('申通')
        expect(service.send(:extract_courier_company, { 操作意见: '韵达快递已收到' })).to eq('韵达')
        expect(service.send(:extract_courier_company, { 操作意见: '邮政快递已收到' })).to eq('邮政')
        expect(service.send(:extract_courier_company, { 操作意见: 'EMS快递已收到' })).to eq('EMS')
        expect(service.send(:extract_courier_company, { 操作意见: '其他快递已收到' })).to eq('其他')
      end
      
      it '从快递公司列提取' do
        expect(service.send(:extract_courier_company, { 快递公司: '顺丰' })).to eq('顺丰')
      end
      
      it '返回默认值当无法提取时' do
        expect(service.send(:extract_courier_company, {})).to eq('未知')
      end
    end
    
    describe '#parse_date' do
      it '解析日期字符串' do
        expect(service.send(:parse_date, '2025-01-01 10:00:00')).to be_within(1.second).of(DateTime.parse('2025-01-01 10:00:00'))
      end
      
      it '返回当前时间当无法解析时' do
        expect(service.send(:parse_date, 'invalid date')).to be_within(1.second).of(Time.current)
        expect(service.send(:parse_date, nil)).to be_within(1.second).of(Time.current)
      end
    end
  end
end
```

### 3. 创建 ActiveAdmin 导入界面

在 `app/admin/express_receipts.rb` 文件中添加导入功能：

```ruby
ActiveAdmin.register ExpressReceipt do
  # ... 其他配置 ...

  # 自定义操作
  action_item :import, only: :index do
    link_to "导入快递收单", new_import_admin_express_receipts_path
  end

  action_item :manual_match, only: :index do
    link_to "手动匹配", new_manual_match_admin_express_receipts_path
  end

  # 自定义页面
  collection_action :new_import, method: :get do
    render "admin/express_receipts/new_import"
  end

  collection_action :import, method: :post do
    # 调用导入服务
    service = ExpressReceiptImportService.new(params[:file], current_admin_user)
    result = service.import
    
    if result[:success]
      if result[:unmatched] > 0
        # 存储未匹配记录到会话，以便在手动匹配页面使用
        session[:unmatched_receipts] = result[:unmatched_receipts]
        redirect_to admin_express_receipts_path, notice: "导入成功: #{result[:matched]} 匹配, #{result[:unmatched]} 未匹配, #{result[:errors]} 错误. 您可以手动匹配未匹配的记录."
      else
        redirect_to admin_express_receipts_path, notice: "导入成功: #{result[:matched]} 匹配, #{result[:unmatched]} 未匹配, #{result[:errors]} 错误."
      end
    else
      redirect_to new_import_admin_express_receipts_path, alert: "导入失败: #{result[:errors].join(', ')}"
    end
  end

  collection_action :new_manual_match, method: :get do
    @unmatched_receipts = session[:unmatched_receipts] || []
    @reimbursements = Reimbursement.all
    render "admin/express_receipts/new_manual_match"
  end

  collection_action :manual_match, method: :post do
    # 调用手动匹配服务
    service = ExpressReceiptImportService.new(nil, current_admin_user)
    result = service.manual_match(params[:tracking_number], params[:reimbursement_id])
    
    if result[:success]
      # 从会话中移除已匹配的记录
      if session[:unmatched_receipts].present?
        session[:unmatched_receipts].reject! { |r| r[:tracking_number] == params[:tracking_number] }
      end
      
      redirect_to admin_express_receipt_path(result[:express_receipt_id]), notice: "手动匹配成功，已创建快递收单工单."
    else
      redirect_to new_manual_match_admin_express_receipts_path, alert: "手动匹配失败: #{result[:errors].join(', ')}"
    end
  end

  # ... 其他配置 ...
end
```

创建 `app/views/admin/express_receipts/new_import.html.erb` 文件：

```erb
<h2>导入快递收单</h2>

<%= form_tag import_admin_express_receipts_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择文件</th>
            <td><%= file_field_tag :file, accept: '.csv,.xlsx,.xls', required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_express_receipts_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV或Excel文件应包含以下列：</p>
    <ul>
      <li>单号/单据编号（必填）</li>
      <li>操作人</li>
      <li>操作时间</li>
      <li>操作意见（包含快递单号信息）</li>
      <li>快递单号（可选，如果操作意见中包含则可不填）</li>
      <li>快递公司（可选，如果操作意见中包含则可不填）</li>
    </ul>
    <p>注意：系统会尝试从操作意见中提取快递单号和快递公司信息，格式如"快递单号: SF123456"</p>
  </div>
</div>
```

创建 `app/views/admin/express_receipts/new_manual_match.html.erb` 文件：

```erb
<h2>手动匹配快递收单</h2>

<% if @unmatched_receipts.present? %>
  <div class="panel">
    <h3>未匹配的快递收单</h3>
    <div class="panel_contents">
      <table class="index_table">
        <thead>
          <tr>
            <th>单据编号</th>
            <th>快递单号</th>
            <th>操作人</th>
            <th>操作时间</th>
            <th>操作意见</th>
            <th>错误原因</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <% @unmatched_receipts.each do |receipt| %>
            <tr>
              <td><%= receipt[:document_number] %></td>
              <td><%= receipt[:tracking_number] %></td>
              <td><%= receipt[:original_data][:操作人] || receipt[:original_data][:operator] %></td>
              <td><%= receipt[:original_data][:操作时间] || receipt[:original_data][:operation_time] %></td>
              <td><%= receipt[:original_data][:操作意见] || receipt[:original_data][:operation_comment] %></td>
              <td><%= receipt[:error] %></td>
              <td>
                <%= form_tag manual_match_admin_express_receipts_path, method: :post do %>
                  <%= hidden_field_tag :tracking_number, receipt[:tracking_number] %>
                  <%= select_tag :reimbursement_id, 
                                options_from_collection_for_select(@reimbursements, :id, :invoice_number), 
                                prompt: "选择报销单", required: true %>
                  <%= submit_tag "匹配", class: "button" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% else %>
  <div class="panel">
    <div class="panel_contents">
      <p>没有未匹配的快递收单记录。请先导入快递收单数据。</p>
    </div>
  </div>
<% end %>

<div class="actions">
  <%= link_to "返回", admin_express_receipts_path, class: "button" %>
</div>
```

## 测试验证方法

1. 运行 `rspec spec/services/express_receipt_import_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：

```ruby
# 假设已经有一个测试文件
file_path = Rails.root.join('spec', 'fixtures', 'files', 'test_express_receipts.xlsx')
file = File.open(file_path)
admin_user = AdminUser.first

# 创建测试报销单
reimbursement1 = Reimbursement.create!(
  invoice_number: 'R20250101001',
  document_name: '测试报销单1',
  applicant: '张三',
  applicant_id: 'EMP001',
  company: '测试公司',
  department: '测试部门',
  amount: 1000.00
)

reimbursement2 = Reimbursement.create!(
  invoice_number: 'R20250101002',
  document_name: '测试报销单2',
  applicant: '李四',
  applicant_id: 'EMP002',
  company: '测试公司',
  department: '财务部',
  amount: 2000.00
)

# 创建服务实例
service = ExpressReceiptImportService.new(file, admin_user)

# 执行导入
result = service.import
puts "导入结果: #{result.inspect}"

# 检查导入的快递收单记录
express_receipts = ExpressReceipt.last(2)
express_receipts.each do |er|
  puts "快递收单 #{er.id}: 单据编号 #{er.document_number}, 快递单号: #{er.tracking_number}, 快递公司: #{er.courier_company}"
end

# 检查创建的快递收单工单
work_orders = ExpressReceiptWorkOrder.last(2)
work_orders.each do |wo|
  puts "快递收单工单 #{wo.id}: 报销单 #{wo.reimbursement.invoice_number}, 快递单号: #{wo.tracking_number}, 状态: #{wo.status}"
end

# 检查报销单状态
reimbursement1.reload
reimbursement2.reload
puts "报销单1 状态: #{reimbursement1.receipt_status}, 收单日期: #{reimbursement1.receipt_date}"
puts "报销单2 状态: #{reimbursement2.receipt_status}, 收单日期: #{reimbursement2.receipt_date}"

# 测试手动匹配
if result[:unmatched] > 0
  # 创建新的报销单用于手动匹配
  reimbursement3 = Reimbursement.create!(
    invoice_number: 'R20250101003',
    document_name: '测试报销单3',
    applicant: '王五',
    applicant_id: 'EMP003',
    company: '测试公司',
    department: '市场部',
    amount: 3000.00
  )
  
  # 获取未匹配记录的快递单号
  tracking_number = result[:unmatched_receipts][0][:tracking_number]
  
  # 手动匹配
  match_result = service.manual_match(tracking_number, reimbursement3.id)
  puts "手动匹配结果: #{match_result.inspect}"
  
  # 检查报销单状态
  reimbursement3.reload
  puts "报销单3 状态: #{reimbursement3.receipt_status}, 收单日期: #{reimbursement3.receipt_date}"
  
  # 检查创建的快递收单工单
  work_order = ExpressReceiptWorkOrder.find(match_result[:work_order_id])
  puts "手动匹配创建的工单 #{work_order.id}: 报销单 #{work_order.reimbursement.invoice_number}, 快递单号: #{work_order.tracking_number}, 状态: #{work_order.status}"
end
```

3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试快递收单导入和手动匹配功能

## 注意事项

1. 确保 Roo gem 正确安装和配置
2. 确保导入逻辑正确处理各种边缘情况，如缺少必要字段、格式错误等
3. 确保从操作意见中提取快递单号和快递公司的逻辑正确实现
4. 确保未匹配记录的处理和手动匹配功能正确实现
5. 确保报销单状态更新和快递收单工单创建逻辑正确实现
6. 确保错误处理和日志记录功能正确实现
7. 确保测试覆盖所有关键功能，特别是文件解析、数据导入和手动匹配
8. 考虑大文件导入的性能问题，可能需要使用批量导入或后台任务