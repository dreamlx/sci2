# 费用明细验证服务实现

## 任务描述

实现费用明细验证服务（FeeDetailVerificationService），用于处理费用明细的验证状态更新、批量验证等功能。该服务是工单系统的核心业务逻辑之一，负责处理报销单费用明细的验证流程。

## 输入和依赖

- 已完成的费用明细模型
- 已完成的费用明细选择模型
- 已完成的审核工单模型
- 已完成的沟通工单模型
- 服务实现设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的费用明细验证服务实现，包括：
- 费用明细验证状态更新功能
- 批量验证功能
- 工单关联验证功能
- 错误处理和验证功能

## 详细实现步骤

### 1. 创建费用明细验证服务

创建 `app/services/fee_detail_verification_service.rb` 文件：

```ruby
# app/services/fee_detail_verification_service.rb
class FeeDetailVerificationService
  def initialize(current_admin_user)
    @current_admin_user = current_admin_user
  end
  
  def verify_fee_details(fee_detail_ids, verification_status, comment = nil)
    results = {
      success: 0,
      failure: 0,
      errors: []
    }
    
    FeeDetail.where(id: fee_detail_ids).each do |fee_detail|
      if update_verification_status(fee_detail, verification_status, comment)
        results[:success] += 1
      else
        results[:failure] += 1
        results[:errors] << "费用明细 ##{fee_detail.id} 更新失败"
      end
    end
def verify_fee_detail_in_work_order(work_order, fee_detail_id, verification_status, comment = nil)
    fee_detail = FeeDetail.find(fee_detail_id)
    
    case work_order
    when AuditWorkOrder
      work_order.verify_fee_detail(fee_detail, verification_status, comment)
    when CommunicationWorkOrder
      if verification_status == 'problematic'
        work_order.select_fee_detail(fee_detail)
        true
      else
        work_order.resolve_fee_detail_issue(fee_detail, comment)
      end
    else
      false
    end
  end
  
  def update_fee_detail_after_communication(fee_detail_id, verification_status, comment = nil)
    fee_detail = FeeDetail.find(fee_detail_id)
    
    case verification_status
    when 'verified'
      fee_detail.mark_as_verified
    when 'rejected'
      fee_detail.mark_as_rejected
    else
      return false
    end
    
    # 更新所有关联的费用明细选择记录
    fee_detail.fee_detail_selections.each do |selection|
      selection.update(
        verification_status: verification_status,
        verification_comment: comment,
        verified_by: @current_admin_user.id,
        verified_at: Time.current
      )
    end
    
    true
  end
  
  private
  
  def update_verification_status(fee_detail, verification_status, comment = nil)
    case verification_status
    when 'verified'
      fee_detail.mark_as_verified
    when 'problematic'
      fee_detail.mark_as_problematic
    when 'rejected'
      fee_detail.mark_as_rejected
    else
      return false
    end
    
    # 更新所有关联的费用明细选择记录
    fee_detail.fee_detail_selections.each do |selection|
      selection.update(
        verification_status: verification_status,
        verification_comment: comment,
        verified_by: @current_admin_user.id,
        verified_at: Time.current
      )
    end
    
    true
  end
end
```

### 2. 创建费用明细控制器

创建 `app/controllers/admin/fee_details_controller.rb` 文件：

```ruby
# app/controllers/admin/fee_details_controller.rb
module Admin
  class FeeDetailsController < ApplicationController
    before_action :set_fee_detail, except: [:index, :new, :create, :batch_verify]
    
    def index
      @fee_details = FeeDetail.all
    end
    
    def show
      @fee_detail = FeeDetail.find(params[:id])
    end
    
    def new
      @fee_detail = FeeDetail.new
    end
    
    def create
      @fee_detail = FeeDetail.new(fee_detail_params)
      
      if @fee_detail.save
        redirect_to admin_fee_detail_path(@fee_detail), notice: "费用明细已创建"
      else
        render :new
      end
    end
    
    def edit
    end
    
    def update
      if @fee_detail.update(fee_detail_params)
        redirect_to admin_fee_detail_path(@fee_detail), notice: "费用明细已更新"
      else
        render :edit
      end
    end
    
    def destroy
      @fee_detail.destroy
      redirect_to admin_fee_details_path, notice: "费用明细已删除"
    end
def verify
      @work_order = find_work_order
      render "admin/fee_details/verify"
    end
    
    def do_verify
      @work_order = find_work_order
      service = FeeDetailVerificationService.new(current_admin_user)
      
      if service.verify_fee_detail_in_work_order(@work_order, @fee_detail.id, params[:verification_status], params[:comment])
        redirect_to polymorphic_path([:admin, @work_order]), notice: "费用明细已验证"
      else
        redirect_to polymorphic_path([:admin, @work_order]), alert: "验证费用明细失败"
      end
    end
    
    def mark_problematic
      @work_order = find_work_order
      render "admin/fee_details/mark_problematic"
    end
    
    def do_mark_problematic
      @work_order = find_work_order
      
      if @work_order.is_a?(AuditWorkOrder)
        service = AuditWorkOrderService.new(@work_order, current_admin_user)
        
        if service.mark_fee_detail_problematic(@fee_detail.id, params[:issue_description])
          redirect_to admin_audit_work_order_path(@work_order), notice: "费用明细已标记为有问题，并创建了沟通工单"
        else
          redirect_to admin_audit_work_order_path(@work_order), alert: "标记费用明细有问题失败"
        end
      else
        redirect_to admin_fee_details_path, alert: "无效的工单类型"
      end
    end
    
    def resolve_issue
      @work_order = find_work_order
      render "admin/fee_details/resolve_issue"
    end
    
    def do_resolve_issue
      @work_order = find_work_order
      
      if @work_order.is_a?(CommunicationWorkOrder)
        service = CommunicationWorkOrderService.new(@work_order, current_admin_user)
        
        if service.resolve_fee_detail_issue(@fee_detail.id, params[:resolution])
          redirect_to admin_communication_work_order_path(@work_order), notice: "费用明细问题已解决"
        else
          redirect_to admin_communication_work_order_path(@work_order), alert: "解决费用明细问题失败"
        end
      else
        redirect_to admin_fee_details_path, alert: "无效的工单类型"
      end
    end
    
    def update_after_communication
      render "admin/fee_details/update_after_communication"
    end
    
    def do_update_after_communication
      service = FeeDetailVerificationService.new(current_admin_user)
      
      if service.update_fee_detail_after_communication(@fee_detail.id, params[:verification_status], params[:comment])
        redirect_to admin_fee_detail_path(@fee_detail), notice: "费用明细状态已更新"
      else
        redirect_to admin_fee_detail_path(@fee_detail), alert: "更新费用明细状态失败"
      end
    end
    
    def batch_verify
      render "admin/fee_details/batch_verify"
    end
    
    def do_batch_verify
      service = FeeDetailVerificationService.new(current_admin_user)
      result = service.verify_fee_details(params[:fee_detail_ids], params[:verification_status], params[:comment])
      
      if result[:success] > 0
        redirect_to admin_fee_details_path, notice: "成功验证 #{result[:success]} 个费用明细，失败 #{result[:failure]} 个"
      else
        redirect_to admin_fee_details_path, alert: "验证费用明细失败: #{result[:errors].join(', ')}"
      end
    end
    
    private
    
    def set_fee_detail
      @fee_detail = FeeDetail.find(params[:id])
    end
    
    def fee_detail_params
      params.require(:fee_detail).permit(
        :document_number, 
        :fee_type, 
        :amount, 
        :currency, 
        :fee_date, 
        :payment_method, 
        :verification_status
      )
    end
    
    def find_work_order
      if params[:work_order_id].present?
        if params[:work_order_type] == 'audit'
          AuditWorkOrder.find(params[:work_order_id])
        elsif params[:work_order_type] == 'communication'
          CommunicationWorkOrder.find(params[:work_order_id])
        else
          nil
        end
      else
        nil
      end
    end
  end
end
```

### 3. 创建费用明细视图

创建 `app/views/admin/fee_details/verify.html.erb` 文件：

```erb
<!-- app/views/admin/fee_details/verify.html.erb -->
<h2>验证费用明细</h2>

<%= form_tag do_verify_admin_fee_detail_path(@fee_detail), method: :post do %>
  <%= hidden_field_tag :work_order_id, @work_order.id %>
  <%= hidden_field_tag :work_order_type, @work_order.is_a?(AuditWorkOrder) ? 'audit' : 'communication' %>
  
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @fee_detail.document_number %></td>
          </tr>
          <tr>
            <th>费用类型</th>
            <td><%= @fee_detail.fee_type %></td>
          </tr>
          <tr>
            <th>金额</th>
            <td><%= number_to_currency(@fee_detail.amount, unit: '¥') %></td>
          </tr>
          <tr>
            <th>当前状态</th>
            <td><%= status_tag @fee_detail.verification_status %></td>
          </tr>
          <tr>
            <th>验证状态</th>
            <td>
              <%= select_tag :verification_status, options_for_select([
                ["已验证", "verified"],
                ["已拒绝", "rejected"],
                ["有问题", "problematic"]
              ], @fee_detail.verification_status), required: true %>
            </td>
          </tr>
          <tr>
            <th>验证意见</th>
            <td><%= text_area_tag :comment, nil, rows: 3, cols: 40 %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "提交", class: "button" %>
    <%= link_to "取消", polymorphic_path([:admin, @work_order]), class: "button" %>
  </div>
<% end %>
```
    
创建 `app/views/admin/fee_details/mark_problematic.html.erb` 文件：

```erb
<!-- app/views/admin/fee_details/mark_problematic.html.erb -->
<h2>标记费用明细有问题</h2>

<%= form_tag do_mark_problematic_admin_fee_detail_path(@fee_detail), method: :post do %>
  <%= hidden_field_tag :work_order_id, @work_order.id %>
  <%= hidden_field_tag :work_order_type, 'audit' %>
  
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @fee_detail.document_number %></td>
          </tr>
          <tr>
            <th>费用类型</th>
            <td><%= @fee_detail.fee_type %></td>
          </tr>
          <tr>
            <th>金额</th>
            <td><%= number_to_currency(@fee_detail.amount, unit: '¥') %></td>
          </tr>
          <tr>
            <th>当前状态</th>
            <td><%= status_tag @fee_detail.verification_status %></td>
          </tr>
          <tr>
            <th>问题描述</th>
            <td><%= text_area_tag :issue_description, nil, rows: 5, cols: 50, required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "创建沟通工单", class: "button" %>
    <%= link_to "取消", admin_audit_work_order_path(@work_order), class: "button" %>
  </div>
<% end %>
```

创建 `app/views/admin/fee_details/resolve_issue.html.erb` 文件：

```erb
<!-- app/views/admin/fee_details/resolve_issue.html.erb -->
<h2>解决费用明细问题</h2>

<%= form_tag do_resolve_issue_admin_fee_detail_path(@fee_detail), method: :post do %>
  <%= hidden_field_tag :work_order_id, @work_order.id %>
  <%= hidden_field_tag :work_order_type, 'communication' %>
  
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @fee_detail.document_number %></td>
          </tr>
          <tr>
            <th>费用类型</th>
            <td><%= @fee_detail.fee_type %></td>
          </tr>
          <tr>
            <th>金额</th>
            <td><%= number_to_currency(@fee_detail.amount, unit: '¥') %></td>
          </tr>
          <tr>
            <th>当前状态</th>
            <td><%= status_tag @fee_detail.verification_status %></td>
          </tr>
          <tr>
            <th>解决方案</th>
            <td><%= text_area_tag :resolution, nil, rows: 5, cols: 50, required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "提交", class: "button" %>
    <%= link_to "取消", admin_communication_work_order_path(@work_order), class: "button" %>
  </div>
<% end %>
```

创建 `app/views/admin/fee_details/update_after_communication.html.erb` 文件：

```erb
<!-- app/views/admin/fee_details/update_after_communication.html.erb -->
<h2>沟通后更新费用明细状态</h2>

<%= form_tag do_update_after_communication_admin_fee_detail_path(@fee_detail), method: :post do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @fee_detail.document_number %></td>
          </tr>
          <tr>
            <th>费用类型</th>
            <td><%= @fee_detail.fee_type %></td>
          </tr>
          <tr>
            <th>金额</th>
            <td><%= number_to_currency(@fee_detail.amount, unit: '¥') %></td>
          </tr>
          <tr>
            <th>当前状态</th>
            <td><%= status_tag @fee_detail.verification_status %></td>
          </tr>
          <tr>
            <th>更新状态</th>
            <td>
              <%= select_tag :verification_status, options_for_select([
                ["已验证", "verified"],
                ["已拒绝", "rejected"]
              ]), required: true %>
            </td>
          </tr>
          <tr>
            <th>更新意见</th>
            <td><%= text_area_tag :comment, nil, rows: 3, cols: 40 %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "提交", class: "button" %>
    <%= link_to "取消", admin_fee_detail_path(@fee_detail), class: "button" %>
  </div>
<% end %>
```
    results
  end
创建 `app/views/admin/fee_details/batch_verify.html.erb` 文件：

```erb
<!-- app/views/admin/fee_details/batch_verify.html.erb -->
<h2>批量验证费用明细</h2>

<%= form_tag do_batch_verify_admin_fee_details_path, method: :post do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择费用明细</th>
            <td>
              <div class="fee_detail_selection">
                <% FeeDetail.where(verification_status: 'pending').each do |fee_detail| %>
                  <div>
                    <%= check_box_tag "fee_detail_ids[]", fee_detail.id, false, id: "fee_detail_#{fee_detail.id}" %>
                    <%= label_tag "fee_detail_#{fee_detail.id}", "#{fee_detail.document_number} - #{fee_detail.fee_type} - #{number_to_currency(fee_detail.amount, unit: '¥')}" %>
                  </div>
                <% end %>
              </div>
            </td>
          </tr>
          <tr>
            <th>验证状态</th>
            <td>
              <%= select_tag :verification_status, options_for_select([
                ["已验证", "verified"],
                ["已拒绝", "rejected"],
                ["有问题", "problematic"]
              ]), required: true %>
            </td>
          </tr>
          <tr>
            <th>验证意见</th>
            <td><%= text_area_tag :comment, nil, rows: 3, cols: 40 %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "提交", class: "button" %>
    <%= link_to "取消", admin_fee_details_path, class: "button" %>
  </div>
<% end %>
```

### 4. 更新路由配置

修改 `config/routes.rb` 文件，添加费用明细验证路由：

```ruby
# config/routes.rb
Rails.application.routes.draw do
  # ...
  
  namespace :admin do
    resources :fee_details do
      collection do
        get :batch_verify
        post :do_batch_verify
      end
      
      member do
        get :verify
        post :do_verify
        get :mark_problematic
        post :do_mark_problematic
        get :resolve_issue
        post :do_resolve_issue
        get :update_after_communication
        post :do_update_after_communication
      end
    end
    # ...
  end
  
  # ...
end
```

### 5. 创建费用明细验证服务测试

创建 `spec/services/fee_detail_verification_service_spec.rb` 文件：

```ruby
# spec/services/fee_detail_verification_service_spec.rb
require 'rails_helper'

RSpec.describe FeeDetailVerificationService do
  let(:admin_user) { create(:admin_user) }
  let(:service) { FeeDetailVerificationService.new(admin_user) }
  
  describe '#verify_fee_details' do
    before do
      @fee_detail1 = create(:fee_detail, verification_status: 'pending')
      @fee_detail2 = create(:fee_detail, verification_status: 'pending')
      @fee_detail3 = create(:fee_detail, verification_status: 'pending')
    end
    
    it 'updates verification status for multiple fee details' do
      result = service.verify_fee_details([@fee_detail1.id, @fee_detail2.id], 'verified', '批量验证')
describe '#verify_fee_detail_in_work_order' do
    let(:reimbursement) { create(:reimbursement) }
    let(:audit_work_order) { create(:audit_work_order, reimbursement: reimbursement) }
    let(:communication_work_order) { create(:communication_work_order, reimbursement: reimbursement, audit_work_order: audit_work_order) }
    let(:fee_detail) { create(:fee_detail, document_number: reimbursement.invoice_number, verification_status: 'pending') }
    
    context 'with audit work order' do
      before do
        audit_work_order.select_fee_detail(fee_detail)
      end
      
      it 'updates fee detail verification status' do
        expect {
          service.verify_fee_detail_in_work_order(audit_work_order, fee_detail.id, 'verified', '验证通过')
        }.to change { fee_detail.reload.verification_status }.from('pending').to('verified')
      end
    end
    
    context 'with communication work order' do
      it 'selects fee detail when status is problematic' do
        expect {
          service.verify_fee_detail_in_work_order(communication_work_order, fee_detail.id, 'problematic', '有问题')
        }.to change(FeeDetailSelection, :count).by(1)
        
        selection = FeeDetailSelection.last
        expect(selection.fee_detail).to eq(fee_detail)
        expect(selection.communication_work_order).to eq(communication_work_order)
        expect(selection.verification_status).to eq('problematic')
      end
      
      it 'resolves fee detail issue' do
        # 先创建费用明细选择
        selection = create(:fee_detail_selection, 
          fee_detail: fee_detail, 
          communication_work_order: communication_work_order, 
          verification_status: 'problematic'
        )
        
        service.verify_fee_detail_in_work_order(communication_work_order, fee_detail.id, 'verified', '问题已解决')
        
        expect(selection.reload.verification_comment).to eq('问题已解决')
      end
    end
  end
  
  describe '#update_fee_detail_after_communication' do
    let(:fee_detail) { create(:fee_detail, verification_status: 'problematic') }
    
    it 'updates fee detail to verified' do
      expect {
        service.update_fee_detail_after_communication(fee_detail.id, 'verified', '沟通后验证通过')
      }.to change { fee_detail.reload.verification_status }.from('problematic').to('verified')
    end
    
    it 'updates fee detail to rejected' do
      expect {
        service.update_fee_detail_after_communication(fee_detail.id, 'rejected', '沟通后拒绝')
      }.to change { fee_detail.reload.verification_status }.from('problematic').to('rejected')
    end
    
    it 'returns false for invalid status' do
      expect(service.update_fee_detail_after_communication(fee_detail.id, 'problematic', '沟通后仍有问题')).to be false
      expect(fee_detail.reload.verification_status).to eq('problematic')
    end
    
    it 'updates fee detail selections' do
      selection = create(:fee_detail_selection, fee_detail: fee_detail, verification_status: 'problematic')
      
      service.update_fee_detail_after_communication(fee_detail.id, 'verified', '沟通后验证通过')
      
      expect(selection.reload.verification_status).to eq('verified')
      expect(selection.verification_comment).to eq('沟通后验证通过')
      expect(selection.verified_by).to eq(admin_user.id)
      expect(selection.verified_at).to be_present
    end
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/services/fee_detail_verification_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：
   ```ruby
   # 创建测试报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false,
     is_complete: false,
     reimbursement_status: 'processing'
   )
   
   # 创建测试审核工单
   audit_work_order = AuditWorkOrder.create!(
     reimbursement: reimbursement,
     status: 'auditing',
     created_by: 1
   )
   
   # 创建测试沟通工单
   communication_work_order = CommunicationWorkOrder.create!(
     reimbursement: reimbursement,
     audit_work_order: audit_work_order,
     status: 'in_progress',
     created_by: 1
   )
   
   # 创建测试费用明细
   fee_detail1 = FeeDetail.create!(
     document_number: reimbursement.invoice_number,
     fee_type: "交通费",
     amount: 100.00,
     currency: "CNY",
     verification_status: "pending"
   )
   
   fee_detail2 = FeeDetail.create!(
     document_number: reimbursement.invoice_number,
     fee_type: "餐饮费",
     amount: 200.00,
     currency: "CNY",
     verification_status: "pending"
   )
   
   # 创建管理员用户
   admin_user = AdminUser.first || AdminUser.create!(email: 'admin@example.com', password: 'password')
   
   # 创建服务实例
   service = FeeDetailVerificationService.new(admin_user)
   
   # 测试批量验证
   result = service.verify_fee_details([fee_detail1.id, fee_detail2.id], 'verified', '批量验证')
   puts "批量验证结果: #{result.inspect}"
   puts "费用明细1状态: #{fee_detail1.reload.verification_status}"
   puts "费用明细2状态: #{fee_detail2.reload.verification_status}"
   
   # 测试工单关联验证
   # 先重置费用明细状态
   fee_detail1.update(verification_status: 'pending')
   fee_detail2.update(verification_status: 'pending')
   
   # 关联到审核工单
   audit_work_order.select_fee_detail(fee_detail1)
   
   # 在审核工单中验证
   service.verify_fee_detail_in_work_order(audit_work_order, fee_detail1.id, 'verified', '审核工单验证')
   puts "费用明细1状态: #{fee_detail1.reload.verification_status}"
   
   # 关联到沟通工单
   communication_work_order.select_fee_detail(fee_detail2)
   
   # 在沟通工单中解决问题
   service.verify_fee_detail_in_work_order(communication_work_order, fee_detail2.id, 'verified', '沟通工单解决')
   puts "费用明细2状态: #{fee_detail2.reload.verification_status}"
   
   # 测试沟通后更新
   fee_detail2.update(verification_status: 'problematic')
   service.update_fee_detail_after_communication(fee_detail2.id, 'verified', '沟通后验证通过')
   puts "费用明细2状态: #{fee_detail2.reload.verification_status}"
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试费用明细验证功能

## 注意事项

1. 确保费用明细验证状态更新功能正确实现，特别是状态转换的条件和回调
2. 确保批量验证功能正确实现，特别是处理多个费用明细的验证状态更新
3. 确保工单关联验证功能正确实现，特别是在不同类型工单中的验证逻辑
4. 确保沟通后更新功能正确实现，特别是只允许更新为已验证或已拒绝状态
5. 确保错误处理和验证功能正确实现，特别是非法状态转换的处理
6. 确保服务与控制器的交互正确实现，特别是参数的传递和结果的处理
7. 确保视图正确实现，特别是表单的提交和数据的显示
8. 注意沟通工单解决后不会自动更新费用明细状态，需要审核人员手动更新
      
      expect(result[:success]).to eq(2)
      expect(result[:failure]).to eq(0)
      expect(@fee_detail1.reload.verification_status).to eq('verified')
      expect(@fee_detail2.reload.verification_status).to eq('verified')
      expect(@fee_detail3.reload.verification_status).to eq('pending')
    end
    
    it 'handles invalid verification status' do
      result = service.verify_fee_details([@fee_detail1.id], 'invalid_status', '批量验证')
      
      expect(result[:success]).to eq(0)
      expect(result[:failure]).to eq(1)
      expect(result[:errors]).to include("费用明细 ##{@fee_detail1.id} 更新失败")
      expect(@fee_detail1.reload.verification_status).to eq('pending')
    end
  end