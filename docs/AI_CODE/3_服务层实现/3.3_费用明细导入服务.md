# 费用明细导入服务实现

## 任务描述

实现费用明细导入服务（FeeDetailImportService），用于从CSV文件导入费用明细数据。该服务需要处理CSV文件解析、数据验证、费用明细创建，以及自动关联到报销单。服务还需要处理未匹配报销单的情况，并提供适当的错误处理。

## 输入和依赖

- 已完成的报销单模型
- 已完成的费用明细模型
- 已完成的审核工单模型
- CSV文件格式参考文档 (`docs/3.数据导入格式参考.md`)
- 服务实现设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的费用明细导入服务实现，包括：
- CSV文件解析功能
- 数据验证功能
- 费用明细创建功能
- 报销单匹配功能
- 自动关联到审核工单的功能
- 导入结果统计和错误处理

## 详细实现步骤

### 1. 创建费用明细导入服务

创建 `app/services/fee_detail_import_service.rb` 文件：

```ruby
# app/services/fee_detail_import_service.rb
require 'csv'

class FeeDetailImportService
  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @imported_count = 0
    @unmatched_count = 0
    @error_count = 0
    @errors = []
    @unmatched_details = []
  end
  
  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?
    
    begin
      CSV.foreach(@file.path, headers: true) do |row|
        import_fee_detail(row)
      end
      
      {
        success: true,
        imported: @imported_count,
        unmatched: @unmatched_count,
        errors: @error_count,
        error_details: @errors,
        unmatched_details: @unmatched_details
      }
    rescue => e
      { success: false, errors: [e.message] }
    end
  end
  
  private
  
  def import_fee_detail(row)
    document_number = row['报销单单号']
    
    # 检查必要字段
    unless document_number.present?
      @error_count += 1
      @errors << "行 #{$.}: 报销单单号不能为空"
      return
    end
    
    unless row['费用类型'].present?
      @error_count += 1
      @errors << "行 #{$.}: 费用类型不能为空"
      return
    end
    
    unless row['原始金额'].present?
      @error_count += 1
      @errors << "行 #{$.}: 原始金额不能为空"
      return
    end
    
    # 查找对应的报销单
    reimbursement = Reimbursement.find_by(invoice_number: document_number)
    
    if reimbursement
      # 创建费用明细记录
      fee_detail = FeeDetail.new(
        document_number: document_number,
        fee_type: row['费用类型'],
        amount: row['原始金额'],
        currency: row['币种'] || 'CNY',
        fee_date: parse_date(row['费用发生日期']),
        payment_method: row['弹性字段11'],
        verification_status: 'pending'
      )
      
      if fee_detail.save
        @imported_count += 1
        
        # 如果存在审核工单，自动关联费用明细
        associate_with_audit_work_orders(fee_detail, reimbursement)
      else
        @error_count += 1
        @errors << "行 #{$.}: #{fee_detail.errors.full_messages.join(', ')}"
      end
    else
      # 记录未匹配的费用明细
      @unmatched_count += 1
      @unmatched_details << {
        original_data: row.to_h,
        document_number: document_number
      }
    end
  end
  
  def associate_with_audit_work_orders(fee_detail, reimbursement)
    # 查找该报销单的所有审核工单
    audit_work_orders = AuditWorkOrder.where(reimbursement_id: reimbursement.id)
    
    # 关联到所有处于pending或processing状态的审核工单
    audit_work_orders.where(status: ['pending', 'processing']).each do |audit_work_order|
      audit_work_order.select_fee_detail(fee_detail)
    end
  end
  
  def parse_date(date_string)
    return nil unless date_string.present?
    begin
      DateTime.parse(date_string)
    rescue
      nil
    end
  end
end
```

### 2. 创建费用明细导入控制器

创建 `app/controllers/admin/fee_detail_imports_controller.rb` 文件：

```ruby
# app/controllers/admin/fee_detail_imports_controller.rb
module Admin
  class FeeDetailImportsController < ApplicationController
    def new
      render 'admin/fee_detail_imports/new'
    end
    
    def create
      service = FeeDetailImportService.new(params[:file], current_admin_user)
      result = service.import
      
      if result[:success]
        if result[:unmatched] > 0
          flash[:alert] = "有 #{result[:unmatched]} 条记录未匹配到报销单"
        end
        redirect_to admin_fee_details_path, notice: "成功导入 #{result[:imported]} 条记录"
      else
        flash[:alert] = "导入失败: #{result[:errors].join(', ')}"
        render 'admin/fee_detail_imports/new'
      end
    end
  end
end
```

### 3. 创建费用明细导入视图

创建 `app/views/admin/fee_detail_imports/new.html.erb` 文件：

```erb
<!-- app/views/admin/fee_detail_imports/new.html.erb -->
<h2>导入费用明细</h2>

<%= form_tag admin_fee_detail_imports_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择CSV文件</th>
            <td><%= file_field_tag :file, accept: '.csv' %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_fee_details_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV文件应包含以下列：</p>
    <ul>
      <li>报销单单号（必填）</li>
      <li>费用类型（必填）</li>
      <li>原始金额（必填）</li>
      <li>币种</li>
      <li>费用发生日期</li>
      <li>弹性字段11（支付方式）</li>
    </ul>
    <p>注意：导入前必须先导入对应的报销单</p>
  </div>
</div>
```

### 4. 更新路由配置

修改 `config/routes.rb` 文件，添加费用明细导入路由：

```ruby
# config/routes.rb
Rails.application.routes.draw do
  # ...
  
  namespace :admin do
    resources :fee_details do
      collection do
        resources :fee_detail_imports, only: [:new, :create]
      end
    end
    # ...
  end
  
  # ...
end
```

### 5. 更新 ActiveAdmin 配置

修改 `app/admin/fee_details.rb` 文件，添加导入按钮：

```ruby
# app/admin/fee_details.rb
ActiveAdmin.register FeeDetail do
  # ...
  
  action_item :import, only: :index do
    link_to "导入费用明细", new_admin_fee_detail_import_path
  end
  
  # ...
end
```

### 6. 创建费用明细导入服务测试

创建 `spec/services/fee_detail_import_service_spec.rb` 文件：

```ruby
# spec/services/fee_detail_import_service_spec.rb
require 'rails_helper'

RSpec.describe FeeDetailImportService do
  let(:admin_user) { create(:admin_user) }
  let(:csv_file) { fixture_file_upload('files/test_fee_details.csv', 'text/csv') }
  
  describe '#import' do
    context 'with valid file' do
      before do
        # 创建测试报销单
        @reimbursement = create(:reimbursement, invoice_number: 'R20250101001')
        
        # 创建测试审核工单
        @audit_work_order = create(:audit_work_order, 
          reimbursement: @reimbursement,
          status: 'processing'
        )
        
        # 创建测试CSV文件
        CSV.open(Rails.root.join('spec/fixtures/files/test_fee_details.csv'), 'w') do |csv|
          csv << ['报销单单号', '费用类型', '原始金额', '币种', '费用发生日期', '弹性字段11']
          csv << ['R20250101001', '交通费', '100.00', 'CNY', '2025-01-01', '现金']
          csv << ['R20250101001', '餐饮费', '200.00', 'CNY', '2025-01-01', '信用卡']
          csv << ['R20250101002', '住宿费', '300.00', 'CNY', '2025-01-02', '公司转账']
        end
      end
      
      after do
        # 删除测试CSV文件
        File.delete(Rails.root.join('spec/fixtures/files/test_fee_details.csv')) if File.exist?(Rails.root.join('spec/fixtures/files/test_fee_details.csv'))
      end
      
      it 'creates fee details for matched reimbursements' do
        service = FeeDetailImportService.new(csv_file, admin_user)
        
        expect {
          result = service.import
          expect(result[:success]).to be true
          expect(result[:imported]).to eq(2)
          expect(result[:unmatched]).to eq(1)
          expect(result[:errors]).to eq(0)
        }.to change(FeeDetail, :count).by(3)
          .and change(FeeDetailSelection, :count).by(2)
        
        # 验证费用明细记录
        fee_detail = FeeDetail.find_by(document_number: 'R20250101001', fee_type: '交通费')
        expect(fee_detail.amount).to eq(100.00)
        expect(fee_detail.verification_status).to eq('pending')
        
        # 验证费用明细关联
        expect(@audit_work_order.fee_details.count).to eq(2)
        expect(@audit_work_order.fee_details).to include(fee_detail)
      end
      
      it 'records unmatched fee details' do
        service = FeeDetailImportService.new(csv_file, admin_user)
        result = service.import
        
        expect(result[:unmatched]).to eq(1)
        expect(result[:unmatched_details].size).to eq(1)
        expect(result[:unmatched_details][0]['document_number']).to eq('R20250101002')
      end
      
      it 'does not associate fee details with completed audit work orders' do
        @audit_work_order.update(status: 'completed')
        
        service = FeeDetailImportService.new(csv_file, admin_user)
        
        expect {
          service.import
        }.to change(FeeDetail, :count).by(3)
          .and change(FeeDetailSelection, :count).by(0)
        
        # 验证费用明细未关联
        expect(@audit_work_order.fee_details.count).to eq(0)
      end
    end
    
    context 'with invalid file' do
      it 'returns error when file is nil' do
        service = FeeDetailImportService.new(nil, admin_user)
        result = service.import
        
        expect(result[:success]).to be false
        expect(result[:errors]).to include("文件不存在")
      end
      
      it 'handles CSV parsing errors' do
        invalid_file = fixture_file_upload('files/invalid.csv', 'text/csv')
        
        # 创建无效的CSV文件
        File.open(Rails.root.join('spec/fixtures/files/invalid.csv'), 'w') do |file|
          file.write("This is not a valid CSV file")
        end
        
        service = FeeDetailImportService.new(invalid_file, admin_user)
        result = service.import
        
        expect(result[:success]).to be false
        expect(result[:errors]).to be_present
        
        # 删除测试文件
        File.delete(Rails.root.join('spec/fixtures/files/invalid.csv')) if File.exist?(Rails.root.join('spec/fixtures/files/invalid.csv'))
      end
      
      it 'validates required fields' do
        # 创建缺少必填字段的CSV文件
        CSV.open(Rails.root.join('spec/fixtures/files/invalid_fee_details.csv'), 'w') do |csv|
          csv << ['报销单单号', '费用类型', '原始金额', '币种', '费用发生日期', '弹性字段11']
          csv << ['R20250101001', '', '100.00', 'CNY', '2025-01-01', '现金'] # 缺少费用类型
          csv << ['R20250101001', '餐饮费', '', 'CNY', '2025-01-01', '信用卡'] # 缺少原始金额
          csv << ['', '住宿费', '300.00', 'CNY', '2025-01-02', '公司转账'] # 缺少报销单单号
        end
        
        invalid_file = fixture_file_upload('files/invalid_fee_details.csv', 'text/csv')
        
        service = FeeDetailImportService.new(invalid_file, admin_user)
        result = service.import
        
        expect(result[:success]).to be true
        expect(result[:errors]).to eq(3)
        expect(result[:error_details].size).to eq(3)
        
        # 删除测试文件
        File.delete(Rails.root.join('spec/fixtures/files/invalid_fee_details.csv')) if File.exist?(Rails.root.join('spec/fixtures/files/invalid_fee_details.csv'))
      end
    end
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/services/fee_detail_import_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：
   ```ruby
   # 创建测试报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false
   )
   
   # 创建测试审核工单
   audit_work_order = AuditWorkOrder.create!(
     reimbursement: reimbursement,
     status: 'processing',
     created_by: 1
   )
   
   # 创建测试CSV文件
   require 'csv'
   CSV.open('tmp/test_fee_details.csv', 'w') do |csv|
     csv << ['报销单单号', '费用类型', '原始金额', '币种', '费用发生日期', '弹性字段11']
     csv << ['R20250101001', '交通费', '100.00', 'CNY', '2025-01-01', '现金']
     csv << ['R20250101001', '餐饮费', '200.00', 'CNY', '2025-01-01', '信用卡']
     csv << ['R20250101002', '住宿费', '300.00', 'CNY', '2025-01-02', '公司转账']
   end
   
   # 创建测试文件对象
   file = File.open('tmp/test_fee_details.csv')
   def file.original_filename; 'test_fee_details.csv'; end
   def file.content_type; 'text/csv'; end
   
   # 创建管理员用户
   admin_user = AdminUser.first || AdminUser.create!(email: 'admin@example.com', password: 'password')
   
   # 测试导入服务
   service = FeeDetailImportService.new(file, admin_user)
   result = service.import
   
   # 检查结果
   puts "导入结果: #{result.inspect}"
   puts "创建的费用明细数量: #{FeeDetail.count}"
   puts "创建的费用明细选择数量: #{FeeDetailSelection.count}"
   puts "未匹配的费用明细数量: #{result[:unmatched]}"
   
   # 检查费用明细关联
   puts "审核工单关联的费用明细数量: #{audit_work_order.fee_details.count}"
   puts "审核工单关联的费用明细类型: #{audit_work_order.fee_details.pluck(:fee_type).join(', ')}"
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试费用明细导入功能

## 注意事项

1. 确保CSV文件解析功能正确实现，特别是处理中文字符和日期格式
2. 确保数据验证功能正确实现，特别是必填字段的验证
3. 确保费用明细创建功能正确实现，特别是设置正确的初始验证状态
4. 确保报销单匹配功能正确实现，特别是处理未匹配的情况
5. 确保自动关联到审核工单的功能正确实现，特别是只关联到处于pending或processing状态的审核工单
6. 确保导入结果统计和错误处理功能正确实现，特别是提供详细的错误信息
7. 确保导入服务的安全性，特别是防止SQL注入和文件上传漏洞