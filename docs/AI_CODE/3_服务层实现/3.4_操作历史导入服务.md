# 操作历史导入服务实现

## 任务描述

实现操作历史导入服务（OperationHistoryImportService），用于从CSV文件导入报销单操作历史数据。该服务需要处理CSV文件解析、数据验证、操作历史创建，以及根据操作类型更新报销单状态和相关工单状态。

## 输入和依赖

- 已完成的报销单模型
- 已完成的审核工单模型
- 已完成的沟通工单模型
- CSV文件格式参考文档 (`docs/3.数据导入格式参考.md`)
- 服务实现设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的操作历史导入服务实现，包括：
- CSV文件解析功能
- 数据验证功能
- 操作历史创建功能
- 报销单匹配功能
- 根据操作类型更新报销单状态的功能
- 根据操作类型更新相关工单状态的功能
- 导入结果统计和错误处理

## 详细实现步骤

### 1. 创建操作历史模型

首先，我们需要创建一个操作历史模型来存储操作历史的基本信息：

创建 `app/models/operation_history.rb` 文件：

```ruby
# app/models/operation_history.rb
class OperationHistory < ApplicationRecord
  # 关联
  belongs_to :reimbursement, foreign_key: 'document_number', primary_key: 'invoice_number', optional: true
  
  # 验证
  validates :document_number, presence: true
  validates :operation_type, presence: true
  validates :operation_time, presence: true
  
  # 范围
  scope :approval_operations, -> { where("operation_type LIKE ?", "%审批通过%") }
  scope :rejection_operations, -> { where("operation_type LIKE ?", "%退回%") }
  scope :receipt_operations, -> { where("operation_type LIKE ?", "%收单%") }
  
  # 方法
  def is_approval?
    operation_type.include?('审批通过')
  end
  
  def is_rejection?
    operation_type.include?('退回')
  end
  
  def is_receipt?
    operation_type.include?('收单')
  end
  
  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id document_number operation_type operation_time operator notes created_at updated_at]
  end
  
  def self.ransackable_associations(auth_object = nil)
    %w[reimbursement]
  end
end
```

### 2. 创建操作历史导入服务

创建 `app/services/operation_history_import_service.rb` 文件：

```ruby
# app/services/operation_history_import_service.rb
require 'csv'

class OperationHistoryImportService
  def initialize(file, current_admin_user)
    @file = file
    @current_admin_user = current_admin_user
    @imported_count = 0
    @updated_count = 0
    @error_count = 0
    @errors = []
  end
  
  def import
    return { success: false, errors: ["文件不存在"] } unless @file.present?
    
    begin
      CSV.foreach(@file.path, headers: true) do |row|
        import_operation_history(row)
      end
      
      {
        success: true,
        imported: @imported_count,
        updated: @updated_count,
        errors: @error_count,
        error_details: @errors
      }
    rescue => e
      { success: false, errors: [e.message] }
    end
  end
  
  private
  
  def import_operation_history(row)
    document_number = row['单据编号']
    operation_type = row['操作类型']
    
    # 检查必要字段
    unless document_number.present? && operation_type.present?
      @error_count += 1
      @errors << "行 #{$.}: 单据编号或操作类型不能为空"
      return
    end
    
    # 创建操作历史记录
    operation_history = OperationHistory.new(
      document_number: document_number,
      operation_type: operation_type,
      operation_time: parse_date(row['操作日期']),
      operator: row['操作人'],
      notes: row['操作意见']
    )
    
    if operation_history.save
      @imported_count += 1
      
      # 查找对应的报销单
      reimbursement = Reimbursement.find_by(invoice_number: document_number)
      if reimbursement
        # 检查是否为审批相关操作
        if operation_type.include?('审批') || operation_type.include?('审批通过')
          # 更新报销单状态为已关闭
          reimbursement.mark_as_complete
          @updated_count += 1
          
          # 更新相关工单状态
          update_work_orders(reimbursement)
        end
      end
    else
      @error_count += 1
      @errors << "行 #{$.}: #{operation_history.errors.full_messages.join(', ')}"
    end
  end
  
  def update_work_orders(reimbursement)
    # 更新该报销单的所有审核工单状态
    reimbursement.audit_work_orders.where(status: ['pending', 'processing', 'auditing']).each do |audit_work_order|
      # 如果审核工单尚未完成，则标记为已完成
      audit_work_order.approve if audit_work_order.status == 'auditing'
      audit_work_order.complete if ['approved', 'rejected'].include?(audit_work_order.status)
    end
    
    # 更新该报销单的所有沟通工单状态
    reimbursement.communication_work_orders.where(status: ['open', 'in_progress']).each do |communication_work_order|
      # 如果沟通工单尚未完成，则标记为已解决并关闭
      communication_work_order.resolve(resolution_summary: '基于操作历史自动解决') if communication_work_order.status == 'in_progress'
      communication_work_order.close if ['resolved', 'unresolved'].include?(communication_work_order.status)
    end
  end
  
  def parse_date(date_string)
    return nil unless date_string.present?
    begin
      DateTime.parse(date_string)
    rescue
      DateTime.now
    end
  end
end
```

### 3. 创建操作历史导入控制器

创建 `app/controllers/admin/operation_history_imports_controller.rb` 文件：

```ruby
# app/controllers/admin/operation_history_imports_controller.rb
module Admin
  class OperationHistoryImportsController < ApplicationController
    def new
      render 'admin/operation_history_imports/new'
    end
    
    def create
      service = OperationHistoryImportService.new(params[:file], current_admin_user)
      result = service.import
      
      if result[:success]
        redirect_to admin_operation_histories_path, notice: "成功导入 #{result[:imported]} 条记录，更新 #{result[:updated]} 条报销单状态"
      else
        flash[:alert] = "导入失败: #{result[:errors].join(', ')}"
        render 'admin/operation_history_imports/new'
      end
    end
  end
end
```

### 4. 创建操作历史导入视图

创建 `app/views/admin/operation_history_imports/new.html.erb` 文件：

```erb
<!-- app/views/admin/operation_history_imports/new.html.erb -->
<h2>导入操作历史</h2>

<%= form_tag admin_operation_history_imports_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择CSV文件</th>
            <td><%= file_field_tag :file, accept: '.csv' %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_operation_histories_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV文件应包含以下列：</p>
    <ul>
      <li>单据编号（必填）</li>
      <li>操作类型（必填）</li>
      <li>操作日期</li>
      <li>操作人</li>
      <li>操作意见</li>
    </ul>
    <p>注意：导入前必须先导入对应的报销单</p>
  </div>
</div>
```

### 5. 更新路由配置

修改 `config/routes.rb` 文件，添加操作历史导入路由：

```ruby
# config/routes.rb
Rails.application.routes.draw do
  # ...
  
  namespace :admin do
    resources :operation_histories do
      collection do
        resources :operation_history_imports, only: [:new, :create]
      end
    end
    # ...
  end
  
  # ...
end
```

### 6. 更新 ActiveAdmin 配置

创建 `app/admin/operation_histories.rb` 文件：

```ruby
# app/admin/operation_histories.rb
ActiveAdmin.register OperationHistory do
  # 权限控制
  permit_params :document_number, :operation_type, :operation_time, :operator, :notes
  
  # 菜单设置
  menu priority: 3, label: "操作历史"
  
  # 过滤器
  filter :document_number
  filter :operation_type
  filter :operation_time
  filter :operator
  filter :created_at
  
  # 自定义操作
  action_item :import, only: :index do
    link_to "导入操作历史", new_admin_operation_history_import_path
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :document_number
    column :operation_type
    column :operation_time
    column :operator
    column :notes
    column :created_at
    actions
  end
  
  # 详情页
  show do
    attributes_table do
      row :id
      row :document_number
      row :reimbursement do |operation_history|
        if operation_history.reimbursement.present?
          link_to operation_history.reimbursement.invoice_number, admin_reimbursement_path(operation_history.reimbursement)
        end
      end
      row :operation_type
      row :operation_time
      row :operator
      row :notes
      row :created_at
      row :updated_at
    end
  end
  
  # 表单
  form do |f|
    f.inputs "操作历史信息" do
      f.input :document_number
      f.input :operation_type
      f.input :operation_time, as: :datepicker
      f.input :operator
      f.input :notes
    end
    f.actions
  end
end
```

### 7. 创建操作历史导入服务测试

创建 `spec/services/operation_history_import_service_spec.rb` 文件：

```ruby
# spec/services/operation_history_import_service_spec.rb
require 'rails_helper'

RSpec.describe OperationHistoryImportService do
  let(:admin_user) { create(:admin_user) }
  let(:csv_file) { fixture_file_upload('files/test_operation_histories.csv', 'text/csv') }
  
  describe '#import' do
    context 'with valid file' do
      before do
        # 创建测试报销单
        @reimbursement = create(:reimbursement, invoice_number: 'R20250101001')
        
        # 创建测试审核工单
        @audit_work_order = create(:audit_work_order, 
          reimbursement: @reimbursement,
          status: 'auditing'
        )
        
        # 创建测试沟通工单
        @communication_work_order = create(:communication_work_order,
          reimbursement: @reimbursement,
          audit_work_order: @audit_work_order,
          status: 'in_progress'
        )
        
        # 创建测试CSV文件
        CSV.open(Rails.root.join('spec/fixtures/files/test_operation_histories.csv'), 'w') do |csv|
          csv << ['单据编号', '操作类型', '操作日期', '操作人', '操作意见']
          csv << ['R20250101001', '审批通过', '2025-01-01', '张三', '同意报销']
          csv << ['R20250101002', '退回', '2025-01-02', '李四', '金额有误，请修改']
        end
      end
      
      after do
        # 删除测试CSV文件
        File.delete(Rails.root.join('spec/fixtures/files/test_operation_histories.csv')) if File.exist?(Rails.root.join('spec/fixtures/files/test_operation_histories.csv'))
      end
      
      it 'creates operation histories' do
        service = OperationHistoryImportService.new(csv_file, admin_user)
        
        expect {
          result = service.import
          expect(result[:success]).to be true
          expect(result[:imported]).to eq(2)
          expect(result[:updated]).to eq(1)
          expect(result[:errors]).to eq(0)
        }.to change(OperationHistory, :count).by(2)
        
        # 验证操作历史记录
        operation_history = OperationHistory.find_by(document_number: 'R20250101001')
        expect(operation_history.operation_type).to eq('审批通过')
        expect(operation_history.operator).to eq('张三')
      end
      
      it 'updates reimbursement status for approval operations' do
        service = OperationHistoryImportService.new(csv_file, admin_user)
        service.import
        
        # 验证报销单状态
        @reimbursement.reload
        expect(@reimbursement.is_complete).to be true
        expect(@reimbursement.reimbursement_status).to eq('closed')
      end
      
      it 'updates audit work order status for approval operations' do
        service = OperationHistoryImportService.new(csv_file, admin_user)
        service.import
        
        # 验证审核工单状态
        @audit_work_order.reload
        expect(@audit_work_order.status).to eq('completed')
      end
      
      it 'updates communication work order status for approval operations' do
        service = OperationHistoryImportService.new(csv_file, admin_user)
        service.import
        
        # 验证沟通工单状态
        @communication_work_order.reload
        expect(@communication_work_order.status).to eq('closed')
      end
    end
    
    context 'with invalid file' do
      it 'returns error when file is nil' do
        service = OperationHistoryImportService.new(nil, admin_user)
        result = service.import
        
        expect(result[:success]).to be false
        expect(result[:errors]).to include("文件不存在")
      end
      
      it 'handles CSV parsing errors' do
        invalid_file = fixture_file_upload('files/invalid.csv', 'text/csv')
        
        # 创建无效的CSV文件
        File.open(Rails.root.join('spec/fixtures/files/invalid.csv'), 'w') do |file|
          file.write("This is not a valid CSV file")
        end
        
        service = OperationHistoryImportService.new(invalid_file, admin_user)
        result = service.import
        
        expect(result[:success]).to be false
        expect(result[:errors]).to be_present
        
        # 删除测试文件
        File.delete(Rails.root.join('spec/fixtures/files/invalid.csv')) if File.exist?(Rails.root.join('spec/fixtures/files/invalid.csv'))
      end
      
      it 'validates required fields' do
        # 创建缺少必填字段的CSV文件
        CSV.open(Rails.root.join('spec/fixtures/files/invalid_operation_histories.csv'), 'w') do |csv|
          csv << ['单据编号', '操作类型', '操作日期', '操作人', '操作意见']
          csv << ['R20250101001', '', '2025-01-01', '张三', '同意报销'] # 缺少操作类型
          csv << ['', '退回', '2025-01-02', '李四', '金额有误，请修改'] # 缺少单据编号
        end
        
        invalid_file = fixture_file_upload('files/invalid_operation_histories.csv', 'text/csv')
        
        service = OperationHistoryImportService.new(invalid_file, admin_user)
        result = service.import
        
        expect(result[:success]).to be true
        expect(result[:errors]).to eq(2)
        expect(result[:error_details].size).to eq(2)
        
        # 删除测试文件
        File.delete(Rails.root.join('spec/fixtures/files/invalid_operation_histories.csv')) if File.exist?(Rails.root.join('spec/fixtures/files/invalid_operation_histories.csv'))
      end
    end
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/services/operation_history_import_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：
   ```ruby
   # 创建测试报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false,
     is_complete: false,
     reimbursement_status: 'processing'
   )
   
   # 创建测试审核工单
   audit_work_order = AuditWorkOrder.create!(
     reimbursement: reimbursement,
     status: 'auditing',
     created_by: 1
   )
   
   # 创建测试沟通工单
   communication_work_order = CommunicationWorkOrder.create!(
     reimbursement: reimbursement,
     audit_work_order: audit_work_order,
     status: 'in_progress',
     created_by: 1
   )
   
   # 创建测试CSV文件
   require 'csv'
   CSV.open('tmp/test_operation_histories.csv', 'w') do |csv|
     csv << ['单据编号', '操作类型', '操作日期', '操作人', '操作意见']
     csv << ['R20250101001', '审批通过', '2025-01-01', '张三', '同意报销']
     csv << ['R20250101002', '退回', '2025-01-02', '李四', '金额有误，请修改']
   end
   
   # 创建测试文件对象
   file = File.open('tmp/test_operation_histories.csv')
   def file.original_filename; 'test_operation_histories.csv'; end
   def file.content_type; 'text/csv'; end
   
   # 创建管理员用户
   admin_user = AdminUser.first || AdminUser.create!(email: 'admin@example.com', password: 'password')
   
   # 测试导入服务
   service = OperationHistoryImportService.new(file, admin_user)
   result = service.import
   
   # 检查结果
   puts "导入结果: #{result.inspect}"
   puts "创建的操作历史数量: #{OperationHistory.count}"
   puts "更新的报销单数量: #{result[:updated]}"
   
   # 检查报销单状态
   reimbursement.reload
   puts "报销单完成状态: #{reimbursement.is_complete}"
   puts "报销单状态: #{reimbursement.reimbursement_status}"
   
   # 检查工单状态
   audit_work_order.reload
   puts "审核工单状态: #{audit_work_order.status}"
   
   communication_work_order.reload
   puts "沟通工单状态: #{communication_work_order.status}"
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试操作历史导入功能

## 注意事项

1. 确保CSV文件解析功能正确实现，特别是处理中文字符和日期格式
2. 确保数据验证功能正确实现，特别是必填字段的验证
3. 确保操作历史创建功能正确实现，特别是设置正确的操作时间
4. 确保报销单匹配功能正确实现，特别是处理未匹配的情况
5. 确保根据操作类型更新报销单状态的功能正确实现，特别是审批通过操作
6. 确保根据操作类型更新相关工单状态的功能正确实现，特别是审核工单和沟通工单的状态更新
7. 确保导入结果统计和错误处理功能正确实现，特别是提供详细的错误信息
8. 确保导入服务的安全性，特别是防止SQL注入和文件上传漏洞