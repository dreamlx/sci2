# 快递收单工单处理服务实现

## 任务描述

实现快递收单工单处理服务（ExpressReceiptWorkOrderService），用于处理快递收单工单的状态流转、完成后创建审核工单等功能。该服务是工单系统的核心业务逻辑之一，负责处理报销单的快递收单流程。

## 输入和依赖

- 已完成的报销单模型
- 已完成的快递收单工单模型
- 已完成的审核工单模型
- 已完成的费用明细模型
- 服务实现设计文档 (`docs/refactoring/04_service_implementation.md`)

## 期望输出

完整的快递收单工单处理服务实现，包括：
- 工单状态流转功能
- 完成后创建审核工单功能
- 关联费用明细功能
- 错误处理和验证功能

## 详细实现步骤

### 1. 创建快递收单工单处理服务

创建 `app/services/express_receipt_work_order_service.rb` 文件：

```ruby
# app/services/express_receipt_work_order_service.rb
class ExpressReceiptWorkOrderService
  def initialize(express_receipt_work_order, current_admin_user)
    @express_receipt_work_order = express_receipt_work_order
    @current_admin_user = current_admin_user
  end
  
  def process
    @express_receipt_work_order.process
  end
  
  def complete
    result = @express_receipt_work_order.complete
    
    if result
      # 创建审核工单
      audit_work_order = @express_receipt_work_order.create_audit_work_order
      
      # 关联报销单的所有费用明细到审核工单
      reimbursement = @express_receipt_work_order.reimbursement
      reimbursement.fee_details.each do |fee_detail|
        audit_work_order.select_fee_detail(fee_detail)
      end
    end
    
    result
  end
end
```

### 2. 创建快递收单工单控制器

创建 `app/controllers/admin/express_receipt_work_orders_controller.rb` 文件：

```ruby
# app/controllers/admin/express_receipt_work_orders_controller.rb
module Admin
  class ExpressReceiptWorkOrdersController < ApplicationController
    before_action :set_express_receipt_work_order, except: [:index, :new, :create]
    
    def index
      @express_receipt_work_orders = ExpressReceiptWorkOrder.all
    end
    
    def show
      @express_receipt_work_order = ExpressReceiptWorkOrder.find(params[:id])
    end
    
    def new
      @express_receipt_work_order = ExpressReceiptWorkOrder.new
    end
    
    def create
      @express_receipt_work_order = ExpressReceiptWorkOrder.new(express_receipt_work_order_params)
      @express_receipt_work_order.created_by = current_admin_user.id
      
      if @express_receipt_work_order.save
        redirect_to admin_express_receipt_work_order_path(@express_receipt_work_order), notice: "快递收单工单已创建"
      else
        render :new
      end
    end
    
    def edit
    end
    
    def update
      if @express_receipt_work_order.update(express_receipt_work_order_params)
        redirect_to admin_express_receipt_work_order_path(@express_receipt_work_order), notice: "快递收单工单已更新"
      else
        render :edit
      end
    end
    
    def destroy
      @express_receipt_work_order.destroy
      redirect_to admin_express_receipt_work_orders_path, notice: "快递收单工单已删除"
    end
    
    def process
      service = ExpressReceiptWorkOrderService.new(@express_receipt_work_order, current_admin_user)
      
      if service.process
        redirect_to admin_express_receipt_work_order_path(@express_receipt_work_order), notice: "工单已处理"
      else
        redirect_to admin_express_receipt_work_order_path(@express_receipt_work_order), alert: "操作失败"
      end
    end
    
    def complete
      service = ExpressReceiptWorkOrderService.new(@express_receipt_work_order, current_admin_user)
      
      if service.complete
        redirect_to admin_express_receipt_work_order_path(@express_receipt_work_order), notice: "工单已完成"
      else
        redirect_to admin_express_receipt_work_order_path(@express_receipt_work_order), alert: "操作失败"
      end
    end
    
    private
    
    def set_express_receipt_work_order
      @express_receipt_work_order = ExpressReceiptWorkOrder.find(params[:id])
    end
    
    def express_receipt_work_order_params
      params.require(:express_receipt_work_order).permit(
        :reimbursement_id, 
        :status, 
        :tracking_number, 
        :received_at, 
        :courier_name
      )
    end
  end
end
```

### 3. 更新路由配置

修改 `config/routes.rb` 文件，添加快递收单工单处理路由：

```ruby
# config/routes.rb
Rails.application.routes.draw do
  # ...
  
  namespace :admin do
    resources :express_receipt_work_orders do
      member do
        put :process
        put :complete
      end
    end
    # ...
  end
  
  # ...
end
```

### 4. 创建快递收单工单处理服务测试

创建 `spec/services/express_receipt_work_order_service_spec.rb` 文件：

```ruby
# spec/services/express_receipt_work_order_service_spec.rb
require 'rails_helper'

RSpec.describe ExpressReceiptWorkOrderService do
  let(:admin_user) { create(:admin_user) }
  let(:reimbursement) { create(:reimbursement) }
  let(:express_receipt_work_order) { create(:express_receipt_work_order, reimbursement: reimbursement, status: 'received') }
  let(:service) { ExpressReceiptWorkOrderService.new(express_receipt_work_order, admin_user) }
  
  describe '#process' do
    it 'changes status to processed' do
      expect {
        service.process
      }.to change { express_receipt_work_order.reload.status }.from('received').to('processed')
    end
    
    it 'returns false if status transition is invalid' do
      express_receipt_work_order.update(status: 'completed')
      expect(service.process).to be false
    end
  end
  
  describe '#complete' do
    before do
      express_receipt_work_order.update(status: 'processed')
      @fee_detail1 = create(:fee_detail, document_number: reimbursement.invoice_number)
      @fee_detail2 = create(:fee_detail, document_number: reimbursement.invoice_number)
    end
    
    it 'changes status to completed' do
      expect {
        service.complete
      }.to change { express_receipt_work_order.reload.status }.from('processed').to('completed')
    end
    
    it 'creates an audit work order' do
      expect {
        service.complete
      }.to change(AuditWorkOrder, :count).by(1)
    end
    
    it 'associates fee details with the audit work order' do
      service.complete
      
      audit_work_order = AuditWorkOrder.last
      expect(audit_work_order.fee_details).to include(@fee_detail1, @fee_detail2)
    end
    
    it 'sets correct attributes on the audit work order' do
      service.complete
      
      audit_work_order = AuditWorkOrder.last
      expect(audit_work_order.reimbursement).to eq(reimbursement)
      expect(audit_work_order.express_receipt_work_order).to eq(express_receipt_work_order)
      expect(audit_work_order.status).to eq('pending')
      expect(audit_work_order.created_by).to eq(express_receipt_work_order.created_by)
    end
    
    it 'returns false if status transition is invalid' do
      express_receipt_work_order.update(status: 'received')
      expect(service.complete).to be false
    end
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/services/express_receipt_work_order_service_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试服务功能：
   ```ruby
   # 创建测试报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false,
     is_complete: false,
     reimbursement_status: 'processing'
   )
   
   # 创建测试快递收单工单
   express_receipt_work_order = ExpressReceiptWorkOrder.create!(
     reimbursement: reimbursement,
     status: 'received',
     tracking_number: 'SF1234567890',
     received_at: Time.current,
     courier_name: '顺丰',
     created_by: 1
   )
   
   # 创建测试费用明细
   fee_detail = FeeDetail.create!(
     document_number: reimbursement.invoice_number,
     fee_type: "交通费",
     amount: 100.00,
     currency: "CNY",
     verification_status: "pending"
   )
   
   # 创建管理员用户
   admin_user = AdminUser.first || AdminUser.create!(email: 'admin@example.com', password: 'password')
   
   # 创建服务实例
   service = ExpressReceiptWorkOrderService.new(express_receipt_work_order, admin_user)
   
   # 测试处理工单
   service.process
   puts "工单状态: #{express_receipt_work_order.reload.status}"
   
   # 测试完成工单
   service.complete
   puts "工单状态: #{express_receipt_work_order.reload.status}"
   
   # 检查创建的审核工单
   audit_work_order = AuditWorkOrder.last
   puts "审核工单ID: #{audit_work_order.id}"
   puts "审核工单状态: #{audit_work_order.status}"
   puts "关联的报销单ID: #{audit_work_order.reimbursement_id}"
   puts "关联的快递收单工单ID: #{audit_work_order.express_receipt_work_order_id}"
   
   # 检查费用明细关联
   puts "审核工单关联的费用明细数量: #{audit_work_order.fee_details.count}"
   puts "审核工单关联的费用明细类型: #{audit_work_order.fee_details.pluck(:fee_type).join(', ')}"
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试快递收单工单处理功能

## 注意事项

1. 确保状态流转功能正确实现，特别是状态转换的条件和回调
2. 确保完成后创建审核工单功能正确实现，特别是设置正确的初始状态和关联关系
3. 确保关联费用明细功能正确实现，特别是将报销单的所有费用明细关联到新创建的审核工单
4. 确保错误处理和验证功能正确实现，特别是非法状态转换的处理
5. 确保服务与控制器的交互正确实现，特别是参数的传递和结果的处理
6. 注意快递收单工单完成后自动创建审核工单的流程，这是工单系统的核心业务逻辑之一