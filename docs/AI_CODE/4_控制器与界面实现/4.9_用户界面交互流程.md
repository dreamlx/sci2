# 用户界面交互流程

## 概述

本文档描述了SCI2工单系统的用户界面交互流程，从用户故事和工作流程的角度详细说明系统的使用方式。这些流程基于ActiveAdmin实现，旨在提供直观、高效的用户体验。

## 用户角色

系统主要面向以下用户角色：

1. **财务审核人员**：负责审核报销单和费用明细
2. **沟通协调人员**：负责与申请人沟通解决问题
3. **数据导入人员**：负责导入报销单、快递收单等数据
4. **系统管理员**：负责管理系统和用户

## 核心工作流程

### 1. 数据导入流程

#### 1.1 报销单导入

**用户故事**：作为数据导入人员，我希望能够导入报销单数据，以便系统可以开始处理报销流程。

**交互流程**：

1. 用户登录系统，进入报销单管理页面
2. 点击"导入报销单"按钮
3. 系统显示导入页面，包含导入说明和文件上传控件
4. 用户选择CSV或Excel文件并点击"导入"按钮
5. 系统处理文件并显示导入结果（创建数量、更新数量、错误数量）
6. 如果有错误，系统显示详细错误信息
7. 导入成功后，系统返回报销单列表页面，显示新导入的报销单

**关键交互点**：
- 提供清晰的导入说明和文件格式要求
- 显示导入进度指示器
- 提供详细的导入结果反馈
- 支持错误记录导出

#### 1.2 快递收单导入

**用户故事**：作为数据导入人员，我希望能够导入快递收单数据，以便系统可以自动创建快递收单工单。

**交互流程**：

1. 用户登录系统，进入快递收单工单管理页面
2. 点击"导入快递收单"按钮
3. 系统显示导入页面，包含导入说明和文件上传控件
4. 用户选择CSV或Excel文件并点击"导入"按钮
5. 系统处理文件，自动创建快递收单工单（状态为completed）
6. 系统显示导入结果（创建数量、跳过数量、未匹配数量、错误数量）
7. 如果有未匹配记录，系统提供未匹配记录的详情
8. 导入成功后，系统返回快递收单工单列表页面

**关键交互点**：
- 自动从"操作意见"字段提取快递单号
- 自动关联到已存在的报销单
- 处理重复记录（相同报销单+快递单号）
- 处理未匹配报销单的记录

#### 1.3 费用明细导入

**用户故事**：作为数据导入人员，我希望能够导入费用明细数据，以便审核人员可以审核这些明细。

**交互流程**：

1. 用户登录系统，进入费用明细管理页面
2. 点击"导入费用明细"按钮
3. 系统显示导入页面，包含导入说明和文件上传控件
4. 用户选择CSV或Excel文件并点击"导入"按钮
5. 系统处理文件，创建费用明细记录（初始状态为pending）
6. 系统显示导入结果（导入数量、跳过数量、未匹配数量、错误数量）
7. 导入成功后，系统返回费用明细列表页面

**关键交互点**：
- 自动关联到已存在的报销单
- 处理重复记录（相同报销单号+费用类型+金额+费用日期）
- 处理未匹配报销单的记录

#### 1.4 操作历史导入

**用户故事**：作为数据导入人员，我希望能够导入操作历史数据，以便系统可以根据历史记录更新报销单状态。

**交互流程**：

1. 用户登录系统，进入操作历史管理页面
2. 点击"导入操作历史"按钮
3. 系统显示导入页面，包含导入说明和文件上传控件
4. 用户选择CSV或Excel文件并点击"导入"按钮
5. 系统处理文件，创建操作历史记录
6. 系统根据特定条件（操作类型为"审批"且操作意见为"审批通过"）更新报销单状态为closed
7. 系统显示导入结果（导入数量、跳过数量、报销单状态更新数量、未匹配数量、错误数量）
8. 导入成功后，系统返回操作历史列表页面

**关键交互点**：
- 自动关联到已存在的报销单
- 处理重复记录（相同报销单号+操作类型+操作时间+操作人）
- 处理未匹配报销单的记录
- 自动更新报销单状态

### 2. 审核工单流程

#### 2.1 创建审核工单

**用户故事**：作为财务审核人员，我希望能够创建审核工单，以便对报销单进行审核。

**交互流程**：

1. 用户登录系统，进入报销单详情页面
2. 点击"新建审核工单"按钮
3. 系统显示审核工单创建表单
4. 用户填写表单字段：
   - 问题类型（下拉列表）
   - 问题说明（下拉列表）
   - 备注说明（文本框）
   - 处理意见（下拉列表）
5. 用户选择需要审核的费用明细（至少一条）
6. 用户点击"创建审核工单"按钮
7. 系统创建审核工单（状态为pending）并返回审核工单详情页面

**关键交互点**：
- 自动关联到当前报销单
- 提供费用明细全选/取消全选功能
- 验证至少选择一条费用明细
- 创建工单后自动更新报销单状态为processing

#### 2.2 处理审核工单

**用户故事**：作为财务审核人员，我希望能够处理审核工单，以便完成报销单的审核流程。

**交互流程**：

1. 用户登录系统，进入审核工单详情页面
2. 点击"开始处理"按钮
3. 系统更新工单状态为processing，并更新关联费用明细状态为problematic
4. 用户审核费用明细，可以点击"更新验证状态"按钮修改费用明细验证状态
5. 用户决定审核结果：
   - 如果审核通过，点击"审核通过"按钮
   - 如果审核不通过，点击"审核拒绝"按钮
6. 系统显示确认表单，用户填写审核意见
7. 用户点击"确认通过"或"确认拒绝"按钮
8. 系统更新工单状态为approved或rejected，并更新关联费用明细状态为verified或problematic
9. 如果所有费用明细都变为verified，系统自动更新报销单状态为waiting_completion

**关键交互点**：
- 状态转换按钮只在特定状态下显示
- 拒绝时必须填写拒绝原因
- 状态转换后自动更新关联费用明细状态
- 费用明细全部verified后自动更新报销单状态

### 3. 沟通工单流程

#### 3.1 创建沟通工单

**用户故事**：作为沟通协调人员，我希望能够创建沟通工单，以便与申请人沟通解决问题。

**交互流程**：

1. 用户登录系统，进入报销单详情页面或审核工单详情页面
2. 点击"新建沟通工单"按钮
3. 系统显示沟通工单创建表单
4. 用户填写表单字段：
   - 关联审核工单（如果从审核工单页面创建则自动填充）
   - 沟通方式（下拉列表）
   - 发起人角色（下拉列表）
   - 问题类型（下拉列表）
   - 问题说明（下拉列表）
   - 备注说明（文本框）
   - 处理意见（下拉列表）
5. 用户选择需要沟通的费用明细（至少一条）
6. 用户点击"创建沟通工单"按钮
7. 系统创建沟通工单（状态为pending）并返回沟通工单详情页面

**关键交互点**：
- 自动关联到当前报销单和审核工单
- 提供费用明细全选/取消全选功能
- 验证至少选择一条费用明细
- 创建工单后自动更新报销单状态为processing

#### 3.2 处理沟通工单

**用户故事**：作为沟通协调人员，我希望能够处理沟通工单，以便完成与申请人的沟通流程。

**交互流程**：

1. 用户登录系统，进入沟通工单详情页面
2. 用户可以选择：
   - 点击"开始处理"按钮，系统更新工单状态为processing
   - 点击"标记需沟通"按钮，系统更新工单状态为needs_communication
3. 系统更新关联费用明细状态为problematic
4. 用户可以点击"添加沟通记录"按钮记录沟通过程
5. 用户填写沟通记录表单：
   - 沟通内容（文本框）
   - 沟通角色（下拉列表）
   - 沟通人姓名（文本框，默认为当前用户）
   - 沟通方式（下拉列表）
6. 用户点击"添加记录"按钮，系统保存沟通记录
7. 用户决定沟通结果：
   - 如果沟通解决问题，点击"沟通后通过"按钮
   - 如果沟通未解决问题，点击"沟通后拒绝"按钮
8. 系统显示确认表单，用户填写解决方案摘要或拒绝原因
9. 用户点击"确认通过"或"确认拒绝"按钮
10. 系统更新工单状态为approved或rejected，并更新关联费用明细状态为verified或problematic
11. 如果所有费用明细都变为verified，系统自动更新报销单状态为waiting_completion

**关键交互点**：
- 状态转换按钮只在特定状态下显示
- 沟通记录可以在任何状态下添加
- 拒绝时必须填写拒绝原因
- 状态转换后自动更新关联费用明细状态
- 费用明细全部verified后自动更新报销单状态

### 4. 费用明细验证流程

#### 4.1 更新费用明细验证状态

**用户故事**：作为财务审核人员或沟通协调人员，我希望能够更新费用明细的验证状态，以便标记问题明细或确认已验证明细。

**交互流程**：

1. 用户登录系统，进入工单详情页面
2. 在"费用明细"标签页中，点击特定费用明细的"更新验证状态"按钮
3. 系统显示验证状态更新表单，显示当前费用明细信息和验证状态
4. 用户选择新的验证状态（pending、problematic、verified）
5. 用户可以填写验证意见
6. 用户点击"提交"按钮
7. 系统更新费用明细验证状态和验证意见
8. 如果报销单下所有费用明细都变为verified，系统自动更新报销单状态为waiting_completion

**关键交互点**：
- 显示费用明细的全局状态和工单内状态
- 验证状态变更后自动更新报销单状态
- 提供验证意见记录功能

#### 4.2 批量更新费用明细验证状态

**用户故事**：作为财务审核人员，我希望能够批量更新费用明细的验证状态，以便提高工作效率。

**交互流程**：

1. 用户登录系统，进入费用明细列表页面
2. 用户选择多个费用明细（使用复选框）
3. 用户点击"标记为已验证"批量操作按钮
4. 系统显示确认对话框
5. 用户确认操作
6. 系统批量更新选中费用明细的验证状态为verified
7. 系统显示操作结果消息

**关键交互点**：
- 提供批量选择功能
- 批量操作后自动更新相关报销单状态
- 显示操作结果反馈

### 5. 报销单管理流程

#### 5.1 查看报销单

**用户故事**：作为财务审核人员，我希望能够查看报销单详情，以便了解报销单的状态和相关信息。

**交互流程**：

1. 用户登录系统，进入报销单列表页面
2. 用户可以使用过滤器和搜索功能查找特定报销单
3. 用户点击报销单的"查看"按钮
4. 系统显示报销单详情页面，包含多个标签页：
   - 基本信息
   - 快递收单工单
   - 审核工单
   - 沟通工单
   - 费用明细
   - 操作历史
5. 用户可以在各标签页查看相关信息
6. 用户可以点击"新建审核工单"或"新建沟通工单"按钮创建工单

**关键交互点**：
- 使用标签页组织不同类型的相关信息
- 提供创建工单的快捷入口
- 显示报销单的内部状态和外部状态

#### 5.2 标记报销单为已收单

**用户故事**：作为数据导入人员，我希望能够标记报销单为已收单，以便更新报销单的收单状态。

**交互流程**：

1. 用户登录系统，进入报销单列表页面
2. 用户选择一个或多个报销单（使用复选框）
3. 用户点击"标记为已收单"批量操作按钮
4. 系统显示确认对话框
5. 用户确认操作
6. 系统更新选中报销单的收单状态为received，并设置收单日期为当前日期
7. 系统显示操作结果消息

**关键交互点**：
- 提供批量操作功能
- 自动设置收单日期
- 显示操作结果反馈

### 6. 仪表盘和数据统计

#### 6.1 查看仪表盘

**用户故事**：作为系统用户，我希望能够查看仪表盘，以便获取系统概览和待处理任务。

**交互流程**：

1. 用户登录系统，系统默认显示仪表盘页面
2. 仪表盘显示以下信息：
   - 系统概览（报销单总数、待处理工单数等）
   - 待处理审核工单列表
   - 待处理沟通工单列表
   - 最近导入的报销单列表
   - 最近活动时间线
   - 快速操作区域
3. 用户可以点击各区域的链接进入相应页面
4. 用户可以点击"查看全部"链接查看完整列表

**关键交互点**：
- 提供关键数据的直观展示
- 提供待处理任务的快速访问
- 提供最近活动的概览

#### 6.2 查看数据统计

**用户故事**：作为系统管理员，我希望能够查看数据统计，以便了解系统运行状况和业务指标。

**交互流程**：

1. 用户登录系统，点击侧边栏的"数据统计"菜单
2. 系统显示数据统计页面，包含多个标签页：
   - 报销单状态统计
   - 工单处理统计
   - 费用明细验证统计
3. 用户可以在各标签页查看相关统计图表和数据
4. 用户可以选择时间范围过滤统计数据

**关键交互点**：
- 使用图表直观展示统计数据
- 提供数据过滤功能
- 显示关键业务指标

## 特殊场景处理

### 1. 导入错误处理

**场景**：导入数据时遇到格式错误或数据错误。

**处理流程**：

1. 系统显示错误消息，指出错误类型和位置
2. 系统提供错误详情，包括行号和具体错误原因
3. 用户修正数据文件后重新导入
4. 系统支持部分导入，即使有部分记录错误也能导入正确的记录

### 2. 未匹配报销单处理

**场景**：导入快递收单、费用明细或操作历史时，找不到对应的报销单。

**处理流程**：

1. 系统记录未匹配记录，但不导入数据库
2. 系统在导入结果中显示未匹配记录数量
3. 系统提供未匹配记录的详情，包括报销单号和其他关键信息
4. 用户可以先导入报销单，然后重新导入未匹配记录

### 3. 重复记录处理

**场景**：导入数据时遇到重复记录。

**处理流程**：

1. 对于报销单，系统更新已存在的记录
2. 对于快递收单、费用明细和操作历史，系统跳过重复记录
3. 系统在导入结果中显示更新或跳过的记录数量

### 4. 状态转换错误处理

**场景**：工单状态转换时遇到错误（如非法状态转换）。

**处理流程**：

1. 系统显示错误消息，说明无法执行状态转换的原因
2. 系统保持工单当前状态不变
3. 用户可以尝试其他操作或修正错误后重试

## 用户界面响应性

### 1. 页面加载反馈

- 使用加载指示器显示页面加载状态
- 优先加载关键内容，延迟加载次要内容
- 使用骨架屏减少加载时的视觉跳动

### 2. 操作反馈

- 使用 Toast 消息提示操作结果
- 操作成功后自动跳转到相关页面
- 操作失败时保留表单数据并显示错误

### 3. 表单验证反馈

- 实时表单验证，即时反馈错误
- 清晰的错误提示信息
- 表单提交前确认必填字段

## 总结

本文档详细描述了SCI2工单系统的用户界面交互流程，从用户故事和工作流程的角度说明了系统的使用方式。这些流程设计旨在提供直观、高效的用户体验，帮助用户完成报销单审核和工单处理任务。通过实现这些交互流程，系统可以满足不同用户角色的需求，提高工作效率。