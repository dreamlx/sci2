# 自定义视图模板实现

## 任务描述

实现 ActiveAdmin 资源所需的自定义视图模板，包括导入表单、状态转换表单、验证表单等。这些视图模板将提供用户友好的界面，允许用户执行各种操作，如导入数据、转换工单状态、验证费用明细等。

## 输入和依赖

- ActiveAdmin 资源配置
- 服务层实现
- 控制器与界面设计文档 (`docs/refactoring/05_activeadmin_integration.md`)

## 期望输出

完整的自定义视图模板实现，包括：
- 报销单导入视图
- 审核工单审核视图
- 审核工单沟通创建视图
- 审核工单费用明细验证视图
- 沟通工单沟通记录视图
- 沟通工单解决视图
- 费用明细验证视图

## 详细实现步骤

### 1. 报销单导入视图

创建 `app/views/admin/reimbursements/new_import.html.erb` 文件：

```erb
<h2>导入报销单</h2>

<%= form_tag import_admin_reimbursements_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择文件</th>
            <td><%= file_field_tag :file, accept: '.csv,.xlsx,.xls', required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_reimbursements_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV或Excel文件应包含以下列：</p>
    <ul>
      <li>报销单单号（必填）</li>
      <li>单据名称</li>
      <li>报销单申请人</li>
      <li>报销单申请人工号</li>
      <li>申请人公司</li>
      <li>申请人部门</li>
      <li>报销金额（单据币种）</li>
      <li>收单状态</li>
      <li>报销单状态</li>
      <li>收单日期</li>
      <li>提交报销日期</li>
      <li>单据标签</li>
    </ul>
  </div>
</div>
```

### 2. 审核工单审核视图

#### 2.1 审核通过视图

创建 `app/views/admin/audit_work_orders/approve.html.erb` 文件：

```erb
<% provide :title, "审核通过 - 审核工单 ##{@audit_work_order.id}" %>
<h2>审核通过 - 审核工单 #<%= @audit_work_order.id %></h2>

<%= semantic_form_for @audit_work_order, url: do_approve_admin_audit_work_order_path(@audit_work_order), method: :post do |f| %>
  <%= f.inputs do %>
    <li class="string input optional">
      <label class="label">报销单号</label>
      <%= link_to @audit_work_order.reimbursement.invoice_number, admin_reimbursement_path(@audit_work_order.reimbursement) %>
    </li>
    <li class="string input optional">
      <label class="label">申请人</label>
      <%= @audit_work_order.reimbursement.applicant %>
    </li>
    <%= f.input :comment, as: :text, label: "审核意见", input_html: { rows: 5 } %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "确认通过", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_audit_work_order_path(@audit_work_order) } %>
  <% end %>
<% end %>
```

#### 2.2 审核拒绝视图

创建 `app/views/admin/audit_work_orders/reject.html.erb` 文件：

```erb
<% provide :title, "审核拒绝 - 审核工单 ##{@audit_work_order.id}" %>
<h2>审核拒绝 - 审核工单 #<%= @audit_work_order.id %></h2>

<%= semantic_form_for @audit_work_order, url: do_reject_admin_audit_work_order_path(@audit_work_order), method: :post do |f| %>
  <%= f.inputs do %>
    <li class="string input optional">
      <label class="label">报销单号</label>
      <%= link_to @audit_work_order.reimbursement.invoice_number, admin_reimbursement_path(@audit_work_order.reimbursement) %>
    </li>
    <li class="string input optional">
      <label class="label">申请人</label>
      <%= @audit_work_order.reimbursement.applicant %>
    </li>
    <%= f.input :comment, as: :text, label: "审核意见 (必填)", input_html: { rows: 5, required: true } %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "确认拒绝", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_audit_work_order_path(@audit_work_order) } %>
  <% end %>
<% end %>
```

### 3. 审核工单沟通创建视图

创建 `app/views/admin/audit_work_orders/new_communication.html.erb` 文件：

```erb
<% provide :title, "创建沟通工单 - 审核工单 ##{@audit_work_order.id}" %>
<h2>创建沟通工单 - 审核工单 #<%= @audit_work_order.id %></h2>

<%= semantic_form_for :communication_work_order, url: create_communication_admin_audit_work_order_path(@audit_work_order), method: :post do |f| %>
  <%= f.inputs do %>
    <%= f.input :communication_method, as: :select, collection: ["email", "phone", "system", "other"], label: "沟通方式", required: true %>
    <%= f.input :initiator_role, as: :select, collection: ["auditor", "applicant", "manager", "other"], label: "发起人角色", required: true %>
    <%= f.input :content, as: :text, label: "沟通内容/问题描述", input_html: { rows: 5, required: true } %>
    <%= f.input :fee_detail_ids, as: :check_boxes, collection: @fee_details.map { |fd| ["##{fd.id} - #{fd.fee_type} (#{number_to_currency(fd.amount)})", fd.id] }, label: "关联费用明细 (可选)" %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "创建沟通工单", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_audit_work_order_path(@audit_work_order) } %>
  <% end %>
<% end %>
```

### 4. 审核工单费用明细验证视图

创建 `app/views/admin/audit_work_orders/verify_fee_detail.html.erb` 文件：

```erb
<% provide :title, "验证费用明细 ##{@fee_detail.id} - 审核工单 ##{@audit_work_order.id}" %>
<h2>验证费用明细 #<%= @fee_detail.id %> - 审核工单 #<%= @audit_work_order.id %></h2>

<%= semantic_form_for @audit_work_order, url: do_verify_fee_detail_admin_audit_work_order_path(@audit_work_order), method: :post do |f| %>
  <%= hidden_field_tag :fee_detail_id, @fee_detail.id %>
  <%= f.inputs do %>
    <li class="string input optional">
      <label class="label">费用类型</label>
      <%= @fee_detail.fee_type %>
    </li>
    <li class="string input optional">
      <label class="label">金额</label>
      <%= number_to_currency(@fee_detail.amount, unit: "¥") %>
    </li>
    <li class="string input optional">
      <label class="label">当前全局状态</label>
      <%= status_tag @fee_detail.verification_status %>
    </li>
    <% selection = @audit_work_order.fee_detail_selections.find_by(fee_detail_id: @fee_detail.id) %>
    <li class="string input optional">
      <label class="label">当前工单内状态</label>
      <%= status_tag selection&.verification_status %>
    </li>
    <%= f.input :verification_status, as: :select, collection: [["已验证", "verified"], ["已拒绝", "rejected"], ["有问题", "problematic"]], label: "设置验证状态", required: true, selected: selection&.verification_status %>
    <%= f.input :comment, as: :text, label: "验证意见", input_html: { rows: 3, value: selection&.verification_comment } %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "提交", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_audit_work_order_path(@audit_work_order) } %>
  <% end %>
<% end %>
```

### 5. 沟通工单沟通记录视图

创建 `app/views/admin/communication_work_orders/new_communication_record.html.erb` 文件：

```erb
<% provide :title, "添加沟通记录 - 沟通工单 ##{@communication_work_order.id}" %>
<h2>添加沟通记录 - 沟通工单 #<%= @communication_work_order.id %></h2>

<%= semantic_form_for :communication_record, url: create_communication_record_admin_communication_work_order_path(@communication_work_order), method: :post do |f| %>
  <%= f.inputs do %>
    <%= f.input :content, as: :text, label: "沟通内容", input_html: { rows: 5, required: true } %>
    <%= f.input :communicator_role, as: :select, collection: [["审核人", "auditor"], ["申请人", "applicant"], ["管理员", "admin"], ["其他", "other"]], label: "沟通角色", required: true %>
    <%= f.input :communicator_name, as: :string, label: "沟通人姓名", input_html: { value: current_admin_user.email } %>
    <%= f.input :communication_method, as: :select, collection: [["系统", "system"], ["邮件", "email"], ["电话", "phone"], ["其他", "other"]], label: "沟通方式", required: true %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "添加记录", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_communication_work_order_path(@communication_work_order) } %>
  <% end %>
<% end %>
```

### 6. 沟通工单解决视图

#### 6.1 标记已解决视图

创建 `app/views/admin/communication_work_orders/resolve.html.erb` 文件：

```erb
<% provide :title, "标记已解决 - 沟通工单 ##{@communication_work_order.id}" %>
<h2>标记已解决 - 沟通工单 #<%= @communication_work_order.id %></h2>

<%= semantic_form_for @communication_work_order, url: do_resolve_admin_communication_work_order_path(@communication_work_order), method: :post do |f| %>
  <%= f.inputs do %>
    <%= f.input :resolution_summary, as: :text, label: "解决摘要", input_html: { rows: 5 } %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "确认已解决", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_communication_work_order_path(@communication_work_order) } %>
  <% end %>
<% end %>
```

#### 6.2 标记未解决视图

创建 `app/views/admin/communication_work_orders/mark_unresolved.html.erb` 文件：

```erb
<% provide :title, "标记未解决 - 沟通工单 ##{@communication_work_order.id}" %>
<h2>标记未解决 - 沟通工单 #<%= @communication_work_order.id %></h2>

<%= semantic_form_for @communication_work_order, url: do_mark_unresolved_admin_communication_work_order_path(@communication_work_order), method: :post do |f| %>
  <%= f.inputs do %>
    <%= f.input :resolution_summary, as: :text, label: "未解决原因/摘要", input_html: { rows: 5 } %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "确认未解决", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_communication_work_order_path(@communication_work_order) } %>
  <% end %>
<% end %>
```

### 7. 沟通工单费用明细问题解决视图

创建 `app/views/admin/communication_work_orders/resolve_fee_detail_issue.html.erb` 文件：

```erb
<% provide :title, "解决费用明细问题备注 - 沟通工单 ##{@communication_work_order.id}" %>
<h2>解决费用明细问题备注 - 沟通工单 #<%= @communication_work_order.id %></h2>
<h3>费用明细 #<%= @fee_detail.id %></h3>

<%= semantic_form_for @communication_work_order, url: do_resolve_fee_detail_issue_admin_communication_work_order_path(@communication_work_order), method: :post do |f| %>
  <%= hidden_field_tag :fee_detail_id, @fee_detail.id %>
  <%= f.inputs do %>
    <li class="string input optional">
      <label class="label">费用类型</label>
      <%= @fee_detail.fee_type %>
    </li>
    <li class="string input optional">
      <label class="label">金额</label>
      <%= number_to_currency(@fee_detail.amount, unit: "¥") %>
    </li>
    <% selection = @communication_work_order.fee_detail_selections.find_by(fee_detail_id: @fee_detail.id) %>
    <li class="string input optional">
      <label class="label">当前备注</label>
      <%= selection&.verification_comment %>
    </li>
    <%= f.input :resolution, as: :text, label: "解决备注", input_html: { rows: 5, value: selection&.verification_comment } %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "更新备注", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, button_html: { type: 'link', href: admin_communication_work_order_path(@communication_work_order) } %>
  <% end %>
<% end %>
```

### 8. 费用明细验证视图

创建 `app/views/admin/fee_details/update_verification_status.html.erb` 文件：

```erb
<% provide :title, "更新验证状态 - 费用明细 ##{@fee_detail.id}" %>
<h2>更新验证状态 - 费用明细 #<%= @fee_detail.id %></h2>

<%= semantic_form_for @fee_detail, url: do_update_verification_status_admin_fee_detail_path(@fee_detail), method: :post do |f| %>
  <%= f.inputs do %>
    <li class="string input optional">
      <label class="label">费用类型</label>
      <%= @fee_detail.fee_type %>
    </li>
    <li class="string input optional">
      <label class="label">金额</label>
      <%= number_to_currency(@fee_detail.amount, unit: @fee_detail.currency || "¥") %>
    </li>
    <li class="string input optional">
      <label class="label">当前验证状态</label>
      <%= status_tag @fee_detail.verification_status %>
    </li>
    <%= f.input :verification_status, as: :select, 
                collection: [["待验证", "pending"], ["已验证", "verified"], 
                            ["已拒绝", "rejected"], ["有问题", "problematic"]], 
                label: "设置验证状态", required: true, 
                selected: @fee_detail.verification_status %>
    <%= f.input :comment, as: :text, label: "验证意见", input_html: { rows: 3 } %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "提交", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, 
                 button_html: { type: 'link', href: admin_fee_detail_path(@fee_detail) } %>
  <% end %>
<% end %>
```

## 关键实现点

1. **表单设计**：
   - 使用 Formtastic 构建表单
   - 提供清晰的标签和提示
   - 使用适当的表单控件（文本框、下拉列表、复选框等）
   - 提供取消和提交按钮

2. **状态显示**：
   - 使用 `status_tag` 显示状态
   - 根据状态自动应用不同的样式

3. **关联数据展示**：
   - 显示关联的报销单、费用明细等信息
   - 提供链接跳转到相关资源

4. **错误处理**：
   - 使用 Flash 消息显示错误
   - 在表单中显示验证错误

5. **用户体验**：
   - 提供清晰的页面标题和说明
   - 使用面板和表格组织信息
   - 提供导入说明和示例

## 测试验证方法

1. 启动 Rails 服务器：`rails server`
2. 访问 ActiveAdmin 界面：`http://localhost:3000/admin`
3. 测试各个自定义视图模板：
   - 测试报销单导入视图
   - 测试审核工单审核视图
   - 测试审核工单沟通创建视图
   - 测试审核工单费用明细验证视图
   - 测试沟通工单沟通记录视图
   - 测试沟通工单解决视图
   - 测试费用明细验证视图
4. 验证表单提交和错误处理功能

## 注意事项

1. 确保视图模板路径正确
2. 确保表单提交 URL 和方法正确
3. 确保表单字段名称与控制器参数名称匹配
4. 确保错误处理和显示正确
5. 考虑添加 JavaScript 增强用户体验，如表单验证、动态内容等
6. 考虑添加 CSS 样式，提高界面美观度
7. 确保视图模板与 ActiveAdmin 资源配置一致
8. 考虑添加国际化支持，使界面支持多语言