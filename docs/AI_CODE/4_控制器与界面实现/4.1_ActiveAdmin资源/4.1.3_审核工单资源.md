# 审核工单 ActiveAdmin 资源实现

## 任务描述

实现审核工单的 ActiveAdmin 资源，包括列表页、详情页、表单页和状态转换操作。该资源将提供审核工单的管理界面，允许用户查看、创建、编辑审核工单，以及执行状态转换操作、费用明细验证和沟通工单创建等功能。

## 输入和依赖

- 基础模型（AuditWorkOrder 及其关联模型）
- 服务层（AuditWorkOrderService, FeeDetailVerificationService）
- ActiveAdmin 框架
- 控制器与界面设计文档 (`docs/refactoring/05_activeadmin_integration.md`)

## 期望输出

完整的审核工单 ActiveAdmin 资源实现，包括：
- 资源配置
- 列表页配置
- 详情页配置
- 表单页配置
- 状态转换操作
- 费用明细验证界面
- 沟通工单创建界面
- 批量操作

## 详细实现步骤

### 1. 创建审核工单 ActiveAdmin 资源

创建 `app/admin/audit_work_orders.rb` 文件，实现审核工单的 ActiveAdmin 资源：

```ruby
# app/admin/audit_work_orders.rb
ActiveAdmin.register AuditWorkOrder do
  # 权限控制
  permit_params :reimbursement_id, :express_receipt_work_order_id, :status, :audit_result,
                :audit_comment, :audit_date, :vat_verified, :created_by

  # 菜单设置
  menu priority: 3, label: "审核工单"

  # 过滤器
  filter :reimbursement_invoice_number, as: :string, label: '报销单号'
  filter :status, as: :select, collection: AuditWorkOrder.state_machines[:status].states.map(&:name)
  filter :audit_result, as: :select, collection: ["approved", "rejected"]
  filter :audit_date
  filter :created_at
  
  # 批量操作和自定义操作
  # ...
  
  # 列表页
  index do
    # ...
  end
  
  # 详情页
  show do
    # ...
  end
  
  # 表单
  form do |f|
    # ...
  end
end
```

### 2. 实现批量操作和自定义操作

添加批量操作和自定义操作：

```ruby
# 批量操作
batch_action :start_processing, if: proc { params[:scope] == 'pending' || params[:q].blank? } do |ids|
  batch_action_collection.find(ids).each do |work_order|
    begin
      audit_work_order_service(work_order).start_processing
    rescue StateMachines::InvalidTransition => e
      Rails.logger.warn "批量处理审核工单 ##{work_order.id} 失败: #{e.message}"
    end
  end
  redirect_to collection_path, notice: "已尝试将选中的工单标记为处理中"
end

# 自定义操作 (Action Items)
action_item :start_processing, only: :show, if: proc { resource.may_start_processing? } do
  link_to "开始处理", start_processing_admin_audit_work_order_path(resource), method: :put
end

action_item :start_audit, only: :show, if: proc { resource.may_start_audit? } do
  link_to "开始审核", start_audit_admin_audit_work_order_path(resource), method: :put
end

action_item :approve, only: :show, if: proc { resource.may_approve? } do
  link_to "审核通过", approve_admin_audit_work_order_path(resource)
end

action_item :reject, only: :show, if: proc { resource.may_reject? } do
  link_to "审核拒绝", reject_admin_audit_work_order_path(resource)
end

action_item :need_communication, only: :show, if: proc { resource.may_need_communication? } do
  link_to "需要沟通", new_communication_admin_audit_work_order_path(resource)
end

action_item :complete, only: :show, if: proc { resource.may_complete? } do
  link_to "完成", complete_admin_audit_work_order_path(resource), method: :put
end
```

### 3. 实现自定义页面操作

添加自定义页面操作：

```ruby
# 自定义页面 (Member Actions)
member_action :start_processing, method: :put do
  service = audit_work_order_service(resource)
  begin
    service.start_processing
    redirect_to admin_audit_work_order_path(resource), notice: "工单已开始处理"
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_audit_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end

member_action :start_audit, method: :put do
  service = audit_work_order_service(resource)
  begin
    service.start_audit
    redirect_to admin_audit_work_order_path(resource), notice: "工单已开始审核"
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_audit_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end

member_action :approve, method: :get do
  # 渲染审核通过表单
  render :approve
end

member_action :do_approve, method: :post do
  service = audit_work_order_service(resource)
  begin
    if service.approve(params[:comment])
      redirect_to admin_audit_work_order_path(resource), notice: "审核已通过"
    else
      flash.now[:alert] = "操作失败: #{resource.errors.full_messages.join(', ')}"
      render :approve
    end
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_audit_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end

member_action :reject, method: :get do
  # 渲染审核拒绝表单
  render :reject
end

member_action :do_reject, method: :post do
  service = audit_work_order_service(resource)
  begin
    if service.reject(params[:comment])
      redirect_to admin_audit_work_order_path(resource), notice: "审核已拒绝"
    else
      flash.now[:alert] = "操作失败: #{resource.errors.full_messages.join(', ')}"
      render :reject
    end
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_audit_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end

member_action :new_communication, method: :get do
  @fee_details = resource.reimbursement.fee_details.where(verification_status: ['pending', 'problematic'])
  # 渲染创建沟通工单表单
  render :new_communication
end

member_action :create_communication, method: :post do
  service = audit_work_order_service(resource)
  communication_work_order = service.create_communication_work_order(
    communication_method: params[:communication_method],
    initiator_role: params[:initiator_role],
    content: params[:content],
    fee_detail_ids: params[:fee_detail_ids]
  )

  if communication_work_order&.persisted?
    redirect_to admin_communication_work_order_path(communication_work_order), notice: "沟通工单已创建"
  else
    errors = communication_work_order&.errors&.full_messages || resource.errors.full_messages
    flash.now[:alert] = "创建沟通工单失败: #{errors.join(', ')}"
    @fee_details = resource.reimbursement.fee_details.where(verification_status: ['pending', 'problematic'])
    render :new_communication
  end
end

member_action :complete, method: :put do
  service = audit_work_order_service(resource)
  begin
    service.complete
    redirect_to admin_audit_work_order_path(resource), notice: "工单已完成"
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_audit_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end

# 费用明细验证操作
member_action :verify_fee_detail, method: :get do
  @fee_detail = FeeDetail.find(params[:fee_detail_id])
  # 渲染费用明细验证表单
  render :verify_fee_detail
end

member_action :do_verify_fee_detail, method: :post do
  service = audit_work_order_service(resource)
  if service.verify_fee_detail(params[:fee_detail_id], params[:verification_status], params[:comment])
    redirect_to admin_audit_work_order_path(resource), notice: "费用明细 ##{params[:fee_detail_id]} 状态已更新"
  else
    @fee_detail = FeeDetail.find(params[:fee_detail_id])
    flash.now[:alert] = "费用明细 ##{params[:fee_detail_id]} 更新失败: #{@fee_detail.errors.full_messages.join(', ')}"
    render :verify_fee_detail
  end
end
```

### 4. 实现列表页配置

在 `index` 块中实现列表页配置：

```ruby
index do
  selectable_column
  id_column
  column :reimbursement do |work_order|
    link_to work_order.reimbursement.invoice_number, admin_reimbursement_path(work_order.reimbursement)
  end
  column :status do |work_order|
    status_tag work_order.status
  end
  column :audit_result do |work_order|
    status_tag work_order.audit_result if work_order.audit_result.present?
  end
  column :audit_date
  column :created_at
  actions
end
```

### 5. 实现详情页配置

在 `show` 块中实现详情页配置，使用标签页展示不同类型的信息：

```ruby
show do
  tabs do
    tab "基本信息" do
      attributes_table do
        row :id
        row :reimbursement do |work_order|
          link_to work_order.reimbursement.invoice_number, admin_reimbursement_path(work_order.reimbursement)
        end
        row :express_receipt_work_order do |work_order|
          if work_order.express_receipt_work_order.present?
            link_to work_order.express_receipt_work_order.id, admin_express_receipt_work_order_path(work_order.express_receipt_work_order)
          end
        end
        row :status do |work_order|
          status_tag work_order.status
        end
        row :audit_result do |work_order|
          status_tag work_order.audit_result if work_order.audit_result.present?
        end
        row :audit_comment
        row :audit_date
        row :vat_verified
        row :created_by do |work_order|
          AdminUser.find_by(id: work_order.created_by)&.email
        end
        row :created_at
        row :updated_at
      end
    end

    tab "费用明细" do
      panel "费用明细信息" do
        table_for resource.fee_detail_selections.includes(:fee_detail) do
          column "费用明细ID", :fee_detail_id do |sel|
            link_to sel.fee_detail_id, admin_fee_detail_path(sel.fee_detail)
          end
          column "费用类型", :fee_type do |sel|
            sel.fee_detail.fee_type
          end
          column "金额", :amount do |sel|
            number_to_currency(sel.fee_detail.amount, unit: "¥")
          end
          column "验证状态 (工单内)", :verification_status do |sel|
            status_tag sel.verification_status
          end
          column "验证状态 (全局)", :global_status do |sel|
            status_tag sel.fee_detail.verification_status
          end
          column "验证意见", :verification_comment
          column "操作" do |sel|
            links = []
            links << link_to("更新验证状态", verify_fee_detail_admin_audit_work_order_path(resource, fee_detail_id: sel.fee_detail_id))
            if resource.may_need_communication? && sel.verification_status != 'verified' && sel.verification_status != 'rejected'
              links << link_to("创建沟通工单", new_communication_admin_audit_work_order_path(resource, fee_detail_ids: [sel.fee_detail_id]))
            end
            links.join(" | ").html_safe
          end
        end
      end
    end

    tab "沟通工单" do
      panel "沟通工单信息" do
        table_for resource.communication_work_orders do
          column :id do |comm_wo|
            link_to comm_wo.id, admin_communication_work_order_path(comm_wo)
          end
          column :status do |comm_wo|
            status_tag comm_wo.status
          end
          column :communication_method
          column :initiator_role
          column :created_at
        end
      end
    end

    tab "状态变更历史" do
      panel "状态变更历史" do
        table_for resource.work_order_status_changes.order(changed_at: :desc) do
          column :from_status
          column :to_status
          column :changed_at
          column :changed_by do |change|
            AdminUser.find_by(id: change.changed_by)&.email
          end
        end
      end
    end
  end
end
```

### 6. 实现表单配置

在 `form` 块中实现表单配置：

```ruby
form do |f|
  f.inputs "审核工单信息" do
    f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }
    f.input :express_receipt_work_order_id, as: :select, collection: ExpressReceiptWorkOrder.all.map { |w| [w.id, w.id] }
    f.input :status, as: :select, collection: AuditWorkOrder.state_machines[:status].states.map(&:name)
    f.input :audit_result, as: :select, collection: ["approved", "rejected"]
    f.input :audit_comment
    f.input :audit_date, as: :datepicker
    f.input :vat_verified
  end
  f.actions
end
```

### 7. 创建自定义视图模板

创建以下视图模板：

1. `app/views/admin/audit_work_orders/approve.html.erb` - 审核通过表单
2. `app/views/admin/audit_work_orders/reject.html.erb` - 审核拒绝表单
3. `app/views/admin/audit_work_orders/new_communication.html.erb` - 创建沟通工单表单
4. `app/views/admin/audit_work_orders/verify_fee_detail.html.erb` - 费用明细验证表单

这些视图模板的具体实现将在 `4.2_自定义视图模板.md` 中详细说明。

## 关键实现点

1. **复杂状态转换操作**：
   - 实现多种状态转换操作，如开始处理、开始审核、审核通过、审核拒绝等
   - 使用服务层处理状态转换逻辑
   - 处理状态转换异常

2. **费用明细验证**：
   - 实现费用明细验证界面
   - 使用服务层处理费用明细验证逻辑
   - 显示费用明细的验证状态和验证意见

3. **沟通工单创建**：
   - 实现沟通工单创建界面
   - 允许选择关联的费用明细
   - 使用服务层处理沟通工单创建逻辑

4. **标签页展示**：
   - 使用标签页展示不同类型的信息，如基本信息、费用明细、沟通工单、状态变更历史
   - 提高用户界面的可用性和信息组织

5. **操作按钮条件显示**：
   - 根据工单状态显示或隐藏操作按钮
   - 使用 `may_*?` 方法检查状态转换是否可行

## 测试验证方法

1. 启动 Rails 服务器：`rails server`
2. 访问 ActiveAdmin 界面：`http://localhost:3000/admin/audit_work_orders`
3. 测试列表页、详情页、表单页的功能
4. 测试状态转换操作：
   - 创建一个状态为 "pending" 的工单
   - 点击"开始处理"按钮
   - 验证状态变为 "processing"
   - 点击"开始审核"按钮
   - 验证状态变为 "auditing"
   - 点击"审核通过"按钮，填写审核意见，提交
   - 验证状态变为 "approved"
   - 点击"完成"按钮
   - 验证状态变为 "completed"
5. 测试费用明细验证：
   - 在详情页的费用明细标签页中，点击"更新验证状态"
   - 选择验证状态，填写验证意见，提交
   - 验证费用明细状态已更新
6. 测试沟通工单创建：
   - 在详情页中，点击"需要沟通"按钮
   - 填写沟通信息，选择关联的费用明细，提交
   - 验证沟通工单已创建，审核工单状态变为 "needs_communication"

## 注意事项

1. 确保 AuditWorkOrder 模型已正确实现状态机
2. 确保 AuditWorkOrderService 和 FeeDetailVerificationService 已正确实现
3. 确保状态转换操作处理了所有可能的异常
4. 确保费用明细验证逻辑正确实现，特别是沟通工单解决后状态不自动更新
5. 确保沟通工单创建逻辑正确实现，包括费用明细关联
6. 考虑添加更多的过滤器和排序选项，提高用户体验
7. 考虑添加更多的批量操作，提高工作效率
8. 考虑添加权限控制，限制不同用户的操作权限
9. 确保状态转换操作的用户界面友好，提供清晰的反馈