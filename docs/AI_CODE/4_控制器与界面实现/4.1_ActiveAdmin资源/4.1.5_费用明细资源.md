# 费用明细 ActiveAdmin 资源实现

## 任务描述

实现费用明细的 ActiveAdmin 资源，包括列表页、详情页、表单页和验证状态更新操作。该资源将提供费用明细的管理界面，允许用户查看、创建、编辑费用明细，以及更新验证状态。

## 输入和依赖

- 基础模型（FeeDetail 及其关联模型）
- 服务层（FeeDetailVerificationService）
- ActiveAdmin 框架
- 控制器与界面设计文档 (`docs/refactoring/05_activeadmin_integration.md`)

## 期望输出

完整的费用明细 ActiveAdmin 资源实现，包括：
- 资源配置
- 列表页配置
- 详情页配置
- 表单页配置
- 验证状态更新操作
- 批量操作

## 详细实现步骤

### 1. 创建费用明细 ActiveAdmin 资源

创建 `app/admin/fee_details.rb` 文件，实现费用明细的 ActiveAdmin 资源：

```ruby
# app/admin/fee_details.rb
ActiveAdmin.register FeeDetail do
  # 权限控制
  permit_params :document_number, :fee_type, :amount, :currency, :fee_date, 
                :payment_method, :verification_status

  # 菜单设置
  menu priority: 5, label: "费用明细"

  # 过滤器
  filter :document_number, label: '报销单号'
  filter :fee_type, label: '费用类型'
  filter :amount, label: '金额'
  filter :fee_date, label: '费用日期'
  filter :verification_status, as: :select, 
         collection: ['pending', 'verified', 'rejected', 'problematic'], 
         label: '验证状态'
  filter :created_at, label: '创建时间'
  
  # 批量操作和自定义操作
  # ...
  
  # 列表页
  index do
    # ...
  end
  
  # 详情页
  show do
    # ...
  end
  
  # 表单
  form do |f|
    # ...
  end
end
```

### 2. 实现批量操作和自定义操作

添加批量操作和自定义操作：

```ruby
# 批量操作
batch_action :verify, confirm: "确定要将选中的费用明细标记为已验证吗？" do |ids|
  service = fee_detail_verification_service
  result = service.verify_fee_details(ids, 'verified', '批量验证')
  
  redirect_to collection_path, notice: "已验证 #{result[:success]} 个费用明细，失败 #{result[:failure]} 个。"
end

batch_action :reject, confirm: "确定要将选中的费用明细标记为已拒绝吗？" do |ids|
  service = fee_detail_verification_service
  result = service.verify_fee_details(ids, 'rejected', '批量拒绝')
  
  redirect_to collection_path, notice: "已拒绝 #{result[:success]} 个费用明细，失败 #{result[:failure]} 个。"
end

batch_action :mark_problematic, confirm: "确定要将选中的费用明细标记为有问题吗？" do |ids|
  service = fee_detail_verification_service
  result = service.verify_fee_details(ids, 'problematic', '批量标记为有问题')
  
  redirect_to collection_path, notice: "已标记 #{result[:success]} 个费用明细为有问题，失败 #{result[:failure]} 个。"
end

# 自定义操作
action_item :update_verification_status, only: :show do
  link_to "更新验证状态", update_verification_status_admin_fee_detail_path(resource)
end

# 自定义页面
member_action :update_verification_status, method: :get do
  render :update_verification_status
end

member_action :do_update_verification_status, method: :post do
  service = fee_detail_verification_service
  
  if service.update_verification_status(resource, params[:verification_status], params[:comment])
    redirect_to admin_fee_detail_path(resource), notice: "验证状态已更新为 #{params[:verification_status]}"
  else
    flash.now[:alert] = "更新验证状态失败: #{resource.errors.full_messages.join(', ')}"
    render :update_verification_status
  end
end
```

### 3. 实现列表页配置

在 `index` 块中实现列表页配置：

```ruby
index do
  selectable_column
  id_column
  column :document_number do |fee_detail|
    if fee_detail.reimbursement.present?
      link_to fee_detail.document_number, admin_reimbursement_path(fee_detail.reimbursement)
    else
      fee_detail.document_number
    end
  end
  column :fee_type
  column :amount do |fee_detail|
    number_to_currency(fee_detail.amount, unit: fee_detail.currency || "¥")
  end
  column :fee_date
  column :verification_status do |fee_detail|
    status_tag fee_detail.verification_status
  end
  column :created_at
  actions
end
```

### 4. 实现详情页配置

在 `show` 块中实现详情页配置，使用标签页展示不同类型的信息：

```ruby
show do
  tabs do
    tab "基本信息" do
      attributes_table do
        row :id
        row :document_number do |fee_detail|
          if fee_detail.reimbursement.present?
            link_to fee_detail.document_number, admin_reimbursement_path(fee_detail.reimbursement)
          else
            fee_detail.document_number
          end
        end
        row :fee_type
        row :amount do |fee_detail|
          number_to_currency(fee_detail.amount, unit: fee_detail.currency || "¥")
        end
        row :currency
        row :fee_date
        row :payment_method
        row :verification_status do |fee_detail|
          status_tag fee_detail.verification_status
        end
        row :created_at
        row :updated_at
      end
    end

    tab "验证历史" do
      panel "验证历史" do
        table_for fee_detail_verification_service.get_verification_history(resource) do
          column :id
          column :verification_status do |selection|
            status_tag selection.verification_status
          end
          column :verification_comment
          column :verified_by do |selection|
            AdminUser.find_by(id: selection.verified_by)&.email
          end
          column :verified_at
          column :work_order do |selection|
            if selection.audit_work_order.present?
              link_to "审核工单 ##{selection.audit_work_order_id}", admin_audit_work_order_path(selection.audit_work_order)
            elsif selection.communication_work_order.present?
              link_to "沟通工单 ##{selection.communication_work_order_id}", admin_communication_work_order_path(selection.communication_work_order)
            end
          end
        end
      end
    end

    tab "关联工单" do
      panel "关联的审核工单" do
        table_for resource.fee_detail_selections.includes(:audit_work_order).where.not(audit_work_order_id: nil) do |selection|
          column :audit_work_order_id do |sel|
            link_to sel.audit_work_order_id, admin_audit_work_order_path(sel.audit_work_order)
          end
          column :verification_status do |sel|
            status_tag sel.verification_status
          end
          column :verification_comment
          column :verified_at
        end
      end

      panel "关联的沟通工单" do
        table_for resource.fee_detail_selections.includes(:communication_work_order).where.not(communication_work_order_id: nil) do |selection|
          column :communication_work_order_id do |sel|
            link_to sel.communication_work_order_id, admin_communication_work_order_path(sel.communication_work_order)
          end
          column :verification_status do |sel|
            status_tag sel.verification_status
          end
          column :verification_comment
          column :verified_at
        end
      end
    end
  end
end
```

### 5. 实现表单配置

在 `form` 块中实现表单配置：

```ruby
form do |f|
  f.inputs "费用明细信息" do
    f.input :document_number, hint: "对应报销单的单号"
    f.input :fee_type
    f.input :amount
    f.input :currency, as: :select, collection: ["CNY", "USD", "EUR", "GBP", "JPY"]
    f.input :fee_date, as: :datepicker
    f.input :payment_method
    f.input :verification_status, as: :select, 
            collection: ['pending', 'verified', 'rejected', 'problematic']
  end
  f.actions
end
```

### 6. 创建自定义视图模板

创建 `app/views/admin/fee_details/update_verification_status.html.erb` 文件：

```erb
<% provide :title, "更新验证状态 - 费用明细 ##{@fee_detail.id}" %>
<h2>更新验证状态 - 费用明细 #<%= @fee_detail.id %></h2>

<%= semantic_form_for @fee_detail, url: do_update_verification_status_admin_fee_detail_path(@fee_detail), method: :post do |f| %>
  <%= f.inputs do %>
    <li class="string input optional">
      <label class="label">费用类型</label>
      <%= @fee_detail.fee_type %>
    </li>
    <li class="string input optional">
      <label class="label">金额</label>
      <%= number_to_currency(@fee_detail.amount, unit: @fee_detail.currency || "¥") %>
    </li>
    <li class="string input optional">
      <label class="label">当前验证状态</label>
      <%= status_tag @fee_detail.verification_status %>
    </li>
    <%= f.input :verification_status, as: :select, 
                collection: [["待验证", "pending"], ["已验证", "verified"], 
                            ["已拒绝", "rejected"], ["有问题", "problematic"]], 
                label: "设置验证状态", required: true, 
                selected: @fee_detail.verification_status %>
    <%= f.input :comment, as: :text, label: "验证意见", input_html: { rows: 3 } %>
  <% end %>
  <%= f.actions do %>
    <%= f.action :submit, label: "提交", button_html: { class: "button" } %>
    <%= f.action :cancel, label: "取消", wrapper_html: { class: 'cancel' }, 
                 button_html: { type: 'link', href: admin_fee_detail_path(@fee_detail) } %>
  <% end %>
<% end %>
```

### 7. 实现导入功能

添加导入功能：

```ruby
# 自定义操作
action_item :import, only: :index do
  link_to "导入费用明细", new_import_admin_fee_details_path
end

# 自定义页面
collection_action :new_import, method: :get do
  render "admin/fee_details/new_import"
end

collection_action :import, method: :post do
  service = fee_detail_import_service(params[:file])
  result = service.import
  
  if result[:success]
    redirect_to admin_fee_details_path, notice: "导入成功: #{result[:imported]} 导入, #{result[:unmatched]} 未匹配, #{result[:errors]} 错误."
  else
    redirect_to new_import_admin_fee_details_path, alert: "导入失败: #{result[:errors].join(', ')}"
  end
end
```

创建 `app/views/admin/fee_details/new_import.html.erb` 文件：

```erb
<h2>导入费用明细</h2>

<%= form_tag import_admin_fee_details_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择文件</th>
            <td><%= file_field_tag :file, accept: '.csv,.xlsx,.xls', required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_fee_details_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV或Excel文件应包含以下列：</p>
    <ul>
      <li>报销单单号（必填）</li>
      <li>费用类型（必填）</li>
      <li>原始金额（必填）</li>
      <li>币种</li>
      <li>费用发生日期</li>
      <li>支付方式</li>
    </ul>
    <p>注意：导入前必须先导入对应的报销单。</p>
  </div>
</div>
```

## 关键实现点

1. **验证状态管理**：
   - 实现验证状态更新操作
   - 使用服务层处理验证状态更新逻辑
   - 提供批量验证操作

2. **验证历史展示**：
   - 在详情页中展示验证历史
   - 显示每次验证的状态、意见、验证人和验证时间
   - 显示关联的工单信息

3. **关联工单展示**：
   - 在详情页中展示关联的审核工单和沟通工单
   - 提供链接跳转到相关工单

4. **导入功能**：
   - 实现费用明细导入功能
   - 使用服务层处理导入逻辑
   - 提供导入说明和错误处理

5. **状态标签**：
   - 使用 `status_tag` 显示验证状态
   - 根据状态自动应用不同的样式

## 测试验证方法

1. 启动 Rails 服务器：`rails server`
2. 访问 ActiveAdmin 界面：`http://localhost:3000/admin/fee_details`
3. 测试列表页、详情页、表单页的功能
4. 测试验证状态更新操作：
   - 在详情页中，点击"更新验证状态"按钮
   - 选择验证状态，填写验证意见，提交
   - 验证状态已更新
5. 测试批量操作：
   - 选择多个费用明细
   - 执行批量验证操作
   - 验证操作结果
6. 测试导入功能：
   - 点击"导入费用明细"按钮
   - 选择测试文件
   - 点击"导入"按钮
   - 验证导入结果

## 注意事项

1. 确保 FeeDetail 模型已正确实现
2. 确保 FeeDetailVerificationService 已正确实现
3. 确保验证状态更新操作处理了所有可能的异常
4. 确保导入功能正确处理了报销单存在性验证
5. 考虑添加更多的过滤器和排序选项，提高用户体验
6. 考虑添加更多的批量操作，提高工作效率
7. 考虑添加权限控制，限制不同用户的操作权限
8. 确保验证状态更新操作的用户界面友好，提供清晰的反馈