# 快递收单工单 ActiveAdmin 资源实现

## 任务描述

实现快递收单工单的 ActiveAdmin 资源，包括列表页、详情页、表单页和状态转换操作。该资源将提供快递收单工单的管理界面，允许用户查看、创建、编辑快递收单工单，以及执行状态转换操作。

## 输入和依赖

- 基础模型（ExpressReceiptWorkOrder 及其关联模型）
- 服务层（ExpressReceiptWorkOrderService）
- ActiveAdmin 框架
- 控制器与界面设计文档 (`docs/refactoring/05_activeadmin_integration.md`)

## 期望输出

完整的快递收单工单 ActiveAdmin 资源实现，包括：
- 资源配置
- 列表页配置
- 详情页配置
- 表单页配置
- 状态转换操作
- 批量操作

## 详细实现步骤

### 1. 创建快递收单工单 ActiveAdmin 资源

创建 `app/admin/express_receipt_work_orders.rb` 文件，实现快递收单工单的 ActiveAdmin 资源：

```ruby
# app/admin/express_receipt_work_orders.rb
ActiveAdmin.register ExpressReceiptWorkOrder do
  # 权限控制
  permit_params :reimbursement_id, :status, :tracking_number, :received_at, :courier_name, :created_by

  # 菜单设置
  menu priority: 2, label: "快递收单工单"

  # 过滤器
  filter :reimbursement_invoice_number, as: :string, label: '报销单号'
  filter :tracking_number
  filter :status, as: :select, collection: ExpressReceiptWorkOrder.state_machines[:status].states.map(&:name)
  filter :received_at
  filter :created_at
  
  # 批量操作和自定义操作
  # ...
  
  # 列表页
  index do
    # ...
  end
  
  # 详情页
  show do
    # ...
  end
  
  # 表单
  form do |f|
    # ...
  end
end
```

### 2. 实现批量操作和自定义操作

添加批量操作和自定义操作：

```ruby
# 批量操作
batch_action :process, if: proc { params[:scope] == 'received' || params[:q].blank? } do |ids|
  batch_action_collection.find(ids).each do |work_order|
    begin
      express_receipt_work_order_service(work_order).process
    rescue StateMachines::InvalidTransition => e
      Rails.logger.warn "批量处理快递收单工单 ##{work_order.id} 失败: #{e.message}"
    end
  end
  redirect_to collection_path, notice: "已尝试将选中的工单标记为已处理"
end

batch_action :complete, if: proc { params[:scope] == 'processed' || params[:q].blank? } do |ids|
  batch_action_collection.find(ids).each do |work_order|
    begin
      express_receipt_work_order_service(work_order).complete
    rescue StateMachines::InvalidTransition => e
      Rails.logger.warn "批量完成快递收单工单 ##{work_order.id} 失败: #{e.message}"
    end
  end
  redirect_to collection_path, notice: "已尝试将选中的工单标记为已完成"
end

# 自定义操作
action_item :process, only: :show, if: proc { resource.may_process? } do
  link_to "处理", process_admin_express_receipt_work_order_path(resource), method: :put
end

action_item :complete, only: :show, if: proc { resource.may_complete? } do
  link_to "完成", complete_admin_express_receipt_work_order_path(resource), method: :put
end

# 自定义页面
member_action :process, method: :put do
  service = express_receipt_work_order_service(resource)
  begin
    if service.process
      redirect_to admin_express_receipt_work_order_path(resource), notice: "工单已处理"
    else
      redirect_to admin_express_receipt_work_order_path(resource), alert: "操作失败: #{resource.errors.full_messages.join(', ')}"
    end
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_express_receipt_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end

member_action :complete, method: :put do
  service = express_receipt_work_order_service(resource)
  begin
    if service.complete
      redirect_to admin_express_receipt_work_order_path(resource), notice: "工单已完成，并已创建审核工单"
    else
      redirect_to admin_express_receipt_work_order_path(resource), alert: "操作失败: #{resource.errors.full_messages.join(', ')}"
    end
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_express_receipt_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end
```

### 3. 实现列表页配置

在 `index` 块中实现列表页配置：

```ruby
index do
  selectable_column
  id_column
  column :reimbursement do |work_order|
    link_to work_order.reimbursement.invoice_number, admin_reimbursement_path(work_order.reimbursement)
  end
  column :tracking_number
  column :status do |work_order|
    status_tag work_order.status
  end
  column :received_at
  column :courier_name
  column :created_at
  actions
end
```

### 4. 实现详情页配置

在 `show` 块中实现详情页配置：

```ruby
show do
  attributes_table do
    row :id
    row :reimbursement do |work_order|
      link_to work_order.reimbursement.invoice_number, admin_reimbursement_path(work_order.reimbursement)
    end
    row :tracking_number
    row :status do |work_order|
      status_tag work_order.status
    end
    row :received_at
    row :courier_name
    row :created_by
    row :created_at
    row :updated_at
  end

  panel "状态变更历史" do
    table_for resource.work_order_status_changes.order(changed_at: :desc) do
      column :from_status
      column :to_status
      column :changed_at
      column :changed_by do |change|
        AdminUser.find_by(id: change.changed_by)&.email
      end
    end
  end

  panel "关联的审核工单" do
    if resource.audit_work_order.present?
      attributes_table_for resource.audit_work_order do
        row :id do |audit_wo|
          link_to audit_wo.id, admin_audit_work_order_path(audit_wo)
        end
        row :status do |audit_wo|
          status_tag audit_wo.status
        end
        row :created_at
      end
    else
      para "暂无关联的审核工单"
    end
  end
end
```

### 5. 实现表单配置

在 `form` 块中实现表单配置：

```ruby
form do |f|
  f.inputs "快递收单工单信息" do
    f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }
    f.input :status, as: :select, collection: ExpressReceiptWorkOrder.state_machines[:status].states.map(&:name)
    f.input :tracking_number
    f.input :received_at, as: :datepicker
    f.input :courier_name
  end
  f.actions
end
```

## 关键实现点

1. **状态转换操作**：
   - 使用 `member_action` 定义状态转换操作
   - 使用服务层处理状态转换逻辑
   - 处理状态转换异常

2. **批量操作**：
   - 使用 `batch_action` 定义批量操作
   - 使用条件限制批量操作的可用性
   - 处理批量操作中的异常

3. **自定义操作按钮**：
   - 使用 `action_item` 定义自定义操作按钮
   - 使用条件限制按钮的可见性
   - 链接到相应的 `member_action`

4. **关联数据展示**：
   - 在详情页中展示状态变更历史
   - 在详情页中展示关联的审核工单
   - 使用链接连接到相关资源

5. **状态标签**：
   - 使用 `status_tag` 显示状态标签
   - 根据状态自动应用不同的样式

## 测试验证方法

1. 启动 Rails 服务器：`rails server`
2. 访问 ActiveAdmin 界面：`http://localhost:3000/admin/express_receipt_work_orders`
3. 测试列表页、详情页、表单页的功能
4. 测试状态转换操作：
   - 创建一个状态为 "received" 的工单
   - 点击"处理"按钮
   - 验证状态变为 "processed"
   - 点击"完成"按钮
   - 验证状态变为 "completed"
   - 验证创建了审核工单
5. 测试批量操作：
   - 选择多个工单
   - 执行批量操作
   - 验证操作结果

## 注意事项

1. 确保 ExpressReceiptWorkOrder 模型已正确实现状态机
2. 确保 ExpressReceiptWorkOrderService 已正确实现
3. 确保状态转换操作处理了所有可能的异常
4. 考虑添加更多的过滤器和排序选项，提高用户体验
5. 考虑添加更多的批量操作，提高工作效率
6. 考虑添加权限控制，限制不同用户的操作权限
7. 考虑添加更多的自定义操作，满足特定业务需求
8. 确保状态转换操作的用户界面友好，提供清晰的反馈