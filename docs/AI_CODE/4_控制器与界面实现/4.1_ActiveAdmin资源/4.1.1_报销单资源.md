# 报销单 ActiveAdmin 资源实现

## 任务描述

实现报销单的 ActiveAdmin 资源，包括列表页、详情页、表单页和导入功能。该资源将提供报销单的管理界面，允许用户查看、创建、编辑和导入报销单数据。

## 输入和依赖

- 基础模型（Reimbursement 及其关联模型）
- 服务层（ReimbursementImportService）
- ActiveAdmin 框架
- 控制器与界面设计文档 (`docs/refactoring/05_activeadmin_integration.md`)

## 期望输出

完整的报销单 ActiveAdmin 资源实现，包括：
- 资源配置
- 列表页配置
- 详情页配置
- 表单页配置
- 导入功能
- 批量操作
- 自定义视图模板

## 详细实现步骤

### 1. 创建报销单 ActiveAdmin 资源

创建 `app/admin/reimbursements.rb` 文件，实现报销单的 ActiveAdmin 资源：

```ruby
# app/admin/reimbursements.rb
ActiveAdmin.register Reimbursement do
  # 权限控制
  permit_params :invoice_number, :document_name, :applicant, :applicant_id, :company, :department,
                :amount, :receipt_status, :reimbursement_status, :receipt_date, :submission_date,
                :is_electronic, :is_complete

  # 菜单设置
  menu priority: 1, label: "报销单管理"

  # 过滤器
  filter :invoice_number
  filter :applicant
  filter :company
  filter :department
  filter :receipt_status, as: :select, collection: ["pending", "received"]
  filter :reimbursement_status, as: :select, collection: ["pending", "processing", "closed"]
  filter :is_electronic, as: :boolean
  filter :is_complete, as: :boolean
  filter :created_at

  # 批量操作
  batch_action :mark_as_received do |ids|
    # 实现批量标记为已收单的逻辑
  end

  # 自定义操作
  action_item :import, only: :index do
    link_to "导入报销单", new_import_admin_reimbursements_path
  end

  # 自定义页面
  collection_action :new_import, method: :get do
    render "admin/reimbursements/new_import"
  end

  collection_action :import, method: :post do
    # 调用导入服务
    service = reimbursement_import_service(params[:file])
    result = service.import
    
    # 处理导入结果
    # ...
  end

  # 列表页
  index do
    # 实现列表页配置
    # ...
  end

  # 详情页
  show do
    # 实现详情页配置
    # ...
  end

  # 表单
  form do |f|
    # 实现表单配置
    # ...
  end
end
```

### 2. 实现列表页配置

在 `index` 块中实现列表页配置：

```ruby
index do
  selectable_column
  id_column
  column :invoice_number
  column :applicant
  column :amount do |reimbursement|
    number_to_currency(reimbursement.amount, unit: "¥")
  end
  column :receipt_status do |reimbursement|
    status_tag reimbursement.receipt_status
  end
  column :reimbursement_status do |reimbursement|
    status_tag reimbursement.reimbursement_status
  end
  column :is_electronic
  column :is_complete
  column :created_at
  actions
end
```

### 3. 实现详情页配置

在 `show` 块中实现详情页配置，使用标签页展示不同类型的信息：

```ruby
show do
  tabs do
    tab "基本信息" do
      attributes_table do
        row :invoice_number
        row :document_name
        row :applicant
        row :applicant_id
        row :company
        row :department
        row :amount do |reimbursement|
          number_to_currency(reimbursement.amount, unit: "¥")
        end
        row :receipt_status
        row :reimbursement_status
        row :receipt_date
        row :submission_date
        row :is_electronic
        row :is_complete
        row :created_at
        row :updated_at
      end
    end

    tab "快递收单工单" do
      # 显示关联的快递收单工单
      # ...
    end

    tab "审核工单" do
      # 显示关联的审核工单
      # ...
    end

    tab "沟通工单" do
      # 显示关联的沟通工单
      # ...
    end

    tab "费用明细" do
      # 显示关联的费用明细
      # ...
    end
  end
end
```

### 4. 实现表单配置

在 `form` 块中实现表单配置：

```ruby
form do |f|
  f.inputs "报销单信息" do
    f.input :invoice_number
    f.input :document_name
    f.input :applicant
    f.input :applicant_id
    f.input :company
    f.input :department
    f.input :amount
    f.input :receipt_status, as: :select, collection: ["pending", "received"]
    f.input :reimbursement_status, as: :select, collection: ["pending", "processing", "closed"]
    f.input :receipt_date, as: :datepicker
    f.input :submission_date, as: :datepicker
    f.input :is_electronic
    f.input :is_complete
  end
  f.actions
end
```

### 5. 实现批量操作

完善批量操作的实现：

```ruby
batch_action :mark_as_received do |ids|
  batch_action_collection.find(ids).each do |reimbursement|
    reimbursement.mark_as_received
  end
  redirect_to collection_path, notice: "已将选中的报销单标记为已收单"
end
```

### 6. 实现导入功能

完善导入功能的实现：

```ruby
collection_action :import, method: :post do
  service = reimbursement_import_service(params[:file])
  result = service.import
  
  if result[:success]
    redirect_to admin_reimbursements_path, notice: "导入成功: #{result[:created]} 创建, #{result[:updated]} 更新, #{result[:errors]} 错误."
  else
    redirect_to new_import_admin_reimbursements_path, alert: "导入失败: #{result[:errors].join(', ')}"
  end
end
```

### 7. 创建导入视图模板

创建 `app/views/admin/reimbursements/new_import.html.erb` 文件：

```erb
<h2>导入报销单</h2>

<%= form_tag import_admin_reimbursements_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择文件</th>
            <td><%= file_field_tag :file, accept: '.csv,.xlsx,.xls', required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_reimbursements_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV或Excel文件应包含以下列：</p>
    <ul>
      <li>报销单单号（必填）</li>
      <li>单据名称</li>
      <li>报销单申请人</li>
      <li>报销单申请人工号</li>
      <li>申请人公司</li>
      <li>申请人部门</li>
      <li>报销金额（单据币种）</li>
      <li>收单状态</li>
      <li>报销单状态</li>
      <li>收单日期</li>
      <li>提交报销日期</li>
      <li>单据标签</li>
    </ul>
  </div>
</div>
```

## 关键实现点

1. **资源配置**：
   - 使用 `permit_params` 定义允许的参数
   - 使用 `menu` 设置菜单位置和标签
   - 使用 `filter` 定义过滤器

2. **列表页配置**：
   - 使用 `index` 块定义列表页
   - 使用 `column` 定义显示的列
   - 使用 `status_tag` 显示状态标签

3. **详情页配置**：
   - 使用 `show` 块定义详情页
   - 使用 `tabs` 创建标签页
   - 使用 `attributes_table` 显示属性表格
   - 使用 `panel` 和 `table_for` 显示关联数据

4. **表单配置**：
   - 使用 `form` 块定义表单
   - 使用 `inputs` 分组表单字段
   - 使用 `input` 定义表单字段

5. **批量操作**：
   - 使用 `batch_action` 定义批量操作
   - 使用 `batch_action_collection` 获取选中的记录

6. **自定义操作**：
   - 使用 `action_item` 定义自定义操作按钮
   - 使用 `collection_action` 定义自定义集合操作
   - 使用 `member_action` 定义自定义成员操作

7. **导入功能**：
   - 使用 `collection_action` 定义导入操作
   - 使用服务注册模块获取导入服务
   - 使用 `form_tag` 创建导入表单

## 测试验证方法

1. 启动 Rails 服务器：`rails server`
2. 访问 ActiveAdmin 界面：`http://localhost:3000/admin/reimbursements`
3. 测试列表页、详情页、表单页的功能
4. 测试导入功能：
   - 点击"导入报销单"按钮
   - 选择测试文件
   - 点击"导入"按钮
   - 验证导入结果
5. 测试批量操作：
   - 选择多个报销单
   - 执行批量操作
   - 验证操作结果

## 注意事项

1. 确保 ActiveAdmin 正确安装和配置
2. 确保 Reimbursement 模型已正确实现
3. 确保 ReimbursementImportService 已正确实现
4. 确保导入视图模板路径正确
5. 考虑添加更多的过滤器和排序选项，提高用户体验
6. 考虑添加更多的批量操作，提高工作效率
7. 考虑添加权限控制，限制不同用户的操作权限
8. 考虑添加更多的自定义操作，满足特定业务需求