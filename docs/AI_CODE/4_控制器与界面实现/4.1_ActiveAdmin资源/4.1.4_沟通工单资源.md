# 沟通工单 ActiveAdmin 资源实现

## 任务描述

实现沟通工单的 ActiveAdmin 资源，包括列表页、详情页、表单页和状态转换操作。该资源将提供沟通工单的管理界面，允许用户查看、创建、编辑沟通工单，以及执行状态转换操作、添加沟通记录和解决费用明细问题等功能。

## 输入和依赖

- 基础模型（CommunicationWorkOrder 及其关联模型）
- 服务层（CommunicationWorkOrderService）
- ActiveAdmin 框架
- 控制器与界面设计文档 (`docs/refactoring/05_activeadmin_integration.md`)

## 期望输出

完整的沟通工单 ActiveAdmin 资源实现，包括：
- 资源配置
- 列表页配置
- 详情页配置
- 表单页配置
- 状态转换操作
- 沟通记录添加界面
- 费用明细问题解决界面

## 详细实现步骤

### 1. 创建沟通工单 ActiveAdmin 资源

创建 `app/admin/communication_work_orders.rb` 文件，实现沟通工单的 ActiveAdmin 资源：

```ruby
# app/admin/communication_work_orders.rb
ActiveAdmin.register CommunicationWorkOrder do
  # 权限控制
  permit_params :reimbursement_id, :audit_work_order_id, :status, :communication_method,
                :initiator_role, :resolution_summary, :created_by

  # 菜单设置
  menu priority: 4, label: "沟通工单"

  # 过滤器
  filter :reimbursement_invoice_number, as: :string, label: '报销单号'
  filter :audit_work_order_id
  filter :status, as: :select, collection: CommunicationWorkOrder.state_machines[:status].states.map(&:name)
  filter :communication_method
  filter :initiator_role
  filter :created_at
  
  # 自定义操作
  # ...
  
  # 列表页
  index do
    # ...
  end
  
  # 详情页
  show do
    # ...
  end
  
  # 表单
  form do |f|
    # ...
  end
end
```

### 2. 实现自定义操作

添加自定义操作：

```ruby
# 自定义操作
action_item :start_communication, only: :show, if: proc { resource.may_start_communication? } do
  link_to "开始沟通", start_communication_admin_communication_work_order_path(resource), method: :put
end

action_item :add_communication_record, only: :show, if: proc { resource.status == 'in_progress' } do
  link_to "添加沟通记录", new_communication_record_admin_communication_work_order_path(resource)
end

action_item :resolve, only: :show, if: proc { resource.may_resolve? } do
  link_to "标记已解决", resolve_admin_communication_work_order_path(resource)
end

action_item :mark_unresolved, only: :show, if: proc { resource.may_mark_unresolved? } do
  link_to "标记未解决", mark_unresolved_admin_communication_work_order_path(resource)
end

action_item :close, only: :show, if: proc { resource.may_close? } do
  link_to "关闭", close_admin_communication_work_order_path(resource), method: :put
end

# 自定义页面
member_action :start_communication, method: :put do
  service = communication_work_order_service(resource)
  begin
    service.start_communication
    redirect_to admin_communication_work_order_path(resource), notice: "工单已开始沟通"
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_communication_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end

member_action :new_communication_record, method: :get do
  # 渲染添加沟通记录表单
  render :new_communication_record
end

member_action :create_communication_record, method: :post do
  service = communication_work_order_service(resource)
  communication_record = service.add_communication_record(params.require(:communication_record).permit(:content, :communicator_role, :communicator_name, :communication_method))

  if communication_record.persisted?
    redirect_to admin_communication_work_order_path(resource), notice: "沟通记录已添加"
  else
    flash.now[:alert] = "添加沟通记录失败: #{communication_record.errors.full_messages.join(', ')}"
    render :new_communication_record
  end
end

member_action :resolve, method: :get do
  # 渲染解决表单
  render :resolve
end

member_action :do_resolve, method: :post do
  service = communication_work_order_service(resource)
  begin
    if service.resolve(params[:resolution_summary])
      redirect_to admin_communication_work_order_path(resource), notice: "工单已标记为已解决"
    else
      flash.now[:alert] = "操作失败"
      render :resolve
    end
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_communication_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end

member_action :mark_unresolved, method: :get do
  # 渲染未解决表单
  render :mark_unresolved
end

member_action :do_mark_unresolved, method: :post do
  service = communication_work_order_service(resource)
  begin
    if service.mark_unresolved(params[:resolution_summary])
      redirect_to admin_communication_work_order_path(resource), notice: "工单已标记为未解决"
    else
      flash.now[:alert] = "操作失败"
      render :mark_unresolved
    end
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_communication_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end

member_action :close, method: :put do
  service = communication_work_order_service(resource)
  begin
    service.close
    redirect_to admin_communication_work_order_path(resource), notice: "工单已关闭"
  rescue StateMachines::InvalidTransition => e
    redirect_to admin_communication_work_order_path(resource), alert: "状态转换失败: #{e.message}"
  end
end

# 费用明细问题解决操作
member_action :resolve_fee_detail_issue, method: :get do
  @fee_detail = FeeDetail.find(params[:fee_detail_id])
  # 渲染费用明细问题解决表单
  render :resolve_fee_detail_issue
end

member_action :do_resolve_fee_detail_issue, method: :post do
  service = communication_work_order_service(resource)
  if service.resolve_fee_detail_issue(params[:fee_detail_id], params[:resolution])
    redirect_to admin_communication_work_order_path(resource), notice: "费用明细 ##{params[:fee_detail_id]} 问题备注已更新"
  else
    @fee_detail = FeeDetail.find(params[:fee_detail_id])
    flash.now[:alert] = "更新费用明细备注失败"
    render :resolve_fee_detail_issue
  end
end
```

### 3. 实现列表页配置

在 `index` 块中实现列表页配置：

```ruby
index do
  selectable_column
  id_column
  column :reimbursement do |work_order|
    link_to work_order.reimbursement.invoice_number, admin_reimbursement_path(work_order.reimbursement)
  end
  column :audit_work_order do |work_order|
    link_to work_order.audit_work_order.id, admin_audit_work_order_path(work_order.audit_work_order)
  end
  column :status do |work_order|
    status_tag work_order.status
  end
  column :communication_method
  column :initiator_role
  column :created_at
  actions
end
```

### 4. 实现详情页配置

在 `show` 块中实现详情页配置，使用标签页展示不同类型的信息：

```ruby
show do
  tabs do
    tab "基本信息" do
      attributes_table do
        row :id
        row :reimbursement do |work_order|
          link_to work_order.reimbursement.invoice_number, admin_reimbursement_path(work_order.reimbursement)
        end
        row :audit_work_order do |work_order|
          link_to work_order.audit_work_order.id, admin_audit_work_order_path(work_order.audit_work_order)
        end
        row :status do |work_order|
          status_tag work_order.status
        end
        row :communication_method
        row :initiator_role
        row :resolution_summary
        row :created_by do |work_order|
          AdminUser.find_by(id: work_order.created_by)&.email
        end
        row :created_at
        row :updated_at
      end
    end

    tab "沟通记录" do
      panel "沟通记录" do
        table_for resource.communication_records.order(recorded_at: :desc) do
          column :id
          column :communicator_role
          column :communicator_name
          column :communication_method
          column :content
          column :recorded_at
        end
      end
    end

    tab "关联费用明细" do
      panel "费用明细信息" do
        table_for resource.fee_detail_selections.includes(:fee_detail) do
          column "费用明细ID", :fee_detail_id do |sel|
            link_to sel.fee_detail_id, admin_fee_detail_path(sel.fee_detail)
          end
          column "费用类型", :fee_type do |sel|
            sel.fee_detail.fee_type
          end
          column "金额", :amount do |sel|
            number_to_currency(sel.fee_detail.amount, unit: "¥")
          end
          column "验证状态 (工单内)", :verification_status do |sel|
            status_tag sel.verification_status
          end
          column "验证状态 (全局)", :global_status do |sel|
            status_tag sel.fee_detail.verification_status
          end
          column "验证意见", :verification_comment
          column "操作" do |sel|
            link_to "添加/更新解决备注", resolve_fee_detail_issue_admin_communication_work_order_path(resource, fee_detail_id: sel.fee_detail_id)
          end
        end
      end
    end

    tab "状态变更历史" do
      panel "状态变更历史" do
        table_for resource.work_order_status_changes.order(changed_at: :desc) do
          column :from_status
          column :to_status
          column :changed_at
          column :changed_by do |change|
            AdminUser.find_by(id: change.changed_by)&.email
          end
        end
      end
    end
  end
end
```

### 5. 实现表单配置

在 `form` 块中实现表单配置：

```ruby
form do |f|
  f.inputs "沟通工单信息" do
    f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }
    f.input :audit_work_order_id, as: :select, collection: AuditWorkOrder.all.map { |w| [w.id, w.id] }
    f.input :status, as: :select, collection: CommunicationWorkOrder.state_machines[:status].states.map(&:name)
    f.input :communication_method, as: :select, collection: ["email", "phone", "system", "other"]
    f.input :initiator_role, as: :select, collection: ["auditor", "applicant", "manager", "other"]
    f.input :resolution_summary
  end
  f.actions
end
```

### 6. 创建自定义视图模板

创建以下视图模板：

1. `app/views/admin/communication_work_orders/new_communication_record.html.erb` - 添加沟通记录表单
2. `app/views/admin/communication_work_orders/resolve.html.erb` - 解决表单
3. `app/views/admin/communication_work_orders/mark_unresolved.html.erb` - 未解决表单
4. `app/views/admin/communication_work_orders/resolve_fee_detail_issue.html.erb` - 费用明细问题解决表单

这些视图模板的具体实现将在 `4.2_自定义视图模板.md` 中详细说明。

## 关键实现点

1. **状态转换操作**：
   - 实现多种状态转换操作，如开始沟通、解决、标记未解决、关闭等
   - 使用服务层处理状态转换逻辑
   - 处理状态转换异常

2. **沟通记录管理**：
   - 实现沟通记录添加界面
   - 在详情页中展示沟通记录列表
   - 使用服务层处理沟通记录添加逻辑

3. **费用明细问题解决**：
   - 实现费用明细问题解决界面
   - 允许更新费用明细问题的解决备注
   - 使用服务层处理费用明细问题解决逻辑

4. **标签页展示**：
   - 使用标签页展示不同类型的信息，如基本信息、沟通记录、关联费用明细、状态变更历史
   - 提高用户界面的可用性和信息组织

5. **操作按钮条件显示**：
   - 根据工单状态显示或隐藏操作按钮
   - 使用 `may_*?` 方法检查状态转换是否可行

## 测试验证方法

1. 启动 Rails 服务器：`rails server`
2. 访问 ActiveAdmin 界面：`http://localhost:3000/admin/communication_work_orders`
3. 测试列表页、详情页、表单页的功能
4. 测试状态转换操作：
   - 创建一个状态为 "open" 的工单
   - 点击"开始沟通"按钮
   - 验证状态变为 "in_progress"
   - 点击"添加沟通记录"按钮，填写沟通记录，提交
   - 验证沟通记录已添加
   - 点击"标记已解决"按钮，填写解决摘要，提交
   - 验证状态变为 "resolved"
   - 点击"关闭"按钮
   - 验证状态变为 "closed"
5. 测试费用明细问题解决：
   - 在详情页的关联费用明细标签页中，点击"添加/更新解决备注"
   - 填写解决备注，提交
   - 验证费用明细问题备注已更新

## 注意事项

1. 确保 CommunicationWorkOrder 模型已正确实现状态机
2. 确保 CommunicationWorkOrderService 已正确实现
3. 确保状态转换操作处理了所有可能的异常
4. 确保沟通记录添加逻辑正确实现
5. 确保费用明细问题解决逻辑正确实现，特别是不自动更新费用明细状态
6. 考虑添加更多的过滤器和排序选项，提高用户体验
7. 考虑添加批量操作，提高工作效率
8. 考虑添加权限控制，限制不同用户的操作权限
9. 确保状态转换操作的用户界面友好，提供清晰的反馈