# 项目结构设置

## 任务描述

设置 SCI2 工单系统重构项目的基础结构，包括确认 Rails 版本和依赖、设置数据库配置、配置 ActiveAdmin 和设置 state_machines 状态机。

## 输入和依赖

- Rails 项目框架
- Ruby 3.0.0+ 和 Rails 7.0+
- 项目需求文档

## 期望输出

配置好的项目结构，包括：
- 正确配置的 Gemfile
- 数据库配置文件
- ActiveAdmin 初始化配置
- state_machines 状态机配置

## 详细实现步骤

### 1. 确认 Rails 版本和依赖

检查并更新 Gemfile，确保包含以下依赖：

```ruby
source 'https://rubygems.org'
git_source(:github) { |repo| "https://github.com/#{repo}.git" }

ruby '3.4.2'

# Rails core
gem 'rails', '~>7.1.5.1'
gem 'sqlite3', '~> 1.4'  # 开发环境使用 sqlite
gem 'puma', '~> 5.0'
gem 'bootsnap', '>= 1.4.4', require: false

# 前端
gem 'importmap-rails'
gem 'turbo-rails'
gem 'stimulus-rails'
gem 'jbuilder'

# ActiveAdmin
gem 'activeadmin'
gem 'devise'  # ActiveAdmin 依赖
gem 'sassc-rails'  # ActiveAdmin 依赖
gem 'kaminari'  # 分页

# 状态机
gem 'state_machines-activerecord'  # 状态机

# CSV/Excel 处理
gem 'roo'  # Excel 文件处理

group :development, :test do
  gem 'byebug', platforms: [:mri, :mingw, :x64_mingw]
  gem 'rspec-rails'
  gem 'factory_bot_rails'
  gem 'faker'
end

group :development do
  gem 'web-console', '>= 4.1.0'
  gem 'rack-mini-profiler', '~> 2.0'
  gem 'listen', '~> 3.3'
  gem 'spring'
end

group :test do
  gem 'capybara', '>= 3.26'
  gem 'selenium-webdriver'
  gem 'webdrivers'
  gem 'shoulda-matchers'
  gem 'database_cleaner-active_record'
end
```

运行 `bundle install` 安装依赖。

### 2. 设置数据库配置

编辑 `config/database.yml` 文件：

```yaml
default: &default
  adapter: sqlite3
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  timeout: 5000

development:
  <<: *default
  database: db/sci2_development.sqlite3

test:
  <<: *default
  database: db/sci2_test.sqlite3

production:
  <<: *default
  database: db/sci2_production.sqlite3
```

### 3. 配置 ActiveAdmin

安装 ActiveAdmin：

```bash
rails g active_admin:install
```

编辑 `config/initializers/active_admin.rb` 文件，进行以下配置：

```ruby
ActiveAdmin.setup do |config|
  # 设置站点标题
  config.site_title = "SCI2工单系统"

  # 设置默认命名空间
  config.default_namespace = :admin

  # 设置根路径
  config.root_to = 'dashboard#index'

  # 启用批量操作
  config.batch_actions = true

  # 设置每页显示记录数
  config.default_per_page = 30

  # 设置CSV下载选项
  config.csv_options = { col_sep: ',', force_quotes: true }

  # 设置过滤器位置
  config.filters_position = :right

  # 设置注释
  config.comments = false
end
```

### 4. 设置 RSpec 测试框架

安装 RSpec：

```bash
rails g rspec:install
```

配置 RSpec，编辑 `.rspec` 文件：

```
--require spec_helper
--format documentation
--color
```

配置 shoulda-matchers，编辑 `spec/rails_helper.rb` 文件，添加：

```ruby
Shoulda::Matchers.configure do |config|
  config.integrate do |with|
    with.test_framework :rspec
    with.library :rails
  end
end
```

### 5. 创建 Current 类

创建 `app/models/current.rb` 文件，用于存储当前用户信息：

```ruby
class Current < ActiveSupport::CurrentAttributes
  attribute :admin_user
end
```

### 6. 创建 ServiceRegistry 模块

创建 `app/services/service_registry.rb` 文件，用于注册服务：

```ruby
module ServiceRegistry
  def reimbursement_import_service(file = nil)
    @reimbursement_import_service ||= ReimbursementImportService.new(file, current_admin_user)
  end

  def express_receipt_import_service(file = nil)
    @express_receipt_import_service ||= ExpressReceiptImportService.new(file, current_admin_user)
  end

  def fee_detail_import_service(file = nil)
    @fee_detail_import_service ||= FeeDetailImportService.new(file, current_admin_user)
  end

  def operation_history_import_service(file = nil)
    @operation_history_import_service ||= OperationHistoryImportService.new(file, current_admin_user)
  end

  def audit_work_order_service(work_order)
    AuditWorkOrderService.new(work_order, current_admin_user)
  end

  def communication_work_order_service(work_order)
    CommunicationWorkOrderService.new(work_order, current_admin_user)
  end

  def express_receipt_work_order_service(work_order)
    ExpressReceiptWorkOrderService.new(work_order, current_admin_user)
  end

  def fee_detail_verification_service
    @fee_detail_verification_service ||= FeeDetailVerificationService.new(current_admin_user)
  end

  def work_order_status_change_service
    @work_order_status_change_service ||= WorkOrderStatusChangeService.new(current_admin_user)
  end
end
```

### 7. 创建服务目录结构

创建以下目录结构：

```bash
mkdir -p app/services
```

### 8. 配置 ApplicationController

编辑 `app/controllers/application_controller.rb` 文件，引入 ServiceRegistry：

```ruby
class ApplicationController < ActionController::Base
  include ServiceRegistry

  before_action :set_current_admin_user

  private

  def set_current_admin_user
    Current.admin_user = current_admin_user if defined?(current_admin_user)
  end
end
```

## 测试验证方法

1. 运行 `bundle install` 确保所有依赖安装成功
2. 运行 `rails db:create` 创建数据库
3. 运行 `rails db:migrate` 执行初始迁移
4. 运行 `rails server` 启动服务器
5. 访问 `http://localhost:3000/admin` 确认 ActiveAdmin 配置正确
6. 运行 `rspec` 确认 RSpec 配置正确

## 注意事项

1. 确保 Ruby 和 Rails 版本符合要求
2. 确保所有依赖都正确安装
3. 确保 ActiveAdmin 配置正确
4. 确保 state_machines 状态机配置正确
5. 确保 RSpec 测试框架配置正确
6. 确保 ServiceRegistry 模块配置正确，以便后续服务实现