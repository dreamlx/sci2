# 项目结构设置

## 任务描述

设置 SCI2 工单系统重构项目的基础结构，包括确认 Rails 版本和依赖、设置数据库配置、配置 ActiveAdmin 和设置 AASM 状态机。

## 输入和依赖

- Rails 项目框架
- Ruby 3.0.0+ 和 Rails 7.0+
- 项目需求文档

## 期望输出

配置好的项目结构，包括：
- 正确配置的 Gemfile
- 数据库配置文件
- ActiveAdmin 初始化配置
- AASM 状态机配置

## 详细实现步骤

### 1. 确认 Rails 版本和依赖

检查并更新 Gemfile，确保包含以下依赖：

```ruby
source 'https://rubygems.org'
git_source(:github) { |repo| "https://github.com/#{repo}.git" }

ruby '3.0.0'  # 或更高版本

# Rails 核心
gem 'rails', '~> 7.0.0'  # 或指定的版本
gem 'sqlite3', '~> 1.4'  # 开发环境使用 sqlite
gem 'puma', '~> 5.0'
gem 'bootsnap', '>= 1.4.4', require: false

# 前端
gem 'importmap-rails'
gem 'turbo-rails'
gem 'stimulus-rails'
gem 'jbuilder'

# ActiveAdmin
gem 'activeadmin'
gem 'devise'  # ActiveAdmin 依赖
gem 'sassc-rails'  # ActiveAdmin 依赖
gem 'kaminari'  # 分页

# 状态机
gem 'aasm'  # 状态机

# CSV 处理
gem 'csv'

group :development, :test do
  gem 'byebug', platforms: [:mri, :mingw, :x64_mingw]
  gem 'rspec-rails'
  gem 'factory_bot_rails'
end

group :development do
  gem 'web-console', '>= 4.1.0'
  gem 'rack-mini-profiler', '~> 2.0'
  gem 'listen', '~> 3.3'
  gem 'spring'
end

group :test do
  gem 'capybara', '>= 3.26'
  gem 'selenium-webdriver'
  gem 'webdrivers'
end
```

运行 `bundle install` 安装依赖。

### 2. 设置数据库配置

编辑 `config/database.yml` 文件：

```yaml
default: &default
  adapter: sqlite3
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  timeout: 5000

development:
  <<: *default
  database: db/sci2_development.sqlite3

test:
  <<: *default
  database: db/sci2_test.sqlite3

production:
  <<: *default
  database: db/sci2_production.sqlite3
```

### 3. 配置 ActiveAdmin

安装 ActiveAdmin：

```bash
rails g active_admin:install
```

编辑 `config/initializers/active_admin.rb` 文件，进行以下配置：

```ruby
ActiveAdmin.setup do |config|
  # 设置站点标题
  config.site_title = "SCI2工单系统"
  
  # 设置默认命名空间
  config.default_namespace = :admin
  
  # 设置根路径
  config.root_to = 'dashboard#index'
  
  # 启用批量操作
  config.batch_actions = true
  
  # 设置每页显示记录数
  config.default_per_page = 30
  
  # 设置CSV下载选项
  config.csv_options = { col_sep: ',', force_quotes: true }
  
  # 设置过滤器位置
  config.filters_position = :right
  
  # 设置注释
  config.comments = false
end
```

### 4. 设置 AASM 状态机

创建 `config/initializers/aasm.rb` 文件：

```ruby
AASM.configure do |config|
  # 启用 whiny transitions
  config.whiny_transitions = true
  
  # 启用事务支持
  config.use_transactions = false
  
  # 启用 logger
  config.logger = Rails.logger
end
```

### 5. 创建 Current 类

创建 `app/models/current.rb` 文件，用于存储当前用户信息：

```ruby
class Current < ActiveSupport::CurrentAttributes
  attribute :admin_user
end
```

### 6. 创建 ServiceRegistry 模块

创建 `app/services/service_registry.rb` 文件，用于注册服务：

```ruby
module ServiceRegistry
  def reimbursement_import_service
    @reimbursement_import_service ||= ReimbursementImportService.new(params[:file], current_admin_user)
  end
  
  def express_receipt_import_service
    @express_receipt_import_service ||= ExpressReceiptImportService.new(params[:file], current_admin_user)
  end
  
  def fee_detail_import_service
    @fee_detail_import_service ||= FeeDetailImportService.new(params[:file], current_admin_user)
  end
  
  def operation_history_import_service
    @operation_history_import_service ||= OperationHistoryImportService.new(params[:file], current_admin_user)
  end
  
  def audit_work_order_service(work_order)
    @audit_work_order_service ||= AuditWorkOrderService.new(work_order, current_admin_user)
  end
  
  def communication_work_order_service(work_order)
    @communication_work_order_service ||= CommunicationWorkOrderService.new(work_order, current_admin_user)
  end
  
  def express_receipt_work_order_service(work_order)
    @express_receipt_work_order_service ||= ExpressReceiptWorkOrderService.new(work_order, current_admin_user)
  end
  
  def fee_detail_verification_service
    @fee_detail_verification_service ||= FeeDetailVerificationService.new(current_admin_user)
  end
  
  def work_order_status_change_service
    @work_order_status_change_service ||= WorkOrderStatusChangeService.new(current_admin_user)
  end
end
```

### 7. 创建服务目录结构

创建以下目录结构：

```
app/
├── services/
│   ├── reimbursement_import_service.rb
│   ├── express_receipt_import_service.rb
│   ├── fee_detail_import_service.rb
│   ├── operation_history_import_service.rb
│   ├── audit_work_order_service.rb
│   ├── communication_work_order_service.rb
│   ├── express_receipt_work_order_service.rb
│   ├── fee_detail_verification_service.rb
│   ├── work_order_status_change_service.rb
│   └── service_registry.rb
```

## 测试验证方法

1. 运行 `bundle install` 确保所有依赖安装成功
2. 运行 `rails db:create` 创建数据库
3. 运行 `rails db:migrate` 执行初始迁移
4. 运行 `rails server` 启动服务器
5. 访问 `http://localhost:3000/admin` 确认 ActiveAdmin 配置正确

## 注意事项

1. 确保 Ruby 和 Rails 版本符合要求
2. 确保所有依赖都正确安装
3. 确保 ActiveAdmin 配置正确
4. 确保 AASM 状态机配置正确