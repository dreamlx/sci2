# 数据库迁移脚本准备

## 任务描述

创建 SCI2 工单系统重构所需的数据库迁移脚本，包括为每个工单类型创建表迁移、创建关联表迁移、设置适当的索引和约束。

## 输入和依赖

- 数据库结构设计文档 (`docs/refactoring/02_database_structure.md`)
- 已配置好的 Rails 项目

## 期望输出

完整的数据库迁移脚本，包括：
- 报销单表
- 快递收单工单表
- 审核工单表
- 沟通工单表
- 费用明细表
- 费用明细选择表
- 沟通记录表
- 工单状态变更表
- 操作历史表
- 快递收单表
- 适当的索引和约束

## 详细实现步骤

### 1. 创建报销单表迁移

```bash
rails g migration CreateReimbursements
```

编辑生成的迁移文件：

```ruby
class CreateReimbursements < ActiveRecord::Migration[7.0]
  def change
    create_table :reimbursements do |t|
      t.string :invoice_number, null: false
      t.string :document_name
      t.string :applicant
      t.string :applicant_id
      t.string :company
      t.string :department
      t.decimal :amount, precision: 10, scale: 2
      t.string :receipt_status, default: 'pending'
      t.string :reimbursement_status, default: 'pending'
      t.datetime :receipt_date
      t.datetime :submission_date
      t.boolean :is_electronic, default: false
      t.boolean :is_complete, default: false

      t.timestamps
    end

    add_index :reimbursements, :invoice_number, unique: true
    add_index :reimbursements, :applicant
    add_index :reimbursements, :receipt_status
    add_index :reimbursements, :reimbursement_status
    add_index :reimbursements, :is_complete
  end
end
```

### 2. 创建快递收单工单表迁移

```bash
rails g migration CreateExpressReceiptWorkOrders
```

编辑生成的迁移文件：

```ruby
class CreateExpressReceiptWorkOrders < ActiveRecord::Migration[7.0]
  def change
    create_table :express_receipt_work_orders do |t|
      t.references :reimbursement, foreign_key: true
      t.string :status, null: false
      t.string :tracking_number
      t.datetime :received_at
      t.string :courier_name
      t.integer :created_by

      t.timestamps
    end

    add_index :express_receipt_work_orders, :status
    add_index :express_receipt_work_orders, :tracking_number
  end
end
```

### 3. 创建审核工单表迁移

```bash
rails g migration CreateAuditWorkOrders
```

编辑生成的迁移文件：

```ruby
class CreateAuditWorkOrders < ActiveRecord::Migration[7.0]
  def change
    create_table :audit_work_orders do |t|
      t.references :reimbursement, foreign_key: true
      t.references :express_receipt_work_order, foreign_key: true, null: true
      t.string :status, null: false
      t.string :audit_result
      t.text :audit_comment
      t.datetime :audit_date
      t.boolean :vat_verified
      t.integer :created_by

      t.timestamps
    end

    add_index :audit_work_orders, :status
    add_index :audit_work_orders, :audit_result
  end
end
```

### 4. 创建沟通工单表迁移

```bash
rails g migration CreateCommunicationWorkOrders
```

编辑生成的迁移文件：

```ruby
class CreateCommunicationWorkOrders < ActiveRecord::Migration[7.0]
  def change
    create_table :communication_work_orders do |t|
      t.references :reimbursement, foreign_key: true
      t.references :audit_work_order, foreign_key: true
      t.string :status, null: false
      t.string :communication_method
      t.string :initiator_role
      t.text :resolution_summary
      t.integer :created_by

      t.timestamps
    end

    add_index :communication_work_orders, :status
  end
end
```

### 5. 创建费用明细表迁移

```bash
rails g migration CreateFeeDetails
```

编辑生成的迁移文件：

```ruby
class CreateFeeDetails < ActiveRecord::Migration[7.0]
  def change
    create_table :fee_details do |t|
      t.string :document_number, null: false
      t.string :fee_type
      t.decimal :amount, precision: 10, scale: 2
      t.string :currency, default: 'CNY'
      t.datetime :fee_date
      t.string :payment_method
      t.string :verification_status, default: 'pending'

      t.timestamps
    end

    add_index :fee_details, :document_number
    add_index :fee_details, :verification_status
  end
end
```

### 6. 创建费用明细选择表迁移

```bash
rails g migration CreateFeeDetailSelections
```

编辑生成的迁移文件：

```ruby
class CreateFeeDetailSelections < ActiveRecord::Migration[7.0]
  def change
    create_table :fee_detail_selections do |t|
      t.references :fee_detail, foreign_key: true
      t.references :audit_work_order, foreign_key: true, null: true
      t.references :communication_work_order, foreign_key: true, null: true
      t.string :verification_status
      t.text :verification_comment
      t.integer :verified_by
      t.datetime :verified_at

      t.timestamps
    end

    add_index :fee_detail_selections, [:fee_detail_id, :audit_work_order_id],
              unique: true,
              name: 'index_fee_detail_selections_on_fee_detail_and_audit_work_order',
              where: 'audit_work_order_id IS NOT NULL'

    add_index :fee_detail_selections, [:fee_detail_id, :communication_work_order_id],
              unique: true,
              name: 'index_fee_detail_selections_on_fee_detail_and_comm_work_order',
              where: 'communication_work_order_id IS NOT NULL'
  end
end
```

### 7. 创建沟通记录表迁移

```bash
rails g migration CreateCommunicationRecords
```

编辑生成的迁移文件：

```ruby
class CreateCommunicationRecords < ActiveRecord::Migration[7.0]
  def change
    create_table :communication_records do |t|
      t.references :communication_work_order, foreign_key: true
      t.text :content
      t.string :communicator_role
      t.string :communicator_name
      t.string :communication_method
      t.datetime :recorded_at

      t.timestamps
    end

    add_index :communication_records, :recorded_at
  end
end
```

### 8. 创建工单状态变更表迁移

```bash
rails g migration CreateWorkOrderStatusChanges
```

编辑生成的迁移文件：

```ruby
class CreateWorkOrderStatusChanges < ActiveRecord::Migration[7.0]
  def change
    create_table :work_order_status_changes do |t|
      t.string :work_order_type, null: false
      t.integer :work_order_id, null: false
      t.string :from_status
      t.string :to_status, null: false
      t.datetime :changed_at, null: false
      t.integer :changed_by
      t.string :reason

      t.timestamps
    end

    add_index :work_order_status_changes, [:work_order_type, :work_order_id]
    add_index :work_order_status_changes, :changed_at
  end
end
```

### 9. 创建操作历史表迁移

```bash
rails g migration CreateOperationHistories
```

编辑生成的迁移文件：

```ruby
class CreateOperationHistories < ActiveRecord::Migration[7.0]
  def change
    create_table :operation_histories do |t|
      t.string :document_number, null: false
      t.string :operation_type
      t.datetime :operation_time
      t.string :operator
      t.text :notes

      t.timestamps
    end

    add_index :operation_histories, :document_number
    add_index :operation_histories, :operation_time
  end
end
```

### 10. 创建快递收单表迁移

```bash
rails g migration CreateExpressReceipts
```

编辑生成的迁移文件：

```ruby
class CreateExpressReceipts < ActiveRecord::Migration[7.0]
  def change
    create_table :express_receipts do |t|
      t.string :document_number, null: false
      t.string :tracking_number
      t.datetime :receive_date
      t.string :receiver
      t.string :courier_company

      t.timestamps
    end

    add_index :express_receipts, :document_number
    add_index :express_receipts, :tracking_number
  end
end
```

### 11. 执行迁移

运行以下命令执行迁移：

```bash
rails db:migrate
```

## 测试验证方法

1. 运行 `rails db:migrate` 确保所有迁移成功执行
2. 运行 `rails db:schema:dump` 生成 schema.rb 文件
3. 检查 schema.rb 文件，确保所有表、字段、索引和约束都正确创建
4. 使用 RSpec 创建简单的模型测试，确保数据库结构正确：

```ruby
# spec/models/reimbursement_spec.rb
require 'rails_helper'

RSpec.describe Reimbursement, type: :model do
  it "has a valid factory" do
    reimbursement = build(:reimbursement)
    expect(reimbursement).to be_valid
  end

  it "is invalid without an invoice number" do
    reimbursement = build(:reimbursement, invoice_number: nil)
    expect(reimbursement).not_to be_valid
  end
end
```

## 注意事项

1. 确保所有外键关系正确设置
2. 确保索引设置合理，特别是对于频繁查询的字段
3. 确保唯一性约束设置正确，特别是对于费用明细选择表
4. 确保所有必要的字段都设置了非空约束
5. 确保所有日期时间字段使用 datetime 类型
6. 确保所有金额字段使用 decimal 类型，并设置适当的精度和小数位数
7. 注意 SQLite 可能不支持某些高级索引功能，如条件索引，在生产环境中使用 PostgreSQL 或 MySQL 时需要调整