# 数据导入集成测试实现

## 任务描述

实现 SCI2 工单系统数据导入功能的集成测试，包括报销单导入、快递收单导入、费用明细导入和操作历史导入的测试。这些测试将确保数据导入功能正确，特别是导入顺序要求和数据关联关系，为后续的开发和重构提供保障。

## 输入和依赖

- 基础模型实现
- 服务层实现
- RSpec 测试框架
- FactoryBot 工厂
- 测试策略文档 (`docs/refactoring/06_testing_strategy.md`)

## 期望输出

完整的数据导入集成测试实现，包括：
- 报销单导入测试
- 快递收单导入测试
- 费用明细导入测试
- 操作历史导入测试
- 导入顺序测试

## 详细实现步骤

### 1. 测试准备

确保 RSpec 和 FactoryBot 已正确配置，并创建必要的测试辅助方法：

```ruby
# spec/support/import_test_helpers.rb
module ImportTestHelpers
  def create_admin_user
    @admin_user ||= create(:admin_user)
  end
  
  def create_test_xlsx(data)
    require 'axlsx'
    
    file = Tempfile.new(['test', '.xlsx'])
    
    Axlsx::Package.new do |p|
      p.workbook.add_worksheet(name: 'Sheet1') do |sheet|
        data.each do |row|
          sheet.add_row row
        end
      end
      p.serialize(file.path)
    end
    
    file.rewind
    
    uploaded_file = Rack::Test::UploadedFile.new(file.path, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
    
    # 确保测试结束后删除临时文件
    ObjectSpace.define_finalizer(self, -> { file.close; file.unlink })
    
    uploaded_file
  end
end

RSpec.configure do |config|
  config.include ImportTestHelpers, type: :integration
end
```

### 2. 实现报销单导入测试

创建 `spec/integration/reimbursement_import_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "报销单导入", type: :integration do
  let(:admin_user) { create(:admin_user) }
  
  describe "导入成功" do
    it "导入新的报销单" do
      # 创建测试文件
      file = create_test_xlsx([
        ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签'],
        ['R20250101001', '测试报销单1', '张三', 'EMP001', '测试公司', '测试部门', '1000.00', '已收单', '已付款', '2025-01-01', '2025-01-01', ''],
        ['R20250101002', '测试报销单2', '李四', 'EMP002', '测试公司', '财务部', '2000.00', '已收单', '已付款', '2025-01-02', '2025-01-02', '全电子发票']
      ])
      
      # 导入报销单
      service = ReimbursementImportService.new(file, admin_user)
      result = service.import
      
      # 验证导入结果
      expect(result[:success]).to be_truthy
      expect(result[:created]).to eq(2)
      expect(result[:updated]).to eq(0)
      expect(result[:errors]).to eq(0)
      
      # 验证报销单创建
      expect(Reimbursement.count).to eq(2)
      
      reimbursement1 = Reimbursement.find_by(invoice_number: 'R20250101001')
      expect(reimbursement1).to be_present
      expect(reimbursement1.document_name).to eq('测试报销单1')
      expect(reimbursement1.is_electronic).to be_falsey
      
      # 验证非电子发票报销单创建审核工单
      expect(AuditWorkOrder.count).to eq(1)
      audit_work_order = AuditWorkOrder.first
      expect(audit_work_order.reimbursement_id).to eq(reimbursement1.id)
      expect(audit_work_order.status).to eq('pending')
    end
    
    it "更新已存在的报销单" do
      # 创建已存在的报销单
      existing_reimbursement = create(:reimbursement, 
                                     invoice_number: 'R20250101001', 
                                     document_name: '旧报销单', 
                                     applicant: '旧申请人')
      
      # 创建测试文件
      file = create_test_xlsx([
        ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签'],
        ['R20250101001', '更新的报销单', '新申请人', 'EMP001', '测试公司', '测试部门', '1000.00', '已收单', '已付款', '2025-01-01', '2025-01-01', '']
      ])
      
      # 导入报销单
      service = ReimbursementImportService.new(file, admin_user)
      result = service.import
      
      # 验证导入结果
      expect(result[:success]).to be_truthy
      expect(result[:created]).to eq(0)
      expect(result[:updated]).to eq(1)
      
      # 验证报销单更新
      existing_reimbursement.reload
      expect(existing_reimbursement.document_name).to eq('更新的报销单')
      expect(existing_reimbursement.applicant).to eq('新申请人')
    end
  end
  
  describe "导入失败" do
    it "文件不存在" do
      service = ReimbursementImportService.new(nil, admin_user)
      result = service.import
      
      expect(result[:success]).to be_falsey
      expect(result[:errors]).to include("文件不存在")
    end
  end
end
```

### 3. 实现快递收单导入测试

创建 `spec/integration/express_receipt_import_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "快递收单导入", type: :integration do
  let(:admin_user) { create(:admin_user) }
  let!(:reimbursement) { create(:reimbursement, invoice_number: 'R20250101001') }
  
  describe "导入成功" do
    it "导入快递收单记录并创建工单" do
      # 创建测试文件
      file = create_test_xlsx([
        ['单号', '操作时间', '操作人', '操作意见'],
        ['R20250101001', '2025-01-01 10:00:00', '张三', '快递单号: SF1234567890']
      ])
      
      # 导入快递收单
      service = ExpressReceiptImportService.new(file, admin_user)
      result = service.import
      
      # 验证导入结果
      expect(result[:success]).to be_truthy
      expect(result[:matched]).to eq(1)
      expect(result[:unmatched]).to eq(0)
      
      # 验证快递收单记录创建
      expect(ExpressReceipt.count).to eq(1)
      express_receipt = ExpressReceipt.first
      expect(express_receipt.document_number).to eq('R20250101001')
      expect(express_receipt.tracking_number).to eq('SF1234567890')
      
      # 验证快递收单工单创建
      expect(ExpressReceiptWorkOrder.count).to eq(1)
      work_order = ExpressReceiptWorkOrder.first
      expect(work_order.reimbursement_id).to eq(reimbursement.id)
      expect(work_order.tracking_number).to eq('SF1234567890')
      expect(work_order.status).to eq('received')
      
      # 验证报销单状态更新
      reimbursement.reload
      expect(reimbursement.receipt_status).to eq('received')
      expect(reimbursement.receipt_date).to be_present
    end
  end
  
  describe "导入失败" do
    it "报销单不存在" do
      # 创建测试文件
      file = create_test_xlsx([
        ['单号', '操作时间', '操作人', '操作意见'],
        ['R20250101999', '2025-01-01 10:00:00', '张三', '快递单号: SF1234567890'] # 不存在的报销单
      ])
      
      # 导入快递收单
      service = ExpressReceiptImportService.new(file, admin_user)
      result = service.import
      
      # 验证导入结果
      expect(result[:success]).to be_truthy
      expect(result[:matched]).to eq(0)
      expect(result[:unmatched]).to eq(1)
      
      # 验证未匹配记录
      expect(result[:unmatched_receipts].first[:document_number]).to eq('R20250101999')
      expect(result[:unmatched_receipts].first[:error]).to eq('报销单不存在')
      
      # 验证没有创建快递收单记录和工单
      expect(ExpressReceipt.count).to eq(0)
      expect(ExpressReceiptWorkOrder.count).to eq(0)
    end
  end
  
  describe "手动匹配" do
    it "手动匹配未匹配的快递单" do
      # 创建测试文件
      file = create_test_xlsx([
        ['单号', '操作时间', '操作人', '操作意见'],
        ['R20250101999', '2025-01-01 10:00:00', '张三', '快递单号: SF1234567890'] # 不存在的报销单
      ])
      
      # 导入快递收单
      service = ExpressReceiptImportService.new(file, admin_user)
      result = service.import
      
      # 手动匹配
      tracking_number = result[:unmatched_receipts].first[:tracking_number]
      match_result = service.manual_match(tracking_number, reimbursement.id)
      
      # 验证匹配结果
      expect(match_result[:success]).to be_truthy
      
      # 验证快递收单记录和工单创建
      expect(ExpressReceipt.count).to eq(1)
      expect(ExpressReceiptWorkOrder.count).to eq(1)
    end
  end
end
```

### 4. 实现费用明细导入测试

创建 `spec/integration/fee_detail_import_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "费用明细导入", type: :integration do
  let(:admin_user) { create(:admin_user) }
  let!(:reimbursement) { create(:reimbursement, invoice_number: 'R20250101001') }
  let!(:audit_work_order) { create(:audit_work_order, reimbursement: reimbursement, status: 'processing') }
  
  describe "导入成功" do
    it "导入费用明细并关联到审核工单" do
      # 创建测试文件
      file = create_test_xlsx([
        ['报销单单号', '费用类型', '原始金额', '币种', '费用发生日期', '支付方式'],
        ['R20250101001', '交通费', '100.00', 'CNY', '2025-01-01', '现金'],
        ['R20250101001', '餐饮费', '200.00', 'CNY', '2025-01-01', '现金'],
        ['R20250101001', '住宿费', '300.00', 'CNY', '2025-01-01', '现金']
      ])
      
      # 导入费用明细
      service = FeeDetailImportService.new(file, admin_user)
      result = service.import
      
      # 验证导入结果
      expect(result[:success]).to be_truthy
      expect(result[:imported]).to eq(3)
      expect(result[:unmatched]).to eq(0)
      
      # 验证费用明细创建
      expect(FeeDetail.count).to eq(3)
      
      fee_detail1 = FeeDetail.find_by(fee_type: '交通费')
      expect(fee_detail1).to be_present
      expect(fee_detail1.document_number).to eq('R20250101001')
      expect(fee_detail1.amount).to eq(100.00)
      expect(fee_detail1.verification_status).to eq('pending')
      
      # 验证费用明细关联到审核工单
      expect(audit_work_order.fee_details.count).to eq(3)
      expect(audit_work_order.fee_details).to include(fee_detail1)
    end
  end
  
  describe "导入失败" do
    it "报销单不存在" do
      # 创建测试文件
      file = create_test_xlsx([
        ['报销单单号', '费用类型', '原始金额', '币种', '费用发生日期', '支付方式'],
        ['R20250101999', '交通费', '100.00', 'CNY', '2025-01-01', '现金'] # 不存在的报销单
      ])
      
      # 导入费用明细
      service = FeeDetailImportService.new(file, admin_user)
      result = service.import
      
      # 验证导入结果
      expect(result[:success]).to be_truthy
      expect(result[:imported]).to eq(0)
      expect(result[:unmatched]).to eq(1)
      
      # 验证未匹配记录
      expect(result[:unmatched_details].first[:document_number]).to eq('R20250101999')
      expect(result[:unmatched_details].first[:error]).to eq('报销单不存在')
    end
  end
end
```

### 5. 实现操作历史导入测试

创建 `spec/integration/operation_history_import_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "操作历史导入", type: :integration do
  let(:admin_user) { create(:admin_user) }
  let!(:reimbursement) { create(:reimbursement, invoice_number: 'R20250101001', is_complete: false, reimbursement_status: 'processing') }
  
  describe "导入成功" do
    it "导入操作历史并更新报销单状态" do
      # 创建测试文件
      file = create_test_xlsx([
        ['单据编号', '操作类型', '操作日期', '操作人', '操作意见'],
        ['R20250101001', '审批通过', '2025-01-01', '张三', '审批通过'],
        ['R20250101001', '已付款', '2025-01-02', '李四', '已付款']
      ])
      
      # 导入操作历史
      service = OperationHistoryImportService.new(file, admin_user)
      result = service.import
      
      # 验证导入结果
      expect(result[:success]).to be_truthy
      expect(result[:imported]).to eq(2)
      expect(result[:updated]).to eq(1)
      
      # 验证操作历史创建
      expect(OperationHistory.count).to eq(2)
      
      # 验证报销单状态更新
      reimbursement.reload
      expect(reimbursement.is_complete).to be_truthy
      expect(reimbursement.reimbursement_status).to eq('closed')
    end
  end
  
  describe "导入失败" do
    it "报销单不存在" do
      # 创建测试文件
      file = create_test_xlsx([
        ['单据编号', '操作类型', '操作日期', '操作人', '操作意见'],
        ['R20250101999', '审批通过', '2025-01-01', '张三', '审批通过'] # 不存在的报销单
      ])
      
      # 导入操作历史
      service = OperationHistoryImportService.new(file, admin_user)
      result = service.import
      
      # 验证导入结果
      expect(result[:success]).to be_truthy
      expect(result[:imported]).to eq(0)
      expect(result[:unmatched]).to eq(1)
    end
  end
end
```

### 6. 实现导入顺序测试

创建 `spec/integration/import_order_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "导入顺序", type: :integration do
  let(:admin_user) { create(:admin_user) }
  
  describe "导入顺序要求" do
    it "必须先导入报销单" do
      # 创建快递收单测试文件
      express_file = create_test_xlsx([
        ['单号', '操作时间', '操作人', '操作意见'],
        ['R20250101001', '2025-01-01 10:00:00', '张三', '快递单号: SF1234567890']
      ])
      
      # 尝试导入快递收单
      express_service = ExpressReceiptImportService.new(express_file, admin_user)
      express_result = express_service.import
      
      # 验证导入结果
      expect(express_result[:success]).to be_truthy
      expect(express_result[:matched]).to eq(0)
      expect(express_result[:unmatched]).to eq(1)
      
      # 创建报销单测试文件
      reimbursement_file = create_test_xlsx([
        ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签'],
        ['R20250101001', '测试报销单', '张三', 'EMP001', '测试公司', '测试部门', '1000.00', '已收单', '已付款', '2025-01-01', '2025-01-01', '']
      ])
      
      # 导入报销单
      reimbursement_service = ReimbursementImportService.new(reimbursement_file, admin_user)
      reimbursement_result = reimbursement_service.import
      
      # 验证导入结果
      expect(reimbursement_result[:success]).to be_truthy
      expect(reimbursement_result[:created]).to eq(1)
      
      # 再次尝试导入快递收单
      express_service = ExpressReceiptImportService.new(express_file, admin_user)
      express_result = express_service.import
      
      # 验证导入结果
      expect(express_result[:success]).to be_truthy
      expect(express_result[:matched]).to eq(1)
      expect(express_result[:unmatched]).to eq(0)
    end
  end
  
  describe "完整导入流程" do
    it "按正确顺序导入所有数据" do
      # 1. 导入报销单
      reimbursement_file = create_test_xlsx([
        ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签'],
        ['R20250101001', '测试报销单', '张三', 'EMP001', '测试公司', '测试部门', '1000.00', '', '', '', '2025-01-01', '']
      ])
      
      reimbursement_service = ReimbursementImportService.new(reimbursement_file, admin_user)
      reimbursement_service.import
      
      # 验证报销单创建
      reimbursement = Reimbursement.find_by(invoice_number: 'R20250101001')
      expect(reimbursement).to be_present
      
      # 2. 导入快递收单
      express_file = create_test_xlsx([
        ['单号', '操作时间', '操作人', '操作意见'],
        ['R20250101001', '2025-01-01 10:00:00', '张三', '快递单号: SF1234567890']
      ])
      
      express_service = ExpressReceiptImportService.new(express_file, admin_user)
      express_service.import
      
      # 验证快递收单工单创建
      express_receipt_work_order = ExpressReceiptWorkOrder.first
      expect(express_receipt_work_order).to be_present
      
      # 3. 导入费用明细
      fee_detail_file = create_test_xlsx([
        ['报销单单号', '费用类型', '原始金额', '币种', '费用发生日期', '支付方式'],
        ['R20250101001', '交通费', '100.00', 'CNY', '2025-01-01', '现金'],
        ['R20250101001', '餐饮费', '200.00', 'CNY', '2025-01-01', '现金']
      ])
      
      fee_detail_service = FeeDetailImportService.new(fee_detail_file, admin_user)
      fee_detail_service.import
      
      # 验证费用明细创建
      expect(FeeDetail.count).to eq(2)
      
      # 4. 导入操作历史
      operation_history_file = create_test_xlsx([
        ['单据编号', '操作类型', '操作日期', '操作人', '操作意见'],
        ['R20250101001', '审批通过', '2025-01-01', '张三', '审批通过'],
        ['R20250101001', '已付款', '2025-01-02', '李四', '已付款']
      ])
      
      operation_history_service = OperationHistoryImportService.new(operation_history_file, admin_user)
      operation_history_service.import
      
      # 验证操作历史创建
      expect(OperationHistory.count).to eq(2)
      
      # 验证最终状态
      reimbursement.reload
      expect(reimbursement.receipt_status).to eq('received')
      expect(reimbursement.reimbursement_status).to eq('closed')
      expect(reimbursement.is_complete).to be_truthy
    end
  end
end
```

## 测试验证方法

1. 运行所有导入测试：`bundle exec rspec spec/integration/*_import_spec.rb`
2. 运行特定导入测试：`bundle exec rspec spec/integration/reimbursement_import_spec.rb`
3. 运行导入顺序测试：`bundle exec rspec spec/integration/import_order_spec.rb`

## 注意事项

1. 确保测试覆盖所有导入功能
2. 特别关注导入顺序要求，确保必须先导入报销单
3. 特别关注数据关联关系，确保费用明细正确关联到审核工单
4. 特别关注报销单状态更新，确保操作历史导入后正确更新报销单状态
5. 使用 FactoryBot 创建测试数据，避免在测试中直接创建对象
6. 使用 DatabaseCleaner 确保测试之间的数据隔离
7. 考虑使用 SimpleCov 监控测试覆盖率
8. 确保测试场景覆盖边缘情况，如报销单不存在的情况