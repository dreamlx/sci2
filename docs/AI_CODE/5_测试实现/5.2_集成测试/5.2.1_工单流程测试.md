# 工单流程集成测试实现

## 任务描述

实现 SCI2 工单系统各个工单流程的集成测试，包括快递收单工单流程、审核工单流程、沟通工单流程和费用明细验证流程的测试。这些测试将确保不同工单类型之间的交互和状态流转正确，为后续的开发和重构提供保障。

## 输入和依赖

- 基础模型实现
- 服务层实现
- RSpec 测试框架
- FactoryBot 工厂
- 测试策略文档 (`docs/refactoring/06_testing_strategy.md`)

## 期望输出

完整的工单流程集成测试实现，包括：
- 快递收单工单流程测试
- 审核工单流程测试
- 沟通工单流程测试
- 费用明细验证流程测试

## 详细实现步骤

### 1. 测试准备

确保 RSpec 和 FactoryBot 已正确配置，并创建必要的测试辅助方法：

```ruby
# spec/support/integration_test_helpers.rb
module IntegrationTestHelpers
  def create_admin_user
    @admin_user ||= create(:admin_user)
  end
  
  def create_reimbursement
    @reimbursement ||= create(:reimbursement, invoice_number: "R#{Time.current.strftime('%Y%m%d')}001")
  end
  
  def create_fee_details(count = 3)
    @fee_details ||= count.times.map do |i|
      create(:fee_detail, document_number: @reimbursement.invoice_number, fee_type: "费用类型#{i+1}", amount: 100 * (i+1))
    end
  end
end

RSpec.configure do |config|
  config.include IntegrationTestHelpers, type: :integration
end
```

### 2. 实现快递收单工单流程测试

创建 `spec/integration/express_receipt_work_order_flow_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "快递收单工单流程", type: :integration do
  let(:admin_user) { create(:admin_user) }
  let(:reimbursement) { create(:reimbursement) }
  
  describe "完整流程" do
    it "从创建到完成，并创建审核工单" do
      # 创建快递收单工单
      express_receipt_work_order = create(:express_receipt_work_order, 
                                         reimbursement: reimbursement, 
                                         status: 'received')
      
      # 创建费用明细
      fee_details = 3.times.map do |i|
        create(:fee_detail, document_number: reimbursement.invoice_number, 
               fee_type: "费用类型#{i+1}", amount: 100 * (i+1))
      end
      
      # 处理快递收单工单
      service = ExpressReceiptWorkOrderService.new(express_receipt_work_order, admin_user)
      service.process
      
      express_receipt_work_order.reload
      expect(express_receipt_work_order.status).to eq('processed')
      
      # 完成快递收单工单
      service.complete
      
      express_receipt_work_order.reload
      expect(express_receipt_work_order.status).to eq('completed')
      
      # 验证审核工单创建
      audit_work_order = AuditWorkOrder.find_by(express_receipt_work_order_id: express_receipt_work_order.id)
      expect(audit_work_order).to be_present
      expect(audit_work_order.status).to eq('pending')
      expect(audit_work_order.reimbursement_id).to eq(reimbursement.id)
      
      # 验证费用明细关联
      expect(audit_work_order.fee_details.count).to eq(3)
      fee_details.each do |fee_detail|
        expect(audit_work_order.fee_details).to include(fee_detail)
      end
    end
  end
  
  describe "状态变更记录" do
    it "记录状态变更历史" do
      express_receipt_work_order = create(:express_receipt_work_order, 
                                         reimbursement: reimbursement, 
                                         status: 'received')
      
      # 处理快递收单工单
      service = ExpressReceiptWorkOrderService.new(express_receipt_work_order, admin_user)
      service.process
      service.complete
      
      # 验证状态变更记录
      status_changes = WorkOrderStatusChange.where(
        work_order_type: 'express_receipt',
        work_order_id: express_receipt_work_order.id
      ).order(changed_at: :asc)
      
      expect(status_changes.count).to eq(2)
      expect(status_changes[0].from_status).to eq('received')
      expect(status_changes[0].to_status).to eq('processed')
      expect(status_changes[1].from_status).to eq('processed')
      expect(status_changes[1].to_status).to eq('completed')
    end
  end
end
```

### 3. 实现审核工单流程测试

创建 `spec/integration/audit_work_order_flow_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "审核工单流程", type: :integration do
  let(:admin_user) { create(:admin_user) }
  let(:reimbursement) { create(:reimbursement) }
  
  describe "审核通过流程" do
    it "从创建到审核通过并完成" do
      # 创建审核工单
      audit_work_order = create(:audit_work_order, 
                               reimbursement: reimbursement, 
                               status: 'pending')
      
      # 创建费用明细
      fee_details = 3.times.map do |i|
        create(:fee_detail, document_number: reimbursement.invoice_number, 
               fee_type: "费用类型#{i+1}", amount: 100 * (i+1))
      end
      
      # 关联费用明细
      fee_details.each do |fee_detail|
        audit_work_order.select_fee_detail(fee_detail)
      end
      
      # 开始处理
      service = AuditWorkOrderService.new(audit_work_order, admin_user)
      service.start_processing
      service.start_audit
      
      # 验证费用明细
      fee_details.each do |fee_detail|
        service.verify_fee_detail(fee_detail.id, 'verified', '验证通过')
        expect(fee_detail.reload.verification_status).to eq('verified')
      end
      
      # 审核通过
      service.approve('审核通过')
      
      audit_work_order.reload
      expect(audit_work_order.status).to eq('approved')
      expect(audit_work_order.audit_result).to eq('approved')
      
      # 完成
      service.complete
      
      audit_work_order.reload
      expect(audit_work_order.status).to eq('completed')
    end
  end
  
  describe "需要沟通流程" do
    it "从审核到需要沟通，再恢复审核" do
      # 创建审核工单
      audit_work_order = create(:audit_work_order, 
                               reimbursement: reimbursement, 
                               status: 'auditing')
      
      # 创建费用明细
      fee_detail = create(:fee_detail, document_number: reimbursement.invoice_number, 
                         fee_type: "交通费", amount: 100)
      
      # 关联费用明细
      audit_work_order.select_fee_detail(fee_detail)
      
      # 创建沟通工单
      service = AuditWorkOrderService.new(audit_work_order, admin_user)
      communication_work_order = service.create_communication_work_order(
        communication_method: 'email',
        initiator_role: 'auditor',
        content: '需要沟通',
        fee_detail_ids: [fee_detail.id]
      )
      
      audit_work_order.reload
      expect(audit_work_order.status).to eq('needs_communication')
      expect(fee_detail.reload.verification_status).to eq('problematic')
      
      # 处理沟通工单
      comm_service = CommunicationWorkOrderService.new(communication_work_order, admin_user)
      comm_service.start_communication
      comm_service.resolve('问题已解决')
      
      # 验证审核工单状态恢复
      audit_work_order.reload
      expect(audit_work_order.status).to eq('auditing')
      
      # 验证费用明细状态未变
      expect(fee_detail.reload.verification_status).to eq('problematic')
      
      # 手动更新费用明细状态
      service.verify_fee_detail(fee_detail.id, 'verified', '沟通后确认无误')
      
      expect(fee_detail.reload.verification_status).to eq('verified')
    end
  end
end
```

### 4. 实现沟通工单流程测试

创建 `spec/integration/communication_work_order_flow_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "沟通工单流程", type: :integration do
  let(:admin_user) { create(:admin_user) }
  let(:reimbursement) { create(:reimbursement) }
  let(:audit_work_order) { create(:audit_work_order, reimbursement: reimbursement, status: 'needs_communication') }
  
  describe "解决流程" do
    it "从创建到解决并关闭" do
      # 创建沟通工单
      communication_work_order = create(:communication_work_order, 
                                       reimbursement: reimbursement, 
                                       audit_work_order: audit_work_order, 
                                       status: 'open')
      
      # 创建费用明细
      fee_detail = create(:fee_detail, document_number: reimbursement.invoice_number, 
                         fee_type: "交通费", amount: 100, 
                         verification_status: 'problematic')
      
      # 关联费用明细
      selection = create(:fee_detail_selection, 
                        communication_work_order: communication_work_order, 
                        fee_detail: fee_detail, 
                        verification_status: 'problematic')
      
      # 开始沟通
      service = CommunicationWorkOrderService.new(communication_work_order, admin_user)
      service.start_communication
      
      # 添加沟通记录
      record = service.add_communication_record(
        content: '已与申请人沟通',
        communicator_role: 'auditor',
        communication_method: 'email'
      )
      
      expect(record).to be_persisted
      
      # 更新费用明细问题备注
      service.resolve_fee_detail_issue(fee_detail.id, '已与申请人确认，费用合理')
      
      selection.reload
      expect(selection.verification_comment).to eq('已与申请人确认，费用合理')
      
      # 解决沟通工单
      service.resolve('问题已解决')
      
      communication_work_order.reload
      expect(communication_work_order.status).to eq('resolved')
      
      # 验证审核工单状态恢复
      audit_work_order.reload
      expect(audit_work_order.status).to eq('auditing')
      
      # 验证费用明细状态未变
      expect(fee_detail.reload.verification_status).to eq('problematic')
      
      # 关闭沟通工单
      service.close
      
      communication_work_order.reload
      expect(communication_work_order.status).to eq('closed')
    end
  end
end
```

### 5. 实现费用明细验证流程测试

创建 `spec/integration/fee_detail_verification_flow_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "费用明细验证流程", type: :integration do
  let(:admin_user) { create(:admin_user) }
  let(:reimbursement) { create(:reimbursement) }
  let(:audit_work_order) { create(:audit_work_order, reimbursement: reimbursement, status: 'auditing') }
  
  describe "正常验证流程" do
    it "直接验证通过" do
      # 创建费用明细
      fee_detail = create(:fee_detail, document_number: reimbursement.invoice_number, 
                         fee_type: "交通费", amount: 100, 
                         verification_status: 'pending')
      
      # 关联费用明细
      audit_work_order.select_fee_detail(fee_detail)
      
      # 验证费用明细
      service = AuditWorkOrderService.new(audit_work_order, admin_user)
      service.verify_fee_detail(fee_detail.id, 'verified', '验证通过')
      
      # 验证费用明细状态
      fee_detail.reload
      expect(fee_detail.verification_status).to eq('verified')
      
      # 验证费用明细选择记录
      selection = FeeDetailSelection.find_by(
        audit_work_order_id: audit_work_order.id,
        fee_detail_id: fee_detail.id
      )
      expect(selection.verification_status).to eq('verified')
      expect(selection.verification_comment).to eq('验证通过')
    end
  end
  
  describe "沟通后验证流程" do
    it "标记为有问题，沟通后验证通过" do
      # 创建费用明细
      fee_detail = create(:fee_detail, document_number: reimbursement.invoice_number, 
                         fee_type: "交通费", amount: 100, 
                         verification_status: 'pending')
      
      # 关联费用明细
      audit_work_order.select_fee_detail(fee_detail)
      
      # 创建沟通工单
      audit_service = AuditWorkOrderService.new(audit_work_order, admin_user)
      communication_work_order = audit_service.create_communication_work_order(
        communication_method: 'email',
        initiator_role: 'auditor',
        content: '需要沟通',
        fee_detail_ids: [fee_detail.id]
      )
      
      # 验证费用明细状态
      fee_detail.reload
      expect(fee_detail.verification_status).to eq('problematic')
      
      # 处理沟通工单
      comm_service = CommunicationWorkOrderService.new(communication_work_order, admin_user)
      comm_service.start_communication
      comm_service.resolve('问题已解决')
      
      # 验证费用明细状态未变
      fee_detail.reload
      expect(fee_detail.verification_status).to eq('problematic')
      
      # 手动更新费用明细状态
      audit_service.verify_fee_detail(fee_detail.id, 'verified', '沟通后确认无误')
      
      # 验证费用明细状态
      fee_detail.reload
      expect(fee_detail.verification_status).to eq('verified')
    end
  end
  
  describe "报销单关闭后验证限制" do
    it "报销单关闭后不能更新费用明细状态" do
      # 创建费用明细
      fee_detail = create(:fee_detail, document_number: reimbursement.invoice_number, 
                         fee_type: "交通费", amount: 100, 
                         verification_status: 'pending')
      
      # 关联费用明细
      audit_work_order.select_fee_detail(fee_detail)
      
      # 关闭报销单
      reimbursement.update(is_complete: true, reimbursement_status: 'closed')
      
      # 尝试验证费用明细
      service = AuditWorkOrderService.new(audit_work_order, admin_user)
      result = service.verify_fee_detail(fee_detail.id, 'verified', '验证通过')
      
      # 验证操作失败
      expect(result).to be_falsey
      
      # 验证费用明细状态未变
      fee_detail.reload
      expect(fee_detail.verification_status).to eq('pending')
    end
  end
end
```

### 6. 实现完整工单流程测试

创建 `spec/integration/complete_work_order_flow_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "完整工单流程", type: :integration do
  let(:admin_user) { create(:admin_user) }
  let(:reimbursement) { create(:reimbursement, is_electronic: false) }
  
  describe "非电子发票完整流程" do
    it "从快递收单到审核完成，包含沟通" do
      # 创建费用明细
      fee_details = 3.times.map do |i|
        create(:fee_detail, document_number: reimbursement.invoice_number, 
               fee_type: "费用类型#{i+1}", amount: 100 * (i+1),
               verification_status: 'pending')
      end
      
      # 创建快递收单工单
      express_receipt_work_order = create(:express_receipt_work_order, 
                                         reimbursement: reimbursement, 
                                         status: 'received')
      
      # 处理快递收单工单
      express_service = ExpressReceiptWorkOrderService.new(express_receipt_work_order, admin_user)
      express_service.process
      express_service.complete
      
      # 获取创建的审核工单
      audit_work_order = AuditWorkOrder.find_by(express_receipt_work_order_id: express_receipt_work_order.id)
      
      # 处理审核工单
      audit_service = AuditWorkOrderService.new(audit_work_order, admin_user)
      audit_service.start_processing
      audit_service.start_audit
      
      # 验证第一个费用明细
      audit_service.verify_fee_detail(fee_details[0].id, 'verified', '验证通过')
      
      # 对第二个费用明细创建沟通工单
      communication_work_order = audit_service.create_communication_work_order(
        communication_method: 'email',
        initiator_role: 'auditor',
        content: '需要沟通',
        fee_detail_ids: [fee_details[1].id]
      )
      
      # 处理沟通工单
      comm_service = CommunicationWorkOrderService.new(communication_work_order, admin_user)
      comm_service.start_communication
      comm_service.resolve('问题已解决')
      
      # 手动更新费用明细状态
      audit_service.verify_fee_detail(fee_details[1].id, 'verified', '沟通后确认无误')
      
      # 验证第三个费用明细
      audit_service.verify_fee_detail(fee_details[2].id, 'verified', '验证通过')
      
      # 审核通过
      audit_service.approve('审核通过')
      
      # 完成审核工单
      audit_service.complete
      
      # 验证最终状态
      expect(express_receipt_work_order.reload.status).to eq('completed')
      expect(audit_work_order.reload.status).to eq('completed')
      expect(communication_work_order.reload.status).to eq('resolved')
      
      fee_details.each do |fee_detail|
        expect(fee_detail.reload.verification_status).to eq('verified')
      end
    end
  end
end
```

## 测试验证方法

1. 运行所有集成测试：`bundle exec rspec spec/integration`
2. 运行特定集成测试：`bundle exec rspec spec/integration/express_receipt_work_order_flow_spec.rb`
3. 运行特定测试用例：`bundle exec rspec spec/integration/express_receipt_work_order_flow_spec.rb:10`

## 注意事项

1. 确保测试覆盖所有关键工单流程
2. 特别关注状态流转逻辑，确保状态转换正确
3. 特别关注费用明细验证逻辑，确保沟通工单解决后状态不自动更新
4. 特别关注工单创建逻辑，确保两种审核工单创建路径正确实现
5. 使用 FactoryBot 创建测试数据，避免在测试中直接创建对象
6. 使用 DatabaseCleaner 确保测试之间的数据隔离
7. 考虑使用 SimpleCov 监控测试覆盖率
8. 确保测试场景覆盖边缘情况，如报销单关闭后的验证限制