# 端到端系统测试实现

## 任务描述

实现 SCI2 工单系统的端到端系统测试，使用 RSpec 和 Capybara 模拟用户交互，测试完整的业务流程。这些测试将确保系统各组件能够协同工作，并且完整的业务流程能够正确执行，为后续的开发和重构提供保障。

## 输入和依赖

- 基础模型实现
- 服务层实现
- 控制器与界面实现
- RSpec 测试框架
- Capybara 测试框架
- FactoryBot 工厂
- 测试策略文档 (`docs/refactoring/06_testing_strategy.md`)

## 期望输出

完整的端到端系统测试实现，包括：
- 完整报销流程测试
- 包含沟通的报销流程测试
- 非电子发票报销流程测试
- 操作历史影响报销单状态测试

## 详细实现步骤

### 1. 测试准备

确保 RSpec、Capybara 和 FactoryBot 已正确配置，并创建必要的测试辅助方法：

```ruby
# spec/support/system_test_helpers.rb
module SystemTestHelpers
  def login_as_admin
    visit new_admin_user_session_path
    fill_in 'admin_user_email', with: 'admin@example.com'
    fill_in 'admin_user_password', with: 'password'
    click_button '登录'
    expect(page).to have_content('登录成功')
  end
  
  def create_test_xlsx(data)
    require 'axlsx'
    
    file = Tempfile.new(['test', '.xlsx'])
    
    Axlsx::Package.new do |p|
      p.workbook.add_worksheet(name: 'Sheet1') do |sheet|
        data.each do |row|
          sheet.add_row row
        end
      end
      p.serialize(file.path)
    end
    
    file.path
  end
end

RSpec.configure do |config|
  config.include SystemTestHelpers, type: :system
  
  config.before(:each, type: :system) do
    driven_by :selenium_chrome_headless
  end
end
```

### 2. 实现完整报销流程测试

创建 `spec/system/complete_workflow_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "完整报销流程", type: :system do
  let!(:admin_user) { create(:admin_user, email: 'admin@example.com', password: 'password') }
  
  before do
    login_as_admin
  end
  
  scenario "从导入报销单到审核完成" do
    # 1. 导入报销单
    visit new_import_admin_reimbursements_path
    
    reimbursement_file = create_test_xlsx([
      ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签'],
      ['R20250101001', '测试报销单', '张三', 'EMP001', '测试公司', '测试部门', '1000.00', '', '', '', '2025-01-01', '']
    ])
    
    attach_file('file', reimbursement_file)
    click_button '导入'
    
    expect(page).to have_content('导入成功')
    
    # 2. 导入快递收单
    visit new_import_admin_express_receipts_path
    
    express_file = create_test_xlsx([
      ['单号', '操作时间', '操作人', '操作意见'],
      ['R20250101001', '2025-01-01 10:00:00', '张三', '快递单号: SF1234567890']
    ])
    
    attach_file('file', express_file)
    click_button '导入'
    
    expect(page).to have_content('导入成功')
    
    # 3. 导入费用明细
    visit new_import_admin_fee_details_path
    
    fee_detail_file = create_test_xlsx([
      ['报销单单号', '费用类型', '原始金额', '币种', '费用发生日期', '支付方式'],
      ['R20250101001', '交通费', '100.00', 'CNY', '2025-01-01', '现金'],
      ['R20250101001', '餐饮费', '200.00', 'CNY', '2025-01-01', '现金']
    ])
    
    attach_file('file', fee_detail_file)
    click_button '导入'
    
    expect(page).to have_content('导入成功')
    
    # 4. 处理快递收单工单
    visit admin_express_receipt_work_orders_path
    
    within('table tbody tr', text: 'R20250101001') do
      click_link '查看'
    end
    
    click_link '处理'
    expect(page).to have_content('工单已处理')
    
    click_link '完成'
    expect(page).to have_content('工单已完成')
    
    # 5. 处理审核工单
    visit admin_audit_work_orders_path
    
    within('table tbody tr', text: 'R20250101001') do
      click_link '查看'
    end
    
    click_link '开始处理'
    expect(page).to have_content('工单已开始处理')
    
    click_link '开始审核'
    expect(page).to have_content('工单已开始审核')
    
    # 6. 验证费用明细
    within('#fee_details') do
      all('tr').each do |row|
        within(row) do
          if find('td', text: '交通费')
            click_link '更新验证状态'
            select '已验证', from: 'audit_work_order_verification_status'
            fill_in 'audit_work_order_comment', with: '验证通过'
            click_button '提交'
            expect(page).to have_content('费用明细状态已更新')
          end
          
          if find('td', text: '餐饮费')
            click_link '更新验证状态'
            select '已验证', from: 'audit_work_order_verification_status'
            fill_in 'audit_work_order_comment', with: '验证通过'
            click_button '提交'
            expect(page).to have_content('费用明细状态已更新')
          end
        end
      end
    end
    
    # 7. 审核通过
    click_link '审核通过'
    fill_in 'comment', with: '审核通过'
    click_button '确认通过'
    
    expect(page).to have_content('审核已通过')
    
    # 8. 完成审核工单
    click_link '完成'
    expect(page).to have_content('工单已完成')
    
    # 9. 验证最终状态
    visit admin_reimbursements_path
    
    within('table tbody tr', text: 'R20250101001') do
      expect(page).to have_content('received') # 收单状态
      click_link '查看'
    end
    
    expect(page).to have_content('测试报销单')
    expect(page).to have_content('张三')
    expect(page).to have_content('received') # 收单状态
    
    # 验证快递收单工单状态
    within('#express_receipt_work_orders') do
      expect(page).to have_content('completed')
    end
    
    # 验证审核工单状态
    within('#audit_work_orders') do
      expect(page).to have_content('completed')
    end
    
    # 验证费用明细状态
    within('#fee_details') do
      expect(page).to have_content('verified')
    end
  end
end
```

### 3. 实现包含沟通的报销流程测试

创建 `spec/system/communication_workflow_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "包含沟通的报销流程", type: :system do
  let!(:admin_user) { create(:admin_user, email: 'admin@example.com', password: 'password') }
  
  before do
    login_as_admin
  end
  
  scenario "从导入报销单到沟通解决再审核完成" do
    # 1. 导入报销单
    visit new_import_admin_reimbursements_path
    
    reimbursement_file = create_test_xlsx([
      ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签'],
      ['R20250101002', '测试报销单', '李四', 'EMP002', '测试公司', '测试部门', '2000.00', '', '', '', '2025-01-01', '']
    ])
    
    attach_file('file', reimbursement_file)
    click_button '导入'
    
    expect(page).to have_content('导入成功')
    
    # 2. 导入快递收单
    visit new_import_admin_express_receipts_path
    
    express_file = create_test_xlsx([
      ['单号', '操作时间', '操作人', '操作意见'],
      ['R20250101002', '2025-01-01 10:00:00', '张三', '快递单号: SF1234567890']
    ])
    
    attach_file('file', express_file)
    click_button '导入'
    
    expect(page).to have_content('导入成功')
    
    # 3. 导入费用明细
    visit new_import_admin_fee_details_path
    
    fee_detail_file = create_test_xlsx([
      ['报销单单号', '费用类型', '原始金额', '币种', '费用发生日期', '支付方式'],
      ['R20250101002', '交通费', '100.00', 'CNY', '2025-01-01', '现金'],
      ['R20250101002', '餐饮费', '500.00', 'CNY', '2025-01-01', '现金'] # 金额较大，需要沟通
    ])
    
    attach_file('file', fee_detail_file)
    click_button '导入'
    
    expect(page).to have_content('导入成功')
    
    # 4. 处理快递收单工单
    visit admin_express_receipt_work_orders_path
    
    within('table tbody tr', text: 'R20250101002') do
      click_link '查看'
    end
    
    click_link '处理'
    click_link '完成'
    
    # 5. 处理审核工单
    visit admin_audit_work_orders_path
    
    within('table tbody tr', text: 'R20250101002') do
      click_link '查看'
    end
    
    click_link '开始处理'
    click_link '开始审核'
    
    # 6. 验证第一个费用明细
    within('#fee_details') do
      within('tr', text: '交通费') do
        click_link '更新验证状态'
        select '已验证', from: 'audit_work_order_verification_status'
        fill_in 'audit_work_order_comment', with: '验证通过'
        click_button '提交'
      end
    end
    
    # 7. 对第二个费用明细创建沟通工单
    within('#fee_details') do
      within('tr', text: '餐饮费') do
        click_link '创建沟通工单'
        select 'email', from: 'communication_method'
        select 'auditor', from: 'initiator_role'
        fill_in 'content', with: '餐饮费金额较大，需要确认'
        check "fee_detail_ids_#{FeeDetail.find_by(fee_type: '餐饮费').id}"
        click_button '创建沟通工单'
      end
    end
    
    expect(page).to have_content('沟通工单已创建')
    
    # 8. 处理沟通工单
    click_link '开始沟通'
    
    click_link '添加沟通记录'
    fill_in 'communication_record_content', with: '已与申请人沟通，确认餐饮费金额正确'
    select '审核人', from: 'communication_record_communicator_role'
    select '邮件', from: 'communication_record_communication_method'
    click_button '添加记录'
    
    expect(page).to have_content('沟通记录已添加')
    
    # 9. 更新费用明细问题备注
    within('#fee_details') do
      within('tr', text: '餐饮费') do
        click_link '添加/更新解决备注'
        fill_in 'resolution', with: '已与申请人确认，餐饮费金额正确，为团队聚餐'
        click_button '更新备注'
      end
    end
    
    expect(page).to have_content('费用明细问题备注已更新')
    
    # 10. 解决沟通工单
    click_link '标记已解决'
    fill_in 'resolution_summary', with: '问题已解决'
    click_button '确认已解决'
    
    expect(page).to have_content('工单已标记为已解决')
    
    # 11. 关闭沟通工单
    click_link '关闭'
    expect(page).to have_content('工单已关闭')
    
    # 12. 返回审核工单
    visit admin_audit_work_orders_path
    
    within('table tbody tr', text: 'R20250101002') do
      click_link '查看'
    end
    
    # 13. 手动更新费用明细状态
    within('#fee_details') do
      within('tr', text: '餐饮费') do
        click_link '更新验证状态'
        select '已验证', from: 'audit_work_order_verification_status'
        fill_in 'audit_work_order_comment', with: '沟通后确认无误'
        click_button '提交'
      end
    end
    
    expect(page).to have_content('费用明细状态已更新')
    
    # 14. 审核通过
    click_link '审核通过'
    fill_in 'comment', with: '审核通过'
    click_button '确认通过'
    
    expect(page).to have_content('审核已通过')
    
    # 15. 完成审核工单
    click_link '完成'
    expect(page).to have_content('工单已完成')
    
    # 16. 验证最终状态
    visit admin_reimbursements_path
    
    within('table tbody tr', text: 'R20250101002') do
      click_link '查看'
    end
    
    # 验证审核工单状态
    within('#audit_work_orders') do
      expect(page).to have_content('completed')
    end
    
    # 验证沟通工单状态
    within('#communication_work_orders') do
      expect(page).to have_content('closed')
    end
    
    # 验证费用明细状态
    within('#fee_details') do
      expect(page).to have_content('verified')
    end
  end
end
```

### 4. 实现非电子发票报销流程测试

创建 `spec/system/non_electronic_workflow_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "非电子发票报销流程", type: :system do
  let!(:admin_user) { create(:admin_user, email: 'admin@example.com', password: 'password') }
  
  before do
    login_as_admin
  end
  
  scenario "直接创建审核工单并处理" do
    # 1. 导入报销单（非电子发票）
    visit new_import_admin_reimbursements_path
    
    reimbursement_file = create_test_xlsx([
      ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签'],
      ['R20250101003', '测试报销单', '王五', 'EMP003', '测试公司', '测试部门', '3000.00', '', '', '', '2025-01-01', '']
    ])
    
    attach_file('file', reimbursement_file)
    click_button '导入'
    
    expect(page).to have_content('导入成功')
    
    # 2. 导入费用明细
    visit new_import_admin_fee_details_path
    
    fee_detail_file = create_test_xlsx([
      ['报销单单号', '费用类型', '原始金额', '币种', '费用发生日期', '支付方式'],
      ['R20250101003', '交通费', '300.00', 'CNY', '2025-01-01', '现金'],
      ['R20250101003', '餐饮费', '200.00', 'CNY', '2025-01-01', '现金']
    ])
    
    attach_file('file', fee_detail_file)
    click_button '导入'
    
    expect(page).to have_content('导入成功')
    
    # 3. 验证自动创建的审核工单
    visit admin_audit_work_orders_path
    
    within('table tbody tr', text: 'R20250101003') do
      expect(page).to have_content('pending')
      click_link '查看'
    end
    
    # 4. 处理审核工单
    click_link '开始处理'
    click_link '开始审核'
    
    # 5. 验证费用明细
    within('#fee_details') do
      all('tr').each do |row|
        within(row) do
          if has_content?('交通费') || has_content?('餐饮费')
            click_link '更新验证状态'
            select '已验证', from: 'audit_work_order_verification_status'
            fill_in 'audit_work_order_comment', with: '验证通过'
            click_button '提交'
          end
        end
      end
    end
    
    # 6. 审核通过
    click_link '审核通过'
    fill_in 'comment', with: '审核通过'
    click_button '确认通过'
    
    expect(page).to have_content('审核已通过')
    
    # 7. 完成审核工单
    click_link '完成'
    expect(page).to have_content('工单已完成')
    
    # 8. 验证最终状态
    visit admin_reimbursements_path
    
    within('table tbody tr', text: 'R20250101003') do
      click_link '查看'
    end
    
    # 验证审核工单状态
    within('#audit_work_orders') do
      expect(page).to have_content('completed')
    end
    
    # 验证费用明细状态
    within('#fee_details') do
      expect(page).to have_content('verified')
    end
  end
end
```

### 5. 实现操作历史影响报销单状态测试

创建 `spec/system/operation_history_impact_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe "操作历史影响报销单状态", type: :system do
  let!(:admin_user) { create(:admin_user, email: 'admin@example.com', password: 'password') }
  
  before do
    login_as_admin
  end
  
  scenario "导入操作历史更新报销单状态" do
    # 1. 导入报销单
    visit new_import_admin_reimbursements_path
    
    reimbursement_file = create_test_xlsx([
      ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签'],
      ['R20250101004', '测试报销单', '赵六', 'EMP004', '测试公司', '测试部门', '4000.00', '', 'processing', '', '2025-01-01', '']
    ])
    
    attach_file('file', reimbursement_file)
    click_button '导入'
    
    expect(page).to have_content('导入成功')
    
    # 2. 验证初始状态
    visit admin_reimbursements_path
    
    within('table tbody tr', text: 'R20250101004') do
      expect(page).to have_content('processing') # 报销单状态
      expect(page).not_to have_content('closed') # 报销单未关闭
      click_link '查看'
    end
    
    expect(page).to have_content('processing') # 报销单状态
    expect(page).not_to have_content('closed') # 报销单未关闭
    
    # 3. 导入操作历史
    visit new_import_admin_operation_histories_path
    
    operation_history_file = create_test_xlsx([
      ['单据编号', '操作类型', '操作日期', '操作人', '操作意见'],
      ['R20250101004', '审批通过', '2025-01-01', '张三', '审批通过'],
      ['R20250101004', '已付款', '2025-01-02', '李四', '已付款']
    ])
    
    attach_file('file', operation_history_file)
    click_button '导入'
    
    expect(page).to have_content('导入成功')
    
    # 4. 验证报销单状态更新
    visit admin_reimbursements_path
    
    within('table tbody tr', text: 'R20250101004') do
      expect(page).to have_content('closed') # 报销单状态已更新
      click_link '查看'
    end
    
    expect(page).to have_content('closed') # 报销单状态已更新
    
    # 5. 验证操作历史记录
    within('#operation_histories') do
      expect(page).to have_content('审批通过')
      expect(page).to have_content('已付款')
    end
    
    # 6. 验证报销单完成状态
    expect(page).to have_content('is_complete: true') # 报销单已完成
  end
  
  scenario "报销单关闭后不能更新费用明细状态" do
    # 1. 导入报销单
    visit new_import_admin_reimbursements_path
    
    reimbursement_file = create_test_xlsx([
      ['报销单单号', '单据名称', '报销单申请人', '报销单申请人工号', '申请人公司', '申请人部门', '报销金额（单据币种）', '收单状态', '报销单状态', '收单日期', '提交报销日期', '单据标签'],
      ['R20250101005', '测试报销单', '钱七', 'EMP005', '测试公司', '测试部门', '5000.00', '', 'processing', '', '2025-01-01', '']
    ])
    
    attach_file('file', reimbursement_file)
    click_button '导入'
    
    # 2. 导入费用明细
    visit new_import_admin_fee_details_path
    
    fee_detail_file = create_test_xlsx([
      ['报销单单号', '费用类型', '原始金额', '币种', '费用发生日期', '支付方式'],
      ['R20250101005', '交通费', '500.00', 'CNY', '2025-01-01', '现金']
    ])
    
    attach_file('file', fee_detail_file)
    click_button '导入'
    
    # 3. 导入操作历史关闭报销单
    visit new_import_admin_operation_histories_path
    
    operation_history_file = create_test_xlsx([
      ['单据编号', '操作类型', '操作日期', '操作人', '操作意见'],
      ['R20250101005', '已付款', '2025-01-02', '李四', '已付款']
    ])
    
    attach_file('file', operation_history_file)
    click_button '导入'
    
    # 4. 尝试更新费用明细状态
    visit admin_audit_work_orders_path
    
    within('table tbody tr', text: 'R20250101005') do
      click_link '查看'
    end
    
    within('#fee_details') do
      within('tr', text: '交通费') do
        click_link '更新验证状态'
        select '已验证', from: 'audit_work_order_verification_status'
        fill_in 'audit_work_order_comment', with: '验证通过'
        click_button '提交'
      end
    end
    
    # 5. 验证更新失败
    expect(page).to have_content('关联报销单已关闭，无法修改费用明细状态')
    
    # 6. 验证费用明细状态未变
    visit admin_fee_details_path
    
    within('table tbody tr', text: 'R20250101005') do
      expect(page).to have_content('pending') # 状态未变
    end
  end
end
```

## 测试验证方法

1. 运行所有系统测试：`bundle exec rspec spec/system`
2. 运行特定系统测试：`bundle exec rspec spec/system/complete_workflow_spec.rb`
3. 运行特定测试场景：`bundle exec rspec spec/system/complete_workflow_spec.rb:10`

## 注意事项

1. 确保测试覆盖所有关键业务流程
2. 特别关注状态流转逻辑，确保状态转换正确
3. 特别关注费用明细验证逻辑，确保沟通工单解决后状态不自动更新
4. 特别关注操作历史对报销单状态的影响
5. 使用 Capybara 模拟用户交互，确保界面功能正确
6. 使用 DatabaseCleaner 确保测试之间的数据隔离
7. 考虑使用 SimpleCov 监控测试覆盖率
8. 确保测试场景覆盖边缘情况，如报销单关闭后的验证限制
9. 系统测试运行较慢，可以使用 `--tag focus` 标记重点测试场景
10. 使用 `driven_by :selenium_chrome_headless` 在无头浏览器中运行测试，提高效率