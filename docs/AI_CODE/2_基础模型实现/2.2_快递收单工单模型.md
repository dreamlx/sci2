# 快递收单工单模型实现

## 任务描述

实现快递收单工单（ExpressReceiptWorkOrder）模型，包括定义模型属性和验证、实现与报销单的关联关系、使用 AASM 实现状态机、实现状态变更记录功能以及实现完成后创建审核工单的功能。

## 输入和依赖

- 已完成的数据库迁移
- 已实现的报销单模型
- 数据库结构设计文档 (`docs/refactoring/02_database_structure.md`)
- 模型实现设计文档 (`docs/refactoring/03_model_implementation.md`)

## 期望输出

完整的快递收单工单模型实现，包括：
- 模型属性和验证
- 与报销单的关联关系
- AASM 状态机实现
- 状态变更记录功能
- 完成后创建审核工单的功能
- ActiveAdmin 配置

## 详细实现步骤

### 1. 创建快递收单工单模型

创建 `app/models/express_receipt_work_order.rb` 文件：

```ruby
# app/models/express_receipt_work_order.rb
class ExpressReceiptWorkOrder < ApplicationRecord
  # 关联
  belongs_to :reimbursement
  has_one :audit_work_order
  has_many :work_order_status_changes, as: :work_order, dependent: :destroy
  
  # 验证
  validates :status, presence: true, inclusion: { in: %w[received processed completed] }
  validates :tracking_number, presence: true
  
  # 回调
  after_save :record_status_change, if: :saved_change_to_status?
  
  # 状态机
  include AASM
  
  aasm column: 'status' do
    state :received, initial: true
    state :processed
    state :completed
    
    event :process do
      transitions from: :received, to: :processed
    end
    
    event :complete do
      transitions from: :processed, to: :completed
      after do
        create_audit_work_order
      end
    end
  end
  
  # 方法
  def create_audit_work_order
    AuditWorkOrder.create!(
      reimbursement: reimbursement,
      express_receipt_work_order: self,
      status: 'pending',
      created_by: created_by
    )
  end
  
  private
  
  def record_status_change
    if saved_change_to_status?
      old_status, new_status = saved_change_to_status
      work_order_status_changes.create(
        work_order_type: 'express_receipt',
        from_status: old_status,
        to_status: new_status,
        changed_at: Time.current,
        changed_by: Current.admin_user&.id
      )
    end
  end
  
  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id reimbursement_id status tracking_number received_at courier_name created_by created_at updated_at]
  end
  
  def self.ransackable_associations(auth_object = nil)
    %w[reimbursement audit_work_order work_order_status_changes]
  end
end
```

### 2. 创建快递收单工单工厂（用于测试）

创建 `spec/factories/express_receipt_work_orders.rb` 文件：

```ruby
# spec/factories/express_receipt_work_orders.rb
FactoryBot.define do
  factory :express_receipt_work_order do
    association :reimbursement
    status { "received" }
    tracking_number { "SF#{rand(10**10)}" }
    received_at { Time.current }
    courier_name { ["顺丰", "圆通", "中通", "申通", "韵达"].sample }
    created_by { 1 }
    
    trait :processed do
      status { "processed" }
    end
    
    trait :completed do
      status { "completed" }
    end
  end
end
```

### 3. 创建快递收单工单模型测试

创建 `spec/models/express_receipt_work_order_spec.rb` 文件：

```ruby
# spec/models/express_receipt_work_order_spec.rb
require 'rails_helper'

RSpec.describe ExpressReceiptWorkOrder, type: :model do
  describe "validations" do
    it { should validate_presence_of(:status) }
    it { should validate_inclusion_of(:status).in_array(%w[received processed completed]) }
    it { should validate_presence_of(:tracking_number) }
  end
  
  describe "associations" do
    it { should belong_to(:reimbursement) }
    it { should have_one(:audit_work_order) }
    it { should have_many(:work_order_status_changes).dependent(:destroy) }
  end
  
  describe "state machine" do
    let(:work_order) { create(:express_receipt_work_order) }
    
    context "when in received state" do
      it "can transition to processed" do
        expect(work_order.status).to eq("received")
        expect(work_order).to allow_event(:process)
        expect(work_order).not_to allow_event(:complete)
      end
      
      it "changes status to processed after process event" do
        work_order.process!
        expect(work_order.status).to eq("processed")
      end
    end
    
    context "when in processed state" do
      let(:work_order) { create(:express_receipt_work_order, :processed) }
      
      it "can transition to completed" do
        expect(work_order.status).to eq("processed")
        expect(work_order).to allow_event(:complete)
        expect(work_order).not_to allow_event(:process)
      end
      
      it "changes status to completed after complete event" do
        work_order.complete!
        expect(work_order.status).to eq("completed")
      end
      
      it "creates an audit work order after complete event" do
        expect { work_order.complete! }.to change(AuditWorkOrder, :count).by(1)
        
        audit_work_order = work_order.audit_work_order
        expect(audit_work_order.status).to eq("pending")
        expect(audit_work_order.reimbursement).to eq(work_order.reimbursement)
        expect(audit_work_order.express_receipt_work_order).to eq(work_order)
      end
    end
  end
  
  describe "callbacks" do
    let(:work_order) { create(:express_receipt_work_order) }
    
    context "when status changes" do
      before do
        allow(Current).to receive(:admin_user).and_return(double(id: 1))
      end
      
      it "records status change" do
        expect { work_order.process! }.to change(WorkOrderStatusChange, :count).by(1)
        
        status_change = work_order.work_order_status_changes.last
        expect(status_change.work_order_type).to eq("express_receipt")
        expect(status_change.from_status).to eq("received")
        expect(status_change.to_status).to eq("processed")
        expect(status_change.changed_by).to eq(1)
      end
    end
  end
  
  describe "#create_audit_work_order" do
    let(:work_order) { create(:express_receipt_work_order, :processed, created_by: 1) }
    
    it "creates an audit work order" do
      expect { work_order.create_audit_work_order }.to change(AuditWorkOrder, :count).by(1)
      
      audit_work_order = work_order.audit_work_order
      expect(audit_work_order.status).to eq("pending")
      expect(audit_work_order.reimbursement).to eq(work_order.reimbursement)
      expect(audit_work_order.express_receipt_work_order).to eq(work_order)
      expect(audit_work_order.created_by).to eq(1)
    end
  end
end
```

### 4. 实现 ActiveAdmin 资源

创建 `app/admin/express_receipt_work_orders.rb` 文件：

```ruby
# app/admin/express_receipt_work_orders.rb
ActiveAdmin.register ExpressReceiptWorkOrder do
  # 权限控制
  permit_params :reimbursement_id, :status, :tracking_number, :received_at, :courier_name, :created_by
  
  # 菜单设置
  menu priority: 2, label: "快递收单工单"
  
  # 过滤器
  filter :reimbursement_id
  filter :tracking_number
  filter :status, as: :select, collection: ["received", "processed", "completed"]
  filter :received_at
  filter :created_at
  
  # 批量操作
  batch_action :process do |ids|
    batch_action_collection.find(ids).each do |work_order|
      ExpressReceiptWorkOrderService.new(work_order, current_admin_user).process
    end
    redirect_to collection_path, notice: "已将选中的工单标记为已处理"
  end
  
  batch_action :complete do |ids|
    batch_action_collection.find(ids).each do |work_order|
      ExpressReceiptWorkOrderService.new(work_order, current_admin_user).complete
    end
    redirect_to collection_path, notice: "已将选中的工单标记为已完成"
  end
  
  # 自定义操作
  action_item :process, only: :show, if: proc { resource.status == "received" } do
    link_to "处理", process_admin_express_receipt_work_order_path(resource), method: :put
  end
  
  action_item :complete, only: :show, if: proc { resource.status == "processed" } do
    link_to "完成", complete_admin_express_receipt_work_order_path(resource), method: :put
  end
  
  # 自定义页面
  member_action :process, method: :put do
    service = ExpressReceiptWorkOrderService.new(resource, current_admin_user)
    if service.process
      redirect_to admin_express_receipt_work_order_path(resource), notice: "工单已处理"
    else
      redirect_to admin_express_receipt_work_order_path(resource), alert: "操作失败"
    end
  end
  
  member_action :complete, method: :put do
    service = ExpressReceiptWorkOrderService.new(resource, current_admin_user)
    if service.complete
      redirect_to admin_express_receipt_work_order_path(resource), notice: "工单已完成"
    else
      redirect_to admin_express_receipt_work_order_path(resource), alert: "操作失败"
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :reimbursement do |work_order|
      link_to work_order.reimbursement.invoice_number, admin_reimbursement_path(work_order.reimbursement)
    end
    column :tracking_number
    column :status do |work_order|
      status_tag work_order.status
    end
    column :received_at
    column :courier_name
    column :created_at
    actions
  end
  
  # 详情页
  show do
    attributes_table do
      row :id
      row :reimbursement do |work_order|
        link_to work_order.reimbursement.invoice_number, admin_reimbursement_path(work_order.reimbursement)
      end
      row :tracking_number
      row :status do |work_order|
        status_tag work_order.status
      end
      row :received_at
      row :courier_name
      row :created_by
      row :created_at
      row :updated_at
    end
    
    panel "状态变更历史" do
      table_for resource.work_order_status_changes.order(changed_at: :desc) do
        column :from_status
        column :to_status
        column :changed_at
        column :changed_by
      end
    end
    
    panel "关联的审核工单" do
      if resource.audit_work_order.present?
        attributes_table_for resource.audit_work_order do
          row :id do |work_order|
            link_to work_order.id, admin_audit_work_order_path(work_order)
          end
          row :status do |work_order|
            status_tag work_order.status
          end
          row :created_at
        end
      else
        para "暂无关联的审核工单"
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "快递收单工单信息" do
      f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }
      f.input :status, as: :select, collection: ["received", "processed", "completed"]
      f.input :tracking_number
      f.input :received_at, as: :datepicker
      f.input :courier_name
      f.input :created_by, input_html: { value: current_admin_user.id }, as: :hidden
    end
    f.actions
  end
end
```

### 5. 创建 Current 类（如果尚未创建）

确保 `app/models/current.rb` 文件存在：

```ruby
# app/models/current.rb
class Current < ActiveSupport::CurrentAttributes
  attribute :admin_user
end
```

### 6. 创建 WorkOrderStatusChange 模型（如果尚未创建）

创建 `app/models/work_order_status_change.rb` 文件：

```ruby
# app/models/work_order_status_change.rb
class WorkOrderStatusChange < ApplicationRecord
  # 验证
  validates :work_order_type, presence: true
  validates :work_order_id, presence: true
  validates :to_status, presence: true
  validates :changed_at, presence: true
  
  # 范围
  scope :for_express_receipt_work_orders, -> { where(work_order_type: 'express_receipt') }
  scope :for_audit_work_orders, -> { where(work_order_type: 'audit') }
  scope :for_communication_work_orders, -> { where(work_order_type: 'communication') }
  
  # 多态关联
  belongs_to :work_order, polymorphic: true, optional: true
  
  # 方法
  def work_order
    case work_order_type
    when 'express_receipt'
      ExpressReceiptWorkOrder.find_by(id: work_order_id)
    when 'audit'
      AuditWorkOrder.find_by(id: work_order_id)
    when 'communication'
      CommunicationWorkOrder.find_by(id: work_order_id)
    end
  end
  
  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id work_order_type work_order_id from_status to_status changed_at changed_by created_at updated_at]
  end
  
  def self.ransackable_associations(auth_object = nil)
    %w[work_order]
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/models/express_receipt_work_order_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试模型功能：
   ```ruby
   # 创建报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false
   )
   
   # 创建快递收单工单
   work_order = ExpressReceiptWorkOrder.create!(
     reimbursement: reimbursement,
     status: "received",
     tracking_number: "SF1234567890",
     received_at: Time.current,
     courier_name: "顺丰",
     created_by: 1
   )
   
   # 测试状态转换
   work_order.process!
   work_order.status # 应该返回 "processed"
   
   # 测试完成后创建审核工单
   work_order.complete!
   work_order.status # 应该返回 "completed"
   work_order.audit_work_order # 应该返回一个审核工单实例
   
   # 测试状态变更记录
   work_order.work_order_status_changes.count # 应该返回 2
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试快递收单工单管理功能

## 注意事项

1. 确保 AASM 状态机正确配置，特别是状态转换和回调
2. 确保状态变更记录功能正确实现
3. 确保完成后创建审核工单的功能正确实现
4. 确保与报销单的关联关系正确设置
5. 确保 ActiveAdmin 配置正确，特别是自定义操作和批量操作