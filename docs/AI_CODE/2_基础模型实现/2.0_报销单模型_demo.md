# 报销单模型实现

## 任务描述

实现报销单（Reimbursement）模型，作为工单系统的核心数据模型之一。报销单模型存储报销单的基本信息，并与各类工单建立关联关系。

## 输入和依赖

- 数据库迁移脚本（已创建的报销单表）
- 模型实现设计文档 (`docs/refactoring/03_model_implementation.md`)

## 期望输出

完整的报销单模型实现，包括：
- 模型属性和验证
- 与其他模型的关联关系
- 业务方法
- 作用域和查询方法
- ActiveAdmin 配置

## 详细实现步骤

### 1. 创建报销单模型

创建 `app/models/reimbursement.rb` 文件：

```ruby
class Reimbursement < ApplicationRecord
  # 关联
  has_many :express_receipt_work_orders, dependent: :destroy
  has_many :audit_work_orders, dependent: :destroy
  has_many :communication_work_orders, dependent: :destroy
  has_many :fee_details, foreign_key: 'document_number', primary_key: 'invoice_number'

  # 验证
  validates :invoice_number, presence: true, uniqueness: true
  validates :document_name, presence: true
  validates :applicant, presence: true
  validates :applicant_id, presence: true

  # 范围
  scope :electronic, -> { where(is_electronic: true) }
  scope :non_electronic, -> { where(is_electronic: false) }
  scope :completed, -> { where(is_complete: true) }
  scope :pending, -> { where(is_complete: false) }
  scope :received, -> { where(receipt_status: 'received') }
  scope :not_received, -> { where(receipt_status: 'pending') }

  # 方法
  def mark_as_received(receipt_date = Time.current)
    update(receipt_status: 'received', receipt_date: receipt_date)
  end

  def mark_as_complete
    update(is_complete: true, reimbursement_status: 'closed')
  end

  # 获取最新的审核工单
  def latest_audit_work_order
    audit_work_orders.order(created_at: :desc).first
  end

  # 获取最新的快递收单工单
  def latest_express_receipt_work_order
    express_receipt_work_orders.order(created_at: :desc).first
  end

  # 获取未完成的沟通工单
  def pending_communication_work_orders
    communication_work_orders.where.not(status: ['resolved', 'unresolved', 'closed'])
  end

  # 获取费用明细总金额
  def total_fee_amount
    fee_details.sum(:amount)
  end

  # 获取已验证的费用明细总金额
  def verified_fee_amount
    fee_details.where(verification_status: 'verified').sum(:amount)
  end

  # 获取已拒绝的费用明细总金额
  def rejected_fee_amount
    fee_details.where(verification_status: 'rejected').sum(:amount)
  end

  # 获取待验证的费用明细总金额
  def pending_fee_amount
    fee_details.where(verification_status: ['pending', 'problematic']).sum(:amount)
  end

  # 检查是否所有费用明细都已验证
  def all_fees_verified?
    fee_details.where.not(verification_status: ['verified', 'rejected']).count.zero?
  end

  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id invoice_number document_name applicant applicant_id company department receipt_status reimbursement_status amount is_electronic is_complete created_at updated_at]
  end

  def self.ransackable_associations(auth_object = nil)
    %w[express_receipt_work_orders audit_work_orders communication_work_orders fee_details]
  end
end
```

### 2. 创建报销单工厂

创建 `spec/factories/reimbursements.rb` 文件：

```ruby
FactoryBot.define do
  factory :reimbursement do
    sequence(:invoice_number) { |n| "R#{Time.current.strftime('%Y%m%d')}#{n.to_s.rjust(3, '0')}" }
    document_name { "测试报销单" }
    applicant { "张三" }
    applicant_id { "EMP001" }
    company { "测试公司" }
    department { "测试部门" }
    amount { 1000.00 }
    receipt_status { "pending" }
    reimbursement_status { "pending" }
    is_electronic { false }
    is_complete { false }

    trait :electronic do
      is_electronic { true }
    end

    trait :received do
      receipt_status { "received" }
      receipt_date { Time.current }
    end

    trait :completed do
      is_complete { true }
      reimbursement_status { "closed" }
    end
  end
end
```

### 3. 创建报销单模型测试

创建 `spec/models/reimbursement_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe Reimbursement, type: :model do
  describe "validations" do
    it { should validate_presence_of(:invoice_number) }
    it { should validate_uniqueness_of(:invoice_number) }
    it { should validate_presence_of(:document_name) }
    it { should validate_presence_of(:applicant) }
    it { should validate_presence_of(:applicant_id) }
  end

  describe "associations" do
    it { should have_many(:express_receipt_work_orders).dependent(:destroy) }
    it { should have_many(:audit_work_orders).dependent(:destroy) }
    it { should have_many(:communication_work_orders).dependent(:destroy) }
    it { should have_many(:fee_details) }
  end

  describe "scopes" do
    before do
      create(:reimbursement, is_electronic: true)
      create(:reimbursement, is_electronic: false)
      create(:reimbursement, is_complete: true)
      create(:reimbursement, receipt_status: 'received')
    end

    it "returns electronic reimbursements" do
      expect(Reimbursement.electronic.count).to eq(1)
    end

    it "returns non-electronic reimbursements" do
      expect(Reimbursement.non_electronic.count).to eq(3)
    end

    it "returns completed reimbursements" do
      expect(Reimbursement.completed.count).to eq(1)
    end

    it "returns pending reimbursements" do
      expect(Reimbursement.pending.count).to eq(3)
    end

    it "returns received reimbursements" do
      expect(Reimbursement.received.count).to eq(1)
    end

    it "returns not received reimbursements" do
      expect(Reimbursement.not_received.count).to eq(3)
    end
  end

  describe "methods" do
    let(:reimbursement) { create(:reimbursement) }

    describe "#mark_as_received" do
      it "updates receipt_status and receipt_date" do
        reimbursement.mark_as_received
        expect(reimbursement.receipt_status).to eq('received')
        expect(reimbursement.receipt_date).not_to be_nil
      end
    end

    describe "#mark_as_complete" do
      it "updates is_complete and reimbursement_status" do
        reimbursement.mark_as_complete
        expect(reimbursement.is_complete).to be_truthy
        expect(reimbursement.reimbursement_status).to eq('closed')
      end
    end

    describe "fee amount calculations" do
      before do
        create(:fee_detail, document_number: reimbursement.invoice_number, amount: 100, verification_status: 'verified')
        create(:fee_detail, document_number: reimbursement.invoice_number, amount: 200, verification_status: 'rejected')
        create(:fee_detail, document_number: reimbursement.invoice_number, amount: 300, verification_status: 'pending')
        create(:fee_detail, document_number: reimbursement.invoice_number, amount: 400, verification_status: 'problematic')
      end

      it "calculates total fee amount" do
        expect(reimbursement.total_fee_amount).to eq(1000)
      end

      it "calculates verified fee amount" do
        expect(reimbursement.verified_fee_amount).to eq(100)
      end

      it "calculates rejected fee amount" do
        expect(reimbursement.rejected_fee_amount).to eq(200)
      end

      it "calculates pending fee amount" do
        expect(reimbursement.pending_fee_amount).to eq(700)
      end

      it "checks if all fees are verified" do
        expect(reimbursement.all_fees_verified?).to be_falsey
        
        # Update all pending fees to verified
        reimbursement.fee_details.where(verification_status: ['pending', 'problematic']).update_all(verification_status: 'verified')
        
        expect(reimbursement.all_fees_verified?).to be_truthy
      end
    end
  end
end
```

### 4. 创建 ActiveAdmin 资源

创建 `app/admin/reimbursements.rb` 文件（如果尚未创建）：

```ruby
ActiveAdmin.register Reimbursement do
  # 权限控制
  permit_params :invoice_number, :document_name, :applicant, :applicant_id, :company, :department,
                :amount, :receipt_status, :reimbursement_status, :receipt_date, :submission_date,
                :is_electronic, :is_complete

  # 菜单设置
  menu priority: 1, label: "报销单管理"

  # 过滤器
  filter :invoice_number
  filter :applicant
  filter :company
  filter :department
  filter :receipt_status, as: :select, collection: ["pending", "received"]
  filter :reimbursement_status, as: :select, collection: ["pending", "processing", "closed"]
  filter :is_electronic, as: :boolean
  filter :is_complete, as: :boolean
  filter :created_at

  # 批量操作
  batch_action :mark_as_received do |ids|
    batch_action_collection.find(ids).each do |reimbursement|
      reimbursement.mark_as_received
    end
    redirect_to collection_path, notice: "已将选中的报销单标记为已收单"
  end

  # 列表页
  index do
    selectable_column
    id_column
    column :invoice_number
    column :applicant
    column :amount do |reimbursement|
      number_to_currency(reimbursement.amount, unit: "¥")
    end
    column :receipt_status do |reimbursement|
      status_tag reimbursement.receipt_status
    end
    column :reimbursement_status do |reimbursement|
      status_tag reimbursement.reimbursement_status
    end
    column :is_electronic
    column :is_complete
    column :created_at
    actions
  end

  # 详情页
  show do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :invoice_number
          row :document_name
          row :applicant
          row :applicant_id
          row :company
          row :department
          row :amount do |reimbursement|
            number_to_currency(reimbursement.amount, unit: "¥")
          end
          row :receipt_status
          row :reimbursement_status
          row :receipt_date
          row :submission_date
          row :is_electronic
          row :is_complete
          row :created_at
          row :updated_at
        end
      end

      tab "快递收单工单" do
        panel "快递收单工单信息" do
          table_for resource.express_receipt_work_orders do
            column :id
            column :tracking_number
            column :received_at
            column :courier_name
            column :status
            column :created_at
            column "操作" do |work_order|
              links = []
              links << link_to("查看", admin_express_receipt_work_order_path(work_order))
              links.join(" | ").html_safe
            end
          end
        end
      end

      tab "审核工单" do
        panel "审核工单信息" do
          table_for resource.audit_work_orders do
            column :id
            column :status
            column :audit_result
            column :audit_date
            column :created_at
            column "操作" do |work_order|
              links = []
              links << link_to("查看", admin_audit_work_order_path(work_order))
              links.join(" | ").html_safe
            end
          end
        end
      end

      tab "沟通工单" do
        panel "沟通工单信息" do
          table_for resource.communication_work_orders do
            column :id
            column :status
            column :communication_method
            column :initiator_role
            column :created_at
            column "操作" do |work_order|
              links = []
              links << link_to("查看", admin_communication_work_order_path(work_order))
              links.join(" | ").html_safe
            end
          end
        end
      end

      tab "费用明细" do
        panel "费用明细信息" do
          table_for resource.fee_details do
            column :id
            column :fee_type
            column :amount do |fee_detail|
              number_to_currency(fee_detail.amount, unit: "¥")
            end
            column :fee_date
            column :verification_status
            column :created_at
            column "操作" do |fee_detail|
              links = []
              links << link_to("查看", admin_fee_detail_path(fee_detail))
              links.join(" | ").html_safe
            end
          end
        end
      end
    end
  end

  # 表单
  form do |f|
    f.inputs "报销单信息" do
      f.input :invoice_number
      f.input :document_name
      f.input :applicant
      f.input :applicant_id
      f.input :company
      f.input :department
      f.input :amount
      f.input :receipt_status, as: :select, collection: ["pending", "received"]
      f.input :reimbursement_status, as: :select, collection: ["pending", "processing", "closed"]
      f.input :receipt_date, as: :datepicker
      f.input :submission_date, as: :datepicker
      f.input :is_electronic
      f.input :is_complete
    end
    f.actions
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/models/reimbursement_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试模型功能：

```ruby
# 创建报销单
reimbursement = Reimbursement.create!(
  invoice_number: "R20250101001",
  document_name: "测试报销单",
  applicant: "张三",
  applicant_id: "EMP001",
  company: "测试公司",
  department: "测试部门",
  amount: 1000.00
)

# 测试标记为已收单
reimbursement.mark_as_received
puts "收单状态: #{reimbursement.receipt_status}, 收单日期: #{reimbursement.receipt_date}"

# 测试标记为已完成
reimbursement.mark_as_complete
puts "完成状态: #{reimbursement.is_complete}, 报销单状态: #{reimbursement.reimbursement_status}"

# 测试作用域
puts "电子报销单数量: #{Reimbursement.electronic.count}"
puts "非电子报销单数量: #{Reimbursement.non_electronic.count}"
puts "已完成报销单数量: #{Reimbursement.completed.count}"
puts "待处理报销单数量: #{Reimbursement.pending.count}"
```

3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试报销单管理功能

## 注意事项

1. 确保 `invoice_number` 字段的唯一性验证正确实现
2. 确保与其他模型的关联关系正确设置，特别是与费用明细的关联
3. 确保业务方法正确实现，特别是 `mark_as_received` 和 `mark_as_complete` 方法
4. 确保作用域和查询方法正确实现，以便在 ActiveAdmin 中使用
5. 确保 ActiveAdmin 配置正确，特别是 `ransackable_attributes` 和 `ransackable_associations` 方法
6. 注意报销单与费用明细的关联是通过 `invoice_number` 和 `document_number` 字段建立的，而不是通过 ID