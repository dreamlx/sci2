# 审核工单模型实现

## 任务描述

实现审核工单（AuditWorkOrder）模型，包括定义模型属性和验证、实现与报销单和快递收单工单的关联关系、使用 AASM 实现状态机、实现状态变更记录功能、实现创建沟通工单的功能以及实现费用明细验证功能。

## 输入和依赖

- 已完成的数据库迁移
- 已实现的报销单模型
- 已实现的快递收单工单模型
- 数据库结构设计文档 (`docs/refactoring/02_database_structure.md`)
- 模型实现设计文档 (`docs/refactoring/03_model_implementation.md`)

## 期望输出

完整的审核工单模型实现，包括：
- 模型属性和验证
- 与报销单和快递收单工单的关联关系
- AASM 状态机实现
- 状态变更记录功能
- 创建沟通工单的功能
- 费用明细验证功能
- ActiveAdmin 配置

## 详细实现步骤

### 1. 创建审核工单模型

创建 `app/models/audit_work_order.rb` 文件：

```ruby
# app/models/audit_work_order.rb
class AuditWorkOrder < ApplicationRecord
  # 关联
  belongs_to :reimbursement
  belongs_to :express_receipt_work_order, optional: true
  has_many :communication_work_orders, dependent: :nullify
  has_many :fee_detail_selections, dependent: :destroy
  has_many :fee_details, through: :fee_detail_selections
  has_many :work_order_status_changes, as: :work_order, dependent: :destroy
  
  # 验证
  validates :status, presence: true, inclusion: { in: %w[pending processing auditing approved rejected needs_communication completed] }
  validates :audit_result, presence: true, if: -> { %w[approved rejected].include?(status) }
  
  # 回调
  after_save :record_status_change, if: :saved_change_to_status?
  
  # 状态机
  include AASM
  
  aasm column: 'status' do
    state :pending, initial: true
    state :processing
    state :auditing
    state :approved
    state :rejected
    state :needs_communication
    state :completed
    
    event :start_processing do
      transitions from: :pending, to: :processing
    end
    
    event :start_audit do
      transitions from: :processing, to: :auditing
    end
    
    event :approve do
      transitions from: :auditing, to: :approved
      after do
        update(
          audit_result: 'approved',
          audit_date: Time.current
        )
      end
    end
    
    event :reject do
      transitions from: [:auditing, :needs_communication], to: :rejected
      after do
        update(
          audit_result: 'rejected',
          audit_date: Time.current
        )
      end
    end
    
    event :need_communication do
      transitions from: :auditing, to: :needs_communication
    end
    
    event :resume_audit do
      transitions from: :needs_communication, to: :auditing
    end
    
    event :complete do
      transitions from: [:approved, :rejected], to: :completed
    end
  end
  
  # 方法
  def create_communication_work_order(params = {})
    comm_order = CommunicationWorkOrder.new(
      reimbursement: reimbursement,
      audit_work_order: self,
      status: 'open',
      created_by: created_by,
      **params
    )
    
    if comm_order.save
      # 如果指定了费用明细ID，则关联这些费用明细
      if params[:fee_detail_ids].present?
        params[:fee_detail_ids].each do |id|
          fee_detail = FeeDetail.find_by(id: id)
          if fee_detail
            # 创建费用明细选择记录
            comm_order.fee_detail_selections.create(
def verify_fee_detail(fee_detail, result = 'verified', comment = nil)
    selection = fee_detail_selections.find_by(fee_detail: fee_detail)
    return false unless selection
    
    selection.update(
      verification_status: result,
      verification_comment: comment,
      verified_by: Current.admin_user&.id,
      verified_at: Time.current
    )
    
    # 同时更新费用明细的状态
    case result
    when 'verified'
      fee_detail.mark_as_verified
    when 'rejected'
      fee_detail.mark_as_rejected
    when 'problematic'
      fee_detail.mark_as_problematic
    end
    
    true
  end
  
  def select_fee_detail(fee_detail)
    fee_detail_selections.find_or_create_by(fee_detail: fee_detail) do |selection|
      selection.verification_status = 'pending'
    end
  end
  
  def select_fee_details(fee_detail_ids)
    fee_detail_ids.each do |id|
      fee_detail = FeeDetail.find_by(id: id)
      select_fee_detail(fee_detail) if fee_detail
    end
  end
  
  private
  
  def record_status_change
    if saved_change_to_status?
      old_status, new_status = saved_change_to_status
      work_order_status_changes.create(
        work_order_type: 'audit',
        from_status: old_status,
        to_status: new_status,
        changed_at: Time.current,
        changed_by: Current.admin_user&.id
      )
    end
  end
  
  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id reimbursement_id express_receipt_work_order_id status audit_result audit_comment audit_date vat_verified created_by created_at updated_at]
  end
  
  def self.ransackable_associations(auth_object = nil)
    %w[reimbursement express_receipt_work_order communication_work_orders fee_detail_selections fee_details work_order_status_changes]
  end
end
```

### 2. 创建审核工单工厂（用于测试）

创建 `spec/factories/audit_work_orders.rb` 文件：

```ruby
# spec/factories/audit_work_orders.rb
FactoryBot.define do
  factory :audit_work_order do
    association :reimbursement
    status { "pending" }
    created_by { 1 }
    
    trait :with_express_receipt_work_order do
      association :express_receipt_work_order
    end
    
    trait :processing do
      status { "processing" }
    end
    
    trait :auditing do
      status { "auditing" }
    end
    
    trait :approved do
      status { "approved" }
      audit_result { "approved" }
      audit_date { Time.current }
    end
    
    trait :rejected do
      status { "rejected" }
      audit_result { "rejected" }
      audit_date { Time.current }
    end
    
    trait :needs_communication do
      status { "needs_communication" }
    end
    
    trait :completed do
      status { "completed" }
      audit_result { "approved" }
      audit_date { Time.current }
    end
  end
end
```
              fee_detail: fee_detail,
              verification_status: 'problematic'
            )
### 3. 创建审核工单模型测试

创建 `spec/models/audit_work_order_spec.rb` 文件：

```ruby
# spec/models/audit_work_order_spec.rb
require 'rails_helper'

RSpec.describe AuditWorkOrder, type: :model do
  describe "validations" do
    it { should validate_presence_of(:status) }
    it { should validate_inclusion_of(:status).in_array(%w[pending processing auditing approved rejected needs_communication completed]) }
    
    context "when status is approved or rejected" do
      it "validates presence of audit_result" do
        work_order = build(:audit_work_order, status: "approved", audit_result: nil)
        expect(work_order).not_to be_valid
        expect(work_order.errors[:audit_result]).to include("can't be blank")
        
        work_order = build(:audit_work_order, status: "rejected", audit_result: nil)
        expect(work_order).not_to be_valid
        expect(work_order.errors[:audit_result]).to include("can't be blank")
      end
    end
  end
  
  describe "associations" do
    it { should belong_to(:reimbursement) }
    it { should belong_to(:express_receipt_work_order).optional }
    it { should have_many(:communication_work_orders).dependent(:nullify) }
    it { should have_many(:fee_detail_selections).dependent(:destroy) }
    it { should have_many(:fee_details).through(:fee_detail_selections) }
    it { should have_many(:work_order_status_changes).dependent(:destroy) }
  end
  
  describe "state machine" do
    let(:work_order) { create(:audit_work_order) }
    
    context "when in pending state" do
      it "can transition to processing" do
        expect(work_order.status).to eq("pending")
        expect(work_order).to allow_event(:start_processing)
        expect(work_order).not_to allow_event(:start_audit)
        expect(work_order).not_to allow_event(:approve)
        expect(work_order).not_to allow_event(:reject)
        expect(work_order).not_to allow_event(:need_communication)
        expect(work_order).not_to allow_event(:resume_audit)
        expect(work_order).not_to allow_event(:complete)
      end
      
      it "changes status to processing after start_processing event" do
        work_order.start_processing!
        expect(work_order.status).to eq("processing")
      end
    end
    
    context "when in processing state" do
      let(:work_order) { create(:audit_work_order, :processing) }
      
      it "can transition to auditing" do
        expect(work_order.status).to eq("processing")
        expect(work_order).to allow_event(:start_audit)
        expect(work_order).not_to allow_event(:start_processing)
        expect(work_order).not_to allow_event(:approve)
        expect(work_order).not_to allow_event(:reject)
        expect(work_order).not_to allow_event(:need_communication)
        expect(work_order).not_to allow_event(:resume_audit)
        expect(work_order).not_to allow_event(:complete)
      end
      
      it "changes status to auditing after start_audit event" do
        work_order.start_audit!
        expect(work_order.status).to eq("auditing")
      end
    end
    
    context "when in auditing state" do
      let(:work_order) { create(:audit_work_order, :auditing) }
      
      it "can transition to approved, rejected, or needs_communication" do
        expect(work_order.status).to eq("auditing")
        expect(work_order).to allow_event(:approve)
        expect(work_order).to allow_event(:reject)
        expect(work_order).to allow_event(:need_communication)
        expect(work_order).not_to allow_event(:start_processing)
        expect(work_order).not_to allow_event(:start_audit)
        expect(work_order).not_to allow_event(:resume_audit)
        expect(work_order).not_to allow_event(:complete)
      end
      
      it "changes status to approved and sets audit_result after approve event" do
        work_order.approve!
        expect(work_order.status).to eq("approved")
        expect(work_order.audit_result).to eq("approved")
        expect(work_order.audit_date).to be_present
      end
      
      it "changes status to rejected and sets audit_result after reject event" do
        work_order.reject!
        expect(work_order.status).to eq("rejected")
        expect(work_order.audit_result).to eq("rejected")
        expect(work_order.audit_date).to be_present
      end
      
      it "changes status to needs_communication after need_communication event" do
        work_order.need_communication!
        expect(work_order.status).to eq("needs_communication")
      end
    end
    
    context "when in needs_communication state" do
      let(:work_order) { create(:audit_work_order, :needs_communication) }
      
      it "can transition to auditing or rejected" do
        expect(work_order.status).to eq("needs_communication")
        expect(work_order).to allow_event(:resume_audit)
        expect(work_order).to allow_event(:reject)
        expect(work_order).not_to allow_event(:start_processing)
        expect(work_order).not_to allow_event(:start_audit)
        expect(work_order).not_to allow_event(:approve)
        expect(work_order).not_to allow_event(:need_communication)
        expect(work_order).not_to allow_event(:complete)
      end
      
      it "changes status to auditing after resume_audit event" do
        work_order.resume_audit!
        expect(work_order.status).to eq("auditing")
      end
      
      it "changes status to rejected after reject event" do
        work_order.reject!
        expect(work_order.status).to eq("rejected")
        expect(work_order.audit_result).to eq("rejected")
        expect(work_order.audit_date).to be_present
      end
    end
    
    context "when in approved state" do
      let(:work_order) { create(:audit_work_order, :approved) }
      
      it "can transition to completed" do
        expect(work_order.status).to eq("approved")
        expect(work_order).to allow_event(:complete)
        expect(work_order).not_to allow_event(:start_processing)
        expect(work_order).not_to allow_event(:start_audit)
        expect(work_order).not_to allow_event(:approve)
        expect(work_order).not_to allow_event(:reject)
        expect(work_order).not_to allow_event(:need_communication)
        expect(work_order).not_to allow_event(:resume_audit)
      end
      
      it "changes status to completed after complete event" do
        work_order.complete!
        expect(work_order.status).to eq("completed")
      end
    end
    
    context "when in rejected state" do
      let(:work_order) { create(:audit_work_order, :rejected) }
      
      it "can transition to completed" do
        expect(work_order.status).to eq("rejected")
        expect(work_order).to allow_event(:complete)
        expect(work_order).not_to allow_event(:start_processing)
        expect(work_order).not_to allow_event(:start_audit)
        expect(work_order).not_to allow_event(:approve)
describe "callbacks" do
    let(:work_order) { create(:audit_work_order) }
    
    context "when status changes" do
      before do
        allow(Current).to receive(:admin_user).and_return(double(id: 1))
      end
      
      it "records status change" do
        expect { work_order.start_processing! }.to change(WorkOrderStatusChange, :count).by(1)
        
        status_change = work_order.work_order_status_changes.last
        expect(status_change.work_order_type).to eq("audit")
        expect(status_change.from_status).to eq("pending")
        expect(status_change.to_status).to eq("processing")
        expect(status_change.changed_by).to eq(1)
      end
    end
  end
  
  describe "#create_communication_work_order" do
    let(:work_order) { create(:audit_work_order, :auditing, created_by: 1) }
    let(:fee_detail) { create(:fee_detail, document_number: work_order.reimbursement.invoice_number) }
    
    before do
      work_order.select_fee_detail(fee_detail)
    end
    
    it "creates a communication work order" do
      expect {
        work_order.create_communication_work_order(
          communication_method: "email",
          initiator_role: "auditor"
        )
      }.to change(CommunicationWorkOrder, :count).by(1)
      
      comm_order = work_order.communication_work_orders.last
      expect(comm_order.status).to eq("open")
      expect(comm_order.communication_method).to eq("email")
      expect(comm_order.initiator_role).to eq("auditor")
      expect(comm_order.reimbursement).to eq(work_order.reimbursement)
      expect(comm_order.created_by).to eq(1)
    end
    
    it "associates fee details with the communication work order" do
      comm_order = work_order.create_communication_work_order(
        communication_method: "email",
        initiator_role: "auditor",
        fee_detail_ids: [fee_detail.id]
      )
      
      expect(comm_order.fee_details).to include(fee_detail)
      selection = comm_order.fee_detail_selections.find_by(fee_detail: fee_detail)
      expect(selection.verification_status).to eq("problematic")
      expect(fee_detail.reload.verification_status).to eq("problematic")
    end
    
    it "updates the audit work order status to needs_communication" do
      work_order.create_communication_work_order(
        communication_method: "email",
        initiator_role: "auditor"
      )
      
      expect(work_order.status).to eq("needs_communication")
    end
  end
  
  describe "#verify_fee_detail" do
    let(:work_order) { create(:audit_work_order) }
    let(:fee_detail) { create(:fee_detail, document_number: work_order.reimbursement.invoice_number) }
    
    before do
      work_order.select_fee_detail(fee_detail)
      allow(Current).to receive(:admin_user).and_return(double(id: 1))
    end
    
    it "updates the fee detail selection verification status" do
      work_order.verify_fee_detail(fee_detail, "verified", "验证通过")
      
      selection = work_order.fee_detail_selections.find_by(fee_detail: fee_detail)
      expect(selection.verification_status).to eq("verified")
      expect(selection.verification_comment).to eq("验证通过")
      expect(selection.verified_by).to eq(1)
      expect(selection.verified_at).to be_present
    end
    
    it "updates the fee detail verification status" do
      work_order.verify_fee_detail(fee_detail, "verified")
      expect(fee_detail.reload.verification_status).to eq("verified")
      
      work_order.verify_fee_detail(fee_detail, "rejected")
      expect(fee_detail.reload.verification_status).to eq("rejected")
      
      work_order.verify_fee_detail(fee_detail, "problematic")
      expect(fee_detail.reload.verification_status).to eq("problematic")
    end
    
    it "returns false if the fee detail is not associated with the work order" do
      other_fee_detail = create(:fee_detail)
      expect(work_order.verify_fee_detail(other_fee_detail, "verified")).to be_falsey
    end
  end
  
  describe "#select_fee_detail" do
    let(:work_order) { create(:audit_work_order) }
    let(:fee_detail) { create(:fee_detail, document_number: work_order.reimbursement.invoice_number) }
    
    it "creates a fee detail selection" do
      expect {
        work_order.select_fee_detail(fee_detail)
      }.to change(FeeDetailSelection, :count).by(1)
      
      selection = work_order.fee_detail_selections.find_by(fee_detail: fee_detail)
      expect(selection.verification_status).to eq("pending")
    end
    
    it "does not create duplicate selections" do
      work_order.select_fee_detail(fee_detail)
      
      expect {
        work_order.select_fee_detail(fee_detail)
      }.not_to change(FeeDetailSelection, :count)
    end
  end
  
  describe "#select_fee_details" do
    let(:work_order) { create(:audit_work_order) }
    let(:fee_details) do
      [
        create(:fee_detail, document_number: work_order.reimbursement.invoice_number),
        create(:fee_detail, document_number: work_order.reimbursement.invoice_number)
      ]
    end
    
    it "creates fee detail selections for multiple fee details" do
      expect {
        work_order.select_fee_details(fee_details.map(&:id))
      }.to change(FeeDetailSelection, :count).by(2)
### 4. 实现 ActiveAdmin 资源

创建 `app/admin/audit_work_orders.rb` 文件：

```ruby
# app/admin/audit_work_orders.rb
ActiveAdmin.register AuditWorkOrder do
  # 权限控制
  permit_params :reimbursement_id, :express_receipt_work_order_id, :status, :audit_result, 
                :audit_comment, :audit_date, :vat_verified, :created_by
  
  # 菜单设置
  menu priority: 3, label: "审核工单"
  
  # 过滤器
  filter :reimbursement_id
  filter :status, as: :select, collection: ["pending", "processing", "auditing", "approved", "rejected", "needs_communication", "completed"]
  filter :audit_result, as: :select, collection: ["approved", "rejected"]
  filter :audit_date
  filter :created_at
  
  # 批量操作
  batch_action :start_processing do |ids|
    batch_action_collection.find(ids).each do |work_order|
      AuditWorkOrderService.new(work_order, current_admin_user).start_processing
    end
    redirect_to collection_path, notice: "已将选中的工单标记为处理中"
  end
  
  # 自定义操作
  action_item :start_processing, only: :show, if: proc { resource.status == "pending" } do
    link_to "开始处理", start_processing_admin_audit_work_order_path(resource), method: :put
  end
  
  action_item :start_audit, only: :show, if: proc { resource.status == "processing" } do
    link_to "开始审核", start_audit_admin_audit_work_order_path(resource), method: :put
  end
  
  action_item :approve, only: :show, if: proc { resource.status == "auditing" } do
    link_to "审核通过", approve_admin_audit_work_order_path(resource)
  end
  
  action_item :reject, only: :show, if: proc { resource.status == "auditing" } do
    link_to "审核拒绝", reject_admin_audit_work_order_path(resource)
  end
  
  action_item :need_communication, only: :show, if: proc { resource.status == "auditing" } do
    link_to "需要沟通", new_communication_admin_audit_work_order_path(resource)
  end
  
  action_item :complete, only: :show, if: proc { ["approved", "rejected"].include?(resource.status) } do
    link_to "完成", complete_admin_audit_work_order_path(resource), method: :put
  end
  
  # 自定义页面
  member_action :start_processing, method: :put do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    if service.start_processing
      redirect_to admin_audit_work_order_path(resource), notice: "工单已开始处理"
    else
      redirect_to admin_audit_work_order_path(resource), alert: "操作失败"
    end
  end
  
  member_action :start_audit, method: :put do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    if service.start_audit
      redirect_to admin_audit_work_order_path(resource), notice: "工单已开始审核"
    else
      redirect_to admin_audit_work_order_path(resource), alert: "操作失败"
    end
  end
  
  member_action :approve, method: :get do
    render "admin/audit_work_orders/approve"
  end
  
  member_action :do_approve, method: :post do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    if service.approve(params[:comment])
      redirect_to admin_audit_work_order_path(resource), notice: "审核已通过"
    else
      redirect_to admin_audit_work_order_path(resource), alert: "操作失败"
    end
  end
  
  member_action :reject, method: :get do
    render "admin/audit_work_orders/reject"
  end
  
  member_action :do_reject, method: :post do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    if service.reject(params[:comment])
      redirect_to admin_audit_work_order_path(resource), notice: "审核已拒绝"
    else
      redirect_to admin_audit_work_order_path(resource), alert: "操作失败"
    end
  end
  
  member_action :new_communication, method: :get do
    @fee_details = resource.reimbursement.fee_details
    render "admin/audit_work_orders/new_communication"
  end
  
  member_action :create_communication, method: :post do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    communication_work_order = service.create_communication_work_order(
      communication_method: params[:communication_method],
      initiator_role: params[:initiator_role],
      content: params[:content],
      fee_detail_ids: params[:fee_detail_ids]
    )
    
    if communication_work_order.persisted?
      redirect_to admin_communication_work_order_path(communication_work_order), notice: "沟通工单已创建"
    else
      redirect_to admin_audit_work_order_path(resource), alert: "创建沟通工单失败"
    end
  end
  
  member_action :complete, method: :put do
    service = AuditWorkOrderService.new(resource, current_admin_user)
    if service.complete
      redirect_to admin_audit_work_order_path(resource), notice: "工单已完成"
    else
      redirect_to admin_audit_work_order_path(resource), alert: "操作失败"
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :reimbursement do |work_order|
      link_to work_order.reimbursement.invoice_number, admin_reimbursement_path(work_order.reimbursement)
    end
    column :status do |work_order|
      status_tag work_order.status
    end
    column :audit_result do |work_order|
      status_tag work_order.audit_result if work_order.audit_result.present?
    end
    column :audit_date
    column :created_at
    actions
  end
  
  # 详情页
  show do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :id
          row :reimbursement do |work_order|
            link_to work_order.reimbursement.invoice_number, admin_reimbursement_path(work_order.reimbursement)
          end
          row :express_receipt_work_order do |work_order|
            if work_order.express_receipt_work_order.present?
              link_to work_order.express_receipt_work_order.id, admin_express_receipt_work_order_path(work_order.express_receipt_work_order)
            end
          end
          row :status do |work_order|
            status_tag work_order.status
          end
          row :audit_result do |work_order|
            status_tag work_order.audit_result if work_order.audit_result.present?
          end
          row :audit_comment
          row :audit_date
          row :vat_verified
          row :created_by
          row :created_at
          row :updated_at
        end
      end
      
      tab "费用明细" do
        panel "费用明细信息" do
          table_for resource.fee_details do
            column :id
            column :fee_type
            column :amount do |fee_detail|
              number_to_currency(fee_detail.amount, unit: "¥")
            end
            column :verification_status do |fee_detail|
              status_tag fee_detail.verification_status
            end
            column "验证状态" do |fee_detail|
              selection = resource.fee_detail_selections.find_by(fee_detail: fee_detail)
              status_tag selection.verification_status if selection.present?
            end
            column "操作" do |fee_detail|
              links = []
              links << link_to("查看", admin_fee_detail_path(fee_detail))
              links << link_to("验证", verify_admin_fee_detail_path(fee_detail, work_order_id: resource.id))
              links << link_to("标记问题", mark_problematic_admin_fee_detail_path(fee_detail, work_order_id: resource.id))
              links.join(" | ").html_safe
            end
          end
        end
      end
      
      tab "沟通工单" do
        panel "沟通工单信息" do
          table_for resource.communication_work_orders do
            column :id
            column :status do |work_order|
              status_tag work_order.status
            end
            column :communication_method
            column :initiator_role
            column :created_at
            column "操作" do |work_order|
              links = []
              links << link_to("查看", admin_communication_work_order_path(work_order))
              links.join(" | ").html_safe
            end
          end
        end
      end
      
      tab "状态变更历史" do
        panel "状态变更历史" do
          table_for resource.work_order_status_changes.order(changed_at: :desc) do
            column :from_status
            column :to_status
            column :changed_at
            column :changed_by
          end
        end
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "审核工单信息" do
      f.input :reimbursement_id, as: :select, collection: Reimbursement.all.map { |r| [r.invoice_number, r.id] }
      f.input :express_receipt_work_order_id, as: :select, collection: ExpressReceiptWorkOrder.all.map { |w| [w.id, w.id] }
      f.input :status, as: :select, collection: ["pending", "processing", "auditing", "approved", "rejected", "needs_communication", "completed"]
      f.input :audit_result, as: :select, collection: ["approved", "rejected"]
      f.input :audit_comment
      f.input :audit_date, as: :datepicker
      f.input :vat_verified
      f.input :created_by, input_html: { value: current_admin_user.id }, as: :hidden
    end
    f.actions
  end
end
```

### 5. 创建审核工单视图模板

创建 `app/views/admin/audit_work_orders/approve.html.erb` 文件：

```erb
<!-- app/views/admin/audit_work_orders/approve.html.erb -->
<h2>审核通过</h2>

<%= form_tag do_approve_admin_audit_work_order_path(@audit_work_order), method: :post do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @audit_work_order.reimbursement.invoice_number %></td>
          </tr>
          <tr>
            <th>申请人</th>
            <td><%= @audit_work_order.reimbursement.applicant %></td>
          </tr>
          <tr>
            <th>审核意见</th>
            <td><%= text_area_tag :comment, nil, rows: 5, cols: 50 %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "确认通过", class: "button" %>
    <%= link_to "取消", admin_audit_work_order_path(@audit_work_order), class: "button" %>
  </div>
<% end %>
```

创建 `app/views/admin/audit_work_orders/reject.html.erb` 文件：

```erb
<!-- app/views/admin/audit_work_orders/reject.html.erb -->
<h2>审核拒绝</h2>

<%= form_tag do_reject_admin_audit_work_order_path(@audit_work_order), method: :post do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @audit_work_order.reimbursement.invoice_number %></td>
          </tr>
          <tr>
            <th>申请人</th>
            <td><%= @audit_work_order.reimbursement.applicant %></td>
          </tr>
          <tr>
            <th>拒绝原因</th>
            <td><%= text_area_tag :comment, nil, rows: 5, cols: 50, required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "确认拒绝", class: "button" %>
    <%= link_to "取消", admin_audit_work_order_path(@audit_work_order), class: "button" %>
  </div>
<% end %>
```

创建 `app/views/admin/audit_work_orders/new_communication.html.erb` 文件：

```erb
<!-- app/views/admin/audit_work_orders/new_communication.html.erb -->
<h2>创建沟通工单</h2>

<%= form_tag create_communication_admin_audit_work_order_path(@audit_work_order), method: :post do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @audit_work_order.reimbursement.invoice_number %></td>
          </tr>
          <tr>
            <th>申请人</th>
            <td><%= @audit_work_order.reimbursement.applicant %></td>
          </tr>
          <tr>
            <th>沟通方式</th>
            <td>
              <%= select_tag :communication_method, options_for_select([
                ["系统", "system"],
                ["邮件", "email"],
                ["电话", "phone"],
                ["其他", "other"]
              ]), required: true %>
            </td>
          </tr>
          <tr>
            <th>发起人角色</th>
            <td>
              <%= select_tag :initiator_role, options_for_select([
                ["审核人", "auditor"],
                ["申请人", "applicant"],
                ["管理员", "admin"],
                ["其他", "other"]
              ]), required: true %>
            </td>
          </tr>
          <tr>
            <th>沟通内容</th>
            <td><%= text_area_tag :content, nil, rows: 5, cols: 50, required: true %></td>
          </tr>
          <tr>
            <th>相关费用明细</th>
            <td>
              <div class="fee-details-selection">
                <% @fee_details.each do |fee_detail| %>
                  <div>
                    <%= check_box_tag "fee_detail_ids[]", fee_detail.id, false, id: "fee_detail_#{fee_detail.id}" %>
                    <%= label_tag "fee_detail_#{fee_detail.id}", "#{fee_detail.fee_type} - #{number_to_currency(fee_detail.amount, unit: '¥')}" %>
                  </div>
                <% end %>
              </div>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "创建沟通工单", class: "button" %>
    <%= link_to "取消", admin_audit_work_order_path(@audit_work_order), class: "button" %>
  </div>
<% end %>
```

## 测试验证方法

1. 运行 `rspec spec/models/audit_work_order_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试模型功能：
   ```ruby
   # 创建报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false
   )
   
   # 创建审核工单
   work_order = AuditWorkOrder.create!(
     reimbursement: reimbursement,
     status: "pending",
     created_by: 1
   )
   
   # 测试状态转换
   work_order.start_processing!
   work_order.status # 应该返回 "processing"
   
   work_order.start_audit!
   work_order.status # 应该返回 "auditing"
   
   # 测试审核通过
   work_order.approve
   work_order.status # 应该返回 "approved"
   work_order.audit_result # 应该返回 "approved"
   
   # 测试完成
   work_order.complete!
   work_order.status # 应该返回 "completed"
   
   # 测试创建沟通工单
   work_order = AuditWorkOrder.create!(
     reimbursement: reimbursement,
     status: "auditing",
     created_by: 1
   )
   
   fee_detail = FeeDetail.create!(
     document_number: reimbursement.invoice_number,
     fee_type: "交通费",
     amount: 100,
     verification_status: "pending"
   )
   
   work_order.select_fee_detail(fee_detail)
   
   comm_order = work_order.create_communication_work_order(
     communication_method: "email",
     initiator_role: "auditor",
     fee_detail_ids: [fee_detail.id]
   )
   
   comm_order.persisted? # 应该返回 true
   comm_order.status # 应该返回 "open"
   work_order.status # 应该返回 "needs_communication"
   fee_detail.reload.verification_status # 应该返回 "problematic"
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试审核工单管理功能

## 注意事项

1. 确保 AASM 状态机正确配置，特别是状态转换和回调
2. 确保状态变更记录功能正确实现
3. 确保创建沟通工单的功能正确实现
4. 确保费用明细验证功能正确实现
5. 确保与报销单和快递收单工单的关联关系正确设置
6. 确保 ActiveAdmin 配置正确，特别是自定义操作和批量操作
      
      expect(work_order.fee_details).to match_array(fee_details)
    end
  end
end
```
        expect(work_order).not_to allow_event(:reject)
        expect(work_order).not_to allow_event(:need_communication)
        expect(work_order).not_to allow_event(:resume_audit)
      end
      
      it "changes status to completed after complete event" do
        work_order.complete!
        expect(work_order.status).to eq("completed")
      end
    end
  end
            
            # 更新费用明细状态
            fee_detail.mark_as_problematic
          end
        end
      end
      
      # 更新自身状态
      need_communication unless status == 'needs_communication'
    end
    
    comm_order
  end