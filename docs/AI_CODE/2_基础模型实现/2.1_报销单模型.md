# 报销单模型实现

## 任务描述

实现报销单（Reimbursement）模型，包括定义模型属性和验证、实现与其他模型的关联关系、实现业务方法以及添加适当的作用域和查询方法。

## 输入和依赖

- 已完成的数据库迁移
- 数据库结构设计文档 (`docs/refactoring/02_database_structure.md`)
- 模型实现设计文档 (`docs/refactoring/03_model_implementation.md`)

## 期望输出

完整的报销单模型实现，包括：
- 模型属性和验证
- 与其他模型的关联关系
- 业务方法
- 作用域和查询方法
- ActiveAdmin 配置

## 详细实现步骤

### 1. 创建报销单模型

创建 `app/models/reimbursement.rb` 文件：

```ruby
# app/models/reimbursement.rb
class Reimbursement < ApplicationRecord
  # 关联
  has_many :express_receipt_work_orders, dependent: :destroy
  has_many :audit_work_orders, dependent: :destroy
  has_many :communication_work_orders, dependent: :destroy
  has_many :fee_details, foreign_key: 'document_number', primary_key: 'invoice_number'
  has_many :operation_histories, foreign_key: 'document_number', primary_key: 'invoice_number'
  
  # 验证
  validates :invoice_number, presence: true, uniqueness: true
  validates :document_name, presence: true
  validates :applicant, presence: true
  validates :applicant_id, presence: true
  
  # 回调
  after_create :create_audit_work_order_if_needed
  
  # 范围
  scope :electronic, -> { where(is_electronic: true) }
  scope :non_electronic, -> { where(is_electronic: false) }
  scope :completed, -> { where(is_complete: true) }
  scope :pending, -> { where(is_complete: false) }
  scope :received, -> { where(receipt_status: 'received') }
  scope :not_received, -> { where(receipt_status: 'pending') }
  
  # 方法
  def mark_as_received(receipt_date = Time.current)
    update(receipt_status: 'received', receipt_date: receipt_date)
  end
  
  def mark_as_complete
    update(is_complete: true, reimbursement_status: 'closed')
  end
  
  def create_audit_work_order(created_by = nil)
    audit_work_orders.create!(
      status: 'pending',
      created_by: created_by
    )
  end
  
  private
  
  def create_audit_work_order_if_needed
    # 如果是非电子发票且没有审核工单，则创建审核工单
    if !is_electronic && audit_work_orders.empty?
      create_audit_work_order
    end
  end
  
  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id invoice_number document_name applicant applicant_id company department receipt_status reimbursement_status amount is_electronic is_complete created_at updated_at]
  end
  
  def self.ransackable_associations(auth_object = nil)
    %w[express_receipt_work_orders audit_work_orders communication_work_orders fee_details operation_histories]
  end
end
```

### 2. 创建报销单工厂（用于测试）

创建 `spec/factories/reimbursements.rb` 文件：

```ruby
# spec/factories/reimbursements.rb
FactoryBot.define do
  factory :reimbursement do
    sequence(:invoice_number) { |n| "R#{Time.current.strftime('%Y%m%d')}#{n.to_s.rjust(3, '0')}" }
    document_name { "测试报销单" }
    applicant { "测试用户" }
    applicant_id { "EMP001" }
    company { "测试公司" }
    department { "测试部门" }
    amount { 1000.00 }
    receipt_status { "pending" }
    reimbursement_status { "pending" }
    is_electronic { false }
    is_complete { false }
    
    trait :electronic do
      is_electronic { true }
    end
    
    trait :received do
      receipt_status { "received" }
      receipt_date { Time.current }
    end
    
    trait :completed do
      is_complete { true }
      reimbursement_status { "closed" }
    end
  end
end
```

### 3. 创建报销单模型测试

创建 `spec/models/reimbursement_spec.rb` 文件：

```ruby
# spec/models/reimbursement_spec.rb
require 'rails_helper'

RSpec.describe Reimbursement, type: :model do
  describe "validations" do
    it { should validate_presence_of(:invoice_number) }
    it { should validate_uniqueness_of(:invoice_number) }
    it { should validate_presence_of(:document_name) }
    it { should validate_presence_of(:applicant) }
    it { should validate_presence_of(:applicant_id) }
  end
  
  describe "associations" do
    it { should have_many(:express_receipt_work_orders).dependent(:destroy) }
    it { should have_many(:audit_work_orders).dependent(:destroy) }
    it { should have_many(:communication_work_orders).dependent(:destroy) }
    it { should have_many(:fee_details) }
    it { should have_many(:operation_histories) }
  end
  
  describe "callbacks" do
    context "when creating a non-electronic reimbursement" do
      it "creates an audit work order" do
        reimbursement = build(:reimbursement, is_electronic: false)
        expect { reimbursement.save }.to change(AuditWorkOrder, :count).by(1)
        
        audit_work_order = reimbursement.audit_work_orders.first
        expect(audit_work_order.status).to eq('pending')
      end
    end
    
    context "when creating an electronic reimbursement" do
      it "does not create an audit work order" do
        reimbursement = build(:reimbursement, is_electronic: true)
        expect { reimbursement.save }.not_to change(AuditWorkOrder, :count)
      end
    end
  end
  
  describe "scopes" do
    before do
      create(:reimbursement, is_electronic: true)
      create(:reimbursement, is_electronic: false)
      create(:reimbursement, is_complete: true)
      create(:reimbursement, receipt_status: 'received')
    end
    
    it "returns electronic reimbursements" do
      expect(Reimbursement.electronic.count).to eq(1)
    end
    
    it "returns non-electronic reimbursements" do
      expect(Reimbursement.non_electronic.count).to eq(3)
    end
    
    it "returns completed reimbursements" do
      expect(Reimbursement.completed.count).to eq(1)
    end
    
    it "returns pending reimbursements" do
      expect(Reimbursement.pending.count).to eq(3)
    end
    
    it "returns received reimbursements" do
      expect(Reimbursement.received.count).to eq(1)
    end
    
    it "returns not received reimbursements" do
      expect(Reimbursement.not_received.count).to eq(3)
    end
  end
  
  describe "#mark_as_received" do
    let(:reimbursement) { create(:reimbursement) }
    
    it "updates receipt status and date" do
      receipt_date = Time.current
      reimbursement.mark_as_received(receipt_date)
      
      expect(reimbursement.receipt_status).to eq('received')
      expect(reimbursement.receipt_date).to be_within(1.second).of(receipt_date)
    end
  end
  
  describe "#mark_as_complete" do
    let(:reimbursement) { create(:reimbursement) }
    
    it "updates complete flag and reimbursement status" do
      reimbursement.mark_as_complete
      
      expect(reimbursement.is_complete).to be_truthy
      expect(reimbursement.reimbursement_status).to eq('closed')
    end
  end
  
  describe "#create_audit_work_order" do
    let(:reimbursement) { create(:reimbursement, is_electronic: true) }
    let(:created_by) { 1 }
    
    it "creates an audit work order" do
      expect { reimbursement.create_audit_work_order(created_by) }.to change(AuditWorkOrder, :count).by(1)
      
      audit_work_order = reimbursement.audit_work_orders.first
      expect(audit_work_order.status).to eq('pending')
      expect(audit_work_order.created_by).to eq(created_by)
    end
  end
end
```

### 4. 实现 ActiveAdmin 资源

创建 `app/admin/reimbursements.rb` 文件：

```ruby
# app/admin/reimbursements.rb
ActiveAdmin.register Reimbursement do
  # 权限控制
  permit_params :invoice_number, :document_name, :applicant, :applicant_id, :company, :department, 
                :amount, :receipt_status, :reimbursement_status, :receipt_date, :submission_date, 
                :is_electronic, :is_complete
  
  # 菜单设置
  menu priority: 1, label: "报销单管理"
  
  # 过滤器
  filter :invoice_number
  filter :applicant
  filter :company
  filter :department
  filter :receipt_status, as: :select, collection: ["pending", "received"]
  filter :reimbursement_status, as: :select, collection: ["pending", "processing", "closed"]
  filter :is_electronic, as: :boolean
  filter :is_complete, as: :boolean
  filter :created_at
  
  # 批量操作
  batch_action :mark_as_received do |ids|
    batch_action_collection.find(ids).each do |reimbursement|
      reimbursement.mark_as_received
    end
    redirect_to collection_path, notice: "已将选中的报销单标记为已收单"
  end
  
  # 自定义操作
  action_item :import, only: :index do
    link_to "导入报销单", new_import_admin_reimbursements_path
  end
  
  # 自定义页面
  collection_action :new_import, method: :get do
    render "admin/reimbursements/new_import"
  end
  
  collection_action :import, method: :post do
    redirect_to admin_reimbursements_path, notice: "导入成功"
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :invoice_number
    column :applicant
    column :amount do |reimbursement|
      number_to_currency(reimbursement.amount, unit: "¥")
    end
    column :receipt_status do |reimbursement|
      status_tag reimbursement.receipt_status
    end
    column :reimbursement_status do |reimbursement|
      status_tag reimbursement.reimbursement_status
    end
    column :is_electronic
    column :is_complete
    column :created_at
    actions
  end
  
  # 详情页
  show do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :invoice_number
          row :document_name
          row :applicant
          row :applicant_id
          row :company
          row :department
          row :amount do |reimbursement|
            number_to_currency(reimbursement.amount, unit: "¥")
          end
          row :receipt_status
          row :reimbursement_status
          row :receipt_date
          row :submission_date
          row :is_electronic
          row :is_complete
          row :created_at
          row :updated_at
        end
      end
      
      tab "快递收单" do
        panel "快递收单信息" do
          table_for resource.express_receipt_work_orders do
            column :id
            column :tracking_number
            column :received_at
            column :courier_name
            column :status
            column :created_at
            column "操作" do |work_order|
              links = []
              links << link_to("查看", admin_express_receipt_work_order_path(work_order))
              links.join(" | ").html_safe
            end
          end
        end
      end
      
      tab "审核工单" do
        panel "审核工单信息" do
          table_for resource.audit_work_orders do
            column :id
            column :status
            column :audit_result
            column :audit_date
            column :created_at
            column "操作" do |work_order|
              links = []
              links << link_to("查看", admin_audit_work_order_path(work_order))
              links.join(" | ").html_safe
            end
          end
        end
      end
      
      tab "沟通工单" do
        panel "沟通工单信息" do
          table_for resource.communication_work_orders do
            column :id
            column :status
            column :communication_method
            column :initiator_role
            column :created_at
            column "操作" do |work_order|
              links = []
              links << link_to("查看", admin_communication_work_order_path(work_order))
              links.join(" | ").html_safe
            end
          end
        end
      end
      
      tab "费用明细" do
        panel "费用明细信息" do
          table_for resource.fee_details do
            column :id
            column :fee_type
            column :amount do |fee_detail|
              number_to_currency(fee_detail.amount, unit: "¥")
            end
            column :fee_date
            column :verification_status
            column :created_at
            column "操作" do |fee_detail|
              links = []
              links << link_to("查看", admin_fee_detail_path(fee_detail))
              links.join(" | ").html_safe
            end
          end
        end
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "报销单信息" do
      f.input :invoice_number
      f.input :document_name
      f.input :applicant
      f.input :applicant_id
      f.input :company
      f.input :department
      f.input :amount
      f.input :receipt_status, as: :select, collection: ["pending", "received"]
      f.input :reimbursement_status, as: :select, collection: ["pending", "processing", "closed"]
      f.input :receipt_date, as: :datepicker
      f.input :submission_date, as: :datepicker
      f.input :is_electronic
      f.input :is_complete
    end
    f.actions
  end
end
```

### 5. 创建导入视图模板

创建 `app/views/admin/reimbursements/new_import.html.erb` 文件：

```erb
<!-- app/views/admin/reimbursements/new_import.html.erb -->
<h2>导入报销单</h2>

<%= form_tag import_admin_reimbursements_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择CSV文件</th>
            <td><%= file_field_tag :file, accept: '.csv' %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_reimbursements_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV文件应包含以下列：</p>
    <ul>
      <li>报销单单号（必填）</li>
      <li>单据名称</li>
      <li>报销单申请人</li>
      <li>报销单申请人工号</li>
      <li>申请人公司</li>
      <li>申请人部门</li>
      <li>报销金额（单据币种）</li>
      <li>收单状态</li>
      <li>报销单状态</li>
      <li>收单日期</li>
      <li>提交报销日期</li>
      <li>单据标签</li>
    </ul>
  </div>
</div>
```

## 测试验证方法

1. 运行 `rspec spec/models/reimbursement_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试模型功能：
   ```ruby
   # 创建报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false
   )
   
   # 验证非电子发票报销单自动创建审核工单
   reimbursement.audit_work_orders.count # 应该返回 1
   
   # 测试标记为已收单
   reimbursement.mark_as_received
   reimbursement.receipt_status # 应该返回 "received"
   
   # 测试标记为已完成
   reimbursement.mark_as_complete
   reimbursement.is_complete # 应该返回 true
   reimbursement.reimbursement_status # 应该返回 "closed"
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试报销单管理功能

## 注意事项

1. 确保 `invoice_number` 字段的唯一性验证正确实现
2. 确保与其他模型的关联关系正确设置
3. 确保非电子发票报销单自动创建审核工单的回调正确实现
4. 确保 ActiveAdmin 配置正确，特别是 `ransackable_attributes` 和 `ransackable_associations` 方法
5. 确保所有业务方法（如 `mark_as_received` 和 `mark_as_complete`）正确实现