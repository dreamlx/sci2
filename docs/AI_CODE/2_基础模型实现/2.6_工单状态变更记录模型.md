# 工单状态变更记录模型实现

## 任务描述

实现工单状态变更记录（WorkOrderStatusChange）模型，用于记录工单状态的变更历史。该模型需要支持多态关联，能够关联到不同类型的工单（快递收单工单、审核工单、沟通工单），并记录状态变更的详细信息。

## 输入和依赖

- 已完成的数据库迁移
- 已实现的快递收单工单、审核工单和沟通工单模型
- 数据库结构设计文档 (`docs/refactoring/02_database_structure.md`)
- 模型实现设计文档 (`docs/refactoring/03_model_implementation.md`)

## 期望输出

完整的工单状态变更记录模型实现，包括：
- 模型属性和验证
- 多态关联关系
- 作用域和查询方法
- ActiveAdmin 配置

## 详细实现步骤

### 1. 创建工单状态变更记录模型

创建 `app/models/work_order_status_change.rb` 文件：

```ruby
# app/models/work_order_status_change.rb
class WorkOrderStatusChange < ApplicationRecord
  # 验证
  validates :work_order_type, presence: true
  validates :work_order_id, presence: true
  validates :to_status, presence: true
  validates :changed_at, presence: true
  
  # 范围
  scope :for_express_receipt_work_orders, -> { where(work_order_type: 'express_receipt') }
  scope :for_audit_work_orders, -> { where(work_order_type: 'audit') }
  scope :for_communication_work_orders, -> { where(work_order_type: 'communication') }
  scope :recent, -> { order(changed_at: :desc) }
  
  # 多态关联
  belongs_to :work_order, polymorphic: true, optional: true
  
  # 方法
  def work_order
    case work_order_type
    when 'express_receipt'
      ExpressReceiptWorkOrder.find_by(id: work_order_id)
    when 'audit'
      AuditWorkOrder.find_by(id: work_order_id)
    when 'communication'
      CommunicationWorkOrder.find_by(id: work_order_id)
    end
  end
  
  def changed_by_user
    AdminUser.find_by(id: changed_by) if changed_by.present?
  end
  
  def status_change_description
    "从 #{from_status || '(新建)'} 变更为 #{to_status}"
  end
  
  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id work_order_type work_order_id from_status to_status changed_at changed_by created_at updated_at]
  end
  
  def self.ransackable_associations(auth_object = nil)
    %w[work_order]
  end
end
```

### 2. 创建工单状态变更记录工厂（用于测试）

创建 `spec/factories/work_order_status_changes.rb` 文件：

```ruby
# spec/factories/work_order_status_changes.rb
FactoryBot.define do
  factory :work_order_status_change do
    work_order_type { ['express_receipt', 'audit', 'communication'].sample }
    work_order_id { 1 }
    from_status { nil }
    to_status { 'pending' }
    changed_at { Time.current }
    changed_by { 1 }
    
    trait :for_express_receipt do
      work_order_type { 'express_receipt' }
      association :work_order, factory: :express_receipt_work_order
      work_order_id { work_order.id }
      from_status { nil }
      to_status { 'received' }
    end
    
    trait :for_audit do
      work_order_type { 'audit' }
      association :work_order, factory: :audit_work_order
      work_order_id { work_order.id }
      from_status { nil }
      to_status { 'pending' }
    end
    
    trait :for_communication do
      work_order_type { 'communication' }
      association :work_order, factory: :communication_work_order
      work_order_id { work_order.id }
      from_status { nil }
      to_status { 'open' }
    end
    
    trait :with_status_change do
      from_status { 'pending' }
      to_status { 'processing' }
    end
  end
end
```

### 3. 创建工单状态变更记录模型测试

创建 `spec/models/work_order_status_change_spec.rb` 文件：

```ruby
# spec/models/work_order_status_change_spec.rb
require 'rails_helper'

RSpec.describe WorkOrderStatusChange, type: :model do
  describe "validations" do
    it { should validate_presence_of(:work_order_type) }
    it { should validate_presence_of(:work_order_id) }
    it { should validate_presence_of(:to_status) }
    it { should validate_presence_of(:changed_at) }
  end
  
  describe "associations" do
    it { should belong_to(:work_order).optional }
  end
  
  describe "scopes" do
    before do
      create(:work_order_status_change, work_order_type: 'express_receipt')
      create(:work_order_status_change, work_order_type: 'audit')
      create(:work_order_status_change, work_order_type: 'communication')
    end
    
    it "returns express receipt work order status changes" do
      expect(WorkOrderStatusChange.for_express_receipt_work_orders.count).to eq(1)
    end
    
    it "returns audit work order status changes" do
      expect(WorkOrderStatusChange.for_audit_work_orders.count).to eq(1)
    end
    
    it "returns communication work order status changes" do
      expect(WorkOrderStatusChange.for_communication_work_orders.count).to eq(1)
    end
    
    it "returns status changes in descending order by changed_at" do
      old_change = create(:work_order_status_change, changed_at: 2.days.ago)
      middle_change = create(:work_order_status_change, changed_at: 1.day.ago)
      new_change = create(:work_order_status_change, changed_at: Time.current)
      
      recent_changes = WorkOrderStatusChange.recent
      expect(recent_changes.first).to eq(new_change)
      expect(recent_changes.second).to eq(middle_change)
      expect(recent_changes.third).to eq(old_change)
    end
  end
  
  describe "#work_order" do
    context "when work_order_type is express_receipt" do
      let(:express_receipt_work_order) { create(:express_receipt_work_order) }
      let(:status_change) { create(:work_order_status_change, work_order_type: 'express_receipt', work_order_id: express_receipt_work_order.id) }
      
      it "returns the associated express receipt work order" do
        expect(status_change.work_order).to eq(express_receipt_work_order)
      end
    end
    
    context "when work_order_type is audit" do
      let(:audit_work_order) { create(:audit_work_order) }
      let(:status_change) { create(:work_order_status_change, work_order_type: 'audit', work_order_id: audit_work_order.id) }
      
      it "returns the associated audit work order" do
        expect(status_change.work_order).to eq(audit_work_order)
      end
    end
    
    context "when work_order_type is communication" do
      let(:communication_work_order) { create(:communication_work_order) }
      let(:status_change) { create(:work_order_status_change, work_order_type: 'communication', work_order_id: communication_work_order.id) }
      
      it "returns the associated communication work order" do
        expect(status_change.work_order).to eq(communication_work_order)
      end
    end
    
    context "when work_order_id is invalid" do
      let(:status_change) { create(:work_order_status_change, work_order_type: 'express_receipt', work_order_id: 999999) }
      
      it "returns nil" do
        expect(status_change.work_order).to be_nil
      end
    end
  end
  
  describe "#changed_by_user" do
    let(:admin_user) { create(:admin_user) }
    let(:status_change) { create(:work_order_status_change, changed_by: admin_user.id) }
    
    it "returns the associated admin user" do
      expect(status_change.changed_by_user).to eq(admin_user)
    end
    
    context "when changed_by is nil" do
      let(:status_change) { create(:work_order_status_change, changed_by: nil) }
      
      it "returns nil" do
        expect(status_change.changed_by_user).to be_nil
      end
    end
  end
  
  describe "#status_change_description" do
    context "when from_status is present" do
      let(:status_change) { build(:work_order_status_change, from_status: 'pending', to_status: 'processing') }
      
      it "returns a description with from and to status" do
        expect(status_change.status_change_description).to eq("从 pending 变更为 processing")
      end
    end
    
    context "when from_status is nil" do
      let(:status_change) { build(:work_order_status_change, from_status: nil, to_status: 'pending') }
      
      it "returns a description with (新建) and to status" do
        expect(status_change.status_change_description).to eq("从 (新建) 变更为 pending")
      end
    end
  end
end
```

### 4. 实现 ActiveAdmin 资源

创建 `app/admin/work_order_status_changes.rb` 文件：

```ruby
# app/admin/work_order_status_changes.rb
ActiveAdmin.register WorkOrderStatusChange do
  # 权限控制
  actions :index, :show
  
  # 菜单设置
  menu priority: 6, label: "工单状态变更记录"
  
  # 过滤器
  filter :work_order_type, as: :select, collection: [
    ['快递收单工单', 'express_receipt'],
    ['审核工单', 'audit'],
    ['沟通工单', 'communication']
  ]
  filter :work_order_id
  filter :from_status
  filter :to_status
  filter :changed_at
  filter :changed_by
  filter :created_at
  
  # 列表页
  index do
    selectable_column
    id_column
    column :work_order_type do |record|
      case record.work_order_type
      when 'express_receipt'
        '快递收单工单'
      when 'audit'
        '审核工单'
      when 'communication'
        '沟通工单'
      else
        record.work_order_type
      end
    end
    column :work_order_id do |record|
      if record.work_order.present?
        case record.work_order_type
        when 'express_receipt'
          link_to record.work_order_id, admin_express_receipt_work_order_path(record.work_order_id)
        when 'audit'
          link_to record.work_order_id, admin_audit_work_order_path(record.work_order_id)
        when 'communication'
          link_to record.work_order_id, admin_communication_work_order_path(record.work_order_id)
        end
      else
        record.work_order_id
      end
    end
    column :status_change do |record|
      "#{record.from_status || '(新建)'} → #{record.to_status}"
    end
    column :changed_at
    column :changed_by do |record|
      if record.changed_by_user.present?
        record.changed_by_user.email
      else
        record.changed_by
      end
    end
    actions
  end
  
  # 详情页
  show do
    attributes_table do
      row :id
      row :work_order_type do |record|
        case record.work_order_type
        when 'express_receipt'
          '快递收单工单'
        when 'audit'
          '审核工单'
        when 'communication'
          '沟通工单'
        else
          record.work_order_type
        end
      end
      row :work_order do |record|
        if record.work_order.present?
          case record.work_order_type
          when 'express_receipt'
            link_to "快递收单工单 ##{record.work_order_id}", admin_express_receipt_work_order_path(record.work_order_id)
          when 'audit'
            link_to "审核工单 ##{record.work_order_id}", admin_audit_work_order_path(record.work_order_id)
          when 'communication'
            link_to "沟通工单 ##{record.work_order_id}", admin_communication_work_order_path(record.work_order_id)
          end
        else
          "#{record.work_order_type} ##{record.work_order_id} (已删除)"
        end
      end
      row :from_status
      row :to_status
      row :status_change do |record|
        "#{record.from_status || '(新建)'} → #{record.to_status}"
      end
      row :changed_at
      row :changed_by do |record|
        if record.changed_by_user.present?
          link_to record.changed_by_user.email, admin_admin_user_path(record.changed_by)
        else
          record.changed_by
        end
      end
      row :created_at
      row :updated_at
    end
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/models/work_order_status_change_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试模型功能：
   ```ruby
   # 创建报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false
   )
   
   # 创建快递收单工单
   work_order = ExpressReceiptWorkOrder.create!(
     reimbursement: reimbursement,
     status: "received",
     tracking_number: "SF1234567890",
     received_at: Time.current,
     courier_name: "顺丰",
     created_by: 1
   )
   
   # 创建状态变更记录
   status_change = WorkOrderStatusChange.create!(
     work_order_type: 'express_receipt',
     work_order_id: work_order.id,
     from_status: nil,
     to_status: 'received',
     changed_at: Time.current,
     changed_by: 1
   )
   
   # 测试关联关系
   status_change.work_order == work_order # 应该返回 true
   
   # 测试状态变更描述
   status_change.status_change_description # 应该返回 "从 (新建) 变更为 received"
   
   # 测试作用域
   WorkOrderStatusChange.for_express_receipt_work_orders.include?(status_change) # 应该返回 true
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试工单状态变更记录管理功能

## 注意事项

1. 确保多态关联关系正确设置
2. 确保状态变更记录功能正确实现
3. 确保 ActiveAdmin 配置正确，特别是工单类型的显示和链接
4. 确保工单模型中的状态变更回调正确实现，以便在状态变更时自动创建记录