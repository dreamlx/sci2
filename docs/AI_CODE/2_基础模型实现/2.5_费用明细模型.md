# 费用明细模型实现

## 任务描述

实现费用明细（FeeDetail）模型，作为工单系统的核心数据模型之一。费用明细模型存储报销单的费用明细信息，并与工单系统中的审核工单和沟通工单建立关联关系。

## 输入和依赖

- 数据库迁移脚本（已创建的费用明细表）
- 报销单模型（Reimbursement）
- 模型实现设计文档 (`docs/refactoring/03_model_implementation.md`)

## 期望输出

完整的费用明细模型实现，包括：
- 模型属性和验证
- 与报销单的关联关系
- 验证状态更新方法
- 作用域和查询方法
- ActiveAdmin 配置

## 详细实现步骤

### 1. 创建费用明细模型

创建 `app/models/fee_detail.rb` 文件：

```ruby
class FeeDetail < ApplicationRecord
  # 常量
  VERIFICATION_STATUS_PENDING = 'pending'
  VERIFICATION_STATUS_VERIFIED = 'verified'
  VERIFICATION_STATUS_REJECTED = 'rejected'
  VERIFICATION_STATUS_PROBLEMATIC = 'problematic'
  
  VERIFICATION_STATUSES = [
    VERIFICATION_STATUS_PENDING,
    VERIFICATION_STATUS_VERIFIED,
    VERIFICATION_STATUS_REJECTED,
    VERIFICATION_STATUS_PROBLEMATIC
  ]

  # 关联
  belongs_to :reimbursement, foreign_key: 'document_number', primary_key: 'invoice_number', optional: true
  has_many :fee_detail_selections, dependent: :destroy
  has_many :audit_work_orders, through: :fee_detail_selections
  has_many :communication_work_orders, through: :fee_detail_selections

  # 验证
  validates :document_number, presence: true
  validates :fee_type, presence: true
  validates :amount, presence: true, numericality: { greater_than: 0 }
  validates :verification_status, presence: true, inclusion: { in: VERIFICATION_STATUSES }

  # 范围
  scope :pending, -> { where(verification_status: VERIFICATION_STATUS_PENDING) }
  scope :verified, -> { where(verification_status: VERIFICATION_STATUS_VERIFIED) }
  scope :rejected, -> { where(verification_status: VERIFICATION_STATUS_REJECTED) }
  scope :problematic, -> { where(verification_status: VERIFICATION_STATUS_PROBLEMATIC) }
  scope :not_verified, -> { where.not(verification_status: VERIFICATION_STATUS_VERIFIED) }
  scope :not_rejected, -> { where.not(verification_status: VERIFICATION_STATUS_REJECTED) }
  scope :requiring_action, -> { where(verification_status: [VERIFICATION_STATUS_PENDING, VERIFICATION_STATUS_PROBLEMATIC]) }

  # 方法
  def mark_as_verified
    update(verification_status: VERIFICATION_STATUS_VERIFIED)
  end

  def mark_as_rejected
    update(verification_status: VERIFICATION_STATUS_REJECTED)
  end

  def mark_as_problematic
    update(verification_status: VERIFICATION_STATUS_PROBLEMATIC)
  end

  def mark_as_pending
    update(verification_status: VERIFICATION_STATUS_PENDING)
  end

  def verified?
    verification_status == VERIFICATION_STATUS_VERIFIED
  end

  def rejected?
    verification_status == VERIFICATION_STATUS_REJECTED
  end

  def problematic?
    verification_status == VERIFICATION_STATUS_PROBLEMATIC
  end

  def pending?
    verification_status == VERIFICATION_STATUS_PENDING
  end

  def requires_action?
    pending? || problematic?
  end

  def latest_audit_selection
    fee_detail_selections.joins(:audit_work_order).order('audit_work_orders.created_at DESC').first
  end

  def latest_communication_selection
    fee_detail_selections.joins(:communication_work_order).order('communication_work_orders.created_at DESC').first
  end

  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id document_number fee_type amount currency fee_date payment_method verification_status created_at updated_at]
  end

  def self.ransackable_associations(auth_object = nil)
    %w[reimbursement fee_detail_selections audit_work_orders communication_work_orders]
  end
end
```

### 2. 创建费用明细工厂

创建 `spec/factories/fee_details.rb` 文件：

```ruby
FactoryBot.define do
  factory :fee_detail do
    sequence(:document_number) { |n| "R#{Time.current.strftime('%Y%m%d')}#{n.to_s.rjust(3, '0')}" }
    fee_type { ["交通费", "餐饮费", "住宿费", "办公用品", "其他"].sample }
    amount { rand(10.0..1000.0).round(2) }
    currency { "CNY" }
    fee_date { Time.current - rand(1..30).days }
    payment_method { ["现金", "信用卡", "公司转账", "其他"].sample }
    verification_status { "pending" }

    trait :verified do
      verification_status { "verified" }
    end

    trait :rejected do
      verification_status { "rejected" }
    end

    trait :problematic do
      verification_status { "problematic" }
    end

    trait :with_reimbursement do
      association :reimbursement, strategy: :build
      document_number { reimbursement.invoice_number }
    end
  end
end
```

### 3. 创建费用明细模型测试

创建 `spec/models/fee_detail_spec.rb` 文件：

```ruby
require 'rails_helper'

RSpec.describe FeeDetail, type: :model do
  describe "validations" do
    it { should validate_presence_of(:document_number) }
    it { should validate_presence_of(:fee_type) }
    it { should validate_presence_of(:amount) }
    it { should validate_numericality_of(:amount).is_greater_than(0) }
    it { should validate_presence_of(:verification_status) }
    it { should validate_inclusion_of(:verification_status).in_array(FeeDetail::VERIFICATION_STATUSES) }
  end

  describe "associations" do
    it { should belong_to(:reimbursement).optional }
    it { should have_many(:fee_detail_selections).dependent(:destroy) }
    it { should have_many(:audit_work_orders).through(:fee_detail_selections) }
    it { should have_many(:communication_work_orders).through(:fee_detail_selections) }
  end

  describe "scopes" do
    before do
      create(:fee_detail, verification_status: 'pending')
      create(:fee_detail, verification_status: 'verified')
      create(:fee_detail, verification_status: 'rejected')
      create(:fee_detail, verification_status: 'problematic')
    end

    it "returns pending fee details" do
      expect(FeeDetail.pending.count).to eq(1)
    end

    it "returns verified fee details" do
      expect(FeeDetail.verified.count).to eq(1)
    end

    it "returns rejected fee details" do
      expect(FeeDetail.rejected.count).to eq(1)
    end

    it "returns problematic fee details" do
      expect(FeeDetail.problematic.count).to eq(1)
    end

    it "returns not verified fee details" do
      expect(FeeDetail.not_verified.count).to eq(3)
    end

    it "returns not rejected fee details" do
      expect(FeeDetail.not_rejected.count).to eq(3)
    end

    it "returns fee details requiring action" do
      expect(FeeDetail.requiring_action.count).to eq(2)
    end
  end

  describe "methods" do
    let(:fee_detail) { create(:fee_detail) }

    describe "#mark_as_verified" do
      it "updates verification_status to verified" do
        fee_detail.mark_as_verified
        expect(fee_detail.reload.verification_status).to eq('verified')
      end
    end

    describe "#mark_as_rejected" do
      it "updates verification_status to rejected" do
        fee_detail.mark_as_rejected
        expect(fee_detail.reload.verification_status).to eq('rejected')
      end
    end

    describe "#mark_as_problematic" do
      it "updates verification_status to problematic" do
        fee_detail.mark_as_problematic
        expect(fee_detail.reload.verification_status).to eq('problematic')
      end
    end

    describe "#mark_as_pending" do
      it "updates verification_status to pending" do
        fee_detail.update(verification_status: 'verified')
        fee_detail.mark_as_pending
        expect(fee_detail.reload.verification_status).to eq('pending')
      end
    end

    describe "status check methods" do
      it "returns true for verified? when status is verified" do
        fee_detail.update(verification_status: 'verified')
        expect(fee_detail.verified?).to be_truthy
      end

      it "returns true for rejected? when status is rejected" do
        fee_detail.update(verification_status: 'rejected')
        expect(fee_detail.rejected?).to be_truthy
      end

      it "returns true for problematic? when status is problematic" do
        fee_detail.update(verification_status: 'problematic')
        expect(fee_detail.problematic?).to be_truthy
      end

      it "returns true for pending? when status is pending" do
        expect(fee_detail.pending?).to be_truthy
      end

      it "returns true for requires_action? when status is pending or problematic" do
        expect(fee_detail.requires_action?).to be_truthy
        
        fee_detail.update(verification_status: 'problematic')
        expect(fee_detail.requires_action?).to be_truthy
        
        fee_detail.update(verification_status: 'verified')
        expect(fee_detail.requires_action?).to be_falsey
      end
    end

    describe "selection methods" do
      let(:reimbursement) { create(:reimbursement) }
      let(:fee_detail) { create(:fee_detail, document_number: reimbursement.invoice_number) }
      let(:audit_work_order) { create(:audit_work_order, reimbursement: reimbursement) }
      let(:communication_work_order) { create(:communication_work_order, reimbursement: reimbursement, audit_work_order: audit_work_order) }

      before do
        # Create selections
        audit_work_order.select_fee_detail(fee_detail)
        communication_work_order.select_fee_detail(fee_detail)
      end

      it "returns latest audit selection" do
        expect(fee_detail.latest_audit_selection).to be_present
        expect(fee_detail.latest_audit_selection.audit_work_order).to eq(audit_work_order)
      end

      it "returns latest communication selection" do
        expect(fee_detail.latest_communication_selection).to be_present
        expect(fee_detail.latest_communication_selection.communication_work_order).to eq(communication_work_order)
      end
    end
  end
end
```

### 4. 创建 ActiveAdmin 资源

创建 `app/admin/fee_details.rb` 文件（如果尚未创建）：

```ruby
ActiveAdmin.register FeeDetail do
  # 权限控制
  permit_params :document_number, :fee_type, :amount, :currency, :fee_date, 
                :payment_method, :verification_status

  # 菜单设置
  menu priority: 5, label: "费用明细"

  # 过滤器
  filter :document_number
  filter :fee_type
  filter :amount
  filter :fee_date
  filter :verification_status, as: :select, collection: FeeDetail::VERIFICATION_STATUSES
  filter :created_at

  # 批量操作
  batch_action :mark_as_verified do |ids|
    batch_action_collection.find(ids).each do |fee_detail|
      fee_detail.mark_as_verified
    end
    redirect_to collection_path, notice: "已将选中的费用明细标记为已验证"
  end

  batch_action :mark_as_rejected do |ids|
    batch_action_collection.find(ids).each do |fee_detail|
      fee_detail.mark_as_rejected
    end
    redirect_to collection_path, notice: "已将选中的费用明细标记为已拒绝"
  end

  batch_action :mark_as_problematic do |ids|
    batch_action_collection.find(ids).each do |fee_detail|
      fee_detail.mark_as_problematic
    end
    redirect_to collection_path, notice: "已将选中的费用明细标记为有问题"
  end

  # 自定义操作
  action_item :mark_as_verified, only: :show, if: proc { !resource.verified? } do
    link_to "标记为已验证", mark_as_verified_admin_fee_detail_path(resource), method: :put
  end

  action_item :mark_as_rejected, only: :show, if: proc { !resource.rejected? } do
    link_to "标记为已拒绝", mark_as_rejected_admin_fee_detail_path(resource), method: :put
  end

  action_item :mark_as_problematic, only: :show, if: proc { !resource.problematic? } do
    link_to "标记为有问题", mark_as_problematic_admin_fee_detail_path(resource), method: :put
  end

  action_item :mark_as_pending, only: :show, if: proc { !resource.pending? } do
    link_to "标记为待验证", mark_as_pending_admin_fee_detail_path(resource), method: :put
  end

  # 自定义页面
  member_action :mark_as_verified, method: :put do
    resource.mark_as_verified
    redirect_to admin_fee_detail_path(resource), notice: "费用明细已标记为已验证"
  end

  member_action :mark_as_rejected, method: :put do
    resource.mark_as_rejected
    redirect_to admin_fee_detail_path(resource), notice: "费用明细已标记为已拒绝"
  end

  member_action :mark_as_problematic, method: :put do
    resource.mark_as_problematic
    redirect_to admin_fee_detail_path(resource), notice: "费用明细已标记为有问题"
  end

  member_action :mark_as_pending, method: :put do
    resource.mark_as_pending
    redirect_to admin_fee_detail_path(resource), notice: "费用明细已标记为待验证"
  end

  # 列表页
  index do
    selectable_column
    id_column
    column :document_number do |fee_detail|
      if fee_detail.reimbursement.present?
        link_to fee_detail.document_number, admin_reimbursement_path(fee_detail.reimbursement)
      else
        fee_detail.document_number
      end
    end
    column :fee_type
    column :amount do |fee_detail|
      number_to_currency(fee_detail.amount, unit: fee_detail.currency)
    end
    column :fee_date
    column :payment_method
    column :verification_status do |fee_detail|
      status_tag fee_detail.verification_status
    end
    column :created_at
    actions
  end

  # 详情页
  show do
    tabs do
      tab "基本信息" do
        attributes_table do
          row :id
          row :document_number do |fee_detail|
            if fee_detail.reimbursement.present?
              link_to fee_detail.document_number, admin_reimbursement_path(fee_detail.reimbursement)
            else
              fee_detail.document_number
            end
          end
          row :fee_type
          row :amount do |fee_detail|
            number_to_currency(fee_detail.amount, unit: fee_detail.currency)
          end
          row :currency
          row :fee_date
          row :payment_method
          row :verification_status do |fee_detail|
            status_tag fee_detail.verification_status
          end
          row :created_at
          row :updated_at
        end
      end

      tab "审核工单" do
        panel "关联的审核工单" do
          table_for resource.audit_work_orders do
            column :id do |work_order|
              link_to work_order.id, admin_audit_work_order_path(work_order)
            end
            column :status do |work_order|
              status_tag work_order.status
            end
            column :audit_result do |work_order|
              status_tag work_order.audit_result if work_order.audit_result.present?
            end
            column :created_at
          end
        end
      end

      tab "沟通工单" do
        panel "关联的沟通工单" do
          table_for resource.communication_work_orders do
            column :id do |work_order|
              link_to work_order.id, admin_communication_work_order_path(work_order)
            end
            column :status do |work_order|
              status_tag work_order.status
            end
            column :resolution_summary
            column :created_at
          end
        end
      end

      tab "验证历史" do
        panel "费用明细选择记录" do
          table_for resource.fee_detail_selections.includes(:audit_work_order, :communication_work_order).order(created_at: :desc) do
            column "工单类型" do |selection|
              if selection.audit_work_order.present?
                "审核工单"
              elsif selection.communication_work_order.present?
                "沟通工单"
              else
                "未知"
              end
            end
            column "工单ID" do |selection|
              if selection.audit_work_order.present?
                link_to selection.audit_work_order.id, admin_audit_work_order_path(selection.audit_work_order)
              elsif selection.communication_work_order.present?
                link_to selection.communication_work_order.id, admin_communication_work_order_path(selection.communication_work_order)
              end
            end
            column :verification_status do |selection|
              status_tag selection.verification_status
            end
            column :verification_comment
            column :verified_by do |selection|
              AdminUser.find_by(id: selection.verified_by)&.email
            end
            column :verified_at
            column :created_at
          end
        end
      end
    end
  end

  # 表单
  form do |f|
    f.inputs "费用明细信息" do
      f.input :document_number
      f.input :fee_type
      f.input :amount
      f.input :currency
      f.input :fee_date, as: :datepicker
      f.input :payment_method
      f.input :verification_status, as: :select, collection: FeeDetail::VERIFICATION_STATUSES
    end
    f.actions
  end
end
```

## 测试验证方法

1. 运行 `rspec spec/models/fee_detail_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试模型功能：

```ruby
# 创建报销单
reimbursement = Reimbursement.create!(
  invoice_number: "R20250101001",
  document_name: "测试报销单",
  applicant: "张三",
  applicant_id: "EMP001",
  company: "测试公司",
  department: "测试部门",
  amount: 1000.00
)

# 创建费用明细
fee_detail = FeeDetail.create!(
  document_number: reimbursement.invoice_number,
  fee_type: "交通费",
  amount: 150.0,
  currency: "CNY",
  fee_date: Date.today - 5.days,
  payment_method: "现金",
  verification_status: "pending"
)

# 测试状态更新方法
puts "初始状态: #{fee_detail.verification_status}"
fee_detail.mark_as_verified
puts "验证后状态: #{fee_detail.verification_status}"
fee_detail.mark_as_problematic
puts "标记为有问题后状态: #{fee_detail.verification_status}"
fee_detail.mark_as_rejected
puts "拒绝后状态: #{fee_detail.verification_status}"
fee_detail.mark_as_pending
puts "重置为待验证后状态: #{fee_detail.verification_status}"

# 测试状态检查方法
fee_detail.mark_as_verified
puts "verified?: #{fee_detail.verified?}"
puts "rejected?: #{fee_detail.rejected?}"
puts "problematic?: #{fee_detail.problematic?}"
puts "pending?: #{fee_detail.pending?}"
puts "requires_action?: #{fee_detail.requires_action?}"

# 创建审核工单和沟通工单，并关联费用明细
audit_work_order = AuditWorkOrder.create!(
  reimbursement: reimbursement,
  status: 'auditing',
  created_by: 1
)
audit_work_order.select_fee_detail(fee_detail)

communication_work_order = CommunicationWorkOrder.create!(
  reimbursement: reimbursement,
  audit_work_order: audit_work_order,
  status: 'open',
  communication_method: 'email',
  initiator_role: 'auditor',
  created_by: 1
)
communication_work_order.select_fee_detail(fee_detail)

# 测试关联查询方法
puts "最新审核选择: #{fee_detail.latest_audit_selection.id}"
puts "最新沟通选择: #{fee_detail.latest_communication_selection.id}"
```

3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试费用明细管理功能

## 注意事项

1. 确保验证状态常量和方法正确实现
2. 确保与报销单的关联关系正确设置，特别是使用 `document_number` 和 `invoice_number` 字段
3. 确保作用域和查询方法正确实现，以便在 ActiveAdmin 中使用
4. 确保 ActiveAdmin 配置正确，特别是状态更新操作
5. 注意费用明细与审核工单和沟通工单的关联是通过 `fee_detail_selections` 表实现的
6. 确保测试覆盖所有关键功能，特别是状态更新方法和关联查询方法