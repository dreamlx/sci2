# 费用明细模型实现

## 任务描述

实现费用明细（FeeDetail）模型，包括定义模型属性和验证、实现与报销单的关联关系、实现验证状态更新方法以及添加适当的作用域和查询方法。

## 输入和依赖

- 已完成的数据库迁移
- 已实现的报销单模型
- 数据库结构设计文档 (`docs/refactoring/02_database_structure.md`)
- 模型实现设计文档 (`docs/refactoring/03_model_implementation.md`)

## 期望输出

完整的费用明细模型实现，包括：
- 模型属性和验证
- 与报销单的关联关系
- 验证状态更新方法
- 作用域和查询方法
- ActiveAdmin 配置

## 详细实现步骤

### 1. 创建费用明细模型

创建 `app/models/fee_detail.rb` 文件：

```ruby
# app/models/fee_detail.rb
class FeeDetail < ApplicationRecord
  # 关联
  belongs_to :reimbursement, foreign_key: 'document_number', primary_key: 'invoice_number', optional: true
  has_many :fee_detail_selections, dependent: :destroy
  
  # 验证
  validates :document_number, presence: true
  validates :fee_type, presence: true
  validates :amount, presence: true, numericality: { greater_than: 0 }
  validates :verification_status, presence: true
  
  # 常量
  VERIFICATION_STATUS_PENDING = 'pending'
  VERIFICATION_STATUS_VERIFIED = 'verified'
  VERIFICATION_STATUS_REJECTED = 'rejected'
  VERIFICATION_STATUS_PROBLEMATIC = 'problematic'
  
  # 回调
  before_validation :set_default_verification_status, on: :create
  
  # 范围
  scope :pending, -> { where(verification_status: VERIFICATION_STATUS_PENDING) }
  scope :verified, -> { where(verification_status: VERIFICATION_STATUS_VERIFIED) }
  scope :rejected, -> { where(verification_status: VERIFICATION_STATUS_REJECTED) }
  scope :problematic, -> { where(verification_status: VERIFICATION_STATUS_PROBLEMATIC) }
# 方法
  def mark_as_verified
    update(verification_status: VERIFICATION_STATUS_VERIFIED)
  end
  
  def mark_as_rejected
    update(verification_status: VERIFICATION_STATUS_REJECTED)
  end
  
  def mark_as_problematic
    update(verification_status: VERIFICATION_STATUS_PROBLEMATIC)
  end
  
  def pending?
    verification_status == VERIFICATION_STATUS_PENDING
  end
  
  def verified?
    verification_status == VERIFICATION_STATUS_VERIFIED
  end
  
  def rejected?
    verification_status == VERIFICATION_STATUS_REJECTED
  end
  
  def problematic?
    verification_status == VERIFICATION_STATUS_PROBLEMATIC
  end
  
  private
  
  def set_default_verification_status
    self.verification_status ||= VERIFICATION_STATUS_PENDING
  end
  
  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id document_number fee_type amount currency fee_date payment_method verification_status created_at updated_at]
  end
  
  def self.ransackable_associations(auth_object = nil)
    %w[reimbursement fee_detail_selections]
  end
end
```

### 2. 创建费用明细选择模型

创建 `app/models/fee_detail_selection.rb` 文件：

```ruby
# app/models/fee_detail_selection.rb
class FeeDetailSelection < ApplicationRecord
  # 关联
  belongs_to :fee_detail
  belongs_to :audit_work_order, optional: true
  belongs_to :communication_work_order, optional: true
  
  # 验证
  validates :fee_detail_id, uniqueness: { scope: :audit_work_order_id }, if: :audit_work_order_id?
  validates :fee_detail_id, uniqueness: { scope: :communication_work_order_id }, if: :communication_work_order_id?
  validate :ensure_one_work_order_association
  
  # 常量
  VERIFICATION_STATUS_PENDING = 'pending'
  VERIFICATION_STATUS_VERIFIED = 'verified'
  VERIFICATION_STATUS_REJECTED = 'rejected'
  VERIFICATION_STATUS_PROBLEMATIC = 'problematic'
  
  # 范围
  scope :pending, -> { where(verification_status: VERIFICATION_STATUS_PENDING) }
  scope :verified, -> { where(verification_status: VERIFICATION_STATUS_VERIFIED) }
  scope :rejected, -> { where(verification_status: VERIFICATION_STATUS_REJECTED) }
  scope :problematic, -> { where(verification_status: VERIFICATION_STATUS_PROBLEMATIC) }
  
  private
  
  def ensure_one_work_order_association
    if audit_work_order_id.blank? && communication_work_order_id.blank?
      errors.add(:base, "必须关联到审核工单或沟通工单")
    end
    
    if audit_work_order_id.present? && communication_work_order_id.present?
      errors.add(:base, "不能同时关联到审核工单和沟通工单")
    end
  end
  
  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id fee_detail_id audit_work_order_id communication_work_order_id verification_status verification_comment verified_by verified_at created_at updated_at]
  end
  
  def self.ransackable_associations(auth_object = nil)
    %w[fee_detail audit_work_order communication_work_order]
  end
end
```

### 3. 创建费用明细工厂（用于测试）

创建 `spec/factories/fee_details.rb` 文件：

```ruby
# spec/factories/fee_details.rb
FactoryBot.define do
  factory :fee_detail do
    sequence(:document_number) { |n| "R#{Time.current.strftime('%Y%m%d')}#{n.to_s.rjust(3, '0')}" }
    fee_type { ["交通费", "餐饮费", "住宿费", "办公用品", "其他"].sample }
    amount { rand(10.0..1000.0).round(2) }
    currency { "CNY" }
    fee_date { Time.current - rand(1..30).days }
    payment_method { ["现金", "信用卡", "公司转账", "其他"].sample }
    verification_status { "pending" }
    
    trait :verified do
      verification_status { "verified" }
    end
    
    trait :rejected do
      verification_status { "rejected" }
    end
    
    trait :problematic do
      verification_status { "problematic" }
    end
    
    trait :with_reimbursement do
      association :reimbursement, factory: :reimbursement, strategy: :build
      document_number { reimbursement.invoice_number }
    end
  end
end
```

### 4. 创建费用明细选择工厂（用于测试）

创建 `spec/factories/fee_detail_selections.rb` 文件：

```ruby
# spec/factories/fee_detail_selections.rb
FactoryBot.define do
  factory :fee_detail_selection do
    association :fee_detail
    verification_status { "pending" }
    
    trait :with_audit_work_order do
      association :audit_work_order
      audit_work_order_id { audit_work_order.id }
      communication_work_order_id { nil }
    end
    
    trait :with_communication_work_order do
      association :communication_work_order
      audit_work_order_id { nil }
      communication_work_order_id { communication_work_order.id }
    end
    
    trait :verified do
      verification_status { "verified" }
      verified_at { Time.current }
      verified_by { 1 }
    end
    
    trait :rejected do
      verification_status { "rejected" }
      verified_at { Time.current }
      verified_by { 1 }
    end
    
### 5. 创建费用明细模型测试

创建 `spec/models/fee_detail_spec.rb` 文件：

```ruby
# spec/models/fee_detail_spec.rb
require 'rails_helper'

RSpec.describe FeeDetail, type: :model do
  describe "validations" do
    it { should validate_presence_of(:document_number) }
    it { should validate_presence_of(:fee_type) }
    it { should validate_presence_of(:amount) }
    it { should validate_numericality_of(:amount).is_greater_than(0) }
    it { should validate_presence_of(:verification_status) }
  end
  
  describe "associations" do
    it { should belong_to(:reimbursement).optional }
    it { should have_many(:fee_detail_selections).dependent(:destroy) }
  end
  
  describe "callbacks" do
    it "sets default verification status on create" do
      fee_detail = build(:fee_detail, verification_status: nil)
      fee_detail.save
      expect(fee_detail.verification_status).to eq("pending")
    end
    
    it "does not override verification status if provided" do
      fee_detail = build(:fee_detail, verification_status: "verified")
      fee_detail.save
      expect(fee_detail.verification_status).to eq("verified")
    end
  end
  
  describe "scopes" do
    before do
      create(:fee_detail, verification_status: "pending")
      create(:fee_detail, verification_status: "verified")
      create(:fee_detail, verification_status: "rejected")
      create(:fee_detail, verification_status: "problematic")
    end
    
    it "returns pending fee details" do
      expect(FeeDetail.pending.count).to eq(1)
    end
    
    it "returns verified fee details" do
      expect(FeeDetail.verified.count).to eq(1)
    end
    
    it "returns rejected fee details" do
      expect(FeeDetail.rejected.count).to eq(1)
    end
    
    it "returns problematic fee details" do
      expect(FeeDetail.problematic.count).to eq(1)
    end
  end
  
  describe "status update methods" do
    let(:fee_detail) { create(:fee_detail) }
    
    it "marks as verified" do
      fee_detail.mark_as_verified
      expect(fee_detail.verification_status).to eq("verified")
      expect(fee_detail).to be_verified
    end
    
    it "marks as rejected" do
      fee_detail.mark_as_rejected
      expect(fee_detail.verification_status).to eq("rejected")
      expect(fee_detail).to be_rejected
    end
    
    it "marks as problematic" do
      fee_detail.mark_as_problematic
      expect(fee_detail.verification_status).to eq("problematic")
      expect(fee_detail).to be_problematic
    end
  end
  
  describe "status check methods" do
    it "returns true for pending?" do
      fee_detail = build(:fee_detail, verification_status: "pending")
      expect(fee_detail).to be_pending
    end
    
    it "returns true for verified?" do
      fee_detail = build(:fee_detail, verification_status: "verified")
      expect(fee_detail).to be_verified
    end
    
    it "returns true for rejected?" do
      fee_detail = build(:fee_detail, verification_status: "rejected")
      expect(fee_detail).to be_rejected
    end
    
    it "returns true for problematic?" do
      fee_detail = build(:fee_detail, verification_status: "problematic")
      expect(fee_detail).to be_problematic
    end
  end
end
```

### 6. 创建费用明细选择模型测试

创建 `spec/models/fee_detail_selection_spec.rb` 文件：

```ruby
# spec/models/fee_detail_selection_spec.rb
require 'rails_helper'

RSpec.describe FeeDetailSelection, type: :model do
  describe "validations" do
    it { should validate_uniqueness_of(:fee_detail_id).scoped_to(:audit_work_order_id).allow_nil }
    it { should validate_uniqueness_of(:fee_detail_id).scoped_to(:communication_work_order_id).allow_nil }
    
    it "validates that at least one work order is associated" do
      selection = build(:fee_detail_selection, audit_work_order_id: nil, communication_work_order_id: nil)
      expect(selection).not_to be_valid
      expect(selection.errors[:base]).to include("必须关联到审核工单或沟通工单")
    end
    
    it "validates that only one work order is associated" do
      audit_work_order = create(:audit_work_order)
      communication_work_order = create(:communication_work_order)
      selection = build(:fee_detail_selection, audit_work_order_id: audit_work_order.id, communication_work_order_id: communication_work_order.id)
      expect(selection).not_to be_valid
      expect(selection.errors[:base]).to include("不能同时关联到审核工单和沟通工单")
    end
  end
  
  describe "associations" do
    it { should belong_to(:fee_detail) }
    it { should belong_to(:audit_work_order).optional }
    it { should belong_to(:communication_work_order).optional }
  end
  
  describe "scopes" do
    before do
      create(:fee_detail_selection, :with_audit_work_order, verification_status: "pending")
      create(:fee_detail_selection, :with_audit_work_order, verification_status: "verified")
      create(:fee_detail_selection, :with_audit_work_order, verification_status: "rejected")
      create(:fee_detail_selection, :with_audit_work_order, verification_status: "problematic")
    end
    
    it "returns pending selections" do
      expect(FeeDetailSelection.pending.count).to eq(1)
    end
    
    it "returns verified selections" do
      expect(FeeDetailSelection.verified.count).to eq(1)
### 7. 实现 ActiveAdmin 资源

创建 `app/admin/fee_details.rb` 文件：

```ruby
# app/admin/fee_details.rb
ActiveAdmin.register FeeDetail do
  # 权限控制
  permit_params :document_number, :fee_type, :amount, :currency, :fee_date, 
                :payment_method, :verification_status
  
  # 菜单设置
  menu priority: 5, label: "费用明细"
  
  # 过滤器
  filter :document_number
  filter :fee_type
  filter :amount
  filter :fee_date
  filter :verification_status, as: :select, collection: ["pending", "verified", "rejected", "problematic"]
  filter :created_at
  
  # 批量操作
  batch_action :mark_as_verified do |ids|
    batch_action_collection.find(ids).each do |fee_detail|
      fee_detail.mark_as_verified
    end
    redirect_to collection_path, notice: "已将选中的费用明细标记为已验证"
  end
  
  batch_action :mark_as_rejected do |ids|
    batch_action_collection.find(ids).each do |fee_detail|
      fee_detail.mark_as_rejected
    end
    redirect_to collection_path, notice: "已将选中的费用明细标记为已拒绝"
  end
  
  # 自定义操作
  action_item :import, only: :index do
    link_to "导入费用明细", new_import_admin_fee_details_path
  end
  
  # 自定义页面
  collection_action :new_import, method: :get do
    render "admin/fee_details/new_import"
  end
  
  collection_action :import, method: :post do
    redirect_to admin_fee_details_path, notice: "导入成功"
  end
  
  member_action :verify, method: :get do
    @work_order = AuditWorkOrder.find_by(id: params[:work_order_id])
    render "admin/fee_details/verify"
  end
  
  member_action :do_verify, method: :post do
    @work_order = AuditWorkOrder.find_by(id: params[:work_order_id])
    service = FeeDetailVerificationService.new(current_admin_user)
    
    if service.verify_fee_detail_in_work_order(@work_order, params[:id], params[:verification_status], params[:comment])
      redirect_to admin_audit_work_order_path(@work_order), notice: "费用明细已验证"
    else
      redirect_to admin_audit_work_order_path(@work_order), alert: "验证失败"
    end
  end
  
  member_action :mark_problematic, method: :get do
    @work_order = AuditWorkOrder.find_by(id: params[:work_order_id])
    render "admin/fee_details/mark_problematic"
  end
  
  member_action :do_mark_problematic, method: :post do
    @work_order = AuditWorkOrder.find_by(id: params[:work_order_id])
    service = AuditWorkOrderService.new(@work_order, current_admin_user)
    
    communication_work_order = service.create_communication_work_order(
      communication_method: params[:communication_method],
      initiator_role: params[:initiator_role],
      content: params[:issue_description],
      fee_detail_ids: [params[:id]]
    )
    
    if communication_work_order.persisted?
      redirect_to admin_communication_work_order_path(communication_work_order), notice: "沟通工单已创建"
    else
      redirect_to admin_audit_work_order_path(@work_order), alert: "创建沟通工单失败"
    end
  end
  
  member_action :resolve_issue, method: :get do
    @work_order = CommunicationWorkOrder.find_by(id: params[:work_order_id])
    render "admin/fee_details/resolve_issue"
  end
  
  member_action :do_resolve_issue, method: :post do
    @work_order = CommunicationWorkOrder.find_by(id: params[:work_order_id])
    service = CommunicationWorkOrderService.new(@work_order, current_admin_user)
    
    if service.resolve_fee_detail_issue(params[:id], params[:resolution])
      redirect_to admin_communication_work_order_path(@work_order), notice: "问题已解决"
    else
      redirect_to admin_communication_work_order_path(@work_order), alert: "解决问题失败"
    end
  end
  
  # 列表页
  index do
    selectable_column
    id_column
    column :document_number
    column :fee_type
    column :amount do |fee_detail|
      number_to_currency(fee_detail.amount, unit: "¥")
    end
    column :fee_date
    column :verification_status do |fee_detail|
      status_tag fee_detail.verification_status
    end
    column :created_at
    actions
  end
  
  # 详情页
  show do
    attributes_table do
      row :id
      row :document_number
      row :reimbursement do |fee_detail|
        if fee_detail.reimbursement.present?
          link_to fee_detail.reimbursement.invoice_number, admin_reimbursement_path(fee_detail.reimbursement)
        end
      end
      row :fee_type
      row :amount do |fee_detail|
        number_to_currency(fee_detail.amount, unit: "¥")
      end
      row :currency
      row :fee_date
      row :payment_method
      row :verification_status do |fee_detail|
        status_tag fee_detail.verification_status
      end
      row :created_at
      row :updated_at
    end
    
    panel "关联的工单" do
      tabs do
        tab "审核工单" do
          table_for fee_detail.fee_detail_selections.where.not(audit_work_order_id: nil) do
            column :audit_work_order do |selection|
              link_to selection.audit_work_order_id, admin_audit_work_order_path(selection.audit_work_order_id)
            end
            column :verification_status do |selection|
              status_tag selection.verification_status
            end
            column :verification_comment
            column :verified_by
            column :verified_at
          end
        end
        
        tab "沟通工单" do
          table_for fee_detail.fee_detail_selections.where.not(communication_work_order_id: nil) do
            column :communication_work_order do |selection|
              link_to selection.communication_work_order_id, admin_communication_work_order_path(selection.communication_work_order_id)
            end
            column :verification_status do |selection|
              status_tag selection.verification_status
            end
            column :verification_comment
            column :verified_by
            column :verified_at
          end
        end
      end
    end
  end
  
  # 表单
  form do |f|
    f.inputs "费用明细信息" do
      f.input :document_number
      f.input :fee_type
      f.input :amount
      f.input :currency
      f.input :fee_date, as: :datepicker
      f.input :payment_method
      f.input :verification_status, as: :select, collection: ["pending", "verified", "rejected", "problematic"]
    end
    f.actions
  end
end
```

### 8. 创建费用明细视图模板

创建 `app/views/admin/fee_details/new_import.html.erb` 文件：

```erb
<!-- app/views/admin/fee_details/new_import.html.erb -->
<h2>导入费用明细</h2>

<%= form_tag import_admin_fee_details_path, multipart: true do %>
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>选择CSV文件</th>
            <td><%= file_field_tag :file, accept: '.csv' %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "导入", class: "button" %>
    <%= link_to "取消", admin_fee_details_path, class: "button" %>
  </div>
<% end %>

<div class="panel">
  <h3>导入说明</h3>
  <div class="panel_contents">
    <p>CSV文件应包含以下列：</p>
    <ul>
      <li>报销单单号（必填）</li>
      <li>费用类型（必填）</li>
      <li>原始金额（必填）</li>
      <li>币种</li>
      <li>费用发生日期</li>
      <li>支付方式</li>
    </ul>
  </div>
</div>
```

创建 `app/views/admin/fee_details/verify.html.erb` 文件：

```erb
<!-- app/views/admin/fee_details/verify.html.erb -->
<h2>验证费用明细</h2>

<%= form_tag do_verify_admin_fee_detail_path(@fee_detail), method: :post do %>
  <%= hidden_field_tag :work_order_id, @work_order.id %>
  
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @fee_detail.document_number %></td>
          </tr>
          <tr>
            <th>费用类型</th>
            <td><%= @fee_detail.fee_type %></td>
          </tr>
          <tr>
            <th>金额</th>
            <td><%= number_to_currency(@fee_detail.amount, unit: "¥") %></td>
          </tr>
          <tr>
            <th>当前状态</th>
            <td><%= status_tag @fee_detail.verification_status %></td>
          </tr>
          <tr>
            <th>验证状态</th>
            <td>
              <%= select_tag :verification_status, options_for_select([
                ["已验证", "verified"],
                ["已拒绝", "rejected"],
                ["有问题", "problematic"]
              ], @fee_detail.verification_status), required: true %>
            </td>
          </tr>
          <tr>
            <th>验证意见</th>
            <td><%= text_area_tag :comment, nil, rows: 3, cols: 40 %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "提交", class: "button" %>
    <%= link_to "取消", admin_audit_work_order_path(@work_order), class: "button" %>
  </div>
<% end %>
```

创建 `app/views/admin/fee_details/mark_problematic.html.erb` 文件：

```erb
<!-- app/views/admin/fee_details/mark_problematic.html.erb -->
<h2>标记费用明细有问题</h2>

<%= form_tag do_mark_problematic_admin_fee_detail_path(@fee_detail), method: :post do %>
  <%= hidden_field_tag :work_order_id, @work_order.id %>
  
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @fee_detail.document_number %></td>
          </tr>
          <tr>
            <th>费用类型</th>
            <td><%= @fee_detail.fee_type %></td>
          </tr>
          <tr>
            <th>金额</th>
            <td><%= number_to_currency(@fee_detail.amount, unit: "¥") %></td>
          </tr>
          <tr>
            <th>沟通方式</th>
            <td>
              <%= select_tag :communication_method, options_for_select([
                ["系统", "system"],
                ["邮件", "email"],
                ["电话", "phone"],
                ["其他", "other"]
              ]), required: true %>
            </td>
          </tr>
          <tr>
            <th>发起人角色</th>
            <td>
              <%= select_tag :initiator_role, options_for_select([
                ["审核人", "auditor"],
                ["申请人", "applicant"],
                ["管理员", "admin"],
                ["其他", "other"]
              ]), required: true %>
            </td>
          </tr>
          <tr>
            <th>问题描述</th>
            <td><%= text_area_tag :issue_description, nil, rows: 5, cols: 50, required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "创建沟通工单", class: "button" %>
    <%= link_to "取消", admin_audit_work_order_path(@work_order), class: "button" %>
  </div>
<% end %>
```

创建 `app/views/admin/fee_details/resolve_issue.html.erb` 文件：

```erb
<!-- app/views/admin/fee_details/resolve_issue.html.erb -->
<h2>解决费用明细问题</h2>

<%= form_tag do_resolve_issue_admin_fee_detail_path(@fee_detail), method: :post do %>
  <%= hidden_field_tag :work_order_id, @work_order.id %>
  
  <div class="panel">
    <div class="panel_contents">
      <div class="attributes_table">
        <table>
          <tr>
            <th>报销单号</th>
            <td><%= @fee_detail.document_number %></td>
          </tr>
          <tr>
            <th>费用类型</th>
            <td><%= @fee_detail.fee_type %></td>
          </tr>
          <tr>
            <th>金额</th>
            <td><%= number_to_currency(@fee_detail.amount, unit: "¥") %></td>
          </tr>
          <tr>
            <th>当前状态</th>
            <td><%= status_tag @fee_detail.verification_status %></td>
          </tr>
          <tr>
            <th>解决方案</th>
            <td><%= text_area_tag :resolution, nil, rows: 5, cols: 50, required: true %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <%= submit_tag "提交", class: "button" %>
    <%= link_to "取消", admin_communication_work_order_path(@work_order), class: "button" %>
  </div>
<% end %>
```

## 测试验证方法

1. 运行 `rspec spec/models/fee_detail_spec.rb spec/models/fee_detail_selection_spec.rb` 确保所有测试通过
2. 在 Rails 控制台中测试模型功能：
   ```ruby
   # 创建报销单
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false
   )
   
   # 创建费用明细
   fee_detail = FeeDetail.create!(
     document_number: reimbursement.invoice_number,
     fee_type: "交通费",
     amount: 100.00,
     currency: "CNY",
     fee_date: Date.today - 5.days,
     payment_method: "现金"
   )
   
   # 测试验证状态更新
   fee_detail.verification_status # 应该返回 "pending"
   fee_detail.mark_as_verified
   fee_detail.verification_status # 应该返回 "verified"
   
   # 创建审核工单
   audit_work_order = AuditWorkOrder.create!(
     reimbursement: reimbursement,
     status: "auditing",
     created_by: 1
   )
   
   # 关联费用明细到审核工单
   selection = FeeDetailSelection.create!(
     fee_detail: fee_detail,
     audit_work_order: audit_work_order,
     verification_status: "pending"
   )
   
   # 验证关联关系
   audit_work_order.fee_details.include?(fee_detail) # 应该返回 true
   fee_detail.fee_detail_selections.first.audit_work_order == audit_work_order # 应该返回 true
   ```
3. 启动 Rails 服务器，访问 ActiveAdmin 界面，测试费用明细管理功能

## 注意事项

1. 确保费用明细与报销单的关联关系正确设置，特别是外键和主键的设置
2. 确保验证状态更新方法正确实现
3. 确保费用明细选择模型的验证逻辑正确实现，特别是确保一个费用明细只能关联到一个审核工单或沟通工单
4. 确保 ActiveAdmin 配置正确，特别是自定义操作和表单
5. 确保费用明细导入功能正确实现，特别是与报销单的关联
    end
    
    it "returns rejected selections" do
      expect(FeeDetailSelection.rejected.count).to eq(1)
    end
    
    it "returns problematic selections" do
      expect(FeeDetailSelection.problematic.count).to eq(1)
    end
  end
end
```
    trait :problematic do
      verification_status { "problematic" }
      verified_at { Time.current }
      verified_by { 1 }
    end
  end
end
```