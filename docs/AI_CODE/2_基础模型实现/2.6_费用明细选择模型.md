# 费用明细选择模型实现

## 任务描述

实现费用明细选择模型（FeeDetailSelection），用于关联费用明细到审核工单或沟通工单。该模型是工单系统的关键组件，负责处理费用明细的选择和验证状态的记录。

## 输入和依赖

- 已完成的费用明细模型
- 已完成的审核工单模型
- 已完成的沟通工单模型
- 数据库迁移文件 (`db/migrate/20250421100001_create_fee_detail_selections.rb`)

## 期望输出

完整的费用明细选择模型实现，包括：
- 模型定义
- 关联关系
- 验证规则
- 作用域和查询方法
- ActiveAdmin配置

## 详细实现步骤

### 1. 创建数据库迁移文件

确认 `db/migrate/20250421100001_create_fee_detail_selections.rb` 文件内容如下：

```ruby
class CreateFeeDetailSelections < ActiveRecord::Migration[7.0]
  def change
    create_table :fee_detail_selections do |t|
      t.references :fee_detail, null: false, foreign_key: true
      t.references :audit_work_order, foreign_key: true
      t.references :communication_work_order, foreign_key: true
      t.string :verification_status
      t.text :verification_comment
      t.integer :verified_by
      t.datetime :verified_at

      t.timestamps
    end

    add_index :fee_detail_selections, [:fee_detail_id, :audit_work_order_id], unique: true, name: 'index_fee_detail_selections_on_fee_detail_and_audit_work_order'
    add_index :fee_detail_selections, [:fee_detail_id, :communication_work_order_id], unique: true, name: 'index_fee_detail_selections_on_fee_detail_and_comm_work_order'
  end
end
```

### 2. 创建费用明细选择模型

创建 `app/models/fee_detail_selection.rb` 文件：

```ruby
# app/models/fee_detail_selection.rb
class FeeDetailSelection < ApplicationRecord
  # 关联
  belongs_to :fee_detail
  belongs_to :audit_work_order, optional: true
  belongs_to :communication_work_order, optional: true
  
  # 验证
  validates :fee_detail_id, uniqueness: { scope: :audit_work_order_id }, if: :audit_work_order_id?
  validates :fee_detail_id, uniqueness: { scope: :communication_work_order_id }, if: :communication_work_order_id?
  validate :ensure_one_work_order_association
  
  # 常量
  VERIFICATION_STATUS_PENDING = 'pending'
  VERIFICATION_STATUS_VERIFIED = 'verified'
  VERIFICATION_STATUS_REJECTED = 'rejected'
  VERIFICATION_STATUS_PROBLEMATIC = 'problematic'
  
  # 范围
  scope :pending, -> { where(verification_status: VERIFICATION_STATUS_PENDING) }
  scope :verified, -> { where(verification_status: VERIFICATION_STATUS_VERIFIED) }
  scope :rejected, -> { where(verification_status: VERIFICATION_STATUS_REJECTED) }
  scope :problematic, -> { where(verification_status: VERIFICATION_STATUS_PROBLEMATIC) }
  
  # 方法
  def verified?
    verification_status == VERIFICATION_STATUS_VERIFIED
  end
  
  def rejected?
    verification_status == VERIFICATION_STATUS_REJECTED
  end
  
  def problematic?
    verification_status == VERIFICATION_STATUS_PROBLEMATIC
  end
  
  def pending?
    verification_status == VERIFICATION_STATUS_PENDING
  end
  
  def mark_as_verified(admin_user_id = nil, comment = nil)
    update(
      verification_status: VERIFICATION_STATUS_VERIFIED,
      verification_comment: comment,
      verified_by: admin_user_id,
      verified_at: Time.current
    )
  end
  
  def mark_as_rejected(admin_user_id = nil, comment = nil)
    update(
      verification_status: VERIFICATION_STATUS_REJECTED,
      verification_comment: comment,
      verified_by: admin_user_id,
      verified_at: Time.current
    )
  end
  
  def mark_as_problematic(admin_user_id = nil, comment = nil)
    update(
      verification_status: VERIFICATION_STATUS_PROBLEMATIC,
      verification_comment: comment,
      verified_by: admin_user_id,
      verified_at: Time.current
    )
  end
  
  def work_order
    audit_work_order || communication_work_order
  end
  
  private
  
  def ensure_one_work_order_association
    if audit_work_order_id.blank? && communication_work_order_id.blank?
      errors.add(:base, "必须关联到审核工单或沟通工单")
    end
    
    if audit_work_order_id.present? && communication_work_order_id.present?
      errors.add(:base, "不能同时关联到审核工单和沟通工单")
    end
  end
  
  # ActiveAdmin配置
  def self.ransackable_attributes(auth_object = nil)
    %w[id fee_detail_id audit_work_order_id communication_work_order_id verification_status verification_comment verified_by verified_at created_at updated_at]
  end
  
  def self.ransackable_associations(auth_object = nil)
    %w[fee_detail audit_work_order communication_work_order]
  end
end
```

### 3. 更新费用明细模型关联

修改 `app/models/fee_detail.rb` 文件，添加与费用明细选择的关联：

```ruby
# app/models/fee_detail.rb
class FeeDetail < ApplicationRecord
  # 其他代码...
  
  # 关联
  belongs_to :reimbursement, foreign_key: 'document_number', primary_key: 'invoice_number', optional: true
  has_many :fee_detail_selections, dependent: :destroy
  has_many :audit_work_orders, through: :fee_detail_selections
  has_many :communication_work_orders, through: :fee_detail_selections
  
  # 其他代码...
end
```

### 4. 更新审核工单模型关联

修改 `app/models/audit_work_order.rb` 文件，添加与费用明细选择的关联：

```ruby
# app/models/audit_work_order.rb
class AuditWorkOrder < ApplicationRecord
  # 其他代码...
  
  # 关联
  belongs_to :reimbursement
  belongs_to :express_receipt_work_order, optional: true
  has_many :communication_work_orders, dependent: :nullify
  has_many :fee_detail_selections, dependent: :destroy
  has_many :fee_details, through: :fee_detail_selections
  has_many :work_order_status_changes, as: :work_order, dependent: :destroy
  
  # 其他代码...
  
  # 费用明细选择方法
  def select_fee_detail(fee_detail)
    fee_detail_selections.find_or_create_by(fee_detail: fee_detail) do |selection|
      selection.verification_status = 'pending'
    end
  end
  
  def verify_fee_detail(fee_detail, verification_status, comment = nil)
    selection = fee_detail_selections.find_by(fee_detail: fee_detail)
    return false unless selection
    
    case verification_status
    when 'verified'
      selection.mark_as_verified(Current.admin_user&.id, comment)
      fee_detail.mark_as_verified
    when 'rejected'
      selection.mark_as_rejected(Current.admin_user&.id, comment)
      fee_detail.mark_as_rejected
    when 'problematic'
      selection.mark_as_problematic(Current.admin_user&.id, comment)
      fee_detail.mark_as_problematic
    else
      return false
    end
    
    true
  end
  
  # 其他代码...
end
```

### 5. 更新沟通工单模型关联

修改 `app/models/communication_work_order.rb` 文件，添加与费用明细选择的关联：

```ruby
# app/models/communication_work_order.rb
class CommunicationWorkOrder < ApplicationRecord
  # 其他代码...
  
  # 关联
  belongs_to :reimbursement
  belongs_to :audit_work_order
  has_many :communication_records, dependent: :destroy
  has_many :fee_detail_selections, dependent: :destroy
  has_many :fee_details, through: :fee_detail_selections
  has_many :work_order_status_changes, as: :work_order, dependent: :destroy
  
  # 其他代码...
  
  # 费用明细选择方法
  def select_fee_detail(fee_detail)
    fee_detail_selections.find_or_create_by(fee_detail: fee_detail) do |selection|
      selection.verification_status = 'problematic'
    end
  end
  
  def resolve_fee_detail_issue(fee_detail, resolution)
    selection = fee_detail_selections.find_by(fee_detail: fee_detail)
    return false unless selection
    
    # 更新选择记录
    selection.update(
      verification_comment: resolution
    )
    
    true
  end
  
  # 其他代码...
end
```

### 6. 创建费用明细选择模型测试

创建 `spec/models/fee_detail_selection_spec.rb` 文件：

```ruby
# spec/models/fee_detail_selection_spec.rb
require 'rails_helper'

RSpec.describe FeeDetailSelection, type: :model do
  describe 'associations' do
    it { should belong_to(:fee_detail) }
    it { should belong_to(:audit_work_order).optional }
    it { should belong_to(:communication_work_order).optional }
  end
  
  describe 'validations' do
    let(:fee_detail) { create(:fee_detail) }
    let(:audit_work_order) { create(:audit_work_order) }
    let(:communication_work_order) { create(:communication_work_order) }
    
    it 'validates uniqueness of fee_detail_id scoped to audit_work_order_id' do
      create(:fee_detail_selection, fee_detail: fee_detail, audit_work_order: audit_work_order)
      duplicate = build(:fee_detail_selection, fee_detail: fee_detail, audit_work_order: audit_work_order)
      expect(duplicate).not_to be_valid
    end
    
    it 'validates uniqueness of fee_detail_id scoped to communication_work_order_id' do
      create(:fee_detail_selection, fee_detail: fee_detail, communication_work_order: communication_work_order)
      duplicate = build(:fee_detail_selection, fee_detail: fee_detail, communication_work_order: communication_work_order)
      expect(duplicate).not_to be_valid
    end
    
    it 'requires at least one work order association' do
      selection = build(:fee_detail_selection, fee_detail: fee_detail, audit_work_order: nil, communication_work_order: nil)
      expect(selection).not_to be_valid
      expect(selection.errors[:base]).to include("必须关联到审核工单或沟通工单")
    end
    
    it 'prevents association with both work order types' do
      selection = build(:fee_detail_selection, fee_detail: fee_detail, audit_work_order: audit_work_order, communication_work_order: communication_work_order)
      expect(selection).not_to be_valid
      expect(selection.errors[:base]).to include("不能同时关联到审核工单和沟通工单")
    end
  end
  
  describe 'scopes' do
    before do
      @pending = create(:fee_detail_selection, verification_status: 'pending')
      @verified = create(:fee_detail_selection, verification_status: 'verified')
      @rejected = create(:fee_detail_selection, verification_status: 'rejected')
      @problematic = create(:fee_detail_selection, verification_status: 'problematic')
    end
    
    it 'returns pending selections' do
      expect(FeeDetailSelection.pending).to include(@pending)
      expect(FeeDetailSelection.pending).not_to include(@verified, @rejected, @problematic)
    end
    
    it 'returns verified selections' do
      expect(FeeDetailSelection.verified).to include(@verified)
      expect(FeeDetailSelection.verified).not_to include(@pending, @rejected, @problematic)
    end
    
    it 'returns rejected selections' do
      expect(FeeDetailSelection.rejected).to include(@rejected)
      expect(FeeDetailSelection.rejected).not_to include(@pending, @verified, @problematic)
    end
    
    it 'returns problematic selections' do
      expect(FeeDetailSelection.problematic).to include(@problematic)
      expect(FeeDetailSelection.problematic).not_to include(@pending, @verified, @rejected)
    end
  end
  
  describe 'methods' do
    let(:selection) { create(:fee_detail_selection, verification_status: 'pending') }
    let(:admin_user) { create(:admin_user) }
    
    it 'marks as verified' do
      selection.mark_as_verified(admin_user.id, '验证通过')
      expect(selection.verification_status).to eq('verified')
      expect(selection.verification_comment).to eq('验证通过')
      expect(selection.verified_by).to eq(admin_user.id)
      expect(selection.verified_at).to be_present
    end
    
    it 'marks as rejected' do
      selection.mark_as_rejected(admin_user.id, '验证拒绝')
      expect(selection.verification_status).to eq('rejected')
      expect(selection.verification_comment).to eq('验证拒绝')
      expect(selection.verified_by).to eq(admin_user.id)
      expect(selection.verified_at).to be_present
    end
    
    it 'marks as problematic' do
      selection.mark_as_problematic(admin_user.id, '验证有问题')
      expect(selection.verification_status).to eq('problematic')
      expect(selection.verification_comment).to eq('验证有问题')
      expect(selection.verified_by).to eq(admin_user.id)
      expect(selection.verified_at).to be_present
    end
    
    it 'returns the associated work order' do
      audit_work_order = create(:audit_work_order)
      selection.update(audit_work_order: audit_work_order)
      expect(selection.work_order).to eq(audit_work_order)
      
      communication_work_order = create(:communication_work_order)
      selection.update(audit_work_order: nil, communication_work_order: communication_work_order)
      expect(selection.work_order).to eq(communication_work_order)
    end
  end
end
```

### 7. 创建费用明细选择工厂

创建 `spec/factories/fee_detail_selections.rb` 文件：

```ruby
# spec/factories/fee_detail_selections.rb
FactoryBot.define do
  factory :fee_detail_selection do
    association :fee_detail
    association :audit_work_order
    verification_status { 'pending' }
    verification_comment { nil }
    verified_by { nil }
    verified_at { nil }
    
    trait :with_audit_work_order do
      communication_work_order { nil }
    end
    
    trait :with_communication_work_order do
      audit_work_order { nil }
      association :communication_work_order
    end
    
    trait :pending do
      verification_status { 'pending' }
    end
    
    trait :verified do
      verification_status { 'verified' }
      verification_comment { '验证通过' }
      verified_by { 1 }
      verified_at { Time.current }
    end
    
    trait :rejected do
      verification_status { 'rejected' }
      verification_comment { '验证拒绝' }
      verified_by { 1 }
      verified_at { Time.current }
    end
    
    trait :problematic do
      verification_status { 'problematic' }
      verification_comment { '验证有问题' }
      verified_by { 1 }
      verified_at { Time.current }
    end
  end
end
```

### 8. 创建费用明细选择ActiveAdmin配置

创建 `app/admin/fee_detail_selections.rb` 文件：

```ruby
# app/admin/fee_detail_selections.rb
ActiveAdmin.register FeeDetailSelection do
  # 权限控制
  permit_params :fee_detail_id, :audit_work_order_id, :communication_work_order_id, 
                :verification_status, :verification_comment, :verified_by, :verified_at
  
  # 菜单设置
  menu priority: 6, label: "费用明细选择"
  
  # 过滤器
  filter :fee_detail
  filter :audit_work_order
  filter :communication_work_order
  filter :verification_status, as: :select, collection: ["pending", "verified", "rejected", "problematic"]
  filter :verified_by
  filter :verified_at
  filter :created_at
  
  # 列表页
  index do
    selectable_column
    id_column
    column :fee_detail do |selection|
      link_to "#{selection.fee_detail.document_number} - #{selection.fee_detail.fee_type}", admin_fee_detail_path(selection.fee_detail)
    end
    column :work_order do |selection|
      if selection.audit_work_order
        link_to "审核工单 ##{selection.audit_work_order.id}", admin_audit_work_order_path(selection.audit_work_order)
      elsif selection.communication_work_order
        link_to "沟通工单 ##{selection.communication_work_order.id}", admin_communication_work_order_path(selection.communication_work_order)
      end
    end
    column :verification_status do |selection|
      status_tag selection.verification_status
    end
    column :verification_comment
    column :verified_by
    column :verified_at
    column :created_at
    actions
  end
  
  # 详情页
  show do
    attributes_table do
      row :id
      row :fee_detail do |selection|
        link_to "#{selection.fee_detail.document_number} - #{selection.fee_detail.fee_type}", admin_fee_detail_path(selection.fee_detail)
      end
      row :audit_work_order do |selection|
        link_to "审核工单 ##{selection.audit_work_order.id}", admin_audit_work_order_path(selection.audit_work_order) if selection.audit_work_order
      end
      row :communication_work_order do |selection|
        link_to "沟通工单 ##{selection.communication_work_order.id}", admin_communication_work_order_path(selection.communication_work_order) if selection.communication_work_order
      end
      row :verification_status do |selection|
        status_tag selection.verification_status
      end
      row :verification_comment
      row :verified_by
      row :verified_at
      row :created_at
      row :updated_at
    end
  end
  
  # 表单
  form do |f|
    f.inputs "费用明细选择信息" do
      f.input :fee_detail
      f.input :audit_work_order, as: :select, collection: AuditWorkOrder.all.map { |w| ["审核工单 ##{w.id}", w.id] }
      f.input :communication_work_order, as: :select, collection: CommunicationWorkOrder.all.map { |w| ["沟通工单 ##{w.id}", w.id] }
      f.input :verification_status, as: :select, collection: ["pending", "verified", "rejected", "problematic"]
      f.input :verification_comment
      f.input :verified_by
      f.input :verified_at, as: :datepicker
    end
    f.actions
  end
end
```

## 测试验证方法

1. 运行数据库迁移：`rails db:migrate`
2. 运行模型测试：`rspec spec/models/fee_detail_selection_spec.rb`
3. 在Rails控制台中测试模型功能：
   ```ruby
   # 创建测试数据
   reimbursement = Reimbursement.create!(
     invoice_number: "R20250101001",
     document_name: "测试报销单",
     applicant: "张三",
     applicant_id: "EMP001",
     company: "测试公司",
     department: "测试部门",
     amount: 1000.00,
     is_electronic: false,
     is_complete: false,
     reimbursement_status: 'processing'
   )
   
   fee_detail = FeeDetail.create!(
     document_number: reimbursement.invoice_number,
     fee_type: "交通费",
     amount: 100.00,
     currency: "CNY",
     verification_status: "pending"
   )
   
   audit_work_order = AuditWorkOrder.create!(
     reimbursement: reimbursement,
     status: 'pending',
     created_by: 1
   )
   
   # 测试审核工单选择费用明细
   selection = audit_work_order.select_fee_detail(fee_detail)
   puts "选择ID: #{selection.id}"
   puts "费用明细ID: #{selection.fee_detail_id}"
   puts "审核工单ID: #{selection.audit_work_order_id}"
   puts "验证状态: #{selection.verification_status}"
   
   # 测试验证费用明细
   audit_work_order.verify_fee_detail(fee_detail, 'verified', '验证通过')
   selection.reload
   puts "验证状态: #{selection.verification_status}"
   puts "验证意见: #{selection.verification_comment}"
   puts "验证时间: #{selection.verified_at}"
   
   # 测试沟通工单选择费用明细
   communication_work_order = CommunicationWorkOrder.create!(
     reimbursement: reimbursement,
     audit_work_order: audit_work_order,
     status: 'open',
     created_by: 1
   )
   
   fee_detail2 = FeeDetail.create!(
     document_number: reimbursement.invoice_number,
     fee_type: "餐饮费",
     amount: 200.00,
     currency: "CNY",
     verification_status: "pending"
   )
   
   selection2 = communication_work_order.select_fee_detail(fee_detail2)
   puts "选择ID: #{selection2.id}"
   puts "费用明细ID: #{selection2.fee_detail_id}"
   puts "沟通工单ID: #{selection2.communication_work_order_id}"
   puts "验证状态: #{selection2.verification_status}"
   
   # 测试解决费用明细问题
   communication_work_order.resolve_fee_detail_issue(fee_detail2, '问题已解决')
   selection2.reload
   puts "验证意见: #{selection2.verification_comment}"
   ```
4. 启动Rails服务器，访问ActiveAdmin界面，测试费用明细选择功能

## 注意事项

1. 确保费用明细选择模型的验证规则正确实现，特别是确保一个费用明细只能关联到一个审核工单或沟通工单
2. 确保费用明细选择模型的关联关系正确实现，特别是与费用明细、审核工单和沟通工单的关联
3. 确保费用明细选择模型的验证状态更新方法正确实现，特别是验证时间和验证人的记录
4. 确保费用明细选择模型的作用域和查询方法正确实现，便于查询不同验证状态的费用明细选择
5. 确保费用明细选择模型的ActiveAdmin配置正确实现，便于在管理界面中管理费用明细选择
6. 注意费用明细选择模型是连接费用明细和工单的关键模型，需要确保其正确性和稳定性