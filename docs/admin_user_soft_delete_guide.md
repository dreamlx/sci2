# AdminUser 软删除功能使用指南

## 功能概述

AdminUser模块现已支持软删除功能，允许您安全地"删除"用户而不影响系统的数据完整性。被软删除的用户将无法登录系统，但其历史操作记录仍然保留。

## 主要特性

### 1. 状态管理
- **active** (活跃) - 用户可以正常登录和操作
- **inactive** (非活跃) - 用户存在但暂时禁用
- **suspended** (暂停) - 用户被暂停使用
- **deleted** (已删除) - 用户被软删除

### 2. 软删除功能
- 保留用户所有历史数据
- 被删除用户无法登录系统
- 可以随时恢复被删除的用户
- 不影响关联数据（工单操作、报销单分配等）

### 3. 权限控制
- 超级管理员可以软删除和恢复用户
- 普通管理员无法执行删除操作
- 被删除的用户没有任何系统权限

## 使用方法

### 在ActiveAdmin界面中

#### 单个用户操作
1. 进入"管理员用户"页面
2. 找到目标用户，点击"查看"或编辑
3. 在用户详情页面点击"软删除"按钮
4. 确认删除操作
5. 如需恢复，点击"恢复"按钮

#### 批量操作
1. 在列表页面选择多个用户（使用复选框）
2. 点击"批量操作"下拉菜单
3. 选择"软删除"、"恢复"或其他状态操作
4. 确认批量操作

#### 过滤和查看
- 使用顶部的scope标签快速过滤用户状态
- 使用侧边栏过滤器按状态、角色等条件筛选
- 查看用户详情时可以看到关联的报销单分配和工单操作记录

### 在代码中使用

#### 软删除用户
```ruby
user = AdminUser.find(id)
user.soft_delete  # 状态变为deleted，设置deleted_at时间
```

#### 恢复用户
```ruby
user = AdminUser.find(id)
user.restore      # 状态变为active，清除deleted_at
```

#### 检查用户状态
```ruby
user.active?      # 是否为活跃状态
user.deleted?     # 是否被软删除
user.status_display # 获取状态的中文显示名称
```

#### 使用scope过滤
```ruby
AdminUser.available     # 获取非删除状态的用户
AdminUser.deleted       # 获取已删除的用户
AdminUser.active_users  # 获取活跃的用户
```

#### 权限检查
```ruby
ability = Ability.new(current_user)
ability.can?(:soft_delete, AdminUser)  # 检查是否可以软删除用户
ability.can?(:restore, AdminUser)      # 检查是否可以恢复用户
```

## 注意事项

### 1. 数据安全
- 软删除不会真正删除用户数据，只是改变状态
- 关联的工单操作记录会保留（admin_user_id设为null）
- 报销单分配记录会保留，但分配者信息会显示为"已删除用户"

### 2. 登录限制
- 被软删除的用户无法通过Devise认证登录
- 状态为inactive或suspended的用户仍然可以登录
- 只有deleted状态的用户会被完全禁止登录

### 3. 权限管理
- 超级管理员不能软删除自己
- 普通管理员无法执行任何删除或恢复操作
- 被删除的用户没有任何系统权限

### 4. 性能考虑
- 添加了数据库索引以提高查询性能
- 建议在查询活跃用户时使用`active_users` scope
- 大量用户数据时，使用分页和过滤功能

## 故障排除

### 用户无法登录
1. 检查用户状态是否为`deleted`
2. 检查`deleted_at`字段是否有值
3. 确认用户没有被硬删除

### 软删除按钮不显示
1. 确认当前用户有超级管理员权限
2. 检查Ability配置是否正确
3. 确认目标用户不是当前登录用户

### 批量操作无效
1. 确认选择了用户
2. 检查浏览器控制台是否有JavaScript错误
3. 确认当前用户有执行批量操作的权限

## 最佳实践

1. **定期清理** - 定期检查已删除的用户，决定是否需要永久删除
2. **审计日志** - 记录所有软删除和恢复操作
3. **用户通知** - 在软删除用户前发送通知
4. **数据备份** - 定期备份用户数据
5. **权限最小化** - 只给必要的人员删除权限

## 技术实现

### 数据库结构
- `status` - 用户状态（active/inactive/suspended/deleted）
- `deleted_at` - 软删除时间戳
- 索引优化 - 为status和deleted_at字段添加索引

### 模型方法
- `soft_delete` - 执行软删除
- `restore` - 恢复用户
- `deleted?` - 检查是否被删除
- `active_for_authentication?` - Devise认证覆盖

### ActiveAdmin集成
- 自定义scope和过滤器
- 批量操作支持
- 状态标签显示
- 关联数据显示

这个软删除系统提供了安全、灵活的用户管理功能，同时保持了数据的完整性和系统的稳定性。
