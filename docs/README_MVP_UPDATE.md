# 工单系统MVP更新说明

本文档说明了基于财务经理反馈的工单系统MVP更新内容。

## 一、更新内容概述

根据财务经理在MVP部署上线后提供的新理解，我们对工单系统进行了以下更新：

1. **数据模型更新**
   - 新增沟通记录表（CommunicationRecord）
   - 新增费用明细选择表（FeeDetailSelection）
   - 更新工单表，增加沟通相关字段

2. **业务逻辑更新**
   - 快递收单导入与匹配逻辑优化
   - 费用明细多选与工单创建功能
   - 多轮沟通记录管理
   - 操作历史处理与报销单关闭

3. **用户界面更新**
   - 报销单详情页（费用明细多选）
   - 工单详情页（多轮沟通）
   - 快递收单导入结果页

## 二、数据库迁移

执行以下命令运行数据库迁移：

```bash
rails db:migrate
```

这将创建新的表并更新现有表结构。

## 三、功能说明

### 1. 快递收单导入与匹配

- 导入快递收单CSV时，系统会自动匹配报销单
- 对于未匹配的快递单，提供手动匹配功能
- 匹配成功后自动生成工单

### 2. 费用明细多选功能

- 在报销单详情页可以选择多个费用明细
- 可以基于选中的费用明细创建工单
- 工单详情页显示关联的费用明细及其验证状态

### 3. 多轮沟通记录管理

- 工单详情页可以添加沟通记录
- 沟通记录包含角色、内容、方式等信息
- 工单状态会根据沟通记录自动更新

### 4. 操作历史处理与报销单关闭

- 导入操作历史时，系统会识别审批通过的记录
- 对于审批通过的报销单，自动标记为已关闭
- 对于需补件的操作，自动创建沟通工单

## 四、使用流程

### 导入数据的正确顺序

1. 导入报销单数据
2. 导入快递收单数据
3. 导入费用明细数据
4. 导入操作历史数据

### 工单处理流程

1. 快递收单匹配后自动生成工单
2. 在报销单详情页选择费用明细创建工单
3. 在工单详情页添加沟通记录
4. 标记费用明细问题为已解决
5. 完成工单处理

## 五、测试

系统包含以下测试：

- 模型测试：测试新增模型的基本功能
- 集成测试：测试各功能模块的交互

运行测试：

```bash
rails test
```

## 六、注意事项

- 确保按照正确的顺序导入数据
- 费用明细多选功能需要至少选择一个费用明细
- 沟通记录添加后会自动更新工单状态
- 操作历史中的审批通过记录会自动关闭报销单

## 七、后续计划

- 优化用户界面，提升用户体验
- 增加数据统计和报表功能
- 完善权限管理
- 增加批量处理功能