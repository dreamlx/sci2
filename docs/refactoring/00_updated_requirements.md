# SCI2 工单系统需求更新与重构调整

根据对数据导入格式参考和测试计划的深入分析，以及与用户的沟通确认，我们对系统需求有了更清晰的理解，并相应地调整了重构计划。

## 1. 数据导入需求

### 1.1 数据导入顺序

- **必须先导入报销单**，然后才能导入快递收单、费用明细和操作历史（这三者顺序可灵活）
- 报销单的invoice number是关键字段，其他数据导入都依赖于此
- 系统需要验证报销单存在后才允许导入其他数据

### 1.2 导入数据类型

系统需要处理四种CSV导入数据：

1. **报销单报表**：包含报销单基本信息，如单号、申请人、金额等
2. **快递收单导出数据**：包含快递收单信息，如单号、快递单号、收单时间等
3. **单据费用明细报表**：包含费用明细信息，如费用类型、金额、发生日期等
4. **每单操作历史数据**：包含操作历史信息，如操作类型、操作人、操作时间等

### 1.3 导入处理逻辑

- **报销单导入**：
  - 检查报销单是否已存在，存在则更新，不存在则创建
  - 对于电子发票，标记`is_electronic = true`
  - 对于非电子发票报销单，自动创建审核工单

- **快递收单导入**：
  - 从操作意见中提取快递单号
  - 检查是否存在匹配的报销单
  - 创建快递收单记录并关联到报销单
  - 自动创建快递收单工单

- **费用明细导入**：
  - 检查是否存在匹配的报销单
  - 创建费用明细记录并关联到报销单
  - 设置验证状态为"待验证"

- **操作历史导入**：
  - 创建操作历史记录并关联到报销单
  - 根据操作类型更新报销单状态
  - 如果操作类型包含"审批通过"，标记报销单为已完成

## 2. 工单流程需求

### 2.1 工单创建逻辑

- **快递收单工单**：
  - 在导入快递收单数据时自动创建
  - 初始状态为"received"

- **审核工单**：有两种创建路径
  1. 导入非电子发票报销单时自动创建
  2. 快递收单工单完成后自动创建
  - 初始状态为"pending"

- **沟通工单**：
  - 只能由审核工单创建
  - 可以关联0到多个费用明细
  - 初始状态为"open"

### 2.2 工单状态流转

- **快递收单工单**：
  ```
  [创建] --> received --> processed --> completed
  ```

- **审核工单**：
  ```
  [创建] --> pending --> processing --> auditing --> approved --> completed
                                     |          |
                                     |          v
                                     |       rejected --> completed
                                     v
                               needs_communication --> auditing
  ```

- **沟通工单**：
  ```
  [创建] --> open --> in_progress --> resolved --> closed
                                  |
                                  v
                              unresolved --> closed
  ```

### 2.3 费用明细验证状态流转

- **导入时**：初始状态为"待验证"(pending)
- **审核过程中**：
  - 审核人员可以将费用明细标记为"已验证"(verified)
  - 或标记为"有问题"(problematic)并创建沟通工单
- **沟通工单解决后**：
  - 费用明细状态保持为"有问题"(problematic)
  - 需要审核人员手动将其更改为"已验证"(verified)或"已拒绝"(rejected)
- **审核工单完成时**：
  - 审核通过的费用明细最终状态为"已验证"(verified)
  - 审核拒绝的费用明细最终状态为"已拒绝"(rejected)

## 3. 重构计划调整

基于以上需求理解，我们对重构计划做以下调整：

### 3.1 数据库结构调整

- 确保报销单表(reimbursements)、快递收单表(express_receipt_work_orders)、审核工单表(audit_work_orders)和沟通工单表(communication_work_orders)之间有正确的外键关联
- 在费用明细选择表(fee_detail_selections)中添加适当的外键，支持关联到审核工单或沟通工单

### 3.2 数据导入服务调整

- 修改ReimbursementImportService，实现非电子发票报销单的审核工单自动创建
- 修改ExpressReceiptImportService，实现快递收单工单自动创建
- 修改FeeDetailImportService，确保费用明细初始状态为"待验证"
- 修改OperationHistoryImportService，实现根据操作类型更新报销单状态

### 3.3 工单模型调整

- 在ExpressReceiptWorkOrder模型中实现完成后自动创建审核工单
- 在AuditWorkOrder模型中实现创建沟通工单的功能，支持关联0到多个费用明细
- 在CommunicationWorkOrder模型中实现解决后通知审核工单的功能

### 3.4 费用明细验证服务调整

- 确保FeeDetailVerificationService实现正确的状态流转逻辑
- 在沟通工单解决后不自动更新费用明细状态
- 提供方法让审核人员手动更新费用明细状态

### 3.5 ActiveAdmin集成调整

- 确保导入界面支持四种数据类型的导入
- 提供清晰的费用明细验证界面
- 实现沟通工单与费用明细的关联功能
- 确保工单状态流转按照定义的流程进行

## 4. 测试策略调整

- 添加测试用例验证数据导入顺序的强制要求
- 测试非电子发票报销单导入时自动创建审核工单
- 测试快递收单工单完成后自动创建审核工单
- 测试沟通工单可以关联0到多个费用明细
- 测试费用明细验证状态流转的完整流程，特别是沟通解决后状态不自动更新的情况