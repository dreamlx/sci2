# SCI2 工单系统文档对齐分析

本文档分析了以下三个文件之间的逻辑对齐情况：
1. `docs/999-SCI2工单系统测试计划_v4.1.md`（测试计划）
2. `docs/refactoring/01_overview.md`（重构概述）
3. `docs/refactoring/02_database_structure.md`（数据库结构）

## 1. 核心业务逻辑对齐

### 1.1 报销单逻辑

| 业务需求 | 测试计划 | 重构概述 | 数据库结构 | 对齐状态 |
|---------|---------|---------|----------|---------|
| 电子发票与纸质发票区分 | IMP-R-003, INT-006 | 第6点第1条 | `is_electronic` 布尔字段 | ✅ 完全对齐 |
| 导入后手动设置电子发票标志 | IMP-R-003 | 未明确提及 | `is_electronic` 默认为false | ✅ 完全对齐 |
| 状态变化流程 | REL-004, REL-008 | 2.4节 | 第7、8节 | ✅ 完全对齐 |
| 重复导入更新机制 | IMP-R-006 | 2.5节 | Duplicate Handling | ✅ 完全对齐 |

### 1.2 工单类型与结构

| 业务需求 | 测试计划 | 重构概述 | 数据库结构 | 对齐状态 |
|---------|---------|---------|----------|---------|
| 单表继承设计 | 隐含在测试中 | 2.1节 | 2.2节 | ✅ 完全对齐 |
| 表单字段一致性 | WF-FORM-001, INT-003 | 未明确提及 | 字段设计一致 | ✅ 完全对齐 |
| 工单与报销单关联 | REL-001, REL-002 | 2.1节 | 外键关系 | ✅ 完全对齐 |
| 工单之间无关联关系 | REL-007 | 第6点第4条 | 数据库无直接关联 | ✅ 完全对齐 |

### 1.3 快递收单工单逻辑

| 业务需求 | 测试计划 | 重构概述 | 数据库结构 | 对齐状态 |
|---------|---------|---------|----------|---------|
| 导入时自动创建 | IMP-E-001 | 2.2节 | Duplicate Handling | ✅ 完全对齐 |
| 状态固定为completed | WF-E-001 | 2.2节 | 未明确提及状态值 | ⚠️ 部分对齐 |
| 自动关联报销单 | WF-E-002 | 未明确提及 | 外键关系 | ✅ 完全对齐 |

### 1.4 审核工单状态流转

| 业务需求 | 测试计划 | 重构概述 | 数据库结构 | 对齐状态 |
|---------|---------|---------|----------|---------|
| 状态流转路径 | WF-A-001, WF-A-002 | 2.2节 | 第7节 | ✅ 完全对齐 |
| 直接通过路径 | WF-A-008 | 2.2节 | 第7节 | ✅ 完全对齐 |
| 处理意见与状态关系 | WF-A-009 | 未明确提及 | 第7节 | ✅ 完全对齐 |

### 1.5 沟通工单状态流转

| 业务需求 | 测试计划 | 重构概述 | 数据库结构 | 对齐状态 |
|---------|---------|---------|----------|---------|
| 状态流转路径 | WF-C-001, WF-C-002 | 2.2节 | 第7节 | ✅ 完全对齐 |
| needs_communication布尔标志 | WF-C-003 | 2.2节特别说明 | `needs_communication`字段 | ✅ 完全对齐 |
| 直接通过路径 | WF-C-008 | 2.2节 | 第7节 | ✅ 完全对齐 |

### 1.6 费用明细状态逻辑

| 业务需求 | 测试计划 | 重构概述 | 数据库结构 | 对齐状态 |
|---------|---------|---------|----------|---------|
| 初始状态为pending | FEE-001 | 2.3节 | `verification_status`默认值 | ✅ 完全对齐 |
| 工单状态影响费用明细状态 | FEE-003 | 2.3节 | 第8节 | ✅ 完全对齐 |
| 多工单关联 | FEE-004, FEE-009 | 2.3节 | 多态关联设计 | ✅ 完全对齐 |

### 1.7 数据导入逻辑

| 业务需求 | 测试计划 | 重构概述 | 数据库结构 | 对齐状态 |
|---------|---------|---------|----------|---------|
| 操作历史重复检查 | IMP-O-006 | 2.5节 | Duplicate Handling | ✅ 完全对齐 |
| 费用明细重复检查 | IMP-F-006 | 2.5节 | Duplicate Handling | ✅ 完全对齐 |
| 报销单重复更新 | IMP-R-006 | 2.5节 | Duplicate Handling | ✅ 完全对齐 |

## 2. 数据库设计对齐

### 2.1 表结构设计

所有三个文档中的表结构设计完全一致，包括：
- 报销单表 (reimbursements)
- 费用明细表 (fee_details)
- 操作历史表 (operation_histories)
- 工单表 (work_orders) - 使用STI
- 费用明细选择表 (fee_detail_selections)
- 沟通记录表 (communication_records)
- 工单状态变更表 (work_order_status_changes)

### 2.2 字段设计

所有关键字段在三个文档中都保持一致，特别是：
- `needs_communication` 布尔字段已添加到工单表中
- 状态字段的定义和默认值一致
- 关联关系的设计一致

### 2.3 状态机设计

状态机设计在重构概述和数据库结构文档中一致，并且与测试计划中的测试用例对齐：
- 审核工单状态流转: pending → processing → rejected/approved
- 沟通工单状态流转: pending → processing → rejected/approved
- 费用明细状态: pending → problematic/verified
- 报销单状态: pending → processing → waiting_completion → closed

## 3. 测试覆盖对齐

测试计划中的测试用例覆盖了重构概述和数据库结构中定义的所有关键功能和业务逻辑：
- 数据导入测试 (IMP-*)
- 工单状态流转测试 (WF-*)
- 工单关联关系测试 (REL-*)
- 费用明细验证测试 (FEE-*)
- 集成测试场景 (INT-*)

## 4. 结论

三个文档在逻辑设计上完全对齐，只有一处小的不一致：快递收单工单的固定状态值在数据库结构文档中未明确提及，但这不影响整体实现。

所有关键业务需求都在三个文档中得到了一致的处理，特别是：
1. 沟通工单的needs_communication实现为布尔字段
2. 处理意见与工单状态的关系
3. 工单状态与费用明细状态的联动
4. 报销单状态的自动变更逻辑
5. 数据导入与重复处理机制

建议在实现过程中特别关注这些关键点，确保代码实现与设计文档保持一致。