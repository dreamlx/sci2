# SCI2 工单系统重构计划总结

## 1. 重构背景与目标

SCI2工单系统是一个用于处理报销单收单、审核和沟通的内部系统。当前系统存在一些设计问题，包括表结构臃肿、多态关联复杂、工单之间的父子关系复杂等。通过重构，我们旨在解决这些问题，提高系统的性能、可维护性和可扩展性。

### 1.1 重构目标

1. **独立拆表**：为每种工单类型创建独立的表，避免表结构臃肿
2. **清晰的关联关系**：使用直接的外键关联替代多态关联，简化查询和提高性能
3. **状态机分离**：为每种工单类型实现独立的状态机，使状态流转更加清晰 https://github.com/state-machines/state_machines
4. **服务对象模式**：使用服务对象封装复杂的业务逻辑，保持模型的简洁
5. **ActiveAdmin优化**：针对拆分后的表结构优化ActiveAdmin配置

## 2. 重构计划文档结构

本重构计划分为以下几个文档：

1. **[概述](01_overview.md)**：提供重构的背景、目标和总体方案
2. **[数据库结构](02_database_structure.md)**：详细的数据库表设计和迁移计划
3. **[模型实现](03_model_implementation.md)**：各类工单模型和关联模型的实现细节
4. **[服务实现](04_service_implementation.md)**：数据导入和业务逻辑服务的实现细节
5. **[ActiveAdmin集成](05_activeadmin_integration.md)**：ActiveAdmin资源和界面的实现细节
6. **[测试策略](06_testing_strategy.md)**：单元测试、集成测试和系统测试的计划和实现

## 3. 核心设计决策

### 3.1 独立拆表设计

我们决定为每种工单类型创建独立的表，而不是使用单表继承(STI)。这一决策基于以下考虑：

1. **性能优化**：独立表可以避免单表过大导致的性能问题
2. **结构清晰**：每个表只包含与该类型工单相关的字段，减少表的宽度
3. **ActiveAdmin兼容性**：独立表更容易与ActiveAdmin集成
4. **查询简化**：直接的外键关联简化了查询，避免了多态关联的复杂性

### 3.2 工单类型与状态流转

我们定义了三种工单类型，每种类型有独立的状态流转：

1. **快递收单工单**：处理快递收单，状态流转为 received → processed → completed
2. **审核工单**：审核报销单和费用明细，状态流转为 pending → processing → auditing → approved/rejected → completed
3. **沟通工单**：处理审核过程中的沟通，状态流转为 open → in_progress → resolved/unresolved → closed

### 3.3 费用明细验证流程

费用明细有四种状态：待验证(pending)、已验证(verified)、有问题(problematic)、已拒绝(rejected)。

- 导入时：初始状态为"待验证"(pending)
- 审核过程中：可以标记为"已验证"(verified)或"有问题"(problematic)
- 沟通工单解决后：状态保持为"有问题"，需要审核人员手动更新
- 审核工单完成时：最终状态为"已验证"(verified)或"已拒绝"(rejected)

## 4. 实施路线图

### 4.1 阶段一：基础设计与准备（1周）

- 完善数据库设计
- 创建数据库迁移脚本
- 设计模型关联关系
- 准备测试环境和测试数据

### 4.2 阶段二：核心模型实现（2周）

- 实现基础工单功能
- 实现各类工单模型
- 实现工单状态流转逻辑
- 实现工单关联关系

### 4.3 阶段三：业务逻辑与服务（2周）

- 实现数据导入服务
- 实现工单处理服务
- 实现费用明细验证逻辑
- 实现状态变更记录逻辑

### 4.4 阶段四：界面与交互（2周）

- 实现ActiveAdmin资源
- 实现工单列表和详情页
- 实现状态转换操作
- 实现费用明细选择界面

### 4.5 阶段五：测试与优化（2周）

- 执行单元测试和集成测试
- 性能测试和优化
- 用户验收测试
- 部署准备

## 5. 预期成果

通过这次重构，我们预期达到以下成果：

1. **性能提升**：系统响应时间提高50%以上
2. **代码质量提升**：测试覆盖率达到85%以上
3. **维护性提升**：代码结构更清晰，模块化程度更高
4. **用户体验提升**：界面响应更快，操作流程更顺畅
5. **可扩展性提升**：更容易添加新的工单类型和功能

## 6. 风险与应对措施

### 6.1 风险

1. **代码重复**：不同工单类型的模型可能有重复代码
2. **关联复杂性**：多表之间的关联可能增加复杂性
3. **一致性维护**：跨表操作可能导致数据一致性问题
4. **迁移风险**：数据迁移可能导致数据丢失或不一致

### 6.2 应对措施

1. **关注点分离**：将共享逻辑提取到服务对象或关注点中
2. **清晰的命名和文档**：使用清晰的命名和文档，创建辅助方法简化关联查询
3. **事务保证**：使用事务确保操作的原子性，添加数据验证和约束
4. **迁移测试**：在测试环境中充分测试迁移脚本，准备回滚方案

## 7. 总结

通过这次完全重构，我们将实现一个更清晰、更高效的工单系统。独立拆表的设计将解决当前设计中的性能和维护问题，直接的外键关联将简化查询和提高性能，独立的状态机将使状态流转更加清晰。

这个重构计划提供了一个全面的路线图，从数据库设计到最终部署，确保项目能够按时、高质量地完成。