# SCI2 工单系统 ActiveAdmin 用户界面设计更新

## 1. 用户界面设计概述

SCI2工单系统的用户界面采用ActiveAdmin框架实现，基于单表继承(STI)模型设计。本文档更新反映了最新需求变更，特别是工单模型的单表继承设计和共享表单字段的实现。

### 1.1 主要变更

1. **单表继承模型**：确认使用单表继承(STI)模型实现工单类型
2. **工单关联关系**：移除工单之间的直接关联，所有工单类型直接关联到报销单
3. **共享表单字段**：审核工单和沟通工单表单结构基本相同
4. **工单状态流转**：更新状态流转逻辑
5. **费用明细验证**：统一验证状态流转

### 1.2 用户角色与权限

系统支持三种主要用户角色，均通过`admin_users`表创建：

1. **管理员**：系统管理员，拥有所有权限
2. **审核人员**：负责审核报销单及费用明细
3. **沟通人员**：负责与申请人沟通解决问题

在第一阶段实现中，我们先假设所有用户都是管理员权限，后续再根据需求细化权限控制。

## 2. 用户界面交互流程

### 2.1 报销单处理流程

```mermaid
sequenceDiagram
    participant 财务管理员
    participant 系统
    participant 审核人员
    participant 沟通人员
    
    财务管理员->>系统: 导入报销单
    财务管理员->>系统: 导入快递收单
    系统->>系统: 自动创建快递收单工单(completed)
    系统->>系统: 更新报销单状态为processing
    财务管理员->>系统: 导入费用明细
    财务管理员->>系统: 导入操作历史
    
    审核人员->>系统: 查看报销单详情
    审核人员->>系统: 创建审核工单
    审核人员->>系统: 选择费用明细
    审核人员->>系统: 填写问题信息
    审核人员->>系统: 提交审核工单(pending)
    
    审核人员->>系统: 开始处理审核工单
    系统->>系统: 更新工单状态为processing
    系统->>系统: 更新费用明细状态为problematic
    
    alt 直接审核通过
        审核人员->>系统: 审核通过
        系统->>系统: 更新工单状态为approved
        系统->>系统: 更新费用明细状态为verified
        系统->>系统: 检查所有费用明细是否verified
        系统->>系统: 如果全部verified，更新报销单状态为waiting_completion
    else 需要沟通
        审核人员->>系统: 审核拒绝
        系统->>系统: 更新工单状态为rejected
        
        沟通人员->>系统: 创建沟通工单
        沟通人员->>系统: 选择相同费用明细
        沟通人员->>系统: 填写问题信息
        沟通人员->>系统: 提交沟通工单(pending)
        
        沟通人员->>系统: 标记需沟通
        系统->>系统: 更新工单状态为needs_communication
        系统->>系统: 更新费用明细状态为problematic
        
        沟通人员->>系统: 添加沟通记录
        沟通人员->>系统: 沟通后通过
        系统->>系统: 更新工单状态为approved
        系统->>系统: 更新费用明细状态为verified
        系统->>系统: 检查所有费用明细是否verified
        系统->>系统: 如果全部verified，更新报销单状态为waiting_completion
    end
    
    系统->>系统: 导入包含"审批通过"的操作历史
    系统->>系统: 更新报销单状态为closed
```

### 2.2 工单状态流转图

#### 审核工单状态流转

```mermaid
stateDiagram-v2
    direction LR
    [*] --> pending
    pending --> processing : 开始处理
    processing --> approved : 审核通过
    processing --> rejected : 审核拒绝
    approved --> [*]
    rejected --> [*]
```

#### 沟通工单状态流转

```mermaid
stateDiagram-v2
    direction LR
    [*] --> pending
    pending --> processing : 开始处理
    pending --> needs_communication : 标记需沟通
    processing --> approved : 沟通后通过
    processing --> rejected : 沟通后拒绝
    needs_communication --> approved : 沟通后通过
    needs_communication --> rejected : 沟通后拒绝
    approved --> [*]
    rejected --> [*]
```

#### 报销单状态流转

```mermaid
stateDiagram-v2
    direction LR
    [*] --> pending : 导入
    pending --> processing : 创建工单
    processing --> waiting_completion : 所有费用明细verified
    waiting_completion --> closed : 导入审批通过操作历史
    closed --> [*]
```

## 3. 仪表盘设计

仪表盘需要更新以反映新的"等待完成"状态：

```mermaid
graph TD
    A[仪表盘] --> B[报销单状态统计]
    A --> C[待处理工单]
    A --> D[最近活动]
    A --> E[快速操作]
    
    B --> B1[待处理]
    B --> B2[处理中]
    B --> B3[等待完成]
    B --> B4[已关闭]
    
    C --> C1[待处理审核工单]
    C --> C2[待处理沟通工单]
    
    E --> E1[导入报销单]
    E --> E2[导入快递收单]
    E --> E3[导入费用明细]
    E --> E4[导入操作历史]
```

## 4. 工单模块界面设计

### 4.1 审核工单详情页

```mermaid
graph TD
    A[审核工单详情页] --> B[基本信息标签页]
    A --> C[费用明细标签页]
    A --> D[状态变更历史标签页]
    
    B --> B1[工单属性表]
    B --> B2[状态操作按钮]
    
    C --> C1[关联费用明细列表]
    C --> C2[费用明细验证状态]
    C --> C3[更新验证状态按钮]
    
    D --> D1[状态变更历史列表]
    
    B1 --> B1a[报销单]
    B1 --> B1b[状态]
    B1 --> B1c[问题类型]
    B1 --> B1d[问题说明]
    B1 --> B1e[备注说明]
    B1 --> B1f[处理意见]
    B1 --> B1g[审核结果]
    B1 --> B1h[审核意见]
    
    B2 --> B2a[开始处理]
    B2 --> B2b[审核通过]
    B2 --> B2c[审核拒绝]
```

### 4.2 沟通工单详情页

```mermaid
graph TD
    A[沟通工单详情页] --> B[基本信息标签页]
    A --> C[沟通记录标签页]
    A --> D[费用明细标签页]
    A --> E[状态变更历史标签页]
    
    B --> B1[工单属性表]
    B --> B2[状态操作按钮]
    
    C --> C1[沟通记录列表]
    C --> C2[添加沟通记录按钮]
    
    D --> D1[关联费用明细列表]
    D --> D2[费用明细验证状态]
    D --> D3[更新验证状态按钮]
    
    E --> E1[状态变更历史列表]
    
    B1 --> B1a[报销单]
    B1 --> B1b[状态]
    B1 --> B1c[问题类型]
    B1 --> B1d[问题说明]
    B1 --> B1e[备注说明]
    B1 --> B1f[处理意见]
    B1 --> B1g[沟通方式]
    B1 --> B1h[发起人角色]
    B1 --> B1i[解决方案摘要]
    
    B2 --> B2a[开始处理]
    B2 --> B2b[标记需沟通]
    B2 --> B2c[沟通后通过]
    B2 --> B2d[沟通后拒绝]
```

## 5. 表单设计

### 5.1 共享字段下拉列表选项

为审核工单和沟通工单的共享字段提供统一的下拉列表选项：

1. **问题类型下拉列表**
   - 发票问题
   - 金额错误
   - 费用类型错误
   - 缺少附件
   - 其他问题

2. **问题说明下拉列表**
   - 发票信息不完整
   - 发票金额与申报金额不符
   - 费用类型选择错误
   - 缺少必要证明材料
   - 其他问题说明

3. **处理意见下拉列表**
   - 需要补充材料
   - 需要修改申报信息
   - 需要重新提交
   - 可以通过
   - 无法通过

### 5.2 审核工单表单

```mermaid
graph TD
    A[审核工单表单] --> B[报销单信息]
    A --> C[工单基本信息]
    A --> D[费用明细选择]
    A --> E[提交按钮]
    
    C --> C1[状态]
    C --> C2[问题类型下拉列表]
    C --> C3[问题说明下拉列表]
    C --> C4[备注说明文本框]
    C --> C5[处理意见下拉列表]
    C --> C6[审核意见文本框]
    
    D --> D1[费用明细多选框]
```

### 5.3 沟通工单表单

```mermaid
graph TD
    A[沟通工单表单] --> B[报销单信息]
    A --> C[工单基本信息]
    A --> D[费用明细选择]
    A --> E[提交按钮]
    
    C --> C1[状态]
    C --> C2[问题类型下拉列表]
    C --> C3[问题说明下拉列表]
    C --> C4[备注说明文本框]
    C --> C5[处理意见下拉列表]
    C --> C6[沟通方式下拉列表]
    C --> C7[发起人角色下拉列表]
    C --> C8[解决方案摘要文本框]
    
    D --> D1[费用明细多选框]
```

## 6. 数据导入界面设计

数据导入界面需要更新以支持重复记录处理：

```mermaid
graph TD
    A[数据导入界面] --> B[文件选择]
    A --> C[导入选项]
    A --> D[导入按钮]
    A --> E[导入结果]
    
    B --> B1[文件上传控件]
    
    C --> C1[数据类型选择]
    C --> C2[重复处理策略]
    
    E --> E1[成功记录数]
    E --> E2[更新记录数]
    E --> E3[跳过记录数]
    E --> E4[错误记录数]
    E --> E5[错误详情]
    E --> E6[未匹配记录下载]
```

### 6.1 重复处理策略

- **报销单**：以invoice number为唯一键，重复时覆盖更新
- **费用明细**：完全相同记录跳过
- **操作历史**：完全相同记录跳过

## 7. 实施建议

1. **优先级排序**：
   - 首先更新数据库结构和模型实现
   - 然后更新服务层实现
   - 最后更新ActiveAdmin集成和UI设计

2. **测试策略**：
   - 确保单元测试覆盖单表继承模型的所有功能
   - 添加集成测试验证工单状态流转和费用明细状态变更
   - 测试数据导入的重复处理逻辑

3. **UI改进**：
   - 使用标准化的下拉列表选项
   - 确保表单字段布局一致
   - 提供清晰的状态流转操作按钮