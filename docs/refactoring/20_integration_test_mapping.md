# 集成测试映射文档

本文档解释了集成测试用户故事(`docs/integration_test_user_story.md`)与实际测试数据文件(`spec/fixtures/files/`)之间的映射关系，并提供了执行测试的具体指导。

## 1. 数据格式差异说明

### 1.1 报销单号格式

| 用户故事中的格式 | 测试数据文件中的格式 | 映射关系 |
|----------------|-------------------|---------|
| R2025001       | ER14228251        | R2025001 → ER14228251 |
| R2025002       | ER14228252        | R2025002 → ER14228252 |
| R2025003       | ER14228253        | R2025003 → ER14228253 |
| R2025004       | ER14228254        | R2025004 → ER14228254 |
| R2025005       | ER14228255        | R2025005 → ER14228255 |

### 1.2 CSV文件结构差异

#### 报销单数据文件

**用户故事中的结构**:
```
报销单单号,单据名称,报销单申请人,报销单申请人工号,申请人公司,申请人部门,收单状态,收单日期,提交报销日期,报销金额（单据币种）,报销单状态
```

**实际测试数据文件结构**:
```
报销单单号,单据名称,报销单申请人,报销单申请人工号,申请人公司,申请人部门,收单状态,收单日期,关联申请单号,提交报销日期,记账日期,报销单状态,当前审批节点,当前审批人,报销单审核通过日期,审核通过人,报销金额（单据币种）,弹性字段2,当前审批节点转入时间,首次提交时间,单据标签,弹性字段8
```

#### 快递收单数据文件

**用户故事中的结构**:
```
单据编号,操作类型,操作日期,操作人,操作意见
```

**实际测试数据文件结构**:
```
序号,单据类型,单号,申请人,操作时间,操作类型,操作意见
```

#### 费用明细数据文件

**用户故事中的结构**:
```
报销单单号,费用类型,原始金额,原始币种,费用发生日期,弹性字段11
```

**实际测试数据文件结构**:
```
所属月,费用类型,申请人名称,申请人工号,申请人公司,申请人部门,费用发生日期,原始金额,单据名称,报销单单号,关联申请单号,计划/预申请,产品,弹性字段11,弹性字段6(报销单),弹性字段7(报销单),费用id,首次提交日期,费用对应计划,费用关联申请单
```

#### 操作历史数据文件

**用户故事中的结构**:
```
单据编号,操作类型,操作日期,操作人,操作意见
```

**实际测试数据文件结构**:
```
表单类型,单据编号,申请人,员工工号,员工公司,员工部门,员工部门路径,员工单据公司,员工单据部门,员工单据部门路径,提交人,单据名称,币种,金额,创建日期,操作节点,操作类型,操作意见 ,操作日期,操作人
```

### 1.3 快递单号格式

| 用户故事中的格式 | 测试数据文件中的格式 | 映射关系 |
|----------------|-------------------|---------|
| SF1234567890   | 快递单号：SF1001    | SF1234567890 → 快递单号：SF1001 |

### 1.4 测试数据数量

用户故事中描述了10条报销单数据，而测试数据文件只包含5条报销单数据。执行测试时，可以使用这5条数据进行测试，或者根据需要添加更多测试数据。

## 2. 与费用明细状态简化的一致性

用户故事中的测试流程与我们实现的费用明细状态简化设计是一致的：

- 用户故事中只关注`FeeDetail.verification_status`的变化
- 没有提及`FeeDetailSelection.verification_status`字段
- 测试流程中描述的状态变更逻辑符合我们的简化设计，即：
  - 工单状态为`approved`时，费用明细状态变为`verified`
  - 其他任何工单状态，费用明细状态变为`problematic`
  - 费用明细可关联到多个工单，状态跟随最新处理的工单状态变化

## 3. 执行测试指南

### 3.1 数据导入阶段

1. 登录系统
2. 导入报销单数据
   - 使用`test_reimbursements.csv`
   - 验证成功导入5条报销单记录（而非用户故事中的10条）
   - 验证所有报销单状态为`pending`

3. 导入快递收单数据
   - 使用`test_express_receipts.csv`
   - 验证成功导入5条快递收单记录（而非用户故事中的10条）
   - 验证自动创建5个快递收单工单，状态为`completed`
   - 验证报销单状态变为`processing`（注意：这与用户故事中描述的"状态仍为pending"不同）

4. 导入费用明细数据
   - 使用`test_fee_details.csv`
   - 验证成功导入5条费用明细记录（而非用户故事中的19条）
   - 验证所有费用明细状态为`pending`

5. 导入操作历史数据
   - 使用`test_operation_histories.csv`
   - 验证成功导入5条操作历史记录（而非用户故事中的10条）

### 3.2 工单处理阶段

按照用户故事中的流程处理工单，但使用实际测试数据文件中的报销单号（ER14228251而非R2025001）。

### 3.3 操作历史导入与状态更新

使用`test_operation_histories_approval.csv`导入操作历史数据，验证报销单状态变为`closed`。

## 4. 与其他文档的关系

本映射文档与以下文档密切相关：

- [项目概述](01_overview.md)
- [数据库结构设计](02_database_structure.md)
- [模型实现](03_model_implementation_updated.md)
- [服务实现](04_service_implementation_updated.md)
- [UI设计](05_activeadmin_ui_design_updated_v3.md)
- [ActiveAdmin集成](05_activeadmin_integration_updated_v3.md)
- [测试策略](06_testing_strategy.md)
- [费用明细状态简化](10_simplify_fee_detail_status.md)

特别是，本文档与[费用明细状态简化](10_simplify_fee_detail_status.md)文档中描述的设计保持一致，确保测试过程中正确验证费用明细状态的变化。