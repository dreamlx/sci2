# SCI2 工单系统重构测试计划

## 目录

- [1. 测试目标与范围](#1-测试目标与范围)
- [2. 测试环境](#2-测试环境)
- [3. 测试数据准备](#3-测试数据准备)
- [4. 测试用例分类](#4-测试用例分类)
- [5. 数据导入测试](#5-数据导入测试)
- [6. 工单状态流转测试](#6-工单状态流转测试)
- [7. 工单关联关系测试](#7-工单关联关系测试)
- [8. 费用明细验证测试](#8-费用明细验证测试)
- [9. 集成测试场景](#9-集成测试场景)
- [10. 测试执行计划](#10-测试执行计划)
- [11. 测试报告模板](#11-测试报告模板)

## 1. 测试目标与范围

### 测试目标

1. 验证重构后的工单系统核心功能是否按照设计规范正常工作
2. 确保数据导入功能能够正确处理各类CSV文件，并遵循必要的导入顺序
3. 验证三种工单类型（快递收单工单、审核工单、沟通工单）的状态流转逻辑正确性和完整性
4. 测试工单之间的关联关系是否正确建立和维护
5. 确保费用明细验证功能正常工作，特别是沟通工单解决后状态不自动更新的情况
6. 测试系统在各种边界条件和异常情况下的行为

### 测试范围

- **数据导入模块**：报销单、快递收单、费用明细、操作历史的导入功能，特别关注导入顺序的强制要求
- **工单处理模块**：三种工单类型的创建、处理和状态流转
  - 快递收单工单：received → processed → completed
  - 审核工单：pending → processing → auditing → approved/rejected → completed（中间可能进入needs_communication状态）
  - 沟通工单：open → in_progress → resolved/unresolved → closed
- **费用明细模块**：费用明细的选择、关联和验证状态更新，特别是沟通工单解决后状态不自动更新的情况
- **工单关联模块**：工单之间的关联关系建立和维护
- **状态变更模块**：工单状态变更历史记录和查询

## 2. 测试环境

### 开发环境

- **操作系统**：macOS/Linux/Windows
- **数据库**：sqlite
- **Ruby版本**：3.4.2
- **Rails版本**：7.0+
- **浏览器**：Chrome 最新版、Firefox 最新版、Safari 最新版

### 测试环境

- **测试数据库**：与开发环境隔离的独立测试数据库
- **测试框架**：Rails内置测试框架（Minitest）
- **测试类型**：单元测试、集成测试、系统测试
- **CI/CD**：GitHub Actions 或 Jenkins

## 3. 测试数据准备

### 基础测试数据

1. **报销单数据**：
   - 普通报销单（非电子发票）
   - 电子发票报销单
   - 不同状态的报销单（未收单、已收单、审核中、已完成）

2. **快递收单数据**：
   - 匹配已有报销单的快递收单
   - 未匹配报销单的快递收单
   - 多次收单的情况（一个报销单对应多个快递单）

3. **费用明细数据**：
   - 不同类型的费用明细（交通费、餐费、办公用品等）
   - 不同验证状态的费用明细（待验证、已验证、有问题、已拒绝）

4. **操作历史数据**：
   - 不同操作类型的历史记录（审批、审批通过、退回等）
   - 不同操作人的历史记录

### 测试文件准备

1. **CSV测试文件**：
   - 标准格式的CSV文件
   - 包含中文字符的CSV文件
   - 格式错误的CSV文件（用于测试错误处理）

2. **测试数据生成脚本**：
   - 开发自动化脚本生成大量测试数据
   - 支持生成不同场景的测试数据集

## 4. 测试用例分类

### 按功能模块分类

1. **数据导入测试**：测试四种数据类型的导入功能和导入顺序要求
2. **工单创建测试**：测试三种工单类型的创建逻辑，包括自动创建和手动创建
3. **工单状态流转测试**：测试三种工单类型的状态流转逻辑
4. **费用明细验证测试**：测试费用明细的验证状态流转，特别是沟通工单解决后状态不自动更新的情况
5. **工单关联关系测试**：测试工单之间的关联关系建立和维护
6. **状态变更历史测试**：测试工单状态变更历史记录和查询

### 按测试类型分类

1. **单元测试**：测试各个模型和服务的独立功能
2. **集成测试**：测试多个组件之间的交互
3. **系统测试**：测试完整的业务流程
## 5. 数据导入测试

### 5.1 报销单导入测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-R-001 | 导入标准CSV格式报销单 | 1. 准备标准格式的报销单CSV文件<br>2. 使用导入功能上传文件 | 1. 成功导入所有记录<br>2. 显示导入成功消息<br>3. 数据库中创建对应的报销单记录 | 高 |
| IMP-R-002 | 导入包含电子发票标记的报销单 | 1. 准备包含"全电子发票"标签的报销单文件<br>2. 使用导入功能上传文件 | 1. 成功导入所有记录<br>2. 电子发票标记字段设置为true<br>3. 不自动创建审核工单 | 中 |
| IMP-R-003 | 导入非电子发票报销单 | 1. 准备不包含"全电子发票"标签的报销单文件<br>2. 使用导入功能上传文件 | 1. 成功导入所有记录<br>2. 电子发票标记字段设置为false<br>3. 自动创建审核工单 | 高 |
| IMP-R-004 | 导入格式错误的报销单文件 | 1. 准备格式错误的报销单文件<br>2. 使用导入功能上传文件 | 1. 显示导入错误消息<br>2. 提供错误详情<br>3. 不导入任何记录 | 中 |
| IMP-R-005 | 导入重复的报销单 | 1. 导入一批报销单<br>2. 再次导入相同的报销单 | 1. 系统识别重复记录<br>2. 更新已存在的报销单记录<br>3. 显示更新成功消息 | 中 |

### 5.2 快递收单导入测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-E-001 | 导入匹配已有报销单的快递收单 | 1. 先导入报销单<br>2. 导入对应的快递收单 | 1. 成功导入所有记录<br>2. 自动关联到对应的报销单<br>3. 自动创建快递收单工单<br>4. 更新报销单收单状态 | 高 |
| IMP-E-002 | 导入未匹配报销单的快递收单 | 1. 导入不存在对应报销单的快递收单 | 1. 显示未匹配警告<br>2. 记录未匹配的快递收单<br>3. 提供未匹配记录下载 | 高 |
| IMP-E-003 | 导入多次收单的情况 | 1. 先导入一个报销单<br>2. 导入对应的第一个快递收单<br>3. 导入对应的第二个快递收单 | 1. 成功导入所有记录<br>2. 两个快递收单都关联到同一个报销单<br>3. 创建两个独立的快递收单工单 | 中 |
| IMP-E-004 | 导入格式错误的快递收单文件 | 1. 准备格式错误的快递收单文件<br>2. 使用导入功能上传文件 | 1. 显示导入错误消息<br>2. 提供错误详情<br>3. 不导入任何记录 | 中 |

### 5.3 费用明细导入测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-F-001 | 导入匹配已有报销单的费用明细 | 1. 先导入报销单<br>2. 导入对应的费用明细 | 1. 成功导入所有记录<br>2. 自动关联到对应的报销单<br>3. 设置验证状态为待验证 | 高 |
| IMP-F-002 | 导入未匹配报销单的费用明细 | 1. 导入不存在对应报销单的费用明细 | 1. 显示未匹配警告<br>2. 记录未匹配的费用明细<br>3. 提供未匹配记录下载 | 中 |
| IMP-F-003 | 导入多种费用类型的明细 | 1. 准备包含多种费用类型的明细文件<br>2. 使用导入功能上传文件 | 1. 成功导入所有记录<br>2. 正确识别不同的费用类型 | 中 |
| IMP-F-004 | 导入格式错误的费用明细文件 | 1. 准备格式错误的费用明细文件<br>2. 使用导入功能上传文件 | 1. 显示导入错误消息<br>2. 提供错误详情<br>3. 不导入任何记录 | 中 |

### 5.4 操作历史导入测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-O-001 | 导入匹配已有报销单的操作历史 | 1. 先导入报销单<br>2. 导入对应的操作历史 | 1. 成功导入所有记录<br>2. 自动关联到对应的报销单 | 高 |
| IMP-O-002 | 导入审批通过类型的操作历史 | 1. 先导入报销单<br>2. 导入包含"审批通过"类型的操作历史 | 1. 成功导入记录<br>2. 自动更新报销单状态为已关闭<br>3. 设置报销单完成标志 | 高 |
| IMP-O-003 | 导入未匹配报销单的操作历史 | 1. 导入不存在对应报销单的操作历史 | 1. 显示未匹配警告<br>2. 记录未匹配的操作历史<br>3. 提供未匹配记录下载 | 中 |
| IMP-O-004 | 导入格式错误的操作历史文件 | 1. 准备格式错误的操作历史文件<br>2. 使用导入功能上传文件 | 1. 显示导入错误消息<br>2. 提供错误详情<br>3. 不导入任何记录 | 中 |

### 5.5 导入顺序测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| IMP-S-001 | 按正确顺序导入所有数据 | 1. 先导入报销单<br>2. 导入快递收单<br>3. 导入费用明细<br>4. 导入操作历史 | 1. 所有数据成功导入<br>2. 所有关联关系正确建立<br>3. 工单自动创建<br>4. 状态正确更新 | 高 |
| IMP-S-002 | 尝试在导入报销单前导入其他数据 | 1. 尝试先导入快递收单<br>2. 尝试先导入费用明细<br>3. 尝试先导入操作历史 | 1. 系统拒绝导入<br>2. 显示错误消息，提示必须先导入报销单<br>3. 不导入任何记录 | 高 |
| IMP-S-003 | 导入报销单后任意顺序导入其他数据 | 1. 先导入报销单<br>2. 导入操作历史<br>3. 导入费用明细<br>4. 导入快递收单 | 1. 所有数据成功导入<br>2. 所有关联关系正确建立<br>3. 工单自动创建<br>4. 状态正确更新 | 中 |
## 6. 工单状态流转测试

### 6.1 快递收单工单状态流转测试

快递收单工单状态流转图：

```
[创建] --> received --> processed --> completed
```

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| WF-E-001 | 快递收单工单基础流程 | 1. 导入快递收单数据（自动创建工单）<br>2. 处理快递收单（process）<br>3. 完成处理（complete） | 1. 工单状态初始为received<br>2. 状态从received变为processed<br>3. 状态从processed变为completed | 高 |
| WF-E-002 | 快递收单工单完成后创建审核工单 | 1. 导入快递收单数据<br>2. 处理快递收单工单至completed状态 | 1. 快递收单工单状态变为completed<br>2. 自动创建审核工单<br>3. 审核工单状态为pending<br>4. 建立关联关系 | 高 |
| WF-E-003 | 快递收单工单状态变更记录 | 1. 导入快递收单数据<br>2. 执行多次状态变更 | 1. 每次状态变更都有记录<br>2. 记录包含变更前后状态、操作人和时间 | 中 |
| WF-E-004 | 快递收单工单非法状态转换 | 1. 创建快递收单工单（received）<br>2. 尝试直接标记为已完成（complete） | 1. 系统拒绝非法状态转换<br>2. 显示错误消息<br>3. 工单状态保持不变 | 中 |

### 6.2 审核工单状态流转测试

审核工单状态流转图：

```
[创建] --> pending --> processing --> auditing --> approved --> completed
                                   |          |
                                   |          v
                                   |       rejected --> completed
                                   v
                             needs_communication --> auditing
```

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| WF-A-001 | 审核工单基础状态流转-通过路径 | 1. 创建审核工单（pending）<br>2. 开始处理工单（start_processing）<br>3. 开始审核（start_audit）<br>4. 审核通过（approve）<br>5. 完成处理（complete） | 1. 状态从pending变为processing<br>2. 状态从processing变为auditing<br>3. 状态从auditing变为approved<br>4. 状态从approved变为completed | 高 |
| WF-A-002 | 审核工单基础状态流转-不通过路径 | 1. 创建审核工单（pending）<br>2. 开始处理工单（start_processing）<br>3. 开始审核（start_audit）<br>4. 审核不通过（reject）<br>5. 完成处理（complete） | 1. 状态从pending变为processing<br>2. 状态从processing变为auditing<br>3. 状态从auditing变为rejected<br>4. 状态从rejected变为completed | 高 |
| WF-A-003 | 审核工单需要沟通路径 | 1. 创建审核工单（pending）<br>2. 开始处理工单（start_processing）<br>3. 开始审核（start_audit）<br>4. 需要沟通（need_communication）<br>5. 重新审核（resume_audit）<br>6. 审核通过（approve）<br>7. 完成处理（complete） | 1. 状态从pending变为processing<br>2. 状态从processing变为auditing<br>3. 状态从auditing变为needs_communication<br>4. 状态从needs_communication变为auditing<br>5. 状态从auditing变为approved<br>6. 状态从approved变为completed | 高 |
| WF-A-004 | 审核工单需要沟通并创建沟通工单 | 1. 创建审核工单（pending）<br>2. 开始处理工单（start_processing）<br>3. 开始审核（start_audit）<br>4. 需要沟通（need_communication）<br>5. 创建沟通工单（create_communication_work_order） | 1. 审核工单状态变为needs_communication<br>2. 成功创建沟通工单<br>3. 沟通工单状态为open<br>4. 建立关联关系 | 高 |
| WF-A-005 | 审核工单状态变更记录 | 1. 创建审核工单<br>2. 执行多次状态变更 | 1. 每次状态变更都有记录<br>2. 记录包含变更前后状态、操作人和时间 | 中 |
| WF-A-006 | 审核工单非法状态转换 | 1. 创建审核工单（pending）<br>2. 尝试直接标记为审核通过（approve） | 1. 系统拒绝非法状态转换<br>2. 显示错误消息<br>3. 工单状态保持不变 | 中 |
| WF-A-007 | 非电子发票报销单导入自动创建审核工单 | 1. 导入非电子发票报销单 | 1. 系统自动创建审核工单<br>2. 审核工单状态为pending<br>3. 建立关联关系 | 高 |

### 6.3 沟通工单状态流转测试

沟通工单状态流转图：

```
[创建] --> open --> in_progress --> resolved --> closed
                              |
                              v
                          unresolved --> closed
```

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| WF-C-001 | 沟通工单解决流程 | 1. 创建沟通工单（open）<br>2. 开始沟通（start_communication）<br>3. 标记问题已解决（resolve）<br>4. 关闭工单（close） | 1. 状态从open变为in_progress<br>2. 状态从in_progress变为resolved<br>3. 状态从resolved变为closed | 高 |
| WF-C-002 | 沟通工单未解决流程 | 1. 创建沟通工单（open）<br>2. 开始沟通（start_communication）<br>3. 标记问题未解决（mark_unresolved）<br>4. 关闭工单（close） | 1. 状态从open变为in_progress<br>2. 状态从in_progress变为unresolved<br>3. 状态从unresolved变为closed | 高 |
| WF-C-003 | 沟通工单通知父工单 | 1. 创建审核工单<br>2. 审核工单标记为需要沟通<br>3. 创建沟通工单<br>4. 处理沟通工单至已解决状态 | 1. 沟通工单状态变为resolved<br>2. 自动通知父工单<br>3. 审核工单状态从needs_communication变为auditing | 高 |
| WF-C-004 | 沟通工单添加沟通记录 | 1. 创建沟通工单<br>2. 添加多条沟通记录 | 1. 成功添加沟通记录<br>2. 记录包含内容、参与者角色和时间 | 中 |
| WF-C-005 | 沟通工单状态变更记录 | 1. 创建沟通工单<br>2. 执行多次状态变更 | 1. 每次状态变更都有记录<br>2. 记录包含变更前后状态、操作人和时间 | 中 |
| WF-C-006 | 沟通工单非法状态转换 | 1. 创建沟通工单（open）<br>2. 尝试直接标记为已解决（resolve） | 1. 系统拒绝非法状态转换<br>2. 显示错误消息<br>3. 工单状态保持不变 | 中 |
| WF-C-007 | 沟通工单关联0个费用明细 | 1. 创建审核工单<br>2. 创建沟通工单但不关联任何费用明细 | 1. 成功创建沟通工单<br>2. 沟通工单不关联任何费用明细<br>3. 沟通工单状态为open | 中 |
| WF-C-008 | 沟通工单关联多个费用明细 | 1. 创建审核工单<br>2. 创建沟通工单并关联多个费用明细 | 1. 成功创建沟通工单<br>2. 沟通工单关联所有选中的费用明细<br>3. 费用明细状态更新为"有问题" | 高 |
## 7. 工单关联关系测试

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| REL-001 | 报销单与快递收单工单关联 | 1. 导入报销单<br>2. 导入快递收单 | 1. 成功创建快递收单工单<br>2. 快递收单工单关联到报销单<br>3. 报销单可以访问到关联的快递收单工单 | 高 |
| REL-002 | 报销单与审核工单关联 | 1. 导入非电子发票报销单<br>2. 系统自动创建审核工单 | 1. 成功创建审核工单<br>2. 审核工单关联到报销单<br>3. 报销单可以访问到关联的审核工单 | 高 |
| REL-003 | 快递收单工单与审核工单关联 | 1. 导入报销单和快递收单<br>2. 处理快递收单工单至completed状态 | 1. 自动创建审核工单<br>2. 审核工单关联到快递收单工单<br>3. 审核工单关联到报销单<br>4. 快递收单工单可以访问到关联的审核工单 | 高 |
| REL-004 | 审核工单与沟通工单关联 | 1. 创建审核工单<br>2. 处理至审核暂缓状态<br>3. 创建沟通工单 | 1. 成功创建沟通工单<br>2. 沟通工单关联到审核工单<br>3. 沟通工单关联到报销单<br>4. 审核工单可以访问到关联的沟通工单 | 高 |
| REL-005 | 一个报销单多个工单 | 1. 为同一报销单创建多个工单 | 1. 所有工单都关联到同一报销单<br>2. 报销单详情页显示所有关联工单 | 中 |
| REL-006 | 删除工单对关联关系的影响 | 1. 创建关联的工单<br>2. 删除其中一个工单 | 1. 关联的工单不受影响继续存在<br>2. 关联关系适当更新 | 低 |

## 8. 费用明细验证测试

费用明细验证状态流转：

```
[导入] --> pending --> verified --> completed
                  |
                  v
              problematic --> verified/rejected --> completed
```

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| FEE-001 | 选择费用明细关联到审核工单 | 1. 选择报销单->创建审核工单<br>2. 选择多个费用明细关联到审核工单 | 1. 成功创建费用明细选择记录<br>2. 工单关联到所有选中的费用明细<br>3. 费用明细验证状态为"待验证" | 高 |
| FEE-002 | 批量全选关联费用明细 | 1. 导入报销单<br>2. 导入费用明细<br>3. 选择报销单->创建审核工单 | 1. 批量全选关联所有相关费用明细<br>2. 费用明细验证状态为"待验证" | 中 |
| FEE-003 | 更新费用明细验证状态为已验证 | 1. 创建审核工单并关联费用明细<br>2. 更新费用明细验证状态为已验证 | 1. 费用明细验证状态成功更新为已验证<br>2. 记录更新时间和操作人 | 高 |
| FEE-004 | 更新费用明细验证状态为有问题 | 1. 创建审核工单并关联费用明细<br>2. 更新费用明细验证状态为有问题<br>3. 创建沟通工单 | 1. 费用明细验证状态成功更新为有问题<br>2. 成功创建沟通工单<br>3. 沟通工单关联到该费用明细 | 高 |
| FEE-005 | 沟通工单解决后费用明细状态不自动更新 | 1. 创建审核工单并关联费用明细<br>2. 标记费用明细有问题并创建沟通工单<br>3. 处理沟通工单至已解决状态 | 1. 费用明细验证状态保持为有问题<br>2. 沟通工单状态变为已解决<br>3. 审核工单状态从needs_communication变为auditing | 高 |
| FEE-006 | 手动更新沟通解决后的费用明细状态 | 1. 创建审核工单并关联费用明细<br>2. 标记费用明细有问题并创建沟通工单<br>3. 处理沟通工单至已解决状态<br>4. 手动更新费用明细状态为已验证 | 1. 费用明细验证状态成功更新为已验证<br>2. 记录更新时间和操作人 | 高 |
| FEE-007 | 审核工单完成时更新费用明细状态 | 1. 创建审核工单并关联费用明细<br>2. 处理审核工单至approved状态<br>3. 完成审核工单 | 1. 所有关联的费用明细状态更新为已验证<br>2. 记录更新时间和操作人 | 中 |
| FEE-008 | 审核工单拒绝时更新费用明细状态 | 1. 创建审核工单并关联费用明细<br>2. 处理审核工单至rejected状态<br>3. 完成审核工单 | 1. 所有关联的费用明细状态更新为已拒绝<br>2. 记录更新时间和操作人 | 中 |
## 9. 集成测试场景

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| INT-001 | 完整报销流程-快递收单到审核完成 | 1. 导入报销单<br>2. 导入快递收单<br>3. 处理快递收单工单<br>4. 处理审核工单 | 1. 所有工单状态正确流转<br>2. 关联关系正确建立<br>3. 报销单状态正确更新 | 高 |
| INT-002 | 完整报销流程-包含沟通处理 | 1. 导入报销单<br>2. 导入快递收单<br>3. 处理快递收单工单<br>4. 处理审核工单至需要沟通状态<br>5. 创建并处理沟通工单<br>6. 完成审核工单 | 1. 所有工单状态正确流转<br>2. 关联关系正确建立<br>3. 沟通工单成功解决<br>4. 审核工单成功完成 | 高 |
| INT-003 | 非电子发票报销单直接审核流程 | 1. 导入非电子发票报销单<br>2. 处理自动创建的审核工单 | 1. 系统自动创建审核工单<br>2. 审核工单状态正确流转<br>3. 报销单状态正确更新 | 高 |
| INT-004 | 费用明细验证完整流程 | 1. 导入报销单和费用明细<br>2. 创建审核工单并关联费用明细<br>3. 验证费用明细<br>4. 完成审核工单 | 1. 费用明细成功关联<br>2. 验证状态正确更新<br>3. 审核工单成功完成 | 中 |
| INT-005 | 操作历史影响报销单状态 | 1. 导入报销单<br>2. 创建并处理工单<br>3. 导入包含审批通过的操作历史 | 1. 报销单状态更新为已关闭<br>2. 工单状态不受影响 | 中 |
| INT-006 | 沟通工单解决后手动更新费用明细状态 | 1. 导入报销单和费用明细<br>2. 创建审核工单并关联费用明细<br>3. 标记费用明细有问题并创建沟通工单<br>4. 处理沟通工单至已解决状态<br>5. 手动更新费用明细状态<br>6. 完成审核工单 | 1. 沟通工单成功解决<br>2. 费用明细状态不自动更新<br>3. 手动更新费用明细状态成功<br>4. 审核工单成功完成 | 高 |
| INT-007 | 多个报销单并行处理 | 1. 导入多个报销单<br>2. 并行处理多个工单<br>3. 观察系统行为 | 1. 各报销单处理互不影响<br>2. 所有工单状态正确流转 | 低 |

## 12. 测试计划补充说明

根据与财务经理的沟通，对测试计划进行以下补充说明：

### 12.1 审核工单状态流转补充说明

1. **从needs_communication状态直接拒绝**：
   - 审核工单可以从needs_communication状态直接转换为rejected状态，无需等待沟通工单解决。
   - 这是为了处理可能出现的沟通超时情况。

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| WF-A-008 | 审核工单从needs_communication状态直接拒绝 | 1. 创建审核工单<br>2. 处理至needs_communication状态<br>3. 直接拒绝审核工单 | 1. 状态从needs_communication变为rejected<br>2. 沟通工单状态不受影响<br>3. 记录状态变更 | 高 |

### 12.2 沟通工单与审核工单的联动补充说明

1. **状态同步机制**：
   - 沟通工单解决后会自动通知父工单（审核工单），但不会自动更新费用明细状态。
   - 费用明细状态的更新由审核工单负责处理。

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| WF-C-009 | 沟通工单解决后的状态同步 | 1. 创建审核工单<br>2. 创建沟通工单并关联费用明细<br>3. 解决沟通工单 | 1. 沟通工单状态变为resolved<br>2. 审核工单状态从needs_communication变为auditing<br>3. 费用明细状态保持不变 | 高 |

### 12.3 费用明细验证状态流程补充说明

1. **状态转换灵活性**：
   - 费用明细状态可以自由更改，除非关联的报销单状态已关闭。
   - 费用明细可以从"有问题"(problematic)状态直接转换为"已验证"(verified)或"已拒绝"(rejected)状态。

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| FEE-009 | 费用明细从有问题状态转为已拒绝 | 1. 创建审核工单并关联费用明细<br>2. 标记费用明细为有问题<br>3. 直接将费用明细状态更新为已拒绝 | 1. 费用明细状态成功更新为已拒绝<br>2. 记录更新时间和操作人 | 中 |
| FEE-010 | 报销单关闭后费用明细状态锁定 | 1. 创建审核工单并关联费用明细<br>2. 完成审核工单<br>3. 关闭报销单<br>4. 尝试更改费用明细状态 | 1. 系统拒绝更改费用明细状态<br>2. 显示错误消息 | 中 |

### 12.4 报销单状态同步补充说明

1. **报销单状态确定机制**：
   - 报销单状态以最新导入的操作历史数据为准，而非由工单状态决定。
   - 工单系统不控制外部ERP系统中的报销单状态。

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| INT-008 | 操作历史决定报销单状态 | 1. 导入报销单<br>2. 处理工单至不同状态<br>3. 导入包含最新状态的操作历史 | 1. 报销单状态以最新操作历史为准<br>2. 工单状态不影响报销单状态 | 高 |

### 12.5 报销单完整生命周期测试补充说明

1. **端到端测试**：
   - 增加覆盖报销单从创建到关闭的所有可能路径的端到端测试。

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| INT-009 | 非电子发票报销单完整生命周期 | 1. 导入非电子发票报销单<br>2. 处理自动创建的审核工单<br>3. 完成审核工单<br>4. 导入审批通过的操作历史 | 1. 审核工单状态正确流转<br>2. 报销单状态正确更新<br>3. 费用明细状态正确更新 | 高 |
| INT-010 | 快递收单报销单完整生命周期 | 1. 导入报销单<br>2. 导入快递收单<br>3. 处理快递收单工单<br>4. 处理审核工单<br>5. 导入审批通过的操作历史 | 1. 所有工单状态正确流转<br>2. 报销单状态正确更新<br>3. 费用明细状态正确更新 | 高 |
| INT-011 | 包含沟通的报销单完整生命周期 | 1. 导入报销单和费用明细<br>2. 处理审核工单并创建沟通工单<br>3. 处理沟通工单<br>4. 完成审核工单<br>5. 导入审批通过的操作历史 | 1. 所有工单状态正确流转<br>2. 沟通工单成功解决<br>3. 报销单状态正确更新<br>4. 费用明细状态正确更新 | 高 |

### 12.6 用户角色补充说明

1. **单一用户角色**：
   - 由于使用ActiveAdmin，目前所有用户都是admin_user。
   - 暂不需要考虑多用户角色的测试，先确保单个用户可以完成整个流程。

| 测试ID | 测试场景 | 测试步骤 | 预期结果 | 优先级 |
|--------|----------|----------|----------|--------|
| INT-012 | 单一管理员用户完整流程 | 1. 以admin_user身份登录<br>2. 执行完整的报销处理流程 | 1. 管理员用户可以执行所有操作<br>2. 完整流程可以顺利完成 | 高 |