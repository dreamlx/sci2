# 数据导入格式参考

本文档提供了工单系统数据导入的格式参考，包括四种CSV文件的结构和字段说明。

## 目录

- [导入顺序说明](#导入顺序说明)
- [报销单报表](#1-报销单报表)
- [快递收单导出数据](#2-快递收单导出数据)
- [每单操作历史数据](#3-每单操作历史数据)
- [单据费用明细报表](#4-单据费用明细报表)
- [数据导入流程](#数据导入流程)
- [字段映射关系](#字段映射关系)
- [特殊情况处理](#特殊情况处理)

## 导入顺序说明

数据导入必须按照以下顺序进行，以确保数据的正确关联：

1. 首先导入**报销单报表**，建立基础数据
2. 然后导入**快递收单导出数据**，关联到报销单
3. 接着导入**单据费用明细报表**，关联到报销单
4. 最后导入**每单操作历史数据**，更新报销单状态

不按照正确顺序导入可能导致数据关联失败或工单生成错误。

## 1. 报销单报表

### 文件名示例
`2.HLY报销单报表.csv`

### 字段说明
| 字段名 | 说明 | 示例值 |
|-------|------|-------|
| 报销单单号 | 报销单的唯一标识 | ER14228250 |
| 单据名称 | 报销单类型 | 个人日常和差旅（含小沟会）报销单 |
| 报销单申请人 | 申请人姓名 | 梅文达 |
| 报销单申请人工号 | 申请人工号 | 20181101 |
| 申请人公司 | 申请人所属公司 | SPC |
| 申请人部门 | 申请人所属部门 | FIN |
| 收单状态 | 报销单收单状态 | 未收单/已收单 |
| 收单日期 | 收单日期 | 2024-07-25 17:11:05 |
| 关联申请单号 | 关联的申请单号 | EA08588801 |
| 提交报销日期 | 提交报销的日期 | 2024-07-01 16:13:33 |
| 记账日期 | 记账日期 | 2024-07-02 |
| 报销单状态 | 报销单当前状态 | 已付款 |
| 当前审批节点 | 当前审批节点 | - |
| 当前审批人 | 当前审批人 | - |
| 报销单审核通过日期 | 审核通过日期 | 2024-07-02 15:08:13 |
| 审核通过人 | 审核通过人 | 顾丽君 |
| 报销金额（单据币种） | 报销金额 | 323.86 |
| 单据标签 | 单据标签 | 全电子发票 |

### 数据示例
```
报销单单号,单据名称,报销单申请人,报销单申请人工号,申请人公司,申请人部门,收单状态,收单日期,关联申请单号,提交报销日期,记账日期,报销单状态,当前审批节点,当前审批人,报销单审核通过日期,审核通过人,报销金额（单据币种）,弹性字段2,当前审批节点转入时间,首次提交时间,单据标签,弹性字段8
ER14228250,个人日常和差旅（含小沟会）报销单,梅文达,20181101,SPC,FIN,未收单,,EA08588801,2024-07-01 16:13:33,2024-07-02,已付款,,,2024-07-02 15:08:13,顾丽君,323.86,2024-05,,2024-07-01 16:13:33,全电子发票,
ER14225632,个人日常和差旅（含小沟会）报销单,彭肖军,20150620,SPC,OBU-E1,已收单,2024-07-25 17:11:05,EA08579291,2024-07-01 18:02:16,2024-07-04,已付款,,,2024-07-04 19:04:10,顾丽君,5992.00,2024-06,,2024-07-01 17:58:18,,
```

## 2. 快递收单导出数据

### 文件名示例
`1.HLY快递收单导出数据.csv`

### 字段说明
| 字段名 | 说明 | 示例值 |
|-------|------|-------|
| 序号 | 记录序号 | 1 |
| 单据类型 | 报销单类型 | 学术会议报销单 |
| 单号 | 报销单号 | ER19886133 |
| 申请人 | 申请人姓名 | 潘志琦 |
| 操作时间 | 收单操作时间 | 2025-03-31 17:51:35 |
| 操作类型 | 操作类型 | 单据接收 |
| 操作意见 | 操作意见（包含快递单号） | 快递单号：73547754777673 |

### 数据示例
```
序号,单据类型,单号,申请人,操作时间,操作类型,操作意见
1,学术会议报销单,ER19886133,潘志琦,2025-03-31 17:51:35,单据接收,快递单号：73547754777673
2,个人日常和差旅（含小沟会）报销单,ER20221531,潘志琦,2025-03-31 17:51:35,单据接收,快递单号：73547754777673
```

## 3. 每单操作历史数据

### 文件名示例
`3.HLY每单操作历史数据.csv`

### 字段说明
| 字段名 | 说明 | 示例值 |
|-------|------|-------|
| 表单类型 | 表单类型 | 日常报销单 |
| 单据编号 | 报销单号 | ER20235830 |
| 申请人 | 申请人姓名 | 齐雁杰 |
| 员工工号 | 申请人工号 | 20220819 |
| 员工公司 | 申请人公司 | SPC |
| 员工部门 | 申请人部门 | IBU-Core-JN |
| 单据名称 | 单据名称 | 学术会议报销单 |
| 币种 | 币种 | CNY |
| 金额 | 金额 | 1199 |
| 创建日期 | 创建日期 | 2025-03-19 21:42:29 |
| 操作节点 | 操作节点 | 审批 |
| 操作类型 | 操作类型 | 删除单据/审批通过/回复 |
| 操作意见 | 操作意见 | - |
| 操作日期 | 操作日期 | 2025-03-31 23:54:11 |
| 操作人 | 操作人 | 齐雁杰 |

### 数据示例
```
表单类型,单据编号,申请人,员工工号,员工公司,员工部门,员工部门路径,员工单据公司,员工单据部门,员工单据部门路径,提交人,单据名称,币种,金额,创建日期,操作节点,操作类型,操作意见 ,操作日期,操作人
日常报销单,ER20235830,齐雁杰,20220819,SPC,IBU-Core-JN,BU-Immunology|IBU-Core|IBU-Core-JN,SPC,IBU-Core-JN,BU-Immunology|IBU-Core|IBU-Core-JN,齐雁杰,学术会议报销单,CNY,1199,2025-03-19 21:42:29,审批,删除单据,,2025-03-31 23:54:11,齐雁杰
日常报销单,ER19842295,姜一宁,20231110,SPC,IBU-Core-SY,BU-Immunology|IBU-Core|IBU-Core-SY,SPC,IBU-Core-SY,BU-Immunology|IBU-Core|IBU-Core-SY,姜一宁,个人日常和差旅（含小沟会）报销单,CNY,783,2025-03-03 23:20:10,审批,回复,@姜一宁@Dshen Gu您好，可以帮我拍一下定额发票吗？已经邮寄。谢谢,2025-03-31 23:40:51,姜一宁
```

## 4. 单据费用明细报表

### 文件名示例
`4.HLY单据费用明细报表.csv`

### 字段说明
| 字段名 | 说明 | 示例值 |
|-------|------|-------|
| 所属月 | 费用所属月份 | 2024-05 |
| 费用类型 | 费用类型 | 电话费 |
| 申请人名称 | 申请人姓名 | 梅文达 |
| 申请人工号 | 申请人工号 | 20181101 |
| 申请人公司 | 申请人公司 | SPC |
| 申请人部门 | 申请人部门 | FIN |
| 费用发生日期 | 费用发生日期 | 2024-06-02 00:00:00 |
| 原始金额 | 费用金额 | 323.86 |
| 单据名称 | 单据名称 | 个人日常和差旅（含小沟会）报销单 |
| 报销单单号 | 报销单号 | ER14228250 |
| 关联申请单号 | 关联申请单号 | EA08588801 |
| 计划/预申请 | 计划/预申请 | - |
| 产品 | 产品 | - |
| 弹性字段11 | 支付方式 | 个人卡 |
| 首次提交日期 | 首次提交日期 | 2024-07-01 16:13:33 |

### 数据示例
```
所属月,费用类型,申请人名称,申请人工号,申请人公司,申请人部门,费用发生日期,原始金额,单据名称,报销单单号,关联申请单号,计划/预申请,产品,弹性字段11,弹性字段6(报销单),弹性字段7(报销单),费用id,首次提交日期,费用对应计划,费用关联申请单
2024-05,电话费,梅文达,20181101,SPC,FIN,2024-06-02 00:00:00,323.86,个人日常和差旅（含小沟会）报销单,ER14228250,EA08588801,,,个人卡,,,1806265772805390337,2024-07-01 16:13:33,,
2024-06,月度交通费（销售/SMO/CO),彭肖军,20150620,SPC,OBU-E1,2024-06-02 00:00:00,2500.00,个人日常和差旅（含小沟会）报销单,ER14225632,EA08579291,,,个人卡,,,1807705099481513985,2024-07-01 17:58:18,,
```

## 数据导入流程

### 1. 报销单导入流程
1. 系统读取CSV文件
2. 检查报销单是否已存在
   - 如果存在，更新现有记录
   - 如果不存在，创建新记录
3. 设置报销单状态和标签
4. 对于电子发票，标记`is_electronic = true`

### 2. 快递收单导入流程
1. 系统读取CSV文件
2. 从操作意见中提取快递单号
3. 检查是否存在匹配的报销单
   - 如果存在，创建快递收单记录并关联到报销单
   - 如果不存在，提示未匹配并提供手动匹配选项
4. 对于匹配成功的记录，自动创建收件工单

### 3. 费用明细导入流程
1. 系统读取CSV文件
2. 检查是否存在匹配的报销单
3. 创建费用明细记录并关联到报销单
4. 设置验证状态为"待验证"

### 4. 操作历史导入流程
1. 系统读取CSV文件
2. 创建操作历史记录并关联到报销单
3. 根据操作类型更新报销单状态
   - 如果操作类型包含"审批通过"，标记报销单为已完成
   

## 字段映射关系

### 报销单表字段映射
| CSV字段 | 数据库字段 |
|--------|-----------|
| 报销单单号 | invoice_number |
| 单据名称 | document_name |
| 报销单申请人 | applicant |
| 报销单申请人工号 | applicant_id |
| 申请人公司 | company |
| 申请人部门 | department |
| 收单状态 | receipt_status |
| 收单日期 | receipt_date |
| 提交报销日期 | submission_date |
| 报销单状态 | reimbursement_status |
| 报销金额（单据币种） | amount |
| 单据标签 | document_tags |

### 快递收单表字段映射
| CSV字段 | 数据库字段 |
|--------|-----------|
| 单号 | document_number |
| 操作意见(提取快递单号) | tracking_number |
| 操作时间 | receive_date |
| 操作人 | receiver |

### 操作历史表字段映射
| CSV字段 | 数据库字段 |
|--------|-----------|
| 单据编号 | document_number |
| 操作类型 | operation_type |
| 操作日期 | operation_time |
| 操作人 | operator |
| 操作意见 | notes |

### 费用明细表字段映射
| CSV字段 | 数据库字段 |
|--------|-----------|
| 报销单单号 | document_number |
| 费用类型 | fee_type |
| 原始金额 | amount |
| 费用发生日期 | fee_date |
| 弹性字段11 | payment_method |

## 特殊情况处理

### 1. 未匹配的快递单
- 系统会记录未匹配的快递单信息
- 也可以选择忽略未匹配的快递单

### 2. 电子发票报销单
- 对于标记为"全电子发票"的报销单，系统会设置`is_electronic = true`
- 电子发票报销单不需要快递收单，可以直接进入审核流程

### 3. 多次补件情况
- 系统会记录每次补件请求和补件提交
- 报销单状态在"审核中"和"需补件"之间循环切换
- 每次需要补件时创建新的沟通工单

### 4. 操作历史状态冲突
- 当导入的操作历史状态与系统当前状态冲突时，以操作历史为准
- 记录状态变更原因，标注为"基于操作历史更新"